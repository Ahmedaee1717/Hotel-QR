<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Wristband Encoding Station - OnePass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .encoder-card {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .nfc-ready {
            animation: nfcReadyPulse 2s ease-in-out infinite;
        }
        
        @keyframes nfcReadyPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        .encoding-active {
            animation: encodingPulse 1s ease-in-out infinite;
        }
        
        @keyframes encodingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .success-bounce {
            animation: successBounce 0.5s ease-in-out;
        }
        
        @keyframes successBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-2xl p-6 mb-4 encoder-card">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="/onepass-logo.png" alt="OnePass" class="h-12">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">NFC Encoding Station</h1>
                        <p class="text-sm text-gray-600">Write digital pass to NFC wristband</p>
                    </div>
                </div>
                <button onclick="goBack()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
            </div>
        </div>

        <!-- Pass Lookup Card -->
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-4 encoder-card">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i class="fas fa-search text-purple-600"></i>
                Step 1: Load Digital Pass
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Pass Reference Number
                    </label>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="passReference" 
                            placeholder="PASS-XXX-XXX"
                            class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-lg font-mono uppercase"
                            onkeyup="this.value = this.value.toUpperCase()"
                            onkeypress="if(event.key === 'Enter') loadPassDetails()"
                        >
                        <button 
                            onclick="loadPassDetails()"
                            class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-bold hover:shadow-lg transition-all">
                            <i class="fas fa-arrow-right mr-2"></i>Load
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Enter the pass reference from the digital pass creation
                    </p>
                </div>
            </div>
        </div>

        <!-- Pass Details Card (Hidden initially) -->
        <div id="passDetailsCard" class="bg-white rounded-xl shadow-2xl p-8 mb-4 encoder-card hidden">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i class="fas fa-id-card text-purple-600"></i>
                Pass Details
            </h2>
            
            <div id="passDetailsContent"></div>
        </div>

        <!-- Encoding Card (Hidden initially) -->
        <div id="encodingCard" class="bg-white rounded-xl shadow-2xl p-8 mb-4 encoder-card hidden">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i class="fas fa-wifi text-purple-600" style="transform: rotate(-45deg);"></i>
                Step 2: Encode NFC Wristband
            </h2>
            
            <div id="encodingContent" class="text-center">
                <div class="w-32 h-32 mx-auto mb-6">
                    <i id="encodingIcon" class="fas fa-wifi text-8xl text-purple-600" style="transform: rotate(-45deg);"></i>
                </div>
                
                <h3 id="encodingTitle" class="text-2xl font-bold mb-2">Ready to Encode</h3>
                <p id="encodingMessage" class="text-gray-600 mb-6">Click the button below to start encoding</p>
                
                <button 
                    id="encodeButton"
                    onclick="startEncoding()"
                    class="w-full py-4 text-xl font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 bg-gradient-to-r from-purple-600 to-indigo-600 text-white">
                    <i class="fas fa-wifi mr-3" style="transform: rotate(-45deg);"></i>
                    Encode Wristband Now
                </button>
                
                <div class="mt-6 p-4 bg-purple-50 rounded-lg">
                    <p class="text-sm text-gray-700">
                        <i class="fas fa-hand-point-right text-purple-600 mr-2"></i>
                        <strong>Instructions:</strong> After clicking "Encode", tap the blank NFC wristband to the back of this device.
                    </p>
                </div>
            </div>
        </div>

        <!-- Result Card (Hidden initially) -->
        <div id="resultCard" class="bg-white rounded-xl shadow-2xl p-8 mb-4 encoder-card hidden">
            <div id="resultContent"></div>
        </div>

        <!-- NFC Support Status -->
        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 text-white encoder-card">
            <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                <i class="fas fa-info-circle"></i>
                NFC Encoding Requirements
            </h3>
            <ul class="space-y-2 text-sm">
                <li class="flex items-start gap-2">
                    <i class="fas fa-check text-green-400 mt-1"></i>
                    <span>Android device with NFC capability (Android 10+)</span>
                </li>
                <li class="flex items-start gap-2">
                    <i class="fas fa-check text-green-400 mt-1"></i>
                    <span>Chrome or Edge browser</span>
                </li>
                <li class="flex items-start gap-2">
                    <i class="fas fa-check text-green-400 mt-1"></i>
                    <span>NFC enabled in device settings</span>
                </li>
                <li class="flex items-start gap-2">
                    <i class="fas fa-check text-green-400 mt-1"></i>
                    <span>Blank NTAG215/216 NFC wristband or card</span>
                </li>
            </ul>
            
            <div class="mt-4 flex items-center gap-4 text-sm" id="nfcSupportStatus">
                <div class="flex items-center gap-2">
                    <i class="fas fa-circle text-gray-400 text-xs"></i>
                    <span>Checking NFC support...</span>
                </div>
            </div>
        </div>

        <!-- Recent Encodings -->
        <div class="bg-white rounded-xl shadow-2xl p-6 mt-4 encoder-card">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-history text-purple-600"></i>
                    Recent Encodings
                </h3>
                <button onclick="loadEncodingHistory()" class="text-sm text-purple-600 hover:text-purple-800">
                    <i class="fas fa-sync mr-1"></i>Refresh
                </button>
            </div>
            <div id="encodingHistory" class="space-y-2">
                <p class="text-gray-500 text-center py-4 text-sm">No encodings yet today</p>
            </div>
        </div>
    </div>

    <script>
        let propertyId = localStorage.getItem('property_id') || '1';
        let userId = localStorage.getItem('user_id');
        let staffName = localStorage.getItem('admin_user') ? JSON.parse(localStorage.getItem('admin_user')).first_name : 'Staff';
        let currentPass = null;
        let nfcWriter = null;

        function goBack() {
            window.history.back();
        }

        // Check NFC Support for Writing
        async function checkNFCSupport() {
            if ('NDEFReader' in window) {
                document.getElementById('nfcSupportStatus').innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-circle text-green-400 text-xs"></i>
                        <span class="text-green-400 font-semibold">‚úì NFC Writing Supported</span>
                    </div>
                `;
                return true;
            } else {
                document.getElementById('nfcSupportStatus').innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-circle text-red-400 text-xs"></i>
                        <span class="text-red-400">‚úó NFC Not Supported - Use Android Chrome/Edge</span>
                    </div>
                `;
                return false;
            }
        }

        // Load Pass Details by Reference
        async function loadPassDetails() {
            const passRef = document.getElementById('passReference').value.trim().toUpperCase();
            
            if (!passRef) {
                alert('Please enter a pass reference');
                return;
            }

            try {
                console.log('üîç Loading pass details for:', passRef);
                
                const response = await fetch(`/api/staff/all-inclusive/pass-by-reference/${passRef}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Property-ID': propertyId,
                        'X-User-ID': userId || '0'
                    }
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    alert('‚ùå Pass not found: ' + (data.error || 'Invalid pass reference'));
                    return;
                }

                currentPass = data.pass;
                displayPassDetails(currentPass);
                showEncodingCard();
                
            } catch (error) {
                console.error('‚ùå Error loading pass:', error);
                alert('Failed to load pass details: ' + error.message);
            }
        }

        // Display Pass Details
        function displayPassDetails(pass) {
            const card = document.getElementById('passDetailsCard');
            const content = document.getElementById('passDetailsContent');
            
            const tierColor = pass.tier_color || '#667eea';
            const tierIcon = pass.tier_icon || 'fa-star';
            
            content.innerHTML = `
                <div class="grid md:grid-cols-2 gap-6">
                    ${pass.face_photo_url ? `
                    <div class="md:col-span-2 flex justify-center">
                        <img src="${pass.face_photo_url}" 
                             alt="Guest Photo" 
                             class="w-32 h-32 rounded-full object-cover border-4 border-purple-500 shadow-lg">
                    </div>
                    ` : ''}
                    
                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-4 rounded-lg border-2 border-purple-200">
                        <p class="text-sm text-gray-600 mb-1 font-semibold">Pass Reference</p>
                        <p class="text-xl font-bold font-mono text-purple-600">${pass.pass_reference}</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-lg border-2 border-blue-200">
                        <p class="text-sm text-gray-600 mb-1 font-semibold">NFC ID</p>
                        <p class="text-xl font-bold font-mono text-blue-600">${pass.nfc_id || 'Not Generated'}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Guest Name</p>
                        <p class="font-bold text-lg">${pass.primary_guest_name}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Room Number</p>
                        <p class="font-bold text-lg">${pass.room_number || 'N/A'}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Tier</p>
                        <div class="flex items-center gap-2">
                            <i class="${tierIcon}" style="color: ${tierColor};"></i>
                            <span class="font-bold text-lg" style="color: ${tierColor}">${pass.tier_display_name || 'Standard'}</span>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Guests</p>
                        <p class="font-bold text-lg">${pass.num_adults || 0} Adults, ${pass.num_children || 0} Children</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Valid From</p>
                        <p class="font-bold">${new Date(pass.valid_from).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Valid Until</p>
                        <p class="font-bold">${new Date(pass.valid_until).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Pass Status</p>
                        <p class="font-bold text-lg ${pass.pass_status === 'active' ? 'text-green-600' : 'text-gray-600'}">
                            ${pass.pass_status ? pass.pass_status.toUpperCase() : 'UNKNOWN'}
                        </p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">NFC Enabled</p>
                        <p class="font-bold text-lg ${pass.nfc_enabled ? 'text-green-600' : 'text-red-600'}">
                            ${pass.nfc_enabled ? '‚úì Enabled' : '‚úó Disabled'}
                        </p>
                    </div>
                </div>
            `;
            
            card.classList.remove('hidden');
        }

        // Show Encoding Card
        function showEncodingCard() {
            if (!currentPass || !currentPass.nfc_id) {
                alert('‚ùå This pass does not have an NFC ID generated. Cannot encode.');
                return;
            }
            
            if (!currentPass.nfc_enabled) {
                alert('‚ö†Ô∏è Warning: NFC is disabled for this pass. It can still be encoded, but verification may fail.');
            }
            
            document.getElementById('encodingCard').classList.remove('hidden');
        }

        // Start Encoding Process
        async function startEncoding() {
            if (!currentPass || !currentPass.nfc_id) {
                alert('No pass loaded or NFC ID missing');
                return;
            }

            if (!('NDEFReader' in window)) {
                alert('‚ùå NFC is not supported on this device. Use Android Chrome/Edge.');
                return;
            }

            try {
                const encodeButton = document.getElementById('encodeButton');
                const encodingIcon = document.getElementById('encodingIcon');
                const encodingTitle = document.getElementById('encodingTitle');
                const encodingMessage = document.getElementById('encodingMessage');
                
                // Disable button
                encodeButton.disabled = true;
                encodeButton.classList.add('opacity-50', 'cursor-not-allowed');
                encodeButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Waiting for wristband...';
                
                // Update status
                encodingIcon.classList.add('encoding-active');
                encodingTitle.textContent = 'Tap Wristband Now';
                encodingMessage.textContent = 'Hold the blank NFC wristband to the back of your device';

                console.log('üî∑ Starting NFC write for:', currentPass.nfc_id);

                // Create NDEF writer
                const ndef = new NDEFReader();
                
                // Write NFC ID to tag
                await ndef.write({
                    records: [
                        {
                            recordType: "text",
                            data: currentPass.nfc_id
                        }
                    ]
                });

                console.log('‚úÖ NFC write successful!');

                // Log encoding to database
                await logEncoding(currentPass.pass_id, currentPass.nfc_id, 'success');

                // Show success
                showSuccess();
                
            } catch (error) {
                console.error('‚ùå NFC encoding error:', error);
                
                // Log failed encoding
                if (currentPass) {
                    await logEncoding(currentPass.pass_id, currentPass.nfc_id, 'failed', error.message);
                }
                
                showError('Encoding failed: ' + error.message);
                resetEncoder();
            }
        }

        // Log Encoding to Database
        async function logEncoding(passId, nfcId, result, errorMessage = null) {
            try {
                await fetch('/api/staff/all-inclusive/log-encoding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Property-ID': propertyId,
                        'X-User-ID': userId || '0'
                    },
                    body: JSON.stringify({
                        pass_id: passId,
                        nfc_id: nfcId,
                        staff_name: staffName,
                        device_info: navigator.userAgent,
                        encoding_result: result,
                        error_message: errorMessage
                    })
                });
            } catch (error) {
                console.error('Failed to log encoding:', error);
            }
        }

        // Show Success Result
        function showSuccess() {
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');
            
            resultContent.innerHTML = `
                <div class="success-bounce">
                    <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-lg mb-4">
                        <div class="flex items-center gap-4 mb-4">
                            <i class="fas fa-check-circle text-5xl text-green-500"></i>
                            <div>
                                <h3 class="text-2xl font-bold text-green-800">Encoding Successful!</h3>
                                <p class="text-green-600">Wristband is ready to use</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg mb-6">
                        <h4 class="font-bold text-lg mb-2 text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>What's Next?
                        </h4>
                        <ul class="space-y-2 text-sm text-blue-700">
                            <li class="flex items-start gap-2">
                                <i class="fas fa-check text-blue-500 mt-1"></i>
                                <span>Give the encoded wristband to guest: <strong>${currentPass.primary_guest_name}</strong></span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fas fa-check text-blue-500 mt-1"></i>
                                <span>Guest can now tap wristband at restaurants, pools, beaches, etc.</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fas fa-check text-blue-500 mt-1"></i>
                                <span>Staff can verify using NFC Scanner: /staff/nfc-scanner</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fas fa-check text-blue-500 mt-1"></i>
                                <span>Backup QR code and face recognition still available</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <button onclick="encodeAnother()" 
                                class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Encode Another Wristband
                        </button>
                        <button onclick="testWristband()" 
                                class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors">
                            <i class="fas fa-vial mr-2"></i>Test Wristband Now
                        </button>
                    </div>
                </div>
            `;
            
            resultCard.classList.remove('hidden');
            document.getElementById('encodingCard').classList.add('hidden');
            
            // Refresh encoding history
            loadEncodingHistory();
        }

        // Show Error
        function showError(message) {
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');
            
            resultContent.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg">
                    <div class="flex items-center gap-4 mb-4">
                        <i class="fas fa-times-circle text-5xl text-red-500"></i>
                        <div>
                            <h3 class="text-2xl font-bold text-red-800">Encoding Failed</h3>
                            <p class="text-red-600">${message}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-lightbulb mr-2"></i>
                            <strong>Troubleshooting:</strong>
                        </p>
                        <ul class="mt-2 text-sm text-yellow-700 space-y-1 ml-6">
                            <li>‚Ä¢ Make sure NFC is enabled on your device</li>
                            <li>‚Ä¢ Hold wristband close to the back of device (1-2cm)</li>
                            <li>‚Ä¢ Keep wristband still for 1-2 seconds</li>
                            <li>‚Ä¢ Try a different wristband if this one is damaged</li>
                        </ul>
                    </div>
                    
                    <button onclick="resetEncoder()" 
                            class="w-full mt-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors">
                        <i class="fas fa-redo mr-2"></i>Try Again
                    </button>
                </div>
            `;
            
            resultCard.classList.remove('hidden');
        }

        // Reset Encoder
        function resetEncoder() {
            document.getElementById('resultCard').classList.add('hidden');
            document.getElementById('encodingCard').classList.remove('hidden');
            
            const encodeButton = document.getElementById('encodeButton');
            const encodingIcon = document.getElementById('encodingIcon');
            const encodingTitle = document.getElementById('encodingTitle');
            const encodingMessage = document.getElementById('encodingMessage');
            
            encodeButton.disabled = false;
            encodeButton.classList.remove('opacity-50', 'cursor-not-allowed');
            encodeButton.innerHTML = '<i class="fas fa-wifi mr-3" style="transform: rotate(-45deg);"></i>Encode Wristband Now';
            
            encodingIcon.classList.remove('encoding-active');
            encodingTitle.textContent = 'Ready to Encode';
            encodingMessage.textContent = 'Click the button below to start encoding';
        }

        // Encode Another Wristband
        function encodeAnother() {
            document.getElementById('passReference').value = '';
            document.getElementById('passDetailsCard').classList.add('hidden');
            document.getElementById('encodingCard').classList.add('hidden');
            document.getElementById('resultCard').classList.add('hidden');
            currentPass = null;
            document.getElementById('passReference').focus();
        }

        // Test Wristband (redirect to NFC scanner)
        function testWristband() {
            window.open('/staff/nfc-scanner', '_blank');
        }

        // Load Encoding History
        async function loadEncodingHistory() {
            try {
                const response = await fetch(`/api/staff/all-inclusive/encoding-history`, {
                    headers: {
                        'X-Property-ID': propertyId,
                        'X-User-ID': userId || '0'
                    }
                });

                const data = await response.json();

                if (data.success && data.encodings && data.encodings.length > 0) {
                    const historyDiv = document.getElementById('encodingHistory');
                    historyDiv.innerHTML = data.encodings.slice(0, 5).map(enc => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg text-sm">
                            <div class="flex items-center gap-3">
                                <i class="fas ${enc.encoding_result === 'success' ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                                <div>
                                    <p class="font-semibold">${enc.pass_reference || 'Unknown'}</p>
                                    <p class="text-xs text-gray-500">${enc.guest_name || 'N/A'} - ${enc.staff_name || 'Unknown Staff'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-600">${new Date(enc.encoded_at).toLocaleTimeString()}</p>
                                <p class="text-xs font-mono text-gray-500">${enc.nfc_id ? enc.nfc_id.substring(0, 12) + '...' : ''}</p>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load encoding history:', error);
            }
        }

        // Initialize on page load
        window.onload = async () => {
            await checkNFCSupport();
            await loadEncodingHistory();
            document.getElementById('passReference').focus();
        };
    </script>
</body>
</html>
