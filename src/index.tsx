import { Hono } from 'hono'
import { cors } from 'hono/cors'
import { serveStatic } from 'hono/cloudflare-workers'

// Type definitions for Cloudflare bindings
type Bindings = {
  DB: D1Database
}

const app = new Hono<{ Bindings: Bindings }>()

// Enable CORS for API routes
app.use('/api/*', cors())

// ============================================
// UTILITY FUNCTIONS
// ============================================

// Generate unique booking reference
function generateBookingReference(): string {
  const date = new Date().toISOString().slice(2, 10).replace(/-/g, '')
  const random = Math.random().toString(36).substring(2, 6).toUpperCase()
  return `HB-${date}-${random}`
}

// Generate session token
function generateSessionToken(): string {
  return crypto.randomUUID()
}

// Language configuration
const SUPPORTED_LANGUAGES = {
  'en': { name: 'English', native: 'English', flag: 'ðŸ‡¬ðŸ‡§' },
  'ar': { name: 'Arabic', native: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ðŸ‡¸ðŸ‡¦' },
  'de': { name: 'German', native: 'Deutsch', flag: 'ðŸ‡©ðŸ‡ª' },
  'ru': { name: 'Russian', native: 'Ð ÑƒÑÑÐºÐ¸Ð¹', flag: 'ðŸ‡·ðŸ‡º' },
  'pl': { name: 'Polish', native: 'Polski', flag: 'ðŸ‡µðŸ‡±' },
  'it': { name: 'Italian', native: 'Italiano', flag: 'ðŸ‡®ðŸ‡¹' },
  'fr': { name: 'French', native: 'FranÃ§ais', flag: 'ðŸ‡«ðŸ‡·' },
  'cs': { name: 'Czech', native: 'ÄŒeÅ¡tina', flag: 'ðŸ‡¨ðŸ‡¿' },
  'uk': { name: 'Ukrainian', native: 'Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°', flag: 'ðŸ‡ºðŸ‡¦' },
  'zh': { name: 'Chinese (Simplified)', native: 'ç®€ä½“ä¸­æ–‡', flag: 'ðŸ‡¨ðŸ‡³' },
  'es': { name: 'Spanish', native: 'EspaÃ±ol', flag: 'ðŸ‡ªðŸ‡¸' },
  'ja': { name: 'Japanese', native: 'æ—¥æœ¬èªž', flag: 'ðŸ‡¯ðŸ‡µ' },
  'pt': { name: 'Portuguese', native: 'PortuguÃªs', flag: 'ðŸ‡µðŸ‡¹' },
  'ko': { name: 'Korean', native: 'í•œêµ­ì–´', flag: 'ðŸ‡°ðŸ‡·' },
  'hi': { name: 'Hindi', native: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€', flag: 'ðŸ‡®ðŸ‡³' },
  'tr': { name: 'Turkish', native: 'TÃ¼rkÃ§e', flag: 'ðŸ‡¹ðŸ‡·' },
  'el': { name: 'Greek', native: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬', flag: 'ðŸ‡¬ðŸ‡·' },
  'sv': { name: 'Swedish', native: 'Svenska', flag: 'ðŸ‡¸ðŸ‡ª' },
  'no': { name: 'Norwegian', native: 'Norsk', flag: 'ðŸ‡³ðŸ‡´' },
  'da': { name: 'Danish', native: 'Dansk', flag: 'ðŸ‡©ðŸ‡°' },
  'ro': { name: 'Romanian', native: 'RomÃ¢nÄƒ', flag: 'ðŸ‡·ðŸ‡´' },
  'hu': { name: 'Hungarian', native: 'Magyar', flag: 'ðŸ‡­ðŸ‡º' },
  'fi': { name: 'Finnish', native: 'Suomi', flag: 'ðŸ‡«ðŸ‡®' },
  'hr': { name: 'Croatian', native: 'Hrvatski', flag: 'ðŸ‡­ðŸ‡·' },
  'sk': { name: 'Slovak', native: 'SlovenÄina', flag: 'ðŸ‡¸ðŸ‡°' },
  'bg': { name: 'Bulgarian', native: 'Ð‘ÑŠÐ»Ð³Ð°Ñ€ÑÐºÐ¸', flag: 'ðŸ‡§ðŸ‡¬' },
  'sr': { name: 'Serbian', native: 'Ð¡Ñ€Ð¿ÑÐºÐ¸', flag: 'ðŸ‡·ðŸ‡¸' },
  'sl': { name: 'Slovenian', native: 'SlovenÅ¡Äina', flag: 'ðŸ‡¸ðŸ‡®' },
  'th': { name: 'Thai', native: 'à¹„à¸—à¸¢', flag: 'ðŸ‡¹ðŸ‡­' },
  'id': { name: 'Indonesian', native: 'Bahasa Indonesia', flag: 'ðŸ‡®ðŸ‡©' },
  'vi': { name: 'Vietnamese', native: 'Tiáº¿ng Viá»‡t', flag: 'ðŸ‡»ðŸ‡³' },
  'tl': { name: 'Filipino', native: 'Tagalog', flag: 'ðŸ‡µðŸ‡­' },
  'ms': { name: 'Malay', native: 'Bahasa Melayu', flag: 'ðŸ‡²ðŸ‡¾' }
}

// Helper function to populate language selectors (called from guest pages)
function populateLanguageSelector(selectorId: string, enabledLangs: string[] | null = null) {
  const selector = document.getElementById(selectorId) as HTMLSelectElement
  if (!selector) return
  
  // If no enabled languages specified, show all
  const langsToShow = enabledLangs || Object.keys(SUPPORTED_LANGUAGES)
  
  selector.innerHTML = ''
  langsToShow.forEach(code => {
    const lang = SUPPORTED_LANGUAGES[code]
    if (lang) {
      const option = document.createElement('option')
      option.value = code
      option.textContent = `${lang.flag} ${lang.native}`
      selector.appendChild(option)
    }
  })
}

// AI Translation using OpenAI GPT-4 (for 100% accurate tourism translations)
async function translateWithAI(texts: string[], targetLang: string, apiKey: string): Promise<string[]> {
  if (!texts || texts.length === 0) return []
  
  const languageNames: Record<string, string> = {
    'ar': 'Modern Standard Arabic',
    'de': 'German', 
    'ru': 'Russian',
    'pl': 'Polish',
    'it': 'Italian',
    'fr': 'French',
    'cs': 'Czech',
    'uk': 'Ukrainian',
    'zh': 'Simplified Chinese',
    'es': 'Spanish',
    'ja': 'Japanese',
    'pt': 'Portuguese',
    'ko': 'Korean',
    'hi': 'Hindi',
    'tr': 'Turkish',
    'el': 'Greek',
    'sv': 'Swedish',
    'no': 'Norwegian',
    'da': 'Danish',
    'ro': 'Romanian',
    'hu': 'Hungarian',
    'fi': 'Finnish',
    'hr': 'Croatian',
    'sk': 'Slovak',
    'bg': 'Bulgarian',
    'sr': 'Serbian',
    'sl': 'Slovenian',
    'th': 'Thai',
    'id': 'Indonesian',
    'vi': 'Vietnamese',
    'tl': 'Filipino/Tagalog',
    'ms': 'Malay'
  }
  
  try {
    const combinedText = texts.join('\n---SPLIT---\n')
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4',
        messages: [{
          role: 'system',
          content: `You are a professional tourism translator specializing in hotel, resort, and travel content for Egypt Red Sea destinations (Hurghada, Marsa Alam). 

CRITICAL REQUIREMENTS:
- Translate with 100% accuracy to ${languageNames[targetLang]}
- Maintain tourism marketing tone and appeal
- Preserve formatting, punctuation, and special characters
- Keep proper nouns (hotel names, locations) unchanged
- Use appropriate formality level for hospitality industry
- Ensure cultural appropriateness for ${languageNames[targetLang]} speakers
- Output translations separated by ---SPLIT--- markers
- Output ONLY the translations, NO explanations or notes`
        }, {
          role: 'user',
          content: combinedText
        }],
        temperature: 0.2,
        max_tokens: 2000
      })
    })
    
    if (!response.ok) {
      console.error('Translation API error:', await response.text())
      return texts // Fallback to original
    }
    
    const data: any = await response.json()
    const translatedText = data.choices?.[0]?.message?.content?.trim()
    
    if (!translatedText) return texts
    
    return translatedText.split('---SPLIT---').map((t: string) => t.trim())
  } catch (error) {
    console.error(`Translation error for ${targetLang}:`, error)
    return texts // Fallback to original text
  }
}

// Helper function to translate activity content
async function translateActivityContent(
  titleEn: string,
  shortDescriptionEn: string,
  targetLang: string,
  apiKey: string
): Promise<{ title: string; short_description: string }> {
  try {
    const translated = await translateWithAI(
      [titleEn, shortDescriptionEn],
      targetLang,
      apiKey
    );
    
    return {
      title: translated[0] || titleEn,
      short_description: translated[1] || shortDescriptionEn
    };
  } catch (error) {
    console.error('Activity translation error:', error);
    return {
      title: titleEn,
      short_description: shortDescriptionEn
    };
  }
}

// ============================================
// STATIC FILES - Serve GuestConnect logo and other assets
// ============================================

// Serve static files from public directory (Cloudflare Pages will handle this automatically)

// ============================================
// SAAS HOMEPAGE
// ============================================

app.get('/', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GuestConnect - Digital Guest Experience Platform for Hotels & Resorts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .gradient-text {
            background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .feature-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .feature-card:hover {
            transform: translateY(-4px);
        }
    </style>
</head>
<body class="bg-white">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full bg-white/98 backdrop-blur-sm border-b border-gray-100 z-50">
        <div class="max-w-7xl mx-auto px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center">
                    <!-- GuestConnect Logo -->
                    <img src="https://www.genspark.ai/api/files/s/Az5K2rEF" alt="GuestConnect - Your Resort, Connected" class="h-14 w-auto">
                </div>
                <div class="hidden md:flex items-center space-x-10">
                    <a href="#how-it-works" class="text-sm font-medium text-gray-600 hover:text-gray-900 transition">How It Works</a>
                    <a href="#features" class="text-sm font-medium text-gray-600 hover:text-gray-900 transition">Features</a>
                    <a href="/admin/dashboard" class="text-sm font-medium text-gray-600 hover:text-gray-900 transition">Login</a>
                    <a href="/admin/dashboard" class="bg-gray-900 text-white px-5 py-2.5 rounded-md hover:bg-gray-800 transition text-sm font-medium">
                        Get Started
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="pt-32 pb-20 px-6">
        <div class="max-w-7xl mx-auto">
            <div class="max-w-4xl mx-auto text-center mb-16">
                <h1 class="text-6xl md:text-7xl font-light text-gray-900 mb-8 leading-[1.1] tracking-tight">
                    One QR code<br/>in every room
                </h1>
                <p class="text-xl text-gray-600 mb-4 leading-relaxed font-light max-w-2xl mx-auto">
                    Guests scan. They see everythingâ€”your restaurants, events, spa, activities.
                </p>
                <p class="text-xl text-gray-600 mb-12 leading-relaxed font-light max-w-2xl mx-auto">
                    All branded to your hotel. No app download required.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="/admin/dashboard" class="bg-gray-900 text-white px-8 py-4 rounded-md hover:bg-gray-800 transition font-medium text-base">
                        Start Building
                    </a>
                    <a href="#how-it-works" class="bg-white text-gray-900 px-8 py-4 rounded-md hover:bg-gray-50 transition font-medium border border-gray-200 text-base">
                        See How It Works
                    </a>
                </div>
            </div>

            <!-- Hero Visual: QR Code in Hotel Room -->
            <div class="max-w-5xl mx-auto">
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl overflow-hidden border border-gray-200 shadow-lg">
                    <div class="relative">
                        <!-- Beautiful Hotel Room Image with QR Code -->
                        <img src="https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=1400&q=80" 
                             alt="Luxury hotel room with QR code on nightstand" 
                             class="w-full h-[500px] object-cover">
                        
                        <!-- Overlay with QR Code Card -->
                        <div class="absolute inset-0 bg-black/20 flex items-center justify-center">
                            <div class="bg-white p-8 rounded-xl shadow-2xl transform hover:scale-105 transition-transform duration-300">
                                <div class="text-center">
                                    <div class="w-48 h-48 mx-auto mb-4">
                                        <svg viewBox="0 0 100 100" class="w-full h-full">
                                            <rect width="100" height="100" fill="white"/>
                                            <!-- QR Code Pattern -->
                                            <rect x="10" y="10" width="25" height="25" fill="black"/>
                                            <rect x="65" y="10" width="25" height="25" fill="black"/>
                                            <rect x="10" y="65" width="25" height="25" fill="black"/>
                                            <rect x="15" y="15" width="15" height="15" fill="white"/>
                                            <rect x="70" y="15" width="15" height="15" fill="white"/>
                                            <rect x="15" y="70" width="15" height="15" fill="white"/>
                                            <rect x="20" y="20" width="5" height="5" fill="black"/>
                                            <rect x="75" y="20" width="5" height="5" fill="black"/>
                                            <rect x="20" y="75" width="5" height="5" fill="black"/>
                                            <!-- Additional QR patterns -->
                                            <rect x="45" y="15" width="5" height="5" fill="black"/>
                                            <rect x="55" y="20" width="5" height="5" fill="black"/>
                                            <rect x="40" y="25" width="5" height="5" fill="black"/>
                                            <rect x="50" y="30" width="5" height="5" fill="black"/>
                                            <rect x="60" y="35" width="5" height="5" fill="black"/>
                                            <rect x="45" y="40" width="5" height="5" fill="black"/>
                                            <rect x="55" y="45" width="5" height="5" fill="black"/>
                                            <rect x="40" y="50" width="5" height="5" fill="black"/>
                                            <rect x="50" y="55" width="5" height="5" fill="black"/>
                                            <rect x="60" y="60" width="5" height="5" fill="black"/>
                                        </svg>
                                    </div>
                                    <p class="text-base font-semibold text-gray-900 mb-1">Scan to Explore</p>
                                    <p class="text-sm text-gray-600">Room 305</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mt-6">Unique QR code per room</p>
                        </div>

                        <!-- Arrow -->
                        <div class="text-center">
                            <i class="fas fa-arrow-right text-4xl text-gray-300 hidden md:block"></i>
                            <i class="fas fa-arrow-down text-4xl text-gray-300 md:hidden"></i>
                        </div>

                        <!-- Guest Experience -->
                        <div class="md:col-span-2 mt-8">
                            <div class="bg-white rounded-xl p-8 shadow-lg">
                                <div class="text-center mb-6">
                                    <h3 class="text-2xl font-semibold text-gray-900 mb-2">What Guests See</h3>
                                    <p class="text-gray-600">Instant access to everything your hotel offers</p>
                                </div>
                                <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
                                    <div class="text-center">
                                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                                            <i class="fas fa-utensils text-gray-600"></i>
                                        </div>
                                        <p class="text-xs text-gray-600">Restaurants</p>
                                    </div>
                                    <div class="text-center">
                                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                                            <i class="fas fa-calendar-star text-gray-600"></i>
                                        </div>
                                        <p class="text-xs text-gray-600">Events</p>
                                    </div>
                                    <div class="text-center">
                                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                                            <i class="fas fa-spa text-gray-600"></i>
                                        </div>
                                        <p class="text-xs text-gray-600">Spa</p>
                                    </div>
                                    <div class="text-center">
                                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                                            <i class="fas fa-hiking text-gray-600"></i>
                                        </div>
                                        <p class="text-xs text-gray-600">Activities</p>
                                    </div>
                                    <div class="text-center">
                                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                                            <i class="fas fa-concierge-bell text-gray-600"></i>
                                        </div>
                                        <p class="text-xs text-gray-600">Services</p>
                                    </div>
                                    <div class="text-center">
                                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                                            <i class="fas fa-map text-gray-600"></i>
                                        </div>
                                        <p class="text-xs text-gray-600">Hotel Map</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- How It Works -->
    <section id="how-it-works" class="py-24 px-6 bg-gray-50">
        <div class="max-w-7xl mx-auto">
            <div class="max-w-2xl mb-20">
                <h2 class="text-4xl md:text-5xl font-light text-gray-900 mb-6">How it works</h2>
                <p class="text-lg text-gray-600 leading-relaxed">Simple for hotels. Seamless for guests.</p>
            </div>

            <div class="grid md:grid-cols-3 gap-16">
                <!-- Step 1 -->
                <div>
                    <div class="text-6xl font-light text-gray-200 mb-6">01</div>
                    <h3 class="text-2xl font-medium text-gray-900 mb-4">Build your page</h3>
                    <p class="text-gray-600 leading-relaxed mb-6">
                        Add your logo, set your colors and fonts. Upload your restaurants, events, spa services, activities. Everything is customizable.
                    </p>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>Custom branding (colors, fonts, logo)</li>
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>Add offerings with photos & videos</li>
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>Connect activity vendors</li>
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>8-language AI translation</li>
                    </ul>
                </div>

                <!-- Step 2 -->
                <div>
                    <div class="text-6xl font-light text-gray-200 mb-6">02</div>
                    <h3 class="text-2xl font-medium text-gray-900 mb-4">Generate QR codes</h3>
                    <p class="text-gray-600 leading-relaxed mb-6">
                        Create a unique QR code for each room. Print and place them. Guests scan with their phone cameraâ€”no app needed.
                    </p>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>Unique code per room</li>
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>Track which rooms scan</li>
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>No app download required</li>
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>Works on any phone</li>
                    </ul>
                </div>

                <!-- Step 3 -->
                <div>
                    <div class="text-6xl font-light text-gray-200 mb-6">03</div>
                    <h3 class="text-2xl font-medium text-gray-900 mb-4">Guests browse & book</h3>
                    <p class="text-gray-600 leading-relaxed mb-6">
                        They see everything instantly. Book activities, check event times, browse restaurantsâ€”all in their language.
                    </p>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>Instant activity booking</li>
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>Real-time availability</li>
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>Auto-translated content</li>
                        <li class="flex items-center gap-2"><span class="w-1 h-1 bg-gray-400 rounded-full"></span>Callback requests</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="py-24 px-6">
        <div class="max-w-7xl mx-auto">
            <div class="max-w-2xl mb-20">
                <h2 class="text-4xl md:text-5xl font-light text-gray-900 mb-6">Complete control over<br/>your guest experience</h2>
                <p class="text-lg text-gray-600 leading-relaxed">Everything you need to create a premium digital experience for your guests.</p>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-12">
                <!-- Feature 1 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-palette text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Full Brand Customization</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Your colors, fonts, logo, and layout. Choose from modern, elegant, or minimal styles. Every pixel matches your brand.
                        </p>
                    </div>
                </div>

                <!-- Feature 2 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-language text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">8-Language AI Translation</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            English, Arabic, German, French, Italian, Russian, Polish, Czech, Ukrainian. Powered by GPT-4 for 100% accurate tourism translations.
                        </p>
                    </div>
                </div>

                <!-- Feature 3 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-utensils text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Restaurants & Dining</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Add all your restaurants with menus, photos, videos, opening hours, locations. Guests see everything at a glance.
                        </p>
                    </div>
                </div>

                <!-- Feature 4 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-calendar-alt text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Events & Entertainment</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Showcase your events, live music, themed nights. Include dates, times, photos, videos. Keep guests informed and engaged.
                        </p>
                    </div>
                </div>

                <!-- Feature 5 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-hiking text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Activity Booking System</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Full booking system for excursions and activities. Connect local vendors. Real-time availability. Automated confirmations. Commission tracking.
                        </p>
                    </div>
                </div>

                <!-- Feature 6 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-spa text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Spa & Wellness</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Display spa treatments, massage services, wellness programs. Add pricing, duration, photos, booking options.
                        </p>
                    </div>
                </div>

                <!-- Feature 7 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-map-marked-alt text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Interactive Hotel Map</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Upload your hotel map or grounds layout. Floating button for easy access. Guests find their way around effortlessly.
                        </p>
                    </div>
                </div>

                <!-- Feature 8 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-video text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Photos & Videos</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Add videos to activities and offerings. Upload multiple photos. Show guests exactly what to expect.
                        </p>
                    </div>
                </div>

                <!-- Feature 9 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Analytics Dashboard</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Track bookings, QR scans, popular activities, revenue. See which rooms engage most. Make data-driven decisions.
                        </p>
                    </div>
                </div>

                <!-- Feature 10 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-plug text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Vendor Integration</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Activity vendors get their own dashboard. They manage listings, pricing, availability. You control commissions and approvals.
                        </p>
                    </div>
                </div>

                <!-- Feature 11 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-qrcode text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">QR Code Management</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Generate unique QR codes for each room. Download as PDFs. Track which codes are scanned. Regenerate anytime.
                        </p>
                    </div>
                </div>

                <!-- Feature 12 -->
                <div class="feature-card">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-gray-900 rounded-lg flex items-center justify-center mb-4">
                            <i class="fas fa-plus-circle text-white"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Custom Sections</h3>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            Create any section you needâ€”kids club, beach services, golf, diving center. Fully customizable categories with custom icons.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="py-24 px-6 bg-gray-900 text-white">
        <div class="max-w-4xl mx-auto text-center">
            <h2 class="text-4xl md:text-5xl font-light mb-6">Ready to get started?</h2>
            <p class="text-xl text-gray-300 mb-12 font-light">Create your hotel's digital guest experience today.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="/admin/dashboard" class="bg-white text-gray-900 px-8 py-4 rounded-md hover:bg-gray-100 transition font-medium">
                    Start Building Now
                </a>
                <a href="/vendor/login" class="bg-transparent border border-white text-white px-8 py-4 rounded-md hover:bg-white/10 transition font-medium">
                    Vendor Login
                </a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-100 py-12 px-6">
        <div class="max-w-7xl mx-auto">
            <div class="grid md:grid-cols-4 gap-12 mb-12">
                <div class="md:col-span-2">
                    <img src="https://www.genspark.ai/api/files/s/Az5K2rEF" alt="GuestConnect - Your Resort, Connected" class="h-12 w-auto mb-4">
                    <p class="text-sm text-gray-600 leading-relaxed max-w-md">
                        Digital guest experience platform for hotels and resorts. QR-powered in-room access to everything your property offers.
                    </p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900 mb-4 text-sm">Platform</h4>
                    <ul class="space-y-3 text-sm text-gray-600">
                        <li><a href="#features" class="hover:text-gray-900 transition">Features</a></li>
                        <li><a href="#how-it-works" class="hover:text-gray-900 transition">How It Works</a></li>
                        <li><a href="/admin/dashboard" class="hover:text-gray-900 transition">Demo</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900 mb-4 text-sm">Access</h4>
                    <ul class="space-y-3 text-sm text-gray-600">
                        <li><a href="/admin/dashboard" class="hover:text-gray-900 transition">Hotel Admin</a></li>
                        <li><a href="/vendor/login" class="hover:text-gray-900 transition">Activity Vendor</a></li>
                        <li><a href="/superadmin" class="hover:text-gray-900 transition">Super Admin</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-100 pt-8 text-center">
                <p class="text-sm text-gray-500">&copy; 2024 GuestConnect. Digital guest experience platform.</p>
            </div>
        </div>
    </footer>
</body>
</html>
  `)
})

// ============================================
// GUEST API ROUTES
// ============================================

// Welcome page - QR code entry point
app.get('/api/welcome/:property_slug/:room_token', async (c) => {
  const { property_slug, room_token } = c.req.param()
  const { DB } = c.env

  try {
    // Validate room token and get property/room info
    const room = await DB.prepare(`
      SELECT r.*, p.* FROM rooms r
      JOIN properties p ON r.property_id = p.property_id
      WHERE r.qr_code_data = ? AND p.slug = ? AND p.status = 'active'
    `).bind(room_token, property_slug).first()

    if (!room) {
      return c.json({ error: 'Invalid QR code or property' }, 404)
    }

    // Create guest session
    const session_token = generateSessionToken()
    const guest = await DB.prepare(`
      INSERT INTO guests (property_id, room_id, session_token, preferred_language)
      VALUES (?, ?, ?, 'en')
      RETURNING guest_id, session_token
    `).bind(room.property_id, room.room_id, session_token).first()

    // Get featured activities
    const featured = await DB.prepare(`
      SELECT a.*, v.business_name as vendor_name, c.name_en as category_name
      FROM activities a
      JOIN vendors v ON a.vendor_id = v.vendor_id
      JOIN categories c ON a.category_id = c.category_id
      JOIN vendor_properties vp ON v.vendor_id = vp.vendor_id
      WHERE vp.property_id = ? AND a.status = 'active' AND a.is_featured = 1
      ORDER BY a.popularity_score DESC
      LIMIT 6
    `).bind(room.property_id).all()

    // Log analytics event
    await DB.prepare(`
      INSERT INTO analytics_events (property_id, guest_id, event_type, entity_id, metadata)
      VALUES (?, ?, 'qr_scan', ?, ?)
    `).bind(room.property_id, guest.guest_id, room.room_id, JSON.stringify({ room_token })).run()

    return c.json({
      session_token: guest.session_token,
      property: {
        name: room.name,
        slug: room.slug,
        logo: room.brand_logo_url,
        primary_color: room.primary_color,
        secondary_color: room.secondary_color,
        supported_languages: JSON.parse(room.supported_languages)
      },
      room: {
        number: room.room_number,
        type: room.room_type
      },
      featured_activities: featured.results
    })
  } catch (error) {
    console.error('Welcome API error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get all categories
app.get('/api/categories', async (c) => {
  const { DB } = c.env
  const lang = c.req.query('lang') || 'en'

  try {
    const categories = await DB.prepare(`
      SELECT 
        category_id,
        ${lang === 'ar' ? 'name_ar' : 'name_en'} as name,
        slug,
        icon_name,
        display_order
      FROM categories
      WHERE parent_category_id IS NULL
      ORDER BY display_order ASC
    `).all()

    return c.json({ categories: categories.results })
  } catch (error) {
    console.error('Categories API error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get activities catalog
app.get('/api/activities', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  const category = c.req.query('category')
  const sort = c.req.query('sort') || 'popularity'
  const lang = c.req.query('lang') || 'en'
  const page = parseInt(c.req.query('page') || '1')
  const per_page = 20

  try {
    let query = `
      SELECT 
        a.activity_id,
        ${lang === 'ar' ? 'a.title_ar' : 'a.title_en'} as title,
        ${lang === 'ar' ? 'a.short_description_ar' : 'a.short_description_en'} as short_description,
        a.images,
        a.duration_minutes,
        a.capacity_per_slot,
        a.price,
        a.currency,
        a.is_featured,
        v.business_name as vendor_name,
        v.slug as vendor_slug,
        ${lang === 'ar' ? 'c.name_ar' : 'c.name_en'} as category_name,
        c.slug as category_slug
      FROM activities a
      JOIN vendors v ON a.vendor_id = v.vendor_id
      JOIN categories c ON a.category_id = c.category_id
      JOIN vendor_properties vp ON v.vendor_id = vp.vendor_id
      WHERE vp.property_id = ? AND a.status = 'active'
    `

    const params: any[] = [property_id]

    if (category) {
      query += ` AND c.slug = ?`
      params.push(category)
    }

    // Sorting
    if (sort === 'price') {
      query += ` ORDER BY a.price ASC`
    } else if (sort === 'duration') {
      query += ` ORDER BY a.duration_minutes ASC`
    } else {
      query += ` ORDER BY a.popularity_score DESC`
    }

    query += ` LIMIT ? OFFSET ?`
    params.push(per_page, (page - 1) * per_page)

    const activities = await DB.prepare(query).bind(...params).all()

    return c.json({
      activities: activities.results,
      page,
      per_page,
      total: activities.results.length
    })
  } catch (error) {
    console.error('Activities API error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get single activity details
app.get('/api/activities/:activity_id', async (c) => {
  const { DB } = c.env
  const { activity_id } = c.req.param()
  const lang = c.req.query('lang') || 'en'

  try {
    const activity = await DB.prepare(`
      SELECT 
        a.*,
        ${lang === 'ar' ? 'a.title_ar' : 'a.title_en'} as title,
        ${lang === 'ar' ? 'a.short_description_ar' : 'a.short_description_en'} as short_description,
        ${lang === 'ar' ? 'a.full_description_ar' : 'a.full_description_en'} as full_description,
        v.business_name as vendor_name,
        v.slug as vendor_slug,
        v.phone as vendor_phone,
        v.email as vendor_email,
        v.certifications as vendor_certifications,
        v.safety_rating as vendor_safety_rating,
        ${lang === 'ar' ? 'c.name_ar' : 'c.name_en'} as category_name
      FROM activities a
      JOIN vendors v ON a.vendor_id = v.vendor_id
      JOIN categories c ON a.category_id = c.category_id
      WHERE a.activity_id = ? AND a.status = 'active'
    `).bind(activity_id).first()

    if (!activity) {
      return c.json({ error: 'Activity not found' }, 404)
    }

    // Get availability schedule
    const schedule = await DB.prepare(`
      SELECT * FROM availability_schedule
      WHERE activity_id = ?
      ORDER BY day_of_week, start_time
    `).bind(activity_id).all()

    return c.json({
      activity: {
        ...activity,
        images: activity.images ? JSON.parse(activity.images) : [],
        requirements: activity.requirements ? JSON.parse(activity.requirements) : {},
        includes: activity.includes ? JSON.parse(activity.includes) : []
      },
      schedule: schedule.results
    })
  } catch (error) {
    console.error('Activity detail API error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get activity availability for specific date
app.get('/api/availability/:activity_id', async (c) => {
  const { DB } = c.env
  const { activity_id } = c.req.param()
  const date = c.req.query('date') // Format: YYYY-MM-DD

  try {
    const dayOfWeek = new Date(date).getDay()

    // Get scheduled slots for this day
    const slots = await DB.prepare(`
      SELECT 
        start_time,
        end_time,
        slots_available
      FROM availability_schedule
      WHERE activity_id = ?
        AND (day_of_week = ? OR specific_date = ?)
        AND (valid_from IS NULL OR valid_from <= ?)
        AND (valid_until IS NULL OR valid_until >= ?)
      ORDER BY start_time
    `).bind(activity_id, dayOfWeek, date, date, date).all()

    // Get existing bookings for this date
    const bookings = await DB.prepare(`
      SELECT activity_time, SUM(num_participants) as booked
      FROM bookings
      WHERE activity_id = ? AND activity_date = ? AND booking_status = 'confirmed'
      GROUP BY activity_time
    `).bind(activity_id, date).all()

    const bookedMap = new Map()
    bookings.results.forEach((b: any) => {
      bookedMap.set(b.activity_time, b.booked)
    })

    // Calculate availability
    const availability = slots.results.map((slot: any) => {
      const booked = bookedMap.get(slot.start_time) || 0
      return {
        time: slot.start_time,
        capacity: slot.slots_available,
        available: slot.slots_available - booked,
        booked
      }
    })

    return c.json({ date, slots: availability })
  } catch (error) {
    console.error('Availability API error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Create booking
app.post('/api/bookings', async (c) => {
  const { DB } = c.env
  const body = await c.req.json()
  const {
    session_token,
    activity_id,
    activity_date,
    activity_time,
    num_participants,
    guest_info,
    payment_method,
    guest_notes
  } = body

  try {
    // Validate session
    const guest = await DB.prepare(`
      SELECT * FROM guests WHERE session_token = ?
    `).bind(session_token).first()

    if (!guest) {
      return c.json({ error: 'Invalid session' }, 401)
    }

    // Get activity details
    const activity = await DB.prepare(`
      SELECT a.*, v.commission_rate
      FROM activities a
      JOIN vendors v ON a.vendor_id = v.vendor_id
      WHERE a.activity_id = ?
    `).bind(activity_id).first()

    if (!activity) {
      return c.json({ error: 'Activity not found' }, 404)
    }

    // Check availability
    const dayOfWeek = new Date(activity_date).getDay()
    const slot = await DB.prepare(`
      SELECT slots_available FROM availability_schedule
      WHERE activity_id = ? AND (day_of_week = ? OR specific_date = ?) AND start_time = ?
    `).bind(activity_id, dayOfWeek, activity_date, activity_time).first()

    if (!slot) {
      return c.json({ error: 'Time slot not available' }, 400)
    }

    // Check current bookings
    const booked = await DB.prepare(`
      SELECT SUM(num_participants) as total
      FROM bookings
      WHERE activity_id = ? AND activity_date = ? AND activity_time = ? AND booking_status = 'confirmed'
    `).bind(activity_id, activity_date, activity_time).first()

    const currentBooked = booked?.total || 0
    if (currentBooked + num_participants > slot.slots_available) {
      return c.json({ error: 'Not enough capacity available' }, 400)
    }

    // Update guest info if provided
    if (guest_info) {
      await DB.prepare(`
        UPDATE guests
        SET first_name = ?, last_name = ?, email = ?, phone = ?, preferred_language = ?
        WHERE guest_id = ?
      `).bind(
        guest_info.first_name,
        guest_info.last_name,
        guest_info.email,
        guest_info.phone,
        guest_info.preferred_language || 'en',
        guest.guest_id
      ).run()
    }

    // Calculate pricing
    const total_price = activity.price * num_participants
    const commission_amount = total_price * (activity.commission_rate / 100)

    // Generate booking reference
    const booking_reference = generateBookingReference()

    // Determine booking status based on payment method
    const booking_status = payment_method === 'pay_at_vendor' ? 'confirmed' : 'pending'
    const payment_status = payment_method === 'pay_at_vendor' ? 'pending' : 'pending'

    // Create booking
    const booking = await DB.prepare(`
      INSERT INTO bookings (
        booking_reference, guest_id, property_id, activity_id, vendor_id,
        activity_date, activity_time, duration_minutes, num_participants,
        total_price, currency, commission_amount, payment_status, payment_method,
        booking_status, guest_notes
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      RETURNING booking_id
    `).bind(
      booking_reference,
      guest.guest_id,
      guest.property_id,
      activity_id,
      activity.vendor_id,
      activity_date,
      activity_time,
      activity.duration_minutes,
      num_participants,
      total_price,
      activity.currency,
      commission_amount,
      payment_status,
      payment_method,
      booking_status,
      guest_notes || null
    ).first()

    // Log analytics event
    await DB.prepare(`
      INSERT INTO analytics_events (property_id, guest_id, event_type, entity_id, metadata)
      VALUES (?, ?, 'booking_created', ?, ?)
    `).bind(guest.property_id, guest.guest_id, booking.booking_id, JSON.stringify({ payment_method })).run()

    return c.json({
      success: true,
      booking_id: booking.booking_id,
      booking_reference,
      status: booking_status,
      payment_required: payment_method !== 'pay_at_vendor',
      total_price,
      currency: activity.currency
    })
  } catch (error) {
    console.error('Booking creation error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get booking details
app.get('/api/bookings/:booking_id', async (c) => {
  const { DB } = c.env
  const { booking_id } = c.req.param()
  const session_token = c.req.header('X-Session-Token')
  const lang = c.req.query('lang') || 'en'

  try {
    const booking = await DB.prepare(`
      SELECT 
        b.*,
        ${lang === 'ar' ? 'a.title_ar' : 'a.title_en'} as activity_title,
        a.images as activity_images,
        v.business_name as vendor_name,
        v.phone as vendor_phone,
        v.email as vendor_email,
        g.first_name,
        g.last_name,
        g.email as guest_email,
        g.phone as guest_phone
      FROM bookings b
      JOIN activities a ON b.activity_id = a.activity_id
      JOIN vendors v ON b.vendor_id = v.vendor_id
      JOIN guests g ON b.guest_id = g.guest_id
      WHERE b.booking_id = ? AND g.session_token = ?
    `).bind(booking_id, session_token).first()

    if (!booking) {
      return c.json({ error: 'Booking not found' }, 404)
    }

    return c.json({ booking })
  } catch (error) {
    console.error('Get booking error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get guest's bookings
app.get('/api/my-bookings', async (c) => {
  const { DB } = c.env
  const session_token = c.req.header('X-Session-Token')
  const status = c.req.query('status') || 'upcoming'
  const lang = c.req.query('lang') || 'en'

  try {
    const guest = await DB.prepare(`
      SELECT guest_id FROM guests WHERE session_token = ?
    `).bind(session_token).first()

    if (!guest) {
      return c.json({ error: 'Invalid session' }, 401)
    }

    let query = `
      SELECT 
        b.*,
        ${lang === 'ar' ? 'a.title_ar' : 'a.title_en'} as activity_title,
        a.images as activity_images,
        v.business_name as vendor_name,
        v.phone as vendor_phone
      FROM bookings b
      JOIN activities a ON b.activity_id = a.activity_id
      JOIN vendors v ON b.vendor_id = v.vendor_id
      WHERE b.guest_id = ?
    `

    if (status === 'upcoming') {
      query += ` AND b.activity_date >= date('now') AND b.booking_status = 'confirmed'`
    } else if (status === 'past') {
      query += ` AND b.activity_date < date('now')`
    } else if (status === 'cancelled') {
      query += ` AND b.booking_status = 'cancelled'`
    }

    query += ` ORDER BY b.activity_date DESC, b.activity_time DESC`

    const bookings = await DB.prepare(query).bind(guest.guest_id).all()

    return c.json({ bookings: bookings.results })
  } catch (error) {
    console.error('Get bookings error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Cancel booking
app.post('/api/bookings/:booking_id/cancel', async (c) => {
  const { DB } = c.env
  const { booking_id } = c.req.param()
  const session_token = c.req.header('X-Session-Token')

  try {
    const booking = await DB.prepare(`
      SELECT b.*, g.session_token
      FROM bookings b
      JOIN guests g ON b.guest_id = g.guest_id
      WHERE b.booking_id = ?
    `).bind(booking_id).first()

    if (!booking || booking.session_token !== session_token) {
      return c.json({ error: 'Booking not found' }, 404)
    }

    if (booking.booking_status === 'cancelled') {
      return c.json({ error: 'Booking already cancelled' }, 400)
    }

    // Check cancellation policy
    const activity = await DB.prepare(`
      SELECT cancellation_policy_hours FROM activities WHERE activity_id = ?
    `).bind(booking.activity_id).first()

    const activityDateTime = new Date(`${booking.activity_date}T${booking.activity_time}`)
    const now = new Date()
    const hoursUntilActivity = (activityDateTime.getTime() - now.getTime()) / (1000 * 60 * 60)

    if (hoursUntilActivity < activity.cancellation_policy_hours) {
      return c.json({
        error: `Cancellation must be made at least ${activity.cancellation_policy_hours} hours before activity`,
        refund_eligible: false
      }, 400)
    }

    // Cancel booking
    await DB.prepare(`
      UPDATE bookings
      SET booking_status = 'cancelled', cancelled_at = datetime('now')
      WHERE booking_id = ?
    `).bind(booking_id).run()

    return c.json({
      success: true,
      message: 'Booking cancelled successfully',
      refund_eligible: booking.payment_status === 'paid'
    })
  } catch (error) {
    console.error('Cancel booking error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get vendor profile
app.get('/api/vendors/:vendor_slug', async (c) => {
  const { DB } = c.env
  const { vendor_slug } = c.req.param()
  const property_id = c.req.query('property_id')
  const lang = c.req.query('lang') || 'en'

  try {
    const vendor = await DB.prepare(`
      SELECT 
        v.*,
        ${lang === 'ar' ? 'v.description_ar' : 'v.description_en'} as description,
        ${lang === 'ar' ? 'c.name_ar' : 'c.name_en'} as category_name
      FROM vendors v
      JOIN categories c ON v.category_id = c.category_id
      JOIN vendor_properties vp ON v.vendor_id = vp.vendor_id
      WHERE v.slug = ? AND vp.property_id = ? AND v.status = 'active'
    `).bind(vendor_slug, property_id).first()

    if (!vendor) {
      return c.json({ error: 'Vendor not found' }, 404)
    }

    // Get vendor's activities
    const activities = await DB.prepare(`
      SELECT 
        a.activity_id,
        ${lang === 'ar' ? 'a.title_ar' : 'a.title_en'} as title,
        ${lang === 'ar' ? 'a.short_description_ar' : 'a.short_description_en'} as short_description,
        a.images,
        a.duration_minutes,
        a.price,
        a.currency
      FROM activities a
      WHERE a.vendor_id = ? AND a.status = 'active'
      ORDER BY a.is_featured DESC, a.popularity_score DESC
    `).bind(vendor.vendor_id).all()

    return c.json({
      vendor: {
        ...vendor,
        cover_images: vendor.cover_images ? JSON.parse(vendor.cover_images) : [],
        certifications: vendor.certifications ? JSON.parse(vendor.certifications) : [],
        working_hours: vendor.working_hours ? JSON.parse(vendor.working_hours) : {},
        operating_hours: vendor.operating_hours ? JSON.parse(vendor.operating_hours) : {},
        social_media: vendor.social_media ? JSON.parse(vendor.social_media) : {},
        specialties: vendor.specialties ? JSON.parse(vendor.specialties) : [],
        languages_spoken: vendor.languages_spoken ? JSON.parse(vendor.languages_spoken) : []
      },
      activities: activities.results
    })
  } catch (error) {
    console.error('Vendor profile error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// ============================================
// VENDOR API ROUTES
// ============================================

// Vendor login
app.post('/api/vendor/login', async (c) => {
  const { DB } = c.env
  const { email, password } = await c.req.json()

  try {
    const vendor = await DB.prepare(`
      SELECT * FROM vendors WHERE email = ? AND status = 'active'
    `).bind(email).first()

    if (!vendor) {
      return c.json({ error: 'Invalid credentials' }, 401)
    }

    // Note: In production, use proper bcrypt password verification
    // For now, we're using the hashed password from seed data
    // You would normally do: const match = await bcrypt.compare(password, vendor.password_hash)
    
    return c.json({
      success: true,
      vendor: {
        vendor_id: vendor.vendor_id,
        business_name: vendor.business_name,
        email: vendor.email,
        slug: vendor.slug
      },
      // In production, generate and return a JWT token here
      token: `vendor-${vendor.vendor_id}-${Date.now()}`
    })
  } catch (error) {
    console.error('Vendor login error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Vendor dashboard stats
app.get('/api/vendor/dashboard', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')

  try {
    // Today's bookings
    const todayBookings = await DB.prepare(`
      SELECT COUNT(*) as count FROM bookings
      WHERE vendor_id = ? AND activity_date = date('now')
    `).bind(vendor_id).first()

    // This week's revenue
    const weekRevenue = await DB.prepare(`
      SELECT SUM(total_price - commission_amount) as revenue FROM bookings
      WHERE vendor_id = ? 
        AND activity_date >= date('now', 'weekday 0', '-7 days')
        AND payment_status = 'paid'
    `).bind(vendor_id).first()

    // Pending confirmations
    const pending = await DB.prepare(`
      SELECT COUNT(*) as count FROM bookings
      WHERE vendor_id = ? AND booking_status = 'pending'
    `).bind(vendor_id).first()

    // Upcoming bookings
    const upcoming = await DB.prepare(`
      SELECT 
        b.*,
        a.title_en as activity_title,
        g.first_name,
        g.last_name,
        g.email,
        g.phone
      FROM bookings b
      JOIN activities a ON b.activity_id = a.activity_id
      JOIN guests g ON b.guest_id = g.guest_id
      WHERE b.vendor_id = ? 
        AND b.activity_date >= date('now')
        AND b.booking_status = 'confirmed'
      ORDER BY b.activity_date, b.activity_time
      LIMIT 10
    `).bind(vendor_id).all()

    return c.json({
      kpis: {
        today_bookings: todayBookings.count,
        week_revenue: weekRevenue.revenue || 0,
        pending_confirmations: pending.count
      },
      upcoming_bookings: upcoming.results
    })
  } catch (error) {
    console.error('Vendor dashboard error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get vendor bookings
app.get('/api/vendor/bookings', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  const status = c.req.query('status') || 'upcoming'
  const date_from = c.req.query('date_from')
  const date_to = c.req.query('date_to')

  console.log('GET /api/vendor/bookings - vendor_id:', vendor_id)

  if (!vendor_id) {
    return c.json({ error: 'Vendor ID not provided' }, 401)
  }

  try {
    let query = `
      SELECT 
        b.*,
        a.title_en as activity_title,
        g.first_name,
        g.last_name,
        g.email,
        g.phone
      FROM bookings b
      JOIN activities a ON b.activity_id = a.activity_id
      JOIN guests g ON b.guest_id = g.guest_id
      WHERE b.vendor_id = ?
    `
    const params = [vendor_id]

    if (status === 'upcoming') {
      query += ` AND b.activity_date >= date('now') AND b.booking_status = 'confirmed'`
    } else if (status === 'past') {
      query += ` AND b.activity_date < date('now')`
    } else if (status === 'pending') {
      query += ` AND b.booking_status = 'pending'`
    }

    if (date_from) {
      query += ` AND b.activity_date >= ?`
      params.push(date_from)
    }

    if (date_to) {
      query += ` AND b.activity_date <= ?`
      params.push(date_to)
    }

    query += ` ORDER BY b.activity_date DESC, b.activity_time DESC`

    const bookings = await DB.prepare(query).bind(...params).all()

    console.log('Bookings query returned:', bookings.results?.length || 0, 'bookings')

    return c.json({ bookings: bookings.results || [] })
  } catch (error) {
    console.error('Vendor bookings error:', error)
    return c.json({ error: 'Internal server error: ' + error.message }, 500)
  }
})

// Get vendor callbacks
app.get('/api/vendor/callbacks', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  
  if (!vendor_id) {
    return c.json({ error: 'Vendor ID not provided' }, 401)
  }
  
  try {
    const callbacks = await DB.prepare(`
      SELECT 
        cr.*,
        a.title_en as activity_title,
        a.activity_id
      FROM callback_requests cr
      LEFT JOIN activities a ON cr.activity_id = a.activity_id
      WHERE cr.vendor_id = ? OR (cr.activity_id IS NOT NULL AND a.vendor_id = ?)
      ORDER BY cr.created_at DESC
    `).bind(vendor_id, vendor_id).all()
    
    return c.json(callbacks.results || [])
  } catch (error) {
    console.error('Get vendor callbacks error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Update callback status
app.patch('/api/vendor/callbacks/:request_id', async (c) => {
  const { DB } = c.env
  const { request_id } = c.req.param()
  const vendor_id = c.req.header('X-Vendor-ID')
  const { status } = await c.req.json()
  
  if (!vendor_id) {
    return c.json({ error: 'Vendor ID not provided' }, 401)
  }
  
  try {
    // Verify callback belongs to vendor's activity
    const callback = await DB.prepare(`
      SELECT cr.*, a.vendor_id
      FROM callback_requests cr
      LEFT JOIN activities a ON cr.activity_id = a.activity_id
      WHERE cr.request_id = ?
    `).bind(request_id).first()
    
    if (!callback || (callback.vendor_id && callback.vendor_id != vendor_id)) {
      return c.json({ error: 'Callback not found or access denied' }, 404)
    }
    
    const contacted_at = status === 'contacted' || status === 'completed' ? new Date().toISOString() : null
    
    await DB.prepare(`
      UPDATE callback_requests 
      SET status = ?, contacted_at = ?
      WHERE request_id = ?
    `).bind(status, contacted_at, request_id).run()
    
    return c.json({ success: true, message: 'Callback status updated' })
  } catch (error) {
    console.error('Update callback error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Update booking status (vendor confirms or completes)
app.patch('/api/vendor/bookings/:booking_id', async (c) => {
  const { DB } = c.env
  const { booking_id } = c.req.param()
  const vendor_id = c.req.header('X-Vendor-ID')
  const { status, vendor_notes, send_payment_link } = await c.req.json()

  try {
    const booking = await DB.prepare(`
      SELECT * FROM bookings WHERE booking_id = ? AND vendor_id = ?
    `).bind(booking_id, vendor_id).first()

    if (!booking) {
      return c.json({ error: 'Booking not found' }, 404)
    }

    // Update booking
    await DB.prepare(`
      UPDATE bookings
      SET booking_status = ?, vendor_notes = ?, payment_link_sent = ?, updated_at = datetime('now')
      WHERE booking_id = ?
    `).bind(status, vendor_notes || booking.vendor_notes, send_payment_link ? 1 : 0, booking_id).run()

    // TODO: If send_payment_link is true, send email with Stripe payment link

    return c.json({ success: true, message: 'Booking updated successfully' })
  } catch (error) {
    console.error('Update booking error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get vendor activities
app.get('/api/vendor/activities', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')

  console.log('GET /api/vendor/activities - vendor_id:', vendor_id)

  if (!vendor_id) {
    return c.json({ error: 'Vendor ID not provided' }, 401)
  }

  try {
    const activities = await DB.prepare(`
      SELECT 
        a.*,
        c.name_en as category_name
      FROM activities a
      JOIN categories c ON a.category_id = c.category_id
      WHERE a.vendor_id = ?
      ORDER BY a.created_at DESC
    `).bind(vendor_id).all()

    console.log('Activities query returned:', activities.results?.length || 0, 'activities')

    return c.json({ activities: activities.results || [] })
  } catch (error) {
    console.error('Vendor activities error:', error)
    return c.json({ error: 'Internal server error: ' + error.message }, 500)
  }
})

// Create new activity
app.post('/api/vendor/activities', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  const body = await c.req.json()

  try {
    const {
      category_id, title_en, title_ar, short_description_en, short_description_ar,
      full_description_en, full_description_ar, images, video_url, duration_minutes,
      capacity_per_slot, price, currency, price_type, requirements,
      includes, excludes, cancellation_policy_hours, status
    } = body

    const activity = await DB.prepare(`
      INSERT INTO activities (
        vendor_id, category_id, title_en, title_ar, short_description_en, short_description_ar,
        full_description_en, full_description_ar, images, video_url, duration_minutes, capacity_per_slot,
        price, currency, price_type, requirements, includes, excludes, cancellation_policy_hours, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      RETURNING activity_id
    `).bind(
      vendor_id, category_id, title_en, title_ar || title_en,
      short_description_en, short_description_ar || short_description_en,
      full_description_en, full_description_ar || full_description_en,
      JSON.stringify(images), video_url || null, duration_minutes, capacity_per_slot,
      price, currency || 'USD', price_type || 'per_person',
      JSON.stringify(requirements), JSON.stringify(includes), JSON.stringify(excludes),
      cancellation_policy_hours || 24, status || 'draft'
    ).first()

    return c.json({ success: true, activity_id: activity.activity_id })
  } catch (error) {
    console.error('Create activity error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Update activity
app.put('/api/vendor/activities/:activity_id', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  const { activity_id } = c.req.param()
  const body = await c.req.json()

  if (!vendor_id) {
    return c.json({ error: 'Vendor ID not provided' }, 401)
  }

  try {
    // Verify activity belongs to vendor
    const existing = await DB.prepare(`
      SELECT activity_id FROM activities WHERE activity_id = ? AND vendor_id = ?
    `).bind(activity_id, vendor_id).first()

    if (!existing) {
      return c.json({ error: 'Activity not found or access denied' }, 404)
    }

    const {
      category_id, title_en, title_ar, short_description_en, short_description_ar,
      full_description_en, full_description_ar, images, video_url, duration_minutes,
      capacity_per_slot, price, currency, price_type, requirements, includes, excludes, status
    } = body

    await DB.prepare(`
      UPDATE activities
      SET category_id = ?,
          title_en = ?,
          title_ar = ?,
          short_description_en = ?,
          short_description_ar = ?,
          full_description_en = ?,
          full_description_ar = ?,
          images = ?,
          video_url = ?,
          duration_minutes = ?,
          capacity_per_slot = ?,
          price = ?,
          currency = ?,
          price_type = ?,
          requirements = ?,
          includes = ?,
          excludes = ?,
          status = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE activity_id = ? AND vendor_id = ?
    `).bind(
      category_id,
      title_en,
      title_ar || title_en,
      short_description_en,
      short_description_ar || short_description_en,
      full_description_en,
      full_description_ar || full_description_en,
      JSON.stringify(images || []),
      video_url || null,
      duration_minutes,
      capacity_per_slot,
      price,
      currency || 'USD',
      price_type || 'per_person',
      JSON.stringify(requirements || []),
      JSON.stringify(includes || []),
      JSON.stringify(excludes || []),
      status || 'active',
      activity_id,
      vendor_id
    ).run()

    return c.json({ success: true, message: 'Activity updated successfully' })
  } catch (error) {
    console.error('Update activity error:', error)
    return c.json({ error: 'Internal server error: ' + error.message }, 500)
  }
})

// Delete activity
app.delete('/api/vendor/activities/:activity_id', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  const { activity_id } = c.req.param()

  if (!vendor_id) {
    return c.json({ error: 'Vendor ID not provided' }, 401)
  }

  try {
    // Verify activity belongs to vendor
    const existing = await DB.prepare(`
      SELECT activity_id FROM activities WHERE activity_id = ? AND vendor_id = ?
    `).bind(activity_id, vendor_id).first()

    if (!existing) {
      return c.json({ error: 'Activity not found or access denied' }, 404)
    }

    // Check for existing bookings
    const bookings = await DB.prepare(`
      SELECT COUNT(*) as count FROM bookings 
      WHERE activity_id = ? AND booking_status != 'cancelled'
    `).bind(activity_id).first()

    if (bookings && bookings.count > 0) {
      return c.json({ 
        error: `Cannot delete activity with ${bookings.count} active booking(s). Please cancel bookings first.`,
        has_bookings: true
      }, 400)
    }

    // Delete the activity
    await DB.prepare(`
      DELETE FROM activities WHERE activity_id = ? AND vendor_id = ?
    `).bind(activity_id, vendor_id).run()

    return c.json({ success: true, message: 'Activity deleted successfully' })
  } catch (error) {
    console.error('Delete activity error:', error)
    return c.json({ error: 'Internal server error: ' + error.message }, 500)
  }
})

// Auto-translate activity to all languages (Vendor/Admin)
app.post('/api/vendor/activities/:activity_id/translate', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  const { activity_id } = c.req.param()
  const { openai_api_key } = await c.req.json()
  
  if (!openai_api_key) {
    return c.json({ error: 'OpenAI API key required' }, 400)
  }
  
  if (!vendor_id) {
    return c.json({ error: 'Vendor ID not provided' }, 401)
  }
  
  try {
    // Verify activity belongs to vendor
    const activity: any = await DB.prepare(`
      SELECT title_en, short_description_en, full_description_en
      FROM activities WHERE activity_id = ? AND vendor_id = ?
    `).bind(activity_id, vendor_id).first()
    
    if (!activity) {
      return c.json({ error: 'Activity not found or access denied' }, 404)
    }
    
    // Translate to all languages
    const languages = ['ar', 'de', 'ru', 'pl', 'it', 'fr', 'cs', 'uk', 'zh', 'es', 'ja', 'pt', 'ko', 'hi', 'tr', 'el', 'sv', 'no', 'da', 'ro', 'hu', 'fi', 'hr', 'sk', 'bg', 'sr', 'sl', 'th', 'id', 'vi', 'tl', 'ms']
    const translations: any = {}
    
    for (const lang of languages) {
      const textsToTranslate = [
        activity.title_en,
        activity.short_description_en || '',
        activity.full_description_en || ''
      ]
      
      const translated = await translateWithAI(textsToTranslate, lang, openai_api_key)
      
      translations[`title_${lang}`] = translated[0] || activity.title_en
      translations[`short_description_${lang}`] = translated[1] || activity.short_description_en
      translations[`full_description_${lang}`] = translated[2] || activity.full_description_en
    }
    
    // Update database with translations
    await DB.prepare(`
      UPDATE activities SET
        title_ar = ?, short_description_ar = ?, full_description_ar = ?,
        title_de = ?, short_description_de = ?, full_description_de = ?,
        title_ru = ?, short_description_ru = ?, full_description_ru = ?,
        title_pl = ?, short_description_pl = ?, full_description_pl = ?,
        title_it = ?, short_description_it = ?, full_description_it = ?,
        title_fr = ?, short_description_fr = ?, full_description_fr = ?,
        title_cs = ?, short_description_cs = ?, full_description_cs = ?,
        title_uk = ?, short_description_uk = ?, full_description_uk = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE activity_id = ? AND vendor_id = ?
    `).bind(
      translations.title_ar, translations.short_description_ar, translations.full_description_ar,
      translations.title_de, translations.short_description_de, translations.full_description_de,
      translations.title_ru, translations.short_description_ru, translations.full_description_ru,
      translations.title_pl, translations.short_description_pl, translations.full_description_pl,
      translations.title_it, translations.short_description_it, translations.full_description_it,
      translations.title_fr, translations.short_description_fr, translations.full_description_fr,
      translations.title_cs, translations.short_description_cs, translations.full_description_cs,
      translations.title_uk, translations.short_description_uk, translations.full_description_uk,
      activity_id,
      vendor_id
    ).run()
    
    return c.json({ 
      success: true,
      translations: translations,
      message: 'Activity translated to 8 languages successfully'
    })
  } catch (error) {
    console.error('Activity translation error:', error)
    return c.json({ error: 'Translation failed: ' + error }, 500)
  }
})

// Upload activity image (simulated - returns data URL for now)
app.post('/api/vendor/upload-image', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  
  try {
    // In production, this would upload to Cloudflare R2
    // For now, we'll return a placeholder URL
    const formData = await c.req.formData()
    const image = formData.get('image')
    
    if (!image) {
      return c.json({ error: 'No image provided' }, 400)
    }
    
    // Generate placeholder image URL
    const timestamp = Date.now()
    const imageUrl = `/static/uploads/${vendor_id}_${timestamp}.jpg`
    
    return c.json({
      success: true,
      image_url: imageUrl,
      message: 'Image uploaded successfully'
    })
  } catch (error) {
    console.error('Image upload error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get vendor profile
app.get('/api/vendor/profile', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  
  console.log('GET /api/vendor/profile - vendor_id:', vendor_id)
  
  if (!vendor_id) {
    return c.json({ error: 'Vendor ID not provided' }, 401)
  }
  
  try {
    const profile = await DB.prepare(`
      SELECT 
        vendor_id, business_name, slug, email, phone, website,
        profile_image, description, address, city, country,
        operating_hours, social_media, specialties, years_experience,
        languages_spoken, safety_rating, status
      FROM vendors
      WHERE vendor_id = ?
    `).bind(vendor_id).first()
    
    console.log('Profile query result:', profile)
    
    if (!profile) {
      return c.json({ error: 'Vendor not found' }, 404)
    }
    
    return c.json({ profile })
  } catch (error) {
    console.error('Get vendor profile error:', error)
    return c.json({ error: 'Internal server error: ' + error.message }, 500)
  }
})

// Get vendor connected properties
app.get('/api/vendor/properties', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  
  if (!vendor_id) {
    return c.json({ error: 'Vendor ID not provided' }, 401)
  }
  
  try {
    const properties = await DB.prepare(`
      SELECT 
        vp.vendor_property_id,
        vp.vendor_id,
        vp.property_id,
        vp.status,
        vp.is_featured,
        vp.custom_commission_rate,
        vp.joined_via,
        p.name as property_name,
        p.slug as property_slug,
        p.contact_email as property_email,
        p.contact_phone as property_phone,
        p.address as property_address
      FROM vendor_properties vp
      JOIN properties p ON vp.property_id = p.property_id
      WHERE vp.vendor_id = ?
      ORDER BY vp.is_featured DESC, p.name ASC
    `).bind(vendor_id).all()
    
    return c.json({ properties: properties.results || [] })
  } catch (error) {
    console.error('Get vendor properties error:', error)
    return c.json({ error: 'Internal server error: ' + error.message }, 500)
  }
})

// Update vendor profile
app.put('/api/vendor/profile', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  const body = await c.req.json()
  
  try {
    const {
      business_name, phone, website, description, address, city, country,
      operating_hours, social_media, specialties, years_experience, languages_spoken
    } = body
    
    await DB.prepare(`
      UPDATE vendors
      SET business_name = ?,
          phone = ?,
          website = ?,
          description = ?,
          address = ?,
          city = ?,
          country = ?,
          operating_hours = ?,
          social_media = ?,
          specialties = ?,
          years_experience = ?,
          languages_spoken = ?,
          updated_at = datetime('now')
      WHERE vendor_id = ?
    `).bind(
      business_name, phone, website || null, description || null,
      address || null, city || null, country || null,
      operating_hours ? JSON.stringify(operating_hours) : null,
      social_media ? JSON.stringify(social_media) : null,
      specialties ? JSON.stringify(specialties) : null,
      years_experience || null,
      languages_spoken ? JSON.stringify(languages_spoken) : null,
      vendor_id
    ).run()
    
    return c.json({ success: true, message: 'Profile updated successfully' })
  } catch (error) {
    console.error('Update vendor profile error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Upload vendor profile image
app.post('/api/vendor/upload-profile-image', async (c) => {
  const { DB } = c.env
  const vendor_id = c.req.header('X-Vendor-ID')
  
  try {
    const formData = await c.req.formData()
    const image = formData.get('image')
    
    if (!image) {
      return c.json({ error: 'No image provided' }, 400)
    }
    
    // Generate placeholder image URL (production: upload to R2)
    const timestamp = Date.now()
    const imageUrl = `/static/vendors/${vendor_id}_profile_${timestamp}.jpg`
    
    // Update vendor profile image
    await DB.prepare(`
      UPDATE vendors SET profile_image = ?, updated_at = datetime('now')
      WHERE vendor_id = ?
    `).bind(imageUrl, vendor_id).run()
    
    return c.json({
      success: true,
      image_url: imageUrl,
      message: 'Profile image uploaded successfully'
    })
  } catch (error) {
    console.error('Profile image upload error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Vendor registration with hotel code
app.post('/api/vendor/register', async (c) => {
  const { DB } = c.env
  const { registration_code, business_name, email, phone, password } = await c.req.json()
  
  try {
    // Validate registration code
    const property = await DB.prepare(`
      SELECT property_id, registration_code_expires_at 
      FROM properties 
      WHERE registration_code = ? AND status = 'active'
    `).bind(registration_code).first()
    
    if (!property) {
      return c.json({ error: 'Invalid registration code' }, 400)
    }
    
    // Check if code is expired
    const expiresAt = new Date(property.registration_code_expires_at)
    if (expiresAt < new Date()) {
      return c.json({ error: 'Registration code has expired' }, 400)
    }
    
    // Check if email already exists
    const existing = await DB.prepare(`
      SELECT vendor_id FROM vendors WHERE email = ?
    `).bind(email).first()
    
    if (existing) {
      return c.json({ error: 'Email already registered' }, 400)
    }
    
    // Create vendor
    const slug = business_name.toLowerCase().replace(/[^a-z0-9]+/g, '-')
    const vendor = await DB.prepare(`
      INSERT INTO vendors (business_name, slug, email, phone, password_hash, status)
      VALUES (?, ?, ?, ?, ?, 'active')
      RETURNING vendor_id
    `).bind(business_name, slug, email, phone, password).first()
    
    // Link vendor to property
    await DB.prepare(`
      INSERT INTO vendor_properties (vendor_id, property_id, registration_code_used, joined_via, commission_rate)
      VALUES (?, ?, ?, 'registration_code', 15)
    `).bind(vendor.vendor_id, property.property_id, registration_code).run()
    
    return c.json({
      success: true,
      vendor_id: vendor.vendor_id,
      message: 'Vendor registered successfully'
    })
  } catch (error) {
    console.error('Vendor registration error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// ============================================
// GUEST CALLBACK REQUESTS
// ============================================

// Submit callback request
app.post('/api/callback-request', async (c) => {
  const { DB } = c.env
  const { property_id, activity_id, vendor_id, first_name, last_name, phone, email, preferred_time, message } = await c.req.json()
  
  try {
    const request = await DB.prepare(`
      INSERT INTO callback_requests (
        property_id, activity_id, vendor_id, first_name, last_name, phone, email, preferred_time, message, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending')
      RETURNING request_id
    `).bind(
      property_id, 
      activity_id || null, 
      vendor_id || null, 
      first_name, 
      last_name, 
      phone, 
      email || null, 
      preferred_time || 'anytime', 
      message || null
    ).first()
    
    return c.json({
      success: true,
      request_id: request.request_id,
      message: 'Callback request submitted. We will contact you soon!'
    })
  } catch (error) {
    console.error('Callback request error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// ============================================
// SUPER ADMIN API ENDPOINTS
// ============================================

// Get platform stats
app.get('/api/superadmin/stats', async (c) => {
  const { DB } = c.env
  
  try {
    const hotels = await DB.prepare('SELECT COUNT(*) as count FROM properties').first()
    const vendors = await DB.prepare('SELECT COUNT(*) as count FROM vendors').first()
    const bookings = await DB.prepare('SELECT COUNT(*) as count, SUM(total_amount) as revenue FROM bookings').first()
    
    return c.json({
      total_hotels: hotels.count,
      total_vendors: vendors.count,
      total_bookings: bookings.count,
      total_revenue: bookings.revenue || 0
    })
  } catch (error) {
    console.error('Stats error:', error)
    return c.json({ error: 'Failed to load stats' }, 500)
  }
})

// Get all hotels
app.get('/api/superadmin/hotels', async (c) => {
  const { DB } = c.env
  
  try {
    const hotels = await DB.prepare(`
      SELECT property_id, name as property_name, slug, contact_email, contact_phone, 
             address as location, status, created_at
      FROM properties
      ORDER BY created_at DESC
    `).all()
    
    return c.json(hotels.results)
  } catch (error) {
    console.error('Get hotels error:', error)
    return c.json({ error: 'Failed to load hotels' }, 500)
  }
})

// Add new hotel
app.post('/api/superadmin/hotels', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    // Create hotel property
    const property = await DB.prepare(`
      INSERT INTO properties (name, slug, contact_email, contact_phone, address, status)
      VALUES (?, ?, ?, ?, ?, 'active')
    `).bind(
      data.name,
      data.slug,
      data.contact_email,
      data.contact_phone || null,
      data.address || null
    ).run()
    
    // Create admin user for the hotel
    const adminResult = await DB.prepare(`
      INSERT INTO guests (email, name, phone, language_preference)
      VALUES (?, ?, ?, 'en')
    `).bind(data.contact_email, data.name + ' Admin', data.contact_phone || '').run()
    
    // Generate registration code for the hotel
    const code = Math.random().toString(36).substring(2, 10).toUpperCase()
    const expiry = new Date()
    expiry.setDate(expiry.getDate() + 30)
    
    await DB.prepare(`
      UPDATE properties 
      SET registration_code = ?, registration_code_expires_at = ?
      WHERE property_id = ?
    `).bind(code, expiry.toISOString(), property.meta.last_row_id).run()
    
    return c.json({
      success: true,
      property_id: property.meta.last_row_id,
      registration_code: code,
      message: 'Hotel created successfully'
    })
  } catch (error) {
    console.error('Create hotel error:', error)
    return c.json({ error: 'Failed to create hotel' }, 500)
  }
})

// Get all vendors
app.get('/api/superadmin/vendors', async (c) => {
  const { DB } = c.env
  
  try {
    const vendors = await DB.prepare(`
      SELECT 
        v.*,
        COUNT(DISTINCT vp.property_id) as property_count
      FROM vendors v
      LEFT JOIN vendor_properties vp ON v.vendor_id = vp.vendor_id
      GROUP BY v.vendor_id
      ORDER BY v.created_at DESC
    `).all()
    
    return c.json(vendors.results)
  } catch (error) {
    console.error('Get vendors error:', error)
    return c.json({ error: 'Failed to load vendors' }, 500)
  }
})

// Get all bookings
app.get('/api/superadmin/bookings', async (c) => {
  const { DB } = c.env
  
  try {
    const bookings = await DB.prepare(`
      SELECT 
        b.*,
        a.title_en as activity_title,
        p.name as property_name
      FROM activity_bookings b
      JOIN activities a ON b.activity_id = a.activity_id
      JOIN properties p ON b.property_id = p.property_id
      ORDER BY b.created_at DESC
      LIMIT 100
    `).all()
    
    return c.json(bookings.results)
  } catch (error) {
    console.error('Get bookings error:', error)
    return c.json({ error: 'Failed to load bookings' }, 500)
  }
})

// ============================================
// SUPER ADMIN - USER MANAGEMENT API
// ============================================

// Get all platform users
app.get('/api/superadmin/users', async (c) => {
  const { DB } = c.env
  const user_type = c.req.query('type') // 'hotel', 'vendor', or 'all'
  const status = c.req.query('status') // 'active', 'suspended', etc.
  
  try {
    let query = `
      SELECT 
        pu.*,
        p.name as property_name,
        v.business_name as vendor_business_name
      FROM platform_users pu
      LEFT JOIN properties p ON pu.property_id = p.property_id
      LEFT JOIN vendors v ON pu.vendor_id = v.vendor_id
      WHERE 1=1
    `
    const bindings = []
    
    if (user_type && user_type !== 'all') {
      query += ` AND pu.user_type = ?`
      bindings.push(user_type)
    }
    if (status && status !== 'all') {
      query += ` AND pu.status = ?`
      bindings.push(status)
    }
    
    query += ` ORDER BY pu.created_at DESC LIMIT 1000`
    
    const users = await DB.prepare(query).bind(...bindings).all()
    return c.json({ success: true, users: users.results })
  } catch (error) {
    console.error('Get users error:', error)
    return c.json({ error: 'Failed to load users' }, 500)
  }
})

// Suspend/Activate user
app.patch('/api/superadmin/users/:user_id/status', async (c) => {
  const { DB } = c.env
  const { user_id } = c.req.param()
  const { status, reason } = await c.req.json()
  
  try {
    await DB.prepare(`
      UPDATE platform_users 
      SET status = ?, 
          suspended_at = CASE WHEN ? = 'suspended' THEN CURRENT_TIMESTAMP ELSE NULL END,
          suspended_reason = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE user_id = ?
    `).bind(status, status, reason || null, user_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update user status error:', error)
    return c.json({ error: 'Failed to update user status' }, 500)
  }
})

// Delete user
app.delete('/api/superadmin/users/:user_id', async (c) => {
  const { DB } = c.env
  const { user_id } = c.req.param()
  
  try {
    await DB.prepare(`DELETE FROM platform_users WHERE user_id = ?`).bind(user_id).run()
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete user error:', error)
    return c.json({ error: 'Failed to delete user' }, 500)
  }
})

// ============================================
// SUPER ADMIN - SUPPORT TICKETS API
// ============================================

// Get all tickets
app.get('/api/superadmin/tickets', async (c) => {
  const { DB } = c.env
  const status = c.req.query('status') || 'all'
  const priority = c.req.query('priority') || 'all'
  
  try {
    let query = `SELECT * FROM support_tickets WHERE 1=1`
    const bindings = []
    
    if (status !== 'all') {
      query += ` AND status = ?`
      bindings.push(status)
    }
    if (priority !== 'all') {
      query += ` AND priority = ?`
      bindings.push(priority)
    }
    
    query += ` ORDER BY 
      CASE priority 
        WHEN 'urgent' THEN 1 
        WHEN 'high' THEN 2 
        WHEN 'medium' THEN 3 
        ELSE 4 
      END,
      created_at DESC
      LIMIT 500`
    
    const tickets = await DB.prepare(query).bind(...bindings).all()
    return c.json({ success: true, tickets: tickets.results })
  } catch (error) {
    console.error('Get tickets error:', error)
    return c.json({ error: 'Failed to load tickets' }, 500)
  }
})

// Create ticket
app.post('/api/tickets', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    const ticket_number = 'TKT-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase()
    
    const result = await DB.prepare(`
      INSERT INTO support_tickets (
        ticket_number, subject, description, priority, category,
        created_by_type, created_by_id, created_by_email, created_by_name,
        property_id, vendor_id
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      ticket_number,
      data.subject,
      data.description,
      data.priority || 'medium',
      data.category || 'general',
      data.created_by_type,
      data.created_by_id,
      data.created_by_email,
      data.created_by_name,
      data.property_id || null,
      data.vendor_id || null
    ).run()
    
    return c.json({ success: true, ticket_id: result.meta.last_row_id, ticket_number })
  } catch (error) {
    console.error('Create ticket error:', error)
    return c.json({ error: 'Failed to create ticket' }, 500)
  }
})

// Update ticket status
app.patch('/api/superadmin/tickets/:ticket_id', async (c) => {
  const { DB } = c.env
  const { ticket_id } = c.req.param()
  const data = await c.req.json()
  
  try {
    await DB.prepare(`
      UPDATE support_tickets 
      SET status = ?,
          assigned_to_id = ?,
          assigned_to_name = ?,
          resolved_at = CASE WHEN ? = 'resolved' THEN CURRENT_TIMESTAMP ELSE resolved_at END,
          closed_at = CASE WHEN ? = 'closed' THEN CURRENT_TIMESTAMP ELSE closed_at END,
          updated_at = CURRENT_TIMESTAMP
      WHERE ticket_id = ?
    `).bind(
      data.status || 'open',
      data.assigned_to_id || null,
      data.assigned_to_name || null,
      data.status,
      data.status,
      ticket_id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update ticket error:', error)
    return c.json({ error: 'Failed to update ticket' }, 500)
  }
})

// Get ticket messages
app.get('/api/tickets/:ticket_id/messages', async (c) => {
  const { DB } = c.env
  const { ticket_id } = c.req.param()
  
  try {
    const messages = await DB.prepare(`
      SELECT * FROM ticket_messages 
      WHERE ticket_id = ? 
      ORDER BY created_at ASC
    `).bind(ticket_id).all()
    
    return c.json({ success: true, messages: messages.results })
  } catch (error) {
    console.error('Get ticket messages error:', error)
    return c.json({ error: 'Failed to load messages' }, 500)
  }
})

// Add ticket message/reply
app.post('/api/tickets/:ticket_id/messages', async (c) => {
  const { DB } = c.env
  const { ticket_id } = c.req.param()
  const data = await c.req.json()
  
  try {
    await DB.prepare(`
      INSERT INTO ticket_messages (
        ticket_id, message, is_internal_note,
        author_type, author_id, author_name, author_email
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(
      ticket_id,
      data.message,
      data.is_internal_note ? 1 : 0,
      data.author_type,
      data.author_id,
      data.author_name,
      data.author_email || null
    ).run()
    
    // Update ticket updated_at
    await DB.prepare(`
      UPDATE support_tickets SET updated_at = CURRENT_TIMESTAMP WHERE ticket_id = ?
    `).bind(ticket_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Add ticket message error:', error)
    return c.json({ error: 'Failed to add message' }, 500)
  }
})

// ============================================
// SUPER ADMIN - LIVE CHAT API
// ============================================

// Get chat rooms
app.get('/api/superadmin/chat/rooms', async (c) => {
  const { DB } = c.env
  const status = c.req.query('status') || 'active'
  
  try {
    const rooms = await DB.prepare(`
      SELECT * FROM chat_rooms 
      WHERE status = ? 
      ORDER BY last_message_at DESC NULLS LAST, created_at DESC
      LIMIT 100
    `).bind(status).all()
    
    return c.json({ success: true, rooms: rooms.results })
  } catch (error) {
    console.error('Get chat rooms error:', error)
    return c.json({ error: 'Failed to load chat rooms' }, 500)
  }
})

// Get user's chat rooms
app.get('/api/chat/rooms', async (c) => {
  const { DB } = c.env
  const user_type = c.req.query('user_type')
  const user_id = c.req.query('user_id')
  
  try {
    const rooms = await DB.prepare(`
      SELECT * FROM chat_rooms 
      WHERE (
        (participant1_type = ? AND participant1_id = ?) OR
        (participant2_type = ? AND participant2_id = ?)
      )
      AND status = 'active'
      ORDER BY last_message_at DESC NULLS LAST, created_at DESC
    `).bind(user_type, user_id, user_type, user_id).all()
    
    return c.json({ success: true, rooms: rooms.results })
  } catch (error) {
    console.error('Get user chat rooms error:', error)
    return c.json({ error: 'Failed to load chat rooms' }, 500)
  }
})

// Create chat room
app.post('/api/chat/rooms', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    // Check if room already exists
    const existing = await DB.prepare(`
      SELECT room_id FROM chat_rooms 
      WHERE (
        (participant1_type = ? AND participant1_id = ? AND participant2_type = ? AND participant2_id = ?) OR
        (participant1_type = ? AND participant1_id = ? AND participant2_type = ? AND participant2_id = ?)
      )
      AND status = 'active'
    `).bind(
      data.participant1_type, data.participant1_id, data.participant2_type, data.participant2_id,
      data.participant2_type, data.participant2_id, data.participant1_type, data.participant1_id
    ).first()
    
    if (existing) {
      return c.json({ success: true, room_id: existing.room_id, existing: true })
    }
    
    const result = await DB.prepare(`
      INSERT INTO chat_rooms (
        room_type, room_name,
        participant1_type, participant1_id, participant1_name,
        participant2_type, participant2_id, participant2_name,
        property_id, vendor_id
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.room_type,
      data.room_name,
      data.participant1_type,
      data.participant1_id,
      data.participant1_name,
      data.participant2_type || 'superadmin',
      data.participant2_id || 1,
      data.participant2_name || 'Support Team',
      data.property_id || null,
      data.vendor_id || null
    ).run()
    
    return c.json({ success: true, room_id: result.meta.last_row_id })
  } catch (error) {
    console.error('Create chat room error:', error)
    return c.json({ error: 'Failed to create chat room' }, 500)
  }
})

// Get chat messages
app.get('/api/chat/rooms/:room_id/messages', async (c) => {
  const { DB } = c.env
  const { room_id } = c.req.param()
  const limit = parseInt(c.req.query('limit') || '50')
  
  try {
    const messages = await DB.prepare(`
      SELECT * FROM chat_messages 
      WHERE room_id = ? 
      ORDER BY created_at DESC 
      LIMIT ?
    `).bind(room_id, limit).all()
    
    return c.json({ success: true, messages: messages.results.reverse() })
  } catch (error) {
    console.error('Get chat messages error:', error)
    return c.json({ error: 'Failed to load messages' }, 500)
  }
})

// Send chat message
app.post('/api/chat/rooms/:room_id/messages', async (c) => {
  const { DB } = c.env
  const { room_id } = c.req.param()
  const data = await c.req.json()
  
  try {
    await DB.prepare(`
      INSERT INTO chat_messages (
        room_id, message, message_type,
        sender_type, sender_id, sender_name
      ) VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      room_id,
      data.message,
      data.message_type || 'text',
      data.sender_type,
      data.sender_id,
      data.sender_name
    ).run()
    
    // Update room last_message_at
    await DB.prepare(`
      UPDATE chat_rooms 
      SET last_message_at = CURRENT_TIMESTAMP,
          updated_at = CURRENT_TIMESTAMP
      WHERE room_id = ?
    `).bind(room_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Send chat message error:', error)
    return c.json({ error: 'Failed to send message' }, 500)
  }
})

// ============================================
// HOTEL ADMIN API ENDPOINTS
// ============================================

// Get callback requests (Admin)
app.get('/api/admin/callback-requests', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  const status = c.req.query('status') || 'pending'
  
  try {
    const requests = await DB.prepare(`
      SELECT * FROM callback_requests
      WHERE property_id = ? AND status = ?
      ORDER BY created_at DESC
      LIMIT 50
    `).bind(property_id, status).all()
    
    return c.json({ requests: requests.results })
  } catch (error) {
    console.error('Get callback requests error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// ============================================
// ADMIN API ROUTES
// ============================================

// Admin login
app.post('/api/admin/login', async (c) => {
  const { DB } = c.env
  const { email, password } = await c.req.json()

  try {
    const user = await DB.prepare(`
      SELECT * FROM users WHERE email = ? AND status = 'active'
    `).bind(email).first()

    if (!user) {
      return c.json({ error: 'Invalid credentials' }, 401)
    }

    // Note: In production, use proper bcrypt password verification
    
    return c.json({
      success: true,
      user: {
        user_id: user.user_id,
        email: user.email,
        first_name: user.first_name,
        last_name: user.last_name,
        role: user.role,
        property_id: user.property_id
      },
      token: `admin-${user.user_id}-${Date.now()}`
    })
  } catch (error) {
    console.error('Admin login error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Admin dashboard stats
app.get('/api/admin/dashboard', async (c) => {
  const { DB } = c.env
  const property_id = c.req.header('X-Property-ID')

  try {
    // Today's bookings
    const todayBookings = await DB.prepare(`
      SELECT COUNT(*) as count FROM bookings
      WHERE property_id = ? AND activity_date = date('now')
    `).bind(property_id).first()

    // This month's revenue
    const monthRevenue = await DB.prepare(`
      SELECT SUM(total_price) as revenue FROM bookings
      WHERE property_id = ? 
        AND strftime('%Y-%m', activity_date) = strftime('%Y-%m', 'now')
        AND payment_status = 'paid'
    `).bind(property_id).first()

    // Active vendors
    const activeVendors = await DB.prepare(`
      SELECT COUNT(*) as count FROM vendor_properties vp
      JOIN vendors v ON vp.vendor_id = v.vendor_id
      WHERE vp.property_id = ? AND v.status = 'active'
    `).bind(property_id).first()

    // Guest engagement (QR scans vs bookings)
    const scans = await DB.prepare(`
      SELECT COUNT(*) as count FROM analytics_events
      WHERE property_id = ? AND event_type = 'qr_scan'
        AND date(timestamp) >= date('now', '-30 days')
    `).bind(property_id).first()

    const bookings = await DB.prepare(`
      SELECT COUNT(*) as count FROM bookings
      WHERE property_id = ? AND created_at >= datetime('now', '-30 days')
    `).bind(property_id).first()

    const engagement = scans.count > 0 ? Math.round((bookings.count / scans.count) * 100) : 0

    return c.json({
      kpis: {
        today_bookings: todayBookings.count,
        month_revenue: monthRevenue.revenue || 0,
        active_vendors: activeVendors.count,
        engagement_rate: engagement
      }
    })
  } catch (error) {
    console.error('Admin dashboard error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Track QR code scan
app.post('/api/track-scan', async (c) => {
  const { DB } = c.env
  
  try {
    const { property_id } = await c.req.json()
    const user_agent = c.req.header('User-Agent') || ''
    const ip_address = c.req.header('CF-Connecting-IP') || c.req.header('X-Forwarded-For') || ''
    
    await DB.prepare(`
      INSERT INTO qr_scans (property_id, user_agent, ip_address)
      VALUES (?, ?, ?)
    `).bind(property_id || 1, user_agent, ip_address).run()
    
    return c.json({ success: true, message: 'Scan tracked' })
  } catch (error) {
    console.error('Track scan error:', error)
    return c.json({ success: false, error: 'Failed to track scan' }, 500)
  }
})

// Track page view
app.post('/api/track-page-view', async (c) => {
  const { DB } = c.env
  
  try {
    const { property_id, page_type, page_id } = await c.req.json()
    const user_agent = c.req.header('User-Agent') || ''
    
    await DB.prepare(`
      INSERT INTO page_views (property_id, page_type, page_id, user_agent)
      VALUES (?, ?, ?, ?)
    `).bind(property_id || 1, page_type, page_id || null, user_agent).run()
    
    return c.json({ success: true, message: 'Page view tracked' })
  } catch (error) {
    console.error('Track page view error:', error)
    return c.json({ success: false, error: 'Failed to track page view' }, 500)
  }
})

// Get analytics data
app.get('/api/admin/analytics', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id') || '1'
  const dateRange = c.req.query('range') || 'today' // today, yesterday, 7days, 30days, custom
  const startDate = c.req.query('start_date')
  const endDate = c.req.query('end_date')

  try {
    // Calculate date ranges
    let currentStartDate, currentEndDate, previousStartDate, previousEndDate
    
    if (dateRange === 'custom' && startDate && endDate) {
      currentStartDate = startDate
      currentEndDate = endDate
      // Calculate previous period of same length
      const daysDiff = Math.floor((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24))
      previousEndDate = startDate
      previousStartDate = new Date(new Date(startDate) - daysDiff * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
    } else if (dateRange === 'today') {
      currentStartDate = "date('now')"
      currentEndDate = "date('now')"
      previousStartDate = "date('now', '-1 day')"
      previousEndDate = "date('now', '-1 day')"
    } else if (dateRange === 'yesterday') {
      currentStartDate = "date('now', '-1 day')"
      currentEndDate = "date('now', '-1 day')"
      previousStartDate = "date('now', '-2 days')"
      previousEndDate = "date('now', '-2 days')"
    } else if (dateRange === '7days') {
      currentStartDate = "date('now', '-6 days')"
      currentEndDate = "date('now')"
      previousStartDate = "date('now', '-13 days')"
      previousEndDate = "date('now', '-7 days')"
    } else if (dateRange === '30days') {
      currentStartDate = "date('now', '-29 days')"
      currentEndDate = "date('now')"
      previousStartDate = "date('now', '-59 days')"
      previousEndDate = "date('now', '-30 days')"
    }

    // QR Scans for current period
    const currentScans = await DB.prepare(`
      SELECT COUNT(*) as count FROM qr_scans
      WHERE property_id = ? AND scan_date BETWEEN ${currentStartDate} AND ${currentEndDate}
    `).bind(property_id).first()

    // QR Scans for previous period (for comparison)
    const previousScans = await DB.prepare(`
      SELECT COUNT(*) as count FROM qr_scans
      WHERE property_id = ? AND scan_date BETWEEN ${previousStartDate} AND ${previousEndDate}
    `).bind(property_id).first()

    // Calculate percentage change
    const scansChange = previousScans.count > 0 
      ? ((currentScans.count - previousScans.count) / previousScans.count * 100).toFixed(1)
      : currentScans.count > 0 ? 100 : 0

    // Total activities count
    const activities = await DB.prepare(`
      SELECT COUNT(*) as count FROM activities a
      JOIN vendor_properties vp ON a.vendor_id = vp.vendor_id
      WHERE vp.property_id = ? AND a.status = 'active'
    `).bind(property_id).first()

    // Total vendors count
    const vendors = await DB.prepare(`
      SELECT COUNT(*) as count FROM vendor_properties vp
      JOIN vendors v ON vp.vendor_id = v.vendor_id
      WHERE vp.property_id = ? AND v.status = 'active'
    `).bind(property_id).first()

    // Active bookings for current period
    const currentBookings = await DB.prepare(`
      SELECT COUNT(*) as count FROM bookings
      WHERE property_id = ? AND booking_status IN ('confirmed', 'pending')
        AND booking_date BETWEEN ${currentStartDate} AND ${currentEndDate}
    `).bind(property_id).first()

    // Previous period bookings for comparison
    const previousBookings = await DB.prepare(`
      SELECT COUNT(*) as count FROM bookings
      WHERE property_id = ? AND booking_status IN ('confirmed', 'pending')
        AND booking_date BETWEEN ${previousStartDate} AND ${previousEndDate}
    `).bind(property_id).first()

    const bookingsChange = previousBookings.count > 0
      ? ((currentBookings.count - previousBookings.count) / previousBookings.count * 100).toFixed(1)
      : currentBookings.count > 0 ? 100 : 0

    // Most popular activities (by bookings in current period)
    const popularActivities = await DB.prepare(`
      SELECT 
        a.title_en,
        a.activity_id,
        COUNT(b.booking_id) as booking_count,
        SUM(b.total_price) as total_revenue
      FROM activities a
      JOIN vendor_properties vp ON a.vendor_id = vp.vendor_id
      LEFT JOIN bookings b ON a.activity_id = b.activity_id 
        AND b.booking_date BETWEEN ${currentStartDate} AND ${currentEndDate}
      WHERE vp.property_id = ?
      GROUP BY a.activity_id
      HAVING booking_count > 0
      ORDER BY booking_count DESC
      LIMIT 5
    `).bind(property_id).all()

    // Most viewed sections (from page_views table)
    const popularSections = await DB.prepare(`
      SELECT 
        page_type as name,
        COUNT(*) as views
      FROM page_views
      WHERE property_id = ? AND view_date BETWEEN ${currentStartDate} AND ${currentEndDate}
      GROUP BY page_type
      ORDER BY views DESC
      LIMIT 5
    `).bind(property_id).all()

    // Add icons for sections
    const sectionIcons = {
      'activities': 'hiking',
      'restaurants': 'utensils',
      'spa': 'spa',
      'events': 'calendar',
      'rooms': 'bed',
      'custom': 'layer-group'
    }

    const sectionsWithIcons = (popularSections.results || []).map(s => ({
      ...s,
      icon: sectionIcons[s.name] || 'eye'
    }))

    return c.json({
      stats: {
        totalScans: currentScans.count,
        scansChange: scansChange,
        scansPrevious: previousScans.count,
        totalActivities: activities.count,
        totalVendors: vendors.count,
        activeBookings: currentBookings.count,
        bookingsChange: bookingsChange,
        bookingsPrevious: previousBookings.count
      },
      popularActivities: popularActivities.results || [],
      popularSections: sectionsWithIcons,
      dateRange: {
        current: { start: currentStartDate, end: currentEndDate },
        previous: { start: previousStartDate, end: previousEndDate }
      }
    })
  } catch (error) {
    console.error('Analytics error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get all rooms
app.get('/api/admin/rooms', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id') || c.req.header('X-Property-ID')

  try {
    const rooms = await DB.prepare(`
      SELECT * FROM rooms WHERE property_id = ?
      ORDER BY room_number
    `).bind(property_id).all()

    return c.json(rooms.results)
  } catch (error) {
    console.error('Get rooms error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Create new room
app.post('/api/admin/rooms', async (c) => {
  const { DB } = c.env
  const property_id = c.req.header('X-Property-ID')
  const { room_number, room_type } = await c.req.json()

  try {
    const qr_code_data = `qr-${room_number}-${crypto.randomUUID()}`

    const room = await DB.prepare(`
      INSERT INTO rooms (property_id, room_number, room_type, qr_code_data, status)
      VALUES (?, ?, ?, ?, 'vacant')
      RETURNING room_id, qr_code_data
    `).bind(property_id, room_number, room_type || 'standard', qr_code_data).first()

    return c.json({
      success: true,
      room_id: room.room_id,
      qr_code_data: room.qr_code_data,
      qr_code_url: `/api/qr/${room.qr_code_data}`
    })
  } catch (error) {
    console.error('Create room error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Regenerate room QR code
app.post('/api/admin/rooms/:room_id/regenerate-qr', async (c) => {
  const { DB } = c.env
  const { room_id } = c.req.param()

  try {
    const room = await DB.prepare(`
      SELECT room_number FROM rooms WHERE room_id = ?
    `).bind(room_id).first()

    if (!room) {
      return c.json({ error: 'Room not found' }, 404)
    }

    const new_qr_code_data = `qr-${room.room_number}-${crypto.randomUUID()}`

    await DB.prepare(`
      UPDATE rooms
      SET qr_code_data = ?, updated_at = datetime('now')
      WHERE room_id = ?
    `).bind(new_qr_code_data, room_id).run()

    return c.json({
      success: true,
      qr_code_data: new_qr_code_data,
      qr_code_url: `/api/qr/${new_qr_code_data}`
    })
  } catch (error) {
    console.error('Regenerate QR error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// QR Card Designer - Get QR card template
app.get('/api/admin/qr-card/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()

  try {
    const card = await DB.prepare(`
      SELECT * FROM qr_card_designs WHERE property_id = ?
    `).bind(property_id).first()

    if (!card) {
      // Return default template if none exists
      return c.json({
        property_id,
        card_title: 'Scan for Hotel Services',
        card_subtitle: 'Access all amenities and services',
        background_color: '#ffffff',
        text_color: '#000000',
        qr_size: 300,
        border_radius: 10,
        show_logo: true,
        festive_overlay: null,
        custom_message: null
      })
    }

    return c.json(card)
  } catch (error) {
    console.error('Get QR card error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// QR Card Designer - Save/Update QR card template
app.put('/api/admin/qr-card/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const {
    card_title,
    card_subtitle,
    background_color,
    text_color,
    qr_size,
    border_radius,
    show_logo,
    festive_overlay,
    custom_message
  } = await c.req.json()

  try {
    // Check if template exists
    const existing = await DB.prepare(`
      SELECT design_id FROM qr_card_designs WHERE property_id = ?
    `).bind(property_id).first()

    if (existing) {
      // Update existing template
      await DB.prepare(`
        UPDATE qr_card_designs 
        SET card_title = ?,
            card_subtitle = ?,
            bottom_message = ?,
            card_bg_color = ?,
            text_color = ?,
            qr_size = ?,
            show_logo = ?,
            festive_overlay = ?,
            updated_at = datetime('now')
        WHERE property_id = ?
      `).bind(
        card_title,
        card_subtitle,
        custom_message || 'Scan for more information',
        background_color || '#FFFFFF',
        text_color || '#1F2937',
        qr_size || 'large',
        show_logo ? 1 : 0,
        festive_overlay || 'none',
        property_id
      ).run()
    } else {
      // Insert new template
      await DB.prepare(`
        INSERT INTO qr_card_designs (
          property_id, card_title, card_subtitle, bottom_message,
          card_bg_color, text_color, qr_size, show_logo,
          festive_overlay
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(
        property_id,
        card_title,
        card_subtitle,
        custom_message || 'Scan for more information',
        background_color || '#FFFFFF',
        text_color || '#1F2937',
        qr_size || 'large',
        show_logo ? 1 : 0,
        festive_overlay || 'none'
      ).run()
    }

    return c.json({ success: true })
  } catch (error) {
    console.error('Save QR card error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Notification Settings API - Get settings
app.get('/api/admin/notification-settings/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const settings = await DB.prepare(`
      SELECT * FROM notification_settings WHERE property_id = ?
    `).bind(property_id).first()
    
    if (!settings) {
      // Return default settings if none exist
      return c.json({
        property_id: parseInt(property_id),
        sound_enabled: 1,
        persistent_beep: 0,
        beep_interval_ms: 3000,
        beep_frequency: 800,
        beep_duration_ms: 500,
        persistent_new_bookings: 1,
        persistent_new_callbacks: 1,
        persistent_new_feedback: 0,
        persistent_new_chat: 0,
        show_popup: 1,
        popup_auto_close_seconds: 0,
        refresh_interval_ms: 300000
      })
    }
    
    return c.json(settings)
  } catch (error) {
    console.error('Get notification settings error:', error)
    return c.json({ error: 'Failed to get settings' }, 500)
  }
})

// Notification Settings API - Update settings
app.put('/api/admin/notification-settings/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const data = await c.req.json()
  
  try {
    // Check if settings exist
    const existing = await DB.prepare(`
      SELECT setting_id FROM notification_settings WHERE property_id = ?
    `).bind(property_id).first()
    
    if (existing) {
      // Update existing settings
      await DB.prepare(`
        UPDATE notification_settings
        SET sound_enabled = ?,
            persistent_beep = ?,
            beep_interval_ms = ?,
            beep_frequency = ?,
            beep_duration_ms = ?,
            persistent_new_bookings = ?,
            persistent_new_callbacks = ?,
            persistent_new_feedback = ?,
            persistent_new_chat = ?,
            show_popup = ?,
            popup_auto_close_seconds = ?,
            refresh_interval_ms = ?,
            updated_at = datetime('now')
        WHERE property_id = ?
      `).bind(
        data.sound_enabled ? 1 : 0,
        data.persistent_beep ? 1 : 0,
        data.beep_interval_ms || 3000,
        data.beep_frequency || 800,
        data.beep_duration_ms || 500,
        data.persistent_new_bookings ? 1 : 0,
        data.persistent_new_callbacks ? 1 : 0,
        data.persistent_new_feedback ? 1 : 0,
        data.persistent_new_chat ? 1 : 0,
        data.show_popup ? 1 : 0,
        data.popup_auto_close_seconds || 0,
        data.refresh_interval_ms || 300000,
        property_id
      ).run()
    } else {
      // Insert new settings
      await DB.prepare(`
        INSERT INTO notification_settings (
          property_id, sound_enabled, persistent_beep, beep_interval_ms,
          beep_frequency, beep_duration_ms, persistent_new_bookings,
          persistent_new_callbacks, persistent_new_feedback, persistent_new_chat,
          show_popup, popup_auto_close_seconds, refresh_interval_ms
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(
        property_id,
        data.sound_enabled ? 1 : 0,
        data.persistent_beep ? 1 : 0,
        data.beep_interval_ms || 3000,
        data.beep_frequency || 800,
        data.beep_duration_ms || 500,
        data.persistent_new_bookings ? 1 : 0,
        data.persistent_new_callbacks ? 1 : 0,
        data.persistent_new_feedback ? 1 : 0,
        data.persistent_new_chat ? 1 : 0,
        data.show_popup ? 1 : 0,
        data.popup_auto_close_seconds || 0,
        data.refresh_interval_ms || 300000
      ).run()
    }
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Save notification settings error:', error)
    return c.json({ error: 'Failed to save settings' }, 500)
  }
})

// Get all vendors
app.get('/api/admin/vendors', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')

  try {
    let query = `
      SELECT 
        v.*,
        c.name_en as category_name
      FROM vendors v
      LEFT JOIN categories c ON v.category_id = c.category_id
    `
    
    // If property_id provided, filter by vendor-property relationship
    if (property_id) {
      query += `
        INNER JOIN vendor_properties vp ON v.vendor_id = vp.vendor_id
        WHERE vp.property_id = ?
      `
    }
    
    query += ` ORDER BY v.created_at DESC`
    
    const vendors = property_id 
      ? await DB.prepare(query).bind(property_id).all()
      : await DB.prepare(query).all()

    return c.json(vendors.results)
  } catch (error) {
    console.error('Get vendors error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Update vendor status
app.patch('/api/admin/vendors/:vendor_id', async (c) => {
  const { DB } = c.env
  const { vendor_id } = c.req.param()
  const { status, commission_rate } = await c.req.json()

  try {
    await DB.prepare(`
      UPDATE vendors
      SET status = ?, commission_rate = COALESCE(?, commission_rate), updated_at = datetime('now')
      WHERE vendor_id = ?
    `).bind(status, commission_rate, vendor_id).run()

    return c.json({ success: true, message: 'Vendor updated successfully' })
  } catch (error) {
    console.error('Update vendor error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get property registration code
app.get('/api/admin/registration-code', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  
  try {
    const property = await DB.prepare(`
      SELECT registration_code, registration_code_expires_at
      FROM properties
      WHERE property_id = ?
    `).bind(property_id).first()
    
    return c.json({
      registration_code: property.registration_code,
      expires_at: property.registration_code_expires_at
    })
  } catch (error) {
    console.error('Get registration code error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Regenerate property registration code
app.post('/api/admin/regenerate-registration-code', async (c) => {
  const { DB } = c.env
  const { property_id } = await c.req.json()
  
  try {
    // Generate new 8-character code
    const newCode = Math.random().toString(36).substring(2, 10).toUpperCase()
    const expiresAt = new Date()
    expiresAt.setDate(expiresAt.getDate() + 30) // Expires in 30 days
    
    await DB.prepare(`
      UPDATE properties
      SET registration_code = ?,
          registration_code_expires_at = ?
      WHERE property_id = ?
    `).bind(newCode, expiresAt.toISOString(), property_id).run()
    
    return c.json({
      success: true,
      registration_code: newCode,
      expires_at: expiresAt.toISOString()
    })
  } catch (error) {
    console.error('Regenerate registration code error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Get property design settings
app.get('/api/admin/property-settings', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  
  try {
    const property = await DB.prepare(`
      SELECT 
        slug, name, tagline, contact_email, contact_phone, address,
        brand_logo_url, hero_image_url, hero_image_effect, hero_overlay_opacity,
        primary_color, secondary_color, accent_color,
        layout_style, font_family, button_style, card_style, header_style, use_gradient,
        hotel_map_url, homepage_section_order, 
        show_restaurants, show_events, show_spa, show_service, show_activities, show_hotel_map,
        section_restaurants_en, section_restaurants_ar, section_restaurants_de, section_restaurants_ru, section_restaurants_pl, section_restaurants_it, section_restaurants_fr, section_restaurants_cs, section_restaurants_uk,
        section_events_en, section_events_ar, section_events_de, section_events_ru, section_events_pl, section_events_it, section_events_fr, section_events_cs, section_events_uk,
        section_spa_en, section_spa_ar, section_spa_de, section_spa_ru, section_spa_pl, section_spa_it, section_spa_fr, section_spa_cs, section_spa_uk,
        section_service_en, section_service_ar, section_service_de, section_service_ru, section_service_pl, section_service_it, section_service_fr, section_service_cs, section_service_uk,
        section_activities_en, section_activities_ar, section_activities_de, section_activities_ru, section_activities_pl, section_activities_it, section_activities_fr, section_activities_cs, section_activities_uk
      FROM properties
      WHERE property_id = ?
    `).bind(property_id).first()
    
    // Provide defaults for visibility settings
    const settingsWithDefaults = {
      ...property,
      show_restaurants: property.show_restaurants ?? 1,
      show_events: property.show_events ?? 1,
      show_spa: property.show_spa ?? 1,
      show_service: property.show_service ?? 1,
      show_activities: property.show_activities ?? 1,
      show_hotel_map: property.show_hotel_map ?? 0,
      homepage_section_order: property.homepage_section_order || JSON.stringify(['restaurants', 'events', 'spa', 'service', 'activities'])
    }
    
    return c.json(settingsWithDefaults)
  } catch (error) {
    console.error('Get property settings error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Update property design settings
app.put('/api/admin/property-settings', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    await DB.prepare(`
      UPDATE properties
      SET name = ?,
          tagline = ?,
          contact_email = ?,
          contact_phone = ?,
          address = ?,
          section_restaurants_en = ?,
          section_events_en = ?,
          section_spa_en = ?,
          section_service_en = ?,
          section_activities_en = ?,
          brand_logo_url = ?,
          hero_image_url = ?,
          hero_image_effect = ?,
          hero_overlay_opacity = ?,
          primary_color = ?,
          secondary_color = ?,
          accent_color = ?,
          layout_style = ?,
          font_family = ?,
          button_style = ?,
          card_style = ?,
          header_style = ?,
          use_gradient = ?,
          hotel_map_url = ?,
          homepage_section_order = ?,
          show_restaurants = ?,
          show_events = ?,
          show_spa = ?,
          show_service = ?,
          show_activities = ?,
          show_hotel_map = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE property_id = ?
    `).bind(
      data.name,
      data.tagline,
      data.contact_email,
      data.contact_phone,
      data.address,
      data.section_restaurants_en,
      data.section_events_en,
      data.section_spa_en,
      data.section_service_en,
      data.section_activities_en,
      data.brand_logo_url,
      data.hero_image_url,
      data.hero_image_effect,
      data.hero_overlay_opacity,
      data.primary_color,
      data.secondary_color,
      data.accent_color,
      data.layout_style,
      data.font_family,
      data.button_style,
      data.card_style,
      data.header_style,
      data.use_gradient,
      data.hotel_map_url,
      data.homepage_section_order,
      data.show_restaurants,
      data.show_events,
      data.show_spa,
      data.show_service,
      data.show_activities,
      data.show_hotel_map,
      data.property_id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update property settings error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// ============================================
// CUSTOM SECTIONS APIs
// ============================================

// Get all custom sections for a property
app.get('/api/admin/custom-sections', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  
  try {
    const sections = await DB.prepare(`
      SELECT * FROM custom_sections
      WHERE property_id = ?
      ORDER BY display_order ASC, section_id ASC
    `).bind(property_id).all()
    
    return c.json({ success: true, sections: sections.results })
  } catch (error) {
    console.error('Get custom sections error:', error)
    return c.json({ error: 'Failed to get custom sections' }, 500)
  }
})

// Create new custom section
app.post('/api/admin/custom-sections', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    const result = await DB.prepare(`
      INSERT INTO custom_sections (
        property_id, section_key, section_name_en, icon_class, color_class, display_order, is_visible
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.property_id,
      data.section_key,
      data.section_name_en,
      data.icon_class || 'fas fa-star',
      data.color_class || 'blue',
      data.display_order || 0,
      data.is_visible !== undefined ? data.is_visible : 1
    ).run()
    
    return c.json({ success: true, section_id: result.meta.last_row_id })
  } catch (error) {
    console.error('Create custom section error:', error)
    return c.json({ error: 'Failed to create custom section' }, 500)
  }
})

// Update custom section
app.put('/api/admin/custom-sections/:section_id', async (c) => {
  const { DB } = c.env
  const { section_id } = c.req.param()
  const data = await c.req.json()
  
  try {
    // Support partial updates - only update if_visible if that's all that's provided
    if (Object.keys(data).length === 1 && data.hasOwnProperty('is_visible')) {
      await DB.prepare(`
        UPDATE custom_sections
        SET is_visible = ?,
            updated_at = CURRENT_TIMESTAMP
        WHERE section_id = ?
      `).bind(data.is_visible, section_id).run()
    } else {
      // Full update
      await DB.prepare(`
        UPDATE custom_sections
        SET section_name_en = ?,
            section_name_ar = ?,
            section_name_de = ?,
            section_name_ru = ?,
            section_name_pl = ?,
            section_name_it = ?,
            section_name_fr = ?,
            section_name_cs = ?,
            section_name_uk = ?,
            icon_class = ?,
            color_class = ?,
            display_order = ?,
            is_visible = ?,
            updated_at = CURRENT_TIMESTAMP
        WHERE section_id = ?
      `).bind(
        data.section_name_en,
        data.section_name_ar || null,
        data.section_name_de || null,
        data.section_name_ru || null,
        data.section_name_pl || null,
        data.section_name_it || null,
        data.section_name_fr || null,
        data.section_name_cs || null,
        data.section_name_uk || null,
        data.icon_class,
        data.color_class,
        data.display_order,
        data.is_visible,
        section_id
      ).run()
    }
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update custom section error:', error)
    return c.json({ error: 'Failed to update custom section' }, 500)
  }
})

// Delete custom section
app.delete('/api/admin/custom-sections/:section_id', async (c) => {
  const { DB } = c.env
  const { section_id } = c.req.param()
  
  try {
    await DB.prepare(`
      DELETE FROM custom_sections WHERE section_id = ?
    `).bind(section_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete custom section error:', error)
    return c.json({ error: 'Failed to delete custom section' }, 500)
  }
})

// Get custom sections for hotel homepage (public)
app.get('/api/custom-sections/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const sections = await DB.prepare(`
      SELECT * FROM custom_sections
      WHERE property_id = ? AND is_visible = 1
      ORDER BY display_order ASC, section_id ASC
    `).bind(property_id).all()
    
    return c.json({ success: true, sections: sections.results })
  } catch (error) {
    console.error('Get custom sections error:', error)
    return c.json({ error: 'Failed to get custom sections' }, 500)
  }
})

// ============================================
// INFO PAGES API ENDPOINTS
// ============================================

// Get all info pages for a property (admin)
app.get('/api/admin/info-pages', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  
  try {
    const pages = await DB.prepare(`
      SELECT * FROM info_pages
      WHERE property_id = ?
      ORDER BY display_order ASC, page_id DESC
    `).bind(property_id).all()
    
    return c.json(pages.results)
  } catch (error) {
    console.error('Get info pages error:', error)
    return c.json({ error: 'Failed to get info pages' }, 500)
  }
})

// Get single info page by ID (admin)
app.get('/api/admin/info-pages/:page_id', async (c) => {
  const { DB } = c.env
  const { page_id } = c.req.param()
  
  try {
    const page = await DB.prepare(`
      SELECT * FROM info_pages WHERE page_id = ?
    `).bind(page_id).first()
    
    if (!page) {
      return c.json({ error: 'Info page not found' }, 404)
    }
    
    return c.json(page)
  } catch (error) {
    console.error('Get info page error:', error)
    return c.json({ error: 'Failed to get info page' }, 500)
  }
})

// Create new info page
app.post('/api/admin/info-pages', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    const result = await DB.prepare(`
      INSERT INTO info_pages (
        property_id, page_key, title_en, content_en, 
        icon_class, color_theme, layout_type, is_published, 
        display_order, show_in_menu
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.property_id,
      data.page_key || 'page-' + Date.now(),
      data.title_en,
      data.content_en,
      data.icon_class || 'fas fa-info-circle',
      data.color_theme || 'blue',
      data.layout_type || 'single-column',
      data.is_published !== undefined ? data.is_published : 1,
      data.display_order || 0,
      data.show_in_menu !== undefined ? data.show_in_menu : 1
    ).run()
    
    return c.json({ success: true, page_id: result.meta.last_row_id })
  } catch (error) {
    console.error('Create info page error:', error)
    return c.json({ error: 'Failed to create info page' }, 500)
  }
})

// Update info page
app.put('/api/admin/info-pages/:page_id', async (c) => {
  const { DB } = c.env
  const { page_id } = c.req.param()
  const data = await c.req.json()
  
  try {
    // Build update query dynamically based on provided fields
    const updates = []
    const values = []
    
    if (data.title_en !== undefined) { updates.push('title_en = ?'); values.push(data.title_en); }
    if (data.content_en !== undefined) { updates.push('content_en = ?'); values.push(data.content_en); }
    if (data.icon_class !== undefined) { updates.push('icon_class = ?'); values.push(data.icon_class); }
    if (data.color_theme !== undefined) { updates.push('color_theme = ?'); values.push(data.color_theme); }
    if (data.layout_type !== undefined) { updates.push('layout_type = ?'); values.push(data.layout_type); }
    if (data.is_published !== undefined) { updates.push('is_published = ?'); values.push(data.is_published); }
    if (data.display_order !== undefined) { updates.push('display_order = ?'); values.push(data.display_order); }
    if (data.show_in_menu !== undefined) { updates.push('show_in_menu = ?'); values.push(data.show_in_menu); }
    
    // Add multilingual fields
    const languages = ['ar', 'de', 'ru', 'pl', 'it', 'fr', 'cs', 'uk', 'zh', 'es', 'ja', 'pt', 'ko', 'hi', 'tr', 'el', 'sv', 'no', 'da', 'ro', 'hu', 'fi', 'hr', 'sk', 'bg', 'sr', 'sl', 'th', 'id', 'vi', 'tl', 'ms'];
    languages.forEach(lang => {
      if (data[`title_${lang}`] !== undefined) {
        updates.push(`title_${lang} = ?`);
        values.push(data[`title_${lang}`]);
      }
      if (data[`content_${lang}`] !== undefined) {
        updates.push(`content_${lang} = ?`);
        values.push(data[`content_${lang}`]);
      }
    });
    
    updates.push('updated_at = datetime(\'now\')');
    values.push(page_id);
    
    await DB.prepare(`
      UPDATE info_pages SET ${updates.join(', ')} WHERE page_id = ?
    `).bind(...values).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update info page error:', error)
    return c.json({ error: 'Failed to update info page' }, 500)
  }
})

// Delete info page
app.delete('/api/admin/info-pages/:page_id', async (c) => {
  const { DB } = c.env
  const { page_id } = c.req.param()
  
  try {
    await DB.prepare(`
      DELETE FROM info_pages WHERE page_id = ?
    `).bind(page_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete info page error:', error)
    return c.json({ error: 'Failed to delete info page' }, 500)
  }
})

// Get published info pages for guests (public)
app.get('/api/info-pages/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const pages = await DB.prepare(`
      SELECT page_id, page_key, title_en, title_ar, title_de, title_ru, 
             title_pl, title_it, title_fr, title_cs, title_uk, title_zh,
             icon_class, color_theme, display_order
      FROM info_pages
      WHERE property_id = ? AND is_published = 1 AND show_in_menu = 1
      ORDER BY display_order ASC, page_id ASC
    `).bind(property_id).all()
    
    return c.json({ success: true, pages: pages.results })
  } catch (error) {
    console.error('Get info pages error:', error)
    return c.json({ error: 'Failed to get info pages' }, 500)
  }
})

// Get single info page content for display (public)
app.get('/api/info-page/:property_id/:page_key', async (c) => {
  const { DB } = c.env
  const { property_id, page_key } = c.req.param()
  
  try {
    const page = await DB.prepare(`
      SELECT * FROM info_pages
      WHERE property_id = ? AND page_key = ? AND is_published = 1
    `).bind(property_id, page_key).first()
    
    if (!page) {
      return c.json({ error: 'Info page not found' }, 404)
    }
    
    return c.json({ success: true, page })
  } catch (error) {
    console.error('Get info page error:', error)
    return c.json({ error: 'Failed to get info page' }, 500)
  }
})

// Get all bookings (admin view)
app.get('/api/admin/bookings', async (c) => {
  const { DB } = c.env
  const property_id = c.req.header('X-Property-ID')

  try {
    const bookings = await DB.prepare(`
      SELECT 
        b.*,
        a.title_en as activity_title,
        v.business_name as vendor_name,
        g.first_name,
        g.last_name,
        g.email,
        g.phone
      FROM bookings b
      JOIN activities a ON b.activity_id = a.activity_id
      JOIN vendors v ON b.vendor_id = v.vendor_id
      JOIN guests g ON b.guest_id = g.guest_id
      WHERE b.property_id = ?
      ORDER BY b.created_at DESC
      LIMIT 100
    `).bind(property_id).all()

    return c.json({ bookings: bookings.results })
  } catch (error) {
    console.error('Admin bookings error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// Create hotel offering (Admin) - with auto-translation
app.post('/api/admin/offerings', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    // Insert the offering first
    const result = await DB.prepare(`
      INSERT INTO hotel_offerings (
        property_id, offering_type, title_en, short_description_en, full_description_en,
        images, video_url, price, currency, duration_minutes, requires_booking, location,
        event_date, event_start_time, event_end_time, status, display_order
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'USD', ?, ?, ?, ?, ?, ?, 'active', 0)
    `).bind(
      data.property_id,
      data.offering_type,
      data.title_en,
      data.short_description_en,
      data.full_description_en,
      data.images,
      data.video_url || null,
      data.price || 0,
      data.duration_minutes,
      data.requires_booking ? 1 : 0,
      data.location,
      data.event_date,
      data.event_start_time,
      data.event_end_time
    ).run()
    
    const offering_id = result.meta.last_row_id
    
    // Auto-translate to all languages in background
    const apiKey = c.env.OPENAI_API_KEY
    if (apiKey) {
      // Translate in background (don't wait for it)
      c.executionCtx.waitUntil((async () => {
        try {
          // Only translate to languages that exist in DB schema
          const languages = ['ar', 'de', 'ru', 'pl', 'it', 'fr', 'cs', 'uk', 'zh', 'es', 'ja', 'pt', 'ko', 'hi', 'tr', 'el', 'sv', 'no', 'da', 'ro', 'hu', 'fi', 'hr', 'sk', 'bg', 'sr', 'sl', 'th', 'id', 'vi', 'tl', 'ms']
          const translations: any = {}
          
          for (const lang of languages) {
            const textsToTranslate = [
              data.title_en,
              data.short_description_en || '',
              data.full_description_en || ''
            ]
            
            const translated = await translateWithAI(textsToTranslate, lang, apiKey)
            
            translations['title_' + lang] = translated[0] || data.title_en
            translations['short_description_' + lang] = translated[1] || data.short_description_en
            translations['full_description_' + lang] = translated[2] || data.full_description_en
          }
          
          // Update database with translations (ar, de, ru, pl, it, fr, cs, uk)
          await DB.prepare(`
            UPDATE hotel_offerings SET
              title_ar = ?, short_description_ar = ?, full_description_ar = ?,
              title_de = ?, short_description_de = ?, full_description_de = ?,
              title_ru = ?, short_description_ru = ?, full_description_ru = ?,
              title_pl = ?, short_description_pl = ?, full_description_pl = ?,
              title_it = ?, short_description_it = ?, full_description_it = ?,
              title_fr = ?, short_description_fr = ?, full_description_fr = ?,
              title_cs = ?, short_description_cs = ?, full_description_cs = ?,
              title_uk = ?, short_description_uk = ?, full_description_uk = ?,
              updated_at = CURRENT_TIMESTAMP
            WHERE offering_id = ?
          `).bind(
            translations.title_ar, translations.short_description_ar, translations.full_description_ar,
            translations.title_de, translations.short_description_de, translations.full_description_de,
            translations.title_ru, translations.short_description_ru, translations.full_description_ru,
            translations.title_pl, translations.short_description_pl, translations.full_description_pl,
            translations.title_it, translations.short_description_it, translations.full_description_it,
            translations.title_fr, translations.short_description_fr, translations.full_description_fr,
            translations.title_cs, translations.short_description_cs, translations.full_description_cs,
            translations.title_uk, translations.short_description_uk, translations.full_description_uk,
            offering_id
          ).run()
          
          console.log('Auto-translated offering ' + offering_id + ' to 8 languages')
        } catch (error) {
          console.error('Background translation error:', error)
        }
      })())
    }
    
    // If restaurant and menus provided, save them
    if (data.offering_type === 'restaurant' && data.menu_urls && data.menu_urls.length > 0) {
      for (let i = 0; i < data.menu_urls.length; i++) {
        const menuUrl = data.menu_urls[i].trim()
        if (menuUrl) {
          await DB.prepare(`
            INSERT INTO restaurant_menus (
              offering_id, menu_name, menu_url, menu_type, display_order, is_active
            ) VALUES (?, ?, ?, 'full', ?, 1)
          `).bind(offering_id, 'Menu ' + (i + 1), menuUrl, i).run()
        }
      }
    }
    
    return c.json({ 
      success: true,
      offering_id: offering_id,
      message: apiKey ? 'Offering created and being translated to 8 languages' : 'Offering created'
    })
  } catch (error) {
    console.error('Create offering error:', error)
    return c.json({ error: 'Failed to create offering' }, 500)
  }
})

// Update hotel offering (Admin)
app.put('/api/admin/offerings/:offering_id', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  const data = await c.req.json()
  
  try {
    await DB.prepare(`
      UPDATE hotel_offerings SET
        title_en = ?, short_description_en = ?, full_description_en = ?,
        price = ?, location = ?, duration_minutes = ?,
        requires_booking = ?, images = ?, video_url = ?,
        event_date = ?, event_start_time = ?, event_end_time = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE offering_id = ?
    `).bind(
      data.title_en,
      data.short_description_en,
      data.full_description_en,
      data.price || 0,
      data.location,
      data.duration_minutes,
      data.requires_booking ? 1 : 0,
      data.images,
      data.video_url || null,
      data.event_date,
      data.event_start_time,
      data.event_end_time,
      offering_id
    ).run()
    
    // Update restaurant menus if provided
    if (data.offering_type === 'restaurant' && data.menu_urls !== undefined) {
      // Delete existing menus
      await DB.prepare(`
        DELETE FROM restaurant_menus WHERE offering_id = ?
      `).bind(offering_id).run()
      
      // Insert new menus
      if (data.menu_urls && data.menu_urls.length > 0) {
        for (let i = 0; i < data.menu_urls.length; i++) {
          const menuUrl = data.menu_urls[i].trim()
          if (menuUrl) {
            await DB.prepare(`
              INSERT INTO restaurant_menus (
                offering_id, menu_name, menu_url, menu_type, display_order, is_active
              ) VALUES (?, ?, ?, 'full', ?, 1)
            `).bind(offering_id, 'Menu ' + (i + 1), menuUrl, i).run()
          }
        }
      }
    }
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update offering error:', error)
    return c.json({ error: 'Failed to update offering' }, 500)
  }
})

// Delete hotel offering (Admin)
app.delete('/api/admin/offerings/:offering_id', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  
  console.log('DELETE request for offering_id:', offering_id)
  
  if (!offering_id) {
    return c.json({ error: 'Offering ID is required' }, 400)
  }
  
  try {
    // First check if offering exists
    const existing = await DB.prepare(`
      SELECT offering_id, title_en, offering_type FROM hotel_offerings WHERE offering_id = ?
    `).bind(offering_id).first()
    
    console.log('Found offering to delete:', existing)
    
    if (!existing) {
      return c.json({ error: 'Offering not found' }, 404)
    }
    
    // Check for related bookings
    const bookings = await DB.prepare(`
      SELECT COUNT(*) as count FROM offering_bookings WHERE offering_id = ?
    `).bind(offering_id).first()
    
    if (bookings && bookings.count > 0) {
      return c.json({ 
        error: `Cannot delete offering with ${bookings.count} existing booking(s). Please cancel or complete bookings first.`,
        has_bookings: true,
        booking_count: bookings.count
      }, 400)
    }
    
    // Delete related records in correct order (deepest child tables first)
    console.log('Deleting related records for offering_id:', offering_id)
    
    // 1. Delete table_reservations (references dining_sessions and restaurant_tables)
    const reservationsResult = await DB.prepare(`
      DELETE FROM table_reservations 
      WHERE session_id IN (SELECT session_id FROM dining_sessions WHERE offering_id = ?)
         OR table_id IN (SELECT table_id FROM restaurant_tables WHERE offering_id = ?)
    `).bind(offering_id, offering_id).run()
    console.log('Deleted table_reservations:', reservationsResult)
    
    // 2. Delete session_templates
    await DB.prepare(`
      DELETE FROM session_templates WHERE offering_id = ?
    `).bind(offering_id).run()
    
    // 3. Delete restaurant_layouts
    await DB.prepare(`
      DELETE FROM restaurant_layouts WHERE offering_id = ?
    `).bind(offering_id).run()
    
    // 4. Delete dining_sessions
    await DB.prepare(`
      DELETE FROM dining_sessions WHERE offering_id = ?
    `).bind(offering_id).run()
    
    // 5. Delete restaurant_tables
    await DB.prepare(`
      DELETE FROM restaurant_tables WHERE offering_id = ?
    `).bind(offering_id).run()
    
    // 6. Delete offering_schedule
    await DB.prepare(`
      DELETE FROM offering_schedule WHERE offering_id = ?
    `).bind(offering_id).run()
    
    // 7. Delete restaurant_menus
    await DB.prepare(`
      DELETE FROM restaurant_menus WHERE offering_id = ?
    `).bind(offering_id).run()
    
    // 8. Finally delete the offering itself
    const result = await DB.prepare(`
      DELETE FROM hotel_offerings WHERE offering_id = ?
    `).bind(offering_id).run()
    
    console.log('Delete offering result:', result)
    
    return c.json({ 
      success: true, 
      message: `Successfully deleted ${existing.offering_type}: ${existing.title_en}` 
    })
  } catch (error) {
    console.error('Delete offering error:', error)
    return c.json({ error: 'Failed to delete offering: ' + error.message }, 500)
  }
})

// Auto-translate offering to all languages (Admin)
app.post('/api/admin/offerings/:offering_id/translate', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  const { openai_api_key } = await c.req.json()
  
  if (!openai_api_key) {
    return c.json({ error: 'OpenAI API key required' }, 400)
  }
  
  try {
    // Get the offering
    const offering: any = await DB.prepare(`
      SELECT title_en, short_description_en, full_description_en
      FROM hotel_offerings WHERE offering_id = ?
    `).bind(offering_id).first()
    
    if (!offering) {
      return c.json({ error: 'Offering not found' }, 404)
    }
    
    // Translate to all languages
    const languages = ['ar', 'de', 'ru', 'pl', 'it', 'fr', 'cs', 'uk', 'zh', 'es', 'ja', 'pt', 'ko', 'hi', 'tr', 'el', 'sv', 'no', 'da', 'ro', 'hu', 'fi', 'hr', 'sk', 'bg', 'sr', 'sl', 'th', 'id', 'vi', 'tl', 'ms']
    const translations: any = {}
    
    for (const lang of languages) {
      const textsToTranslate = [
        offering.title_en,
        offering.short_description_en || '',
        offering.full_description_en || ''
      ]
      
      const translated = await translateWithAI(textsToTranslate, lang, openai_api_key)
      
      translations[`title_${lang}`] = translated[0] || offering.title_en
      translations[`short_description_${lang}`] = translated[1] || offering.short_description_en
      translations[`full_description_${lang}`] = translated[2] || offering.full_description_en
    }
    
    // Update database with translations
    await DB.prepare(`
      UPDATE hotel_offerings SET
        title_ar = ?, short_description_ar = ?, full_description_ar = ?,
        title_de = ?, short_description_de = ?, full_description_de = ?,
        title_ru = ?, short_description_ru = ?, full_description_ru = ?,
        title_pl = ?, short_description_pl = ?, full_description_pl = ?,
        title_it = ?, short_description_it = ?, full_description_it = ?,
        title_fr = ?, short_description_fr = ?, full_description_fr = ?,
        title_cs = ?, short_description_cs = ?, full_description_cs = ?,
        title_uk = ?, short_description_uk = ?, full_description_uk = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE offering_id = ?
    `).bind(
      translations.title_ar, translations.short_description_ar, translations.full_description_ar,
      translations.title_de, translations.short_description_de, translations.full_description_de,
      translations.title_ru, translations.short_description_ru, translations.full_description_ru,
      translations.title_pl, translations.short_description_pl, translations.full_description_pl,
      translations.title_it, translations.short_description_it, translations.full_description_it,
      translations.title_fr, translations.short_description_fr, translations.full_description_fr,
      translations.title_cs, translations.short_description_cs, translations.full_description_cs,
      translations.title_uk, translations.short_description_uk, translations.full_description_uk,
      offering_id
    ).run()
    
    return c.json({ 
      success: true,
      translations: translations,
      message: 'Translated to 8 languages successfully'
    })
  } catch (error) {
    console.error('Translation error:', error)
    return c.json({ error: 'Translation failed: ' + error }, 500)
  }
})

// Batch translate ALL offerings to all languages (Admin)
app.post('/api/admin/offerings/translate-all', async (c) => {
  const { DB } = c.env
  const { property_id, openai_api_key } = await c.req.json()
  
  if (!openai_api_key) {
    return c.json({ error: 'OpenAI API key required' }, 400)
  }
  
  try {
    // Get all offerings for this property
    const offerings: any = await DB.prepare(`
      SELECT offering_id, title_en, short_description_en, full_description_en
      FROM hotel_offerings 
      WHERE property_id = ?
    `).bind(property_id).all()
    
    if (!offerings.results || offerings.results.length === 0) {
      return c.json({ error: 'No offerings found' }, 404)
    }
    
    const languages = ['ar', 'de', 'ru', 'pl', 'it', 'fr', 'cs', 'uk', 'zh', 'es', 'ja', 'pt', 'ko', 'hi', 'tr', 'el', 'sv', 'no', 'da', 'ro', 'hu', 'fi', 'hr', 'sk', 'bg', 'sr', 'sl', 'th', 'id', 'vi', 'tl', 'ms']
    let translatedCount = 0
    let failedCount = 0
    
    // Translate each offering
    for (const offering of offerings.results) {
      try {
        const translations: any = {}
        
        // Translate to all languages
        for (const lang of languages) {
          const textsToTranslate = [
            offering.title_en,
            offering.short_description_en || '',
            offering.full_description_en || ''
          ]
          
          const translated = await translateWithAI(textsToTranslate, lang, openai_api_key)
          
          translations['title_' + lang] = translated[0] || offering.title_en
          translations['short_description_' + lang] = translated[1] || offering.short_description_en
          translations['full_description_' + lang] = translated[2] || offering.full_description_en
        }
        
        // Update database with translations
        await DB.prepare(`
          UPDATE hotel_offerings SET
            title_ar = ?, short_description_ar = ?, full_description_ar = ?,
            title_de = ?, short_description_de = ?, full_description_de = ?,
            title_ru = ?, short_description_ru = ?, full_description_ru = ?,
            title_pl = ?, short_description_pl = ?, full_description_pl = ?,
            title_it = ?, short_description_it = ?, full_description_it = ?,
            title_fr = ?, short_description_fr = ?, full_description_fr = ?,
            title_cs = ?, short_description_cs = ?, full_description_cs = ?,
            title_uk = ?, short_description_uk = ?, full_description_uk = ?,
            updated_at = CURRENT_TIMESTAMP
          WHERE offering_id = ?
        `).bind(
          translations.title_ar, translations.short_description_ar, translations.full_description_ar,
          translations.title_de, translations.short_description_de, translations.full_description_de,
          translations.title_ru, translations.short_description_ru, translations.full_description_ru,
          translations.title_pl, translations.short_description_pl, translations.full_description_pl,
          translations.title_it, translations.short_description_it, translations.full_description_it,
          translations.title_fr, translations.short_description_fr, translations.full_description_fr,
          translations.title_cs, translations.short_description_cs, translations.full_description_cs,
          translations.title_uk, translations.short_description_uk, translations.full_description_uk,
          offering.offering_id
        ).run()
        
        translatedCount++
        console.log('Translated offering ' + offering.offering_id)
      } catch (error) {
        failedCount++
        console.error('Failed to translate offering ' + offering.offering_id + ':', error)
      }
    }
    
    return c.json({ 
      success: true,
      total: offerings.results.length,
      translated: translatedCount,
      failed: failedCount,
      message: 'Translated ' + translatedCount + ' offerings to 8 languages'
    })
  } catch (error) {
    console.error('Batch translation error:', error)
    return c.json({ error: 'Batch translation failed: ' + error }, 500)
  }
})

// Batch translate ALL activities to all languages (Admin)
app.post('/api/admin/activities/translate-all', async (c) => {
  const { DB } = c.env
  const { property_id, openai_api_key } = await c.req.json()
  
  if (!openai_api_key) {
    return c.json({ error: 'OpenAI API key required' }, 400)
  }
  
  try {
    // Get all activities - need to join with vendors table to filter by property_id
    const activities: any = await DB.prepare(`
      SELECT a.activity_id, a.title_en, a.short_description_en, a.full_description_en
      FROM activities a
      JOIN vendors v ON a.vendor_id = v.vendor_id
      WHERE v.property_id = ?
    `).bind(property_id).all()
    
    if (!activities.results || activities.results.length === 0) {
      return c.json({ error: 'No activities found' }, 404)
    }
    
    const languages = ['ar', 'de', 'ru', 'pl', 'it', 'fr', 'cs', 'uk', 'zh', 'es', 'ja', 'pt', 'ko', 'hi', 'tr', 'el', 'sv', 'no', 'da', 'ro', 'hu', 'fi', 'hr', 'sk', 'bg', 'sr', 'sl', 'th', 'id', 'vi', 'tl', 'ms']
    let translatedCount = 0
    let failedCount = 0
    
    // Translate each activity
    for (const activity of activities.results) {
      try {
        const translations: any = {}
        
        // Translate to all languages
        for (const lang of languages) {
          const textsToTranslate = [
            activity.title_en,
            activity.short_description_en || '',
            activity.full_description_en || ''
          ]
          
          const translated = await translateWithAI(textsToTranslate, lang, openai_api_key)
          
          translations['title_' + lang] = translated[0] || activity.title_en
          translations['short_description_' + lang] = translated[1] || activity.short_description_en
          translations['full_description_' + lang] = translated[2] || activity.full_description_en
        }
        
        // Update database with translations
        await DB.prepare(`
          UPDATE activities SET
            title_ar = ?, short_description_ar = ?, full_description_ar = ?,
            title_de = ?, short_description_de = ?, full_description_de = ?,
            title_ru = ?, short_description_ru = ?, full_description_ru = ?,
            title_pl = ?, short_description_pl = ?, full_description_pl = ?,
            title_it = ?, short_description_it = ?, full_description_it = ?,
            title_fr = ?, short_description_fr = ?, full_description_fr = ?,
            title_cs = ?, short_description_cs = ?, full_description_cs = ?,
            title_uk = ?, short_description_uk = ?, full_description_uk = ?,
            updated_at = CURRENT_TIMESTAMP
          WHERE activity_id = ?
        `).bind(
          translations.title_ar, translations.short_description_ar, translations.full_description_ar,
          translations.title_de, translations.short_description_de, translations.full_description_de,
          translations.title_ru, translations.short_description_ru, translations.full_description_ru,
          translations.title_pl, translations.short_description_pl, translations.full_description_pl,
          translations.title_it, translations.short_description_it, translations.full_description_it,
          translations.title_fr, translations.short_description_fr, translations.full_description_fr,
          translations.title_cs, translations.short_description_cs, translations.full_description_cs,
          translations.title_uk, translations.short_description_uk, translations.full_description_uk,
          activity.activity_id
        ).run()
        
        translatedCount++
        console.log('Translated activity ' + activity.activity_id)
      } catch (error) {
        failedCount++
        console.error('Failed to translate activity ' + activity.activity_id + ':', error)
      }
    }
    
    return c.json({ 
      success: true,
      total: activities.results.length,
      translated: translatedCount,
      failed: failedCount,
      message: 'Translated ' + translatedCount + ' activities to 8 languages'
    })
  } catch (error) {
    console.error('Activities batch translation error:', error)
    return c.json({ error: 'Batch translation failed: ' + error }, 500)
  }
})

// Translate property tagline (Admin)
app.post('/api/admin/property/:property_id/translate-tagline', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const { openai_api_key } = await c.req.json()
  
  if (!openai_api_key) {
    return c.json({ error: 'OpenAI API key required' }, 400)
  }
  
  try {
    const property: any = await DB.prepare(`
      SELECT tagline FROM properties WHERE property_id = ?
    `).bind(property_id).first()
    
    if (!property || !property.tagline) {
      return c.json({ error: 'Property or tagline not found' }, 404)
    }
    
    const languages = ['de', 'ru', 'pl', 'it', 'fr', 'cs', 'uk', 'zh', 'es', 'ja', 'pt', 'ko', 'hi', 'tr', 'el', 'sv', 'no', 'da', 'ro', 'hu', 'fi', 'hr', 'sk', 'bg', 'sr', 'sl', 'th', 'id', 'vi', 'tl', 'ms']
    const translations: any = {}
    
    for (const lang of languages) {
      const translated = await translateWithAI([property.tagline], lang, openai_api_key)
      translations[`tagline_${lang}`] = translated[0] || property.tagline
    }
    
    await DB.prepare(`
      UPDATE properties SET
        tagline_de = ?, tagline_ru = ?, tagline_pl = ?,
        tagline_it = ?, tagline_fr = ?, tagline_cs = ?, tagline_uk = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE property_id = ?
    `).bind(
      translations.tagline_de, translations.tagline_ru, translations.tagline_pl,
      translations.tagline_it, translations.tagline_fr, translations.tagline_cs, translations.tagline_uk,
      property_id
    ).run()
    
    return c.json({ success: true, translations })
  } catch (error) {
    console.error('Tagline translation error:', error)
    return c.json({ error: 'Translation failed' }, 500)
  }
})

// Real-time translation API for guest-facing pages (no auth required)
app.post('/api/translate', async (c) => {
  try {
    const { text, target_lang, context, persona } = await c.req.json()
    
    if (!text || !target_lang) {
      return c.json({ error: 'Missing text or target_lang' }, 400)
    }
    
    // For English, return as-is
    if (target_lang === 'en') {
      return c.json({ translated_text: text })
    }
    
    // Get OpenAI API key from environment variable if configured
    // For now, return original text (hotel admin should use batch translation)
    // This is a fallback - ideally translations should be pre-stored in DB
    const apiKey = c.env.OPENAI_API_KEY
    
    if (!apiKey) {
      // No API key, return original text
      return c.json({ translated_text: text })
    }
    
    const languageNames: Record<string, string> = {
      'es': 'Spanish',
      'fr': 'French',
      'de': 'German',
      'it': 'Italian',
      'pt': 'Portuguese',
      'ru': 'Russian',
      'ar': 'Modern Standard Arabic',
      'zh': 'Simplified Chinese'
    }
    
    const contextPrompts: Record<string, string> = {
      'hotel_offering_description': 'You are translating hotel offering descriptions (restaurants, spa, events, services). Maintain luxury hospitality tone.',
      'luxury_hospitality': 'You are translating luxury hotel content. Use elegant, professional language appropriate for high-end hospitality.'
    }
    
    const systemPrompt = `You are a professional hospitality translator.
${contextPrompts[context] || contextPrompts['luxury_hospitality']}

CRITICAL REQUIREMENTS:
- Translate with 100% accuracy to ${languageNames[target_lang] || target_lang}
- Maintain tourism marketing tone and appeal
- Preserve formatting, punctuation, and special characters  
- Keep proper nouns (hotel names, locations) unchanged
- Use appropriate formality level for luxury hospitality
- Ensure cultural appropriateness for ${languageNames[target_lang] || target_lang} speakers
- Output ONLY the translation, NO explanations or notes`

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: text }
        ],
        temperature: 0.2,
        max_tokens: 1000
      })
    })
    
    if (!response.ok) {
      console.error('Translation API error:', await response.text())
      return c.json({ translated_text: text }) // Fallback
    }
    
    const data: any = await response.json()
    const translatedText = data.choices?.[0]?.message?.content?.trim()
    
    return c.json({ translated_text: translatedText || text })
  } catch (error) {
    console.error('Translation error:', error)
    return c.json({ translated_text: text }, 200) // Fallback to original
  }
})

// Remove vendor from hotel (Admin)
app.delete('/api/admin/vendors/:vendor_id/remove', async (c) => {
  const { DB } = c.env
  const { vendor_id } = c.req.param()
  const property_id = c.req.query('property_id')
  
  try {
    // Remove vendor-property link
    await DB.prepare(`
      DELETE FROM vendor_properties 
      WHERE vendor_id = ? AND property_id = ?
    `).bind(vendor_id, property_id).run()
    
    return c.json({ success: true, message: 'Vendor removed from hotel' })
  } catch (error) {
    console.error('Remove vendor error:', error)
    return c.json({ error: 'Failed to remove vendor' }, 500)
  }
})

// Get all activities (Admin)
app.get('/api/admin/activities', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  
  try {
    const activities = await DB.prepare(`
      SELECT 
        a.*,
        v.business_name,
        c.name_en as category_name
      FROM activities a
      JOIN vendors v ON a.vendor_id = v.vendor_id
      JOIN vendor_properties vp ON v.vendor_id = vp.vendor_id
      JOIN categories c ON a.category_id = c.category_id
      WHERE vp.property_id = ?
      ORDER BY a.created_at DESC
    `).bind(property_id).all()
    
    return c.json(activities.results)
  } catch (error) {
    console.error('Get activities error:', error)
    return c.json({ error: 'Failed to get activities' }, 500)
  }
})

// Delete activity (Admin)
app.delete('/api/admin/activities/:activity_id', async (c) => {
  const { DB } = c.env
  const { activity_id } = c.req.param()
  
  try {
    await DB.prepare(`
      UPDATE activities SET status = 'inactive' WHERE activity_id = ?
    `).bind(activity_id).run()
    
    return c.json({ success: true, message: 'Activity deactivated' })
  } catch (error) {
    console.error('Delete activity error:', error)
    return c.json({ error: 'Failed to delete activity' }, 500)
  }
})

// ============================================
// RESTAURANT TABLE BOOKING APIs
// ============================================

// Get all tables for a restaurant
app.get('/api/restaurant/:offering_id/tables', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  
  try {
    const tables = await DB.prepare(`
      SELECT * FROM restaurant_tables 
      WHERE offering_id = ? AND is_active = 1
      ORDER BY table_number
    `).bind(offering_id).all()
    
    return c.json({ 
      success: true,
      tables: tables.results.map(t => ({
        ...t,
        features: t.features ? JSON.parse(t.features) : []
      }))
    })
  } catch (error) {
    console.error('Get tables error:', error)
    return c.json({ error: 'Failed to get tables' }, 500)
  }
})

// Create table (Admin)
app.post('/api/admin/restaurant/table', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    const result = await DB.prepare(`
      INSERT INTO restaurant_tables (
        offering_id, table_number, table_name, capacity,
        position_x, position_y, width, height, shape, table_type, features
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.offering_id,
      data.table_number,
      data.table_name || null,
      data.capacity,
      data.position_x || 0,
      data.position_y || 0,
      data.width || 100,
      data.height || 80,
      data.shape || 'rectangle',
      data.table_type || 'standard',
      JSON.stringify(data.features || [])
    ).run()
    
    return c.json({ 
      success: true,
      table_id: result.meta.last_row_id
    })
  } catch (error) {
    console.error('Create table error:', error)
    return c.json({ error: 'Failed to create table' }, 500)
  }
})

// Update table (Admin)
app.put('/api/admin/restaurant/table/:table_id', async (c) => {
  const { DB } = c.env
  const { table_id } = c.req.param()
  const data = await c.req.json()
  
  try {
    await DB.prepare(`
      UPDATE restaurant_tables SET
        table_number = ?, table_name = ?, capacity = ?,
        position_x = ?, position_y = ?, width = ?, height = ?,
        shape = ?, table_type = ?, features = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE table_id = ?
    `).bind(
      data.table_number,
      data.table_name || null,
      data.capacity,
      data.position_x,
      data.position_y,
      data.width,
      data.height,
      data.shape,
      data.table_type,
      JSON.stringify(data.features || []),
      table_id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update table error:', error)
    return c.json({ error: 'Failed to update table' }, 500)
  }
})

// Delete table (Admin)
app.delete('/api/admin/restaurant/table/:table_id', async (c) => {
  const { DB } = c.env
  const { table_id } = c.req.param()
  
  try {
    await DB.prepare(`
      UPDATE restaurant_tables SET is_active = 0 WHERE table_id = ?
    `).bind(table_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete table error:', error)
    return c.json({ error: 'Failed to delete table' }, 500)
  }
})

// Floor Plan Elements APIs
app.get('/api/admin/restaurant/:offering_id/floor-elements', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  
  try {
    const elements = await DB.prepare(`
      SELECT * FROM floor_plan_elements 
      WHERE offering_id = ? AND is_active = 1
      ORDER BY element_id ASC
    `).bind(offering_id).all()
    
    return c.json({ success: true, elements: elements.results })
  } catch (error) {
    console.error('Get floor elements error:', error)
    return c.json({ error: 'Failed to load floor elements' }, 500)
  }
})

app.post('/api/admin/restaurant/floor-element', async (c) => {
  const { DB } = c.env
  const body = await c.req.json()
  
  try {
    const result = await DB.prepare(`
      INSERT INTO floor_plan_elements (
        offering_id, property_id, element_type, element_label,
        position_x, position_y, width, height, color, icon
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      body.offering_id,
      body.property_id,
      body.element_type,
      body.element_label,
      body.position_x,
      body.position_y,
      body.width,
      body.height,
      body.color,
      getElementIcon(body.element_type)
    ).run()
    
    return c.json({ success: true, element_id: result.meta.last_row_id })
  } catch (error) {
    console.error('Create floor element error:', error)
    return c.json({ error: 'Failed to create floor element' }, 500)
  }
})

app.put('/api/admin/restaurant/floor-element/:element_id', async (c) => {
  const { DB } = c.env
  const { element_id } = c.req.param()
  const body = await c.req.json()
  
  try {
    await DB.prepare(`
      UPDATE floor_plan_elements 
      SET position_x = ?, position_y = ?, updated_at = CURRENT_TIMESTAMP
      WHERE element_id = ?
    `).bind(body.position_x, body.position_y, element_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update floor element error:', error)
    return c.json({ error: 'Failed to update floor element' }, 500)
  }
})

function getElementIcon(type: string) {
  const icons: Record<string, string> = {
    'buffet': 'fa-utensils',
    'bar': 'fa-glass-cheers',
    'kitchen': 'fa-fire-burner',
    'entrance': 'fa-door-open',
    'exit': 'fa-door-closed',
    'restroom': 'fa-restroom',
    'window': 'fa-window-maximize',
    'wall': 'fa-border-all',
    'plant': 'fa-leaf',
    'stage': 'fa-microphone'
  }
  return icons[type] || 'fa-shapes'
}

// Wall Drawing APIs
app.get('/api/admin/restaurant/:offering_id/walls', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  
  try {
    const walls = await DB.prepare(`
      SELECT * FROM restaurant_walls 
      WHERE offering_id = ? AND is_active = 1
      ORDER BY wall_id ASC
    `).bind(offering_id).all()
    
    return c.json({ success: true, walls: walls.results })
  } catch (error) {
    console.error('Get walls error:', error)
    return c.json({ error: 'Failed to load walls' }, 500)
  }
})

app.post('/api/admin/restaurant/wall', async (c) => {
  const { DB } = c.env
  const body = await c.req.json()
  
  try {
    const result = await DB.prepare(`
      INSERT INTO restaurant_walls (
        offering_id, property_id, start_x, start_y, end_x, end_y,
        thickness, color, style
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      body.offering_id,
      body.property_id,
      body.start_x,
      body.start_y,
      body.end_x,
      body.end_y,
      body.thickness,
      body.color,
      body.style
    ).run()
    
    return c.json({ success: true, wall_id: result.meta.last_row_id })
  } catch (error) {
    console.error('Create wall error:', error)
    return c.json({ error: 'Failed to create wall' }, 500)
  }
})

app.delete('/api/admin/restaurant/wall/:wall_id', async (c) => {
  const { DB } = c.env
  const { wall_id } = c.req.param()
  
  try {
    await DB.prepare(`
      UPDATE restaurant_walls SET is_active = 0 WHERE wall_id = ?
    `).bind(wall_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete wall error:', error)
    return c.json({ error: 'Failed to delete wall' }, 500)
  }
})

// Get dining sessions for a restaurant
app.get('/api/restaurant/:offering_id/sessions', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  const date = c.req.query('date') || new Date().toISOString().split('T')[0]
  
  try {
    const sessions = await DB.prepare(`
      SELECT * FROM dining_sessions 
      WHERE offering_id = ? AND session_date = ? AND status != 'cancelled'
      ORDER BY session_time
    `).bind(offering_id, date).all()
    
    return c.json({ 
      success: true,
      sessions: sessions.results
    })
  } catch (error) {
    console.error('Get sessions error:', error)
    return c.json({ error: 'Failed to get sessions' }, 500)
  }
})

// Create dining session (Admin)
app.post('/api/admin/restaurant/session', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    const result = await DB.prepare(`
      INSERT INTO dining_sessions (
        offering_id, session_date, session_time, session_type,
        duration_minutes, max_capacity, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.offering_id,
      data.session_date,
      data.session_time,
      data.session_type,
      data.duration_minutes || 90,
      data.max_capacity,
      'available'
    ).run()
    
    return c.json({ 
      success: true,
      session_id: result.meta.last_row_id
    })
  } catch (error) {
    console.error('Create session error:', error)
    return c.json({ error: 'Failed to create session' }, 500)
  }
})

// Delete a dining session
app.delete('/api/admin/restaurant/session/:session_id', async (c) => {
  const { DB } = c.env
  const { session_id } = c.req.param()
  
  try {
    await DB.prepare(`
      UPDATE dining_sessions 
      SET status = 'cancelled' 
      WHERE session_id = ?
    `).bind(session_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete session error:', error)
    return c.json({ error: 'Failed to delete session' }, 500)
  }
})

// Get table availability for a session
app.get('/api/restaurant/session/:session_id/availability', async (c) => {
  const { DB } = c.env
  const { session_id } = c.req.param()
  
  try {
    // Get session details
    const session = await DB.prepare(`
      SELECT * FROM dining_sessions WHERE session_id = ?
    `).bind(session_id).first()
    
    if (!session) {
      return c.json({ error: 'Session not found' }, 404)
    }
    
    // Get all tables for this restaurant
    const tables = await DB.prepare(`
      SELECT * FROM restaurant_tables 
      WHERE offering_id = ? AND is_active = 1
    `).bind(session.offering_id).all()
    
    // Get reserved tables for this session
    const reservations = await DB.prepare(`
      SELECT table_id FROM table_reservations 
      WHERE session_id = ? AND status != 'cancelled'
    `).bind(session_id).all()
    
    const reservedTableIds = new Set(reservations.results.map(r => r.table_id))
    
    const availableTables = tables.results.map(t => ({
      ...t,
      features: t.features ? JSON.parse(t.features) : [],
      is_available: !reservedTableIds.has(t.table_id)
    }))
    
    return c.json({ 
      success: true,
      session: session,
      tables: availableTables
    })
  } catch (error) {
    console.error('Get availability error:', error)
    return c.json({ error: 'Failed to get availability' }, 500)
  }
})

// Get AI-extracted textures for restaurant (public endpoint for guest booking page)
app.get('/api/restaurant/:offering_id/textures', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  
  try {
    const texture = await DB.prepare(`
      SELECT * FROM restaurant_textures 
      WHERE offering_id = ? AND is_active = 1
      ORDER BY texture_id DESC 
      LIMIT 1
    `).bind(offering_id).first()
    
    return c.json({ 
      success: true, 
      texture: texture || null 
    })
  } catch (error) {
    console.error('Get public textures error:', error)
    return c.json({ success: false, texture: null })
  }
})

// Create table reservation
app.post('/api/restaurant/reserve', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    // Validate table capacity
    const table = await DB.prepare(`
      SELECT capacity FROM restaurant_tables WHERE table_id = ?
    `).bind(data.table_id).first()
    
    if (!table) {
      return c.json({ error: 'Table not found' }, 404)
    }
    
    if (data.num_guests > table.capacity) {
      return c.json({ error: `Table capacity is ${table.capacity} guests` }, 400)
    }
    
    // Check if table is already booked
    const existing = await DB.prepare(`
      SELECT reservation_id FROM table_reservations 
      WHERE session_id = ? AND table_id = ? AND status != 'cancelled'
    `).bind(data.session_id, data.table_id).first()
    
    if (existing) {
      return c.json({ error: 'Table is already reserved' }, 400)
    }
    
    // Create or get guest
    let guest = await DB.prepare(`
      SELECT guest_id FROM guests WHERE email = ?
    `).bind(data.guest_email).first()
    
    let guestId = guest?.guest_id
    
    if (!guestId) {
      const nameParts = (data.guest_name || '').split(' ')
      const firstName = nameParts[0] || 'Guest'
      const lastName = nameParts.slice(1).join(' ') || ''
      
      const newGuest = await DB.prepare(`
        INSERT INTO guests (property_id, first_name, last_name, email, phone, preferred_language)
        VALUES (?, ?, ?, ?, ?, 'en')
      `).bind(data.property_id || 1, firstName, lastName, data.guest_email, data.guest_phone).run()
      guestId = newGuest.meta.last_row_id
    }
    
    // Get session details for reservation_time and date
    const session = await DB.prepare(`
      SELECT session_time, session_date FROM dining_sessions WHERE session_id = ?
    `).bind(data.session_id).first()
    
    // Use guest_count or num_guests
    const guestCount = data.guest_count || data.num_guests || 1
    
    // Create reservation
    const result = await DB.prepare(`
      INSERT INTO table_reservations (
        session_id, table_id, guest_id, property_id,
        reservation_date, reservation_time, num_guests,
        special_requests, dietary_requirements, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.session_id,
      data.table_id,
      guestId,
      data.property_id || 1,
      data.reservation_date || session.session_date,
      session.session_time,
      guestCount,
      data.special_requests || null,
      data.dietary_requirements || null,
      'confirmed'
    ).run()
    
    // Update session booking count
    await DB.prepare(`
      UPDATE dining_sessions 
      SET current_bookings = current_bookings + ?
      WHERE session_id = ?
    `).bind(guestCount, data.session_id).run()
    
    // Generate reservation reference (using reservation_id)
    const reservationRef = `RES${String(result.meta.last_row_id).padStart(6, '0')}`
    
    return c.json({ 
      success: true,
      reservation_id: result.meta.last_row_id,
      reservation_reference: reservationRef,
      message: 'Table reserved successfully!'
    })
  } catch (error) {
    console.error('Create reservation error:', error)
    return c.json({ error: 'Failed to create reservation' }, 500)
  }
})

// Create offering booking (General bookings for restaurants, events, spa)
app.post('/api/offering-booking', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()
  
  try {
    // Create guest record if doesn't exist
    let guest = await DB.prepare(`
      SELECT guest_id FROM guests WHERE email = ?
    `).bind(data.guest_email).first()
    
    let guestId = guest?.guest_id
    
    if (!guestId) {
      const newGuest = await DB.prepare(`
        INSERT INTO guests (email, name, phone, language_preference)
        VALUES (?, ?, ?, 'en')
      `).bind(data.guest_email, data.guest_name, data.guest_phone).run()
      guestId = newGuest.meta.last_row_id
    }
    
    // Create offering booking record
    const result = await DB.prepare(`
      INSERT INTO offering_bookings (
        offering_id, guest_id, property_id, booking_date,
        num_guests, total_amount, special_requests, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, 'pending')
    `).bind(
      data.offering_id,
      guestId,
      data.property_id,
      data.booking_date,
      data.num_guests,
      data.total_amount,
      data.special_requests || null
    ).run()
    
    return c.json({
      success: true,
      booking_id: result.meta.last_row_id,
      message: 'Booking request submitted! We will contact you shortly.'
    })
  } catch (error) {
    console.error('Create offering booking error:', error)
    return c.json({ error: 'Failed to create booking' }, 500)
  }
})

// Get reservations (Admin)
app.get('/api/admin/restaurant/reservations', async (c) => {
  const { DB } = c.env
  const offering_id = c.req.query('offering_id')
  const date = c.req.query('date') || new Date().toISOString().split('T')[0]
  const status = c.req.query('status')
  const guest = c.req.query('guest')
  
  try {
    let query = `
      SELECT 
        tr.*,
        rt.table_number,
        rt.table_name,
        ds.session_time,
        ds.session_type,
        g.first_name,
        g.last_name,
        g.email,
        g.phone
      FROM table_reservations tr
      JOIN restaurant_tables rt ON tr.table_id = rt.table_id
      JOIN dining_sessions ds ON tr.session_id = ds.session_id
      JOIN guests g ON tr.guest_id = g.guest_id
      WHERE rt.offering_id = ? AND tr.reservation_date = ?
    `
    
    const params = [offering_id, date]
    
    if (status) {
      query += ` AND tr.status = ?`
      params.push(status)
    }
    
    if (guest) {
      query += ` AND (g.first_name LIKE ? OR g.last_name LIKE ? OR g.email LIKE ?)`
      const searchTerm = `%${guest}%`
      params.push(searchTerm, searchTerm, searchTerm)
    }
    
    query += ` ORDER BY ds.session_time, rt.table_number`
    
    const reservations = await DB.prepare(query).bind(...params).all()
    
    // Format the data
    const formattedReservations = (reservations.results || []).map(r => ({
      ...r,
      guest_name: `${r.first_name} ${r.last_name}`,
      guest_email: r.email,
      guest_phone: r.phone,
      reservation_time: r.session_time,
      reservation_reference: `RES${String(r.reservation_id).padStart(6, '0')}`
    }))
    
    return c.json({ 
      success: true,
      reservations: formattedReservations
    })
  } catch (error) {
    console.error('Get reservations error:', error)
    return c.json({ error: 'Failed to get reservations' }, 500)
  }
})

// Confirm reservation
app.post('/api/admin/restaurant/reservation/:reference/confirm', async (c) => {
  const { DB } = c.env
  const { reference } = c.req.param()
  
  try {
    // Extract reservation_id from reference (RES000001 -> 1)
    const reservationId = reference.replace('RES', '').replace(/^0+/, '')
    
    await DB.prepare(`
      UPDATE table_reservations 
      SET status = 'confirmed' 
      WHERE reservation_id = ?
    `).bind(reservationId).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Confirm reservation error:', error)
    return c.json({ error: 'Failed to confirm reservation' }, 500)
  }
})

// Check in reservation
app.post('/api/admin/restaurant/reservation/:reference/checkin', async (c) => {
  const { DB } = c.env
  const { reference } = c.req.param()
  
  try {
    // Extract reservation_id from reference (RES000001 -> 1)
    const reservationId = reference.replace('RES', '').replace(/^0+/, '')
    
    await DB.prepare(`
      UPDATE table_reservations 
      SET status = 'checked_in', checked_in_at = CURRENT_TIMESTAMP 
      WHERE reservation_id = ?
    `).bind(reservationId).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Check in reservation error:', error)
    return c.json({ error: 'Failed to check in reservation' }, 500)
  }
})

// Cancel reservation
app.post('/api/admin/restaurant/reservation/:reference/cancel', async (c) => {
  const { DB } = c.env
  const { reference } = c.req.param()
  
  try {
    // Extract reservation_id from reference (RES000001 -> 1)
    const reservationId = reference.replace('RES', '').replace(/^0+/, '')
    
    await DB.prepare(`
      UPDATE table_reservations 
      SET status = 'cancelled', cancelled_at = CURRENT_TIMESTAMP 
      WHERE reservation_id = ?
    `).bind(reservationId).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Cancel reservation error:', error)
    return c.json({ error: 'Failed to cancel reservation' }, 500)
  }
})

// ============================================
// AI TEXTURE EXTRACTION APIS
// ============================================

// Get current textures for a restaurant
app.get('/api/admin/restaurant/:offering_id/textures', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  
  try {
    const result = await DB.prepare(`
      SELECT * FROM restaurant_textures 
      WHERE offering_id = ? 
      ORDER BY texture_id DESC 
      LIMIT 1
    `).bind(offering_id).first()
    
    return c.json({ 
      success: true, 
      texture: result || null 
    })
  } catch (error) {
    console.error('Get textures error:', error)
    return c.json({ error: 'Failed to load textures' }, 500)
  }
})

// AI-powered texture analysis
app.post('/api/admin/restaurant/:offering_id/analyze-textures', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  const body = await c.req.json()
  const { image, property_id } = body
  
  try {
    // Real AI-powered texture analysis
    // Analyze the restaurant image to extract floor and table materials
    const aiPrompt = `Analyze this restaurant interior photo and extract texture information:

1. FLOOR ANALYSIS:
   - Material type (hardwood, tile, marble, carpet, concrete, stone, vinyl, laminate, terrazzo)
   - Primary color (hex code)
   - Secondary color if pattern exists (hex code)
   - Texture description

2. TABLE ANALYSIS:
   - Material type (wood, glass, metal, marble, granite, laminate, plastic)
   - Primary color (hex code)
   - Secondary color if applicable (hex code)
   - Surface finish (polished, matte, glossy, textured)

3. CONFIDENCE SCORE:
   - Overall confidence in analysis (0.0 to 1.0)

Return JSON format:
{
  "floor_texture_type": "material name",
  "floor_color_primary": "#hexcode",
  "floor_color_secondary": "#hexcode or null",
  "floor_description": "brief description",
  "table_texture_type": "material name",
  "table_color_primary": "#hexcode",
  "table_color_secondary": "#hexcode or null",
  "table_description": "brief description",
  "confidence_score": 0.0-1.0
}

Be specific and accurate with hex colors. Look at the dominant surfaces in the image.`

    // Call AI vision analysis
    const aiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + (c.env.OPENAI_API_KEY || '')
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'user',
            content: [
              { type: 'text', text: aiPrompt },
              { type: 'image_url', image_url: { url: image } }
            ]
          }
        ],
        max_tokens: 1000,
        temperature: 0.3
      })
    })
    
    const aiResult = await aiResponse.json()
    
    // Parse AI response
    let aiAnalysis
    try {
      const aiText = aiResult.choices[0].message.content
      // Extract JSON from response (might be wrapped in markdown)
      const jsonMatch = aiText.match(/\{[\s\S]*\}/)
      aiAnalysis = jsonMatch ? JSON.parse(jsonMatch[0]) : {
        floor_texture_type: 'hardwood',
        floor_color_primary: '#8B7355',
        floor_color_secondary: '#A0826D',
        table_texture_type: 'wood',
        table_color_primary: '#FFFFFF',
        table_color_secondary: '#F5F5F5',
        confidence_score: 0.5
      }
    } catch (parseError) {
      console.error('AI response parse error:', parseError)
      // Fallback to defaults
      aiAnalysis = {
        floor_texture_type: 'hardwood',
        floor_color_primary: '#8B7355',
        floor_color_secondary: '#A0826D',
        table_texture_type: 'wood',
        table_color_primary: '#FFFFFF',
        table_color_secondary: '#F5F5F5',
        confidence_score: 0.5
      }
    }
    
    // Store the original image and AI results
    const result = await DB.prepare(`
      INSERT INTO restaurant_textures (
        offering_id, 
        property_id, 
        original_image_url,
        floor_texture_type,
        floor_color_primary,
        floor_color_secondary,
        table_texture_type,
        table_color_primary,
        table_color_secondary,
        ai_analysis_data,
        confidence_score,
        is_active,
        floor_opacity,
        table_opacity
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, 0.8, 0.9)
    `).bind(
      offering_id,
      property_id,
      image,  // Store base64 image (in production, upload to R2/S3)
      aiAnalysis.floor_texture_type,
      aiAnalysis.floor_color_primary,
      aiAnalysis.floor_color_secondary,
      aiAnalysis.table_texture_type,
      aiAnalysis.table_color_primary,
      aiAnalysis.table_color_secondary,
      JSON.stringify(aiAnalysis),
      aiAnalysis.confidence_score
    ).run()
    
    // Get the inserted texture
    const texture = await DB.prepare(`
      SELECT * FROM restaurant_textures 
      WHERE texture_id = ?
    `).bind(result.meta.last_row_id).first()
    
    return c.json({ 
      success: true, 
      texture: texture
    })
  } catch (error) {
    console.error('AI texture analysis error:', error)
    return c.json({ error: 'Failed to analyze textures: ' + error.message }, 500)
  }
})

// Update texture settings (opacity, enable/disable)
app.put('/api/admin/restaurant/:offering_id/textures', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  const body = await c.req.json()
  const { texture_id, is_active, floor_opacity, table_opacity } = body
  
  try {
    await DB.prepare(`
      UPDATE restaurant_textures 
      SET is_active = ?,
          floor_opacity = ?,
          table_opacity = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE texture_id = ? AND offering_id = ?
    `).bind(is_active, floor_opacity, table_opacity, texture_id, offering_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update textures error:', error)
    return c.json({ error: 'Failed to update textures' }, 500)
  }
})

// ============================================
// HOTEL LANDING PAGE & APIs
// ============================================

// API: Get property details
app.get('/api/properties', async (c) => {
  const { DB } = c.env
  const slug = c.req.query('slug')
  const property_id = c.req.query('property_id')
  
  try {
    let properties;
    
    if (slug) {
      properties = await DB.prepare(`
        SELECT * FROM properties WHERE slug = ? AND status = 'active'
      `).bind(slug).all()
    } else if (property_id) {
      properties = await DB.prepare(`
        SELECT * FROM properties WHERE property_id = ? AND status = 'active'
      `).bind(property_id).all()
    } else {
      properties = await DB.prepare(`
        SELECT * FROM properties WHERE status = 'active' ORDER BY name
      `).all()
    }
    
    return c.json({ 
      success: true,
      properties: properties.results
    })
  } catch (error) {
    console.error('Get properties error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// ============================================
// SEASONAL EFFECTS API
// ============================================

// Get seasonal settings for a property
app.get('/api/seasonal-settings/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const settings = await DB.prepare(`
      SELECT * FROM seasonal_settings WHERE property_id = ?
    `).bind(property_id).first()
    
    if (!settings) {
      // Create default settings if none exist
      await DB.prepare(`
        INSERT INTO seasonal_settings (property_id, active_theme) VALUES (?, 'none')
      `).bind(property_id).run()
      
      const newSettings = await DB.prepare(`
        SELECT * FROM seasonal_settings WHERE property_id = ?
      `).bind(property_id).first()
      
      return c.json({ success: true, settings: newSettings })
    }
    
    return c.json({ success: true, settings })
  } catch (error) {
    console.error('Get seasonal settings error:', error)
    return c.json({ error: 'Failed to get settings' }, 500)
  }
})

// Update seasonal settings (Admin)
app.put('/api/admin/seasonal-settings/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const data = await c.req.json()
  
  try {
    await DB.prepare(`
      UPDATE seasonal_settings SET
        active_theme = ?,
        is_active = ?,
        enable_snow = ?,
        enable_fireworks = ?,
        enable_confetti = ?,
        enable_lights = ?,
        enable_overlay = ?,
        overlay_type = ?,
        overlay_position = ?,
        custom_decorations = ?,
        theme_primary_color = ?,
        theme_secondary_color = ?,
        custom_message = ?,
        auto_activate_start = ?,
        auto_activate_end = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE property_id = ?
    `).bind(
      data.active_theme || 'none',
      data.is_active ? 1 : 0,
      data.enable_snow ? 1 : 0,
      data.enable_fireworks ? 1 : 0,
      data.enable_confetti ? 1 : 0,
      data.enable_lights ? 1 : 0,
      data.enable_overlay ? 1 : 0,
      data.overlay_type || null,
      data.overlay_position || 'top-right',
      data.custom_decorations || null,
      data.theme_primary_color || null,
      data.theme_secondary_color || null,
      data.custom_message || null,
      data.auto_activate_start || null,
      data.auto_activate_end || null,
      property_id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update seasonal settings error:', error)
    return c.json({ error: 'Failed to update settings' }, 500)
  }
})

// API: Get hotel offerings by property
app.get('/api/hotel-offerings/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const lang = c.req.query('lang') || 'en'
  const offering_type = c.req.query('type') // optional filter
  
  try {
    let query = `
      SELECT 
        ho.*,
        CASE 
          WHEN ? = 'ar' THEN COALESCE(ho.title_ar, ho.title_en)
          WHEN ? = 'de' THEN COALESCE(ho.title_de, ho.title_en)
          WHEN ? = 'ru' THEN COALESCE(ho.title_ru, ho.title_en)
          WHEN ? = 'pl' THEN COALESCE(ho.title_pl, ho.title_en)
          WHEN ? = 'it' THEN COALESCE(ho.title_it, ho.title_en)
          WHEN ? = 'fr' THEN COALESCE(ho.title_fr, ho.title_en)
          WHEN ? = 'cs' THEN COALESCE(ho.title_cs, ho.title_en)
          WHEN ? = 'uk' THEN COALESCE(ho.title_uk, ho.title_en)
          ELSE ho.title_en
        END as title,
        CASE 
          WHEN ? = 'ar' THEN COALESCE(ho.short_description_ar, ho.short_description_en)
          WHEN ? = 'de' THEN COALESCE(ho.short_description_de, ho.short_description_en)
          WHEN ? = 'ru' THEN COALESCE(ho.short_description_ru, ho.short_description_en)
          WHEN ? = 'pl' THEN COALESCE(ho.short_description_pl, ho.short_description_en)
          WHEN ? = 'it' THEN COALESCE(ho.short_description_it, ho.short_description_en)
          WHEN ? = 'fr' THEN COALESCE(ho.short_description_fr, ho.short_description_en)
          WHEN ? = 'cs' THEN COALESCE(ho.short_description_cs, ho.short_description_en)
          WHEN ? = 'uk' THEN COALESCE(ho.short_description_uk, ho.short_description_en)
          ELSE ho.short_description_en
        END as short_description,
        CASE 
          WHEN ? = 'ar' THEN COALESCE(ho.full_description_ar, ho.full_description_en)
          WHEN ? = 'de' THEN COALESCE(ho.full_description_de, ho.full_description_en)
          WHEN ? = 'ru' THEN COALESCE(ho.full_description_ru, ho.full_description_en)
          WHEN ? = 'pl' THEN COALESCE(ho.full_description_pl, ho.full_description_en)
          WHEN ? = 'it' THEN COALESCE(ho.full_description_it, ho.full_description_en)
          WHEN ? = 'fr' THEN COALESCE(ho.full_description_fr, ho.full_description_en)
          WHEN ? = 'cs' THEN COALESCE(ho.full_description_cs, ho.full_description_en)
          WHEN ? = 'uk' THEN COALESCE(ho.full_description_uk, ho.full_description_en)
          ELSE ho.full_description_en
        END as full_description
      FROM hotel_offerings ho
      WHERE ho.property_id = ?
        AND ho.status = 'active'
        ${offering_type ? 'AND ho.offering_type = ?' : ''}
      ORDER BY ho.is_featured DESC, ho.display_order ASC, ho.created_at DESC
    `
    
    // Build params array: 8 params for title + 8 for short_desc + 8 for full_desc + property_id + optional type
    const langParams = Array(24).fill(lang) // 8 CASE statements Ã— 3 fields
    const params = offering_type 
      ? [...langParams, property_id, offering_type]
      : [...langParams, property_id]
    
    const offerings = await DB.prepare(query).bind(...params).all()
    
    return c.json({ 
      success: true,
      offerings: offerings.results.map(o => ({
        ...o,
        images: o.images ? JSON.parse(o.images) : [],
        includes: o.includes ? JSON.parse(o.includes) : []
      }))
    })
  } catch (error) {
    console.error('Get hotel offerings error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// API: Get restaurant menus for an offering
app.get('/api/offerings/:offering_id/menus', async (c) => {
  const { DB } = c.env
  const { offering_id } = c.req.param()
  
  try {
    const menus = await DB.prepare(`
      SELECT menu_id, menu_name, menu_url, menu_type, display_order
      FROM restaurant_menus
      WHERE offering_id = ? AND is_active = 1
      ORDER BY display_order ASC, created_at ASC
    `).bind(offering_id).all()
    
    return c.json({ success: true, menus: menus.results })
  } catch (error) {
    console.error('Get menus error:', error)
    return c.json({ error: 'Failed to get menus' }, 500)
  }
})

// API: Get linked vendor activities for a property
app.get('/api/property-vendor-activities/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const lang = c.req.query('lang') || 'en'
  
  try {
    const activities = await DB.prepare(`
      SELECT 
        a.*,
        v.business_name,
        v.slug as vendor_slug,
        c.name_en as category_name,
        CASE 
          WHEN ? = 'ar' THEN COALESCE(a.title_ar, a.title_en)
          ELSE a.title_en
        END as title,
        CASE 
          WHEN ? = 'ar' THEN COALESCE(a.short_description_ar, a.short_description_en)
          ELSE a.short_description_en
        END as short_description
      FROM activities a
      JOIN vendors v ON a.vendor_id = v.vendor_id
      JOIN vendor_properties vp ON v.vendor_id = vp.vendor_id
      JOIN categories c ON a.category_id = c.category_id
      WHERE vp.property_id = ?
        AND vp.status = 'active'
        AND a.status = 'active'
        AND v.status = 'active'
      ORDER BY a.is_featured DESC, a.popularity_score DESC
      LIMIT 50
    `).bind(lang, lang, property_id).all()
    
    return c.json({ 
      success: true,
      activities: activities.results.map(a => ({
        ...a,
        images: a.images ? JSON.parse(a.images) : []
      }))
    })
  } catch (error) {
    console.error('Get property vendor activities error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// ============================================
// AI PROOFREADING API ENDPOINT
// ============================================

// API: AI Proofread Text with Rate Limiting
app.post('/api/ai/proofread', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const { text, user_id, user_type } = body
    
    // Validation
    if (!text || !user_id || !user_type) {
      return c.json({ error: 'Missing required fields: text, user_id, user_type' }, 400)
    }
    
    if (!['admin', 'vendor'].includes(user_type)) {
      return c.json({ error: 'Invalid user_type. Must be admin or vendor' }, 400)
    }
    
    if (text.length > 5000) {
      return c.json({ error: 'Text too long. Maximum 5000 characters allowed.' }, 400)
    }
    
    // Check rate limiting
    const today = new Date().toISOString().split('T')[0]
    
    // Get today's usage
    const usage = await DB.prepare(`
      SELECT request_count, last_request_time
      FROM ai_proofreading_usage
      WHERE user_id = ? AND user_type = ? AND usage_date = ?
    `).bind(user_id, user_type, today).first()
    
    // Check daily limit (10 requests per day)
    if (usage && usage.request_count >= 10) {
      return c.json({ 
        error: 'Daily limit reached', 
        message: 'You have reached your daily limit of 10 AI proofreading requests. Please try again tomorrow.',
        limit: 10,
        used: usage.request_count
      }, 429)
    }
    
    // Check cooldown period (60 seconds between requests)
    if (usage && usage.last_request_time) {
      const lastRequest = new Date(usage.last_request_time).getTime()
      const now = new Date().getTime()
      const timeDiff = (now - lastRequest) / 1000 // seconds
      
      if (timeDiff < 60) {
        const waitTime = Math.ceil(60 - timeDiff)
        return c.json({ 
          error: 'Cooldown period active', 
          message: `Please wait ${waitTime} seconds before making another proofreading request.`,
          wait_seconds: waitTime
        }, 429)
      }
    }
    
    // Call AI proofreading (using GenSpark LLM proxy)
    const startTime = Date.now()
    let proofreadText = text
    let modelUsed = 'gpt-5-nano'
    
    try {
      // Check if GenSpark API is configured
      const apiKey = process.env.OPENAI_API_KEY
      const baseURL = process.env.OPENAI_BASE_URL || 'https://www.genspark.ai/api/llm_proxy/v1'
      
      if (!apiKey) {
        // Fallback: Return formatted text with basic improvements
        console.warn('GenSpark API not configured. Using fallback formatting.')
        proofreadText = text.trim()
        modelUsed = 'fallback'
      } else {
        // Use GenSpark LLM API for proofreading
        const response = await fetch(`${baseURL}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-5-nano', // Fastest, cheapest model
            messages: [{
              role: 'system',
              content: `You are a professional proofreading assistant for hotel and tourism content. Your task is to:

1. Fix grammar, spelling, and punctuation errors
2. Improve sentence structure and clarity
3. Maintain the original meaning and tone
4. Use professional hospitality language
5. Keep the text length similar to the original
6. Output ONLY the corrected text, NO explanations or comments

Important: Do not add or remove information. Only improve grammar, spelling, and readability.`
            }, {
              role: 'user',
              content: `Please proofread and improve this text:\n\n${text}`
            }],
            temperature: 0.3,
            max_tokens: 1000
          })
        })
        
        if (response.ok) {
          const data: any = await response.json()
          proofreadText = data.choices?.[0]?.message?.content?.trim() || text
        } else {
          console.error('AI API error:', await response.text())
          proofreadText = text.trim()
          modelUsed = 'fallback'
        }
      }
    } catch (aiError) {
      console.error('AI proofreading error:', aiError)
      proofreadText = text.trim()
      modelUsed = 'fallback'
    }
    
    const processingTime = Date.now() - startTime
    
    // Update usage tracking
    await DB.prepare(`
      INSERT INTO ai_proofreading_usage (user_id, user_type, request_count, last_request_time, usage_date)
      VALUES (?, ?, 1, CURRENT_TIMESTAMP, ?)
      ON CONFLICT(user_id, user_type, usage_date) 
      DO UPDATE SET 
        request_count = request_count + 1,
        last_request_time = CURRENT_TIMESTAMP
    `).bind(user_id, user_type, today).run()
    
    // Log the request for analytics
    await DB.prepare(`
      INSERT INTO ai_proofreading_logs (user_id, user_type, original_text, proofread_text, text_length, model_used, processing_time_ms)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(user_id, user_type, text, proofreadText, text.length, modelUsed, processingTime).run()
    
    // Get updated usage stats
    const updatedUsage = await DB.prepare(`
      SELECT request_count
      FROM ai_proofreading_usage
      WHERE user_id = ? AND user_type = ? AND usage_date = ?
    `).bind(user_id, user_type, today).first()
    
    return c.json({
      success: true,
      original_text: text,
      proofread_text: proofreadText,
      model_used: modelUsed,
      processing_time_ms: processingTime,
      usage: {
        used: updatedUsage?.request_count || 0,
        limit: 10,
        remaining: 10 - (updatedUsage?.request_count || 0)
      }
    })
    
  } catch (error) {
    console.error('AI proofread error:', error)
    return c.json({ error: 'Internal server error' }, 500)
  }
})

// ============================================
// RAG CHATBOT UTILITY FUNCTIONS
// ============================================

// Split text into chunks for RAG
function chunkText(text: string, maxChunkSize: number = 500): string[] {
  const chunks: string[] = []
  const sentences = text.split(/[.!?]+/).map(s => s.trim()).filter(s => s.length > 0)
  
  let currentChunk = ''
  
  for (const sentence of sentences) {
    if ((currentChunk + sentence).length > maxChunkSize && currentChunk.length > 0) {
      chunks.push(currentChunk.trim())
      currentChunk = sentence + '. '
    } else {
      currentChunk += sentence + '. '
    }
  }
  
  if (currentChunk.length > 0) {
    chunks.push(currentChunk.trim())
  }
  
  return chunks
}

// Simple keyword-based search for chunks (BM25-like)
function calculateRelevanceScore(query: string, text: string): number {
  const queryWords = query.toLowerCase().split(/\s+/).filter(w => w.length > 2)
  const textLower = text.toLowerCase()
  
  // Synonym/related terms mapping - MULTILINGUAL (English + Arabic + French + Spanish + German + Russian + Chinese)
  const synonyms: Record<string, string[]> = {
    // Gym/Fitness (English + Arabic + French + Spanish + German + Russian + Chinese)
    'gym': ['fitness', 'exercise', 'workout', 'gym', 'ØµØ§Ù„Ø©', 'Ø±ÙŠØ§Ø¶ÙŠØ©', 'Ù†Ø§Ø¯ÙŠ', 'gymnase', 'gimnasio', 'fitnessstudio', 'ÑÐ¿Ð¾Ñ€Ñ‚Ð·Ð°Ð»', 'å¥èº«æˆ¿'],
    'fitness': ['gym', 'exercise', 'workout', 'fitness', 'ØµØ§Ù„Ø©', 'Ø±ÙŠØ§Ø¶ÙŠØ©', 'ÙØªÙ†Ø³', 'gymnase', 'gimnasio', 'ÑÐ¿Ð¾Ñ€Ñ‚Ð·Ð°Ð»', 'å¥èº«'],
    'ØµØ§Ù„Ø©': ['gym', 'fitness', 'exercise', 'workout'],
    'Ø±ÙŠØ§Ø¶ÙŠØ©': ['gym', 'fitness', 'exercise', 'workout'],
    'Ù†Ø§Ø¯ÙŠ': ['gym', 'fitness', 'club'],
    'gymnase': ['gym', 'fitness', 'exercise'],
    'gimnasio': ['gym', 'fitness', 'exercise'],
    'ÑÐ¿Ð¾Ñ€Ñ‚Ð·Ð°Ð»': ['gym', 'fitness', 'exercise'],
    'å¥èº«æˆ¿': ['gym', 'fitness', 'exercise'],
    
    // Restaurant/Dining (English + Arabic + French + Spanish + German + Russian + Chinese)
    'restaurant': ['dining', 'food', 'eat', 'restaurant', 'cuisine', 'Ù…Ø·Ø¹Ù…', 'Ø·Ø¹Ø§Ù…', 'Ø£ÙƒÙ„', 'restaurante', 'Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½', 'é¤åŽ…'],
    'dining': ['restaurant', 'food', 'eat', 'dining', 'cuisine', 'Ù…Ø·Ø¹Ù…', 'Ø·Ø¹Ø§Ù…', 'restaurante', 'Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½', 'ç”¨é¤'],
    'Ù…Ø·Ø¹Ù…': ['restaurant', 'dining', 'food'],
    'Ø·Ø¹Ø§Ù…': ['food', 'dining', 'restaurant', 'eat'],
    'Ø£ÙƒÙ„': ['food', 'eat', 'dining'],
    'restaurante': ['restaurant', 'dining', 'food'],
    'Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½': ['restaurant', 'dining', 'food'],
    'é¤åŽ…': ['restaurant', 'dining', 'food'],
    
    // Pool (English + Arabic + French + Spanish + German + Russian + Chinese)
    'pool': ['swimming', 'swim', 'beach', 'pool', 'Ù…Ø³Ø¨Ø­', 'Ø³Ø¨Ø§Ø­Ø©', 'piscine', 'alberca', 'schwimmbad', 'Ð±Ð°ÑÑÐµÐ¹Ð½', 'æ¸¸æ³³æ± '],
    'Ù…Ø³Ø¨Ø­': ['pool', 'swimming', 'swim'],
    'Ø³Ø¨Ø§Ø­Ø©': ['swimming', 'swim', 'pool'],
    'piscine': ['pool', 'swimming'],
    'alberca': ['pool', 'swimming'],
    'schwimmbad': ['pool', 'swimming'],
    'Ð±Ð°ÑÑÐµÐ¹Ð½': ['pool', 'swimming'],
    'æ¸¸æ³³æ± ': ['pool', 'swimming'],
    
    // Spa (English + Arabic + French + Spanish + German + Russian + Chinese)
    'spa': ['wellness', 'massage', 'treatment', 'spa', 'therapy', 'Ø³Ø¨Ø§', 'ØªØ¯Ù„ÙŠÙƒ', 'massage', 'ÑÐ¿Ð°', 'Ð¼Ð°ÑÑÐ°Ð¶', 'æ°´ç–—'],
    'Ø³Ø¨Ø§': ['spa', 'wellness', 'massage'],
    'ØªØ¯Ù„ÙŠÙƒ': ['massage', 'spa', 'treatment'],
    'massage': ['spa', 'wellness', 'treatment', 'massage', 'ØªØ¯Ù„ÙŠÙƒ', 'Ð¼Ð°ÑÑÐ°Ð¶', 'æŒ‰æ‘©'],
    'ÑÐ¿Ð°': ['spa', 'wellness'],
    'Ð¼Ð°ÑÑÐ°Ð¶': ['massage', 'spa'],
    'æ°´ç–—': ['spa', 'wellness'],
    'æŒ‰æ‘©': ['massage', 'spa'],
    
    // Events (English + Arabic + French + Spanish + German + Russian + Chinese)
    'event': ['party', 'celebration', 'gala', 'dinner', 'event', 'festive', 'entertainment', 'Ø­ÙÙ„', 'Ø§Ø­ØªÙØ§Ù„', 'Ø­Ø¯Ø«', 'Ã©vÃ©nement', 'evento', 'veranstaltung', 'Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ', 'æ´»åŠ¨'],
    'events': ['party', 'celebration', 'gala', 'dinner', 'event', 'festive', 'entertainment', 'Ø­ÙÙ„Ø§Øª', 'Ø§Ø­ØªÙØ§Ù„Ø§Øª', 'Ø£Ø­Ø¯Ø§Ø«', 'Ã©vÃ©nements', 'eventos', 'æ´»åŠ¨'],
    'party': ['event', 'celebration', 'gala', 'dinner', 'party', 'festive', 'Ø­ÙÙ„Ø©', 'fiesta', 'Ð²ÐµÑ‡ÐµÑ€Ð¸Ð½ÐºÐ°', 'æ´¾å¯¹'],
    'celebration': ['event', 'party', 'gala', 'dinner', 'celebration', 'festive', 'Ø§Ø­ØªÙØ§Ù„', 'celebraciÃ³n', 'Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸Ðº', 'åº†ç¥'],
    'Ø­ÙÙ„': ['event', 'party', 'celebration'],
    'Ø­ÙÙ„Ø©': ['party', 'event', 'celebration'],
    'Ø§Ø­ØªÙØ§Ù„': ['celebration', 'event', 'party'],
    'Ø­Ø¯Ø«': ['event', 'happening'],
    'Ã©vÃ©nement': ['event', 'happening'],
    'evento': ['event', 'happening'],
    'Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ': ['event', 'happening'],
    'æ´»åŠ¨': ['event', 'activity'],
    
    // Diving/Snorkeling (English + Arabic + French + Spanish + German + Russian + Chinese)
    'snorkel': ['diving', 'snorkeling', 'underwater', 'scuba', 'dive', 'snorkel', 'ØºØ·Ø³', 'plongÃ©e', 'buceo', 'tauchen', 'Ð´Ð°Ð¹Ð²Ð¸Ð½Ð³', 'æ½œæ°´'],
    'snorkeling': ['diving', 'snorkeling', 'underwater', 'scuba', 'dive', 'snorkel', 'ØºØ·Ø³', 'plongÃ©e', 'buceo', 'Ð´Ð°Ð¹Ð²Ð¸Ð½Ð³', 'æµ®æ½œ'],
    'dive': ['diving', 'snorkeling', 'underwater', 'scuba', 'dive', 'snorkel', 'ØºÙˆØµ', 'plongÃ©e', 'buceo', 'æ½œæ°´'],
    'diving': ['diving', 'snorkeling', 'underwater', 'scuba', 'dive', 'snorkel', 'ØºØ·Ø³', 'ØºÙˆØµ', 'plongÃ©e', 'buceo', 'tauchen', 'Ð´Ð°Ð¹Ð²Ð¸Ð½Ð³', 'æ½œæ°´'],
    'scuba': ['diving', 'snorkeling', 'underwater', 'scuba', 'dive', 'snorkel', 'ØºØ·Ø³', 'buceo', 'Ð´Ð°Ð¹Ð²Ð¸Ð½Ð³', 'æ°´è‚ºæ½œæ°´'],
    'ØºØ·Ø³': ['diving', 'snorkeling', 'scuba', 'dive'],
    'ØºÙˆØµ': ['diving', 'dive', 'scuba'],
    'plongÃ©e': ['diving', 'snorkeling', 'scuba'],
    'buceo': ['diving', 'snorkeling', 'scuba'],
    'tauchen': ['diving', 'snorkeling'],
    'Ð´Ð°Ð¹Ð²Ð¸Ð½Ð³': ['diving', 'scuba'],
    'æ½œæ°´': ['diving', 'snorkeling', 'scuba'],
    'æµ®æ½œ': ['snorkeling', 'diving']
  }
  
  let score = 0
  for (const word of queryWords) {
    // Exact word match (high priority)
    const wordRegex = new RegExp(`\\b${word}\\b`, 'i')
    if (wordRegex.test(textLower)) {
      score += 10 // Much higher score for exact match
    }
    
    // Check synonyms
    if (synonyms[word]) {
      for (const synonym of synonyms[word]) {
        const synRegex = new RegExp(`\\b${synonym}\\b`, 'i')
        if (synRegex.test(textLower)) {
          score += 8 // High score for synonym match
        }
      }
    }
    
    // Partial match (lower priority)
    if (textLower.includes(word)) {
      score += 2
    }
  }
  
  // Boost if text looks like a title/heading (starts with capital or has newlines around it)
  if (/^[A-Z]/.test(text) || text.includes('\n\n')) {
    score *= 1.2
  }
  
  return score
}

// ============================================
// RAG CHATBOT API ENDPOINTS
// ============================================

// API: Upload/Create Knowledge Base Document
app.post('/api/admin/chatbot/documents', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const { property_id, title, content, document_type } = body
    
    if (!property_id || !title || !content) {
      return c.json({ error: 'Missing required fields' }, 400)
    }
    
    // Insert document
    const docResult = await DB.prepare(`
      INSERT INTO chatbot_documents (property_id, title, content, document_type)
      VALUES (?, ?, ?, ?)
    `).bind(property_id, title, content, document_type || 'general').run()
    
    const documentId = docResult.meta.last_row_id
    
    // Chunk the content
    const chunks = chunkText(content)
    
    // Insert chunks
    for (let i = 0; i < chunks.length; i++) {
      await DB.prepare(`
        INSERT INTO chatbot_chunks (document_id, property_id, chunk_text, chunk_index, embedding_text, token_count)
        VALUES (?, ?, ?, ?, ?, ?)
      `).bind(documentId, property_id, chunks[i], i, chunks[i].toLowerCase(), chunks[i].split(/\s+/).length).run()
    }
    
    return c.json({ 
      success: true, 
      document_id: documentId,
      chunks_created: chunks.length 
    })
    
  } catch (error) {
    console.error('Create document error:', error)
    return c.json({ error: 'Failed to create document' }, 500)
  }
})

// API: Get all documents for a property
app.get('/api/admin/chatbot/documents', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  
  try {
    const documents = await DB.prepare(`
      SELECT d.*, 
             (SELECT COUNT(*) FROM chatbot_chunks WHERE document_id = d.document_id) as chunk_count
      FROM chatbot_documents d
      WHERE d.property_id = ? AND d.is_active = 1
      ORDER BY d.created_at DESC
    `).bind(property_id).all()
    
    return c.json({ success: true, documents: documents.results || [] })
  } catch (error) {
    console.error('Get documents error:', error)
    return c.json({ error: 'Failed to get documents' }, 500)
  }
})

// API: Update document
app.put('/api/admin/chatbot/documents/:document_id', async (c) => {
  const { DB } = c.env
  const { document_id } = c.req.param()
  
  try {
    const body = await c.req.json()
    const { property_id, title, content, document_type } = body
    
    if (!property_id || !title || !content) {
      return c.json({ error: 'Missing required fields' }, 400)
    }
    
    // Update document
    await DB.prepare(`
      UPDATE chatbot_documents 
      SET title = ?, content = ?, document_type = ?, updated_at = CURRENT_TIMESTAMP
      WHERE document_id = ? AND property_id = ?
    `).bind(title, content, document_type || 'general', document_id, property_id).run()
    
    // Delete old chunks
    await DB.prepare(`DELETE FROM chatbot_chunks WHERE document_id = ?`).bind(document_id).run()
    
    // Re-chunk the content
    const chunks = chunkText(content)
    
    // Insert new chunks
    for (let i = 0; i < chunks.length; i++) {
      await DB.prepare(`
        INSERT INTO chatbot_chunks (document_id, property_id, chunk_text, chunk_index, embedding_text, token_count)
        VALUES (?, ?, ?, ?, ?, ?)
      `).bind(document_id, property_id, chunks[i], i, chunks[i].toLowerCase(), chunks[i].split(/\s+/).length).run()
    }
    
    return c.json({ 
      success: true, 
      document_id: document_id,
      chunks_created: chunks.length 
    })
    
  } catch (error) {
    console.error('Update document error:', error)
    return c.json({ error: 'Failed to update document' }, 500)
  }
})

// API: Delete document
app.delete('/api/admin/chatbot/documents/:document_id', async (c) => {
  const { DB } = c.env
  const { document_id } = c.req.param()
  
  try {
    await DB.prepare(`UPDATE chatbot_documents SET is_active = 0 WHERE document_id = ?`).bind(document_id).run()
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete document error:', error)
    return c.json({ error: 'Failed to delete document' }, 500)
  }
})

// API: Chat with RAG
// ðŸ¤– AI Sentiment Analysis & Feedback Capture Function
// AI-POWERED COMPLAINT DETECTION - Works for ANY language, ANY phrasing
async function detectComplaintWithAI(message: string, apiKey: string, baseURL: string): Promise<{isComplaint: boolean, isUrgent: boolean, category: string, confidence: number}> {
  try {
    const response = await fetch(`${baseURL}/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          {
            role: 'system',
            content: `You are a sentiment analysis expert for hotel guest messages. Analyze if the message is a complaint or negative feedback.

IMPORTANT: Guest messages can be in ANY language (English, Arabic, French, Spanish, German, Russian, Chinese, etc.)

Analyze this message and respond with ONLY valid JSON (no markdown, no code blocks):
{
  "isComplaint": boolean (true if expressing dissatisfaction, problem, or negative experience),
  "isUrgent": boolean (true if requires immediate attention - emergency, danger, health hazard),
  "category": string (one of: "room", "food", "staff", "cleanliness", "amenities", "service", "other"),
  "confidence": number (0-100, how confident you are this is a complaint)
}

Examples:
"Ø§Ù„ØºØ±ÙØ© Ù…ØªØ³Ø®Ø©" â†’ {"isComplaint": true, "isUrgent": false, "category": "cleanliness", "confidence": 95}
"I'm not satisfied with the service" â†’ {"isComplaint": true, "isUrgent": false, "category": "service", "confidence": 90}
"å¯ä»¥å‘Šè¯‰æˆ‘æ—©é¤æ—¶é—´å—ï¼Ÿ" â†’ {"isComplaint": false, "isUrgent": false, "category": "other", "confidence": 0}
"There are bugs in my room!" â†’ {"isComplaint": true, "isUrgent": true, "category": "room", "confidence": 100}`
          },
          {
            role: 'user',
            content: message
          }
        ],
        temperature: 0.3,
        max_tokens: 100
      })
    })

    if (!response.ok) {
      console.error('AI complaint detection failed:', response.status)
      return { isComplaint: false, isUrgent: false, category: 'other', confidence: 0 }
    }

    const data = await response.json()
    const content = data.choices[0].message.content.trim()
    
    // Remove markdown code blocks if present
    const jsonStr = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim()
    const result = JSON.parse(jsonStr)
    
    console.log('ðŸ¤– AI Complaint Detection:', {
      message: message.substring(0, 50),
      result
    })
    
    return result
  } catch (error) {
    console.error('AI complaint detection error:', error)
    // Fallback to safe default
    return { isComplaint: false, isUrgent: false, category: 'other', confidence: 0 }
  }
}

async function analyzeSentimentAndCaptureFeedback(DB: any, property_id: number, conversation_id: number, guestMessage: string, botResponse: string, apiKey?: string, baseURL?: string) {
  try {
    // Use AI-powered detection if API key available
    let isComplaint = false
    let isUrgent = false
    let complaintCategory = 'other'
    let confidence = 0
    
    if (apiKey) {
      const aiResult = await detectComplaintWithAI(guestMessage, apiKey, baseURL || 'https://www.genspark.ai/api/llm_proxy/v1')
      isComplaint = aiResult.isComplaint && aiResult.confidence >= 70
      isUrgent = aiResult.isUrgent
      complaintCategory = aiResult.category
      confidence = aiResult.confidence
      
      console.log('âœ… AI Detection:', { isComplaint, isUrgent, category: complaintCategory, confidence })
    } else {
      // Fallback: Simple keyword detection for critical words only
      const messageLower = guestMessage.toLowerCase()
      const criticalKeywords = ['terrible', 'disgusting', 'awful', 'horrible', 'unacceptable', 'emergency', 'dirty', 'broken',
        'Ø´ÙƒÙˆÙ‰', 'Ù…Ø´ÙƒÙ„Ø©', 'ÙØ¸ÙŠØ¹', 'Ù‚Ø°Ø±', 'Ù…ØªØ³Ø®', 'ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„',
        'plainte', 'problÃ¨me', 'terrible', 'sale',
        'queja', 'problema', 'terrible', 'sucio']
      isComplaint = criticalKeywords.some(k => messageLower.includes(k))
      complaintCategory = detectComplaintCategory(messageLower)
    }
    
    if (!isComplaint) {
      // Not a complaint, skip feedback capture
      return { needsGuestInfo: false }
    }
    
    // 2. CALCULATE SENTIMENT SCORE based on confidence
    const sentimentScore = confidence ? -(confidence / 100) : -0.5
    
    // 3. DETERMINE SENTIMENT LABEL
    let sentimentLabel = 'negative'
    if (isUrgent) sentimentLabel = 'urgent'
    else if (confidence >= 90) sentimentLabel = 'complaint'
    
    // 4. EXTRACT STRUCTURED INFORMATION
    const complaintSummary = generateComplaintSummary(guestMessage, complaintCategory)
    
    // Extract room number and name using SMART EXTRACTORS
    const roomNumber = extractRoomNumber(guestMessage)
    const guestName = extractGuestName(guestMessage)
    
    // 5. CHECK IF WE HAVE GUEST INFO - REQUIRED for actionable complaints
    const hasRoomNumber = roomNumber !== null
    const hasLastName = guestName !== null
    
    // Check if there's a pending complaint for this conversation (missing guest info)
    const pendingComplaint = await DB.prepare(`
      SELECT feedback_id, guest_name, room_number 
      FROM chat_feedback 
      WHERE conversation_id = ? AND property_id = ?
        AND (guest_name IS NULL OR room_number IS NULL)
      ORDER BY detected_at DESC
      LIMIT 1
    `).bind(conversation_id, property_id).first()
    
    // If guest provided info, update the pending complaint
    if (pendingComplaint && (hasRoomNumber || hasLastName)) {
      const updateFields = []
      const updateValues = []
      
      if (hasRoomNumber && !pendingComplaint.room_number) {
        updateFields.push('room_number = ?')
        updateValues.push(roomNumber)
      }
      if (hasLastName && !pendingComplaint.guest_name) {
        updateFields.push('guest_name = ?')
        updateValues.push(guestName)
      }
      
      if (updateFields.length > 0) {
        updateValues.push(pendingComplaint.feedback_id)
        await DB.prepare(`
          UPDATE chat_feedback 
          SET ${updateFields.join(', ')}
          WHERE feedback_id = ?
        `).bind(...updateValues).run()
        
        // Check if now complete
        const updatedComplaint = await DB.prepare(`
          SELECT guest_name, room_number FROM chat_feedback WHERE feedback_id = ?
        `).bind(pendingComplaint.feedback_id).first()
        
        if (updatedComplaint.guest_name && updatedComplaint.room_number) {
          return { needsGuestInfo: false, feedbackSaved: true, complaintUpdated: true }
        }
      }
    }
    
    // 6. SAVE NEW COMPLAINT ONLY IF we have complete info OR it's the first complaint
    if (!hasRoomNumber || !hasLastName) {
      // Check if we already asked for info (don't create duplicate entries)
      if (pendingComplaint) {
        return { 
          needsGuestInfo: true, 
          hasRoomNumber, 
          hasLastName,
          complaintCategory,
          isUrgent,
          feedbackSaved: false,
          hasPendingComplaint: true
        }
      }
      
      // First time - save incomplete complaint as placeholder
      await DB.prepare(`
        INSERT INTO chat_feedback (
          property_id, conversation_id, guest_message, bot_response,
          sentiment_label, sentiment_score, is_complaint, is_urgent,
          complaint_category, complaint_summary, guest_name, room_number,
          issue_description
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(
        property_id, 
        conversation_id, 
        guestMessage, 
        botResponse,
        sentimentLabel,
        sentimentScore,
        isComplaint ? 1 : 0,
        isUrgent ? 1 : 0,
        complaintCategory,
        complaintSummary,
        null, // No guest name yet
        null, // No room number yet
        guestMessage
      ).run()
      
      return { 
        needsGuestInfo: true, 
        hasRoomNumber, 
        hasLastName,
        complaintCategory,
        isUrgent,
        feedbackSaved: true,
        hasPendingComplaint: false
      }
    }
    
    // Complete info available - save full complaint
    await DB.prepare(`
      INSERT INTO chat_feedback (
        property_id, conversation_id, guest_message, bot_response,
        sentiment_label, sentiment_score, is_complaint, is_urgent,
        complaint_category, complaint_summary, guest_name, room_number,
        issue_description
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      property_id, 
      conversation_id, 
      guestMessage, 
      botResponse,
      sentimentLabel,
      sentimentScore,
      isComplaint ? 1 : 0,
      isUrgent ? 1 : 0,
      complaintCategory,
      complaintSummary,
      guestName,
      roomNumber,
      guestMessage
    ).run()
    
    return { needsGuestInfo: false, feedbackSaved: true }
    
  } catch (error) {
    console.error('Sentiment analysis error:', error)
    // Don't throw - this shouldn't break the chat flow
    return { needsGuestInfo: false, error: true }
  }
}

function detectComplaintCategory(messageLower: string): string {
  if (messageLower.includes('room') || messageLower.includes('bed') || messageLower.includes('bathroom')) 
    return 'room'
  if (messageLower.includes('food') || messageLower.includes('restaurant') || messageLower.includes('meal') || messageLower.includes('breakfast'))
    return 'food'
  if (messageLower.includes('staff') || messageLower.includes('reception') || messageLower.includes('rude'))
    return 'staff'
  if (messageLower.includes('clean') || messageLower.includes('dirty') || messageLower.includes('hygiene'))
    return 'cleanliness'
  if (messageLower.includes('wifi') || messageLower.includes('pool') || messageLower.includes('gym') || messageLower.includes('spa'))
    return 'amenities'
  if (messageLower.includes('service') || messageLower.includes('wait'))
    return 'service'
  return 'other'
}

function generateComplaintSummary(message: string, category: string): string {
  const maxLength = 200
  const trimmed = message.length > maxLength ? message.substring(0, maxLength) + '...' : message
  return `[${category.toUpperCase()}] ${trimmed}`
}

// DETECT LANGUAGE from message
function detectLanguage(message: string): string {
  // Arabic
  if (/[\u0600-\u06FF]/.test(message)) return 'ar'
  // Chinese
  if (/[\u4E00-\u9FFF]/.test(message)) return 'zh'
  // Russian
  if (/[\u0400-\u04FF]/.test(message)) return 'ru'
  // French indicators
  if (/\b(le|la|les|un|une|des|bonjour|merci|oui|non|est|sont)\b/i.test(message)) return 'fr'
  // Spanish indicators
  if (/\b(el|la|los|las|un|una|hola|gracias|sÃ­|no|es|son|estÃ¡|estÃ¡n)\b/i.test(message)) return 'es'
  // German indicators
  if (/\b(der|die|das|ein|eine|ist|sind|und|oder|aber|guten|danke)\b/i.test(message)) return 'de'
  // Default to English
  return 'en'
}

// SMART EXTRACTION: Extract room number from natural language
function extractRoomNumber(message: string): string | null {
  const msg = message.toLowerCase().trim()
  
  // Pattern 1: "room 305", "room number 305", "room #305"
  let match = msg.match(/room\s*(?:number|#)?\s*(\d+)/i)
  if (match) return match[1]
  
  // Pattern 2: "305" or "#305" standalone (2-4 digit number)
  match = msg.match(/(?:^|\s)#?(\d{2,4})(?:\s|$)/)
  if (match) return match[1]
  
  // Pattern 3: "in 305", "at 305"
  match = msg.match(/(?:in|at)\s+(?:room\s*)?(\d{2,4})/i)
  if (match) return match[1]
  
  // Pattern 4: Just numbers in response (if message is short)
  if (msg.length < 30) {
    match = msg.match(/(\d{2,4})/)
    if (match) return match[1]
  }
  
  return null
}

// SMART EXTRACTION: Extract guest name from natural language (supports all languages)
function extractGuestName(message: string): string | null {
  const msg = message.trim()
  
  // Pattern 1: "my name is Smith", "my last name is Smith", "surname is Smith"
  let match = msg.match(/(?:my\s+)?(?:last\s+)?(?:name|surname)\s+(?:is\s+)?([^\s,]+)/i)
  if (match) return match[1]
  
  // Pattern 2: "I'm Smith", "I am Smith"
  match = msg.match(/I'?m\s+([^\s,]+)|I\s+am\s+([^\s,]+)/i)
  if (match) return match[1] || match[2]
  
  // Pattern 3: "Mr. Smith", "Mrs. Smith", "Ms. Smith", "Miss Smith"
  match = msg.match(/(?:mr\.?|mrs\.?|ms\.?|miss)\s+([^\s,]+)/i)
  if (match) return match[1]
  
  // Pattern 4: Name before room number "Ahmed 401" or "Ø£Ø­Ù…Ø¯ 401"
  match = msg.match(/^([^\s\d]+)\s+\d{2,4}/)
  if (match && match[1].length >= 2) return match[1]
  
  // Pattern 5: Just a word (likely a name if message is short and has no numbers)
  if (msg.length < 50 && !/\d/.test(msg)) {
    // Latin alphabet capitalized word
    match = msg.match(/\b([A-Z][a-z]{2,})\b/)
    if (match && !['Room', 'Hotel', 'Yes', 'Sure', 'Thanks', 'Please', 'Hello'].includes(match[1])) {
      return match[1]
    }
    // Or any non-space word (for Arabic, Chinese, etc.)
    match = msg.match(/([^\s\d]{2,})/)
    if (match) return match[1]
  }
  
  // Pattern 6: Name followed by room with various separators
  match = msg.match(/([^\s\d,]+)\s*(?:and|,|in|at|room)?\s*\d{2,4}/i)
  if (match && match[1].length >= 2) return match[1]
  
  // Pattern 7: For short messages with both letters and numbers, extract letters
  if (msg.length < 30) {
    // Extract first word that's not a number
    const words = msg.split(/\s+/)
    for (const word of words) {
      if (!/^\d+$/.test(word) && word.length >= 2) {
        return word
      }
    }
  }
  
  return null
}

app.post('/api/chatbot/chat', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const { property_id, session_id, message, conversation_id } = body
    
    if (!property_id || !session_id || !message) {
      return c.json({ error: 'Missing required fields' }, 400)
    }
    
    // Rate limiting check
    const today = new Date().toISOString().split('T')[0]
    const rateLimit = await DB.prepare(`
      SELECT message_count FROM chatbot_rate_limits
      WHERE property_id = ? AND session_id = ? AND reset_date = ?
    `).bind(property_id, session_id, today).first()
    
    if (rateLimit && rateLimit.message_count >= 20) {
      return c.json({ 
        error: 'Rate limit exceeded',
        message: 'You have reached your daily limit of 20 messages. Please try again tomorrow.'
      }, 429)
    }
    
    // Get or create conversation
    let convId = conversation_id
    if (!convId) {
      const convResult = await DB.prepare(`
        INSERT INTO chatbot_conversations (property_id, session_id)
        VALUES (?, ?)
      `).bind(property_id, session_id).run()
      convId = convResult.meta.last_row_id
    }
    
    // Get property info for personalization
    const propertyInfo = await DB.prepare(`
      SELECT name, chatbot_name, chatbot_greeting_en
      FROM properties
      WHERE property_id = ?
    `).bind(property_id).first()
    
    const hotelName = propertyInfo?.name || 'our hotel'
    const chatbotName = propertyInfo?.chatbot_name || 'Hotel Assistant'
    
    // âš ï¸ CHECK FOR PENDING COMPLAINT FIRST - Block conversation until guest info provided
    // Search by session_id since frontend might not always send conversation_id
    const pendingComplaint = await DB.prepare(`
      SELECT cf.feedback_id, cf.complaint_category, cf.is_urgent, cf.guest_name, cf.room_number
      FROM chat_feedback cf
      JOIN chatbot_conversations cc ON cf.conversation_id = cc.conversation_id
      WHERE cc.session_id = ? AND cf.property_id = ?
        AND (cf.guest_name IS NULL OR cf.room_number IS NULL)
      ORDER BY cf.detected_at DESC
      LIMIT 1
    `).bind(session_id, property_id).first()
    
    if (pendingComplaint) {
      // Check if user is providing the missing info NOW - SMART EXTRACTION
      const roomNumber = extractRoomNumber(message)
      const guestName = extractGuestName(message)
      
      const needsRoom = !pendingComplaint.room_number
      const needsName = !pendingComplaint.guest_name
      const providedRoom = roomNumber !== null
      const providedName = guestName !== null
      
      // If they provided what we need, update the complaint
      if ((needsRoom && providedRoom) || (needsName && providedName)) {
        const updateFields = []
        const updateValues = []
        
        if (needsRoom && providedRoom) {
          updateFields.push('room_number = ?')
          updateValues.push(roomNumber)
        }
        if (needsName && providedName) {
          updateFields.push('guest_name = ?')
          updateValues.push(guestName)
        }
        
        updateValues.push(pendingComplaint.feedback_id)
        await DB.prepare(`
          UPDATE chat_feedback 
          SET ${updateFields.join(', ')}
          WHERE feedback_id = ?
        `).bind(...updateValues).run()
        
        // Check if now complete
        const stillNeedsRoom = needsRoom && !providedRoom
        const stillNeedsName = needsName && !providedName
        
        if (!stillNeedsRoom && !stillNeedsName) {
          // Complete! Send confirmation
          const finalName = guestName || pendingComplaint.guest_name
          const finalRoom = roomNumber || pendingComplaint.room_number
          let confirmationMsg = "âœ… **Thank you! Your complaint has been officially logged.**\n\n"
          confirmationMsg += "ðŸ“‹ **Complaint Details:**\n"
          confirmationMsg += "â€¢ Guest: " + finalName + "\n"
          confirmationMsg += "â€¢ Room: " + finalRoom + "\n"
          confirmationMsg += "â€¢ Category: " + (pendingComplaint.complaint_category || 'General') + "\n"
          confirmationMsg += "â€¢ Status: Logged with management\n"
          confirmationMsg += "â€¢ Response Time: Within 15 minutes\n\n"
          confirmationMsg += "Our management team will contact you shortly to resolve this issue.\n\n"
          confirmationMsg += "Is there anything else I can help you with in the meantime?"
          
          await DB.prepare(`
            INSERT INTO chatbot_messages (conversation_id, role, content)
            VALUES (?, 'user', ?)
          `).bind(convId, message).run()
          
          await DB.prepare(`
            INSERT INTO chatbot_messages (conversation_id, role, content, chunks_used)
            VALUES (?, 'assistant', ?, '[]')
          `).bind(convId, confirmationMsg).run()
          
          return c.json({ 
            success: true,
            response: confirmationMsg,
            conversation_id: convId,
            chunks_used: 0
          })
        } else {
          // Still need more info
          let stillNeedMsg = "ðŸ“‹ **Thank you! I have:\n"
          if (providedName || !needsName) stillNeedMsg += "âœ… Your name: " + (providedName || pendingComplaint.guest_name) + "\n"
          if (providedRoom || !needsRoom) stillNeedMsg += "âœ… Your room: " + (providedRoom || pendingComplaint.room_number) + "\n"
          stillNeedMsg += "\nðŸš¨ **Still needed:**\n"
          if (stillNeedsRoom) stillNeedMsg += "âŒ Your room number\n"
          if (stillNeedsName) stillNeedMsg += "âŒ Your last name\n"
          stillNeedMsg += "\nðŸ“‹ Please provide the missing information so I can log your complaint."
          
          await DB.prepare(`
            INSERT INTO chatbot_messages (conversation_id, role, content)
            VALUES (?, 'user', ?)
          `).bind(convId, message).run()
          
          await DB.prepare(`
            INSERT INTO chatbot_messages (conversation_id, role, content, chunks_used)
            VALUES (?, 'assistant', ?, '[]')
          `).bind(convId, stillNeedMsg).run()
          
          return c.json({ 
            success: true,
            response: stillNeedMsg,
            conversation_id: convId,
            chunks_used: 0
          })
        }
      } else {
        // They didn't provide the info - block and remind them
        let blockMsg = "ðŸš¨ **I cannot assist with other requests until your complaint is logged.**\n\n"
        blockMsg += "**Please provide:**\n"
        if (needsName) blockMsg += "ðŸ‘¤ Your **last name** (surname)\n"
        if (needsRoom) blockMsg += "ðŸ¨ Your **room number**\n"
        blockMsg += "\nðŸ“‹ Example: My last name is Smith and I'm in room 305"
        
        await DB.prepare(`
          INSERT INTO chatbot_messages (conversation_id, role, content)
          VALUES (?, 'user', ?)
        `).bind(convId, message).run()
        
        await DB.prepare(`
          INSERT INTO chatbot_messages (conversation_id, role, content, chunks_used)
          VALUES (?, 'assistant', ?, '[]')
        `).bind(convId, blockMsg).run()
        
        return c.json({ 
          success: true,
          response: blockMsg,
          conversation_id: convId,
          chunks_used: 0
        })
      }
    }
    
    // Store user message (only if no pending complaint)
    await DB.prepare(`
      INSERT INTO chatbot_messages (conversation_id, role, content)
      VALUES (?, 'user', ?)
    `).bind(convId, message).run()
    
    // Check if this is a simple greeting FIRST (before RAG search) - MULTILINGUAL
    const greetings = [
      // English
      'hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening', 'greetings',
      // Arabic
      'Ù…Ø±Ø­Ø¨Ø§', 'Ù…Ø±Ø­Ø¨Ø§Ù‹', 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…', 'Ø£Ù‡Ù„Ø§', 'Ø£Ù‡Ù„Ø§Ù‹', 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±', 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±',
      // French
      'bonjour', 'salut', 'bonsoir', 'coucou',
      // Spanish
      'hola', 'buenos dÃ­as', 'buenas tardes', 'buenas noches',
      // German
      'hallo', 'guten tag', 'guten morgen', 'guten abend',
      // Italian
      'ciao', 'buongiorno', 'buonasera',
      // Russian
      'Ð¿Ñ€Ð¸Ð²ÐµÑ‚', 'Ð·Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ', 'Ð´Ð¾Ð±Ñ€Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ',
      // Chinese
      'ä½ å¥½', 'æ‚¨å¥½', 'æ—©ä¸Šå¥½', 'æ™šä¸Šå¥½'
    ];
    const messageLower = message.toLowerCase().trim()
    const isSimpleGreeting = greetings.includes(messageLower) || greetings.some(g => messageLower === g + '!' || messageLower === g + '.' || messageLower === g + 'ØŸ');
    
    if (isSimpleGreeting) {
      // Detect language and respond accordingly
      let greetingResponse = '';
      
      // Arabic detection
      if (/[\u0600-\u06FF]/.test(message)) {
        greetingResponse = `Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ ${hotelName}! Ø£Ù†Ø§ ${chatbotName}ØŒ Ù…Ø³Ø§Ø¹Ø¯ÙƒÙ… Ø§Ù„Ø´Ø®ØµÙŠ.\n\nÙŠØ³Ø¹Ø¯Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒÙ… ÙÙŠ:\nâ€¢ Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ø§Ø¹Ù… ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø·Ø¹Ø§Ù…\nâ€¢ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø³Ø¨Ø§ ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ©\nâ€¢ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ø±Ø­Ù„Ø§Øª\nâ€¢ Ù…Ø±Ø§ÙÙ‚ Ø§Ù„ØºØ±Ù ÙˆØ§Ù„ÙÙ†Ø¯Ù‚\nâ€¢ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„ ÙˆØ§Ù„Ù…ØºØ§Ø¯Ø±Ø©\nâ€¢ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø®Ø§ØµØ©\n\nÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø®Ø¯Ù…ØªÙƒÙ…ØŸ`;
      }
      // French detection
      else if (messageLower.includes('bonjour') || messageLower.includes('salut') || messageLower.includes('bonsoir')) {
        greetingResponse = `Bienvenue Ã  ${hotelName}! Je suis ${chatbotName}, votre assistant personnel.\n\nJe suis lÃ  pour vous aider avec:\nâ€¢ RÃ©servations de restaurants et informations\nâ€¢ Services de spa et bien-Ãªtre\nâ€¢ ActivitÃ©s et excursions\nâ€¢ Ã‰quipements de chambre et installations\nâ€¢ Enregistrement et dÃ©part\nâ€¢ Toute demande spÃ©ciale\n\nComment puis-je vous servir?`;
      }
      // Spanish detection
      else if (messageLower.includes('hola') || messageLower.includes('buenos')) {
        greetingResponse = `Â¡Bienvenido a ${hotelName}! Soy ${chatbotName}, su asistente personal.\n\nEstoy aquÃ­ para ayudarle con:\nâ€¢ Reservas de restaurantes e informaciÃ³n\nâ€¢ Servicios de spa y bienestar\nâ€¢ Actividades y excursiones\nâ€¢ Comodidades de habitaciÃ³n y instalaciones\nâ€¢ Check-in y check-out\nâ€¢ Cualquier solicitud especial\n\nÂ¿En quÃ© puedo servirle?`;
      }
      // German detection
      else if (messageLower.includes('hallo') || messageLower.includes('guten')) {
        greetingResponse = `Willkommen im ${hotelName}! Ich bin ${chatbotName}, Ihr persÃ¶nlicher Assistent.\n\nIch helfe Ihnen gerne bei:\nâ€¢ Restaurant-Reservierungen und Informationen\nâ€¢ Spa- und Wellness-Dienstleistungen\nâ€¢ AktivitÃ¤ten und AusflÃ¼ge\nâ€¢ Zimmerausstattung und Einrichtungen\nâ€¢ Check-in und Check-out\nâ€¢ Besonderen WÃ¼nschen\n\nWie kann ich Ihnen helfen?`;
      }
      // Russian detection
      else if (/[\u0400-\u04FF]/.test(message)) {
        greetingResponse = `Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² ${hotelName}! Ð¯ ${chatbotName}, Ð²Ð°Ñˆ Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº.\n\nÐ¯ Ð·Ð´ÐµÑÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð²Ð°Ð¼ Ñ:\nâ€¢ Ð‘Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð¾Ð² Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ\nâ€¢ Ð¡Ð¿Ð° Ð¸ Ð²ÐµÐ»Ð½ÐµÑ ÑƒÑÐ»ÑƒÐ³Ð¸\nâ€¢ ÐœÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ Ð¸ ÑÐºÑÐºÑƒÑ€ÑÐ¸Ð¸\nâ€¢ Ð£Ð´Ð¾Ð±ÑÑ‚Ð²Ð° Ð½Ð¾Ð¼ÐµÑ€Ð° Ð¸ Ð¾Ñ‚ÐµÐ»Ñ\nâ€¢ Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð·Ð°ÐµÐ·Ð´Ð° Ð¸ Ð²Ñ‹ÐµÐ·Ð´Ð°\nâ€¢ Ð›ÑŽÐ±Ñ‹Ðµ Ð¾ÑÐ¾Ð±Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹\n\nÐ§ÐµÐ¼ Ñ Ð¼Ð¾Ð³Ñƒ Ð²Ð°Ð¼ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ?`;
      }
      // Chinese detection
      else if (/[\u4E00-\u9FFF]/.test(message)) {
        greetingResponse = `æ¬¢è¿Žæ¥åˆ°${hotelName}ï¼æˆ‘æ˜¯${chatbotName}ï¼Œæ‚¨çš„ç§äººåŠ©ç†ã€‚\n\næˆ‘å¯ä»¥å¸®åŠ©æ‚¨ï¼š\nâ€¢ é¤åŽ…é¢„è®¢å’Œä¿¡æ¯\nâ€¢ æ°´ç–—å’Œå¥åº·æœåŠ¡\nâ€¢ æ´»åŠ¨å’Œæ¸¸è§ˆ\nâ€¢ æˆ¿é—´è®¾æ–½å’Œè®¾å¤‡\nâ€¢ å…¥ä½å’Œé€€æˆ¿\nâ€¢ ä»»ä½•ç‰¹æ®Šè¦æ±‚\n\næˆ‘èƒ½ä¸ºæ‚¨åšäº›ä»€ä¹ˆï¼Ÿ`;
      }
      // Italian detection
      else if (messageLower.includes('ciao') || messageLower.includes('buon')) {
        greetingResponse = `Benvenuto a ${hotelName}! Sono ${chatbotName}, il tuo assistente personale.\n\nSono qui per aiutarti con:\nâ€¢ Prenotazioni ristoranti e informazioni\nâ€¢ Servizi spa e benessere\nâ€¢ AttivitÃ  ed escursioni\nâ€¢ Comfort della camera e strutture\nâ€¢ Check-in e check-out\nâ€¢ Qualsiasi richiesta speciale\n\nCome posso servirti?`;
      }
      // Default: English
      else {
        greetingResponse = `Welcome to ${hotelName}! I'm ${chatbotName}, your personal concierge assistant. It's my pleasure to assist you today.\n\nI'm here to help with:\nâ€¢ Dining reservations and restaurant information\nâ€¢ Spa and wellness services\nâ€¢ Activities and excursions\nâ€¢ Room amenities and facilities\nâ€¢ Check-in/check-out assistance\nâ€¢ Any special requests\n\nHow may I be of service?`;
      }
      
      await DB.prepare(`
        INSERT INTO chatbot_messages (conversation_id, role, content, chunks_used)
        VALUES (?, 'assistant', ?, ?)
      `).bind(convId, greetingResponse, '[]').run()
      
      return c.json({ 
        success: true,
        response: greetingResponse,
        conversation_id: convId,
        chunks_used: 0
      })
    }
    
    // ðŸ“ FEEDBACK INTENT DETECTION
    const feedbackKeywords = ['feedback', 'review', 'survey', 'complaint', 'complain', 'suggestion', 'improve', 'opinion', 'rate', 'rating'];
    const messageLowerForFeedback = message.toLowerCase();
    const isFeedbackIntent = feedbackKeywords.some(keyword => messageLowerForFeedback.includes(keyword));
    
    if (isFeedbackIntent) {
      // Check if there are active feedback forms
      const activeForms = await DB.prepare(`
        SELECT form_id, form_name, form_type
        FROM feedback_forms
        WHERE property_id = ? AND is_active = 1
        ORDER BY created_at DESC
        LIMIT 1
      `).bind(property_id).all()
      
      if (activeForms.results && activeForms.results.length > 0) {
        const form = activeForms.results[0]
        const formUrl = '/feedback/' + form.form_id
        
        // Multi-language feedback invitation - Default to English
        const feedbackResponse = 'Thank you for wanting to share your feedback with us!' + String.fromCharCode(10) + String.fromCharCode(10) + 'We would love to hear from you. You can [submit your feedback here](' + formUrl + ') - it will only take a few minutes.' + String.fromCharCode(10) + String.fromCharCode(10) + 'Is there anything else I can help you with?';
        
        await DB.prepare('INSERT INTO chatbot_messages (conversation_id, role, content, chunks_used) VALUES (?, ?, ?, ?)').bind(convId, 'assistant', feedbackResponse, '[]').run()
        
        return c.json({ 
          success: true,
          response: feedbackResponse,
          conversation_id: convId,
          chunks_used: 0
        })
      }
    }
    
    // RAG: Find relevant chunks
    const allChunks = await DB.prepare(`
      SELECT chunk_id, chunk_text, document_id
      FROM chatbot_chunks
      WHERE property_id = ?
    `).bind(property_id).all()
    
    // Score and rank chunks
    const scoredChunks = (allChunks.results || []).map((chunk: any) => ({
      ...chunk,
      score: calculateRelevanceScore(message, chunk.chunk_text)
    })).filter((chunk: any) => chunk.score > 0)
      .sort((a: any, b: any) => b.score - a.score)
      .slice(0, 3) // Top 3 most relevant chunks
    
    // Build context from chunks
    const context = scoredChunks.map((chunk: any) => chunk.chunk_text).join('\n\n')
    const chunkIds = scoredChunks.map((chunk: any) => chunk.chunk_id)
    
    // ðŸ”— SMART LINK SEARCH: Find relevant activities, restaurants, spa, events
    const messageLowerCase = message.toLowerCase()
    const relevantLinks: any[] = []
    
    // Search keywords from user message
    const searchTerms = messageLowerCase.split(/\s+/).filter(w => w.length > 3)
    
    try {
      // Search Activities
      const activities = await DB.prepare(`
        SELECT activity_id, title_en, short_description_en, vendor_id
        FROM activities a
        JOIN vendor_properties vp ON a.vendor_id = vp.vendor_id
        WHERE vp.property_id = ? AND a.status = 'active' AND vp.status = 'active'
        LIMIT 50
      `).bind(property_id).all()
      
      for (const activity of (activities.results || [])) {
        const titleLower = activity.title_en.toLowerCase()
        const descLower = (activity.short_description_en || '').toLowerCase()
        const matchScore = searchTerms.filter(term => 
          titleLower.includes(term) || descLower.includes(term)
        ).length
        
        if (matchScore > 0) {
          relevantLinks.push({
            type: 'activity',
            id: activity.activity_id,
            title: activity.title_en,
            url: `/activity?id=${activity.activity_id}&property=${property_id}&lang=en`,
            score: matchScore
          })
        }
      }
      
      // Search Hotel Offerings (Restaurants, Spa, Events)
      const offerings = await DB.prepare(`
        SELECT offering_id, title_en, short_description_en, offering_type
        FROM hotel_offerings
        WHERE property_id = ? AND status = 'active'
        LIMIT 50
      `).bind(property_id).all()
      
      for (const offering of (offerings.results || [])) {
        const titleLower = offering.title_en.toLowerCase()
        const descLower = (offering.short_description_en || '').toLowerCase()
        const matchScore = searchTerms.filter(term => 
          titleLower.includes(term) || descLower.includes(term)
        ).length
        
        if (matchScore > 0) {
          relevantLinks.push({
            type: offering.offering_type,
            id: offering.offering_id,
            title: offering.title_en,
            url: `/offering?id=${offering.offering_id}&property=${property_id}&lang=en`,
            score: matchScore
          })
        }
      }
    } catch (linkError) {
      console.error('Link search error:', linkError)
    }
    
    // Sort by relevance and take top 3
    relevantLinks.sort((a, b) => b.score - a.score)
    const topLinks = relevantLinks.slice(0, 3)
    
    // Build link context for AI
    let linkContext = ''
    if (topLinks.length > 0) {
      linkContext = '\n\nðŸ“Ž RELEVANT LINKS (Include these in your response):\n'
      topLinks.forEach(link => {
        linkContext += `- ${link.title}: ${link.url}\n`
      })
    }
    
    // Generate AI response - use Cloudflare env bindings
    const apiKey = c.env.OPENAI_API_KEY
    const baseURL = c.env.OPENAI_BASE_URL || 'https://www.genspark.ai/api/llm_proxy/v1'
    
    let aiResponse = 'I apologize, but I am unable to answer your question at the moment. Please contact the hotel staff for assistance.'
    
    if (apiKey && context.length > 0) {
      try {
        console.log('ðŸ¤– Using AI with API key:', apiKey ? 'SET' : 'NOT SET')
        console.log('ðŸ“š Context length:', context.length)
        console.log('ðŸ“ Context preview:', context.substring(0, 200))
        
        const systemPrompt = `You are ${chatbotName}, the personal concierge assistant for ${hotelName}, a 5-star luxury resort. Your role is to provide impeccable, professional service with warmth and sophistication.

CRITICAL: You MUST respond in the SAME LANGUAGE as the guest's question. If they ask in Arabic, respond in Arabic. If French, respond in French. If Spanish, respond in Spanish. This is ESSENTIAL for international guests.

Guest's Question: "${message}"

Relevant Hotel Information (English):
${context}${linkContext}

Instructions:
1. **Language Matching**: ALWAYS respond in the SAME language as the guest's question. Translate your response accordingly.
2. **Tone**: Professional yet warm, like a luxury hotel concierge. Use phrases appropriate to the language (e.g., "Ø¨ÙƒÙ„ Ø³Ø±ÙˆØ±" in Arabic, "Avec plaisir" in French, "Con mucho gusto" in Spanish)
3. **Accuracy**: Use ONLY the information provided above. Translate and adapt the information naturally.
4. **Specifics**: Include prices, times, locations, booking details when mentioned (keep numbers/times as-is)
5. **Brevity**: Keep responses concise (2-3 sentences) but complete
6. **LINKS**: If relevant links are provided above, ALWAYS include them in your response using this EXACT format: [Link Text](URL). For example: "You can [view our diving activities here](/activity?id=7&property=1&lang=en)."
7. **Referrals**: If information is NOT in the context above, politely refer to hotel staff IN THE GUEST'S LANGUAGE
8. **Complaints/Issues**: If guest mentions a problem or complaint, acknowledge it professionally and assure them management will be notified. If they mention their room number or last name, acknowledge it gracefully.
9. **Never** say "I don't have that information" - always be gracious

Provide your response now IN THE SAME LANGUAGE as the guest's question:`
        
        const response = await fetch(`${baseURL}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini', // OpenAI's fastest, cheapest model
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: message }
            ],
            temperature: 0.7,
            max_tokens: 300
          })
        })
        
        console.log('ðŸ”¥ API Response status:', response.status)
        
        if (response.ok) {
          const data = await response.json()
          console.log('âœ… AI Response received:', data.choices[0].message.content.substring(0, 100))
          aiResponse = data.choices[0].message.content
        } else {
          const errorText = await response.text()
          console.error('âŒ API Error:', response.status, errorText)
          // API failed, use fallback
          aiResponse = null // Will trigger fallback below
        }
      } catch (error) {
        console.error('ðŸ’¥ AI chat error:', error)
        // API error, use fallback
        aiResponse = null
      }
    }
    
    // Smart fallback if API didn't work or no API key
    if (!aiResponse && context.length > 0) {
      // Fallback: Intelligent text summarization without AI API
      const messageLower = message.toLowerCase()
      
      // Remove duplicate sentences and clean up text
      // More aggressive normalization to catch duplicates
      const sentences = context.split(/[.!?\n]+/).filter(s => s.trim().length > 10)
      const uniqueSentences = []
      const seen = new Set()
      
      for (const sentence of sentences) {
        // Normalize: lowercase, remove extra spaces, remove common filler words
        const normalized = sentence.trim().toLowerCase()
          .replace(/\s+/g, ' ')
          .replace(/^(the|a|an|our|at)\s+/i, '') // Remove common leading articles
          
        // Check for near-duplicate (>80% similarity for short text)
        let isDuplicate = false
        for (const existing of seen) {
          // Simple contains check for obvious duplicates
          if (normalized.includes(existing) || existing.includes(normalized)) {
            isDuplicate = true
            break
          }
        }
        
        if (!isDuplicate && !seen.has(normalized)) {
          seen.add(normalized)
          uniqueSentences.push(sentence.trim())
        }
      }
      
      // Score sentences by keyword relevance
      const keywords = messageLower.split(/\s+/).filter(w => w.length > 3)
      const scoredSentences = uniqueSentences.map(sentence => {
        const sentenceLower = sentence.toLowerCase()
        let score = 0
        for (const keyword of keywords) {
          if (sentenceLower.includes(keyword)) {
            score += 2
          }
        }
        // Prefer sentences with specific details (prices, times, locations)
        if (/\d+/.test(sentence)) score += 1
        if (/location:|price:|time:|duration:/i.test(sentence)) score += 1
        return { sentence, score }
      })
      
      // Sort by relevance and take top 3-5 sentences
      scoredSentences.sort((a, b) => b.score - a.score)
      const topSentences = scoredSentences.slice(0, Math.min(5, scoredSentences.length))
      const summary = topSentences.map(s => s.sentence).join('. ')
      
      // Format response based on question type
      let prefix = ''
      if (messageLower.includes('tell me about') || messageLower.includes('what is') || messageLower.includes('describe')) {
        prefix = 'Here\'s what I found:\n\n'
      } else if (messageLower.includes('do you have') || messageLower.includes('is there')) {
        prefix = 'Yes, we have this available:\n\n'
      } else {
        prefix = 'Based on our hotel information:\n\n'
      }
      
      aiResponse = prefix + summary + '.\n\nðŸ’¡ Tip: For booking or detailed questions, please contact our front desk.'
    } else if (!aiResponse && context.length === 0) {
      // No relevant chunks found
      aiResponse = `Thank you for your inquiry. While I don't have specific information about that particular topic in my current knowledge base, our dedicated team at ${hotelName} would be delighted to assist you personally.\n\nI can help you with:\nâ€¢ Dining reservations and menus\nâ€¢ Spa treatments and wellness services\nâ€¢ Activities and excursions\nâ€¢ Room amenities\nâ€¢ Check-in/check-out procedures\n\nWould you like to know about any of these services, or shall I connect you with our front desk?`;
    } else if (!aiResponse) {
      // Final fallback
      aiResponse = `I appreciate your patience. For the most accurate and detailed information regarding your inquiry, I'd recommend speaking directly with our guest services team at ${hotelName}. They'll be able to provide you with comprehensive assistance. How else may I help you today?`;
    }
    
    // ðŸ¤– AI SENTIMENT ANALYSIS - Detect complaints/feedback BEFORE storing response
    const feedbackAnalysis = await analyzeSentimentAndCaptureFeedback(DB, property_id, convId, message, aiResponse, apiKey, baseURL)
    
    // If complaint detected but missing guest info, REQUIRE it before continuing
    if (feedbackAnalysis.needsGuestInfo) {
      // Detect language from original complaint message
      const lang = detectLanguage(message)
      let missingInfoPrompt = ""
      
      // Multilingual templates
      const templates: any = {
        en: {
          header1: "ðŸš¨ **I need your information to log your complaint with management.**\n\n**I cannot process any other requests until you provide:**\n\n",
          header2: "âš ï¸ **I've noted your concern and our management team needs to address this immediately.**\n\n**To log your complaint officially, I need:**\n\n",
          lastName: "ðŸ‘¤ Your **last name** (surname)\n",
          roomNumber: "ðŸ¨ Your **room number**\n",
          both: "1ï¸âƒ£ Your **last name** (surname)\n2ï¸âƒ£ Your **room number**\n\n",
          example: "ðŸ“‹ **Please respond with BOTH** (Example: My last name is Smith and I'm in room 305)\n\n",
          urgent: "â±ï¸ **URGENT**: This will be escalated to management immediately once I have your information.",
          normal: "âœ… Once provided, your complaint will be logged and staff will contact you within 15 minutes."
        },
        ar: {
          header1: "ðŸš¨ **Ø£Ø­ØªØ§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ù„ØªØ³Ø¬ÙŠÙ„ Ø´ÙƒÙˆØ§Ùƒ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.**\n\n**Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø£Ø®Ø±Ù‰ Ø­ØªÙ‰ ØªÙ‚Ø¯Ù…:**\n\n",
          header2: "âš ï¸ **Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª Ø´ÙƒÙˆØ§Ùƒ ÙˆØ¥Ø¯Ø§Ø±ØªÙ†Ø§ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ ÙÙˆØ±Ø§Ù‹.**\n\n**Ù„ØªØ³Ø¬ÙŠÙ„ Ø´ÙƒÙˆØ§Ùƒ Ø±Ø³Ù…ÙŠØ§Ù‹ØŒ Ø£Ø­ØªØ§Ø¬:**\n\n",
          lastName: "ðŸ‘¤ **Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©**\n",
          roomNumber: "ðŸ¨ **Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©**\n",
          both: "1ï¸âƒ£ **Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©**\n2ï¸âƒ£ **Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©**\n\n",
          example: "ðŸ“‹ **ÙŠØ±Ø¬Ù‰ ØªÙ‚Ø¯ÙŠÙ… ÙƒÙ„ÙŠÙ‡Ù…Ø§** (Ù…Ø«Ø§Ù„: Ø§Ø³Ù…ÙŠ Ø³Ù…ÙŠØ« ÙˆØ£Ù†Ø§ ÙÙŠ Ø§Ù„ØºØ±ÙØ© 305)\n\n",
          urgent: "â±ï¸ **Ø¹Ø§Ø¬Ù„**: Ø³ÙŠØªÙ… Ø¥Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ù…Ø¬Ø±Ø¯ Ø­ØµÙˆÙ„ÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ.",
          normal: "âœ… Ø¨Ù…Ø¬Ø±Ø¯ ØªÙ‚Ø¯ÙŠÙ…Ù‡Ø§ØŒ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø´ÙƒÙˆØ§Ùƒ ÙˆØ³ÙŠØªØµÙ„ Ø¨Ùƒ Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø©."
        },
        fr: {
          header1: "ðŸš¨ **J'ai besoin de vos informations pour enregistrer votre plainte auprÃ¨s de la direction.**\n\n**Je ne peux traiter d'autres demandes avant que vous ne fournissiez:**\n\n",
          header2: "âš ï¸ **J'ai notÃ© votre prÃ©occupation et notre direction doit y rÃ©pondre immÃ©diatement.**\n\n**Pour enregistrer officiellement votre plainte, j'ai besoin de:**\n\n",
          lastName: "ðŸ‘¤ Votre **nom de famille**\n",
          roomNumber: "ðŸ¨ Votre **numÃ©ro de chambre**\n",
          both: "1ï¸âƒ£ Votre **nom de famille**\n2ï¸âƒ£ Votre **numÃ©ro de chambre**\n\n",
          example: "ðŸ“‹ **Veuillez fournir les DEUX** (Exemple: Mon nom est Smith et je suis dans la chambre 305)\n\n",
          urgent: "â±ï¸ **URGENT**: Cela sera transmis Ã  la direction immÃ©diatement une fois vos informations reÃ§ues.",
          normal: "âœ… Une fois fournis, votre plainte sera enregistrÃ©e et le personnel vous contactera dans 15 minutes."
        },
        es: {
          header1: "ðŸš¨ **Necesito su informaciÃ³n para registrar su queja con la gerencia.**\n\n**No puedo procesar otras solicitudes hasta que proporcione:**\n\n",
          header2: "âš ï¸ **He notado su preocupaciÃ³n y nuestra gerencia necesita atenderla inmediatamente.**\n\n**Para registrar su queja oficialmente, necesito:**\n\n",
          lastName: "ðŸ‘¤ Su **apellido**\n",
          roomNumber: "ðŸ¨ Su **nÃºmero de habitaciÃ³n**\n",
          both: "1ï¸âƒ£ Su **apellido**\n2ï¸âƒ£ Su **nÃºmero de habitaciÃ³n**\n\n",
          example: "ðŸ“‹ **Por favor proporcione AMBOS** (Ejemplo: Mi apellido es Smith y estoy en la habitaciÃ³n 305)\n\n",
          urgent: "â±ï¸ **URGENTE**: Esto se escalarÃ¡ a la gerencia inmediatamente una vez que tenga su informaciÃ³n.",
          normal: "âœ… Una vez proporcionada, su queja serÃ¡ registrada y el personal lo contactarÃ¡ en 15 minutos."
        },
        de: {
          header1: "ðŸš¨ **Ich benÃ¶tige Ihre Informationen, um Ihre Beschwerde bei der GeschÃ¤ftsleitung einzureichen.**\n\n**Ich kann keine anderen Anfragen bearbeiten, bis Sie Folgendes angeben:**\n\n",
          header2: "âš ï¸ **Ich habe Ihre Beschwerde notiert und unsere GeschÃ¤ftsleitung muss sich sofort darum kÃ¼mmern.**\n\n**Um Ihre Beschwerde offiziell zu registrieren, benÃ¶tige ich:**\n\n",
          lastName: "ðŸ‘¤ Ihren **Nachnamen**\n",
          roomNumber: "ðŸ¨ Ihre **Zimmernummer**\n",
          both: "1ï¸âƒ£ Ihren **Nachnamen**\n2ï¸âƒ£ Ihre **Zimmernummer**\n\n",
          example: "ðŸ“‹ **Bitte geben Sie BEIDES an** (Beispiel: Mein Name ist Schmidt und ich bin in Zimmer 305)\n\n",
          urgent: "â±ï¸ **DRINGEND**: Dies wird sofort an die GeschÃ¤ftsleitung weitergeleitet, sobald ich Ihre Informationen habe.",
          normal: "âœ… Sobald angegeben, wird Ihre Beschwerde registriert und das Personal kontaktiert Sie innerhalb von 15 Minuten."
        }
      }
      
      const t = templates[lang] || templates.en
      
      // First time asking vs. still waiting for info
      if (feedbackAnalysis.hasPendingComplaint) {
        missingInfoPrompt = t.header1
      } else {
        missingInfoPrompt = t.header2
      }
      
      if (!feedbackAnalysis.hasRoomNumber && !feedbackAnalysis.hasLastName) {
        missingInfoPrompt += t.both + t.example
      } else if (!feedbackAnalysis.hasRoomNumber) {
        missingInfoPrompt += t.roomNumber + "\n" + t.example
      } else if (!feedbackAnalysis.hasLastName) {
        missingInfoPrompt += t.lastName + "\n" + t.example
      }
      
      if (feedbackAnalysis.isUrgent) {
        missingInfoPrompt += t.urgent
      } else {
        missingInfoPrompt += t.normal
      }
      
      // COMPLETELY OVERRIDE AI response - don't answer their question until we have info
      aiResponse = missingInfoPrompt
    } else if (feedbackAnalysis.feedbackSaved && feedbackAnalysis.complaintUpdated) {
      // Guest just provided the missing info - confirm complaint is now logged
      const lang = detectLanguage(message)
      const confirmations: any = {
        en: "âœ… **Thank you! Your complaint has been officially logged.**\n\nðŸ“‹ **Complaint Details:**\nâ€¢ Category: {category}\nâ€¢ Status: Logged with management\nâ€¢ Response Time: Within 15 minutes\n\nOur management team will contact you shortly to resolve this issue.\n\nIs there anything else I can help you with in the meantime?",
        ar: "âœ… **Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø´ÙƒÙˆØ§Ùƒ Ø±Ø³Ù…ÙŠØ§Ù‹.**\n\nðŸ“‹ **ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰:**\nâ€¢ Ø§Ù„ÙØ¦Ø©: {category}\nâ€¢ Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ø³Ø¬Ù„Ø© Ù„Ø¯Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\nâ€¢ ÙˆÙ‚Øª Ø§Ù„Ø±Ø¯: Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø©\n\nØ³ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ø­Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©.\n\nÙ‡Ù„ Ù‡Ù†Ø§Ùƒ Ø£ÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø± ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¨Ù‡ØŸ",
        fr: "âœ… **Merci! Votre plainte a Ã©tÃ© officiellement enregistrÃ©e.**\n\nðŸ“‹ **DÃ©tails de la plainte:**\nâ€¢ CatÃ©gorie: {category}\nâ€¢ Statut: EnregistrÃ© auprÃ¨s de la direction\nâ€¢ Temps de rÃ©ponse: Dans 15 minutes\n\nNotre Ã©quipe de direction vous contactera sous peu pour rÃ©soudre ce problÃ¨me.\n\nPuis-je vous aider avec autre chose?",
        es: "âœ… **Â¡Gracias! Su queja ha sido registrada oficialmente.**\n\nðŸ“‹ **Detalles de la queja:**\nâ€¢ CategorÃ­a: {category}\nâ€¢ Estado: Registrada con la gerencia\nâ€¢ Tiempo de respuesta: Dentro de 15 minutos\n\nNuestro equipo de gerencia se pondrÃ¡ en contacto con usted en breve para resolver este problema.\n\nÂ¿Hay algo mÃ¡s en lo que pueda ayudarlo?",
        de: "âœ… **Vielen Dank! Ihre Beschwerde wurde offiziell registriert.**\n\nðŸ“‹ **Beschwerdedetails:**\nâ€¢ Kategorie: {category}\nâ€¢ Status: Bei der GeschÃ¤ftsleitung registriert\nâ€¢ Antwortzeit: Innerhalb von 15 Minuten\n\nUnser Management-Team wird Sie in KÃ¼rze kontaktieren, um dieses Problem zu lÃ¶sen.\n\nKann ich Ihnen noch bei etwas anderem helfen?"
      }
      
      aiResponse = (confirmations[lang] || confirmations.en).replace('{category}', feedbackAnalysis.complaintCategory || 'General')
    }
    
    // Store AI response (potentially modified with guest info request)
    await DB.prepare(`
      INSERT INTO chatbot_messages (conversation_id, role, content, chunks_used)
      VALUES (?, 'assistant', ?, ?)
    `).bind(convId, aiResponse, JSON.stringify(chunkIds)).run()
    
    // Update rate limit
    if (rateLimit) {
      await DB.prepare(`
        UPDATE chatbot_rate_limits 
        SET message_count = message_count + 1
        WHERE property_id = ? AND session_id = ? AND reset_date = ?
      `).bind(property_id, session_id, today).run()
    } else {
      await DB.prepare(`
        INSERT INTO chatbot_rate_limits (property_id, session_id, message_count, reset_date)
        VALUES (?, ?, 1, ?)
      `).bind(property_id, session_id, today).run()
    }
    
    // Track chunk usage (simplified - just insert)
    for (const chunkId of chunkIds) {
      try {
        await DB.prepare(`
          INSERT INTO chatbot_chunk_usage (chunk_id, property_id, times_retrieved, last_used)
          VALUES (?, ?, 1, CURRENT_TIMESTAMP)
        `).bind(chunkId, property_id).run()
      } catch {
        // Ignore duplicate errors for now
      }
    }
    
    return c.json({ 
      success: true,
      response: aiResponse,
      conversation_id: convId,
      chunks_used: chunkIds.length
    })
    
  } catch (error) {
    console.error('Chatbot error:', error)
    return c.json({ error: 'Failed to process message' }, 500)
  }
})

// API: Get chatbot settings
app.get('/api/chatbot/settings/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const settings = await DB.prepare(`
      SELECT chatbot_enabled, chatbot_greeting_en, chatbot_name, chatbot_avatar_url, chatbot_primary_color
      FROM properties
      WHERE property_id = ?
    `).bind(property_id).first()
    
    return c.json({ success: true, settings })
  } catch (error) {
    console.error('Get chatbot settings error:', error)
    return c.json({ error: 'Failed to get settings' }, 500)
  }
})

// API: Update chatbot settings
app.post('/api/admin/chatbot/settings', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const { property_id, chatbot_enabled, chatbot_greeting_en, chatbot_name, chatbot_avatar_url, chatbot_primary_color } = body
    
    // Handle undefined/null values - D1 doesn't accept undefined
    const enabled = chatbot_enabled ? 1 : 0
    const greeting = chatbot_greeting_en || null
    const name = chatbot_name || null
    const avatar = chatbot_avatar_url || null
    const color = chatbot_primary_color || null
    
    await DB.prepare(`
      UPDATE properties
      SET chatbot_enabled = ?, chatbot_greeting_en = ?, chatbot_name = ?, chatbot_avatar_url = ?, chatbot_primary_color = ?
      WHERE property_id = ?
    `).bind(enabled, greeting, name, avatar, color, property_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update chatbot settings error:', error)
    return c.json({ error: 'Failed to update settings', details: error.message }, 500)
  }
})

// API: Auto-sync hotel data into chatbot knowledge base
app.post('/api/admin/chatbot/sync-knowledge', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const { property_id } = body
    
    let totalDocuments = 0
    let totalChunks = 0
    
    // 1. Sync all hotel offerings (restaurants, spa, events)
    const offerings = await DB.prepare(`
      SELECT offering_id, offering_type, title_en, short_description_en, full_description_en,
             location, cuisine_type, meal_type, price, duration_minutes, includes
      FROM hotel_offerings
      WHERE property_id = ? AND status = 'active'
    `).bind(property_id).all()
    
    for (const offering of offerings.results) {
      // Build document content
      let content = `${offering.title_en}\n\n`
      content += offering.short_description_en ? offering.short_description_en + '\n\n' : ''
      content += offering.full_description_en ? offering.full_description_en + '\n\n' : ''
      if (offering.location) content += `Location: ${offering.location}\n`
      if (offering.cuisine_type) content += `Cuisine: ${offering.cuisine_type}\n`
      if (offering.meal_type) content += `Meal Type: ${offering.meal_type}\n`
      if (offering.price) content += `Price: ${offering.price} USD\n`
      if (offering.duration_minutes) content += `Duration: ${offering.duration_minutes} minutes\n`
      if (offering.includes) content += `Includes: ${offering.includes}\n`
      
      // Check if document already exists
      const existing = await DB.prepare(`
        SELECT document_id FROM chatbot_documents
        WHERE property_id = ? AND document_type = ? AND title = ?
      `).bind(property_id, offering.offering_type, offering.title_en).first()
      
      let documentId = existing?.document_id
      
      if (!documentId) {
        // Insert new document
        const result = await DB.prepare(`
          INSERT INTO chatbot_documents (property_id, title, content, document_type, created_at)
          VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
        `).bind(property_id, offering.title_en, content, offering.offering_type).run()
        
        documentId = result.meta.last_row_id
        totalDocuments++
      } else {
        // Update existing document
        await DB.prepare(`
          UPDATE chatbot_documents
          SET content = ?, updated_at = CURRENT_TIMESTAMP
          WHERE document_id = ?
        `).bind(content, documentId).run()
        
        // Delete old chunks
        await DB.prepare(`DELETE FROM chatbot_chunks WHERE document_id = ?`).bind(documentId).run()
      }
      
      // Create chunks
      const chunks = chunkText(content, 500)
      for (let i = 0; i < chunks.length; i++) {
        await DB.prepare(`
          INSERT INTO chatbot_chunks (document_id, property_id, chunk_text, chunk_index, embedding_text, token_count)
          VALUES (?, ?, ?, ?, ?, ?)
        `).bind(documentId, property_id, chunks[i], i, chunks[i], chunks[i].split(/\s+/).length).run()
        totalChunks++
      }
    }
    
    // 2. Sync all activities
    const activities = await DB.prepare(`
      SELECT a.activity_id, a.title_en, a.short_description_en, a.full_description_en,
             a.duration_minutes, a.price, a.currency, a.requirements, a.includes,
             c.name_en as category_name
      FROM activities a
      JOIN vendors v ON a.vendor_id = v.vendor_id
      JOIN vendor_properties vp ON v.vendor_id = vp.vendor_id
      JOIN categories c ON a.category_id = c.category_id
      WHERE vp.property_id = ? AND a.status = 'active'
    `).bind(property_id).all()
    
    for (const activity of activities.results) {
      let content = `${activity.title_en}\n\n`
      content += `Category: ${activity.category_name}\n\n`
      content += activity.short_description_en ? activity.short_description_en + '\n\n' : ''
      content += activity.full_description_en ? activity.full_description_en + '\n\n' : ''
      content += `Duration: ${activity.duration_minutes} minutes\n`
      content += `Price: ${activity.price} ${activity.currency}\n`
      if (activity.requirements) content += `Requirements: ${activity.requirements}\n`
      if (activity.includes) content += `Includes: ${activity.includes}\n`
      
      const existing = await DB.prepare(`
        SELECT document_id FROM chatbot_documents
        WHERE property_id = ? AND document_type = 'activity' AND title = ?
      `).bind(property_id, activity.title_en).first()
      
      let documentId = existing?.document_id
      
      if (!documentId) {
        const result = await DB.prepare(`
          INSERT INTO chatbot_documents (property_id, title, content, document_type, created_at)
          VALUES (?, ?, ?, 'activity', CURRENT_TIMESTAMP)
        `).bind(property_id, activity.title_en, content).run()
        
        documentId = result.meta.last_row_id
        totalDocuments++
      } else {
        await DB.prepare(`
          UPDATE chatbot_documents
          SET content = ?, updated_at = CURRENT_TIMESTAMP
          WHERE document_id = ?
        `).bind(content, documentId).run()
        
        await DB.prepare(`DELETE FROM chatbot_chunks WHERE document_id = ?`).bind(documentId).run()
      }
      
      const chunks = chunkText(content, 500)
      for (let i = 0; i < chunks.length; i++) {
        await DB.prepare(`
          INSERT INTO chatbot_chunks (document_id, property_id, chunk_text, chunk_index, embedding_text, token_count)
          VALUES (?, ?, ?, ?, ?, ?)
        `).bind(documentId, property_id, chunks[i], i, chunks[i], chunks[i].split(/\s+/).length).run()
        totalChunks++
      }
    }
    
    // 3. Sync all info pages
    const infoPages = await DB.prepare(`
      SELECT page_id, page_key, title_en, content_en, icon_class, color_theme
      FROM info_pages
      WHERE property_id = ? AND is_published = 1
    `).bind(property_id).all()
    
    for (const page of infoPages.results) {
      // Strip HTML tags from content for better text search, preserving structure
      const stripHtml = (html) => {
        if (!html) return ''
        return html
          .replace(/<style[^>]*>.*?<\/style>/gi, '')
          .replace(/<script[^>]*>.*?<\/script>/gi, '')
          .replace(/<\/h[1-6]>/gi, '\n\n')  // Headings end with double newline
          .replace(/<h[1-6][^>]*>/gi, '\n')  // Headings start with newline
          .replace(/<\/p>/gi, '\n')  // Paragraphs end with newline
          .replace(/<br\s*\/?>/gi, '\n')  // Line breaks
          .replace(/<\/li>/gi, '\n')  // List items end with newline
          .replace(/<[^>]+>/g, ' ')  // Remove remaining tags
          .replace(/\n\s*\n\s*\n/g, '\n\n')  // Max double newlines
          .replace(/[ \t]+/g, ' ')  // Collapse spaces
          .trim()
      }
      
      let content = `${page.title_en}\n\n`
      content += stripHtml(page.content_en || '')
      
      const existing = await DB.prepare(`
        SELECT document_id FROM chatbot_documents
        WHERE property_id = ? AND document_type = 'info_page' AND title = ?
      `).bind(property_id, page.title_en).first()
      
      let documentId = existing?.document_id
      
      if (!documentId) {
        const result = await DB.prepare(`
          INSERT INTO chatbot_documents (property_id, title, content, document_type, created_at)
          VALUES (?, ?, ?, 'info_page', CURRENT_TIMESTAMP)
        `).bind(property_id, page.title_en, content).run()
        
        documentId = result.meta.last_row_id
        totalDocuments++
      } else {
        await DB.prepare(`
          UPDATE chatbot_documents
          SET content = ?, updated_at = CURRENT_TIMESTAMP
          WHERE document_id = ?
        `).bind(content, documentId).run()
        
        await DB.prepare(`DELETE FROM chatbot_chunks WHERE document_id = ?`).bind(documentId).run()
      }
      
      const chunks = chunkText(content, 500)
      for (let i = 0; i < chunks.length; i++) {
        await DB.prepare(`
          INSERT INTO chatbot_chunks (document_id, property_id, chunk_text, chunk_index, embedding_text, token_count)
          VALUES (?, ?, ?, ?, ?, ?)
        `).bind(documentId, property_id, chunks[i], i, chunks[i], chunks[i].split(/\s+/).length).run()
        totalChunks++
      }
    }
    
    return c.json({ 
      success: true, 
      total_documents: totalDocuments,
      total_chunks: totalChunks,
      message: `Successfully synced ${totalDocuments} new documents with ${totalChunks} searchable chunks`
    })
    
  } catch (error) {
    console.error('Sync knowledge base error:', error)
    return c.json({ error: 'Failed to sync knowledge base', details: error.message }, 500)
  }
})

// API: Get chatbot analytics stats
app.get('/api/admin/chatbot/analytics/stats', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  
  try {
    // Total conversations
    const totalConversations = await DB.prepare(`
      SELECT COUNT(*) as count FROM chatbot_conversations WHERE property_id = ?
    `).bind(property_id).first()
    
    // Total messages
    const totalMessages = await DB.prepare(`
      SELECT COUNT(*) as count FROM chatbot_messages m
      JOIN chatbot_conversations c ON m.conversation_id = c.conversation_id
      WHERE c.property_id = ? AND m.role = 'user'
    `).bind(property_id).first()
    
    // Today's chats
    const today = new Date().toISOString().split('T')[0]
    const todayChats = await DB.prepare(`
      SELECT COUNT(*) as count FROM chatbot_conversations
      WHERE property_id = ? AND DATE(started_at) = ?
    `).bind(property_id, today).first()
    
    // Average response time (placeholder - would need timestamps)
    const avgResponseTime = 1.2
    
    return c.json({
      success: true,
      stats: {
        total_conversations: totalConversations?.count || 0,
        total_messages: totalMessages?.count || 0,
        today_chats: todayChats?.count || 0,
        avg_response_time: avgResponseTime
      }
    })
  } catch (error) {
    console.error('Get analytics stats error:', error)
    return c.json({ error: 'Failed to get analytics stats' }, 500)
  }
})

// API: Get top asked questions
app.get('/api/admin/chatbot/analytics/top-questions', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  const limit = parseInt(c.req.query('limit') || '10')
  
  try {
    const topQuestions = await DB.prepare(`
      SELECT m.content as question, COUNT(*) as count
      FROM chatbot_messages m
      JOIN chatbot_conversations c ON m.conversation_id = c.conversation_id
      WHERE c.property_id = ? AND m.role = 'user'
      GROUP BY m.content
      ORDER BY count DESC
      LIMIT ?
    `).bind(property_id, limit).all()
    
    return c.json({
      success: true,
      questions: topQuestions.results || []
    })
  } catch (error) {
    console.error('Get top questions error:', error)
    return c.json({ error: 'Failed to get top questions' }, 500)
  }
})

// API: Get chat history
app.get('/api/admin/chatbot/analytics/chat-history', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  const date = c.req.query('date')
  const search = c.req.query('search')
  
  try {
    let query = `
      SELECT 
        c.conversation_id,
        c.session_id,
        c.started_at as created_at,
        (SELECT content FROM chatbot_messages WHERE conversation_id = c.conversation_id AND role = 'user' ORDER BY created_at ASC LIMIT 1) as user_message,
        (SELECT content FROM chatbot_messages WHERE conversation_id = c.conversation_id AND role = 'assistant' ORDER BY created_at ASC LIMIT 1) as ai_message,
        (SELECT COUNT(*) FROM chatbot_messages WHERE conversation_id = c.conversation_id) as message_count
      FROM chatbot_conversations c
      WHERE c.property_id = ?
    `
    
    const params = [property_id]
    
    if (date) {
      query += ' AND DATE(c.started_at) = ?'
      params.push(date)
    }
    
    if (search) {
      query += ` AND c.conversation_id IN (
        SELECT conversation_id FROM chatbot_messages 
        WHERE content LIKE ?
      )`
      params.push(`%${search}%`)
    }
    
    query += ' ORDER BY c.started_at DESC LIMIT 50'
    
    const chats = await DB.prepare(query).bind(...params).all()
    
    return c.json({
      success: true,
      chats: chats.results || []
    })
  } catch (error) {
    console.error('Get chat history error:', error)
    return c.json({ error: 'Failed to get chat history' }, 500)
  }
})

// ========== BEACH BOOKING API ENDPOINTS ==========

// API: Get or Create Beach Settings
app.get('/api/admin/beach/settings/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    let settings = await DB.prepare(`
      SELECT * FROM beach_settings WHERE property_id = ?
    `).bind(property_id).first()
    
    // Create default settings if not exists
    if (!settings) {
      await DB.prepare(`
        INSERT INTO beach_settings (property_id) VALUES (?)
      `).bind(property_id).run()
      
      settings = await DB.prepare(`
        SELECT * FROM beach_settings WHERE property_id = ?
      `).bind(property_id).first()
    }
    
    return c.json({ success: true, settings })
  } catch (error) {
    console.error('Get beach settings error:', error)
    return c.json({ error: 'Failed to get beach settings' }, 500)
  }
})

// API: Save Beach Settings
app.post('/api/admin/beach/settings', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const {
      property_id,
      beach_booking_enabled,
      beach_map_image_url,
      opening_time,
      closing_time,
      advance_booking_days,
      max_booking_duration_hours,
      free_for_hotel_guests,
      card_title,
      card_subtitle,
      feature1_text,
      feature2_text,
      feature3_text,
      umbrellas_label,
      umbrellas_desc,
      cabanas_label,
      cabanas_desc,
      loungers_label,
      loungers_desc,
      daybeds_label,
      daybeds_desc,
      button_text,
      bg_color_from,
      bg_color_to,
      text_color,
      button_color_from,
      button_color_to,
      button_text_color,
      time_slots
    } = body
    
    // Check if settings exist
    const existing = await DB.prepare(`
      SELECT setting_id FROM beach_settings WHERE property_id = ?
    `).bind(property_id).first()
    
    if (existing) {
      // Update
      await DB.prepare(`
        UPDATE beach_settings
        SET beach_booking_enabled = ?,
            beach_map_image_url = ?,
            opening_time = ?,
            closing_time = ?,
            advance_booking_days = ?,
            max_booking_duration_hours = ?,
            free_for_hotel_guests = ?,
            card_title = ?,
            card_subtitle = ?,
            feature1_text = ?,
            feature2_text = ?,
            feature3_text = ?,
            umbrellas_label = ?,
            umbrellas_desc = ?,
            cabanas_label = ?,
            cabanas_desc = ?,
            loungers_label = ?,
            loungers_desc = ?,
            daybeds_label = ?,
            daybeds_desc = ?,
            button_text = ?,
            bg_color_from = ?,
            bg_color_to = ?,
            text_color = ?,
            button_color_from = ?,
            button_color_to = ?,
            button_text_color = ?,
            time_slots = ?,
            updated_at = CURRENT_TIMESTAMP
        WHERE property_id = ?
      `).bind(
        beach_booking_enabled || 0,
        beach_map_image_url || null,
        opening_time || '08:00',
        closing_time || '18:00',
        advance_booking_days || 7,
        max_booking_duration_hours || 12,
        free_for_hotel_guests || 1,
        card_title || 'Beach Booking',
        card_subtitle || 'Reserve your perfect spot by the sea! Select from umbrellas, cabanas, and premium locations.',
        feature1_text || 'Free for Hotel Guests',
        feature2_text || 'Book Up to 7 Days Ahead',
        feature3_text || 'QR Code Check-in',
        umbrellas_label || 'Umbrellas',
        umbrellas_desc || 'Classic Beach',
        cabanas_label || 'Cabanas',
        cabanas_desc || 'Private & Cozy',
        loungers_label || 'Loungers',
        loungers_desc || 'Relax in Style',
        daybeds_label || 'Daybeds',
        daybeds_desc || 'Ultimate Comfort',
        button_text || 'Book Your Spot Now',
        bg_color_from || '#3b82f6',
        bg_color_to || '#06b6d4',
        text_color || '#ffffff',
        button_color_from || '#ffffff',
        button_color_to || '#ffffff',
        button_text_color || '#3b82f6',
        time_slots || '[{"id":"half_day_am","name":"Morning","start":"08:00","end":"13:00"},{"id":"half_day_pm","name":"Afternoon","start":"13:00","end":"18:00"},{"id":"full_day","name":"Full Day","start":"08:00","end":"18:00"}]',
        property_id
      ).run()
    } else {
      // Insert
      await DB.prepare(`
        INSERT INTO beach_settings (
          property_id, beach_booking_enabled, beach_map_image_url,
          opening_time, closing_time, advance_booking_days,
          max_booking_duration_hours, free_for_hotel_guests,
          card_title, card_subtitle, feature1_text, feature2_text, feature3_text,
          umbrellas_label, umbrellas_desc, cabanas_label, cabanas_desc,
          loungers_label, loungers_desc, daybeds_label, daybeds_desc, button_text,
          bg_color_from, bg_color_to, text_color, button_color_from, button_color_to, button_text_color, time_slots
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(
        property_id,
        beach_booking_enabled || 0,
        beach_map_image_url || null,
        opening_time || '08:00',
        closing_time || '18:00',
        advance_booking_days || 7,
        max_booking_duration_hours || 12,
        free_for_hotel_guests || 1,
        card_title || 'Beach Booking',
        card_subtitle || 'Reserve your perfect spot by the sea! Select from umbrellas, cabanas, and premium locations.',
        feature1_text || 'Free for Hotel Guests',
        feature2_text || 'Book Up to 7 Days Ahead',
        feature3_text || 'QR Code Check-in',
        umbrellas_label || 'Umbrellas',
        umbrellas_desc || 'Classic Beach',
        cabanas_label || 'Cabanas',
        cabanas_desc || 'Private & Cozy',
        loungers_label || 'Loungers',
        loungers_desc || 'Relax in Style',
        daybeds_label || 'Daybeds',
        daybeds_desc || 'Ultimate Comfort',
        button_text || 'Book Your Spot Now',
        bg_color_from || '#3b82f6',
        bg_color_to || '#06b6d4',
        text_color || '#ffffff',
        button_color_from || '#ffffff',
        button_color_to || '#ffffff',
        button_text_color || '#3b82f6',
        time_slots || '[{"id":"half_day_am","name":"Morning","start":"08:00","end":"13:00"},{"id":"half_day_pm","name":"Afternoon","start":"13:00","end":"18:00"},{"id":"full_day","name":"Full Day","start":"08:00","end":"18:00"}]'
      ).run()
    }
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Save beach settings error:', error)
    return c.json({ error: 'Failed to save beach settings' }, 500)
  }
})

// ==================== HOTEL MAP API ENDPOINTS ====================

// API: Get Hotel Map Categories
app.get('/api/admin/hotel-map/categories/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const categories = await DB.prepare(`
      SELECT * FROM hotel_map_categories
      WHERE property_id = ?
      ORDER BY display_order, category_name
    `).bind(property_id).all()
    
    return c.json({ success: true, categories: categories.results || [] })
  } catch (error) {
    console.error('Get map categories error:', error)
    return c.json({ error: 'Failed to get categories' }, 500)
  }
})

// API: Get Hotel Map Hotspots
app.get('/api/admin/hotel-map/hotspots/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const hotspots = await DB.prepare(`
      SELECT * FROM hotel_map_hotspots
      WHERE property_id = ? AND is_visible = 1
      ORDER BY display_order, hotspot_id
    `).bind(property_id).all()
    
    return c.json({ success: true, hotspots: hotspots.results || [] })
  } catch (error) {
    console.error('Get map hotspots error:', error)
    return c.json({ error: 'Failed to get hotspots' }, 500)
  }
})

// API: Create Hotel Map Hotspot
app.post('/api/admin/hotel-map/hotspots', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const {
      property_id, position_x, position_y, width, height, shape,
      hotspot_type, title, subtitle, description, category, 
      building_number, link_url, color
    } = body
    
    await DB.prepare(`
      INSERT INTO hotel_map_hotspots (
        property_id, position_x, position_y, width, height, shape,
        hotspot_type, title, subtitle, description, category,
        building_number, link_url, color
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      property_id, position_x, position_y, width, height, shape,
      hotspot_type, title, subtitle || null, description || null, category || null,
      building_number || null, link_url || null, color || '#3B82F6'
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Create hotspot error:', error)
    return c.json({ error: 'Failed to create hotspot' }, 500)
  }
})

// API: Clear All Hotspots for Property
app.post('/api/admin/hotel-map/hotspots/clear/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    await DB.prepare(`
      DELETE FROM hotel_map_hotspots WHERE property_id = ?
    `).bind(property_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Clear hotspots error:', error)
    return c.json({ error: 'Failed to clear hotspots' }, 500)
  }
})

// ==================== BEACH BOOKING API ENDPOINTS ====================

// API: Get Beach Spots
app.get('/api/admin/beach/spots/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const spots = await DB.prepare(`
      SELECT s.*, z.zone_name
      FROM beach_spots s
      LEFT JOIN beach_zones z ON s.zone_id = z.zone_id
      WHERE s.property_id = ? AND s.is_active = 1
      ORDER BY s.spot_number
    `).bind(property_id).all()
    
    return c.json({ success: true, spots: spots.results || [] })
  } catch (error) {
    console.error('Get beach spots error:', error)
    return c.json({ error: 'Failed to get beach spots' }, 500)
  }
})

// API: Create Beach Spot
app.post('/api/admin/beach/spots', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const {
      property_id,
      zone_id,
      spot_number,
      spot_type,
      position_x,
      position_y,
      max_capacity,
      price_full_day,
      price_half_day,
      price_hourly,
      zone_name
    } = body
    
    // Create default zone if none exists
    let zoneIdToUse = zone_id
    if (!zoneIdToUse) {
      const defaultZone = await DB.prepare(`
        SELECT zone_id FROM beach_zones WHERE property_id = ? LIMIT 1
      `).bind(property_id).first()
      
      if (!defaultZone) {
        const zoneResult = await DB.prepare(`
          INSERT INTO beach_zones (property_id, zone_name, zone_type)
          VALUES (?, 'Main Beach', 'standard')
        `).bind(property_id).run()
        zoneIdToUse = zoneResult.meta.last_row_id
      } else {
        zoneIdToUse = defaultZone.zone_id
      }
    }
    
    await DB.prepare(`
      INSERT INTO beach_spots (
        property_id, zone_id, spot_number, spot_type,
        position_x, position_y, max_capacity,
        price_full_day, price_half_day, price_hourly,
        zone_name
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      property_id,
      zoneIdToUse,
      spot_number,
      spot_type,
      position_x,
      position_y,
      max_capacity || 2,
      price_full_day || 0,
      price_half_day || 0,
      price_hourly || 0,
      zone_name || 'General Area'
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Create beach spot error:', error)
    return c.json({ error: 'Failed to create beach spot' }, 500)
  }
})

// API: Delete Beach Spot
app.delete('/api/admin/beach/spots/:spot_id', async (c) => {
  const { DB } = c.env
  const { spot_id } = c.req.param()
  
  try {
    await DB.prepare(`
      UPDATE beach_spots SET is_active = 0 WHERE spot_id = ?
    `).bind(spot_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete beach spot error:', error)
    return c.json({ error: 'Failed to delete beach spot' }, 500)
  }
})

// API: Get Zone Overlays
app.get('/api/admin/beach/zone-overlays/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const overlays = await DB.prepare(`
      SELECT * FROM beach_zone_overlays 
      WHERE property_id = ? AND is_active = 1
      ORDER BY display_order, overlay_id
    `).bind(property_id).all()
    
    return c.json({ overlays: overlays.results || [] })
  } catch (error) {
    console.error('Get zone overlays error:', error)
    return c.json({ error: 'Failed to load zone overlays' }, 500)
  }
})

// API: Save Zone Overlay
app.post('/api/admin/beach/zone-overlays', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const {
      property_id,
      zone_name,
      shape_type,
      coordinates,
      color,
      opacity,
      display_order
    } = body
    
    await DB.prepare(`
      INSERT INTO beach_zone_overlays (
        property_id, zone_name, shape_type, coordinates,
        color, opacity, display_order, is_active
      ) VALUES (?, ?, ?, ?, ?, ?, ?, 1)
    `).bind(
      property_id,
      zone_name,
      shape_type || 'rectangle',
      coordinates,
      color || '#3b82f6',
      opacity || 0.3,
      display_order || 0
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Save zone overlay error:', error)
    return c.json({ error: 'Failed to save zone overlay' }, 500)
  }
})

// API: Delete All Zone Overlays for Property
app.delete('/api/admin/beach/zone-overlays/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    await DB.prepare(`
      UPDATE beach_zone_overlays SET is_active = 0 WHERE property_id = ?
    `).bind(property_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete zone overlays error:', error)
    return c.json({ error: 'Failed to delete zone overlays' }, 500)
  }
})

// API: Get Beach Bookings (Admin)
app.get('/api/admin/beach/bookings', async (c) => {
  const { DB } = c.env
  const property_id = c.req.query('property_id')
  const date = c.req.query('date')
  
  try {
    let query = `
      SELECT 
        bb.*,
        bs.spot_number,
        bs.spot_type
      FROM beach_bookings bb
      JOIN beach_spots bs ON bb.spot_id = bs.spot_id
      WHERE bb.property_id = ?
    `
    
    const params = [property_id]
    
    if (date) {
      query += ' AND bb.booking_date = ?'
      params.push(date)
    }
    
    query += ' ORDER BY bb.booking_date DESC, bb.start_time ASC'
    
    const bookings = await DB.prepare(query).bind(...params).all()
    
    return c.json({ success: true, bookings: bookings.results || [] })
  } catch (error) {
    console.error('Get beach bookings error:', error)
    return c.json({ error: 'Failed to get beach bookings' }, 500)
  }
})

// API: Get Beach Availability (Guest)
app.get('/api/beach/availability/:property_id/:date', async (c) => {
  const { DB } = c.env
  const { property_id, date } = c.req.param()
  const slot_type = c.req.query('slot_type') || 'full_day'
  
  try {
    // Get all active spots
    const spots = await DB.prepare(`
      SELECT * FROM beach_spots
      WHERE property_id = ? AND is_active = 1 AND maintenance_mode = 0
    `).bind(property_id).all()
    
    // Get bookings for the date
    const bookings = await DB.prepare(`
      SELECT spot_id, slot_type FROM beach_bookings
      WHERE property_id = ? AND booking_date = ? AND booking_status IN ('confirmed', 'checked_in')
    `).bind(property_id, date).all()
    
    // Mark spots as available/unavailable
    const availableSpots = (spots.results || []).map(spot => {
      const spotBookings = (bookings.results || []).filter(b => b.spot_id === spot.spot_id)
      
      // Check if spot is available for requested slot
      let isAvailable = true
      
      for (const booking of spotBookings) {
        if (booking.slot_type === 'full_day' || slot_type === 'full_day') {
          isAvailable = false
          break
        }
        if (booking.slot_type === slot_type) {
          isAvailable = false
          break
        }
      }
      
      return {
        ...spot,
        is_available: isAvailable
      }
    })
    
    return c.json({ success: true, spots: availableSpots })
  } catch (error) {
    console.error('Get beach availability error:', error)
    return c.json({ error: 'Failed to get beach availability' }, 500)
  }
})

// API: Create Beach Booking (Guest)
app.post('/api/beach/bookings', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const {
      property_id,
      spot_id,
      guest_name,
      guest_room_number,
      guest_phone,
      guest_email,
      booking_date,
      slot_type,
      start_time,
      end_time,
      num_guests,
      special_requests
    } = body
    
    // Check if spot is available
    const existingBookings = await DB.prepare(`
      SELECT COUNT(*) as count FROM beach_bookings
      WHERE spot_id = ? AND booking_date = ? AND booking_status IN ('confirmed', 'checked_in')
        AND (slot_type = 'full_day' OR slot_type = ? OR ? = 'full_day')
    `).bind(spot_id, booking_date, slot_type, slot_type).first()
    
    if (existingBookings.count > 0) {
      return c.json({ error: 'This spot is already booked for the selected time' }, 400)
    }
    
    // Get spot price
    const spot = await DB.prepare(`
      SELECT * FROM beach_spots WHERE spot_id = ?
    `).bind(spot_id).first()
    
    // Get settings to check if free for guests
    const settings = await DB.prepare(`
      SELECT * FROM beach_settings WHERE property_id = ?
    `).bind(property_id).first()
    
    let totalPrice = 0
    if (!settings?.free_for_hotel_guests || !guest_room_number) {
      if (slot_type === 'full_day') totalPrice = spot.price_full_day
      else if (slot_type === 'morning' || slot_type === 'afternoon') totalPrice = spot.price_half_day
      else totalPrice = spot.price_hourly
    }
    
    // Generate booking reference
    const bookingReference = 'BCH-' + Date.now() + '-' + Math.random().toString(36).substring(7).toUpperCase()
    
    // Generate 6-digit booking code (e.g., B12345)
    const bookingCode = 'B' + Math.floor(10000 + Math.random() * 90000).toString()
    
    // Generate QR code data (JSON with booking details)
    const qrCodeData = JSON.stringify({
      booking_reference: bookingReference,
      booking_code: bookingCode,
      spot_number: spot.spot_number,
      booking_date: booking_date,
      guest_name: guest_name
    })
    
    // Create booking
    await DB.prepare(`
      INSERT INTO beach_bookings (
        booking_reference, booking_code, property_id, spot_id, guest_name, guest_room_number,
        guest_phone, guest_email, booking_date, slot_type, start_time, end_time,
        num_guests, total_price, special_requests, booking_status, payment_status,
        qr_code_data
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'confirmed', ?, ?)
    `).bind(
      bookingReference,
      bookingCode,
      property_id,
      spot_id,
      guest_name,
      guest_room_number || null,
      guest_phone || null,
      guest_email || null,
      booking_date,
      slot_type,
      start_time || null,
      end_time || null,
      num_guests,
      totalPrice,
      special_requests || null,
      totalPrice === 0 ? 'free' : 'pending',
      qrCodeData
    ).run()
    
    return c.json({ 
      success: true, 
      booking: { 
        booking_reference: bookingReference,
        booking_code: bookingCode,
        spot_number: spot.spot_number,
        spot_type: spot.spot_type,
        qr_code_data: qrCodeData
      } 
    })
  } catch (error) {
    console.error('Create beach booking error:', error)
    return c.json({ error: 'Failed to create booking' }, 500)
  }
})

// API: Get Beach Booking Details by Reference
app.get('/api/beach/bookings/:booking_reference', async (c) => {
  const { DB } = c.env
  const { booking_reference } = c.req.param()
  
  try {
    const booking = await DB.prepare(`
      SELECT 
        bb.*,
        bs.spot_number,
        bs.spot_type,
        bs.max_capacity,
        bs.is_premium
      FROM beach_bookings bb
      LEFT JOIN beach_spots bs ON bb.spot_id = bs.spot_id
      WHERE bb.booking_reference = ?
    `).bind(booking_reference).first()
    
    if (!booking) {
      return c.json({ error: 'Booking not found' }, 404)
    }
    
    return c.json({ success: true, booking })
  } catch (error) {
    console.error('Get booking error:', error)
    return c.json({ error: 'Failed to get booking' }, 500)
  }
})

// API: Cancel Beach Booking
app.post('/api/beach/bookings/:booking_reference/cancel', async (c) => {
  const { DB } = c.env
  const { booking_reference } = c.req.param()
  
  try {
    await DB.prepare(`
      UPDATE beach_bookings
      SET booking_status = 'cancelled', cancelled_at = CURRENT_TIMESTAMP
      WHERE booking_reference = ?
    `).bind(booking_reference).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Cancel beach booking error:', error)
    return c.json({ error: 'Failed to cancel booking' }, 500)
  }
})

// API: Staff - Verify Booking (QR or Code)
app.post('/api/staff/beach/verify', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const { data, method } = body
    
    let booking = null
    
    if (method === 'manual') {
      // Manual code entry - search by booking_code
      booking = await DB.prepare(`
        SELECT bb.*, bs.spot_number, bs.spot_type
        FROM beach_bookings bb
        JOIN beach_spots bs ON bb.spot_id = bs.spot_id
        WHERE bb.booking_code = ? AND bb.booking_status != 'cancelled'
      `).bind(data).first()
    } else if (method === 'qr') {
      // QR code scan - parse JSON data
      try {
        const qrData = JSON.parse(data)
        booking = await DB.prepare(`
          SELECT bb.*, bs.spot_number, bs.spot_type
          FROM beach_bookings bb
          JOIN beach_spots bs ON bb.spot_id = bs.spot_id
          WHERE bb.booking_reference = ? OR bb.booking_code = ?
        `).bind(qrData.booking_reference || data, qrData.booking_code || data).first()
      } catch {
        // If not JSON, try as booking reference
        booking = await DB.prepare(`
          SELECT bb.*, bs.spot_number, bs.spot_type
          FROM beach_bookings bb
          JOIN beach_spots bs ON bb.spot_id = bs.spot_id
          WHERE bb.booking_reference = ? OR bb.booking_code = ?
        `).bind(data, data).first()
      }
    }
    
    if (!booking) {
      return c.json({ success: false, error: 'Booking not found' }, 404)
    }
    
    // Check if booking is for today
    const today = new Date().toISOString().split('T')[0]
    const bookingDate = new Date(booking.booking_date).toISOString().split('T')[0]
    
    if (bookingDate !== today) {
      return c.json({ 
        success: false, 
        error: 'This booking is for ' + new Date(booking.booking_date).toLocaleDateString() 
      }, 400)
    }
    
    return c.json({ success: true, booking })
  } catch (error) {
    console.error('Verify booking error:', error)
    return c.json({ success: false, error: 'Verification failed' }, 500)
  }
})

// API: AI Assistant Chat
app.post('/api/admin/assistant/chat', async (c) => {
  try {
    const { message } = await c.req.json()
    
    if (!message) {
      return c.json({ success: false, error: 'Message is required' }, 400)
    }

    // System prompt with complete platform knowledge
    const systemPrompt = `You are the GuestConnect AI Assistant, an expert helper for hotel administrators using the GuestConnect platform. You have complete knowledge of all platform features and can guide admins through any task.

PLATFORM FEATURES YOU KNOW:

1. BEACH BOOKING SYSTEM:
   - Settings: Go to Admin Dashboard â†’ Beach Booking Management tab to configure opening hours (opening_time, closing_time), advance booking days, enable/disable booking, set free for guests
   - Beach Map Designer: Click "Design Beach Map" button â†’ upload beach photo â†’ draw zones by clicking "Draw Zone" â†’ place spots (umbrellas, cabanas, loungers, daybeds) â†’ edit spot details (number, capacity, price, premium status) â†’ click "Save Beach Layout"
   - Zones: Colored overlays on beach map. Create by clicking "Draw Zone", draw on canvas, name it, choose color. Guests see zones with legend
   - Time Slots: Configure in Beach Booking Management â†’ Time Slots section. Default: Morning (8AM-1PM), Afternoon (1PM-6PM), Full Day (8AM-6PM)
   - Important Information: Scroll to "Important Information" section (blue gradient card) â†’ edit text (one line = one bullet point) â†’ appears on guest confirmation pages
   - QR Codes: Automatically generated with 6-digit booking codes for each reservation. Staff scan at /staff/beach-check-in

2. BEACH ANALYTICS:
   - Access: Beach Booking Management â†’ click "Open Dashboard" OR go directly to /admin/beach-analytics
   - Features: Live occupancy by zone, peak hours heatmaps, revenue by zone, no-show tracking, AI-powered operational recommendations
   - Real-time data showing current bookings, occupancy percentages, busiest times

3. RESTAURANT MANAGEMENT:
   - Add: Go to Offerings tab â†’ click "Add New Offering" â†’ select "Restaurant" â†’ fill details (name, description, hours, menu)
   - Photos: Upload high-quality images in restaurant edit page
   - Floor Plan Designer: Click "Floor Plan Designer" â†’ upload layout â†’ place table markers â†’ guests can select preferred tables

4. QR CODE GENERATION:
   - Create: QR Codes tab â†’ "Create New QR Code" â†’ enter URL â†’ customize with logo, colors, frame style, corner style
   - Download: PNG (print quality) or SVG (vector for scaling)
   - Branding: Upload hotel logo, set foreground/background colors for branded QR codes

5. ANALYTICS & REPORTS:
   - View: Analytics tab in sidebar â†’ see guest engagement, QR scans, popular services, trends
   - Export: Click "Export Data" button to download CSV reports

6. SETTINGS & BRANDING:
   - Logo: Settings â†’ Hotel Information â†’ "Upload Logo" â†’ appears throughout platform
   - Colors: Settings â†’ Branding â†’ use color pickers for primary/secondary brand colors
   - Profile: Complete hotel name, address, phone, email, website

7. STAFF CHECK-IN:
   - Access: /staff/beach-check-in
   - Methods: Scan QR code OR manually enter 6-digit booking code
   - Validation: System verifies booking, shows guest details, marks as checked in

8. BEACH CARD CUSTOMIZATION:
   - Location: Beach Booking Management â†’ Beach Card Customization section
   - Edit: Card title, subtitle, feature texts, category labels (umbrellas, cabanas, loungers, daybeds), button text
   - Colors: Background gradient (from/to), text color, button colors

RESPONSE GUIDELINES:
- Provide clear, step-by-step instructions
- Include exact navigation paths (Tab â†’ Section â†’ Button)
- Mention specific field names and options
- Suggest best practices when relevant
- Be conversational and helpful
- If user asks "how to add restaurant", give complete step-by-step guide
- For complex tasks, break down into numbered steps
- Always confirm you understand their question before answering

Answer the admin's question about the GuestConnect platform:`

    // Call OpenAI API
    const response = await fetch('https://www.genspark.ai/api/llm_proxy/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${c.env.OPENAI_API_KEY || 'gsk-default-key'}`
      },
      body: JSON.stringify({
        model: 'gpt-5-mini',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: message }
        ],
        temperature: 0.7,
        max_tokens: 500
      })
    })

    if (!response.ok) {
      const errorText = await response.text()
      console.error('OpenAI API Error:', errorText)
      return c.json({ 
        success: false, 
        response: 'I apologize, but I am having trouble connecting to my AI brain right now. However, I can still help! Try asking about:\n\n- How to add a restaurant\n- How to configure beach settings\n- How to view analytics\n- How to create QR codes\n\nWhat would you like to know?' 
      })
    }

    const data = await response.json()
    const aiResponse = data.choices?.[0]?.message?.content || 'I am not sure how to help with that. Could you please rephrase your question?'

    return c.json({ 
      success: true, 
      response: aiResponse 
    })

  } catch (error) {
    console.error('AI Chat Error:', error)
    return c.json({ 
      success: false, 
      response: 'I encountered an error processing your question. Please try again or contact support if the issue persists.' 
    }, 500)
  }
})

// API: Staff - Check In Guest
app.post('/api/staff/beach/check-in', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const { booking_reference, staff_name } = body
    
    // Check if already checked in
    const existing = await DB.prepare(`
      SELECT booking_status FROM beach_bookings WHERE booking_reference = ?
    `).bind(booking_reference).first()
    
    if (!existing) {
      return c.json({ success: false, error: 'Booking not found' }, 404)
    }
    
    if (existing.booking_status === 'checked_in') {
      return c.json({ success: false, error: 'Already checked in' }, 400)
    }
    
    // Update booking to checked_in
    await DB.prepare(`
      UPDATE beach_bookings
      SET booking_status = 'checked_in',
          checked_in_at = CURRENT_TIMESTAMP,
          checked_in_by = ?
      WHERE booking_reference = ?
    `).bind(staff_name, booking_reference).run()
    
    // Get updated booking
    const booking = await DB.prepare(`
      SELECT bb.*, bs.spot_number, bs.spot_type
      FROM beach_bookings bb
      JOIN beach_spots bs ON bb.spot_id = bs.spot_id
      WHERE bb.booking_reference = ?
    `).bind(booking_reference).first()
    
    return c.json({ success: true, booking })
  } catch (error) {
    console.error('Check-in error:', error)
    return c.json({ success: false, error: 'Check-in failed' }, 500)
  }
})

// ==================== ANALYTICS API ENDPOINTS ====================

// API: Analytics - Live Occupancy (Real-time)
app.get('/api/analytics/beach/live-occupancy/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const today = new Date().toISOString().split('T')[0]
  
  try {
    // Get total spots by zone and type
    const spots = await DB.prepare(`
      SELECT zone_name, spot_type, COUNT(*) as total_spots
      FROM beach_spots
      WHERE property_id = ? AND is_active = 1
      GROUP BY zone_name, spot_type
    `).bind(property_id).all()
    
    // Get occupied spots for today
    const occupied = await DB.prepare(`
      SELECT bs.zone_name, bs.spot_type, COUNT(*) as occupied_spots
      FROM beach_bookings bb
      JOIN beach_spots bs ON bb.spot_id = bs.spot_id
      WHERE bb.property_id = ? 
        AND bb.booking_date = ?
        AND bb.booking_status IN ('confirmed', 'checked_in')
      GROUP BY bs.zone_name, bs.spot_type
    `).bind(property_id, today).all()
    
    // Calculate occupancy rates
    const occupancyMap = {}
    spots.results.forEach(spot => {
      const key = spot.zone_name + '|' + spot.spot_type
      occupancyMap[key] = {
        zone_name: spot.zone_name,
        spot_type: spot.spot_type,
        total: spot.total_spots,
        occupied: 0,
        available: spot.total_spots,
        occupancy_rate: 0
      }
    })
    
    occupied.results.forEach(occ => {
      const key = occ.zone_name + '|' + occ.spot_type
      if (occupancyMap[key]) {
        occupancyMap[key].occupied = occ.occupied_spots
        occupancyMap[key].available = occupancyMap[key].total - occ.occupied_spots
        occupancyMap[key].occupancy_rate = Math.round((occ.occupied_spots / occupancyMap[key].total) * 100)
      }
    })
    
    return c.json({ 
      success: true, 
      date: today,
      occupancy: Object.values(occupancyMap)
    })
  } catch (error) {
    console.error('Live occupancy error:', error)
    return c.json({ error: 'Failed to get live occupancy' }, 500)
  }
})

// API: Analytics - Revenue by Zone
app.get('/api/analytics/beach/revenue/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const { start_date, end_date } = c.req.query()
  
  try {
    const revenue = await DB.prepare(`
      SELECT 
        bs.zone_name,
        bs.spot_type,
        COUNT(*) as total_bookings,
        SUM(bb.total_price) as total_revenue,
        AVG(bb.total_price) as avg_price,
        SUM(CASE WHEN bb.booking_status = 'checked_in' THEN 1 ELSE 0 END) as checked_in_count
      FROM beach_bookings bb
      JOIN beach_spots bs ON bb.spot_id = bs.spot_id
      WHERE bb.property_id = ?
        AND bb.booking_date BETWEEN ? AND ?
        AND bb.booking_status != 'cancelled'
      GROUP BY bs.zone_name, bs.spot_type
      ORDER BY total_revenue DESC
    `).bind(property_id, start_date, end_date).all()
    
    return c.json({ 
      success: true, 
      period: { start_date, end_date },
      revenue: revenue.results || []
    })
  } catch (error) {
    console.error('Revenue analytics error:', error)
    return c.json({ error: 'Failed to get revenue data' }, 500)
  }
})

// API: Analytics - Peak Hours Heatmap
app.get('/api/analytics/beach/peak-hours/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const { days } = c.req.query() // Number of days to analyze
  
  try {
    const startDate = new Date()
    startDate.setDate(startDate.getDate() - (parseInt(days) || 30))
    const startDateStr = startDate.toISOString().split('T')[0]
    
    // Get bookings by hour and day of week
    const bookings = await DB.prepare(`
      SELECT 
        strftime('%w', booking_date) as day_of_week,
        slot_type,
        bs.zone_name,
        COUNT(*) as booking_count
      FROM beach_bookings bb
      JOIN beach_spots bs ON bb.spot_id = bs.spot_id
      WHERE bb.property_id = ?
        AND bb.booking_date >= ?
        AND bb.booking_status != 'cancelled'
      GROUP BY day_of_week, slot_type, bs.zone_name
      ORDER BY day_of_week, slot_type
    `).bind(property_id, startDateStr).all()
    
    return c.json({ 
      success: true, 
      analysis_period_days: days || 30,
      heatmap_data: bookings.results || []
    })
  } catch (error) {
    console.error('Peak hours error:', error)
    return c.json({ error: 'Failed to get peak hours data' }, 500)
  }
})

// API: Analytics - No-Show Tracking
app.get('/api/analytics/beach/no-shows/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const { start_date, end_date } = c.req.query()
  
  try {
    // Find bookings that weren't checked in (no-shows)
    const noShows = await DB.prepare(`
      SELECT 
        bb.*,
        bs.spot_number,
        bs.spot_type,
        bs.zone_name
      FROM beach_bookings bb
      JOIN beach_spots bs ON bb.spot_id = bs.spot_id
      WHERE bb.property_id = ?
        AND bb.booking_date BETWEEN ? AND ?
        AND bb.booking_status = 'confirmed'
        AND bb.checked_in_at IS NULL
        AND bb.booking_date < date('now')
      ORDER BY bb.booking_date DESC
    `).bind(property_id, start_date, end_date).all()
    
    // Get no-show statistics by zone
    const noShowStats = await DB.prepare(`
      SELECT 
        bs.zone_name,
        COUNT(*) as no_show_count,
        SUM(bb.total_price) as lost_revenue
      FROM beach_bookings bb
      JOIN beach_spots bs ON bb.spot_id = bs.spot_id
      WHERE bb.property_id = ?
        AND bb.booking_date BETWEEN ? AND ?
        AND bb.booking_status = 'confirmed'
        AND bb.checked_in_at IS NULL
        AND bb.booking_date < date('now')
      GROUP BY bs.zone_name
    `).bind(property_id, start_date, end_date).all()
    
    return c.json({ 
      success: true, 
      period: { start_date, end_date },
      no_shows: noShows.results || [],
      statistics: noShowStats.results || []
    })
  } catch (error) {
    console.error('No-show tracking error:', error)
    return c.json({ error: 'Failed to get no-show data' }, 500)
  }
})

// API: Analytics - Comprehensive Dashboard Data
app.get('/api/analytics/beach/dashboard/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  const today = new Date().toISOString().split('T')[0]
  
  try {
    // Today's summary
    const todaySummary = await DB.prepare(`
      SELECT 
        COUNT(*) as total_bookings,
        SUM(CASE WHEN booking_status = 'checked_in' THEN 1 ELSE 0 END) as checked_in,
        SUM(CASE WHEN booking_status = 'confirmed' THEN 1 ELSE 0 END) as pending_checkin,
        SUM(total_price) as total_revenue
      FROM beach_bookings
      WHERE property_id = ? AND booking_date = ?
    `).bind(property_id, today).first()
    
    // This week's trend
    const weekStart = new Date()
    weekStart.setDate(weekStart.getDate() - 7)
    const weekTrend = await DB.prepare(`
      SELECT 
        booking_date,
        COUNT(*) as bookings,
        SUM(total_price) as revenue
      FROM beach_bookings
      WHERE property_id = ? 
        AND booking_date >= ?
        AND booking_status != 'cancelled'
      GROUP BY booking_date
      ORDER BY booking_date
    `).bind(property_id, weekStart.toISOString().split('T')[0]).all()
    
    // Zone performance
    const zonePerformance = await DB.prepare(`
      SELECT 
        bs.zone_name,
        COUNT(*) as bookings,
        SUM(bb.total_price) as revenue,
        AVG(bb.total_price) as avg_revenue,
        SUM(CASE WHEN bb.booking_status = 'checked_in' THEN 1 ELSE 0 END) as utilization
      FROM beach_bookings bb
      JOIN beach_spots bs ON bb.spot_id = bs.spot_id
      WHERE bb.property_id = ?
        AND bb.booking_date >= ?
      GROUP BY bs.zone_name
      ORDER BY revenue DESC
    `).bind(property_id, weekStart.toISOString().split('T')[0]).all()
    
    return c.json({
      success: true,
      today: todaySummary,
      week_trend: weekTrend.results || [],
      zone_performance: zonePerformance.results || []
    })
  } catch (error) {
    console.error('Dashboard data error:', error)
    return c.json({ error: 'Failed to get dashboard data' }, 500)
  }
})

// API: Get Booking Details
app.get('/api/beach/bookings/:booking_reference', async (c) => {
  const { DB } = c.env
  const { booking_reference } = c.req.param()
  
  try {
    const booking = await DB.prepare(`
      SELECT bb.*, bs.spot_number, bs.spot_type, bs.max_capacity
      FROM beach_bookings bb
      JOIN beach_spots bs ON bb.spot_id = bs.spot_id
      WHERE bb.booking_reference = ?
    `).bind(booking_reference).first()
    
    if (!booking) {
      return c.json({ error: 'Booking not found' }, 404)
    }
    
    return c.json({ success: true, booking })
  } catch (error) {
    console.error('Get booking error:', error)
    return c.json({ error: 'Failed to get booking' }, 500)
  }
})

// ========== END BEACH BOOKING API ENDPOINTS ==========

// ========== FEEDBACK SYSTEM API ENDPOINTS ==========

// Admin: Get all feedback forms for a property
app.get('/api/admin/feedback/forms/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const forms = await DB.prepare(`
      SELECT 
        f.*,
        COUNT(DISTINCT s.submission_id) as total_submissions,
        SUM(CASE WHEN s.is_urgent = 1 THEN 1 ELSE 0 END) as urgent_count,
        AVG(s.sentiment_score) as avg_sentiment
      FROM feedback_forms f
      LEFT JOIN feedback_submissions s ON f.form_id = s.form_id
      WHERE f.property_id = ?
      GROUP BY f.form_id
      ORDER BY f.created_at DESC
    `).bind(property_id).all()
    
    return c.json({ success: true, forms: forms.results })
  } catch (error) {
    console.error('Get feedback forms error:', error)
    return c.json({ error: 'Failed to get forms' }, 500)
  }
})

// Admin: Create new feedback form
app.post('/api/admin/feedback/forms', async (c) => {
  const { DB } = c.env
  const body = await c.req.json()
  const { property_id, form_name, form_description, form_type, require_room_number, require_guest_name, require_email, require_phone, thank_you_message, show_on_homepage } = body
  
  try {
    const result = await DB.prepare(`
      INSERT INTO feedback_forms (
        property_id, form_name, form_description, form_type,
        require_room_number, require_guest_name, require_email, require_phone,
        thank_you_message, show_on_homepage
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      property_id, form_name, form_description || '', form_type || 'feedback',
      require_room_number || 0, require_guest_name || 0, require_email || 0, require_phone || 0,
      thank_you_message || 'Thank you for your feedback!', show_on_homepage || 0
    ).run()
    
    const form_id = result.meta.last_row_id
    
    return c.json({ success: true, form_id })
  } catch (error) {
    console.error('Create feedback form error:', error)
    return c.json({ error: 'Failed to create form' }, 500)
  }
})

// Admin: Get form details with questions
app.get('/api/admin/feedback/forms/:form_id/details', async (c) => {
  const { DB } = c.env
  const { form_id } = c.req.param()
  
  try {
    const form = await DB.prepare(`
      SELECT * FROM feedback_forms WHERE form_id = ?
    `).bind(form_id).first()
    
    if (!form) {
      return c.json({ error: 'Form not found' }, 404)
    }
    
    const questions = await DB.prepare(`
      SELECT * FROM feedback_questions
      WHERE form_id = ?
      ORDER BY display_order ASC
    `).bind(form_id).all()
    
    return c.json({ 
      success: true, 
      form: {
        ...form,
        questions: questions.results.map(q => ({
          ...q,
          options: q.options ? JSON.parse(q.options) : null
        }))
      }
    })
  } catch (error) {
    console.error('Get form details error:', error)
    return c.json({ error: 'Failed to get form details' }, 500)
  }
})

// Admin: Add question to form
app.post('/api/admin/feedback/questions', async (c) => {
  const { DB } = c.env
  const body = await c.req.json()
  const { form_id, question_text, question_type, is_required, options, display_order } = body
  
  try {
    const result = await DB.prepare(`
      INSERT INTO feedback_questions (
        form_id, question_text, question_type, is_required, options, display_order
      ) VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      form_id, question_text, question_type, is_required !== false ? 1 : 0,
      options ? JSON.stringify(options) : null, display_order || 0
    ).run()
    
    return c.json({ success: true, question_id: result.meta.last_row_id })
  } catch (error) {
    console.error('Add question error:', error)
    return c.json({ error: 'Failed to add question' }, 500)
  }
})

// Admin: Delete question
app.delete('/api/admin/feedback/questions/:question_id', async (c) => {
  const { DB } = c.env
  const { question_id } = c.req.param()
  
  try {
    await DB.prepare(`
      DELETE FROM feedback_questions WHERE question_id = ?
    `).bind(question_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete question error:', error)
    return c.json({ error: 'Failed to delete question' }, 500)
  }
})

// Admin: Update form
app.put('/api/admin/feedback/forms/:form_id', async (c) => {
  const { DB } = c.env
  const { form_id } = c.req.param()
  const body = await c.req.json()
  
  try {
    await DB.prepare(`
      UPDATE feedback_forms
      SET form_name = ?, form_description = ?, is_active = ?,
          require_room_number = ?, require_guest_name = ?, 
          require_email = ?, require_phone = ?,
          thank_you_message = ?, updated_at = CURRENT_TIMESTAMP
      WHERE form_id = ?
    `).bind(
      body.form_name, body.form_description, body.is_active,
      body.require_room_number, body.require_guest_name,
      body.require_email, body.require_phone,
      body.thank_you_message, form_id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Update form error:', error)
    return c.json({ error: 'Failed to update form' }, 500)
  }
})

// Admin: Delete form
app.delete('/api/admin/feedback/forms/:form_id', async (c) => {
  const { DB } = c.env
  const { form_id } = c.req.param()
  
  try {
    await DB.prepare(`
      DELETE FROM feedback_forms WHERE form_id = ?
    `).bind(form_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Delete form error:', error)
    return c.json({ error: 'Failed to delete form' }, 500)
  }
})

// Admin: Set form as homepage form (only ONE can be active at a time)
app.post('/api/admin/feedback/forms/:form_id/set-homepage', async (c) => {
  const { DB } = c.env
  const { form_id } = c.req.param()
  const body = await c.req.json()
  const { property_id } = body
  
  try {
    // First, unset all other forms for this property
    await DB.prepare(`
      UPDATE feedback_forms 
      SET show_on_homepage = 0 
      WHERE property_id = ?
    `).bind(property_id).run()
    
    // Then set the selected form as homepage form
    await DB.prepare(`
      UPDATE feedback_forms 
      SET show_on_homepage = 1 
      WHERE form_id = ?
    `).bind(form_id).run()
    
    return c.json({ success: true, message: 'Homepage form updated' })
  } catch (error) {
    console.error('Set homepage form error:', error)
    return c.json({ error: 'Failed to set homepage form' }, 500)
  }
})

// PUBLIC: Get feedback form for guest (by form_id)
app.get('/api/feedback/forms/:form_id', async (c) => {
  const { DB } = c.env
  const { form_id } = c.req.param()
  
  try {
    const form = await DB.prepare(`
      SELECT f.*, p.name as property_name
      FROM feedback_forms f
      JOIN properties p ON f.property_id = p.property_id
      WHERE f.form_id = ? AND f.is_active = 1
    `).bind(form_id).first()
    
    if (!form) {
      return c.json({ error: 'Form not found or inactive' }, 404)
    }
    
    const questions = await DB.prepare(`
      SELECT * FROM feedback_questions
      WHERE form_id = ?
      ORDER BY display_order ASC
    `).bind(form_id).all()
    
    return c.json({ 
      success: true, 
      form: {
        ...form,
        questions: questions.results.map(q => ({
          ...q,
          options: q.options ? JSON.parse(q.options) : null
        }))
      }
    })
  } catch (error) {
    console.error('Get public form error:', error)
    return c.json({ error: 'Failed to get form' }, 500)
  }
})

// PUBLIC: Submit feedback
app.post('/api/feedback/submit', async (c) => {
  const { DB } = c.env
  const body = await c.req.json()
  const { form_id, room_number, guest_name, guest_email, guest_phone, answers, submission_source, session_id } = body
  
  try {
    // Get form details
    const form = await DB.prepare(`
      SELECT * FROM feedback_forms WHERE form_id = ?
    `).bind(form_id).first()
    
    if (!form) {
      return c.json({ error: 'Form not found' }, 404)
    }
    
    // Analyze sentiment from answers
    let sentiment_score = 0
    let sentiment_label = 'neutral'
    let is_urgent = 0
    
    // Simple sentiment analysis based on ratings and text
    for (const answer of answers) {
      if (answer.answer_numeric !== undefined && answer.answer_numeric !== null) {
        // For rating/scale questions (1-5 or 1-10)
        const normalized = answer.answer_numeric / 10 // Normalize to 0-1
        sentiment_score += normalized
      }
      
      if (answer.answer_text) {
        const lowerText = answer.answer_text.toLowerCase()
        // Check for urgent keywords
        if (lowerText.match(/urgent|emergency|terrible|awful|angry|furious|disgusting|complaint/)) {
          is_urgent = 1
          sentiment_label = 'urgent'
        }
        // Negative keywords
        else if (lowerText.match(/bad|poor|disappointed|unhappy|dirty|broken|not working/)) {
          sentiment_score -= 0.5
        }
        // Positive keywords
        else if (lowerText.match(/excellent|amazing|wonderful|great|fantastic|perfect|loved/)) {
          sentiment_score += 0.5
        }
      }
    }
    
    // Calculate final sentiment
    if (answers.length > 0) {
      sentiment_score = sentiment_score / answers.length
    }
    
    if (is_urgent === 0) {
      if (sentiment_score > 0.6) sentiment_label = 'positive'
      else if (sentiment_score < -0.2) sentiment_label = 'negative'
      else sentiment_label = 'neutral'
    }
    
    // Create submission
    const submissionResult = await DB.prepare(`
      INSERT INTO feedback_submissions (
        form_id, property_id, room_number, guest_name, guest_email, guest_phone,
        submission_source, session_id, sentiment_score, sentiment_label, is_urgent
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      form_id, form.property_id, room_number || null, guest_name || null,
      guest_email || null, guest_phone || null, submission_source || 'web',
      session_id || null, sentiment_score, sentiment_label, is_urgent
    ).run()
    
    const submission_id = submissionResult.meta.last_row_id
    
    // Save all answers
    for (const answer of answers) {
      await DB.prepare(`
        INSERT INTO feedback_answers (submission_id, question_id, answer_text, answer_numeric)
        VALUES (?, ?, ?, ?)
      `).bind(
        submission_id, answer.question_id,
        answer.answer_text || null, answer.answer_numeric || null
      ).run()
    }
    
    // If urgent, create AI insight
    if (is_urgent === 1) {
      await DB.prepare(`
        INSERT INTO feedback_insights (
          property_id, submission_id, insight_type, title, description,
          action_suggested, priority
        ) VALUES (?, ?, 'alert', ?, ?, ?, 'critical')
      `).bind(
        form.property_id, submission_id,
        `URGENT: Issue from ${guest_name || 'Guest'} ${room_number ? 'in Room ' + room_number : ''}`,
        `Guest expressed urgent concern. Immediate attention required.`,
        `Contact guest immediately and resolve the issue. Follow up within 1 hour.`
      ).run()
    }
    
    return c.json({ success: true, submission_id })
  } catch (error) {
    console.error('Submit feedback error:', error)
    return c.json({ error: 'Failed to submit feedback' }, 500)
  }
})

// Admin: Get submissions for a form
app.get('/api/admin/feedback/forms/:form_id/submissions', async (c) => {
  const { DB } = c.env
  const { form_id } = c.req.param()
  
  try {
    const submissions = await DB.prepare(`
      SELECT * FROM feedback_submissions
      WHERE form_id = ?
      ORDER BY submitted_at DESC
    `).bind(form_id).all()
    
    return c.json({ success: true, submissions: submissions.results })
  } catch (error) {
    console.error('Get submissions error:', error)
    return c.json({ error: 'Failed to get submissions' }, 500)
  }
})

// Admin: Get submission details with answers
app.get('/api/admin/feedback/submissions/:submission_id', async (c) => {
  const { DB } = c.env
  const { submission_id } = c.req.param()
  
  try {
    const submission = await DB.prepare(`
      SELECT s.*, f.form_name
      FROM feedback_submissions s
      JOIN feedback_forms f ON s.form_id = f.form_id
      WHERE s.submission_id = ?
    `).bind(submission_id).first()
    
    if (!submission) {
      return c.json({ error: 'Submission not found' }, 404)
    }
    
    const answers = await DB.prepare(`
      SELECT a.*, q.question_text, q.question_type
      FROM feedback_answers a
      JOIN feedback_questions q ON a.question_id = q.question_id
      WHERE a.submission_id = ?
    `).bind(submission_id).all()
    
    return c.json({
      success: true,
      submission: {
        ...submission,
        answers: answers.results
      }
    })
  } catch (error) {
    console.error('Get submission details error:', error)
    return c.json({ error: 'Failed to get submission' }, 500)
  }
})

// Admin: Get analytics for property
app.get('/api/admin/feedback/analytics/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    // Overall stats
    const stats = await DB.prepare(`
      SELECT 
        COUNT(*) as total_submissions,
        SUM(CASE WHEN is_urgent = 1 THEN 1 ELSE 0 END) as urgent_count,
        SUM(CASE WHEN sentiment_label = 'positive' THEN 1 ELSE 0 END) as positive_count,
        SUM(CASE WHEN sentiment_label = 'negative' THEN 1 ELSE 0 END) as negative_count,
        AVG(sentiment_score) as avg_sentiment,
        SUM(CASE WHEN is_read = 0 THEN 1 ELSE 0 END) as unread_count
      FROM feedback_submissions
      WHERE property_id = ?
    `).bind(property_id).first()
    
    // Recent submissions
    const recent = await DB.prepare(`
      SELECT s.*, f.form_name
      FROM feedback_submissions s
      JOIN feedback_forms f ON s.form_id = f.form_id
      WHERE s.property_id = ?
      ORDER BY s.submitted_at DESC
      LIMIT 10
    `).bind(property_id).all()
    
    // Active insights
    const insights = await DB.prepare(`
      SELECT * FROM feedback_insights
      WHERE property_id = ? AND is_resolved = 0
      ORDER BY priority DESC, created_at DESC
      LIMIT 20
    `).bind(property_id).all()
    
    return c.json({
      success: true,
      stats,
      recent_submissions: recent.results,
      insights: insights.results
    })
  } catch (error) {
    console.error('Get analytics error:', error)
    return c.json({ error: 'Failed to get analytics' }, 500)
  }
})

// Admin: Get chat feedback (AI-detected complaints from chatbot conversations)
app.get('/api/admin/feedback/chat/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    const chatFeedback = await DB.prepare(`
      SELECT 
        cf.*,
        datetime(cf.detected_at, 'localtime') as detected_at_formatted
      FROM chat_feedback cf
      WHERE cf.property_id = ?
      ORDER BY cf.is_urgent DESC, cf.detected_at DESC
      LIMIT 50
    `).bind(property_id).all()
    
    // Get summary stats
    const stats = await DB.prepare(`
      SELECT 
        COUNT(*) as total_chat_feedback,
        SUM(CASE WHEN is_urgent = 1 THEN 1 ELSE 0 END) as urgent_count,
        SUM(CASE WHEN is_resolved = 0 THEN 1 ELSE 0 END) as unresolved_count,
        SUM(CASE WHEN complaint_category = 'room' THEN 1 ELSE 0 END) as room_complaints,
        SUM(CASE WHEN complaint_category = 'food' THEN 1 ELSE 0 END) as food_complaints,
        SUM(CASE WHEN complaint_category = 'staff' THEN 1 ELSE 0 END) as staff_complaints,
        SUM(CASE WHEN complaint_category = 'cleanliness' THEN 1 ELSE 0 END) as cleanliness_complaints
      FROM chat_feedback
      WHERE property_id = ?
    `).bind(property_id).first()
    
    return c.json({
      success: true,
      chat_feedback: chatFeedback.results || [],
      stats: stats || {}
    })
  } catch (error) {
    console.error('Get chat feedback error:', error)
    return c.json({ error: 'Failed to get chat feedback' }, 500)
  }
})

// Admin: Resolve chat feedback
app.post('/api/admin/feedback/chat/:feedback_id/resolve', async (c) => {
  const { DB } = c.env
  const { feedback_id } = c.req.param()
  const body = await c.req.json()
  const { admin_notes } = body
  
  try {
    await DB.prepare(`
      UPDATE chat_feedback 
      SET is_resolved = 1, resolved_at = CURRENT_TIMESTAMP, admin_notes = ?
      WHERE feedback_id = ?
    `).bind(admin_notes || '', feedback_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Resolve chat feedback error:', error)
    return c.json({ error: 'Failed to resolve chat feedback' }, 500)
  }
})

// Admin: Mark submission as read
app.post('/api/admin/feedback/submissions/:submission_id/mark-read', async (c) => {
  const { DB } = c.env
  const { submission_id } = c.req.param()
  
  try {
    await DB.prepare(`
      UPDATE feedback_submissions SET is_read = 1 WHERE submission_id = ?
    `).bind(submission_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Mark read error:', error)
    return c.json({ error: 'Failed to mark as read' }, 500)
  }
})

// Admin: Resolve insight
app.post('/api/admin/feedback/insights/:insight_id/resolve', async (c) => {
  const { DB } = c.env
  const { insight_id } = c.req.param()
  
  try {
    await DB.prepare(`
      UPDATE feedback_insights 
      SET is_resolved = 1, resolved_at = CURRENT_TIMESTAMP
      WHERE insight_id = ?
    `).bind(insight_id).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Resolve insight error:', error)
    return c.json({ error: 'Failed to resolve insight' }, 500)
  }
})

// Admin: Generate AI insights for submissions
app.post('/api/admin/feedback/generate-insights/:property_id', async (c) => {
  const { DB } = c.env
  const { property_id } = c.req.param()
  
  try {
    // Get recent feedback submissions (last 7 days)
    const submissions = await DB.prepare(`
      SELECT s.*, f.form_name, 'form' as source
      FROM feedback_submissions s
      JOIN feedback_forms f ON s.form_id = f.form_id
      WHERE s.property_id = ? 
        AND s.submitted_at > datetime('now', '-7 days')
      ORDER BY s.submitted_at DESC
      LIMIT 50
    `).bind(property_id).all()
    
    // Get recent chatbot conversations with complaints (last 7 days)
    const chatFeedback = await DB.prepare(`
      SELECT 
        feedback_id,
        property_id,
        guest_name,
        room_number,
        complaint_category,
        complaint_summary,
        sentiment_label,
        is_urgent,
        is_complaint,
        detected_at as submitted_at,
        'chat' as source
      FROM chat_feedback
      WHERE property_id = ?
        AND detected_at > datetime('now', '-7 days')
        AND is_complaint = 1
      ORDER BY detected_at DESC
      LIMIT 50
    `).bind(property_id).all()
    
    const allFeedback = [...(submissions.results || []), ...(chatFeedback.results || [])]
    const chatCount = chatFeedback.results?.length || 0
    const formCount = submissions.results?.length || 0
    
    if (allFeedback.length === 0) {
      return c.json({ success: true, message: 'No recent feedback to analyze. Try chatting with guests or collecting form submissions!', insights: [] })
    }
    
    // Use AI API for advanced analysis
    const apiKey = c.env.OPENAI_API_KEY
    const baseURL = c.env.OPENAI_BASE_URL || 'https://www.genspark.ai/api/llm_proxy/v1'
    
    if (!apiKey) {
      return c.json({ 
        success: false, 
        message: 'AI API key not configured. Please add OPENAI_API_KEY to environment variables.',
        insights: []
      })
    }
    
    const insightsGenerated = []
    
    try {
      // Group all feedback
      const urgentFeedback = allFeedback.filter(f => f.is_urgent === 1)
      const negativeFeedback = allFeedback.filter(f => 
        (f.sentiment_label === 'negative' || f.is_complaint === 1) && f.is_urgent !== 1
      )
      
      // Generate insights for urgent issues (both form and chat)
      for (const item of urgentFeedback.slice(0, 5)) {
        let feedbackText = ''
        
        if (item.source === 'form') {
          const answers = await DB.prepare(`
            SELECT a.answer_text, q.question_text
            FROM feedback_answers a
            JOIN feedback_questions q ON a.question_id = q.question_id
            WHERE a.submission_id = ?
          `).bind(item.submission_id).all()
          feedbackText = answers.results.map(a => a.question_text + ': ' + (a.answer_text || 'N/A')).join('\\n')
        } else {
          feedbackText = 'Category: ' + (item.complaint_category || 'General') + '\\nIssue: ' + (item.complaint_summary || 'Guest complaint detected')
        }
        
        const prompt = 'Analyze this urgent guest issue and provide: 1) Brief summary, 2) Immediate action needed, 3) Follow-up steps. Be concise (max 150 words).\\n\\nSource: ' + (item.source === 'chat' ? 'AI Chatbot Conversation' : 'Feedback Form') + '\\nGuest: ' + (item.guest_name || 'Anonymous') + (item.room_number ? ' (Room ' + item.room_number + ')' : '') + '\\n\\n' + feedbackText
        
        const aiResponse = await fetch(baseURL + '/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              { role: 'system', content: 'You are a hotel manager assistant. Provide brief, actionable insights.' },
              { role: 'user', content: prompt }
            ],
            temperature: 0.7,
            max_tokens: 250
          })
        })
        
        if (aiResponse.ok) {
          const aiData = await aiResponse.json()
          const analysis = aiData.choices[0].message.content
          
          await DB.prepare(`
            INSERT INTO feedback_insights (
              property_id, submission_id, insight_type, title, description,
              action_suggested, priority
            ) VALUES (?, ?, ?, ?, ?, ?, ?)
          `).bind(
            property_id, 
            item.submission_id || null,
            'urgent',
            'URGENT: ' + (item.guest_name || 'Guest') + (item.room_number ? ' - Room ' + item.room_number : '') + ' (' + item.source + ')',
            analysis.substring(0, 500),
            'Contact guest immediately and resolve issue',
            'critical'
          ).run()
          
          insightsGenerated.push({ type: 'urgent', source: item.source })
        }
      }
      
      // Analyze negative trends across ALL feedback sources
      if (negativeFeedback.length >= 3) {
        const feedbackSummary = negativeFeedback.slice(0, 15).map(f => {
          if (f.source === 'chat') {
            return (f.complaint_category || 'issue') + ' complaint from chat'
          }
          return 'negative form response: ' + f.sentiment_label
        }).join('; ')
        
        const trendPrompt = 'Analyze these recent guest issues from feedback forms AND chatbot conversations. Identify 2-3 common themes and suggest improvements. Be concise.\\n\\nData points (' + negativeFeedback.length + ' total):\\n' + feedbackSummary
        
        const trendResponse = await fetch(baseURL + '/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              { role: 'system', content: 'You are a hotel analytics expert identifying patterns in guest feedback.' },
              { role: 'user', content: trendPrompt }
            ],
            temperature: 0.7,
            max_tokens: 300
          })
        })
        
        if (trendResponse.ok) {
          const trendData = await trendResponse.json()
          const trendAnalysis = trendData.choices[0].message.content
          
          await DB.prepare(`
            INSERT INTO feedback_insights (
              property_id, submission_id, insight_type, title, description,
              action_suggested, priority
            ) VALUES (?, NULL, ?, ?, ?, ?, ?)
          `).bind(
            property_id,
            'trend',
            'Negative Feedback Trend - ' + negativeFeedback.length + ' issues detected',
            trendAnalysis,
            'Review common issues and implement improvements',
            'high'
          ).run()
          
          insightsGenerated.push({ type: 'trend', count: negativeFeedback.length })
        }
      }
      
      // Generate overall sentiment summary
      if (allFeedback.length >= 5) {
        const summaryPrompt = 'Provide a brief executive summary of guest satisfaction based on: ' + formCount + ' feedback forms and ' + chatCount + ' chatbot conversations with complaints. Include overall sentiment and top recommendation. Max 100 words.'
        
        const summaryResponse = await fetch(baseURL + '/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              { role: 'system', content: 'You are a hotel management consultant providing executive summaries.' },
              { role: 'user', content: summaryPrompt }
            ],
            temperature: 0.7,
            max_tokens: 200
          })
        })
        
        if (summaryResponse.ok) {
          const summaryData = await summaryResponse.json()
          const summary = summaryData.choices[0].message.content
          
          await DB.prepare(`
            INSERT INTO feedback_insights (
              property_id, submission_id, insight_type, title, description,
              action_suggested, priority
            ) VALUES (?, NULL, ?, ?, ?, ?, ?)
          `).bind(
            property_id,
            'recommendation',
            'Guest Satisfaction Overview',
            summary,
            'Review detailed feedback and implement suggested improvements',
            'medium'
          ).run()
          
          insightsGenerated.push({ type: 'summary' })
        }
      }
      
    } catch (aiError) {
      console.error('AI insights generation error:', aiError)
      return c.json({ 
        success: false, 
        message: 'AI analysis failed: ' + aiError.message,
        insights: insightsGenerated
      })
    }
    
    return c.json({ 
      success: true, 
      message: 'Generated ' + insightsGenerated.length + ' insights from ' + allFeedback.length + ' feedback items (' + formCount + ' forms, ' + chatCount + ' chats)',
      insights: insightsGenerated,
      analyzed_count: allFeedback.length,
      sources: {
        forms: formCount,
        chats: chatCount
      }
    })
  } catch (error) {
    console.error('Generate insights error:', error)
    return c.json({ error: 'Failed to generate insights: ' + error.message }, 500)
  }
})

// ========== END FEEDBACK SYSTEM API ENDPOINTS ==========

// Hotel Landing Page - Main QR entry point
app.get('/hotel/:property_slug', async (c) => {
  const { property_slug } = c.req.param()
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">
        <title>Welcome</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style id="dynamic-styles">
          /* Dynamic styles will be injected here */
        </style>
        <style>
          body { 
            -webkit-font-smoothing: antialiased;
          }
          .offering-card {
            transition: all 0.3s ease;
          }
          .offering-card:active {
            transform: scale(0.98);
          }
          .category-pill {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
          }
          .category-pill:active {
            transform: scale(0.95);
          }
          .sticky-nav {
            position: sticky;
            top: 0;
            z-index: 40;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }
          
          /* Social Media Profile Style */
          .gradient-hero {
            position: relative;
            background-size: cover;
            background-position: center;
          }
          
          #propertyLogo img {
            transition: transform 0.3s ease;
          }
          
          #propertyLogo img:hover {
            transform: scale(1.05);
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Loading Spinner -->
        <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
                <p class="mt-4 text-gray-600">Loading your experience...</p>
            </div>
        </div>

        <div id="content" class="hidden">
            <!-- Hero Header - Facebook Profile Style -->
            <div class="relative bg-white">
                <!-- Cover Photo -->
                <div class="gradient-hero h-64 md:h-96 relative">
                    <!-- Info Button, Feedback Button & Language Selector - Top Right on Cover -->
                    <div class="absolute top-4 right-4 z-10 flex gap-2">
                        <!-- Feedback Button (only shows if active form exists) -->
                        <button id="feedbackButton" onclick="openFeedbackForm()" class="hidden px-4 py-2 bg-black text-white rounded-lg shadow-lg font-semibold transition-all hover:bg-gray-800 flex items-center gap-2" title="Share Your Feedback">
                            <i class="fas fa-comment-dots"></i>
                            <span class="hidden sm:inline">Feedback</span>
                        </button>
                        <button id="infoButton" onclick="openInfoMenu()" class="px-4 py-2 text-white rounded-lg shadow-lg font-semibold transition flex items-center gap-2" title="Hotel Information">
                            <i class="fas fa-info-circle"></i>
                            <span class="hidden sm:inline">Info</span>
                        </button>
                        <select id="languageSelector" class="px-3 py-2 bg-white/90 backdrop-blur-sm text-gray-800 rounded-lg shadow-lg text-sm cursor-pointer hover:bg-white transition" onchange="changeLanguage()">
                            <!-- Language options will be populated dynamically -->
                        </select>
                    </div>
                    <!-- Profile Picture - Overlaps at bottom left of cover -->
                    <div class="absolute bottom-0 left-4 md:left-8 translate-y-1/2">
                        <div id="propertyLogo" class="relative">
                            <!-- Logo placeholder - will be replaced if logo exists -->
                            <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-white shadow-lg border-4 border-white flex items-center justify-center">
                                <i class="fas fa-hotel text-2xl md:text-3xl text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Info Section -->
                <div class="pt-14 md:pt-20 pb-6 px-4 md:px-8">
                    <div class="max-w-6xl mx-auto">
                        <h1 class="text-2xl md:text-3xl font-bold mb-2 text-gray-900" id="propertyName">Paradise Resort</h1>
                        <p class="text-sm md:text-base text-gray-600 mb-4" id="propertyTagline">Discover all we have to offer</p>
                    </div>
                </div>
            </div>

            <!-- Category Filter Pills -->
            <div class="sticky-nav py-4 px-4 overflow-x-auto">
                <div class="max-w-6xl mx-auto flex gap-2 whitespace-nowrap" id="category-pills-container">
                    <button onclick="filterOfferings('all')" class="category-pill bg-blue-500 text-white" data-category="all">
                        <i class="fas fa-th-large mr-2"></i><span data-i18n="pill-all">All</span>
                    </button>
                    <button onclick="filterOfferings('restaurant')" class="category-pill bg-gray-200 text-gray-700" data-category="restaurant">
                        <i class="fas fa-utensils mr-2"></i><span id="pill-restaurants" data-i18n="pill-restaurants">Restaurants</span>
                    </button>
                    <button onclick="filterOfferings('event')" class="category-pill bg-gray-200 text-gray-700" data-category="event">
                        <i class="fas fa-calendar-star mr-2"></i><span id="pill-events" data-i18n="pill-events">Events</span>
                    </button>
                    <button onclick="filterOfferings('spa')" class="category-pill bg-gray-200 text-gray-700" data-category="spa">
                        <i class="fas fa-spa mr-2"></i><span id="pill-spa" data-i18n="pill-spa">Spa</span>
                    </button>
                    <button onclick="filterOfferings('service')" class="category-pill bg-gray-200 text-gray-700" data-category="service">
                        <i class="fas fa-concierge-bell mr-2"></i><span id="pill-services" data-i18n="pill-services">Services</span>
                    </button>
                    <button onclick="filterOfferings('activities')" class="category-pill bg-gray-200 text-gray-700" data-category="activities">
                        <i class="fas fa-hiking mr-2"></i><span id="pill-activities" data-i18n="pill-activities">Activities</span>
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="max-w-6xl mx-auto px-4 py-6 pb-20">
                
                <!-- Hotel Restaurants Section -->
                <section id="restaurants-section" class="mb-12">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-utensils text-blue-500 mr-3"></i>
                        <span id="section-heading-restaurants">Dining & Drinks</span>
                    </h2>
                    <div id="restaurants-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Loaded dynamically -->
                    </div>
                </section>

                <!-- Upcoming Events Section -->
                <section id="events-section" class="mb-12">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-calendar-star text-purple-500 mr-3"></i>
                        <span id="section-heading-events">Upcoming Events</span>
                    </h2>
                    <div id="events-grid" class="grid grid-cols-1 gap-4">
                        <!-- Loaded dynamically -->
                    </div>
                </section>

                <!-- Spa & Wellness Section -->
                <section id="spa-section" class="mb-12">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-spa text-green-500 mr-3"></i>
                        <span id="section-heading-spa">Spa & Wellness</span>
                    </h2>
                    <div id="spa-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Loaded dynamically -->
                    </div>
                </section>

                <!-- Hotel Services Section -->
                <section id="service-section" class="mb-12">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-concierge-bell text-indigo-500 mr-3"></i>
                        <span id="section-heading-service">Facilities & Amenities</span>
                    </h2>
                    <div id="service-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Loaded dynamically -->
                    </div>
                </section>

                <!-- Vendor Activities Section -->
                <section id="activities-section" class="mb-12">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-hiking text-orange-500 mr-3"></i>
                        <span id="section-heading-activities">Activities & Experiences</span>
                    </h2>
                    <p class="text-gray-600 mb-4 text-sm" data-i18n="curated-experiences">Curated experiences from our trusted partners</p>
                    <div id="activities-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Loaded dynamically -->
                    </div>
                </section>

                <!-- Beach Booking Section -->
                <section id="beach-booking-section" class="mb-12 hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl p-8 shadow-xl">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                            <div class="flex-1">
                                <h2 class="text-3xl font-bold mb-3 flex items-center">
                                    <i class="fas fa-umbrella-beach mr-3"></i>
                                    Beach Booking
                                </h2>
                                <p class="mb-4">
                                    Reserve your perfect spot by the sea! Select from umbrellas, cabanas, and premium locations.
                                </p>
                                <div class="flex flex-wrap gap-3 text-sm">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Free for Hotel Guests</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-clock"></i>
                                        <span>Book Up to 7 Days Ahead</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-qrcode"></i>
                                        <span>QR Code Check-in</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button onclick="goToBeachBooking()" class="bg-white text-blue-600 px-8 py-4 rounded-xl font-bold text-lg hover:bg-blue-50 transition shadow-lg transform hover:scale-105">
                                    <i class="fas fa-calendar-check mr-2"></i>
                                    Book Your Spot Now
                                </button>
                            </div>
                        </div>
                        
                        <!-- Beach Spots Preview -->
                        <div id="beach-spots-preview" class="mt-6 pt-6 border-t border-white/20">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                    <div class="text-3xl mb-2">ðŸ”µ</div>
                                    <div class="font-semibold">Umbrellas</div>
                                    <div class="text-sm">Classic Beach</div>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                    <div class="text-3xl mb-2">ðŸŸ¢</div>
                                    <div class="font-semibold">Cabanas</div>
                                    <div class="text-sm">Private & Cozy</div>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                    <div class="text-3xl mb-2">ðŸŸ¡</div>
                                    <div class="font-semibold">Loungers</div>
                                    <div class="text-sm">Relax in Style</div>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                    <div class="text-3xl mb-2">ðŸŸ£</div>
                                    <div class="font-semibold">Daybeds</div>
                                    <div class="text-sm">Ultimate Comfort</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
            </div>
        </div>

        <!-- Floating Map Button (appears when map available) -->
        <button id="mapFloatingBtn" 
                onclick="openMapModal()" 
                class="fixed bottom-6 right-6 text-white px-6 py-3 rounded-full shadow-2xl transition-all transform hover:scale-105 z-50 hidden">
            <i class="fas fa-map-marked-alt mr-2"></i>
            <span class="font-semibold">Hotel Map</span>
        </button>

        <!-- Map Modal -->
        <div id="mapModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-auto">
                <button onclick="closeMapModal()" 
                        class="absolute top-4 right-4 bg-white hover:bg-gray-100 text-gray-800 w-10 h-10 rounded-full shadow-lg z-10 flex items-center justify-center">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <div class="p-6">
                    <h2 class="text-3xl font-bold mb-4 flex items-center">
                        <i id="mapModalIcon" class="fas fa-map mr-3"></i>
                        Hotel Map & Layout
                    </h2>
                    <div id="hotel-map-container" class="rounded-xl overflow-hidden">
                        <!-- Loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
        const propertySlug = '${property_slug}';
        window.propertySlug = propertySlug; // Make available globally for inline handlers
        
        let propertyData = null;
        let allOfferings = [];
        let allActivities = [];
        let customSections = [];
        let currentFilter = 'all';
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'en';
        console.log('ðŸŒ Current language loaded:', currentLanguage);
        
        // Expose propertyData to window so chatbot and other functions can access it
        Object.defineProperty(window, 'propertyData', {
            get: () => propertyData,
            set: (value) => { propertyData = value; }
        });
        
        // Track QR code scan on page load
        async function trackQRScan() {
          try {
            await fetch('/api/track-scan', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                property_id: propertyData?.property_id || 1
              })
            });
          } catch (error) {
            console.error('Failed to track scan:', error);
          }
        }
        
        // Track page view
        async function trackPageView(pageType, pageId) {
          try {
            await fetch('/api/track-page-view', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                property_id: propertyData?.property_id || 1,
                page_type: pageType,
                page_id: pageId
              })
            });
          } catch (error) {
            console.error('Failed to track page view:', error);
          }
        }
        
        // Translation dictionaries for UI elements
        const uiTranslations = {
            en: {
                'pill-all': 'All',
                'pill-restaurants': 'Restaurants',
                'pill-events': 'Events',
                'pill-spa': 'Spa',
                'pill-services': 'Services',
                'pill-activities': 'Activities',
                'book-now': 'BOOK NOW',
                'book-table': 'Book Table',
                'reservations': 'Reservations',
                'explore-menu': 'Explore Menu',
                'learn-more': 'Learn More',
                'discover': 'Discover',
                'view-details': 'View Details',
                'explore-more': 'Explore More',
                'curated-by': 'Curated by',
                'minutes': 'minutes',
                'activities-experiences': 'Activities & Experiences',
                'curated-experiences': 'Curated experiences from our trusted partners',
                'hotel-map': 'Hotel Map & Layout',
                'no-restaurants': 'No restaurants available',
                'no-events': 'No upcoming events',
                'no-spa': 'No spa services available',
                'no-services': 'No services available',
                'no-activities': 'No activities available',
                'no-items': 'No items available in this section'
            },
            es: {
                'book-now': 'RESERVAR AHORA',
                'book-table': 'Reservar Mesa',
                'reservations': 'Reservas',
                'explore-menu': 'Explorar Men\u00fa',
                'learn-more': 'Saber M\u00e1s',
                'discover': 'Descubrir',
                'view-details': 'Ver Detalles',
                'explore-more': 'Explorar M\u00e1s',
                'curated-by': 'Curado por',
                'minutes': 'minutos',
                'activities-experiences': 'Actividades y Experiencias',
                'curated-experiences': 'Experiencias seleccionadas de nuestros socios de confianza',
                'hotel-map': 'Mapa y Dise\u00f1o del Hotel',
                'no-restaurants': 'No hay restaurantes disponibles',
                'no-events': 'No hay eventos pr\u00f3ximos',
                'no-spa': 'No hay servicios de spa disponibles',
                'no-services': 'No hay servicios disponibles',
                'no-activities': 'No hay actividades disponibles',
                'no-items': 'No hay elementos disponibles en esta secci\u00f3n'
            },
            fr: {
                'book-now': 'R\u00c9SERVER MAINTENANT',
                'book-table': 'R\u00e9server une Table',
                'reservations': 'R\u00e9servations',
                'explore-menu': 'Explorer le Menu',
                'learn-more': 'En Savoir Plus',
                'discover': 'D\u00e9couvrir',
                'view-details': 'Voir les D\u00e9tails',
                'explore-more': 'Explorer Plus',
                'curated-by': 'S\u00e9lectionn\u00e9 par',
                'minutes': 'minutes',
                'activities-experiences': 'Activit\u00e9s et Exp\u00e9riences',
                'curated-experiences': 'Exp\u00e9riences s\u00e9lectionn\u00e9es par nos partenaires de confiance',
                'hotel-map': 'Plan et Agencement de l\\'H\u00f4tel',
                'no-restaurants': 'Aucun restaurant disponible',
                'no-events': 'Aucun \u00e9v\u00e9nement \u00e0 venir',
                'no-spa': 'Aucun service de spa disponible',
                'no-services': 'Aucun service disponible',
                'no-activities': 'Aucune activit\u00e9 disponible',
                'no-items': 'Aucun \u00e9l\u00e9ment disponible dans cette section'
            },
            de: {
                'book-now': 'JETZT BUCHEN',
                'book-table': 'Tisch Reservieren',
                'reservations': 'Reservierungen',
                'explore-menu': 'Men\u00fc Erkunden',
                'learn-more': 'Mehr Erfahren',
                'discover': 'Entdecken',
                'view-details': 'Details Anzeigen',
                'explore-more': 'Mehr Erkunden',
                'curated-by': 'Kuratiert von',
                'minutes': 'Minuten',
                'activities-experiences': 'Aktivit\u00e4ten und Erlebnisse',
                'curated-experiences': 'Ausgew\u00e4hlte Erlebnisse von unseren vertrauensw\u00fcrdigen Partnern',
                'hotel-map': 'Hotelplan und Layout',
                'no-restaurants': 'Keine Restaurants verf\u00fcgbar',
                'no-events': 'Keine bevorstehenden Veranstaltungen',
                'no-spa': 'Keine Spa-Dienstleistungen verf\u00fcgbar',
                'no-services': 'Keine Dienstleistungen verf\u00fcgbar',
                'no-activities': 'Keine Aktivit\u00e4ten verf\u00fcgbar',
                'no-items': 'Keine Elemente in diesem Bereich verf\u00fcgbar'
            },
            it: {
                'book-now': 'PRENOTA ORA',
                'book-table': 'Prenota Tavolo',
                'reservations': 'Prenotazioni',
                'explore-menu': 'Esplora il Menu',
                'learn-more': 'Scopri di Pi\u00f9',
                'discover': 'Scopri',
                'view-details': 'Vedi Dettagli',
                'explore-more': 'Esplora di Pi\u00f9',
                'curated-by': 'Curato da',
                'minutes': 'minuti',
                'activities-experiences': 'Attivit\u00e0 ed Esperienze',
                'curated-experiences': 'Esperienze selezionate dai nostri partner fidati',
                'hotel-map': 'Mappa e Layout dell\\'Hotel',
                'no-restaurants': 'Nessun ristorante disponibile',
                'no-events': 'Nessun evento in arrivo',
                'no-spa': 'Nessun servizio spa disponibile',
                'no-services': 'Nessun servizio disponibile',
                'no-activities': 'Nessuna attivit\u00e0 disponibile',
                'no-items': 'Nessun elemento disponibile in questa sezione'
            },
            pt: {
                'book-now': 'RESERVAR AGORA',
                'book-table': 'Reservar Mesa',
                'reservations': 'Reservas',
                'explore-menu': 'Explorar Menu',
                'learn-more': 'Saiba Mais',
                'discover': 'Descobrir',
                'view-details': 'Ver Detalhes',
                'explore-more': 'Explorar Mais',
                'curated-by': 'Selecionado por',
                'minutes': 'minutos',
                'activities-experiences': 'Atividades e Experi\u00eancias',
                'curated-experiences': 'Experi\u00eancias selecionadas de nossos parceiros confi\u00e1veis',
                'hotel-map': 'Mapa e Layout do Hotel',
                'no-restaurants': 'Nenhum restaurante dispon\u00edvel',
                'no-events': 'Nenhum evento pr\u00f3ximo',
                'no-spa': 'Nenhum servi\u00e7o de spa dispon\u00edvel',
                'no-services': 'Nenhum servi\u00e7o dispon\u00edvel',
                'no-activities': 'Nenhuma atividade dispon\u00edvel',
                'no-items': 'Nenhum item dispon\u00edvel nesta se\u00e7\u00e3o'
            },
            ru: {
                'book-now': '\u0417\u0410\u0411\u0420\u041e\u041d\u0418\u0420\u041e\u0412\u0410\u0422\u042c \u0421\u0415\u0419\u0427\u0410\u0421',
                'book-table': '\u0417\u0430\u0431\u0440\u043e\u043d\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0441\u0442\u043e\u043b\u0438\u043a',
                'reservations': '\u0411\u0440\u043e\u043d\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f',
                'explore-menu': '\u041f\u043e\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u043c\u0435\u043d\u044e',
                'learn-more': '\u0423\u0437\u043d\u0430\u0442\u044c \u0431\u043e\u043b\u044c\u0448\u0435',
                'discover': '\u041e\u0442\u043a\u0440\u044b\u0442\u044c',
                'view-details': '\u041f\u043e\u0434\u0440\u043e\u0431\u043d\u043e\u0441\u0442\u0438',
                'explore-more': '\u0418\u0441\u0441\u043b\u0435\u0434\u043e\u0432\u0430\u0442\u044c \u0431\u043e\u043b\u044c\u0448\u0435',
                'curated-by': '\u041f\u043e\u0434\u043e\u0431\u0440\u0430\u043d\u043e',
                'minutes': '\u043c\u0438\u043d\u0443\u0442',
                'activities-experiences': '\u0410\u043a\u0442\u0438\u0432\u043d\u043e\u0441\u0442\u0438 \u0438 \u043e\u043f\u044b\u0442',
                'curated-experiences': '\u0422\u0449\u0430\u0442\u0435\u043b\u044c\u043d\u043e \u043e\u0442\u043e\u0431\u0440\u0430\u043d\u043d\u044b\u0435 \u0432\u043f\u0435\u0447\u0430\u0442\u043b\u0435\u043d\u0438\u044f \u043e\u0442 \u043d\u0430\u0448\u0438\u0445 \u043d\u0430\u0434\u0435\u0436\u043d\u044b\u0445 \u043f\u0430\u0440\u0442\u043d\u0435\u0440\u043e\u0432',
                'hotel-map': '\u041a\u0430\u0440\u0442\u0430 \u0438 \u043f\u043b\u0430\u043d\u0438\u0440\u043e\u0432\u043a\u0430 \u043e\u0442\u0435\u043b\u044f',
                'no-restaurants': '\u0420\u0435\u0441\u0442\u043e\u0440\u0430\u043d\u044b \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b',
                'no-events': '\u041d\u0435\u0442 \u043f\u0440\u0435\u0434\u0441\u0442\u043e\u044f\u0449\u0438\u0445 \u0441\u043e\u0431\u044b\u0442\u0438\u0439',
                'no-spa': '\u0421\u043f\u0430-\u0443\u0441\u043b\u0443\u0433\u0438 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b',
                'no-services': '\u0423\u0441\u043b\u0443\u0433\u0438 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b',
                'no-activities': '\u0410\u043a\u0442\u0438\u0432\u043d\u043e\u0441\u0442\u0438 \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b',
                'no-items': '\u041d\u0435\u0442 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u0432 \u044d\u0442\u043e\u043c \u0440\u0430\u0437\u0434\u0435\u043b\u0435'
            },
            ar: {
                'book-now': '\u0627\u062d\u062c\u0632 \u0627\u0644\u0622\u0646',
                'book-table': '\u0627\u062d\u062c\u0632 \u0637\u0627\u0648\u0644\u0629',
                'reservations': '\u0627\u0644\u062d\u062c\u0648\u0632\u0627\u062a',
                'explore-menu': '\u0627\u0633\u062a\u0643\u0634\u0641 \u0627\u0644\u0642\u0627\u0626\u0645\u0629',
                'learn-more': '\u0627\u0639\u0631\u0641 \u0627\u0644\u0645\u0632\u064a\u062f',
                'discover': '\u0627\u0643\u062a\u0634\u0641',
                'view-details': '\u0639\u0631\u0636 \u0627\u0644\u062a\u0641\u0627\u0635\u064a\u0644',
                'explore-more': '\u0627\u0633\u062a\u0643\u0634\u0641 \u0627\u0644\u0645\u0632\u064a\u062f',
                'curated-by': '\u0645\u0646\u062a\u0642\u0649 \u0645\u0646',
                'minutes': '\u062f\u0642\u0627\u0626\u0642',
                'activities-experiences': '\u0627\u0644\u0623\u0646\u0634\u0637\u0629 \u0648\u0627\u0644\u062a\u062c\u0627\u0631\u0628',
                'curated-experiences': '\u062a\u062c\u0627\u0631\u0628 \u0645\u0646\u062a\u0642\u0627\u0629 \u0645\u0646 \u0634\u0631\u0643\u0627\u0626\u0646\u0627 \u0627\u0644\u0645\u0648\u062b\u0648\u0642\u064a\u0646',
                'hotel-map': '\u062e\u0631\u064a\u0637\u0629 \u0648\u062a\u0635\u0645\u064a\u0645 \u0627\u0644\u0641\u0646\u062f\u0642',
                'no-restaurants': '\u0644\u0627 \u062a\u0648\u062c\u062f \u0645\u0637\u0627\u0639\u0645 \u0645\u062a\u0627\u062d\u0629',
                'no-events': '\u0644\u0627 \u062a\u0648\u062c\u062f \u0641\u0639\u0627\u0644\u064a\u0627\u062a \u0642\u0627\u062f\u0645\u0629',
                'no-spa': '\u0644\u0627 \u062a\u0648\u062c\u062f \u062e\u062f\u0645\u0627\u062a \u0633\u0628\u0627 \u0645\u062a\u0627\u062d\u0629',
                'no-services': '\u0644\u0627 \u062a\u0648\u062c\u062f \u062e\u062f\u0645\u0627\u062a \u0645\u062a\u0627\u062d\u0629',
                'no-activities': '\u0644\u0627 \u062a\u0648\u062c\u062f \u0623\u0646\u0634\u0637\u0629 \u0645\u062a\u0627\u062d\u0629',
                'no-items': '\u0644\u0627 \u062a\u0648\u062c\u062f \u0639\u0646\u0627\u0635\u0631 \u0645\u062a\u0627\u062d\u0629 \u0641\u064a \u0647\u0630\u0627 \u0627\u0644\u0642\u0633\u0645'
            },
            zh: {
                'book-now': '\u7acb\u5373\u9884\u8ba2',
                'book-table': '\u9884\u8ba2\u9910\u684c',
                'reservations': '\u9884\u8ba2',
                'explore-menu': '\u63a2\u7d22\u83dc\u5355',
                'learn-more': '\u4e86\u89e3\u66f4\u591a',
                'discover': '\u53d1\u73b0',
                'view-details': '\u67e5\u770b\u8be6\u60c5',
                'explore-more': '\u63a2\u7d22\u66f4\u591a',
                'curated-by': '\u7cbe\u9009\u81ea',
                'minutes': '\u5206\u949f',
                'activities-experiences': '\u6d3b\u52a8\u548c\u4f53\u9a8c',
                'curated-experiences': '\u7531\u6211\u4eec\u7684\u53ef\u4fe1\u8d56\u5408\u4f5c\u4f19\u4f34\u7cbe\u9009\u7684\u4f53\u9a8c',
                'hotel-map': '\u9152\u5e97\u5730\u56fe\u548c\u5e03\u5c40',
                'no-restaurants': '\u6ca1\u6709\u53ef\u7528\u7684\u9910\u5385',
                'no-events': '\u6ca1\u6709\u5373\u5c06\u4e3e\u884c\u7684\u6d3b\u52a8',
                'no-spa': '\u6ca1\u6709\u53ef\u7528\u7684\u6c34\u7597\u670d\u52a1',
                'no-services': '\u6ca1\u6709\u53ef\u7528\u7684\u670d\u52a1',
                'no-activities': '\u6ca1\u6709\u53ef\u7528\u7684\u6d3b\u52a8',
                'no-items': '\u6b64\u90e8\u5206\u4e2d\u6ca1\u6709\u53ef\u7528\u9879\u76ee'
            },
            ja: {
                'book-now': '\u4eca\u3059\u3050\u4e88\u7d04',
                'book-table': '\u30c6\u30fc\u30d6\u30eb\u4e88\u7d04',
                'reservations': '\u4e88\u7d04',
                'explore-menu': '\u30e1\u30cb\u30e5\u30fc\u3092\u898b\u308b',
                'learn-more': '\u3082\u3063\u3068\u8a73\u3057\u304f',
                'discover': '\u767a\u898b\u3059\u308b',
                'view-details': '\u8a73\u7d30\u3092\u898b\u308b',
                'explore-more': '\u3082\u3063\u3068\u63a2\u3059',
                'curated-by': '\u53b3\u9078\uff1a',
                'minutes': '\u5206',
                'activities-experiences': '\u30a2\u30af\u30c6\u30a3\u30d3\u30c6\u30a3\u3068\u4f53\u9a13',
                'curated-experiences': '\u4fe1\u983c\u3067\u304d\u308b\u30d1\u30fc\u30c8\u30ca\u30fc\u306b\u3088\u308b\u53b3\u9078\u3055\u308c\u305f\u4f53\u9a13',
                'hotel-map': '\u30db\u30c6\u30eb\u30de\u30c3\u30d7\u3068\u30ec\u30a4\u30a2\u30a6\u30c8',
                'no-restaurants': '\u5229\u7528\u53ef\u80fd\u306a\u30ec\u30b9\u30c8\u30e9\u30f3\u306f\u3042\u308a\u307e\u305b\u3093',
                'no-events': '\u4eca\u5f8c\u306e\u30a4\u30d9\u30f3\u30c8\u306f\u3042\u308a\u307e\u305b\u3093',
                'no-spa': '\u5229\u7528\u53ef\u80fd\u306a\u30b9\u30d1\u30b5\u30fc\u30d3\u30b9\u306f\u3042\u308a\u307e\u305b\u3093',
                'no-services': '\u5229\u7528\u53ef\u80fd\u306a\u30b5\u30fc\u30d3\u30b9\u306f\u3042\u308a\u307e\u305b\u3093',
                'no-activities': '\u5229\u7528\u53ef\u80fd\u306a\u30a2\u30af\u30c6\u30a3\u30d3\u30c6\u30a3\u306f\u3042\u308a\u307e\u305b\u3093',
                'no-items': '\u3053\u306e\u30bb\u30af\u30b7\u30e7\u30f3\u306b\u306f\u5229\u7528\u53ef\u80fd\u306a\u30a2\u30a4\u30c6\u30e0\u304c\u3042\u308a\u307e\u305b\u3093'
            },
            ko: {
                'book-now': '\uc9c0\uae08 \uc608\uc57d',
                'book-table': '\ud14c\uc774\ube14 \uc608\uc57d',
                'reservations': '\uc608\uc57d',
                'explore-menu': '\uba54\ub274 \ubcf4\uae30',
                'learn-more': '\uc790\uc138\ud788 \ubcf4\uae30',
                'discover': '\ubc1c\uacac\ud558\uae30',
                'view-details': '\uc0c1\uc138 \uc815\ubcf4',
                'explore-more': '\ub354 \uc54c\uc544\ubcf4\uae30',
                'curated-by': '\ud050\ub808\uc774\ud305:',
                'minutes': '\ubd84',
                'activities-experiences': '\uc561\ud2f0\ube44\ud2f0 \ubc0f \uccb4\ud5d8',
                'curated-experiences': '\uc2e0\ub8b0\ud560 \uc218 \uc788\ub294 \ud30c\ud2b8\ub108\uac00 \uc5c4\uc120\ud55c \uacbd\ud5d8',
                'hotel-map': '\ud638\ud154 \uc9c0\ub3c4 \ubc0f \ub808\uc774\uc544\uc6c3',
                'no-restaurants': '\uc774\uc6a9 \uac00\ub2a5\ud55c \ub808\uc2a4\ud1a0\ub791\uc774 \uc5c6\uc2b5\ub2c8\ub2e4',
                'no-events': '\uc608\uc815\ub41c \uc774\ubca4\ud2b8\uac00 \uc5c6\uc2b5\ub2c8\ub2e4',
                'no-spa': '\uc774\uc6a9 \uac00\ub2a5\ud55c \uc2a4\ud30c \uc11c\ube44\uc2a4\uac00 \uc5c6\uc2b5\ub2c8\ub2e4',
                'no-services': '\uc774\uc6a9 \uac00\ub2a5\ud55c \uc11c\ube44\uc2a4\uac00 \uc5c6\uc2b5\ub2c8\ub2e4',
                'no-activities': '\uc774\uc6a9 \uac00\ub2a5\ud55c \uc561\ud2f0\ube44\ud2f0\uac00 \uc5c6\uc2b5\ub2c8\ub2e4',
                'no-items': '\uc774 \uc139\uc158\uc5d0\ub294 \uc774\uc6a9 \uac00\ub2a5\ud55c \ud56d\ubaa9\uc774 \uc5c6\uc2b5\ub2c8\ub2e4'
            },
            pl: {
                'book-now': 'ZAREZERWUJ TERAZ',
                'book-table': 'Zarezerwuj Stolik',
                'reservations': 'Rezerwacje',
                'explore-menu': 'Przejrzyj Menu',
                'learn-more': 'Dowiedz Si\u0119 Wi\u0119cej',
                'discover': 'Odkryj',
                'view-details': 'Zobacz Szczeg\u00f3\u0142y',
                'explore-more': 'Odkryj Wi\u0119cej',
                'curated-by': 'Wybrane przez',
                'minutes': 'minut',
                'activities-experiences': 'ZajÄ™cia i Do\u015bwiadczenia',
                'curated-experiences': 'Starannie dobrane do\u015bwiadczenia od naszych zaufanych partnerÃ³w',
                'hotel-map': 'Mapa i Uk\u0142ad Hotelu',
                'no-restaurants': 'Brak dost\u0119pnych restauracji',
                'no-events': 'Brak nadchodz\u0105cych wydarze\u0144',
                'no-spa': 'Brak dost\u0119pnych us\u0142ug spa',
                'no-services': 'Brak dost\u0119pnych us\u0142ug',
                'no-activities': 'Brak dost\u0119pnych zaj\u0119\u0107',
                'no-items': 'Brak dost\u0119pnych elementÃ³w w tej sekcji'
            },
            cs: {
                'book-now': 'REZERVOVAT NYNÄ‚\u00cd',
                'book-table': 'Rezervovat St\u016fl',
                'reservations': 'Rezervace',
                'explore-menu': 'Prozkoumat Menu',
                'learn-more': 'Zjistit V\u00edce',
                'discover': 'Objevit',
                'view-details': 'Zobrazit Podrobnosti',
                'explore-more': 'Prozkoumat V\u00edce',
                'curated-by': 'VybrÃ¡no',
                'minutes': 'minut',
                'activities-experiences': 'Aktivity a Z\u00e1\u017eitky',
                'curated-experiences': 'VybranÃ© z\u00e1\u017eitky od na\u0161ich d\u016fv\u011bryhodnÃ½ch partner\u016f',
                'hotel-map': 'Mapa a Rozlo\u017een\u00ed Hotelu',
                'no-restaurants': '\u017d\u00e1dn\u00e9 dostupn\u00e9 restaurace',
                'no-events': '\u017d\u00e1dn\u00e9 nad choz\u00edc\u00ed ud\u00e1losti',
                'no-spa': '\u017d\u00e1dn\u00e9 dostupn\u00e9 spa slu\u017eby',
                'no-services': '\u017d\u00e1dn\u00e9 dostupn\u00e9 slu\u017eby',
                'no-activities': '\u017d\u00e1dn\u00e9 dostupn\u00e9 aktivity',
                'no-items': '\u017d\u00e1dn\u00e9 dostupn\u00e9 polo\u017eky v t\u00e9to sekci'
            },
            uk: {
                'book-now': '\u0417\u0410\u0411\u0420\u041e\u041d\u042e\u0412\u0410\u0422\u0418 \u0417\u0410\u0420\u0410\u0417',
                'book-table': '\u0417\u0430\u0431\u0440\u043e\u043d\u044e\u0432\u0430\u0442\u0438 \u0421\u0442\u0456\u043b',
                'reservations': '\u0411\u0440\u043e\u043d\u044e\u0432\u0430\u043d\u043d\u044f',
                'explore-menu': '\u041f\u0435\u0440\u0435\u0433\u043b\u044f\u043d\u0443\u0442\u0438 \u041c\u0435\u043d\u044e',
                'learn-more': '\u0414\u0456\u0437\u043d\u0430\u0442\u0438\u0441\u044f \u0411\u0456\u043b\u044c\u0448\u0435',
                'discover': '\u0412\u0456\u0434\u043a\u0440\u0438\u0442\u0438',
                'view-details': '\u041f\u0435\u0440\u0435\u0433\u043b\u044f\u043d\u0443\u0442\u0438 \u0414\u0435\u0442\u0430\u043b\u0456',
                'explore-more': '\u0414\u043e\u0441\u043b\u0456\u0434\u0438\u0442\u0438 \u0411\u0456\u043b\u044c\u0448\u0435',
                'curated-by': '\u0412\u0456\u0434\u0456\u0431\u0440\u0430\u043d\u043e',
                'minutes': '\u0445\u0432\u0438\u043b\u0438\u043d',
                'activities-experiences': '\u0410\u043a\u0442\u0438\u0432\u043d\u043e\u0441\u0442\u0456 \u0442\u0430 \u0412\u0440\u0430\u0436\u0435\u043d\u043d\u044f',
                'curated-experiences': '\u0412\u0456\u0434\u0456\u0431\u0440\u0430\u043d\u0456 \u0432\u0440\u0430\u0436\u0435\u043d\u043d\u044f \u0432\u0456\u0434 \u043d\u0430\u0448\u0438\u0445 \u043d\u0430\u0434\u0456\u0439\u043d\u0438\u0445 \u043f\u0430\u0440\u0442\u043d\u0435\u0440\u0456\u0432',
                'hotel-map': '\u041a\u0430\u0440\u0442\u0430 \u0442\u0430 \u041f\u043b\u0430\u043d\u0443\u0432\u0430\u043d\u043d\u044f \u0413\u043e\u0442\u0435\u043b\u044e',
                'no-restaurants': '\u041d\u0435\u043c\u0430\u0454 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0438\u0445 \u0440\u0435\u0441\u0442\u043e\u0440\u0430\u043d\u0456\u0432',
                'no-events': '\u041d\u0435\u043c\u0430\u0454 \u043c\u0430\u0439\u0431\u0443\u0442\u043d\u0456\u0445 \u043f\u043e\u0434\u0456\u0439',
                'no-spa': '\u041d\u0435\u043c\u0430\u0454 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0438\u0445 \u0441\u043f\u0430-\u043f\u043e\u0441\u043b\u0443\u0433',
                'no-services': '\u041d\u0435\u043c\u0430\u0454 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0438\u0445 \u043f\u043e\u0441\u043b\u0443\u0433',
                'no-activities': '\u041d\u0435\u043c\u0430\u0454 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0438\u0445 \u0430\u043a\u0442\u0438\u0432\u043d\u043e\u0441\u0442\u0435\u0439',
                'no-items': '\u041d\u0435\u043c\u0430\u0454 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0438\u0445 \u0435\u043b\u0435\u043c\u0435\u043d\u0442\u0456\u0432 \u0443 \u0446\u044c\u043e\u043c\u0443 \u0440\u043e\u0437\u0434\u0456\u043b\u0456'
            },
            hi: {
                'book-now': '\u0905\u092d\u0940 \u092c\u0941\u0915 \u0915\u0930\u0947\u0902',
                'book-table': '\u091f\u0947\u092c\u0932 \u092c\u0941\u0915 \u0915\u0930\u0947\u0902',
                'reservations': '\u0906\u0930\u0915\u094d\u0937\u0923',
                'explore-menu': '\u092e\u0947\u0928\u0942 \u0926\u0947\u0916\u0947\u0902',
                'learn-more': '\u0914\u0930 \u091c\u093e\u0928\u0947\u0902',
                'discover': '\u0916\u094b\u091c\u0947\u0902',
                'view-details': '\u0935\u093f\u0935\u0930\u0923 \u0926\u0947\u0916\u0947\u0902',
                'explore-more': '\u0905\u0927\u093f\u0915 \u0916\u094b\u091c\u0947\u0902',
                'curated-by': '\u0926\u094d\u0935\u093e\u0930\u093e \u091a\u092f\u0928\u093f\u0924',
                'minutes': '\u092e\u093f\u0928\u091f',
                'activities-experiences': '\u0917\u0924\u093f\u0935\u093f\u0927\u093f\u092f\u093e\u0902 \u0914\u0930 \u0905\u0928\u0941\u092d\u0935',
                'curated-experiences': '\u0939\u092e\u093e\u0930\u0947 \u0935\u093f\u0936\u094d\u0935\u0938\u0928\u0940\u092f \u092d\u093e\u0917\u0940\u0926\u093e\u0930\u094b\u0902 \u0938\u0947 \u091a\u092f\u0928\u093f\u0924 \u0905\u0928\u0941\u092d\u0935',
                'hotel-map': '\u0939\u094b\u091f\u0932 \u092e\u093e\u0928\u091a\u093f\u0924\u094d\u0930 \u0914\u0930 \u0932\u0947\u0906\u0909\u091f',
                'no-restaurants': '\u0915\u094b\u0908 \u0930\u0947\u0938\u094d\u0924\u0930\u093e\u0902 \u0909\u092a\u0932\u092c\u094d\u0927 \u0928\u0939\u0940\u0902',
                'no-events': '\u0915\u094b\u0908 \u0906\u0917\u093e\u092e\u0940 \u0915\u093e\u0930\u094d\u092f\u0915\u094d\u0930\u092e \u0928\u0939\u0940\u0902',
                'no-spa': '\u0915\u094b\u0908 \u0938\u094d\u092a\u093e \u0938\u0947\u0935\u093e\u090f\u0902 \u0909\u092a\u0932\u092c\u094d\u0927 \u0928\u0939\u0940\u0902',
                'no-services': '\u0915\u094b\u0908 \u0938\u0947\u0935\u093e\u090f\u0902 \u0909\u092a\u0932\u092c\u094d\u0927 \u0928\u0939\u0940\u0902',
                'no-activities': '\u0915\u094b\u0908 \u0917\u0924\u093f\u0935\u093f\u0927\u093f\u092f\u093e\u0902 \u0909\u092a\u0932\u092c\u094d\u0927 \u0928\u0939\u0940\u0902',
                'no-items': '\u0907\u0938 \u0905\u0928\u0941\u092d\u093e\u0917 \u092e\u0947\u0902 \u0915\u094b\u0908 \u0906\u0907\u091f\u092e \u0909\u092a\u0932\u092c\u094d\u0927 \u0928\u0939\u0940\u0902'
            },
            tr: {
                'book-now': '\u015e\u0130MD\u0130 REZERVE ED\u0130N',
                'book-table': 'Masa Rezerve Edin',
                'reservations': 'Rezervasyonlar',
                'explore-menu': 'Men\u00fcy\u00fc Ke\u015ffedin',
                'learn-more': 'Daha Fazla Bilgi',
                'discover': 'Ke\u015ffedin',
                'view-details': 'Detaylar\u0131 G\u00f6r\u00fcnt\u00fcle',
                'explore-more': 'Daha Fazla Ke\u015ffedin',
                'curated-by': 'Taraf\u0131ndan Se\u00e7ilmi\u015f',
                'minutes': 'dakika',
                'activities-experiences': 'Aktiviteler ve Deneyimler',
                'curated-experiences': 'G\u00fcvenilir ortaklar\u0131m\u0131zdan se\u00e7ilmi\u015f deneyimler',
                'hotel-map': 'Otel Haritas\u0131 ve Yerle\u015fimi',
                'no-restaurants': 'M\u00fcsait restoran yok',
                'no-events': 'Yak\u0131nda etkinlik yok',
                'no-spa': 'M\u00fcsait spa hizmeti yok',
                'no-services': 'M\u00fcsait hizmet yok',
                'no-activities': 'M\u00fcsait aktivite yok',
                'no-items': 'Bu b\u00f6l\u00fcmde m\u00fcsait \u00f6\u011fe yok'
            },
            el: {
                'book-now': '\u039a\u0391\u039d\u03a4\u0395 \u039a\u03a1\u0391\u03a4\u0397\u03a3\u0397 \u03a4\u03a9\u03a1\u0391',
                'book-table': '\u039a\u03c1\u03b1\u03c4\u03ae\u03c3\u03c4\u03b5 \u03a4\u03c1\u03b1\u03c0\u03ad\u03b6\u03b9',
                'reservations': '\u039a\u03c1\u03b1\u03c4\u03ae\u03c3\u03b5\u03b9\u03c2',
                'explore-menu': '\u0395\u03be\u03b5\u03c1\u03b5\u03c5\u03bd\u03ae\u03c3\u03c4\u03b5 \u03c4\u03bf \u039c\u03b5\u03bd\u03bf\u03cd',
                'learn-more': '\u039c\u03ac\u03b8\u03b5\u03c4\u03b5 \u03a0\u03b5\u03c1\u03b9\u03c3\u03c3\u03cc\u03c4\u03b5\u03c1\u03b1',
                'discover': '\u0391\u03bd\u03b1\u03ba\u03b1\u03bb\u03cd\u03c8\u03c4\u03b5',
                'view-details': '\u0394\u03b5\u03af\u03c4\u03b5 \u039b\u03b5\u03c0\u03c4\u03bf\u03bc\u03ad\u03c1\u03b5\u03b9\u03b5\u03c2',
                'explore-more': '\u0395\u03be\u03b5\u03c1\u03b5\u03c5\u03bd\u03ae\u03c3\u03c4\u03b5 \u03a0\u03b5\u03c1\u03b9\u03c3\u03c3\u03cc\u03c4\u03b5\u03c1\u03b1',
                'curated-by': '\u0395\u03c0\u03b9\u03bc\u03b5\u03bb\u03b7\u03bc\u03ad\u03bd\u03bf \u03b1\u03c0\u03cc',
                'minutes': '\u03bb\u03b5\u03c0\u03c4\u03ac',
                'activities-experiences': '\u0394\u03c1\u03b1\u03c3\u03c4\u03b7\u03c1\u03b9\u03cc\u03c4\u03b7\u03c4\u03b5\u03c2 \u03ba\u03b1\u03b9 \u0395\u03bc\u03c0\u03b5\u03b9\u03c1\u03af\u03b5\u03c2',
                'curated-experiences': '\u0395\u03c0\u03b9\u03bb\u03b5\u03b3\u03bc\u03ad\u03bd\u03b5\u03c2 \u03b5\u03bc\u03c0\u03b5\u03b9\u03c1\u03af\u03b5\u03c2 \u03b1\u03c0\u03cc \u03c4\u03bf\u03c5\u03c2 \u03ad\u03bc\u03c0\u03b9\u03c3\u03c4\u03bf\u03c5\u03c2 \u03c3\u03c5\u03bd\u03b5\u03c1\u03b3\u03ac\u03c4\u03b5\u03c2 \u03bc\u03b1\u03c2',
                'hotel-map': '\u03a7\u03ac\u03c1\u03c4\u03b7\u03c2 \u03ba\u03b1\u03b9 \u0394\u03b9\u03ac\u03c4\u03b1\u03be\u03b7 \u039e\u03b5\u03bd\u03bf\u03b4\u03bf\u03c7\u03b5\u03af\u03bf\u03c5',
                'no-restaurants': '\u0394\u03b5\u03bd \u03c5\u03c0\u03ac\u03c1\u03c7\u03bf\u03c5\u03bd \u03b4\u03b9\u03b1\u03b8\u03ad\u03c3\u03b9\u03bc\u03b1 \u03b5\u03c3\u03c4\u03b9\u03b1\u03c4\u03cc\u03c1\u03b9\u03b1',
                'no-events': '\u0394\u03b5\u03bd \u03c5\u03c0\u03ac\u03c1\u03c7\u03bf\u03c5\u03bd \u03b5\u03c0\u03b5\u03c1\u03c7\u03cc\u03bc\u03b5\u03bd\u03b5\u03c2 \u03b5\u03ba\u03b4\u03b7\u03bb\u03ce\u03c3\u03b5\u03b9\u03c2',
                'no-spa': '\u0394\u03b5\u03bd \u03c5\u03c0\u03ac\u03c1\u03c7\u03bf\u03c5\u03bd \u03b4\u03b9\u03b1\u03b8\u03ad\u03c3\u03b9\u03bc\u03b5\u03c2 \u03c5\u03c0\u03b7\u03c1\u03b5\u03c3\u03af\u03b5\u03c2 spa',
                'no-services': '\u0394\u03b5\u03bd \u03c5\u03c0\u03ac\u03c1\u03c7\u03bf\u03c5\u03bd \u03b4\u03b9\u03b1\u03b8\u03ad\u03c3\u03b9\u03bc\u03b5\u03c2 \u03c5\u03c0\u03b7\u03c1\u03b5\u03c3\u03af\u03b5\u03c2',
                'no-activities': '\u0394\u03b5\u03bd \u03c5\u03c0\u03ac\u03c1\u03c7\u03bf\u03c5\u03bd \u03b4\u03b9\u03b1\u03b8\u03ad\u03c3\u03b9\u03bc\u03b5\u03c2 \u03b4\u03c1\u03b1\u03c3\u03c4\u03b7\u03c1\u03b9\u03cc\u03c4\u03b7\u03c4\u03b5\u03c2',
                'no-items': '\u0394\u03b5\u03bd \u03c5\u03c0\u03ac\u03c1\u03c7\u03bf\u03c5\u03bd \u03b4\u03b9\u03b1\u03b8\u03ad\u03c3\u03b9\u03bc\u03b1 \u03c3\u03c4\u03bf\u03b9\u03c7\u03b5\u03af\u03b1 \u03c3\u03b5 \u03b1\u03c5\u03c4\u03ae\u03bd \u03c4\u03b7\u03bd \u03b5\u03bd\u03cc\u03c4\u03b7\u03c4\u03b1'
            },
            sv: {
                'book-now': 'BOKA NU',
                'book-table': 'Boka Bord',
                'reservations': 'Reservationer',
                'explore-menu': 'Utforska Meny',
                'learn-more': 'L\u00e4r Dig Mer',
                'discover': 'Uppt\u00e4ck',
                'view-details': 'Visa Detaljer',
                'explore-more': 'Utforska Mer',
                'curated-by': 'Utvalt av',
                'minutes': 'minuter',
                'activities-experiences': 'Aktiviteter och Upplevelser',
                'curated-experiences': 'Utvalda upplevelser fr\u00e5n v\u00e5ra betrodda partner',
                'hotel-map': 'Hotellkarta och Layout',
                'no-restaurants': 'Inga restauranger tillg\u00e4ngliga',
                'no-events': 'Inga kommande evenemang',
                'no-spa': 'Inga spa-tj\u00e4nster tillg\u00e4ngliga',
                'no-services': 'Inga tj\u00e4nster tillg\u00e4ngliga',
                'no-activities': 'Inga aktiviteter tillg\u00e4ngliga',
                'no-items': 'Inga artiklar tillg\u00e4ngliga i detta avsnitt'
            },
            no: {
                'book-now': 'BESTILL N\u00c5',
                'book-table': 'Bestill Bord',
                'reservations': 'Reservasjoner',
                'explore-menu': 'Utforsk Meny',
                'learn-more': 'L\u00e6r Mer',
                'discover': 'Oppdag',
                'view-details': 'Vis Detaljer',
                'explore-more': 'Utforsk Mer',
                'curated-by': 'Kuratert av',
                'minutes': 'minutter',
                'activities-experiences': 'Aktiviteter og Opplevelser',
                'curated-experiences': 'Utvalgte opplevelser fra v\u00e5re p\u00e5litelige partnere',
                'hotel-map': 'Hotellkart og Oppsett',
                'no-restaurants': 'Ingen restauranter tilgjengelige',
                'no-events': 'Ingen kommende arrangementer',
                'no-spa': 'Ingen spa-tjenester tilgjengelige',
                'no-services': 'Ingen tjenester tilgjengelige',
                'no-activities': 'Ingen aktiviteter tilgjengelige',
                'no-items': 'Ingen elementer tilgjengelige i denne seksjonen'
            },
            da: {
                'book-now': 'BESTIL NU',
                'book-table': 'Bestil Bord',
                'reservations': 'Reservationer',
                'explore-menu': 'Udforsk Menu',
                'learn-more': 'L\u00e6r Mere',
                'discover': 'Opdag',
                'view-details': 'Vis Detaljer',
                'explore-more': 'Udforsk Mere',
                'curated-by': 'Kurateret af',
                'minutes': 'minutter',
                'activities-experiences': 'Aktiviteter og Oplevelser',
                'curated-experiences': 'Udvalgte oplevelser fra vores betroede partnere',
                'hotel-map': 'Hotelkort og Layout',
                'no-restaurants': 'Ingen restauranter tilg\u00e6ngelige',
                'no-events': 'Ingen kommende begivenheder',
                'no-spa': 'Ingen spa-tjenester tilg\u00e6ngelige',
                'no-services': 'Ingen tjenester tilg\u00e6ngelige',
                'no-activities': 'Ingen aktiviteter tilg\u00e6ngelige',
                'no-items': 'Ingen elementer tilg\u00e6ngelige i dette afsnit'
            },
            ro: {
                'book-now': 'REZERV\u0102 ACUM',
                'book-table': 'Rezerv\u0103 Mas\u0103',
                'reservations': 'Rezerv\u0103ri',
                'explore-menu': 'Explorea\u021b\u0103 Meniul',
                'learn-more': 'Afla\u021bi Mai Multe',
                'discover': 'Descoperi\u021bi',
                'view-details': 'Vede\u021bi Detalii',
                'explore-more': 'Explorea\u021b\u0103 Mai Mult',
                'curated-by': 'Selec\u021bionat de',
                'minutes': 'minute',
                'activities-experiences': 'Activit\u0103\u021bi \u0219i Experien\u021be',
                'curated-experiences': 'Experien\u021be selec\u021bionate de la partenerii no\u0219tri de \u00eencredere',
                'hotel-map': 'Harta \u0219i Amenajarea Hotelului',
                'no-restaurants': 'Niciun restaurant disponibil',
                'no-events': 'Niciun eveniment viitor',
                'no-spa': 'Niciun serviciu spa disponibil',
                'no-services': 'Niciun serviciu disponibil',
                'no-activities': 'Nicio activitate disponibil\u0103',
                'no-items': 'Niciun element disponibil \u00een aceast\u0103 sec\u021biune'
            },
            hu: {
                'book-now': 'FOGLALJON MOST',
                'book-table': 'Asztal Foglal\u00e1sa',
                'reservations': 'Foglal\u00e1sok',
                'explore-menu': 'Men\u00fc FelfedfzÃ©se',
                'learn-more': 'Tudjon Meg T\u00f6bbet',
                'discover': 'Fedezze Fel',
                'view-details': 'R\u00e9szletek Megtekint\u00e9se',
                'explore-more': 'Fedezzen Fel T\u00f6bbet',
                'curated-by': '\u00d6ssze\u00e1ll\u00edtotta',
                'minutes': 'perc',
                'activities-experiences': 'Tev\u00e9kenys\u00e9gek \u00e9s \u00c9lm\u00e9nyek',
                'curated-experiences': 'Megb\u00edzhat\u00f3 partnereink \u00e1ltal v\u00e1logatott \u00e9lm\u00e9nyek',
                'hotel-map': 'Sz\u00e1lloda T\u00e9rk\u00e9p \u00e9s Elrendez\u00e9s',
                'no-restaurants': 'Nincs el\u00e9rhet\u0151 \u00e9tterem',
                'no-events': 'Nincs k\u00f6zelg\u0151 esem\u00e9ny',
                'no-spa': 'Nincsenek el\u00e9rhet\u0151 spa szolg\u00e1ltat\u00e1sok',
                'no-services': 'Nincsenek el\u00e9rhet\u0151 szolg\u00e1ltat\u00e1sok',
                'no-activities': 'Nincsenek el\u00e9rhet\u0151 tev\u00e9kenys\u00e9gek',
                'no-items': 'Nincsenek el\u00e9rhet\u0151 elemek ebben a r\u00e9szben'
            },
            fi: {
                'book-now': 'VARAA NYT',
                'book-table': 'Varaa P\u00f6yt\u00e4',
                'reservations': 'Varaukset',
                'explore-menu': 'Tutustu Menuun',
                'learn-more': 'Lue Lis\u00e4\u00e4',
                'discover': 'L\u00f6yd\u00e4',
                'view-details': 'N\u00e4yt\u00e4 Tiedot',
                'explore-more': 'Tutustu Lis\u00e4\u00e4n',
                'curated-by': 'Valinnut',
                'minutes': 'minuuttia',
                'activities-experiences': 'Aktiviteetit ja Kokemukset',
                'curated-experiences': 'Luotettavien kumppaneidemme valitsemat kokemukset',
                'hotel-map': 'Hotellin Kartta ja Pohjapiirros',
                'no-restaurants': 'Ei saatavilla olevia ravintoloita',
                'no-events': 'Ei tulevia tapahtumia',
                'no-spa': 'Ei saatavilla olevia kylpyl\u00e4palveluita',
                'no-services': 'Ei saatavilla olevia palveluita',
                'no-activities': 'Ei saatavilla olevia aktiviteetteja',
                'no-items': 'Ei saatavilla olevia kohteita t\u00e4ss\u00e4 osiossa'
            },
            hr: {
                'book-now': 'REZERVIRAJ SADA',
                'book-table': 'Rezerviraj Stol',
                'reservations': 'Rezervacije',
                'explore-menu': 'Istra\u017ei Jelovnik',
                'learn-more': 'Saznaj Vi\u0161e',
                'discover': 'Otkri',
                'view-details': 'Prika\u017ei Detalje',
                'explore-more': 'Istra\u017ei Vi\u0161e',
                'curated-by': 'Odabrao',
                'minutes': 'minuta',
                'activities-experiences': 'Aktivnosti i Iskustva',
                'curated-experiences': 'Odabrana iskustva od na\u0161ih pouzdanih partnera',
                'hotel-map': 'Karta i Raspored Hotela',
                'no-restaurants': 'Nema dostupnih restorana',
                'no-events': 'Nema nadolaze\u0107ih doga\u0111aja',
                'no-spa': 'Nema dostupnih spa usluga',
                'no-services': 'Nema dostupnih usluga',
                'no-activities': 'Nema dostupnih aktivnosti',
                'no-items': 'Nema dostupnih stavki u ovom odjeljku'
            },
            sk: {
                'book-now': 'REZERVOVA\u0164 TERAZ',
                'book-table': 'Rezervova\u0165 St\u00f4l',
                'reservations': 'Rezerv\u00e1cie',
                'explore-menu': 'PreskÃºma\u0165 Menu',
                'learn-more': 'Zisti\u0165 Viac',
                'discover': 'Objavi\u0165',
                'view-details': 'Zobrazi\u0165 Podrobnosti',
                'explore-more': 'PreskÃºma\u0165 Viac',
                'curated-by': 'VybranÃ©',
                'minutes': 'min\u00fat',
                'activities-experiences': 'Aktivity a Z\u00e1\u017eitky',
                'curated-experiences': 'VybranÃ© z\u00e1\u017eitky od na\u0161ich d\u00f4veryhodn\u00fdch partnerov',
                'hotel-map': 'Mapa a Rozlo\u017eenie Hotela',
                'no-restaurants': '\u017diadne dostupn\u00e9 re\u0161taur\u00e1cie',
                'no-events': '\u017diadne nadch\u00e1dzaj\u00face udalosti',
                'no-spa': '\u017diadne dostupn\u00e9 spa slu\u017eby',
                'no-services': '\u017diadne dostupn\u00e9 slu\u017eby',
                'no-activities': '\u017diadne dostupn\u00e9 aktivity',
                'no-items': '\u017diadne dostupn\u00e9 polo\u017eky v tejto sekcii'
            },
            bg: {
                'book-now': '\u0420\u0415\u0417\u0415\u0420\u0412\u0418\u0420\u0410\u0419 \u0421\u0415\u0413\u0410',
                'book-table': '\u0420\u0435\u0437\u0435\u0440\u0432\u0438\u0440\u0430\u0439 \u041c\u0430\u0441\u0430',
                'reservations': '\u0420\u0435\u0437\u0435\u0440\u0432\u0430\u0446\u0438\u0438',
                'explore-menu': '\u0420\u0430\u0437\u0433\u043b\u0435\u0434\u0430\u0439 \u041c\u0435\u043d\u044e\u0442\u043e',
                'learn-more': '\u041d\u0430\u0443\u0447\u0435\u0442\u0435 \u041f\u043e\u0432\u0435\u0447\u0435',
                'discover': '\u041e\u0442\u043a\u0440\u0438\u0439\u0442\u0435',
                'view-details': '\u0412\u0438\u0436 \u041f\u043e\u0434\u0440\u043e\u0431\u043d\u043e\u0441\u0442\u0438',
                'explore-more': '\u0420\u0430\u0437\u0433\u043b\u0435\u0434\u0430\u0439 \u041f\u043e\u0432\u0435\u0447\u0435',
                'curated-by': '\u041f\u043e\u0434\u0431\u0440\u0430\u043d\u043e \u043e\u0442',
                'minutes': '\u043c\u0438\u043d\u0443\u0442\u0438',
                'activities-experiences': '\u0414\u0435\u0439\u043d\u043e\u0441\u0442\u0438 \u0438 \u0418\u0437\u0436\u0438\u0432\u044f\u0432\u0430\u043d\u0438\u044f',
                'curated-experiences': '\u041f\u043e\u0434\u0431\u0440\u0430\u043d\u0438 \u0438\u0437\u0436\u0438\u0432\u044f\u0432\u0430\u043d\u0438\u044f \u043e\u0442 \u043d\u0430\u0448\u0438\u0442\u0435 \u0434\u043e\u0432\u0435\u0440\u0435\u043d\u0438 \u043f\u0430\u0440\u0442\u043d\u044c\u043e\u0440\u0438',
                'hotel-map': '\u041a\u0430\u0440\u0442\u0430 \u0438 \u041e\u0431\u0437\u0430\u0432\u0435\u0436\u0434\u0430\u043d\u0435 \u043d\u0430 \u0425\u043e\u0442\u0435\u043b\u0430',
                'no-restaurants': '\u041d\u044f\u043c\u0430 \u043d\u0430\u043b\u0438\u0447\u043d\u0438 \u0440\u0435\u0441\u0442\u043e\u0440\u0430\u043d\u0442\u0438',
                'no-events': '\u041d\u044f\u043c\u0430 \u043f\u0440\u0435\u0434\u0441\u0442\u043e\u044f\u0449\u0438 \u0441\u044a\u0431\u0438\u0442\u0438\u044f',
                'no-spa': '\u041d\u044f\u043c\u0430 \u043d\u0430\u043b\u0438\u0447\u043d\u0438 \u0441\u043f\u0430 \u0443\u0441\u043b\u0443\u0433\u0438',
                'no-services': '\u041d\u044f\u043c\u0430 \u043d\u0430\u043b\u0438\u0447\u043d\u0438 \u0443\u0441\u043b\u0443\u0433\u0438',
                'no-activities': '\u041d\u044f\u043c\u0430 \u043d\u0430\u043b\u0438\u0447\u043d\u0438 \u0434\u0435\u0439\u043d\u043e\u0441\u0442\u0438',
                'no-items': '\u041d\u044f\u043c\u0430 \u043d\u0430\u043b\u0438\u0447\u043d\u0438 \u0435\u043b\u0435\u043c\u0435\u043d\u0442\u0438 \u0432 \u0442\u0430\u0437\u0438 \u0441\u0435\u043a\u0446\u0438\u044f'
            },
            sr: {
                'book-now': '\u0420\u0415\u0417\u0415\u0420\u0412\u0418\u0428\u0418 \u0421\u0410\u0414\u0410',
                'book-table': '\u0420\u0435\u0437\u0435\u0440\u0432\u0438\u0448\u0438 \u0421\u0442\u043e',
                'reservations': '\u0420\u0435\u0437\u0435\u0440\u0432\u0430\u0446\u0438\u0458\u0435',
                'explore-menu': '\u0418\u0441\u0442\u0440\u0430\u0436\u0438 \u041c\u0435\u043d\u0438',
                'learn-more': '\u0421\u0430\u0437\u043d\u0430\u0458 \u0412\u0438\u0448\u0435',
                'discover': '\u041e\u0442\u043a\u0440\u0438\u0458',
                'view-details': '\u041f\u0440\u0438\u043a\u0430\u0436\u0438 \u0414\u0435\u0442\u0430\u0459\u0435',
                'explore-more': '\u0418\u0441\u0442\u0440\u0430\u0436\u0438 \u0412\u0438\u0448\u0435',
                'curated-by': '\u041e\u0434\u0430\u0431\u0440\u0430\u043e',
                'minutes': '\u043c\u0438\u043d\u0443\u0442\u0430',
                'activities-experiences': '\u0410\u043a\u0442\u0438\u0432\u043d\u043e\u0441\u0442\u0438 \u0438 \u0418\u0441\u043a\u0443\u0441\u0442\u0432\u0430',
                'curated-experiences': '\u041e\u0434\u0430\u0431\u0440\u0430\u043d\u0430 \u0438\u0441\u043a\u0443\u0441\u0442\u0432\u0430 \u043e\u0434 \u043d\u0430\u0448\u0438\u0445 \u043f\u043e\u0443\u0437\u0434\u0430\u043d\u0438\u0445 \u043f\u0430\u0440\u0442\u043d\u0435\u0440\u0430',
                'hotel-map': '\u041c\u0430\u043f\u0430 \u0438 \u0420\u0430\u0441\u043f\u043e\u0440\u0435\u0434 \u0425\u043e\u0442\u0435\u043b\u0430',
                'no-restaurants': '\u041d\u0435\u043c\u0430 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0438\u0445 \u0440\u0435\u0441\u0442\u043e\u0440\u0430\u043d\u0430',
                'no-events': '\u041d\u0435\u043c\u0430 \u043f\u0440\u0435\u0434\u0441\u0442\u043e\u0458\u0435\u045b\u0438\u0445 \u0434\u043e\u0433\u0430\u0452\u0430\u0458\u0430',
                'no-spa': '\u041d\u0435\u043c\u0430 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0438\u0445 \u0441\u043f\u0430 \u0443\u0441\u043b\u0443\u0433\u0430',
                'no-services': '\u041d\u0435\u043c\u0430 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0438\u0445 \u0443\u0441\u043b\u0443\u0433\u0430',
                'no-activities': '\u041d\u0435\u043c\u0430 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0438\u0445 \u0430\u043a\u0442\u0438\u0432\u043d\u043e\u0441\u0442\u0438',
                'no-items': '\u041d\u0435\u043c\u0430 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0438\u0445 \u0441\u0442\u0430\u0432\u043a\u0438 \u0443 \u043e\u0432\u043e\u0458 \u0441\u0435\u043a\u0446\u0438\u0458\u0438'
            },
            sl: {
                'book-now': 'REZERVIRAJ ZDAJ',
                'book-table': 'Rezerviraj Mizo',
                'reservations': 'Rezervacije',
                'explore-menu': 'RaziÅ¡Äite Meni',
                'learn-more': 'Izvedi VeÄ',
                'discover': 'Odkri',
                'view-details': 'Poglej Podrobnosti',
                'explore-more': 'RaziÅ¡Äite VeÄ',
                'curated-by': 'Izbral',
                'minutes': 'minut',
                'activities-experiences': 'Aktivnosti in IzkuÅ¡nje',
                'curated-experiences': 'Izbrane izkuÅ¡nje naÅ¡ih zaupanja vrednih partnerjev',
                'hotel-map': 'Zemljevid in Tloris Hotela',
                'no-restaurants': 'Ni razpoloÅ¾ljivih restavracij',
                'no-events': 'Ni prihajajoÄih dogodkov',
                'no-spa': 'Ni razpoloÅ¾ljivih spa storitev',
                'no-services': 'Ni razpoloÅ¾ljivih storitev',
                'no-activities': 'Ni razpoloÅ¾ljivih aktivnosti',
                'no-items': 'Ni razpoloÅ¾ljivih elementov v tem razdelku'
            },
            th: {
                'book-now': '\u0e08\u0e2d\u0e07\u0e40\u0e14\u0e35\u0e4b\u0e22\u0e27\u0e19\u0e35\u0e49',
                'book-table': '\u0e08\u0e2d\u0e07\u0e42\u0e15\u0e4a\u0e30',
                'reservations': '\u0e01\u0e32\u0e23\u0e08\u0e2d\u0e07',
                'explore-menu': '\u0e2a\u0e33\u0e23\u0e27\u0e08\u0e40\u0e21\u0e19\u0e39',
                'learn-more': '\u0e40\u0e23\u0e35\u0e22\u0e19\u0e23\u0e39\u0e49\u0e40\u0e1e\u0e34\u0e48\u0e21\u0e40\u0e15\u0e34\u0e21',
                'discover': '\u0e04\u0e49\u0e19\u0e1e\u0e1a',
                'view-details': '\u0e14\u0e39\u0e23\u0e32\u0e22\u0e25\u0e30\u0e40\u0e2d\u0e35\u0e22\u0e14',
                'explore-more': '\u0e2a\u0e33\u0e23\u0e27\u0e08\u0e40\u0e1e\u0e34\u0e48\u0e21\u0e40\u0e15\u0e34\u0e21',
                'curated-by': '\u0e04\u0e31\u0e14\u0e2a\u0e23\u0e23\u0e42\u0e14\u0e22',
                'minutes': '\u0e19\u0e32\u0e17\u0e35',
                'activities-experiences': '\u0e01\u0e34\u0e08\u0e01\u0e23\u0e23\u0e21\u0e41\u0e25\u0e30\u0e1b\u0e23\u0e30\u0e2a\u0e1a\u0e01\u0e32\u0e23\u0e13\u0e4c',
                'curated-experiences': '\u0e1b\u0e23\u0e30\u0e2a\u0e1a\u0e01\u0e32\u0e23\u0e13\u0e4c\u0e17\u0e35\u0e48\u0e04\u0e31\u0e14\u0e2a\u0e23\u0e23\u0e08\u0e32\u0e01\u0e1e\u0e31\u0e19\u0e18\u0e21\u0e34\u0e15\u0e23\u0e17\u0e35\u0e48\u0e44\u0e27\u0e49\u0e27\u0e32\u0e07\u0e43\u0e08',
                'hotel-map': '\u0e41\u0e1c\u0e19\u0e17\u0e35\u0e48\u0e41\u0e25\u0e30\u0e41\u0e1c\u0e19\u0e1c\u0e31\u0e07\u0e42\u0e23\u0e07\u0e41\u0e23\u0e21',
                'no-restaurants': '\u0e44\u0e21\u0e48\u0e21\u0e35\u0e23\u0e49\u0e32\u0e19\u0e2d\u0e32\u0e2b\u0e32\u0e23',
                'no-events': '\u0e44\u0e21\u0e48\u0e21\u0e35\u0e01\u0e34\u0e08\u0e01\u0e23\u0e23\u0e21\u0e17\u0e35\u0e48\u0e08\u0e30\u0e40\u0e01\u0e34\u0e14\u0e02\u0e36\u0e49\u0e19',
                'no-spa': '\u0e44\u0e21\u0e48\u0e21\u0e35\u0e1a\u0e23\u0e34\u0e01\u0e32\u0e23\u0e2a\u0e1b\u0e32',
                'no-services': '\u0e44\u0e21\u0e48\u0e21\u0e35\u0e1a\u0e23\u0e34\u0e01\u0e32\u0e23',
                'no-activities': '\u0e44\u0e21\u0e48\u0e21\u0e35\u0e01\u0e34\u0e08\u0e01\u0e23\u0e23\u0e21',
                'no-items': '\u0e44\u0e21\u0e48\u0e21\u0e35\u0e23\u0e32\u0e22\u0e01\u0e32\u0e23\u0e43\u0e19\u0e2a\u0e48\u0e27\u0e19\u0e19\u0e35\u0e49'
            },
            id: {
                'book-now': 'PESAN SEKARANG',
                'book-table': 'Pesan Meja',
                'reservations': 'Reservasi',
                'explore-menu': 'Jelajahi Menu',
                'learn-more': 'Pelajari Lebih Lanjut',
                'discover': 'Temukan',
                'view-details': 'Lihat Detail',
                'explore-more': 'Jelajahi Lebih Banyak',
                'curated-by': 'Dikurasi oleh',
                'minutes': 'menit',
                'activities-experiences': 'Aktivitas dan Pengalaman',
                'curated-experiences': 'Pengalaman terpilih dari mitra tepercaya kami',
                'hotel-map': 'Peta dan Tata Letak Hotel',
                'no-restaurants': 'Tidak ada restoran yang tersedia',
                'no-events': 'Tidak ada acara mendatang',
                'no-spa': 'Tidak ada layanan spa yang tersedia',
                'no-services': 'Tidak ada layanan yang tersedia',
                'no-activities': 'Tidak ada aktivitas yang tersedia',
                'no-items': 'Tidak ada item yang tersedia di bagian ini'
            },
            vi: {
                'book-now': '\u0110\u1eb6T NGAY',
                'book-table': '\u0110\u1eb7t B\u00e0n',
                'reservations': '\u0110\u1eb7t Ch\u1ed7',
                'explore-menu': 'Kh\u00e1m Ph\u00e1 Th\u1ef1c \u0110\u01a1n',
                'learn-more': 'T\u00ecm Hi\u1ec3u Th\u00eam',
                'discover': 'Kh\u00e1m Ph\u00e1',
                'view-details': 'Xem Chi Ti\u1ebft',
                'explore-more': 'Kh\u00e1m Ph\u00e1 Th\u00eam',
                'curated-by': '\u0110\u01b0\u1ee3c ch\u1ecdn b\u1edfi',
                'minutes': 'ph\u00fat',
                'activities-experiences': 'Ho\u1ea1t \u0110\u1ed9ng v\u00e0 Tr\u1ea3i Nghi\u1ec7m',
                'curated-experiences': 'Tr\u1ea3i nghi\u1ec7m \u0111\u01b0\u1ee3c ch\u1ecdn l\u1ecdc t\u1eeb c\u00e1c \u0111\u1ed1i t\u00e1c \u0111\u00e1ng tin c\u1eady c\u1ee7a ch\u00fang t\u00f4i',
                'hotel-map': 'B\u1ea3n \u0110\u1ed3 v\u00e0 B\u1ed1 Tr\u00ed Kh\u00e1ch S\u1ea1n',
                'no-restaurants': 'Kh\u00f4ng c\u00f3 nh\u00e0 h\u00e0ng n\u00e0o',
                'no-events': 'Kh\u00f4ng c\u00f3 s\u1ef1 ki\u1ec7n s\u1eafp t\u1edbi',
                'no-spa': 'Kh\u00f4ng c\u00f3 d\u1ecbch v\u1ee5 spa',
                'no-services': 'Kh\u00f4ng c\u00f3 d\u1ecbch v\u1ee5',
                'no-activities': 'Kh\u00f4ng c\u00f3 ho\u1ea1t \u0111\u1ed9ng',
                'no-items': 'Kh\u00f4ng c\u00f3 m\u1ee5c n\u00e0o trong ph\u1ea7n n\u00e0y'
            },
            tl: {
                'book-now': 'MAG-BOOK NGAYON',
                'book-table': 'Mag-book ng Mesa',
                'reservations': 'Mga Reserbasyon',
                'explore-menu': 'Tuklasin ang Menu',
                'learn-more': 'Matuto Pa',
                'discover': 'Tuklasin',
                'view-details': 'Tingnan ang Detalye',
                'explore-more': 'Tuklasin Pa',
                'curated-by': 'Pinili ni',
                'minutes': 'minuto',
                'activities-experiences': 'Mga Aktibidad at Karanasan',
                'curated-experiences': 'Piniling mga karanasan mula sa aming mapagkakatiwalaang kasosyo',
                'hotel-map': 'Mapa at Layout ng Hotel',
                'no-restaurants': 'Walang available na restaurant',
                'no-events': 'Walang paparating na event',
                'no-spa': 'Walang available na spa services',
                'no-services': 'Walang available na serbisyo',
                'no-activities': 'Walang available na aktibidad',
                'no-items': 'Walang available na item sa seksyong ito'
            },
            ms: {
                'book-now': 'TEMPAH SEKARANG',
                'book-table': 'Tempah Meja',
                'reservations': 'Tempahan',
                'explore-menu': 'Terokai Menu',
                'learn-more': 'Ketahui Lebih Lanjut',
                'discover': 'Temui',
                'view-details': 'Lihat Butiran',
                'explore-more': 'Terokai Lebih Lanjut',
                'curated-by': 'Dipilih oleh',
                'minutes': 'minit',
                'activities-experiences': 'Aktiviti dan Pengalaman',
                'curated-experiences': 'Pengalaman terpilih daripada rakan kongsi dipercayai kami',
                'hotel-map': 'Peta dan Susun Atur Hotel',
                'no-restaurants': 'Tiada restoran tersedia',
                'no-events': 'Tiada acara akan datang',
                'no-spa': 'Tiada perkhidmatan spa tersedia',
                'no-services': 'Tiada perkhidmatan tersedia',
                'no-activities': 'Tiada aktiviti tersedia',
                'no-items': 'Tiada item tersedia dalam bahagian ini'
            }
        };
        
        // Get UI translation
        function t(key) {
            const dict = uiTranslations[currentLanguage] || uiTranslations['en'];
            return dict[key] || uiTranslations['en'][key] || key;
        }
        
        // Cache for AI translations
        const translationCache = new Map();
        
        // Helper function to translate text using AI
        async function translateText(text, targetLanguage) {
            if (!text || targetLanguage === 'en') return text;
            
            // Check cache first
            const cacheKey = text + '__' + targetLanguage;
            if (translationCache.has(cacheKey)) {
                return translationCache.get(cacheKey);
            }
            
            try {
                const languageNames = {
                    'ar': 'Arabic', 'de': 'German', 'ru': 'Russian', 'pl': 'Polish',
                    'it': 'Italian', 'fr': 'French', 'cs': 'Czech', 'uk': 'Ukrainian',
                    'zh': 'Simplified Chinese', 'es': 'Spanish', 'ja': 'Japanese',
                    'pt': 'Portuguese', 'ko': 'Korean', 'hi': 'Hindi', 'tr': 'Turkish',
                    'el': 'Greek', 'sv': 'Swedish', 'no': 'Norwegian', 'da': 'Danish',
                    'ro': 'Romanian', 'hu': 'Hungarian', 'fi': 'Finnish', 'hr': 'Croatian',
                    'sk': 'Slovak', 'bg': 'Bulgarian', 'sr': 'Serbian', 'sl': 'Slovenian',
                    'th': 'Thai', 'id': 'Indonesian', 'vi': 'Vietnamese', 'tl': 'Filipino',
                    'ms': 'Malay'
                };
                
                const targetLangName = languageNames[targetLanguage] || targetLanguage;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a professional translator. Translate the given text to ' + targetLangName + '. Return ONLY the translation, no explanations or additional text.'
                            },
                            {
                                role: 'user',
                                content: text
                            }
                        ],
                        property_id: propertyId
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const translated = data.message || text;
                    translationCache.set(cacheKey, translated);
                    return translated;
                }
            } catch (error) {
                console.warn('Translation failed:', error);
            }
            
            return text; // Fallback to original text
        }
        
        // Helper function to get translated field with AI fallback
        async function getTranslatedField(item, fieldName) {
            if (!item) return '';
            
            // If English, use _en field
            if (currentLanguage === 'en') {
                return item[fieldName + '_en'] || item[fieldName] || '';
            }
            
            // Try translated field first (e.g., title_es, title_fr)
            const translatedField = item[fieldName + '_' + currentLanguage];
            if (translatedField) {
                return translatedField;
            }
            
            // Get English text
            const englishText = item[fieldName + '_en'] || item[fieldName] || '';
            
            // Use AI translation if available
            if (englishText && currentLanguage !== 'en') {
                const aiTranslated = await translateText(englishText, currentLanguage);
                return aiTranslated;
            }
            
            // Fallback to English
            return englishText;
        }
        
        // Helper function to translate location text
        function translateLocation(location) {
            if (!location) return '';
            
            const t = translations[currentLanguage] || translations.en;
            const locationLower = location.toLowerCase().trim();
            
            // Common location mappings
            if (locationLower.includes('main lobby') || locationLower.includes('lobby')) {
                return t.mainLobby;
            }
            if (locationLower.includes('poolside') || locationLower.includes('pool')) {
                return t.poolside;
            }
            if (locationLower.includes('beachfront') || locationLower.includes('beach')) {
                return t.beachfront;
            }
            if (locationLower.includes('rooftop') || locationLower.includes('roof')) {
                return t.rooftop;
            }
            if (locationLower.includes('garden')) {
                return t.garden;
            }
            if (locationLower.includes('behind the souq') || locationLower.includes('souq')) {
                return currentLanguage === 'ru' ? 'Ð—Ð° Ð±Ð°Ð·Ð°Ñ€Ð¾Ð¼' : 
                       currentLanguage === 'ar' ? 'Ø®Ù„Ù Ø§Ù„Ø³ÙˆÙ‚' :
                       currentLanguage === 'de' ? 'Hinter dem Souk' :
                       currentLanguage === 'fr' ? 'DerriÃ¨re le souk' : location;
            }
            
            // Return original if no match found
            return location;
        }
        
        // Update section headings based on language
        function updateSectionHeadings() {
            if (!propertyData) {
              console.error('âŒ propertyData is null!');
              return;
            }
            
            console.log('ðŸ“° Updating section headings with language:', currentLanguage);
            
            // Update default section headings
            const sections = ['restaurants', 'events', 'spa', 'service', 'activities'];
            sections.forEach(section => {
                const el = document.getElementById('section-heading-' + section);
                if (el) {
                    const fieldName = 'section_' + section;
                    // Check if database has THIS language's field
                    const dbField = propertyData[fieldName + '_' + currentLanguage];
                    let translated;
                    if (dbField) {
                        // Use database value if exists
                        translated = dbField;
                    } else if (translations[currentLanguage]) {
                        // Fall back to translations object for languages not in database
                        const translationKey = section === 'service' ? 'services' : section;
                        translated = translations[currentLanguage][translationKey];
                    } else {
                        // Final fallback to English
                        translated = propertyData[fieldName + '_en'] || '';
                    }
                    console.log('  ' + section + ': "' + translated + '"');
                    if (translated) {
                        el.textContent = translated;
                    }
                }
                
                // Also update filter pill buttons
                const pillEl = document.getElementById('pill-' + section);
                if (pillEl) {
                    const fieldName = 'section_' + section;
                    // Check if database has THIS language's field
                    const dbField = propertyData[fieldName + '_' + currentLanguage];
                    let translated;
                    if (dbField) {
                        // Use database value if exists
                        translated = dbField;
                    } else if (translations[currentLanguage]) {
                        // Fall back to translations object for languages not in database
                        const translationKey = section === 'service' ? 'services' : section;
                        translated = translations[currentLanguage][translationKey];
                    } else {
                        // Final fallback to English
                        translated = propertyData[fieldName + '_en'] || '';
                    }
                    if (translated) {
                        pillEl.textContent = translated;
                    }
                }
            });
            
            // Update all data-i18n elements (except pill buttons which are handled above)
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                // Skip category pills as they use custom section names
                if (key && key.startsWith('pill-')) {
                    return;
                }
                const translated = t(key);
                if (translated && translated !== key) {
                    el.textContent = translated;
                }
            });
            
            // Update hotel map heading
            const mapHeading = document.querySelector('#hotel-map-section h2 span');
            if (mapHeading) {
                mapHeading.textContent = t('hotel-map');
            }
        }
        
        // Change language function
        function changeLanguage() {
            const selector = document.getElementById('languageSelector');
            const newLang = selector.value;
            
            console.log('ðŸŒ Changing language to:', newLang);
            
            // CRITICAL: Save to localStorage FIRST
            localStorage.setItem('preferredLanguage', newLang);
            
            // Verify it's saved
            const saved = localStorage.getItem('preferredLanguage');
            console.log('âœ… Saved to localStorage:', saved);
            
            if (saved !== newLang) {
                console.error('âŒ localStorage save FAILED!');
                return;
            }
            
            // RELOAD THE ENTIRE PAGE - cleanest approach
            console.log('ðŸ”„ Reloading page with new language...');
            window.location.reload();
        }
        
        // Make changeLanguage available globally for inline event handler
        window.changeLanguage = changeLanguage;

        function applyDesignSettings(settings) {
          // Font family mapping
          const fontMap = {
            'inter': "'Inter', system-ui, sans-serif",
            'poppins': "'Poppins', sans-serif",
            'playfair': "'Playfair Display', serif",
            'montserrat': "'Montserrat', sans-serif",
            'lora': "'Lora', serif"
          };
          
          const primaryColor = settings.primary_color || '#3B82F6';
          const secondaryColor = settings.secondary_color || '#10B981';
          const accentColor = settings.accent_color || '#F59E0B';
          const fontFamily = fontMap[settings.font_family] || fontMap['inter'];
          const layoutStyle = settings.layout_style || 'modern';
          const buttonStyle = settings.button_style || 'rounded';
          const cardStyle = settings.card_style || 'shadow';
          const headerStyle = settings.header_style || 'transparent';
          const useGradient = settings.use_gradient || 0;
          const heroImageEffect = settings.hero_image_effect || 'none';
          const heroOverlay = (settings.hero_overlay_opacity || 30) / 100;
          
          // Logo - add to propertyLogo container (Facebook Profile Style)
          console.log('ðŸŽ¨ Loading logo from settings:', settings.brand_logo_url);
          const logoContainer = document.getElementById('propertyLogo');
          
          if (logoContainer && settings.brand_logo_url) {
            console.log('âœ… Setting logo image');
            // Create img element programmatically to avoid CSP inline handler issues
            const logoImg = document.createElement('img');
            logoImg.src = settings.brand_logo_url;
            logoImg.alt = 'GuestConnect Logo';
            logoImg.className = 'w-24 h-24 md:w-32 md:h-32 rounded-full object-cover shadow-lg border-4 border-white bg-white';
            logoImg.style.display = 'block';
            
            // Add event listeners (CSP-compliant way)
            logoImg.addEventListener('load', function() {
              console.log('âœ… Logo loaded successfully!');
            });
            
            logoImg.addEventListener('error', function() {
              console.error('âŒ Logo failed to load:', this.src);
            });
            
            // Replace the placeholder
            logoContainer.innerHTML = '';
            logoContainer.appendChild(logoImg);
          } else {
            if (!logoContainer) {
              console.error('âŒ Logo container not found!');
            }
            if (!settings.brand_logo_url) {
              console.warn('âš ï¸ No brand_logo_url in settings');
            }
          }
          
          // Gradient or solid color
          const heroBackground = useGradient ? 
            'linear-gradient(135deg, ' + primaryColor + ' 0%, ' + secondaryColor + ' 100%)' : 
            primaryColor;
          
          // Hero image filter effects
          let heroFilter = '';
          if (heroImageEffect === 'grayscale') heroFilter = 'grayscale(100%)';
          else if (heroImageEffect === 'sepia') heroFilter = 'sepia(80%)';
          else if (heroImageEffect === 'blur') heroFilter = 'blur(4px)';
          
          // Hero background with image and overlay
          const heroImageCSS = settings.hero_image_url ? 
            'background-image: linear-gradient(rgba(0,0,0,' + heroOverlay + '), rgba(0,0,0,' + heroOverlay + ')), url(\\'' + settings.hero_image_url + '\\'); background-size: cover; background-position: center; ' + (heroFilter ? 'filter: ' + heroFilter + ';' : '')
            : '';
          
          // Generate dynamic CSS based on layout style
          let dynamicCSS = '';
          
          if (layoutStyle === 'modern') {
            // Modern: Rounded cards, soft shadows, vibrant colors
            dynamicCSS = \`
              body {
                font-family: \${fontFamily};
                background: linear-gradient(to bottom, #f9fafb 0%, #ffffff 100%);
              }
              
              .gradient-hero {
                background: \${heroBackground};
                position: relative;
                \${heroImageCSS}
              }
              
              .offering-card {
                background: white;
                border-radius: 1.5rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                overflow: hidden;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
              }
              
              .offering-card:hover {
                transform: translateY(-8px);
                box-shadow: 0 12px 24px rgba(0,0,0,0.15);
              }
              
              .offering-card img {
                border-radius: 0;
              }
              
              .category-pill {
                border-radius: 9999px;
                padding: 0.75rem 1.5rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              }
              
              .category-pill.bg-blue-500 {
                background: \${useGradient ? heroBackground : primaryColor} !important;
              }
              
              button, .btn {
                border-radius: \${buttonStyle === 'pill' ? '9999px' : '0.75rem'};
                font-weight: 600;
                transition: all 0.3s ease;
              }
              
              .text-blue-500, .text-blue-600 {
                color: \${primaryColor} !important;
              }
              
              .bg-blue-600 {
                background: \${useGradient ? heroBackground : primaryColor} !important;
              }
              
              .bg-blue-600:hover {
                background: \${secondaryColor} !important;
                transform: scale(1.05);
              }
              
              .text-green-600 { color: \${secondaryColor} !important; }
              .text-orange-600 { color: \${accentColor} !important; }
              .bg-green-100 { background-color: \${secondaryColor}22 !important; color: \${secondaryColor} !important; }
              .bg-blue-100 { background-color: \${primaryColor}22 !important; color: \${primaryColor} !important; }
              .bg-secondary { background: \${secondaryColor} !important; }
              .bg-secondary:hover { opacity: 0.9; }
              .text-secondary { color: \${secondaryColor} !important; }
              
              /* Floating Map Button */
              #mapFloatingBtn {
                background: \${primaryColor} !important;
              }
              #mapFloatingBtn:hover {
                background: \${secondaryColor} !important;
              }
              #mapModalIcon {
                color: \${primaryColor} !important;
              }
            \`;
          } else if (layoutStyle === 'elegant') {
            // Elegant: Borders, subtle colors, refined typography
            dynamicCSS = \`
              body {
                font-family: \${fontFamily};
                background: #fafafa;
              }
              
              .gradient-hero {
                background: \${heroBackground};
                position: relative;
                \${heroImageCSS}
              }
              
              .offering-card {
                background: white;
                border-radius: 0.25rem;
                border: 2px solid #e5e7eb;
                overflow: hidden;
                transition: border-color 0.3s ease, box-shadow 0.3s ease;
              }
              
              .offering-card:hover {
                border-color: \${primaryColor};
                box-shadow: 0 0 0 1px \${primaryColor};
              }
              
              .offering-card img {
                border-bottom: 1px solid #e5e7eb;
              }
              
              .category-pill {
                border-radius: 0.25rem;
                padding: 0.5rem 1.25rem;
                border: 1px solid currentColor;
                background: transparent !important;
                color: #374151;
                font-weight: 500;
                letter-spacing: 0.05em;
              }
              
              .category-pill.bg-blue-500 {
                background: \${primaryColor} !important;
                color: white !important;
                border-color: \${primaryColor} !important;
              }
              
              button, .btn {
                border-radius: 0.25rem;
                font-weight: 500;
                letter-spacing: 0.05em;
                border: 1px solid currentColor;
              }
              
              .text-blue-500, .text-blue-600 {
                color: \${primaryColor} !important;
              }
              
              .bg-blue-600 {
                background: \${primaryColor} !important;
                border-color: \${primaryColor} !important;
              }
              
              .bg-blue-600:hover {
                background: white !important;
                color: \${primaryColor} !important;
              }
              
              .text-green-600 { color: \${secondaryColor} !important; }
              .text-orange-600 { color: \${accentColor} !important; }
              .bg-green-100 { background-color: transparent !important; color: \${secondaryColor} !important; border: 1px solid \${secondaryColor}; }
              .bg-blue-100 { background-color: transparent !important; color: \${primaryColor} !important; border: 1px solid \${primaryColor}; }
              .bg-secondary { background: \${secondaryColor} !important; }
              .bg-secondary:hover { opacity: 0.9; }
              .text-secondary { color: \${secondaryColor} !important; }
              
              /* Floating Map Button */
              #mapFloatingBtn {
                background: \${primaryColor} !important;
              }
              #mapFloatingBtn:hover {
                background: \${secondaryColor} !important;
              }
              #mapModalIcon {
                color: \${primaryColor} !important;
              }
            \`;
          } else if (layoutStyle === 'minimal') {
            // Minimal: Flat, clean, lots of whitespace
            dynamicCSS = \`
              body {
                font-family: \${fontFamily};
                background: white;
              }
              
              .gradient-hero {
                background: \${heroBackground};
                padding: 6rem 1rem 3rem;
                position: relative;
                \${heroImageCSS}
              }
              
              .offering-card {
                background: #f9fafb;
                border-radius: 0.5rem;
                border: 1px solid #e5e7eb;
                overflow: hidden;
                transition: background-color 0.2s ease;
              }
              
              .offering-card:hover {
                background: white;
              }
              
              .offering-card img {
                border-radius: 0;
              }
              
              .category-pill {
                border-radius: 0.375rem;
                padding: 0.5rem 1rem;
                background: #f3f4f6 !important;
                color: #374151;
                font-weight: 500;
                font-size: 0.875rem;
              }
              
              .category-pill.bg-blue-500 {
                background: \${primaryColor} !important;
                color: white !important;
              }
              
              button, .btn {
                border-radius: 0.5rem;
                font-weight: 600;
                padding: 0.75rem 1.5rem;
              }
              
              .text-blue-500, .text-blue-600 {
                color: \${primaryColor} !important;
              }
              
              .bg-blue-600 {
                background: \${primaryColor} !important;
              }
              
              .bg-blue-600:hover {
                opacity: 0.9;
              }
              
              .text-green-600 { color: \${secondaryColor} !important; }
              .text-orange-600 { color: \${accentColor} !important; }
              .bg-green-100 { background-color: \${secondaryColor}11 !important; color: \${secondaryColor} !important; }
              .bg-blue-100 { background-color: \${primaryColor}11 !important; color: \${primaryColor} !important; }
              .bg-secondary { background: \${secondaryColor} !important; }
              .bg-secondary:hover { opacity: 0.9; }
              .text-secondary { color: \${secondaryColor} !important; }
              
              /* Floating Map Button */
              #mapFloatingBtn {
                background: \${primaryColor} !important;
              }
              #mapFloatingBtn:hover {
                background: \${secondaryColor} !important;
              }
              #mapModalIcon {
                color: \${primaryColor} !important;
              }
            \`;
          }
          
          document.getElementById('dynamic-styles').textContent = dynamicCSS;
        }

        // Translation helpers
        const translations = {
          en: { 
            all: 'All', 
            restaurants: 'Dining & Drinks', 
            events: 'Events & Entertainment', 
            spa: 'Spa', 
            services: 'Facilities & Amenities', 
            activities: 'Activities',
            discoverAll: 'Discover all we have to offer',
            viewMenu: 'View Menu',
            location: 'Location',
            mainLobby: 'Main Lobby',
            poolside: 'Poolside',
            beachfront: 'Beachfront',
            rooftop: 'Rooftop',
            garden: 'Garden'
          },
          ar: { 
            all: 'Ø§Ù„ÙƒÙ„', 
            restaurants: 'Ù…Ø·Ø§Ø¹Ù… ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª', 
            events: 'ÙØ¹Ø§Ù„ÙŠØ§Øª ÙˆØªØ±ÙÙŠÙ‡', 
            spa: 'Ø³Ø¨Ø§', 
            services: 'Ù…Ø±Ø§ÙÙ‚ ÙˆÙˆØ³Ø§Ø¦Ù„ Ø±Ø§Ø­Ø©', 
            activities: 'Ø£Ù†Ø´Ø·Ø©',
            discoverAll: 'Ø§ÙƒØªØ´Ù ÙƒÙ„ Ù…Ø§ Ù„Ø¯ÙŠÙ†Ø§ Ù„Ù†Ù‚Ø¯Ù…Ù‡',
            viewMenu: 'Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©',
            location: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹',
            mainLobby: 'Ø§Ù„Ù„ÙˆØ¨ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
            poolside: 'Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ø³Ø¨Ø­',
            beachfront: 'Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø­Ø±ÙŠØ©',
            rooftop: 'Ø§Ù„Ø³Ø·Ø­',
            garden: 'Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©'
          },
          de: { 
            all: 'Alle', 
            restaurants: 'Essen und GetrÃ¤nke', 
            events: 'Events und Unterhaltung', 
            spa: 'Spa', 
            services: 'Einrichtungen und Annehmlichkeiten', 
            activities: 'AktivitÃ¤ten',
            discoverAll: 'Entdecken Sie alles, was wir zu bieten haben',
            viewMenu: 'MenÃ¼ ansehen',
            location: 'Standort',
            mainLobby: 'Hauptlobby',
            poolside: 'Am Pool',
            beachfront: 'Strandfront',
            rooftop: 'Dachterrasse',
            garden: 'Garten'
          },
          ru: { 
            all: 'Ð’ÑÐµ', 
            restaurants: 'Ð•Ð´Ð° Ð¸ Ð½Ð°Ð¿Ð¸Ñ‚ÐºÐ¸', 
            events: 'Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð¸ Ñ€Ð°Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ', 
            spa: 'Ð¡Ð¿Ð°', 
            services: 'Ð£Ð´Ð¾Ð±ÑÑ‚Ð²Ð° Ð¸ ÑƒÑÐ»ÑƒÐ³Ð¸', 
            activities: 'ÐœÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ',
            discoverAll: 'ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð´Ð»Ñ ÑÐµÐ±Ñ Ð²ÑÐµ, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÐ¼',
            viewMenu: 'ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¼ÐµÐ½ÑŽ',
            location: 'Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ',
            mainLobby: 'Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð»Ð¾Ð±Ð±Ð¸',
            poolside: 'Ð£ Ð±Ð°ÑÑÐµÐ¹Ð½Ð°',
            beachfront: 'ÐÐ° Ð±ÐµÑ€ÐµÐ³Ñƒ',
            rooftop: 'ÐšÑ€Ñ‹ÑˆÐ°',
            garden: 'Ð¡Ð°Ð´'
          },
          pl: { 
            all: 'Wszystko', 
            restaurants: 'Jedzenie i napoje', 
            events: 'Wydarzenia i rozrywka', 
            spa: 'Spa', 
            services: 'Udogodnienia', 
            activities: 'ZajÄ™cia',
            discoverAll: 'Odkryj wszystko, co mamy do zaoferowania',
            viewMenu: 'Zobacz menu',
            location: 'Lokalizacja',
            mainLobby: 'GÅ‚Ã³wne lobby',
            poolside: 'Przy basenie',
            beachfront: 'Nad brzegiem',
            rooftop: 'Dach',
            garden: 'OgrÃ³d'
          },
          it: { 
            all: 'Tutti', 
            restaurants: 'Cibo e bevande', 
            events: 'Eventi e intrattenimento', 
            spa: 'Spa', 
            services: 'Strutture e servizi', 
            activities: 'AttivitÃ ',
            discoverAll: 'Scopri tutto ciÃ² che abbiamo da offrire',
            viewMenu: 'Visualizza menu',
            location: 'Posizione',
            mainLobby: 'Lobby principale',
            poolside: 'A bordo piscina',
            beachfront: 'Fronte mare',
            rooftop: 'Terrazza',
            garden: 'Giardino'
          },
          fr: { 
            all: 'Tout', 
            restaurants: 'Restaurants et boissons', 
            events: 'Ã‰vÃ©nements et divertissement', 
            spa: 'Spa', 
            services: 'Installations et commoditÃ©s', 
            activities: 'ActivitÃ©s',
            discoverAll: 'DÃ©couvrez tout ce que nous avons Ã  offrir',
            viewMenu: 'Voir le menu',
            location: 'Emplacement',
            mainLobby: 'Hall principal',
            poolside: 'Au bord de la piscine',
            beachfront: 'Front de mer',
            rooftop: 'Terrasse',
            garden: 'Jardin'
          },
          cs: { 
            all: 'VÅ¡e', 
            restaurants: 'JÃ­dlo a nÃ¡poje', 
            events: 'Akce a zÃ¡bava', 
            spa: 'Spa', 
            services: 'ZaÅ™Ã­zenÃ­ a vybavenÃ­', 
            activities: 'Aktivity',
            discoverAll: 'Objevte vÅ¡e, co nabÃ­zÃ­me',
            viewMenu: 'Zobrazit menu',
            location: 'UmÃ­stÄ›nÃ­',
            mainLobby: 'HlavnÃ­ hala',
            poolside: 'U bazÃ©nu',
            beachfront: 'NÃ¡bÅ™eÅ¾Ã­',
            rooftop: 'StÅ™echa',
            garden: 'Zahrada'
          },
          uk: { 
            all: 'Ð’ÑÐµ', 
            restaurants: 'Ð‡Ð¶Ð° Ñ‚Ð° Ð½Ð°Ð¿Ð¾Ñ—', 
            events: 'ÐŸÐ¾Ð´Ñ–Ñ— Ñ‚Ð° Ñ€Ð¾Ð·Ð²Ð°Ð³Ð¸', 
            spa: 'Ð¡Ð¿Ð°', 
            services: 'Ð—Ñ€ÑƒÑ‡Ð½Ð¾ÑÑ‚Ñ– Ñ‚Ð° Ð¿Ð¾ÑÐ»ÑƒÐ³Ð¸', 
            activities: 'Ð—Ð°Ñ…Ð¾Ð´Ð¸',
            discoverAll: 'Ð’Ñ–Ð´ÐºÑ€Ð¸Ð¹Ñ‚Ðµ Ð´Ð»Ñ ÑÐµÐ±Ðµ Ð²ÑÐµ, Ñ‰Ð¾ Ð¼Ð¸ Ð¿Ñ€Ð¾Ð¿Ð¾Ð½ÑƒÑ”Ð¼Ð¾',
            viewMenu: 'ÐŸÐµÑ€ÐµÐ³Ð»ÑÐ½ÑƒÑ‚Ð¸ Ð¼ÐµÐ½ÑŽ',
            location: 'Ð Ð¾Ð·Ñ‚Ð°ÑˆÑƒÐ²Ð°Ð½Ð½Ñ',
            mainLobby: 'Ð“Ð¾Ð»Ð¾Ð²Ð½Ðµ Ð»Ð¾Ð±Ñ–',
            poolside: 'Ð‘Ñ–Ð»Ñ Ð±Ð°ÑÐµÐ¹Ð½Ñƒ',
            beachfront: 'ÐÐ°Ð±ÐµÑ€ÐµÐ¶Ð½Ð°',
            rooftop: 'Ð”Ð°Ñ…',
            garden: 'Ð¡Ð°Ð´'
          },
          zh: { 
            all: 'å…¨éƒ¨', 
            restaurants: 'é¤é¥®', 
            events: 'æ´»åŠ¨ä¸Žå¨±ä¹', 
            spa: 'æ°´ç–—', 
            services: 'è®¾æ–½ä¸ŽæœåŠ¡', 
            activities: 'æ´»åŠ¨',
            discoverAll: 'æŽ¢ç´¢æˆ‘ä»¬çš„æ‰€æœ‰æœåŠ¡',
            viewMenu: 'æŸ¥çœ‹èœå•',
            location: 'ä½ç½®',
            mainLobby: 'å¤§å ‚',
            poolside: 'æ³³æ± è¾¹',
            beachfront: 'æµ·æ»¨',
            rooftop: 'å±‹é¡¶',
            garden: 'èŠ±å›­'
          },
          es: { 
            all: 'Todo', 
            restaurants: 'Comida y bebidas', 
            events: 'Eventos y entretenimiento', 
            spa: 'Spa', 
            services: 'Instalaciones y servicios', 
            activities: 'Actividades',
            discoverAll: 'Descubre todo lo que ofrecemos',
            viewMenu: 'Ver menÃº',
            location: 'UbicaciÃ³n',
            mainLobby: 'Lobby principal',
            poolside: 'Junto a la piscina',
            beachfront: 'Frente a la playa',
            rooftop: 'Azotea',
            garden: 'JardÃ­n'
          },
          ja: { 
            all: 'ã™ã¹ã¦', 
            restaurants: 'é£²é£Ÿ', 
            events: 'ã‚¤ãƒ™ãƒ³ãƒˆï¼†ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆ', 
            spa: 'ã‚¹ãƒ‘', 
            services: 'æ–½è¨­ï¼†ã‚µãƒ¼ãƒ“ã‚¹', 
            activities: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£',
            discoverAll: 'ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¦‹ã‚‹',
            viewMenu: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹',
            location: 'å ´æ‰€',
            mainLobby: 'ãƒ¡ã‚¤ãƒ³ãƒ­ãƒ“ãƒ¼',
            poolside: 'ãƒ—ãƒ¼ãƒ«ã‚µã‚¤ãƒ‰',
            beachfront: 'ãƒ“ãƒ¼ãƒãƒ•ãƒ­ãƒ³ãƒˆ',
            rooftop: 'å±‹ä¸Š',
            garden: 'åº­åœ’'
          },
          pt: { 
            all: 'Tudo', 
            restaurants: 'Comida e bebidas', 
            events: 'Eventos e entretenimento', 
            spa: 'Spa', 
            services: 'InstalaÃ§Ãµes e serviÃ§os', 
            activities: 'Atividades',
            discoverAll: 'Descubra tudo o que oferecemos',
            viewMenu: 'Ver menu',
            location: 'LocalizaÃ§Ã£o',
            mainLobby: 'Lobby principal',
            poolside: 'Ã€ beira da piscina',
            beachfront: 'Beira-mar',
            rooftop: 'Cobertura',
            garden: 'Jardim'
          },
          ko: { 
            all: 'ì „ì²´', 
            restaurants: 'ì‹ìŒë£Œ', 
            events: 'ì´ë²¤íŠ¸ ë° ì—”í„°í…Œì¸ë¨¼íŠ¸', 
            spa: 'ìŠ¤íŒŒ', 
            services: 'ì‹œì„¤ ë° ì„œë¹„ìŠ¤', 
            activities: 'ì•¡í‹°ë¹„í‹°',
            discoverAll: 'ëª¨ë“  ì„œë¹„ìŠ¤ ë³´ê¸°',
            viewMenu: 'ë©”ë‰´ ë³´ê¸°',
            location: 'ìœ„ì¹˜',
            mainLobby: 'ë©”ì¸ ë¡œë¹„',
            poolside: 'ìˆ˜ì˜ìž¥',
            beachfront: 'í•´ë³€',
            rooftop: 'ë£¨í”„íƒ‘',
            garden: 'ì •ì›'
          },
          hi: { 
            all: 'à¤¸à¤­à¥€', 
            restaurants: 'à¤­à¥‹à¤œà¤¨ à¤”à¤° à¤ªà¥‡à¤¯', 
            events: 'à¤•à¤¾à¤°à¥à¤¯à¤•à¥à¤°à¤® à¤”à¤° à¤®à¤¨à¥‹à¤°à¤‚à¤œà¤¨', 
            spa: 'à¤¸à¥à¤ªà¤¾', 
            services: 'à¤¸à¥à¤µà¤¿à¤§à¤¾à¤à¤‚ à¤”à¤° à¤¸à¥‡à¤µà¤¾à¤à¤‚', 
            activities: 'à¤—à¤¤à¤¿à¤µà¤¿à¤§à¤¿à¤¯à¤¾à¤',
            discoverAll: 'à¤¹à¤®à¤¾à¤°à¥€ à¤¸à¤­à¥€ à¤¸à¥‡à¤µà¤¾à¤“à¤‚ à¤•à¥€ à¤–à¥‹à¤œ à¤•à¤°à¥‡à¤‚',
            viewMenu: 'à¤®à¥‡à¤¨à¥‚ à¤¦à¥‡à¤–à¥‡à¤‚',
            location: 'à¤¸à¥à¤¥à¤¾à¤¨',
            mainLobby: 'à¤®à¥à¤–à¥à¤¯ à¤²à¥‰à¤¬à¥€',
            poolside: 'à¤ªà¥‚à¤²à¤¸à¤¾à¤‡à¤¡',
            beachfront: 'à¤¬à¥€à¤šà¤«à¥à¤°à¤‚à¤Ÿ',
            rooftop: 'à¤›à¤¤',
            garden: 'à¤¬à¤—à¥€à¤šà¤¾'
          },
          tr: { 
            all: 'TÃ¼mÃ¼', 
            restaurants: 'Yeme iÃ§me', 
            events: 'Etkinlikler ve eÄŸlence', 
            spa: 'Spa', 
            services: 'Tesisler ve hizmetler', 
            activities: 'Aktiviteler',
            discoverAll: 'TÃ¼m hizmetlerimizi keÅŸfedin',
            viewMenu: 'MenÃ¼yÃ¼ gÃ¶rÃ¼ntÃ¼le',
            location: 'Konum',
            mainLobby: 'Ana lobi',
            poolside: 'Havuz kenarÄ±',
            beachfront: 'Sahil',
            rooftop: 'Ã‡atÄ± katÄ±',
            garden: 'BahÃ§e'
          },
          el: { 
            all: 'ÎŒÎ»Î±', 
            restaurants: 'Î¦Î±Î³Î·Ï„ÏŒ ÎºÎ±Î¹ Ï€Î¿Ï„Î¬', 
            events: 'Î•ÎºÎ´Î·Î»ÏŽÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ Î´Î¹Î±ÏƒÎºÎ­Î´Î±ÏƒÎ·', 
            spa: 'Î£Ï€Î±', 
            services: 'Î•Î³ÎºÎ±Ï„Î±ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚', 
            activities: 'Î”ÏÎ±ÏƒÏ„Î·ÏÎ¹ÏŒÏ„Î·Ï„ÎµÏ‚',
            discoverAll: 'Î‘Î½Î±ÎºÎ±Î»ÏÏˆÏ„Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ Î¼Î±Ï‚',
            viewMenu: 'Î”ÎµÎ¯Ï„Îµ Ï„Î¿ Î¼ÎµÎ½Î¿Ï',
            location: 'Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±',
            mainLobby: 'ÎšÏÏÎ¹Î¿ Î»ÏŒÎ¼Ï€Î¹',
            poolside: 'Î”Î¯Ï€Î»Î± ÏƒÏ„Î·Î½ Ï€Î¹ÏƒÎ¯Î½Î±',
            beachfront: 'ÎœÏ€ÏÎ¿ÏƒÏ„Î¬ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±Î»Î¯Î±',
            rooftop: 'Î¤Î±ÏÎ¬Ï„ÏƒÎ±',
            garden: 'ÎšÎ®Ï€Î¿Ï‚'
          },
          sv: { 
            all: 'Alla', 
            restaurants: 'Mat och dryck', 
            events: 'Evenemang och underhÃ¥llning', 
            spa: 'Spa', 
            services: 'Faciliteter och tjÃ¤nster', 
            activities: 'Aktiviteter',
            discoverAll: 'UpptÃ¤ck alla vÃ¥ra tjÃ¤nster',
            viewMenu: 'Se meny',
            location: 'Plats',
            mainLobby: 'Huvudlobbyn',
            poolside: 'Vid poolen',
            beachfront: 'Strandfront',
            rooftop: 'TakfÃ¶nster',
            garden: 'TrÃ¤dgÃ¥rd'
          },
          no: { 
            all: 'Alle', 
            restaurants: 'Mat og drikke', 
            events: 'Arrangementer og underholdning', 
            spa: 'Spa', 
            services: 'Fasiliteter og tjenester', 
            activities: 'Aktiviteter',
            discoverAll: 'Oppdag alle vÃ¥re tjenester',
            viewMenu: 'Se meny',
            location: 'Plassering',
            mainLobby: 'Hovedlobbyen',
            poolside: 'Ved bassenget',
            beachfront: 'Strandfront',
            rooftop: 'Takterrasse',
            garden: 'Hage'
          },
          da: { 
            all: 'Alle', 
            restaurants: 'Mad og drikke', 
            events: 'Begivenheder og underholdning', 
            spa: 'Spa', 
            services: 'Faciliteter og tjenester', 
            activities: 'Aktiviteter',
            discoverAll: 'Opdag alle vores tjenester',
            viewMenu: 'Se menu',
            location: 'Placering',
            mainLobby: 'Hovedlobby',
            poolside: 'Ved poolen',
            beachfront: 'Strandfront',
            rooftop: 'Tagterrasse',
            garden: 'Have'
          },
          ro: { 
            all: 'Toate', 
            restaurants: 'MÃ¢ncare È™i bÄƒuturi', 
            events: 'Evenimente È™i divertisment', 
            spa: 'Spa', 
            services: 'FacilitÄƒÈ›i È™i servicii', 
            activities: 'ActivitÄƒÈ›i',
            discoverAll: 'DescoperÄƒ toate serviciile noastre',
            viewMenu: 'Vezi meniu',
            location: 'LocaÈ›ie',
            mainLobby: 'Lobby principal',
            poolside: 'LÃ¢ngÄƒ piscinÄƒ',
            beachfront: 'Front de plajÄƒ',
            rooftop: 'TerasÄƒ',
            garden: 'GrÄƒdinÄƒ'
          },
          hu: { 
            all: 'Ã–sszes', 
            restaurants: 'Ã‰tel Ã©s ital', 
            events: 'EsemÃ©nyek Ã©s szÃ³rakozÃ¡s', 
            spa: 'Spa', 
            services: 'LÃ©tesÃ­tmÃ©nyek Ã©s szolgÃ¡ltatÃ¡sok', 
            activities: 'TevÃ©kenysÃ©gek',
            discoverAll: 'Fedezze fel minden szolgÃ¡ltatÃ¡sunkat',
            viewMenu: 'MenÃ¼ megtekintÃ©se',
            location: 'HelyszÃ­n',
            mainLobby: 'FÅ‘ elÅ‘csarnok',
            poolside: 'Medence mellett',
            beachfront: 'Tengerpart',
            rooftop: 'TetÅ‘terasz',
            garden: 'Kert'
          },
          fi: { 
            all: 'Kaikki', 
            restaurants: 'Ruoka ja juoma', 
            events: 'Tapahtumat ja viihde', 
            spa: 'KylpylÃ¤', 
            services: 'Tilat ja palvelut', 
            activities: 'Aktiviteetit',
            discoverAll: 'Tutustu kaikkiin palveluihimme',
            viewMenu: 'NÃ¤ytÃ¤ menu',
            location: 'Sijainti',
            mainLobby: 'PÃ¤Ã¤aula',
            poolside: 'Uima-altaan vieressÃ¤',
            beachfront: 'Rantakatu',
            rooftop: 'Kattoterassi',
            garden: 'Puutarha'
          },
          hr: { 
            all: 'Sve', 
            restaurants: 'Hrana i piÄ‡e', 
            events: 'DogaÄ‘aji i zabava', 
            spa: 'Spa', 
            services: 'SadrÅ¾aji i usluge', 
            activities: 'Aktivnosti',
            discoverAll: 'Otkrijte sve naÅ¡e usluge',
            viewMenu: 'Pogledaj meni',
            location: 'Lokacija',
            mainLobby: 'Glavni lobi',
            poolside: 'Uz bazen',
            beachfront: 'PlaÅ¾a',
            rooftop: 'Terasa na krovu',
            garden: 'Vrt'
          },
          sk: { 
            all: 'VÅ¡etko', 
            restaurants: 'Jedlo a nÃ¡poje', 
            events: 'Udalosti a zÃ¡bava', 
            spa: 'Spa', 
            services: 'Zariadenia a sluÅ¾by', 
            activities: 'Aktivity',
            discoverAll: 'Objavte vÅ¡etky naÅ¡e sluÅ¾by',
            viewMenu: 'ZobraziÅ¥ menu',
            location: 'Umiestnenie',
            mainLobby: 'HlavnÃ¡ hala',
            poolside: 'Pri bazÃ©ne',
            beachfront: 'PobreÅ¾ie',
            rooftop: 'Strecha',
            garden: 'ZÃ¡hrada'
          },
          bg: { 
            all: 'Ð’ÑÐ¸Ñ‡ÐºÐ¸', 
            restaurants: 'Ð¥Ñ€Ð°Ð½Ð° Ð¸ Ð½Ð°Ð¿Ð¸Ñ‚ÐºÐ¸', 
            events: 'Ð¡ÑŠÐ±Ð¸Ñ‚Ð¸Ñ Ð¸ Ñ€Ð°Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ', 
            spa: 'Ð¡Ð¿Ð°', 
            services: 'Ð¡ÑŠÐ¾Ñ€ÑŠÐ¶ÐµÐ½Ð¸Ñ Ð¸ ÑƒÑÐ»ÑƒÐ³Ð¸', 
            activities: 'Ð”ÐµÐ¹Ð½Ð¾ÑÑ‚Ð¸',
            discoverAll: 'ÐžÑ‚ÐºÑ€Ð¸Ð¹Ñ‚Ðµ Ð²ÑÐ¸Ñ‡ÐºÐ¸ Ð½Ð°ÑˆÐ¸ ÑƒÑÐ»ÑƒÐ³Ð¸',
            viewMenu: 'Ð’Ð¸Ð¶Ñ‚Ðµ Ð¼ÐµÐ½ÑŽÑ‚Ð¾',
            location: 'ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ',
            mainLobby: 'Ð“Ð»Ð°Ð²Ð½Ð¾ Ñ„Ð¾Ð°Ð¹Ðµ',
            poolside: 'Ð”Ð¾ Ð±Ð°ÑÐµÐ¹Ð½Ð°',
            beachfront: 'ÐŸÐ»Ð°Ð¶Ð½Ð° Ð»Ð¸Ð½Ð¸Ñ',
            rooftop: 'ÐŸÐ¾ÐºÑ€Ð¸Ð²Ð½Ð° Ñ‚ÐµÑ€Ð°ÑÐ°',
            garden: 'Ð“Ñ€Ð°Ð´Ð¸Ð½Ð°'
          },
          sr: { 
            all: 'Ð¡Ð²Ðµ', 
            restaurants: 'Ð¥Ñ€Ð°Ð½Ð° Ð¸ Ð¿Ð¸Ñ›Ðµ', 
            events: 'Ð”Ð¾Ð³Ð°Ñ’Ð°Ñ˜Ð¸ Ð¸ Ð·Ð°Ð±Ð°Ð²Ð°', 
            spa: 'Ð¡Ð¿Ð°', 
            services: 'Ð¡Ð°Ð´Ñ€Ð¶Ð°Ñ˜Ð¸ Ð¸ ÑƒÑÐ»ÑƒÐ³Ðµ', 
            activities: 'ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸',
            discoverAll: 'ÐžÑ‚ÐºÑ€Ð¸Ñ˜Ñ‚Ðµ ÑÐ²Ðµ Ð½Ð°ÑˆÐµ ÑƒÑÐ»ÑƒÐ³Ðµ',
            viewMenu: 'ÐŸÐ¾Ð³Ð»ÐµÐ´Ð°Ñ˜Ñ‚Ðµ Ð¼ÐµÐ½Ð¸',
            location: 'Ð›Ð¾ÐºÐ°Ñ†Ð¸Ñ˜Ð°',
            mainLobby: 'Ð“Ð»Ð°Ð²Ð½Ð¸ Ð»Ð¾Ð±Ð¸',
            poolside: 'ÐšÐ¾Ð´ Ð±Ð°Ð·ÐµÐ½Ð°',
            beachfront: 'ÐŸÐ»Ð°Ð¶Ð°',
            rooftop: 'Ð¢ÐµÑ€Ð°ÑÐ° Ð½Ð° ÐºÑ€Ð¾Ð²Ñƒ',
            garden: 'Ð‘Ð°ÑˆÑ‚Ð°'
          },
          sl: { 
            all: 'Vse', 
            restaurants: 'Hrana in pijaÄa', 
            events: 'Dogodki in zabava', 
            spa: 'Spa', 
            services: 'Objekti in storitve', 
            activities: 'Dejavnosti',
            discoverAll: 'Odkrijte vse naÅ¡e storitve',
            viewMenu: 'Ogled menija',
            location: 'Lokacija',
            mainLobby: 'Glavna avla',
            poolside: 'Ob bazenu',
            beachfront: 'Obmorska fronta',
            rooftop: 'StreÅ¡na terasa',
            garden: 'Vrt'
          },
          th: { 
            all: 'à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”', 
            restaurants: 'à¸­à¸²à¸«à¸²à¸£à¹à¸¥à¸°à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸”à¸·à¹ˆà¸¡', 
            events: 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¸šà¸±à¸™à¹€à¸—à¸´à¸‡', 
            spa: 'à¸ªà¸›à¸²', 
            services: 'à¸ªà¸´à¹ˆà¸‡à¸­à¸³à¸™à¸§à¸¢à¸„à¸§à¸²à¸¡à¸ªà¸°à¸”à¸§à¸à¹à¸¥à¸°à¸šà¸£à¸´à¸à¸²à¸£', 
            activities: 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡',
            discoverAll: 'à¸„à¹‰à¸™à¸žà¸šà¸šà¸£à¸´à¸à¸²à¸£à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸‚à¸­à¸‡à¹€à¸£à¸²',
            viewMenu: 'à¸”à¸¹à¹€à¸¡à¸™à¸¹',
            location: 'à¸—à¸µà¹ˆà¸•à¸±à¹‰à¸‡',
            mainLobby: 'à¸¥à¹‡à¸­à¸šà¸šà¸µà¹‰à¸«à¸¥à¸±à¸',
            poolside: 'à¸£à¸´à¸¡à¸ªà¸£à¸°à¸§à¹ˆà¸²à¸¢à¸™à¹‰à¸³',
            beachfront: 'à¸Šà¸²à¸¢à¸«à¸²à¸”',
            rooftop: 'à¸”à¸²à¸”à¸Ÿà¹‰à¸²',
            garden: 'à¸ªà¸§à¸™'
          },
          id: { 
            all: 'Semua', 
            restaurants: 'Makanan dan minuman', 
            events: 'Acara dan hiburan', 
            spa: 'Spa', 
            services: 'Fasilitas dan layanan', 
            activities: 'Kegiatan',
            discoverAll: 'Temukan semua layanan kami',
            viewMenu: 'Lihat menu',
            location: 'Lokasi',
            mainLobby: 'Lobi utama',
            poolside: 'Di tepi kolam',
            beachfront: 'Tepi pantai',
            rooftop: 'Atap',
            garden: 'Taman'
          },
          vi: { 
            all: 'Táº¥t cáº£', 
            restaurants: 'áº¨m thá»±c vÃ  Ä‘á»“ uá»‘ng', 
            events: 'Sá»± kiá»‡n vÃ  giáº£i trÃ­', 
            spa: 'Spa', 
            services: 'Tiá»‡n nghi vÃ  dá»‹ch vá»¥', 
            activities: 'Hoáº¡t Ä‘á»™ng',
            discoverAll: 'KhÃ¡m phÃ¡ táº¥t cáº£ dá»‹ch vá»¥ cá»§a chÃºng tÃ´i',
            viewMenu: 'Xem thá»±c Ä‘Æ¡n',
            location: 'Vá»‹ trÃ­',
            mainLobby: 'Sáº£nh chÃ­nh',
            poolside: 'BÃªn há»“ bÆ¡i',
            beachfront: 'Máº·t tiá»n bÃ£i biá»ƒn',
            rooftop: 'SÃ¢n thÆ°á»£ng',
            garden: 'VÆ°á»n'
          },
          tl: { 
            all: 'Lahat', 
            restaurants: 'Pagkain at inumin', 
            events: 'Mga kaganapan at aliw', 
            spa: 'Spa', 
            services: 'Mga pasilidad at serbisyo', 
            activities: 'Mga aktibidad',
            discoverAll: 'Tuklasin ang lahat ng aming mga serbisyo',
            viewMenu: 'Tingnan ang menu',
            location: 'Lokasyon',
            mainLobby: 'Pangunahing lobby',
            poolside: 'Sa tabi ng pool',
            beachfront: 'Harap ng dalampasigan',
            rooftop: 'Bubungan',
            garden: 'Hardin'
          },
          ms: { 
            all: 'Semua', 
            restaurants: 'Makanan dan minuman', 
            events: 'Acara dan hiburan', 
            spa: 'Spa', 
            services: 'Kemudahan dan perkhidmatan', 
            activities: 'Aktiviti',
            discoverAll: 'Terokai semua perkhidmatan kami',
            viewMenu: 'Lihat menu',
            location: 'Lokasi',
            mainLobby: 'Lobi utama',
            poolside: 'Tepi kolam',
            beachfront: 'Tepi pantai',
            rooftop: 'Bumbung',
            garden: 'Taman'
          }
        };

        function applySectionTranslations(propertyData) {
          const lang = currentLanguage;
          
          // Update section headings
          const sections = ['restaurants', 'events', 'spa', 'service', 'activities'];
          sections.forEach(section => {
            const headingEl = document.getElementById('section-heading-' + section);
            if (headingEl) {
              const key = 'section_' + section + '_' + lang;
              // Check if database has THIS language's field
              const dbField = propertyData[key];
              let text;
              if (dbField) {
                // Use database value if exists
                text = dbField;
              } else if (translations[lang]) {
                // Fall back to translations object for languages not in database
                const translationKey = section === 'service' ? 'services' : section;
                text = translations[lang][translationKey];
              } else {
                // Final fallback to English
                text = propertyData['section_' + section + '_en'] || '';
              }
              if (text) {
                console.log('ðŸ”„ Updating section heading:', section, 'â†’', text);
                headingEl.textContent = text;
              }
            }
          });
          
          // Update category pills with custom section names from propertyData
          console.log('ðŸ·ï¸ Updating category pills in applySectionTranslations...');
          document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (key === 'pill-all') {
              el.textContent = translations[lang].all;
            } else if (key === 'pill-restaurants') {
              const dbField = propertyData['section_restaurants_' + lang];
              el.textContent = dbField || translations[lang].restaurants;
              console.log('  pill-restaurants:', el.textContent);
            } else if (key === 'pill-events') {
              const dbField = propertyData['section_events_' + lang];
              el.textContent = dbField || translations[lang].events;
            } else if (key === 'pill-spa') {
              const dbField = propertyData['section_spa_' + lang];
              el.textContent = dbField || translations[lang].spa;
            } else if (key === 'pill-services') {
              const dbField = propertyData['section_service_' + lang];
              el.textContent = dbField || translations[lang].services;
            } else if (key === 'pill-activities') {
              const dbField = propertyData['section_activities_' + lang];
              el.textContent = dbField || translations[lang].activities;
            }
          });
        }

        // Global HTML escape function to prevent syntax errors
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function renderCategoryPills() {
          const container = document.getElementById('category-pills-container');
          if (!container) {
            console.error('âŒ category-pills-container NOT FOUND!');
            return;
          }
          
          const lang = currentLanguage;
          const t = translations[lang] || translations.en;
          
          // Always show "All" pill
          let pillsHTML = \`
            <button onclick="filterOfferings('all')" class="category-pill bg-blue-500 text-white" data-category="all">
              <i class="fas fa-th-large mr-2"></i><span data-i18n="pill-all">\${t.all}</span>
            </button>
          \`;
          
          // Add default section pills only if visible (using custom section names)
          if (propertyData?.show_restaurants === 1) {
            const dbField = propertyData['section_restaurants_' + lang];
            const customName = dbField || t.restaurants;
            pillsHTML += \`
              <button onclick="filterOfferings('restaurant')" class="category-pill bg-gray-200 text-gray-700" data-category="restaurant">
                <i class="fas fa-utensils mr-2"></i><span data-i18n="pill-restaurants">\${customName}</span>
              </button>
            \`;
          }
          
          if (propertyData?.show_events === 1) {
            const dbField = propertyData['section_events_' + lang];
            const customName = dbField || t.events;
            pillsHTML += \`
              <button onclick="filterOfferings('event')" class="category-pill bg-gray-200 text-gray-700" data-category="event">
                <i class="fas fa-calendar-star mr-2"></i><span data-i18n="pill-events">\${customName}</span>
              </button>
            \`;
          }
          
          if (propertyData?.show_spa === 1) {
            const dbField = propertyData['section_spa_' + lang];
            const customName = dbField || t.spa;
            pillsHTML += \`
              <button onclick="filterOfferings('spa')" class="category-pill bg-gray-200 text-gray-700" data-category="spa">
                <i class="fas fa-spa mr-2"></i><span data-i18n="pill-spa">\${customName}</span>
              </button>
            \`;
          }
          
          if (propertyData?.show_service === 1) {
            const dbField = propertyData['section_service_' + lang];
            const customName = dbField || t.services;
            pillsHTML += \`
              <button onclick="filterOfferings('service')" class="category-pill bg-gray-200 text-gray-700" data-category="service">
                <i class="fas fa-concierge-bell mr-2"></i><span data-i18n="pill-services">\${customName}</span>
              </button>
            \`;
          }
          
          if (propertyData?.show_activities === 1) {
            const dbField = propertyData['section_activities_' + lang];
            const customName = dbField || t.activities;
            pillsHTML += \`
              <button onclick="filterOfferings('activities')" class="category-pill bg-gray-200 text-gray-700" data-category="activities">
                <i class="fas fa-hiking mr-2"></i><span data-i18n="pill-activities">\${customName}</span>
              </button>
            \`;
          }
          
          // Add custom section pills only if visible
          customSections.forEach(section => {
            if (section.is_visible === 1) {
              const sectionName = section[\`section_name_\${lang}\`] || section.section_name_en;
              const icon = section.icon_class || 'fas fa-star';
              pillsHTML += \`
                <button onclick="filterOfferings('\${section.section_key}')" class="category-pill bg-gray-200 text-gray-700" data-category="\${section.section_key}">
                  <i class="\${icon} mr-2"></i><span>\${sectionName}</span>
                </button>
              \`;
            }
          });
          
          // FORCE CLEAR FIRST to prevent cached HTML
          container.innerHTML = '';
          
          // Then set new content with slight delay
          setTimeout(() => {
            container.innerHTML = pillsHTML;
          }, 100);
        }

        async function init() {
            try {
                // Populate language selector with all available languages
                const languageSelector = document.getElementById('languageSelector');
                if (languageSelector) {
                    const supportedLangs = {
                        'en': { flag: 'ðŸ‡¬ðŸ‡§', native: 'English' },
                        'ar': { flag: 'ðŸ‡¸ðŸ‡¦', native: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' },
                        'de': { flag: 'ðŸ‡©ðŸ‡ª', native: 'Deutsch' },
                        'ru': { flag: 'ðŸ‡·ðŸ‡º', native: 'Ð ÑƒÑÑÐºÐ¸Ð¹' },
                        'pl': { flag: 'ðŸ‡µðŸ‡±', native: 'Polski' },
                        'it': { flag: 'ðŸ‡®ðŸ‡¹', native: 'Italiano' },
                        'fr': { flag: 'ðŸ‡«ðŸ‡·', native: 'FranÃ§ais' },
                        'cs': { flag: 'ðŸ‡¨ðŸ‡¿', native: 'ÄŒeÅ¡tina' },
                        'uk': { flag: 'ðŸ‡ºðŸ‡¦', native: 'Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°' },
                        'zh': { flag: 'ðŸ‡¨ðŸ‡³', native: 'ç®€ä½“ä¸­æ–‡' },
                        'es': { flag: 'ðŸ‡ªðŸ‡¸', native: 'EspaÃ±ol' },
                        'ja': { flag: 'ðŸ‡¯ðŸ‡µ', native: 'æ—¥æœ¬èªž' },
                        'pt': { flag: 'ðŸ‡µðŸ‡¹', native: 'PortuguÃªs' },
                        'ko': { flag: 'ðŸ‡°ðŸ‡·', native: 'í•œêµ­ì–´' },
                        'hi': { flag: 'ðŸ‡®ðŸ‡³', native: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€' },
                        'tr': { flag: 'ðŸ‡¹ðŸ‡·', native: 'TÃ¼rkÃ§e' },
                        'el': { flag: 'ðŸ‡¬ðŸ‡·', native: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬' },
                        'sv': { flag: 'ðŸ‡¸ðŸ‡ª', native: 'Svenska' },
                        'no': { flag: 'ðŸ‡³ðŸ‡´', native: 'Norsk' },
                        'da': { flag: 'ðŸ‡©ðŸ‡°', native: 'Dansk' },
                        'ro': { flag: 'ðŸ‡·ðŸ‡´', native: 'RomÃ¢nÄƒ' },
                        'hu': { flag: 'ðŸ‡­ðŸ‡º', native: 'Magyar' },
                        'fi': { flag: 'ðŸ‡«ðŸ‡®', native: 'Suomi' },
                        'hr': { flag: 'ðŸ‡­ðŸ‡·', native: 'Hrvatski' },
                        'sk': { flag: 'ðŸ‡¸ðŸ‡°', native: 'SlovenÄina' },
                        'bg': { flag: 'ðŸ‡§ðŸ‡¬', native: 'Ð‘ÑŠÐ»Ð³Ð°Ñ€ÑÐºÐ¸' },
                        'sr': { flag: 'ðŸ‡·ðŸ‡¸', native: 'Ð¡Ñ€Ð¿ÑÐºÐ¸' },
                        'sl': { flag: 'ðŸ‡¸ðŸ‡®', native: 'SlovenÅ¡Äina' },
                        'th': { flag: 'ðŸ‡¹ðŸ‡­', native: 'à¹„à¸—à¸¢' },
                        'id': { flag: 'ðŸ‡®ðŸ‡©', native: 'Bahasa Indonesia' },
                        'vi': { flag: 'ðŸ‡»ðŸ‡³', native: 'Tiáº¿ng Viá»‡t' },
                        'tl': { flag: 'ðŸ‡µðŸ‡­', native: 'Tagalog' },
                        'ms': { flag: 'ðŸ‡²ðŸ‡¾', native: 'Bahasa Melayu' }
                    };
                    
                    languageSelector.innerHTML = '';
                    Object.entries(supportedLangs).forEach(([code, lang]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = \`\${lang.flag} \${lang.native}\`;
                        languageSelector.appendChild(option);
                    });
                    languageSelector.value = currentLanguage;
                }
                
                // Get property details
                const propResponse = await fetch(\`/api/properties?slug=\${propertySlug}\`);
                const propData = await propResponse.json();
                
                if (!propData.properties || propData.properties.length === 0) {
                    throw new Error('Property not found');
                }
                
                propertyData = propData.properties[0];
                document.getElementById('propertyName').textContent = propertyData.name;
                
                // Set tagline with translation support
                const taglineEl = document.getElementById('propertyTagline');
                if (propertyData.tagline) {
                  taglineEl.textContent = propertyData.tagline;
                } else {
                  // Use translated default tagline
                  const t = translations[currentLanguage] || translations.en;
                  taglineEl.textContent = t.discoverAll;
                }
                
                document.title = propertyData.name;
                
                // Track QR scan
                trackQRScan();
                
                // Apply design settings
                applyDesignSettings(propertyData);
                
                // Apply translations to section headings
                applySectionTranslations(propertyData);
                
                // Load info pages after property data is loaded
                loadInfoPages();
                
                // Load feedback form for homepage (if exists)
                loadHomepageFeedbackForm();
                
                // Load hotel offerings with language
                const offeringsResponse = await fetch(\`/api/hotel-offerings/\${propertyData.property_id}?lang=\${currentLanguage}\`);
                const offeringsData = await offeringsResponse.json();
                allOfferings = offeringsData.offerings || [];
                
                // Load vendor activities with language
                const activitiesResponse = await fetch(\`/api/property-vendor-activities/\${propertyData.property_id}?lang=\${currentLanguage}\`);
                const activitiesData = await activitiesResponse.json();
                allActivities = activitiesData.activities || [];
                
                // Load custom sections
                const customSectionsResponse = await fetch(\`/api/admin/custom-sections?property_id=\${propertyData.property_id}\`);
                const customSectionsData = await customSectionsResponse.json();
                customSections = customSectionsData.sections || [];
                
                // Render category pills including custom sections
                renderCategoryPills();
                
                // Render all content (await because it's now async)
                await renderContent();
                
                // Update section headings with translations
                updateSectionHeadings();
                
                // Hide loading, show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                
                // Initialize chatbot after all data is loaded
                if (typeof initChatbot === 'function') {
                    initChatbot();
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                console.error('Error details:', error.message, error.stack);
                document.getElementById('loading').innerHTML = \`
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
                        <p class="text-gray-600">Unable to load content</p>
                        <p class="text-sm text-red-600 mt-2">Error: \${error.message || 'Unknown error'}</p>
                        <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg">
                            Try Again
                        </button>
                    </div>
                \`;
            }
        }

        async function renderContent() {
            // Get section order from property settings
            const sectionOrder = propertyData.homepage_section_order ? 
              JSON.parse(propertyData.homepage_section_order) : 
              ['restaurants', 'events', 'spa', 'service', 'activities'];
            
            // Get container
            const container = document.querySelector('.max-w-6xl.mx-auto.px-4.py-6');
            
            // Collect all section elements
            const sectionElements = {
              'restaurants': document.getElementById('restaurants-section'),
              'events': document.getElementById('events-section'),
              'spa': document.getElementById('spa-section'),
              'service': document.getElementById('service-section'),
              'activities': document.getElementById('activities-section'),
              'beach-booking': document.getElementById('beach-booking-section'),
              'hotel-map': document.getElementById('hotel-map-section')
            };
            
            // Create and add custom section elements dynamically
            customSections.forEach(section => {
              if (section.is_visible === 1) {
                let customSectionEl = document.getElementById(\`custom-section-\${section.section_key}\`);
                
                // Create if doesn't exist
                if (!customSectionEl) {
                  customSectionEl = document.createElement('section');
                  customSectionEl.id = \`custom-section-\${section.section_key}\`;
                  customSectionEl.className = 'mb-12';
                  
                  const lang = currentLanguage;
                  const sectionName = section['section_name_' + lang] || section.section_name_en;
                  const icon = section.icon_class || 'fas fa-star';
                  
                  customSectionEl.innerHTML = '<h2 class="text-2xl font-bold mb-4 flex items-center">' +
                    '<i class="' + icon + ' text-blue-500 mr-3"></i>' +
                    '<span>' + sectionName + '</span>' +
                    '</h2>' +
                    '<div id="custom-grid-' + section.section_key + '" class="grid grid-cols-1 gap-4">' +
                    '<!-- Loaded dynamically -->' +
                    '</div>';
                }
                
                sectionElements[section.section_key] = customSectionEl;
              }
            });
            
            // Detach all sections
            Object.values(sectionElements).forEach(el => {
              if (el && el.parentNode) {
                el.parentNode.removeChild(el);
              }
            });
            
            // Re-append in specified order
            sectionOrder.forEach(section => {
              if (sectionElements[section]) {
                container.appendChild(sectionElements[section]);
              }
            });
            
            // Always append hotel map at the end (unless it's in the order already)
            if (sectionElements['hotel-map'] && !sectionOrder.includes('hotel-map')) {
              container.appendChild(sectionElements['hotel-map']);
            }
            
            // Render each section's content (await all async renders)
            await Promise.all([
                renderRestaurants(),
                renderEvents(),
                renderSpa(),
                renderServices(),
                renderActivities(),
                renderHotelMap(),
                // Render custom sections
                ...customSections.map(section => 
                    section.is_visible === 1 ? renderCustomSection(section.section_key) : Promise.resolve()
                )
            ]).catch(err => console.error('Render error:', err));
            
            updateSectionVisibility();
            
            // Check beach booking after property data is loaded
            if (propertyData && propertyData.property_id) {
                checkBeachBookingEnabled();
            }
        }

        async function renderRestaurants() {
            const restaurants = allOfferings.filter(o => o.offering_type === 'restaurant');
            const grid = document.getElementById('restaurants-grid');
            
            if (!grid) {
                console.error('restaurants-grid element not found');
                return;
            }
            
            if (restaurants.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full">' + t('no-restaurants') + '</p>';
                return;
            }
            
            const bookTableText = t('book-table');
            const reservationsText = t('reservations');
            const viewDetailsText = t('view-details');
            
            const cardsHtml = await Promise.all(restaurants.map(async r => {
                const title = await getTranslatedField(r, 'title');
                const description = await getTranslatedField(r, 'short_description');
                return \`
                <div class="offering-card bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-xl transition-all duration-300">
                    <div class="relative cursor-pointer" onclick="viewOffering(\${r.offering_id})">
                        <img src="\${r.images[0] || '/static/placeholder.jpg'}" 
                             alt="\${title}" 
                             class="w-full h-48 object-cover">
                        <div class="absolute top-3 right-3">
                            \${r.requires_booking ? '<span class="bg-white/95 backdrop-blur-sm text-blue-600 px-3 py-1.5 rounded-full text-xs font-medium shadow-lg"><i class="fas fa-calendar-check mr-1"></i>' + reservationsText + '</span>' : ''}
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-xl mb-2 text-gray-800 cursor-pointer" onclick="viewOffering(\${r.offering_id})">\${title}</h3>
                        <p class="text-sm text-gray-600 mb-4 line-clamp-2">\${description}</p>
                        <div class="flex items-center text-sm text-gray-500 mb-4">
                            <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
                            <span>\${translateLocation(r.location)}</span>
                        </div>
                        <div class="pt-3 border-t border-gray-100 flex gap-2">
                            <button onclick="viewOffering(\${r.offering_id})" 
                                    class="flex-1 bg-secondary text-white py-2.5 rounded-lg hover:opacity-90 font-semibold text-sm transition-all">
                                <i class="fas fa-info-circle mr-2"></i>\${viewDetailsText}
                            </button>
                        </div>
                    </div>
                </div>
                \`;
            }));
            
            grid.innerHTML = cardsHtml.join('');
        }

        async function renderEvents() {
            const events = allOfferings.filter(o => o.offering_type === 'event');
            const grid = document.getElementById('events-grid');
            
            if (!grid) {
                console.error('events-grid element not found');
                return;
            }
            
            if (events.length === 0) {
                grid.innerHTML = '<p class="text-gray-500">' + t('no-events') + '</p>';
                return;
            }
            
            const cardsHtml = await Promise.all(events.map(async e => {
                const title = await getTranslatedField(e, 'title');
                const description = await getTranslatedField(e, 'short_description');
                return \`
                <div class="offering-card bg-white rounded-xl shadow-sm overflow-hidden cursor-pointer hover:shadow-xl transition-all duration-300" onclick="viewOffering(\${e.offering_id})">
                    <div class="relative">
                        <img src="\${e.images[0] || '/static/placeholder.jpg'}" 
                             alt="\${title}" 
                             class="w-full h-48 object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                        <div class="absolute bottom-3 left-3 right-3">
                            \${e.event_date ? '<span class="bg-white/95 backdrop-blur-sm text-purple-600 px-3 py-1.5 rounded-full text-xs font-medium inline-block shadow-lg"><i class="fas fa-calendar mr-1"></i>' + new Date(e.event_date).toLocaleDateString() + '</span>' : ''}
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-xl mb-2 text-gray-800">\${title}</h3>
                        <p class="text-sm text-gray-600 mb-4 line-clamp-2">\${description}</p>
                        <div class="flex items-center gap-3 text-sm text-gray-500 mb-4">
                            \${e.event_start_time ? '<span><i class="fas fa-clock mr-2 text-gray-400"></i>' + e.event_start_time + '</span>' : ''}
                        </div>
                        <div class="pt-3 border-t border-gray-100 flex items-center justify-between">
                            <span class="text-xs text-gray-400 uppercase tracking-wider font-medium">\${t('learn-more')}</span>
                            <i class="fas fa-arrow-right text-purple-600"></i>
                        </div>
                    </div>
                </div>
                \`;
            }));
            
            grid.innerHTML = cardsHtml.join('');
        }

        async function renderSpa() {
            const spa = allOfferings.filter(o => o.offering_type === 'spa');
            const grid = document.getElementById('spa-grid');
            
            if (!grid) {
                console.error('spa-grid element not found');
                return;
            }
            
            if (spa.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full">' + t('no-spa') + '</p>';
                return;
            }
            
            const discoverText = t('discover');
            const minutesText = t('minutes');
            
            const cardsHtml = await Promise.all(spa.map(async s => {
                const title = await getTranslatedField(s, 'title');
                const description = await getTranslatedField(s, 'short_description');
                return \`
                <div class="offering-card bg-white rounded-xl shadow-sm overflow-hidden cursor-pointer hover:shadow-xl transition-all duration-300" onclick="viewOffering(\${s.offering_id})">
                    <div class="relative">
                        <img src="\${s.images[0] || '/static/placeholder.jpg'}" 
                             alt="\${title}" 
                             class="w-full h-48 object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-emerald-900/40 via-transparent to-transparent"></div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-xl mb-2 text-gray-800">\${title}</h3>
                        <p class="text-sm text-gray-600 mb-4 line-clamp-2">\${description}</p>
                        <div class="flex items-center text-sm text-gray-500 mb-4">
                            <i class="fas fa-clock mr-2 text-gray-400"></i>
                            <span>\${s.duration_minutes} \${minutesText}</span>
                        </div>
                        <div class="pt-3 border-t border-gray-100 flex items-center justify-between">
                            <span class="text-xs text-gray-400 uppercase tracking-wider font-medium">\${discoverText}</span>
                            <i class="fas fa-arrow-right text-secondary"></i>
                        </div>
                    </div>
                </div>
                \`;
            }));
            
            grid.innerHTML = cardsHtml.join('');
        }

        async function renderServices() {
            const services = allOfferings.filter(o => o.offering_type === 'service');
            const grid = document.getElementById('service-grid');
            
            if (!grid) {
                console.error('service-grid element not found');
                return;
            }
            
            if (services.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full">' + t('no-services') + '</p>';
                return;
            }
            
            const viewDetailsText = t('view-details');
            
            const cardsHtml = await Promise.all(services.map(async s => {
                const title = await getTranslatedField(s, 'title');
                const description = await getTranslatedField(s, 'short_description');
                return \`
                <div class="offering-card bg-white rounded-xl shadow-sm overflow-hidden cursor-pointer hover:shadow-xl transition-all duration-300" onclick="viewOffering(\${s.offering_id})">
                    <div class="relative">
                        <img src="\${s.images[0] || '/static/placeholder.jpg'}" 
                             alt="\${title}" 
                             class="w-full h-48 object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-indigo-900/40 via-transparent to-transparent"></div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-xl mb-2 text-gray-800">\${title}</h3>
                        <p class="text-sm text-gray-600 mb-4 line-clamp-2">\${description}</p>
                        \${s.location ? '<div class="flex items-center text-sm text-gray-500 mb-4"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i><span>' + translateLocation(s.location) + '</span></div>' : ''}
                        <div class="pt-3 border-t border-gray-100 flex items-center justify-between">
                            <span class="text-xs text-gray-400 uppercase tracking-wider font-medium">\${viewDetailsText}</span>
                            <i class="fas fa-arrow-right text-secondary"></i>
                        </div>
                    </div>
                </div>
                \`;
            }));
            
            grid.innerHTML = cardsHtml.join('');
        }

        async function renderActivities() {
            const grid = document.getElementById('activities-grid');
            
            if (!grid) {
                console.error('activities-grid element not found');
                return;
            }
            
            if (allActivities.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full">' + t('no-activities') + '</p>';
                return;
            }
            
            const curatedByText = t('curated-by');
            const minutesText = t('minutes');
            const bookNowText = t('book-now');
            
            const cardsHtml = await Promise.all(allActivities.map(async a => {
                // Translate title and description using AI
                const title = await translateText(a.title, currentLanguage);
                const description = await translateText(a.short_description, currentLanguage);
                
                // Use global escapeHtml to prevent syntax errors from special characters
                const safeTitle = escapeHtml(title);
                const safeDescription = escapeHtml(description);
                const safeBusinessName = escapeHtml(a.business_name);
                const safeCategoryName = escapeHtml(a.category_name);
                
                return \`
                <div class="offering-card bg-white rounded-xl shadow-sm overflow-hidden cursor-pointer hover:shadow-xl transition-all duration-300" onclick="viewActivity(\${a.activity_id})">
                    <div class="relative">
                        <img src="\${a.images[0] || '/static/placeholder.jpg'}" 
                             alt="\${safeTitle}" 
                             class="w-full h-48 object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-orange-900/40 via-transparent to-transparent"></div>
                        <div class="absolute top-3 right-3">
                            <span class="bg-white/95 backdrop-blur-sm text-orange-600 px-3 py-1.5 rounded-full text-xs font-medium shadow-lg">\${safeCategoryName}</span>
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-xl mb-1 text-gray-800">\${safeTitle}</h3>
                        <p class="text-xs text-gray-500 mb-3">\${curatedByText} \${safeBusinessName}</p>
                        <p class="text-sm text-gray-600 mb-4 line-clamp-2">\${safeDescription}</p>
                        <div class="flex items-center text-sm text-gray-500 mb-4">
                            <i class="fas fa-clock mr-2 text-gray-400"></i>
                            <span>\${a.duration_minutes} \${minutesText}</span>
                        </div>
                        <div class="pt-3 border-t border-gray-100 flex items-center justify-between">
                            <span class="text-xs text-gray-400 uppercase tracking-wider font-medium">\${bookNowText}</span>
                            <i class="fas fa-arrow-right text-secondary"></i>
                        </div>
                    </div>
                </div>
                \`;
            }));
            
            grid.innerHTML = cardsHtml.join('');
        }
        
        async function renderCustomSection(sectionKey) {
            // Filter offerings by custom_section_key
            const sectionOfferings = allOfferings.filter(o => 
              o.offering_type === 'custom' && o.custom_section_key === sectionKey
            );
            
            const grid = document.getElementById(\`custom-grid-\${sectionKey}\`);
            
            if (!grid) {
                console.error(\`custom-grid-\${sectionKey} element not found\`);
                return;
            }
            
            if (sectionOfferings.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full">' + t('no-items') + '</p>';
                return;
            }
            
            const reservationsText = t('reservations');
            
            // Render as elegant cards (similar to other sections)
            const cardsHtml = await Promise.all(sectionOfferings.map(async o => {
                const title = await getTranslatedField(o, 'title');
                const description = await getTranslatedField(o, 'short_description');
                return \`
                <div class="offering-card bg-white rounded-xl shadow-sm overflow-hidden cursor-pointer hover:shadow-xl transition-all duration-300" onclick="viewOffering(\${o.offering_id})">
                    <div class="relative">
                        <img src="\${o.images[0] || '/static/placeholder.jpg'}" 
                             alt="\${title}" 
                             class="w-full h-48 object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
                        <div class="absolute top-3 right-3">
                            \${o.requires_booking ? '<span class="bg-white/95 backdrop-blur-sm text-blue-600 px-3 py-1.5 rounded-full text-xs font-medium shadow-lg"><i class="fas fa-calendar-check mr-1"></i>' + reservationsText + '</span>' : ''}
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-xl mb-2 text-gray-800">\${title}</h3>
                        <p class="text-sm text-gray-600 mb-4 line-clamp-2">\${description}</p>
                        \${o.location ? \`
                            <div class="flex items-center text-sm text-gray-500 mb-4">
                                <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
                                <span>\${translateLocation(o.location)}</span>
                            </div>
                        \` : ''}
                        <div class="pt-3 border-t border-gray-100 flex items-center justify-between">
                            <span class="text-sm text-blue-600 font-medium hover:text-blue-700 transition">
                                <i class="fas fa-arrow-right mr-1"></i>\${t('explore-more')}
                            </span>
                        </div>
                    </div>
                </div>
                \`;
            }));
            
            grid.innerHTML = cardsHtml.join('');
        }

        async function renderHotelMap() {
            const mapFloatingBtn = document.getElementById('mapFloatingBtn');
            const mapContainer = document.getElementById('hotel-map-container');
            
            if (!mapFloatingBtn || !mapContainer) {
                console.error('map elements not found');
                return;
            }
            
            if (propertyData.show_hotel_map === 1 && propertyData.hotel_map_url) {
                // Show floating button
                mapFloatingBtn.classList.remove('hidden');
                
                // Load interactive hotspots
                try {
                    const response = await fetch('/api/admin/hotel-map/hotspots/' + propertyData.property_id);
                    const data = await response.json();
                    
                    if (data.success && data.hotspots && data.hotspots.length > 0) {
                        // Render interactive map with hotspots
                        mapContainer.innerHTML = \`
                            <div class="relative w-full" style="padding-bottom: 75%;">
                                <img src="\${propertyData.hotel_map_url}" 
                                     alt="Hotel Map" 
                                     class="absolute inset-0 w-full h-full object-contain rounded-lg">
                                <div id="mapHotspots" class="absolute inset-0">
                                    \${data.hotspots.map(hotspot => \`
                                        <div class="absolute cursor-pointer transition-all duration-200 hover:z-50 group"
                                             style="left: \${hotspot.position_x}%; top: \${hotspot.position_y}%; width: \${hotspot.width}%; height: \${hotspot.height}%;"
                                             onclick="showHotspotInfo('\${hotspot.hotspot_id}')">
                                            <div class="w-full h-full border-3 rounded-lg \${hotspot.shape === 'circle' ? 'rounded-full' : ''}"
                                                 style="border-color: \${hotspot.color}; background: \${hotspot.color}20;">
                                                <div class="flex items-center justify-center w-full h-full text-2xl">
                                                    \${hotspot.building_number || 'ðŸ“'}
                                                </div>
                                            </div>
                                            <!-- Tooltip on hover -->
                                            <div class="absolute hidden group-hover:block bg-black text-white px-3 py-2 rounded-lg text-sm whitespace-nowrap -top-12 left-1/2 transform -translate-x-1/2 z-50 shadow-xl">
                                                <div class="font-bold">\${hotspot.title}</div>
                                                \${hotspot.subtitle ? '<div class="text-xs text-gray-300">' + hotspot.subtitle + '</div>' : ''}
                                                <div class="absolute w-3 h-3 bg-black transform rotate-45 -bottom-1 left-1/2 -translate-x-1/2"></div>
                                            </div>
                                        </div>
                                    \`).join('')}
                                </div>
                            </div>
                            
                            <!-- Hotspot Details Modal -->
                            <div id="hotspotModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
                                <div class="bg-white rounded-2xl max-w-md w-full p-6 relative">
                                    <button onclick="closeHotspotModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                    <div id="hotspotModalContent"></div>
                                </div>
                            </div>
                        \`;
                        
                        // Store hotspots data globally for modal
                        window.mapHotspots = data.hotspots;
                    } else {
                        // No hotspots, show static map
                        mapContainer.innerHTML = \`
                            <img src="\${propertyData.hotel_map_url}" 
                                 alt="Hotel Map" 
                                 class="w-full h-auto rounded-lg"
                                 style="max-height: 80vh; object-fit: contain;">
                        \`;
                    }
                } catch (error) {
                    console.error('Load map hotspots error:', error);
                    // Fallback to static map
                    mapContainer.innerHTML = \`
                        <img src="\${propertyData.hotel_map_url}" 
                             alt="Hotel Map" 
                             class="w-full h-auto rounded-lg"
                             style="max-height: 80vh; object-fit: contain;">
                    \`;
                }
            } else {
                // Hide floating button if no map
                mapFloatingBtn.classList.add('hidden');
            }
        }
        
        function showHotspotInfo(hotspotId) {
            const hotspot = window.mapHotspots.find(h => h.hotspot_id == hotspotId);
            if (!hotspot) return;
            
            const modal = document.getElementById('hotspotModal');
            const content = document.getElementById('hotspotModalContent');
            
            content.innerHTML = \`
                <div class="text-center mb-4">
                    <div class="text-4xl mb-3">\${hotspot.building_number ? 'ðŸ¨' : 'ðŸ“'}</div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-1">\${hotspot.title}</h3>
                    \${hotspot.subtitle ? '<p class="text-gray-600">' + hotspot.subtitle + '</p>' : ''}
                </div>
                
                \${hotspot.building_number ? '<div class="bg-blue-50 rounded-lg p-3 mb-4 text-center"><span class="font-bold text-blue-900">Building ' + hotspot.building_number + '</span></div>' : ''}
                
                \${hotspot.description ? '<p class="text-gray-700 mb-4">' + hotspot.description + '</p>' : ''}
                
                \${hotspot.link_url ? '<a href="' + hotspot.link_url + '" class="block w-full py-3 bg-blue-600 text-white text-center rounded-lg font-semibold hover:bg-blue-700 transition"><i class="fas fa-external-link-alt mr-2"></i>Learn More</a>' : ''}
            \`;
            
            modal.classList.remove('hidden');
        }
        
        function closeHotspotModal() {
            document.getElementById('hotspotModal').classList.add('hidden');
        }
        
        function openMapModal() {
            document.getElementById('mapModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMapModal() {
            document.getElementById('mapModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function checkBeachBookingEnabled() {
            if (!propertyData || !propertyData.property_id) {
                console.log('Property data not loaded yet');
                return false;
            }
            
            try {
                const response = await fetch('/api/admin/beach/settings/' + propertyData.property_id);
                const data = await response.json();
                
                console.log('Beach settings response:', data);
                
                if (data.success && data.settings && data.settings.beach_booking_enabled === 1) {
                    const section = document.getElementById('beach-booking-section');
                    if (section) {
                        const s = data.settings;
                        
                        // Apply custom colors
                        const bgFrom = s.bg_color_from || '#3b82f6';
                        const bgTo = s.bg_color_to || '#06b6d4';
                        const textColor = s.text_color || '#ffffff';
                        const btnFrom = s.button_color_from || '#ffffff';
                        const btnTo = s.button_color_to || '#ffffff';
                        const btnTextColor = s.button_text_color || '#3b82f6';
                        
                        const card = section.querySelector('.bg-gradient-to-r');
                        if (card) {
                            card.style.background = 'linear-gradient(to right, ' + bgFrom + ', ' + bgTo + ')';
                        }
                        
                        // Apply custom text and color
                        const title = section.querySelector('h2');
                        if (title) {
                            title.innerHTML = '<i class=\"fas fa-umbrella-beach mr-3\"></i>' + (s.card_title || 'Beach Booking');
                            title.style.setProperty('color', textColor, 'important');
                        }
                        
                        const subtitle = section.querySelector('p');
                        if (subtitle) {
                            subtitle.textContent = s.card_subtitle || 'Reserve your perfect spot by the sea! Select from umbrellas, cabanas, and premium locations.';
                            subtitle.style.setProperty('color', textColor, 'important');
                        }
                        
                        // Update features and apply color
                        const features = section.querySelectorAll('.flex.items-center.gap-2 span');
                        if (features[0]) {
                            features[0].textContent = s.feature1_text || 'Free for Hotel Guests';
                            features[0].style.setProperty('color', textColor, 'important');
                        }
                        if (features[1]) {
                            features[1].textContent = s.feature2_text || 'Book Up to 7 Days Ahead';
                            features[1].style.setProperty('color', textColor, 'important');
                        }
                        if (features[2]) {
                            features[2].textContent = s.feature3_text || 'QR Code Check-in';
                            features[2].style.setProperty('color', textColor, 'important');
                        }
                        
                        // Apply color to feature icons
                        const featureIcons = section.querySelectorAll('.flex.items-center.gap-2 i');
                        featureIcons.forEach(icon => {
                            icon.style.setProperty('color', textColor, 'important');
                        });
                        
                        // Update button
                        const button = section.querySelector('button');
                        if (button) {
                            button.style.background = 'linear-gradient(to right, ' + btnFrom + ', ' + btnTo + ')';
                            button.style.color = btnTextColor;
                            const btnText = button.querySelector('.fa-calendar-check').nextSibling;
                            if (btnText) btnText.textContent = ' ' + (s.button_text || 'Book Your Spot Now');
                        }
                        
                        // Update spot categories and apply color
                        const spots = section.querySelectorAll('#beach-spots-preview .font-semibold');
                        if (spots[0]) {
                            spots[0].textContent = s.umbrellas_label || 'Umbrellas';
                            spots[0].style.setProperty('color', textColor, 'important');
                        }
                        if (spots[1]) {
                            spots[1].textContent = s.cabanas_label || 'Cabanas';
                            spots[1].style.setProperty('color', textColor, 'important');
                        }
                        if (spots[2]) {
                            spots[2].textContent = s.loungers_label || 'Loungers';
                            spots[2].style.setProperty('color', textColor, 'important');
                        }
                        if (spots[3]) {
                            spots[3].textContent = s.daybeds_label || 'Daybeds';
                            spots[3].style.setProperty('color', textColor, 'important');
                        }
                        
                        const spotDescs = section.querySelectorAll('#beach-spots-preview .text-sm');
                        if (spotDescs[0]) {
                            spotDescs[0].textContent = s.umbrellas_desc || 'Classic Beach';
                            spotDescs[0].style.setProperty('color', textColor, 'important');
                        }
                        if (spotDescs[1]) {
                            spotDescs[1].textContent = s.cabanas_desc || 'Private & Cozy';
                            spotDescs[1].style.setProperty('color', textColor, 'important');
                        }
                        if (spotDescs[2]) {
                            spotDescs[2].textContent = s.loungers_desc || 'Relax in Style';
                            spotDescs[2].style.setProperty('color', textColor, 'important');
                        }
                        if (spotDescs[3]) {
                            spotDescs[3].textContent = s.daybeds_desc || 'Ultimate Comfort';
                            spotDescs[3].style.setProperty('color', textColor, 'important');
                        }
                        
                        section.classList.remove('hidden');
                        console.log('Beach booking section shown with custom styling!');
                    } else {
                        console.error('Beach booking section element not found');
                    }
                    return true;
                }
            } catch (error) {
                console.error('Check beach booking error:', error);
            }
            return false;
        }
        
        function goToBeachBooking() {
            window.location.href = '/beach-booking/' + propertyData.property_id;
        }

        function updateSectionVisibility() {
            const sections = {
                'restaurants': { el: document.getElementById('restaurants-section'), visible: propertyData?.show_restaurants === 1 },
                'events': { el: document.getElementById('events-section'), visible: propertyData?.show_events === 1 },
                'spa': { el: document.getElementById('spa-section'), visible: propertyData?.show_spa === 1 },
                'service': { el: document.getElementById('service-section'), visible: propertyData?.show_service === 1 },
                'activities': { el: document.getElementById('activities-section'), visible: propertyData?.show_activities === 1 }
            };
            
            // Add custom sections
            customSections.forEach(cs => {
                sections[cs.section_key] = {
                    el: document.getElementById(\`custom-section-\${cs.section_key}\`),
                    visible: cs.is_visible === 1
                };
            });
            
            // Map filter values to section keys (handle singular/plural)
            const filterToSectionMap = {
                'all': 'all',
                'restaurant': 'restaurants',
                'event': 'events',
                'spa': 'spa',
                'service': 'service',
                'activities': 'activities'
            };
            
            const mappedFilter = filterToSectionMap[currentFilter] || currentFilter;
            
            // Apply filter
            Object.keys(sections).forEach(key => {
                const section = sections[key];
                if (!section.el) return;
                
                if (mappedFilter === 'all') {
                    // Show if enabled in settings
                    section.el.style.display = section.visible ? 'block' : 'none';
                } else {
                    // Show only the filtered section (if enabled)
                    section.el.style.display = (key === mappedFilter && section.visible) ? 'block' : 'none';
                }
            });
        }

        function filterOfferings(category) {
            currentFilter = category;
            
            // Track page view for the section
            if (category !== 'all') {
                trackPageView(category, null);
            }
            
            // Update pill styles
            document.querySelectorAll('.category-pill').forEach(pill => {
                if (pill.dataset.category === category) {
                    pill.className = 'category-pill bg-blue-500 text-white';
                } else {
                    pill.className = 'category-pill bg-gray-200 text-gray-700';
                }
            });
            
            updateSectionVisibility();
        }

        function viewOffering(offeringId) {
            trackPageView('offering', String(offeringId));
            // Always go to detail page first to show info
            window.location.href = '/offering-detail?id=' + offeringId + '&property=' + propertyData.property_id + '&lang=' + currentLanguage;
        }

        function viewActivity(activityId) {
            trackPageView('activity', String(activityId));
            window.location.href = '/activity?id=' + activityId + '&property=' + propertyData.property_id + '&lang=' + currentLanguage;
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            // CRITICAL: Re-read language from localStorage on page load
            const savedLang = localStorage.getItem('preferredLanguage');
            if (savedLang) {
                currentLanguage = savedLang;
                console.log('ðŸ“– Loaded language from localStorage:', savedLang);
            }
            
            // Set language selector value after DOM is loaded
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector) {
                languageSelector.value = currentLanguage;
                console.log('ðŸŽ¯ Language selector initialized to:', currentLanguage);
            }
            
            // Expose functions to window for inline event handlers (required for type="module")
            window.viewOffering = viewOffering;
            window.viewActivity = viewActivity;
            window.filterOfferings = filterOfferings;
            window.goToBeachBooking = goToBeachBooking;
            window.openMapModal = openMapModal;
            window.closeMapModal = closeMapModal;
            window.showHotspotInfo = showHotspotInfo;
            window.closeHotspotModal = closeHotspotModal;
            
            // Initialize the page
            init().then(() => {
                // Double-check selector value after init
                if (languageSelector) {
                    languageSelector.value = currentLanguage;
                }
                
                // Initialize seasonal effects
                initSeasonalEffects();
                
                // Initialize chatbot (must run after propertyData is loaded)
                if (typeof window.initChatbot === 'function') {
                    window.initChatbot();
                }
            });
        });
        
        // Seasonal Effects (inline)
        async function initSeasonalEffects() {
          if (!propertyData) return;
          
          try {
            const response = await fetch('/api/seasonal-settings/' + propertyData.property_id);
            const data = await response.json();
            
            if (data.success && data.settings && data.settings.is_active) {
              const s = data.settings;
              
              // Custom message banner
              if (s.custom_message) {
                const banner = document.createElement('div');
                const primaryColor = propertyData.primary_color || '#3B82F6';
                banner.style.cssText = 'position:fixed;top:0;left:0;width:100%;background:linear-gradient(135deg,' + primaryColor + ',#ffffff);color:white;text-align:center;padding:12px;font-size:18px;font-weight:bold;z-index:10000;box-shadow:0 2px 10px rgba(0,0,0,0.2);animation:slideDown 0.5s;text-shadow: 1px 1px 2px rgba(0,0,0,0.3)';
                banner.textContent = s.custom_message;
                document.body.appendChild(banner);
                document.body.style.paddingTop = '48px';
              }
              
              // Snow effect
              if (s.enable_snow) {
                const snow = document.createElement('div');
                snow.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;overflow:hidden';
                for (let i = 0; i < 30; i++) {
                  const flake = document.createElement('div');
                  flake.innerHTML = 'â„';
                  flake.style.cssText = 'position:absolute;color:#fff;font-size:' + (Math.random() * 10 + 10) + 'px;left:' + (Math.random() * 100) + '%;animation:snowfall ' + (Math.random() * 3 + 2) + 's linear infinite;opacity:' + (Math.random() * 0.6 + 0.4);
                  flake.style.animationDelay = Math.random() * 2 + 's';
                  snow.appendChild(flake);
                }
                document.body.appendChild(snow);
                if (!document.getElementById('snow-style')) {
                  const style = document.createElement('style');
                  style.id = 'snow-style';
                  style.textContent = '@keyframes snowfall{0%{top:-10%;transform:translateX(0) rotate(0deg)}100%{top:110%;transform:translateX(50px) rotate(360deg)}}@keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}';
                  document.head.appendChild(style);
                }
              }
              
              // Confetti effect
              if (s.enable_confetti) {
                const confetti = document.createElement('div');
                confetti.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9998;overflow:hidden';
                const colors = ['#f44336','#e91e63','#9c27b0','#3f51b5','#2196f3','#4caf50','#ffeb3b','#ff9800'];
                for (let i = 0; i < 50; i++) {
                  setTimeout(() => {
                    const piece = document.createElement('div');
                    piece.style.cssText = 'position:absolute;width:' + (Math.random() * 6 + 4) + 'px;height:' + (Math.random() * 10 + 5) + 'px;background:' + colors[Math.floor(Math.random() * colors.length)] + ';left:' + (Math.random() * 100) + '%;animation:confettifall ' + (Math.random() * 3 + 2) + 's linear infinite';
                    confetti.appendChild(piece);
                  }, i * 30);
                }
                document.body.appendChild(confetti);
                if (!document.getElementById('confetti-style')) {
                  const style = document.createElement('style');
                  style.id = 'confetti-style';
                  style.textContent = '@keyframes confettifall{0%{top:-10%;transform:rotate(0deg)}100%{top:110%;transform:rotate(720deg)}}';
                  document.head.appendChild(style);
                }
              }
              
              // Festive lights
              if (s.enable_lights) {
                const lights = document.createElement('div');
                lights.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:50px;pointer-events:none;z-index:9996;display:flex;justify-content:space-around';
                const colors = ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff'];
                for (let i = 0; i < 15; i++) {
                  const light = document.createElement('div');
                  light.style.cssText = 'width:10px;height:10px;border-radius:50%;background:' + colors[i % colors.length] + ';animation:twinkle ' + (Math.random() * 2 + 1) + 's ease-in-out infinite;box-shadow:0 0 10px ' + colors[i % colors.length];
                  light.style.animationDelay = Math.random() + 's';
                  lights.appendChild(light);
                }
                document.body.appendChild(lights);
                if (!document.getElementById('lights-style')) {
                  const style = document.createElement('style');
                  style.id = 'lights-style';
                  style.textContent = '@keyframes twinkle{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.3;transform:scale(0.8)}}';
                  document.head.appendChild(style);
                }
              }
            }
          } catch (error) {
            console.error('Seasonal effects error:', error);
          }
        }

        // ============================================
        // INFO PAGES - GUEST INTERFACE
        // ============================================
        
        let infoPages = [];

        async function loadInfoPages() {
          try {
            if (!propertyData || !propertyData.property_id) {
              console.log('â³ Property data not loaded yet, skipping info pages load');
              return;
            }
            const response = await fetch('/api/info-pages/' + propertyData.property_id);
            const data = await response.json();
            if (data.success) {
              infoPages = data.pages;
            }
          } catch (error) {
            console.error('Load info pages error:', error);
          }
        }

        window.openInfoMenu = function() {
          document.getElementById('infoMenuModal').classList.remove('hidden');
          displayInfoMenu();
        }

        window.closeInfoMenu = function() {
          document.getElementById('infoMenuModal').classList.add('hidden');
        }

        function displayInfoMenu() {
          const container = document.getElementById('infoMenuList');
          
          if (infoPages.length === 0) {
            container.innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-info-circle text-4xl mb-3"></i><p>No information pages available</p></div>';
            return;
          }

          // Use primary color from settings for all info page buttons
          const primaryColor = propertyData.primary_color || '#3B82F6';

          let html = '';
          infoPages.forEach(page => {
            const title = page['title_' + currentLanguage] || page.title_en;
            
            html += '<button onclick="openInfoPage(&quot;' + page.page_key + '&quot;)" class="w-full text-white p-4 rounded-xl shadow-lg transition transform hover:scale-105 active:scale-95 text-left" style="background: linear-gradient(135deg, ' + primaryColor + ' 0%, ' + primaryColor + 'dd 100%);">' +
              '<div class="flex items-center gap-3">' +
                '<i class="' + page.icon_class + ' text-2xl"></i>' +
                '<span class="font-bold text-lg">' + title + '</span>' +
                '<i class="fas fa-chevron-right ml-auto"></i>' +
              '</div>' +
            '</button>';
          });

          container.innerHTML = html;
        }

        window.openInfoPage = async function(pageKey) {
          try {
            const response = await fetch('/api/info-page/' + propertyData.property_id + '/' + pageKey);
            const data = await response.json();
            
            if (data.success) {
              displayInfoPage(data.page);
              closeInfoMenu();
            }
          } catch (error) {
            console.error('Open info page error:', error);
            alert('Failed to load page');
          }
        }

        function displayInfoPage(page) {
          const title = page['title_' + currentLanguage] || page.title_en;
          const content = page['content_' + currentLanguage] || page.content_en;
          
          document.getElementById('infoPageTitle').innerHTML = '<i class="' + page.icon_class + ' mr-3"></i>' + title;
          document.getElementById('infoPageContent').innerHTML = content;
          
          // Apply custom colors from propertyData
          const primaryColor = propertyData.primary_color || '#3B82F6';
          const infoPageHeader = document.getElementById('infoPageHeader');
          const infoPageCloseFooterBtn = document.getElementById('infoPageCloseFooterBtn');
          
          if (infoPageHeader) {
            infoPageHeader.style.background = 'linear-gradient(135deg, ' + primaryColor + ' 0%, #ffffff 100%)';
          }
          if (infoPageCloseFooterBtn) {
            infoPageCloseFooterBtn.style.background = primaryColor;
          }
          
          document.getElementById('infoPageModal').classList.remove('hidden');
        }

        window.closeInfoPage = function() {
          document.getElementById('infoPageModal').classList.add('hidden');
        }

        // Info pages will be loaded after propertyData is loaded (in main init)

        // ============================================
        // FEEDBACK FORM FUNCTIONS
        // ============================================
        let activeFeedbackForm = null;

        async function loadHomepageFeedbackForm() {
          try {
            const response = await fetch('/api/admin/feedback/forms/' + propertyData.property_id);
            const data = await response.json();
            
            if (data.success && data.forms) {
              // Find the first active form with show_on_homepage = 1
              activeFeedbackForm = data.forms.find(form => form.is_active === 1 && form.show_on_homepage === 1);
              
              if (activeFeedbackForm) {
                // Show feedback button
                const feedbackBtn = document.getElementById('feedbackButton');
                if (feedbackBtn) {
                  feedbackBtn.classList.remove('hidden');
                }
              }
            }
          } catch (error) {
            console.error('Failed to load feedback form:', error);
          }
        }

        window.openFeedbackForm = function() {
          if (!activeFeedbackForm) {
            alert('No feedback form available');
            return;
          }
          
          // Redirect to feedback form page
          window.location.href = '/feedback/' + activeFeedbackForm.form_id;
        }
        
        </script>

        <!-- Info Menu Modal -->
        <div id="infoMenuModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-hidden animate-scale-up">
                <!-- Header -->
                <div id="infoModalHeader" class="p-6 flex justify-between items-center">
                    <h2 id="infoModalTitle" class="text-2xl font-bold"><i class="fas fa-info-circle mr-2"></i>Hotel Information</h2>
                    <button id="infoModalCloseBtn" onclick="closeInfoMenu()" class="hover:opacity-80 transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <!-- Info Pages List -->
                <div id="infoMenuList" class="p-6 space-y-3 overflow-y-auto max-h-[60vh]">
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-3xl"></i>
                        <p class="mt-2">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Page Display Modal -->
        <div id="infoPageModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 overflow-y-auto">
            <div class="min-h-screen p-4 flex items-center justify-center">
                <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full my-8 animate-scale-up">
                    <!-- Header -->
                    <div id="infoPageHeader" class="p-6 rounded-t-2xl flex justify-between items-center bg-gradient-to-r from-blue-500 to-white">
                        <h2 id="infoPageTitle" class="text-2xl md:text-3xl font-bold flex items-center text-white">Loading...</h2>
                        <button id="infoPageCloseBtn" onclick="closeInfoPage()" class="text-white hover:opacity-80 transition">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <!-- Content -->
                    <div id="infoPageContent" class="p-6 md:p-8 prose prose-lg max-w-none overflow-y-auto max-h-[70vh] text-gray-800">
                        <!-- Content will be injected here -->
                    </div>
                    
                    <!-- Footer -->
                    <div class="bg-gray-50 p-4 rounded-b-2xl flex justify-end">
                        <button id="infoPageCloseFooterBtn" onclick="closeInfoPage()" class="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold transition">
                            <i class="fas fa-times mr-2"></i>Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <style>
          @keyframes scale-up {
            from {
              transform: scale(0.9);
              opacity: 0;
            }
            to {
              transform: scale(1);
              opacity: 1;
            }
          }
          
          .animate-scale-up {
            animation: scale-up 0.2s ease-out;
          }

          /* Prose styling for info page content */
          .prose {
            color: #374151;
          }
          .prose h2 {
            color: #1f2937;
            font-weight: 700;
            font-size: 1.875rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
          }
          .prose h3 {
            color: #374151;
            font-weight: 600;
            font-size: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
          }
          .prose p {
            margin-bottom: 1rem;
            line-height: 1.75;
          }
          .prose ul, .prose ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
          }
          .prose li {
            margin-bottom: 0.5rem;
          }
          .prose table {
            width: 100%;
            margin-bottom: 1rem;
          }
          .prose th {
            background-color: #f3f4f6;
            font-weight: 600;
            padding: 0.75rem;
            text-align: left;
          }
          .prose td {
            padding: 0.75rem;
          }
          .prose strong {
            font-weight: 700;
            color: #1f2937;
          }
          .prose em {
            font-style: italic;
          }
        </style>
        
        <!-- AI Chatbot Widget -->
        <div id="chatbotWidget" style="display: none;">
          <!-- Chat Button -->
          <button id="chatbotButton" class="fixed bottom-6 left-6 w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-white text-2xl hover:scale-110 transition-transform duration-300 z-50" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-comments"></i>
          </button>
          
          <!-- Chat Window -->
          <div id="chatWindow" class="hidden fixed bottom-24 left-6 w-96 max-w-[calc(100vw-3rem)] h-[500px] bg-white rounded-2xl shadow-2xl flex flex-col z-50 border border-gray-200">
            <!-- Header -->
            <div class="p-4 rounded-t-2xl text-white flex items-center justify-between" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mr-3">
                  <i class="fas fa-robot text-xl"></i>
                </div>
                <div>
                  <h3 id="chatbotName" class="font-bold">Hotel Assistant</h3>
                  <p class="text-xs opacity-90">Always here to help</p>
                </div>
              </div>
              <button id="closeChatBtn" class="text-white/80 hover:text-white transition">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            
            <!-- Messages Container -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
              <!-- Messages will be added here -->
            </div>
            
            <!-- Input Area -->
            <div class="p-4 border-t border-gray-200 bg-white rounded-b-2xl">
              <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="Ask me anything..." class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button id="sendChatBtn" class="w-12 h-12 rounded-full text-white flex items-center justify-center hover:scale-105 transition" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-2 text-center">
                <span id="chatUsageInfo">AI-powered by hotel knowledge base</span>
              </p>
            </div>
          </div>
        </div>
        
        <script>
          // Chatbot Widget JavaScript
          const chatbotWidget = document.getElementById('chatbotWidget');
          const chatButton = document.getElementById('chatbotButton');
          const chatWindow = document.getElementById('chatWindow');
          const closeChatBtn = document.getElementById('closeChatBtn');
          const chatMessages = document.getElementById('chatMessages');
          const chatInput = document.getElementById('chatInput');
          const sendChatBtn = document.getElementById('sendChatBtn');
          
          let chatConversationId = null;
          let chatSessionId = 'guest-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
          
          // Load chatbot settings and show if enabled
          window.initChatbot = async function() {
              try {
                const response = await fetch('/api/chatbot/settings/' + window.propertyData.property_id);
                const data = await response.json();
                
                if (data.success && data.settings && data.settings.chatbot_enabled === 1) {
                  chatbotWidget.style.display = 'block';
                  document.getElementById('chatbotName').textContent = data.settings.chatbot_name || 'Hotel Assistant';
                  
                  // Apply custom branding color
                  const primaryColor = data.settings.chatbot_primary_color || '#667eea';
                  const chatHeader = document.querySelector('#chatWindow > div:first-child');
                  const sendBtn = document.getElementById('sendChatBtn');
                  
                  // Apply gradient background to button and header
                  chatButton.style.background = 'linear-gradient(135deg, ' + primaryColor + ' 0%, ' + adjustColor(primaryColor, -20) + ' 100%)';
                  if (chatHeader) {
                    chatHeader.style.background = 'linear-gradient(135deg, ' + primaryColor + ' 0%, ' + adjustColor(primaryColor, -20) + ' 100%)';
                  }
                  if (sendBtn) {
                    sendBtn.style.background = 'linear-gradient(135deg, ' + primaryColor + ' 0%, ' + adjustColor(primaryColor, -20) + ' 100%)';
                  }
                  
                  // Store color for message bubbles
                  window.chatbotPrimaryColor = primaryColor;
                  
                  // Add welcome message
                  const greeting = data.settings.chatbot_greeting_en || 'Hi! How can I help you today?';
                  addMessage(greeting, 'assistant');
                }
              } catch (error) {
                console.error('Chatbot init error:', error);
              }
            }
            
            // Helper function to adjust color brightness
            function adjustColor(hex, percent) {
              const num = parseInt(hex.replace('#', ''), 16);
              const amt = Math.round(2.55 * percent);
              const R = (num >> 16) + amt;
              const G = (num >> 8 & 0x00FF) + amt;
              const B = (num & 0x0000FF) + amt;
              return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
            }
            
            // Toggle chat window
            chatButton.addEventListener('click', () => {
              chatWindow.classList.toggle('hidden');
              if (!chatWindow.classList.contains('hidden')) {
                chatInput.focus();
              }
            });
            
            closeChatBtn.addEventListener('click', () => {
              chatWindow.classList.add('hidden');
            });
            
            // Add message to chat
            // Helper: Convert markdown links to HTML
            function parseMarkdownLinks(text) {
              // Convert [text](url) to <a> tags
              return text.replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href="$2" class="text-blue-600 hover:text-blue-800 underline font-medium" target="_blank">$1</a>');
            }
            
            function addMessage(text, role) {
              const messageDiv = document.createElement('div');
              messageDiv.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';
              
              const bubble = document.createElement('div');
              if (role === 'user') {
                const primaryColor = window.chatbotPrimaryColor || '#667eea';
                bubble.className = 'text-white px-4 py-2 rounded-2xl rounded-tr-none max-w-[80%]';
                bubble.style.background = 'linear-gradient(to right, ' + primaryColor + ', ' + adjustColor(primaryColor, -20) + ')';
                bubble.textContent = text; // User messages are plain text
              } else {
                bubble.className = 'bg-white border border-gray-200 text-gray-800 px-4 py-2 rounded-2xl rounded-tl-none max-w-[80%] shadow-sm';
                // Bot messages can have markdown links
                const htmlContent = parseMarkdownLinks(text);
                bubble.innerHTML = htmlContent.replace(/\\n/g, '<br>'); // Preserve line breaks
              }
              
              messageDiv.appendChild(bubble);
              chatMessages.appendChild(messageDiv);
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Send message
            async function sendMessage() {
              const message = chatInput.value.trim();
              if (!message) return;
              
              // Add user message
              addMessage(message, 'user');
              chatInput.value = '';
              
              // Show typing indicator
              const typingDiv = document.createElement('div');
              typingDiv.id = 'typing';
              typingDiv.className = 'flex justify-start';
              typingDiv.innerHTML = '<div class="bg-white border border-gray-200 px-4 py-2 rounded-2xl rounded-tl-none"><i class="fas fa-ellipsis-h animate-pulse"></i></div>';
              chatMessages.appendChild(typingDiv);
              chatMessages.scrollTop = chatMessages.scrollHeight;
              
              try {
                const response = await fetch('/api/chatbot/chat', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    property_id: window.propertyData.property_id,
                    session_id: chatSessionId,
                    message: message,
                    conversation_id: chatConversationId
                  })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById('typing')?.remove();
                
                if (data.success) {
                  chatConversationId = data.conversation_id;
                  addMessage(data.response, 'assistant');
                } else if (response.status === 429) {
                  addMessage(data.message || 'Rate limit exceeded. Please try again later.', 'assistant');
                } else {
                  addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }
              } catch (error) {
                console.error('Chat error:', error);
                document.getElementById('typing')?.remove();
                addMessage('Sorry, I am unable to respond right now. Please try again later.', 'assistant');
              }
            }
            
          sendChatBtn.addEventListener('click', sendMessage);
          chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              sendMessage();
            }
          });
        </script>
    </body>
    </html>
  `)
})

// ============================================
// OFFERING DETAIL PAGE - Booking page for restaurants, events, spa
app.get('/offering-detail', async (c) => {
  const offering_id = c.req.query('id')
  const property_id = c.req.query('property')
  
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Now</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      /* Dynamic styles will be injected here */
      #dynamicStyles { }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <div id="translating" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl flex items-center gap-4">
            <div class="animate-spin rounded-full h-8 w-8 border-t-4 border-b-4 border-blue-500"></div>
            <span class="text-lg font-medium">Translating content...</span>
        </div>
    </div>

    <div id="content" class="hidden">
        <!-- Language Selector -->
        <div class="fixed top-4 right-4 z-50">
            <select id="languageSelector" class="px-4 py-2 border rounded-lg bg-white shadow-md">
                <option value="en">English</option>
                <option value="es">EspaÃ±ol</option>
                <option value="fr">FranÃ§ais</option>
                <option value="de">Deutsch</option>
                <option value="it">Italiano</option>
                <option value="pt">PortuguÃªs</option>
                <option value="ru">Ð ÑƒÑÑÐºÐ¸Ð¹</option>
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="zh">ä¸­æ–‡</option>
            </select>
        </div>

        <!-- Header -->
        <div id="offeringHeader" class="bg-gradient-to-r from-blue-700 to-indigo-700 text-white py-6 px-4">
            <div class="max-w-4xl mx-auto">
                <a id="backLink" href="#" class="text-white/80 hover:text-white mb-2 inline-block">
                    <i class="fas fa-arrow-left mr-2"></i><span data-i18n="back-to-hotel">Back to hotel</span>
                </a>
                <h1 class="text-3xl font-bold" id="offeringTitle">Loading...</h1>
                <p class="text-white/80" id="offeringLocation"></p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto px-4 py-6">
            <!-- Offering Details -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                <img id="offeringImage" src="" alt="" class="w-full h-64 object-cover">
                <div class="p-6">
                    <div class="flex items-center gap-2 mb-4" id="offeringMeta"></div>
                    <h2 class="text-2xl font-bold mb-3" data-i18n="about">About</h2>
                    <p class="text-gray-600 mb-6" id="offeringDescription"></p>
                    
                    <div id="eventDetails" class="hidden mb-6">
                        <h3 class="font-bold text-lg mb-2" data-i18n="event-details">Event Details</h3>
                        <div class="space-y-2 text-gray-700">
                            <div><i class="fas fa-calendar mr-2 text-blue-500"></i><span id="eventDate"></span></div>
                            <div><i class="fas fa-clock mr-2 text-blue-500"></i><span id="eventTime"></span></div>
                        </div>
                    </div>

                    <div id="restaurantMenus" class="hidden mb-6">
                        <h3 class="font-bold text-lg mb-3 flex items-center">
                            <i class="fas fa-utensils mr-2 text-orange-500"></i>
                            <span>Our Menus</span>
                        </h3>
                        <div id="menuGrid" class="grid gap-4 md:grid-cols-2">
                            <!-- Menus will be displayed here -->
                        </div>
                    </div>

                    <div id="bookingSection" class="border-t pt-6">
                        <h3 class="font-bold text-lg mb-4" data-i18n="book-experience">Book Your Experience</h3>
                        <form id="bookingForm" class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2" data-i18n="your-name">Your Name</label>
                                    <input type="text" id="guestName" required class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2" data-i18n="phone-number">Phone Number</label>
                                    <input type="tel" id="guestPhone" required class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" data-i18n="email">Email</label>
                                <input type="email" id="guestEmail" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div id="restaurantFields" class="hidden">
                                <label class="block text-sm font-medium mb-2" data-i18n="preferred-datetime">Preferred Date & Time</label>
                                <input type="datetime-local" id="bookingDateTime" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" data-i18n="num-guests">Number of Guests</label>
                                <input type="number" id="numGuests" min="1" value="2" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" data-i18n="special-requests">Special Requests (Optional)</label>
                                <textarea id="specialRequests" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium" data-i18n="price-per-person">Price per person:</span>
                                    <span class="text-xl font-bold text-blue-600" id="priceDisplay"></span>
                                </div>
                                <div class="flex justify-between items-center text-gray-700">
                                    <span data-i18n="total">Total:</span>
                                    <span class="text-2xl font-bold" id="totalPrice">$0</span>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700">
                                <i class="fas fa-check-circle mr-2"></i><span data-i18n="confirm-booking">Confirm Booking</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get language from URL or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const langFromUrl = urlParams.get('lang');
        let currentLanguage = langFromUrl || localStorage.getItem('preferredLanguage') || 'en';
        
        // Save to localStorage for persistence
        if (langFromUrl) {
            localStorage.setItem('preferredLanguage', langFromUrl);
        }
        
        let offeringData = null;
        let propertyData = null;
        const offeringId = '${offering_id}';
        const propertyId = '${property_id}';

        // Translation dictionary for UI elements
        const translations = {
            en: {
                'back-to-hotel': 'Back to hotel',
                'about': 'About',
                'event-details': 'Event Details',
                'book-experience': 'Book Your Experience',
                'ready-to-dine': 'å‡†å¤‡ç”¨é¤äº†å—ï¼Ÿ',
                'reserve-table-description': 'é¢„è®¢æ‚¨çš„é¤æ¡Œå¹¶é€‰æ‹©æ‚¨å–œæ¬¢çš„åº§ä½',
                'book-table': 'é¢„è®¢é¤æ¡Œ',
                'ready-to-dine': 'Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø·Ø¹Ø§Ù…ØŸ',
                'reserve-table-description': 'Ø§Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„ØªÙƒ ÙˆØ§Ø®ØªØ± Ù…Ù‚Ø¹Ø¯Ùƒ Ø§Ù„Ù…ÙØ¶Ù„',
                'book-table': 'Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©',
                'ready-to-dine': 'Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð¿Ð¾ÑƒÐ¶Ð¸Ð½Ð°Ñ‚ÑŒ?',
                'reserve-table-description': 'Ð—Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÑ‚Ð¾Ð»Ð¸Ðº Ð¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ñ‡Ñ‚Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾',
                'book-table': 'Ð—Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¡Ñ‚Ð¾Ð»Ð¸Ðº',
                'ready-to-dine': 'Pronto para jantar?',
                'reserve-table-description': 'Reserve sua mesa e escolha seu assento preferido',
                'book-table': 'Reservar Mesa',
                'ready-to-dine': 'Pronto a cenare?',
                'reserve-table-description': 'Prenota il tuo tavolo e scegli il tuo posto preferito',
                'book-table': 'Prenota un Tavolo',
                'ready-to-dine': 'Ready to Dine?',
                'reserve-table-description': 'Reserve your table and choose your preferred seating',
                'book-table': 'Book a Table',
                'your-name': 'Your Name',
                'phone-number': 'Phone Number',
                'email': 'Email',
                'preferred-datetime': 'Preferred Date & Time',
                'num-guests': 'Number of Guests',
                'special-requests': 'Special Requests (Optional)',
                'price-per-person': 'Price per person:',
                'total': 'Total:',
                'confirm-booking': 'Confirm Booking'
            },
            es: {
                'back-to-hotel': 'Volver al hotel',
                'about': 'Acerca de',
                'event-details': 'Detalles del evento',
                'book-experience': 'Reserva tu experiencia',
                'ready-to-dine': 'Pronto para jantar?',
                'reserve-table-description': 'Reserve sua mesa e escolha seu assento preferido',
                'book-table': 'Reservar Mesa',
                'ready-to-dine': 'Pronto a cenare?',
                'reserve-table-description': 'Prenota il tuo tavolo e scegli il tuo posto preferito',
                'book-table': 'Prenota un Tavolo',
                'ready-to-dine': 'Â¿Listo para cenar?',
                'reserve-table-description': 'Reserva tu mesa y elige tu asiento preferido',
                'book-table': 'Reservar Mesa',
                'your-name': 'Tu nombre',
                'phone-number': 'NÃºmero de telÃ©fono',
                'email': 'Correo electrÃ³nico',
                'preferred-datetime': 'Fecha y hora preferidas',
                'num-guests': 'NÃºmero de huÃ©spedes',
                'special-requests': 'Solicitudes especiales (opcional)',
                'price-per-person': 'Precio por persona:',
                'total': 'Total:',
                'confirm-booking': 'Confirmar reserva'
            },
            fr: {
                'back-to-hotel': 'Retour Ã  l\\'hÃ´tel',
                'about': 'Ã€ propos',
                'event-details': 'DÃ©tails de l\\'Ã©vÃ©nement',
                'book-experience': 'RÃ©servez votre expÃ©rience',
                'ready-to-dine': 'Pronto a cenare?',
                'reserve-table-description': 'Prenota il tuo tavolo e scegli il tuo posto preferito',
                'book-table': 'Prenota un Tavolo',
                'ready-to-dine': 'PrÃªt Ã  dÃ®ner?',
                'reserve-table-description': 'RÃ©servez votre table et choisissez votre place prÃ©fÃ©rÃ©e',
                'book-table': 'RÃ©server une Table',
                'your-name': 'Votre nom',
                'phone-number': 'NumÃ©ro de tÃ©lÃ©phone',
                'email': 'Email',
                'preferred-datetime': 'Date et heure prÃ©fÃ©rÃ©es',
                'num-guests': 'Nombre d\\'invitÃ©s',
                'special-requests': 'Demandes spÃ©ciales (facultatif)',
                'price-per-person': 'Prix par personne:',
                'total': 'Total:',
                'confirm-booking': 'Confirmer la rÃ©servation'
            },
            de: {
                'back-to-hotel': 'ZurÃ¼ck zum Hotel',
                'about': 'Ãœber',
                'event-details': 'Veranstaltungsdetails',
                'book-experience': 'Buchen Sie Ihr Erlebnis',
                'ready-to-dine': 'Pronto a cenare?',
                'reserve-table-description': 'Prenota il tuo tavolo e scegli il tuo posto preferito',
                'book-table': 'Prenota un Tavolo',
                'your-name': 'Ihr Name',
                'phone-number': 'Telefonnummer',
                'email': 'E-Mail',
                'preferred-datetime': 'Bevorzugtes Datum und Uhrzeit',
                'num-guests': 'Anzahl der GÃ¤ste',
                'special-requests': 'Besondere WÃ¼nsche (optional)',
                'price-per-person': 'Preis pro Person:',
                'total': 'Gesamt:',
                'confirm-booking': 'Buchung bestÃ¤tigen'
            },
            it: {
                'back-to-hotel': 'Torna all\\'hotel',
                'about': 'Informazioni',
                'event-details': 'Dettagli dell\\'evento',
                'book-experience': 'Prenota la tua esperienza',
                'ready-to-dine': 'Pronto a cenare?',
                'reserve-table-description': 'Prenota il tuo tavolo e scegli il tuo posto preferito',
                'book-table': 'Prenota un Tavolo',
                'your-name': 'Il tuo nome',
                'phone-number': 'Numero di telefono',
                'email': 'Email',
                'preferred-datetime': 'Data e ora preferite',
                'num-guests': 'Numero di ospiti',
                'special-requests': 'Richieste speciali (facoltativo)',
                'price-per-person': 'Prezzo per persona:',
                'total': 'Totale:',
                'confirm-booking': 'Conferma prenotazione'
            },
            pt: {
                'back-to-hotel': 'Voltar ao hotel',
                'about': 'Sobre',
                'event-details': 'Detalhes do evento',
                'book-experience': 'Reserve sua experiÃªncia',
                'ready-to-dine': 'Pronto para jantar?',
                'reserve-table-description': 'Reserve sua mesa e escolha seu assento preferido',
                'book-table': 'Reservar Mesa',
                'your-name': 'Seu nome',
                'phone-number': 'NÃºmero de telefone',
                'email': 'Email',
                'preferred-datetime': 'Data e hora preferidas',
                'num-guests': 'NÃºmero de hÃ³spedes',
                'special-requests': 'SolicitaÃ§Ãµes especiais (opcional)',
                'price-per-person': 'PreÃ§o por pessoa:',
                'total': 'Total:',
                'confirm-booking': 'Confirmar reserva'
            },
            ru: {
                'back-to-hotel': 'Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ð² Ð¾Ñ‚ÐµÐ»ÑŒ',
                'about': 'Ðž Ð½Ð°Ñ',
                'event-details': 'Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ',
                'book-experience': 'Ð—Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÐ²Ð¾Ð¹ Ð¾Ð¿Ñ‹Ñ‚',
                'ready-to-dine': 'Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð¿Ð¾ÑƒÐ¶Ð¸Ð½Ð°Ñ‚ÑŒ?',
                'reserve-table-description': 'Ð—Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÑ‚Ð¾Ð»Ð¸Ðº Ð¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ñ‡Ñ‚Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾',
                'book-table': 'Ð—Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¡Ñ‚Ð¾Ð»Ð¸Ðº',
                'your-name': 'Ð’Ð°ÑˆÐµ Ð¸Ð¼Ñ',
                'phone-number': 'ÐÐ¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°',
                'email': 'Ð­Ð»ÐµÐºÑ‚Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¿Ð¾Ñ‡Ñ‚Ð°',
                'preferred-datetime': 'ÐŸÑ€ÐµÐ´Ð¿Ð¾Ñ‡Ñ‚Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ',
                'num-guests': 'ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð³Ð¾ÑÑ‚ÐµÐ¹',
                'special-requests': 'ÐžÑÐ¾Ð±Ñ‹Ðµ Ð¿Ð¾Ð¶ÐµÐ»Ð°Ð½Ð¸Ñ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)',
                'price-per-person': 'Ð¦ÐµÐ½Ð° Ð·Ð° Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°:',
                'total': 'Ð˜Ñ‚Ð¾Ð³Ð¾:',
                'confirm-booking': 'ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ'
            },
            ar: {
                'back-to-hotel': 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙÙ†Ø¯Ù‚',
                'about': 'Ø­ÙˆÙ„',
                'event-details': 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø«',
                'book-experience': 'Ø§Ø­Ø¬Ø² ØªØ¬Ø±Ø¨ØªÙƒ',
                'ready-to-dine': 'Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø·Ø¹Ø§Ù…ØŸ',
                'reserve-table-description': 'Ø§Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„ØªÙƒ ÙˆØ§Ø®ØªØ± Ù…Ù‚Ø¹Ø¯Ùƒ Ø§Ù„Ù…ÙØ¶Ù„',
                'book-table': 'Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©',
                'your-name': 'Ø§Ø³Ù…Ùƒ',
                'phone-number': 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ',
                'email': 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
                'preferred-datetime': 'Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙØ¶Ù„',
                'num-guests': 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¶ÙŠÙˆÙ',
                'special-requests': 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
                'price-per-person': 'Ø§Ù„Ø³Ø¹Ø± Ù„ÙƒÙ„ Ø´Ø®Øµ:',
                'total': 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:',
                'confirm-booking': 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²'
            },
            zh: {
                'back-to-hotel': 'è¿”å›žé…’åº—',
                'about': 'å…³äºŽ',
                'event-details': 'æ´»åŠ¨è¯¦æƒ…',
                'book-experience': 'é¢„è®¢æ‚¨çš„ä½“éªŒ',
                'ready-to-dine': 'å‡†å¤‡ç”¨é¤äº†å—ï¼Ÿ',
                'reserve-table-description': 'é¢„è®¢æ‚¨çš„é¤æ¡Œå¹¶é€‰æ‹©æ‚¨å–œæ¬¢çš„åº§ä½',
                'book-table': 'é¢„è®¢é¤æ¡Œ',
                'your-name': 'æ‚¨çš„å§“å',
                'phone-number': 'ç”µè¯å·ç ',
                'email': 'ç”µå­é‚®ä»¶',
                'preferred-datetime': 'é¦–é€‰æ—¥æœŸå’Œæ—¶é—´',
                'num-guests': 'å®¢äººæ•°é‡',
                'special-requests': 'ç‰¹æ®Šè¦æ±‚ï¼ˆå¯é€‰ï¼‰',
                'price-per-person': 'æ¯äººä»·æ ¼ï¼š',
                'total': 'æ€»è®¡ï¼š',
                'confirm-booking': 'ç¡®è®¤é¢„è®¢'
            }
        };

        function t(key) {
            return translations[currentLanguage]?.[key] || translations['en'][key] || key;
        }

        async function init() {
            try {
                // Fetch property data for settings and slug
                const propResponse = await fetch('/api/properties?property_id=' + propertyId);
                const propData = await propResponse.json();
                propertyData = propData.properties && propData.properties[0];

                if (!propertyData) {
                    alert('Property not found');
                    return;
                }

                // Update back link with correct slug
                document.getElementById('backLink').href = '/hotel/' + (propertyData.slug || 'paradise-resort');

                // Fetch offering data
                const response = await fetch('/api/hotel-offerings/' + propertyId);
                const data = await response.json();
                const offerings = data.offerings || [];
                offeringData = offerings.find(o => o.offering_id == offeringId);

                if (!offeringData) {
                    alert('Offering not found');
                    window.location.href = '/hotel/' + (propertyData.slug || 'paradise-resort');
                    return;
                }

                // Apply design settings
                applyDesignSettings(propertyData);

                // Render offering with current language
                renderOffering();
                updateTranslations();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading offering:', error);
                alert('Failed to load offering details');
            }
        }

        function applyDesignSettings(settings) {
            const fontMap = {
                'inter': "'Inter', system-ui, sans-serif",
                'poppins': "'Poppins', sans-serif",
                'playfair': "'Playfair Display', serif",
                'montserrat': "'Montserrat', sans-serif",
                'lora': "'Lora', serif"
            };
            
            const primaryColor = settings.primary_color || '#3B82F6';
            const secondaryColor = settings.secondary_color || '#10B981';
            const fontFamily = fontMap[settings.font_family] || fontMap['inter'];
            const useGradient = settings.use_gradient || 0;
            
            const heroBackground = useGradient ? 
                'linear-gradient(135deg, ' + primaryColor + ' 0%, ' + secondaryColor + ' 100%)' : 
                primaryColor;
            
            // Apply dynamic CSS
            const style = document.createElement('style');
            style.textContent = 'body { font-family: ' + fontFamily + '; }' +
                '#offeringHeader { background: ' + heroBackground + ' !important; }' +
                '.text-blue-500, .text-blue-600 { color: ' + primaryColor + ' !important; }' +
                '.bg-blue-600 { background: ' + (useGradient ? heroBackground : primaryColor) + ' !important; }' +
                '.bg-blue-600:hover { background: ' + secondaryColor + ' !important; transform: scale(1.05); }' +
                '.bg-blue-50 { background: ' + primaryColor + '15 !important; }' +
                '.bg-secondary { background: ' + secondaryColor + ' !important; }' +
                '.bg-secondary:hover { opacity: 0.9; }' +
                '.text-secondary { color: ' + secondaryColor + ' !important; }';
            document.head.appendChild(style);
            
            // Apply colors to Info button and modal (if they exist on this page)
            const infoButton = document.getElementById('infoButton');
            const infoModalHeader = document.getElementById('infoModalHeader');
            
            if (infoButton) {
                infoButton.style.background = primaryColor;
                infoButton.style.borderColor = primaryColor;
                infoButton.onmouseover = function() { this.style.opacity = '0.9'; };
                infoButton.onmouseout = function() { this.style.opacity = '1'; };
            }
            
            if (infoModalHeader) {
                infoModalHeader.style.background = 'linear-gradient(135deg, ' + primaryColor + ' 0%, #ffffff 100%)';
                const modalTitle = infoModalHeader.querySelector('h2');
                const modalCloseBtn = infoModalHeader.querySelector('button');
                if (modalTitle) {
                    modalTitle.style.color = primaryColor;
                }
                if (modalCloseBtn) {
                    modalCloseBtn.style.color = primaryColor;
                }
            }

            // Apply colors to Info Page modal (individual page view)
            const infoPageHeader = document.getElementById('infoPageHeader');
            const infoPageTitle = document.getElementById('infoPageTitle');
            const infoPageCloseBtn = document.getElementById('infoPageCloseBtn');
            const infoPageContent = document.getElementById('infoPageContent');
            const infoPageCloseFooterBtn = document.getElementById('infoPageCloseFooterBtn');

            if (infoPageHeader) {
                infoPageHeader.style.background = 'linear-gradient(135deg, ' + primaryColor + ' 0%, #ffffff 100%)';
            }
            if (infoPageTitle) {
                infoPageTitle.style.color = '#ffffff';
            }
            if (infoPageCloseBtn) {
                infoPageCloseBtn.style.color = '#ffffff';
            }
            if (infoPageContent) {
                infoPageContent.style.color = '#1f2937'; // Dark gray text for readability
            }
            if (infoPageCloseFooterBtn) {
                infoPageCloseFooterBtn.style.background = primaryColor;
                infoPageCloseFooterBtn.style.color = '#ffffff';
                infoPageCloseFooterBtn.onmouseover = function() { this.style.opacity = '0.9'; };
                infoPageCloseFooterBtn.onmouseout = function() { this.style.opacity = '1'; };
            }
        }

        function updateTranslations() {
            const lang = currentLanguage;
            const dict = translations[lang] || translations['en'];
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (dict[key]) {
                    el.textContent = dict[key];
                }
            });
            
            // Re-render restaurant booking section if it's a restaurant
            if (offeringData && offeringData.offering_type === 'restaurant') {
                const bookingSection = document.getElementById('bookingSection');
                if (bookingSection) {
                    bookingSection.innerHTML = '<h3 class="font-bold text-lg mb-4">' + t('ready-to-dine') + '</h3>' +
                        '<p class="text-gray-600 mb-4">' + t('reserve-table-description') + '</p>' +
                        '<button onclick="window.location.href=\\'/hotel/' + propertyData.slug + '/restaurant/' + offeringId + '/book\\'" ' +
                        'class="w-full bg-secondary text-white py-4 px-6 rounded-lg font-semibold hover:opacity-90 transition-all text-lg">' +
                        '<i class="fas fa-calendar-check mr-2"></i>' + t('book-table') + '</button>';
                }
            }
        }

        async function translateContent(text, targetLang) {
            if (!text || targetLang === 'en') return text;
            
            try {
                // Call translation API
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        target_lang: targetLang,
                        context: 'hotel_offering_description',
                        persona: 'luxury_hospitality'
                    })
                });
                const data = await response.json();
                return data.translated_text || text;
            } catch (error) {
                console.error('Translation error:', error);
                return text;
            }
        }

        async function renderOffering() {
            // Show translating overlay if not English
            if (currentLanguage !== 'en') {
                document.getElementById('translating').classList.remove('hidden');
            }
            
            // Get language-specific field names
            const langSuffix = currentLanguage === 'en' ? '_en' : ('_' + currentLanguage);
            const titleField = 'title' + langSuffix;
            const shortDescField = 'short_description' + langSuffix;
            const fullDescField = 'full_description' + langSuffix;
            
            // Try to get translated content from database first
            let title = offeringData[titleField] || offeringData.title || offeringData.title_en;
            let description = offeringData[fullDescField] || offeringData[shortDescField] || offeringData.full_description || offeringData.short_description;
            let location = offeringData.location;
            
            try {
                // If no translation exists in database and language is not English, use AI translation
                if (currentLanguage !== 'en') {
                    console.log('Translating to', currentLanguage);
                    
                    if (!offeringData[titleField]) {
                        console.log('Translating title:', offeringData.title || offeringData.title_en);
                        title = await translateContent(offeringData.title || offeringData.title_en, currentLanguage);
                        console.log('Translated title:', title);
                    }
                    if (!offeringData[fullDescField] && !offeringData[shortDescField]) {
                        const originalDesc = offeringData.full_description || offeringData.short_description;
                        console.log('Translating description:', originalDesc);
                        description = await translateContent(originalDesc, currentLanguage);
                        console.log('Translated description:', description);
                    }
                    if (offeringData.location) {
                        console.log('Translating location:', offeringData.location);
                        location = await translateContent(offeringData.location, currentLanguage);
                        console.log('Translated location:', location);
                    }
                }
            } catch (error) {
                console.error('Translation rendering error:', error);
            } finally {
                // Hide translating overlay
                document.getElementById('translating').classList.add('hidden');
            }
            
            document.getElementById('offeringTitle').textContent = title;
            document.getElementById('offeringLocation').textContent = location || '';
            
            // Handle images - ensure it's an array
            let imageUrl = '/static/placeholder.jpg';
            if (offeringData.images) {
                console.log('Raw images data:', offeringData.images, 'Type:', typeof offeringData.images);
                // If images is a string, parse it
                if (typeof offeringData.images === 'string') {
                    try {
                        const parsedImages = JSON.parse(offeringData.images);
                        imageUrl = parsedImages[0] || imageUrl;
                    } catch (e) {
                        console.error('Failed to parse images:', e);
                        imageUrl = offeringData.images; // Use as-is if not JSON
                    }
                } else if (Array.isArray(offeringData.images) && offeringData.images.length > 0) {
                    imageUrl = offeringData.images[0];
                }
            }
            console.log('Setting image URL:', imageUrl);
            document.getElementById('offeringImage').src = imageUrl;
            
            document.getElementById('offeringDescription').textContent = description;
            document.getElementById('priceDisplay').textContent = (offeringData.currency || 'USD') + ' ' + (offeringData.price || '0');

            // Show/hide booking section based on requires_booking
            const bookingSection = document.getElementById('bookingSection');
            if (offeringData.requires_booking === 0) {
                bookingSection.classList.add('hidden');
            } else {
                bookingSection.classList.remove('hidden');
            }

            // Show event details if it's an event
            if (offeringData.offering_type === 'event' && offeringData.event_date) {
                document.getElementById('eventDetails').classList.remove('hidden');
                const date = new Date(offeringData.event_date);
                document.getElementById('eventDate').textContent = date.toLocaleDateString();
                if (offeringData.event_start_time) {
                    document.getElementById('eventTime').textContent = offeringData.event_start_time + (offeringData.event_end_time ? ' - ' + offeringData.event_end_time : '');
                }
            }

            // Show restaurant-specific fields and load menus
            if (offeringData.offering_type === 'restaurant') {
                // Hide the generic booking form and show Book Table button
                const bookingSection = document.getElementById('bookingSection');
                if (bookingSection) {
                    bookingSection.innerHTML = '<h3 class="font-bold text-lg mb-4">' + t('ready-to-dine') + '</h3>' +
                        '<p class="text-gray-600 mb-4">' + t('reserve-table-description') + '</p>' +
                        '<button onclick="window.location.href=\\'/hotel/' + propertyData.slug + '/restaurant/' + offeringId + '/book\\'" ' +
                        'class="w-full bg-secondary text-white py-4 px-6 rounded-lg font-semibold hover:opacity-90 transition-all text-lg">' +
                        '<i class="fas fa-calendar-check mr-2"></i>' + t('book-table') + '</button>';
                }
                loadRestaurantMenus();
            }

            updateTotalPrice();
        }

        async function loadRestaurantMenus() {
            try {
                const response = await fetch('/api/offerings/' + offeringId + '/menus');
                const data = await response.json();
                
                if (data.success && data.menus && data.menus.length > 0) {
                    document.getElementById('restaurantMenus').classList.remove('hidden');
                    const menuGrid = document.getElementById('menuGrid');
                    menuGrid.innerHTML = '';
                    
                    data.menus.forEach((menu, index) => {
                        const menuCard = document.createElement('div');
                        menuCard.className = 'bg-white border-2 border-orange-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow cursor-pointer';
                        menuCard.onclick = () => window.open(menu.menu_url, '_blank');
                        
                        const img = document.createElement('img');
                        img.src = menu.menu_url;
                        img.alt = menu.menu_name;
                        img.className = 'w-full h-48 object-cover';
                        
                        const content = document.createElement('div');
                        content.className = 'p-3';
                        
                        const title = document.createElement('h4');
                        title.className = 'font-semibold text-center';
                        title.textContent = menu.menu_name;
                        
                        const hint = document.createElement('p');
                        hint.className = 'text-xs text-gray-500 text-center mt-1';
                        hint.innerHTML = '<i class="fas fa-external-link-alt mr-1"></i>Click to view full size';
                        
                        content.appendChild(title);
                        content.appendChild(hint);
                        menuCard.appendChild(img);
                        menuCard.appendChild(content);
                        menuGrid.appendChild(menuCard);
                    });
                } else {
                    document.getElementById('restaurantMenus').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading menus:', error);
                document.getElementById('restaurantMenus').classList.add('hidden');
            }
        }

        function updateTotalPrice() {
            const numGuests = parseInt(document.getElementById('numGuests').value) || 1;
            const pricePerPerson = parseFloat(offeringData.price) || 0;
            const total = numGuests * pricePerPerson;
            document.getElementById('totalPrice').textContent = (offeringData.currency || 'USD') + ' ' + total.toFixed(2);
        }

        document.getElementById('numGuests').addEventListener('input', updateTotalPrice);

        // Language selector
        document.getElementById('languageSelector').addEventListener('change', async (e) => {
            currentLanguage = e.target.value;
            await renderOffering();
            updateTranslations();
        });

        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const bookingData = {
                offering_id: offeringData.offering_id,
                property_id: propertyId,
                guest_name: document.getElementById('guestName').value,
                guest_email: document.getElementById('guestEmail').value,
                guest_phone: document.getElementById('guestPhone').value,
                num_guests: parseInt(document.getElementById('numGuests').value),
                booking_date: document.getElementById('bookingDateTime')?.value || new Date().toISOString(),
                special_requests: document.getElementById('specialRequests').value,
                total_amount: parseFloat(document.getElementById('totalPrice').textContent.replace(/[^0-9.]/g, ''))
            };

            try {
                const response = await fetch('/api/offering-booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Booking confirmed! We will contact you shortly.');
                    window.location.href = '/hotel/paradise-resort';
                } else {
                    alert('Booking failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Booking error:', error);
                alert('Failed to submit booking. Please try again.');
            }
        });

        init();
    </script>
</body>
</html>
  `)
})

// GUEST WELCOME PAGE - QR Code Entry
// ============================================

app.get('/welcome/:property_slug/:room_token', async (c) => {
  const { property_slug, room_token } = c.req.param()
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Welcome - Paradise Resort</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          body { font-family: 'Inter', system-ui, sans-serif; }
          .gradient-bg { background: linear-gradient(135deg, #0EA5E9 0%, #10B981 100%); }
          .activity-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          .animate-slide-in { animation: slideIn 0.3s ease-out; }
        </style>
    </head>
    <body class="bg-gray-50">
        <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
                <p class="mt-4 text-gray-600">Loading...</p>
            </div>
        </div>

        <div id="content" class="hidden">
            <div class="gradient-bg text-white py-8 px-4 sticky top-0 z-10 shadow-lg">
                <div class="max-w-6xl mx-auto">
                    <h1 class="text-3xl font-bold" id="propertyName">Paradise Resort</h1>
                    <p class="text-sm opacity-90">Room <span id="roomNumber">---</span></p>
                </div>
            </div>

            <div class="max-w-6xl mx-auto px-4 py-8">
                <h2 class="text-2xl font-bold mb-6">Featured Activities</h2>
                <div id="activities" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                
                <div class="mt-12 text-center">
                    <a href="/browse?property=1&token=" id="browseAll" class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold">
                        Browse All Activities
                    </a>
                </div>
            </div>
        </div>

        <script>
        let sessionToken = '';
        
        async function init() {
            try {
                const response = await fetch('/api/welcome/${property_slug}/${room_token}');
                const data = await response.json();
                
                if (data.error) {
                    alert('Invalid QR code');
                    return;
                }
                
                sessionToken = data.session_token;
                document.getElementById('propertyName').textContent = data.property.name;
                document.getElementById('roomNumber').textContent = data.room.number;
                document.getElementById('browseAll').href += sessionToken;
                
                displayActivities(data.featured_activities);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert('Error loading page');
            }
        }
        
        function displayActivities(activities) {
            const html = activities.map(a => \`
                <div class="activity-card bg-white rounded-lg shadow-lg overflow-hidden transition cursor-pointer" 
                     onclick="bookActivity(\${a.activity_id})">
                    <div class="h-48 bg-gradient-to-r from-blue-400 to-green-400"></div>
                    <div class="p-4">
                        <h3 class="text-lg font-bold mb-2">\${a.title_en || a.title}</h3>
                        <p class="text-sm text-gray-600 mb-3">\${a.vendor_name}</p>
                        <p class="text-sm text-gray-700 mb-4">\${(a.short_description_en || a.short_description || '').substring(0, 100)}...</p>
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-blue-600">\${a.currency} \${a.price}</span>
                            <button class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                Book
                            </button>
                        </div>
                    </div>
                </div>
            \`).join('');
            
            document.getElementById('activities').innerHTML = html;
        }
        
        function bookActivity(id) {
            alert('Booking activity ' + id + '. Full booking interface will be available in the next update!' + String.fromCharCode(10) + String.fromCharCode(10) + 'For now, you can use the API directly to create bookings.');
        }
        
        window.addEventListener('DOMContentLoaded', init);
        </script>
    </body>
    </html>
  `)
})

// ============================================
// BROWSE ACTIVITIES PAGE
// ============================================

app.get('/browse', async (c) => {
  const propertyId = c.req.query('property') || '1'
  const token = c.req.query('token') || ''
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Browse Activities - Paradise Resort</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          body { font-family: 'Inter', system-ui, sans-serif; }
          .gradient-bg { background: linear-gradient(135deg, #0EA5E9 0%, #10B981 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="gradient-bg text-white py-4 px-4 sticky top-0 z-10 shadow-lg">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">Browse Activities</h1>
                <button onclick="window.history.back()" class="bg-white/20 px-4 py-2 rounded-lg">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>
        </div>

        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="mb-6 flex gap-4 overflow-x-auto pb-4" id="categories"></div>
            
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold">All Activities</h2>
                <select id="sortSelect" onchange="loadActivities()" class="px-4 py-2 border rounded-lg">
                    <option value="popularity">Most Popular</option>
                    <option value="price">Lowest Price</option>
                    <option value="duration">Shortest Duration</option>
                </select>
            </div>
            
            <div id="activities" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <script>
        const propertyId = '${propertyId}';
        const token = '${token}';
        let currentCategory = null;
        
        async function init() {
            await loadCategories();
            await loadActivities();
        }
        
        async function loadCategories() {
            const response = await fetch('/api/categories?lang=en');
            const data = await response.json();
            
            const html = '<button onclick="filterCategory(null)" class="flex-shrink-0 px-6 py-3 bg-white rounded-lg shadow">All</button>' +
                data.categories.map(c => \`
                    <button onclick="filterCategory('\${c.slug}')" 
                            class="flex-shrink-0 px-6 py-3 bg-white rounded-lg shadow hover:shadow-lg">
                        <i class="fas \${c.icon_name} text-blue-500"></i> \${c.name}
                    </button>
                \`).join('');
            
            document.getElementById('categories').innerHTML = html;
        }
        
        async function loadActivities() {
            const sort = document.getElementById('sortSelect').value;
            let url = \`/api/activities?property_id=\${propertyId}&sort=\${sort}&lang=en\`;
            if (currentCategory) url += \`&category=\${currentCategory}\`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            const html = data.activities.map(a => \`
                <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition cursor-pointer"
                     onclick="viewActivity(\${a.activity_id})">
                    <div class="h-48 bg-gradient-to-r from-blue-400 to-green-400"></div>
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-bold">\${a.title}</h3>
                            \${a.is_featured ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Featured</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-600 mb-2">\${a.vendor_name}</p>
                        <p class="text-sm text-gray-700 mb-3">\${a.short_description}</p>
                        <div class="flex justify-between items-center text-sm text-gray-600 mb-3">
                            <span><i class="far fa-clock"></i> \${a.duration_minutes} min</span>
                            <span><i class="far fa-user"></i> Max \${a.capacity_per_slot}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-blue-600">\${a.currency} \${a.price}</span>
                            <button class="bg-blue-500 text-white px-4 py-2 rounded-lg">Book</button>
                        </div>
                    </div>
                </div>
            \`).join('');
            
            document.getElementById('activities').innerHTML = html;
        }
        
        function filterCategory(slug) {
            currentCategory = slug;
            loadActivities();
        }
        
        function viewActivity(id) {
            alert('Activity details for ID: ' + id + String.fromCharCode(10) + String.fromCharCode(10) + 'Full detail page coming soon!' + String.fromCharCode(10) + String.fromCharCode(10) + 'For now, use API endpoint: /api/activities/' + id);
        }
        
        window.addEventListener('DOMContentLoaded', init);
        </script>
    </body>
    </html>
  `)
})

// ============================================
// HTML PAGE ROUTES
// ============================================

// Vendor login page
app.get('/vendor/login', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Vendor Login - Paradise Resort</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-100">
        <div class="min-h-screen flex items-center justify-center px-4">
            <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
                <h1 class="text-2xl font-bold mb-6 text-center">Vendor Portal Login</h1>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" id="email" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" id="password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login
                    </button>
                </form>
            </div>
        </div>
        <script>
          document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
              const response = await fetch('/api/vendor/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
              });
              
              const data = await response.json();
              
              if (data.success) {
                localStorage.setItem('vendor_id', data.vendor.vendor_id);
                localStorage.setItem('vendor_token', data.token);
                localStorage.setItem('vendor_business_name', data.vendor.business_name);
                window.location.href = '/vendor/dashboard';
              } else {
                alert('Login failed: ' + (data.error || 'Invalid credentials'));
              }
            } catch (error) {
              console.error('Login error:', error);
              alert('Login failed. Please try again.');
            }
          });
        </script>
    </body>
    </html>
  `)
})

// Admin login page
// ============================================
// GUESTCONNECT PLATFORM SUPER ADMIN
// ============================================

// Super Admin Login
app.get('/superadmin/login', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GuestConnect Platform Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-purple-600 to-blue-600 rounded-full mb-4">
                <i class="fas fa-crown text-white text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">GuestConnect</h1>
            <p class="text-gray-600 mt-2">Platform Super Admin</p>
        </div>

        <form id="loginForm" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 transition">
                <i class="fas fa-sign-in-alt mr-2"></i>Login to Platform Admin
            </button>
        </form>

        <div class="mt-6 text-center">
            <a href="/admin/login" class="text-sm text-gray-600 hover:text-purple-600">
                <i class="fas fa-hotel mr-1"></i>Hotel Admin Login
            </a>
        </div>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // Super admin credentials (hardcoded for now - you should change this!)
            if (email === 'superadmin@guestconnect.com' && password === 'GuestConnect2024!') {
                localStorage.setItem('superadmin_user', JSON.stringify({
                    user_id: 1,
                    email: email,
                    role: 'superadmin',
                    name: 'Platform Administrator'
                }));
                window.location.href = '/superadmin/dashboard';
            } else {
                alert('Invalid credentials');
            }
        });
    </script>
</body>
</html>
  `)
})

// Super Admin Dashboard
app.get('/superadmin/dashboard', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GuestConnect Platform Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      .tab-active { border-bottom: 3px solid #9333EA; color: #9333EA; }
      .hidden { display: none !important; }
      .tab-content { display: block; }
      .tab-btn { cursor: pointer; transition: all 0.3s; }
      .tab-btn:hover { background-color: rgba(147, 51, 234, 0.1); }
      .stat-card { transition: transform 0.2s; }
      .stat-card:hover { transform: translateY(-4px); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-700 to-blue-700 text-white py-4 px-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-crown mr-3"></i>GuestConnect Platform Admin
                </h1>
                <p class="text-purple-100 text-sm">Manage all hotels and platform settings</p>
            </div>
            <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Platform Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Hotels</p>
                        <p class="text-3xl font-bold text-purple-600" id="totalHotels">0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-full">
                        <i class="fas fa-hotel text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Vendors</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalVendors">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-full">
                        <i class="fas fa-store text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Bookings</p>
                        <p class="text-3xl font-bold text-green-600" id="totalBookings">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-full">
                        <i class="fas fa-calendar-check text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Platform Revenue</p>
                        <p class="text-3xl font-bold text-indigo-600" id="totalRevenue">$0</p>
                    </div>
                    <div class="bg-indigo-100 p-4 rounded-full">
                        <i class="fas fa-dollar-sign text-indigo-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="flex overflow-x-auto">
                <button data-tab="hotels" class="tab-btn px-6 py-4 font-semibold tab-active">
                    <i class="fas fa-hotel mr-2"></i>Hotels
                </button>
                <button data-tab="vendors" class="tab-btn px-6 py-4 font-semibold">
                    <i class="fas fa-store mr-2"></i>Vendors
                </button>
                <button data-tab="bookings" class="tab-btn px-6 py-4 font-semibold">
                    <i class="fas fa-calendar-alt mr-2"></i>All Bookings
                </button>
                <button data-tab="users" class="tab-btn px-6 py-4 font-semibold">
                    <i class="fas fa-users mr-2"></i>Users
                </button>
                <button data-tab="support" class="tab-btn px-6 py-4 font-semibold">
                    <i class="fas fa-ticket-alt mr-2"></i>Support
                </button>
                <button data-tab="chat" class="tab-btn px-6 py-4 font-semibold">
                    <i class="fas fa-comments mr-2"></i>Live Chat
                </button>
                <button data-tab="analytics" class="tab-btn px-6 py-4 font-semibold">
                    <i class="fas fa-chart-line mr-2"></i>Analytics
                </button>
                <button data-tab="settings" class="tab-btn px-6 py-4 font-semibold">
                    <i class="fas fa-cog mr-2"></i>Platform Settings
                </button>
            </div>
        </div>

        <!-- Users Management Tab -->
        <div id="usersTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold"><i class="fas fa-users mr-2 text-purple-600"></i>Platform Users</h2>
                    <div class="flex gap-3">
                        <select id="userTypeFilter" class="px-4 py-2 border rounded-lg">
                            <option value="all">All Types</option>
                            <option value="hotel">Hotel Admins</option>
                            <option value="vendor">Vendors</option>
                            <option value="superadmin">Super Admins</option>
                        </select>
                        <select id="userStatusFilter" class="px-4 py-2 border rounded-lg">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="inactive">Inactive</option>
                            <option value="pending">Pending</option>
                        </select>
                        <button onclick="loadUsers()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Associated With</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Login</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersList" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Support Tickets Tab -->
        <div id="supportTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold"><i class="fas fa-ticket-alt mr-2 text-orange-600"></i>Support Tickets</h2>
                    <div class="flex gap-3">
                        <select id="ticketStatusFilter" class="px-4 py-2 border rounded-lg">
                            <option value="all">All Status</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                        <select id="ticketPriorityFilter" class="px-4 py-2 border rounded-lg">
                            <option value="all">All Priority</option>
                            <option value="urgent">Urgent</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <button onclick="loadTickets()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ticket #</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">From</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Priority</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ticketsList" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Ticket Detail Modal (hidden by default) -->
            <div id="ticketModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="text-2xl font-bold" id="ticketModalTitle">Ticket Details</h3>
                        <button onclick="closeTicketModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6">
                        <div id="ticketDetails"></div>
                        <div class="mt-6">
                            <h4 class="font-bold mb-3">Messages</h4>
                            <div id="ticketMessages" class="space-y-3 mb-4"></div>
                            <div class="border-t pt-4">
                                <textarea id="ticketReplyMessage" placeholder="Type your reply..." class="w-full px-4 py-2 border rounded-lg" rows="3"></textarea>
                                <div class="flex justify-end gap-2 mt-2">
                                    <button onclick="replyToTicket(false)" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-reply mr-2"></i>Reply
                                    </button>
                                    <button onclick="replyToTicket(true)" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                        <i class="fas fa-sticky-note mr-2"></i>Internal Note
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Chat Tab -->
        <div id="chatTab" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" style="height: calc(100vh - 250px);">
                <!-- Chat Rooms List -->
                <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
                    <div class="p-4 border-b bg-gradient-to-r from-purple-600 to-blue-600 text-white">
                        <h3 class="font-bold flex items-center">
                            <i class="fas fa-comments mr-2"></i>Chat Rooms
                        </h3>
                    </div>
                    <div class="flex-1 overflow-y-auto" id="chatRoomsList">
                        <!-- Chat rooms will be loaded here -->
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div class="md:col-span-2 bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
                    <div class="p-4 border-b bg-gray-50">
                        <div id="chatHeader" class="text-gray-500">Select a chat room to start conversation</div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4" id="chatMessages" style="min-height: 400px;">
                        <!-- Messages will be loaded here -->
                    </div>
                    <div class="p-4 border-t">
                        <div class="flex gap-2">
                            <input type="text" id="chatMessageInput" placeholder="Type a message..." class="flex-1 px-4 py-2 border rounded-lg" disabled>
                            <button onclick="sendChatMessage()" id="sendChatBtn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hotels Tab -->
        <div id="hotelsTab" class="tab-content">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">
                    <i class="fas fa-plus-circle mr-2 text-purple-600"></i>Add New Hotel
                </h2>
                <form id="addHotelForm" class="grid md:grid-cols-3 gap-4">
                    <input type="text" id="hotelName" placeholder="Hotel Name" required class="px-4 py-2 border rounded-lg">
                    <input type="email" id="hotelEmail" placeholder="Admin Email" required class="px-4 py-2 border rounded-lg">
                    <input type="text" id="hotelSlug" placeholder="URL Slug (e.g., paradise-resort)" required class="px-4 py-2 border rounded-lg">
                    <input type="text" id="hotelPhone" placeholder="Phone" class="px-4 py-2 border rounded-lg">
                    <input type="text" id="hotelLocation" placeholder="Location/City" class="px-4 py-2 border rounded-lg">
                    <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                        <i class="fas fa-check mr-2"></i>Add Hotel
                    </button>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">All Hotels</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left">Hotel Name</th>
                                <th class="px-4 py-3 text-left">Slug</th>
                                <th class="px-4 py-3 text-left">Admin Email</th>
                                <th class="px-4 py-3 text-left">Location</th>
                                <th class="px-4 py-3 text-left">Status</th>
                                <th class="px-4 py-3 text-left">Created</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hotelsList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Vendors Tab -->
        <div id="vendorsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">All Vendors Across Platform</h2>
                <div id="vendorsList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Bookings Tab -->
        <div id="bookingsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">Recent Bookings</h2>
                <div id="bookingsList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">Platform Analytics</h2>
                <p class="text-gray-600">Analytics dashboard coming soon...</p>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">Platform Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Platform Name</label>
                        <input type="text" value="GuestConnect" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Default Currency</label>
                        <select class="w-full px-4 py-2 border rounded-lg">
                            <option>USD</option>
                            <option>EUR</option>
                            <option>GBP</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Commission Rate (%)</label>
                        <input type="number" value="10" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <button class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                        <i class="fas fa-save mr-2"></i>Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('superadmin_user') || '{}');
        if (!user.user_id || user.role !== 'superadmin') {
            window.location.href = '/superadmin/login';
        }

        let currentTab = 'hotels';

        function showTab(tab, clickedButton) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            if (clickedButton) {
                clickedButton.classList.add('tab-active');
            }

            if (tab === 'hotels') loadHotels();
            if (tab === 'vendors') loadVendors();
            if (tab === 'bookings') loadBookings();
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                showTab(tab, this);
            });
        });

        async function loadStats() {
            try {
                const response = await fetch('/api/superadmin/stats');
                const stats = await response.json();
                document.getElementById('totalHotels').textContent = stats.total_hotels || 0;
                document.getElementById('totalVendors').textContent = stats.total_vendors || 0;
                document.getElementById('totalBookings').textContent = stats.total_bookings || 0;
                document.getElementById('totalRevenue').textContent = '$' + (stats.total_revenue || 0).toLocaleString();
            } catch (error) {
                console.error('Load stats error:', error);
            }
        }

        async function loadHotels() {
            try {
                const response = await fetch('/api/superadmin/hotels');
                const hotels = await response.json();
                const list = document.getElementById('hotelsList');
                
                if (!hotels || hotels.length === 0) {
                    list.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No hotels yet</td></tr>';
                    return;
                }
                
                list.innerHTML = hotels.map(h => '<tr class="border-b hover:bg-gray-50"><td class="px-4 py-3 font-medium">' + h.property_name + '</td><td class="px-4 py-3"><code class="bg-gray-100 px-2 py-1 rounded text-sm">' + h.slug + '</code></td><td class="px-4 py-3">' + (h.contact_email || 'N/A') + '</td><td class="px-4 py-3">' + (h.location || 'N/A') + '</td><td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ' + (h.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800') + '">' + h.status + '</span></td><td class="px-4 py-3 text-sm text-gray-500">' + new Date(h.created_at).toLocaleDateString() + '</td><td class="px-4 py-3"><a href="/admin/dashboard?property_id=' + h.property_id + '" target="_blank" class="text-purple-600 hover:underline text-sm"><i class="fas fa-external-link-alt mr-1"></i>View Admin</a></td></tr>').join('');
            } catch (error) {
                console.error('Load hotels error:', error);
            }
        }

        async function loadVendors() {
            try {
                const response = await fetch('/api/superadmin/vendors');
                const vendors = await response.json();
                const list = document.getElementById('vendorsList');
                
                if (!vendors || vendors.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-8">No vendors yet</p>';
                    return;
                }
                
                list.innerHTML = vendors.map(v => '<div class="border rounded-lg p-4"><div class="flex justify-between items-start"><div><h3 class="font-bold">' + v.business_name + '</h3><p class="text-sm text-gray-600">' + v.email + ' â€¢ ' + v.phone + '</p><p class="text-xs text-gray-500 mt-1">Connected to: ' + (v.property_count || 0) + ' hotel(s)</p></div><span class="px-3 py-1 rounded-full text-sm ' + (v.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800') + '">' + v.status + '</span></div></div>').join('');
            } catch (error) {
                console.error('Load vendors error:', error);
            }
        }

        async function loadBookings() {
            try {
                const response = await fetch('/api/superadmin/bookings');
                const bookings = await response.json();
                const list = document.getElementById('bookingsList');
                
                if (!bookings || bookings.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-8">No bookings yet</p>';
                    return;
                }
                
                list.innerHTML = bookings.map(b => '<div class="border rounded-lg p-4"><div class="flex justify-between items-start"><div><h3 class="font-bold">' + b.activity_title + '</h3><p class="text-sm text-gray-600">Guest: ' + b.guest_name + ' (' + b.guest_email + ')</p><p class="text-sm text-gray-600">Hotel: ' + b.property_name + '</p><p class="text-xs text-gray-500 mt-1">' + new Date(b.booking_date).toLocaleString() + '</p></div><div class="text-right"><span class="text-lg font-bold text-blue-600">$' + (b.total_amount || 0) + '</span><br><span class="px-2 py-1 rounded text-xs ' + (b.payment_status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800') + '">' + b.payment_status + '</span></div></div></div>').join('');
            } catch (error) {
                console.error('Load bookings error:', error);
            }
        }

        document.getElementById('addHotelForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const hotelData = {
                property_name: document.getElementById('hotelName').value,
                slug: document.getElementById('hotelSlug').value,
                contact_email: document.getElementById('hotelEmail').value,
                contact_phone: document.getElementById('hotelPhone').value,
                location: document.getElementById('hotelLocation').value
            };

            try {
                const response = await fetch('/api/superadmin/hotels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(hotelData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Hotel added successfully! Admin credentials:' + String.fromCharCode(10) + 'Email: ' + hotelData.contact_email + String.fromCharCode(10) + 'Password: admin123' + String.fromCharCode(10) + String.fromCharCode(10) + 'Please ask the hotel to change their password.');
                    e.target.reset();
                    loadHotels();
                    loadStats();
                } else {
                    alert('Error: ' + (result.error || 'Failed to add hotel'));
                }
            } catch (error) {
                console.error('Add hotel error:', error);
                alert('Failed to add hotel');
            }
        });

        // ============================================
        // USER MANAGEMENT FUNCTIONS
        // ============================================
        let allUsers = [];
        
        async function loadUsers() {
            try {
                const userType = document.getElementById('userTypeFilter').value;
                const status = document.getElementById('userStatusFilter').value;
                
                const response = await fetch('/api/superadmin/users?type=' + userType + '&status=' + status);
                const data = await response.json();
                allUsers = data.users || [];
                displayUsers(allUsers);
            } catch (error) {
                console.error('Load users error:', error);
            }
        }
        
        function displayUsers(users) {
            const html = users.map(user => {
                const statusColors = {
                    active: 'bg-green-100 text-green-800',
                    suspended: 'bg-red-100 text-red-800',
                    inactive: 'bg-gray-100 text-gray-800',
                    pending: 'bg-yellow-100 text-yellow-800'
                };
                const typeIcons = {
                    hotel: 'fa-hotel',
                    vendor: 'fa-store',
                    superadmin: 'fa-crown'
                };
                
                return '<tr>' +
                    '<td class="px-6 py-4">' +
                        '<div class="font-medium">' + user.name + '</div>' +
                        '<div class="text-sm text-gray-500">' + user.email + '</div>' +
                    '</td>' +
                    '<td class="px-6 py-4">' +
                        '<i class="fas ' + typeIcons[user.user_type] + ' mr-2"></i>' +
                        user.user_type.toUpperCase() +
                    '</td>' +
                    '<td class="px-6 py-4 text-sm">' +
                        (user.property_name || user.vendor_business_name || 'N/A') +
                    '</td>' +
                    '<td class="px-6 py-4">' +
                        '<span class="px-2 py-1 text-xs rounded-full ' + statusColors[user.status] + '">' +
                            user.status.toUpperCase() +
                        '</span>' +
                    '</td>' +
                    '<td class="px-6 py-4 text-sm">' +
                        (user.last_login_at ? new Date(user.last_login_at).toLocaleDateString() : 'Never') +
                    '</td>' +
                    '<td class="px-6 py-4">' +
                        '<div class="flex gap-2">' +
                            (user.status === 'active' ?
                                '<button onclick="suspendUser(' + user.user_id + ')" class="text-red-600 hover:text-red-800">' +
                                    '<i class="fas fa-ban"></i>' +
                                '</button>' :
                                '<button onclick="activateUser(' + user.user_id + ')" class="text-green-600 hover:text-green-800">' +
                                    '<i class="fas fa-check-circle"></i>' +
                                '</button>') +
                            '<button onclick="deleteUser(' + user.user_id + ')" class="text-red-600 hover:text-red-800">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</td>' +
                '</tr>';
            }).join('');
            
            document.getElementById('usersList').innerHTML = html || '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
        }
        
        async function suspendUser(userId) {
            const reason = prompt('Reason for suspension:');
            if (!reason) return;
            
            try {
                const response = await fetch('/api/superadmin/users/' + userId + '/status', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'suspended', reason })
                });
                
                if (response.ok) {
                    alert('User suspended successfully');
                    loadUsers();
                }
            } catch (error) {
                console.error('Suspend user error:', error);
                alert('Failed to suspend user');
            }
        }
        
        async function activateUser(userId) {
            try {
                const response = await fetch('/api/superadmin/users/' + userId + '/status', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'active' })
                });
                
                if (response.ok) {
                    alert('User activated successfully');
                    loadUsers();
                }
            } catch (error) {
                console.error('Activate user error:', error);
                alert('Failed to activate user');
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/superadmin/users/' + userId, { method: 'DELETE' });
                if (response.ok) {
                    alert('User deleted successfully');
                    loadUsers();
                }
            } catch (error) {
                console.error('Delete user error:', error);
                alert('Failed to delete user');
            }
        }
        
        // ============================================
        // SUPPORT TICKET FUNCTIONS
        // ============================================
        let allTickets = [];
        let currentTicketId = null;
        
        async function loadTickets() {
            try {
                const status = document.getElementById('ticketStatusFilter').value;
                const priority = document.getElementById('ticketPriorityFilter').value;
                
                const response = await fetch('/api/superadmin/tickets?status=' + status + '&priority=' + priority);
                const data = await response.json();
                allTickets = data.tickets || [];
                displayTickets(allTickets);
            } catch (error) {
                console.error('Load tickets error:', error);
            }
        }
        
        function displayTickets(tickets) {
            const priorityColors = {
                urgent: 'bg-red-100 text-red-800',
                high: 'bg-orange-100 text-orange-800',
                medium: 'bg-yellow-100 text-yellow-800',
                low: 'bg-green-100 text-green-800'
            };
            const statusColors = {
                open: 'bg-blue-100 text-blue-800',
                in_progress: 'bg-purple-100 text-purple-800',
                resolved: 'bg-green-100 text-green-800',
                closed: 'bg-gray-100 text-gray-800'
            };
            
            const html = tickets.map(ticket => {
                return '<tr class="hover:bg-gray-50 cursor-pointer" onclick="viewTicket(' + ticket.ticket_id + ')">' +
                    '<td class="px-6 py-4 font-medium">' + ticket.ticket_number + '</td>' +
                    '<td class="px-6 py-4">' + ticket.subject + '</td>' +
                    '<td class="px-6 py-4">' +
                        '<div>' + ticket.created_by_name + '</div>' +
                        '<div class="text-xs text-gray-500">' + ticket.created_by_type + '</div>' +
                    '</td>' +
                    '<td class="px-6 py-4">' +
                        '<span class="px-2 py-1 text-xs rounded-full ' + priorityColors[ticket.priority] + '">' +
                            ticket.priority.toUpperCase() +
                        '</span>' +
                    '</td>' +
                    '<td class="px-6 py-4">' +
                        '<span class="px-2 py-1 text-xs rounded-full ' + statusColors[ticket.status] + '">' +
                            ticket.status.replace('_', ' ').toUpperCase() +
                        '</span>' +
                    '</td>' +
                    '<td class="px-6 py-4 text-sm">' +
                        new Date(ticket.created_at).toLocaleDateString() +
                    '</td>' +
                    '<td class="px-6 py-4">' +
                        '<button onclick="event.stopPropagation(); viewTicket(' + ticket.ticket_id + ')" class="text-blue-600 hover:text-blue-800">' +
                            '<i class="fas fa-eye"></i>' +
                        '</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
            
            document.getElementById('ticketsList').innerHTML = html || '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No tickets found</td></tr>';
        }
        
        async function viewTicket(ticketId) {
            currentTicketId = ticketId;
            const ticket = allTickets.find(t => t.ticket_id === ticketId);
            if (!ticket) return;
            
            document.getElementById('ticketModalTitle').textContent = 'Ticket #' + ticket.ticket_number;
            
            const detailsHtml = '<div class="space-y-4">' +
                '<div><strong>Subject:</strong> ' + ticket.subject + '</div>' +
                '<div><strong>Description:</strong><br>' + ticket.description + '</div>' +
                '<div><strong>From:</strong> ' + ticket.created_by_name + ' (' + ticket.created_by_email + ')</div>' +
                '<div><strong>Priority:</strong> ' + ticket.priority.toUpperCase() + '</div>' +
                '<div><strong>Status:</strong> ' + ticket.status.toUpperCase() + '</div>' +
                '<div><strong>Created:</strong> ' + new Date(ticket.created_at).toLocaleString() + '</div>' +
                '<div>' +
                    '<select id="ticketStatusUpdate" class="px-4 py-2 border rounded-lg">' +
                        '<option value="open" ' + (ticket.status === 'open' ? 'selected' : '') + '>Open</option>' +
                        '<option value="in_progress" ' + (ticket.status === 'in_progress' ? 'selected' : '') + '>In Progress</option>' +
                        '<option value="resolved" ' + (ticket.status === 'resolved' ? 'selected' : '') + '>Resolved</option>' +
                        '<option value="closed" ' + (ticket.status === 'closed' ? 'selected' : '') + '>Closed</option>' +
                    '</select>' +
                    '<button onclick="updateTicketStatus()" class="ml-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">' +
                        'Update Status' +
                    '</button>' +
                '</div>' +
            '</div>';
            
            document.getElementById('ticketDetails').innerHTML = detailsHtml;
            
            // Load messages
            try {
                const response = await fetch('/api/tickets/' + ticketId + '/messages');
                const data = await response.json();
                const messages = data.messages || [];
                
                const messagesHtml = messages.map(msg => {
                    return '<div class="border-l-4 ' + (msg.is_internal_note ? 'border-yellow-500 bg-yellow-50' : 'border-blue-500 bg-blue-50') + ' p-3 rounded">' +
                        '<div class="flex justify-between mb-1">' +
                            '<strong>' + msg.author_name + '</strong>' +
                            '<span class="text-xs text-gray-500">' + new Date(msg.created_at).toLocaleString() + '</span>' +
                        '</div>' +
                        (msg.is_internal_note ? '<div class="text-xs text-yellow-700 mb-1">Internal Note</div>' : '') +
                        '<div>' + msg.message + '</div>' +
                    '</div>';
                }).join('');
                
                document.getElementById('ticketMessages').innerHTML = messagesHtml || '<p class="text-gray-500">No messages yet</p>';
            } catch (error) {
                console.error('Load messages error:', error);
            }
            
            document.getElementById('ticketModal').classList.remove('hidden');
        }
        
        function closeTicketModal() {
            document.getElementById('ticketModal').classList.add('hidden');
            currentTicketId = null;
        }
        
        async function updateTicketStatus() {
            const newStatus = document.getElementById('ticketStatusUpdate').value;
            
            try {
                const response = await fetch('/api/superadmin/tickets/' + currentTicketId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus, assigned_to_id: 1, assigned_to_name: 'Super Admin' })
                });
                
                if (response.ok) {
                    alert('Ticket status updated');
                    loadTickets();
                    closeTicketModal();
                }
            } catch (error) {
                console.error('Update ticket error:', error);
                alert('Failed to update ticket');
            }
        }
        
        async function replyToTicket(isInternal) {
            const message = document.getElementById('ticketReplyMessage').value.trim();
            if (!message) return;
            
            try {
                const response = await fetch('/api/tickets/' + currentTicketId + '/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        is_internal_note: isInternal,
                        author_type: 'superadmin',
                        author_id: 1,
                        author_name: 'Super Admin'
                    })
                });
                
                if (response.ok) {
                    document.getElementById('ticketReplyMessage').value = '';
                    viewTicket(currentTicketId); // Reload to show new message
                }
            } catch (error) {
                console.error('Reply error:', error);
                alert('Failed to send reply');
            }
        }
        
        // ============================================
        // LIVE CHAT FUNCTIONS
        // ============================================
        let chatRooms = [];
        let currentRoomId = null;
        let chatRefreshInterval = null;
        
        async function loadChatRooms() {
            try {
                const response = await fetch('/api/superadmin/chat/rooms?status=active');
                const data = await response.json();
                chatRooms = data.rooms || [];
                displayChatRooms(chatRooms);
            } catch (error) {
                console.error('Load chat rooms error:', error);
            }
        }
        
        function displayChatRooms(rooms) {
            const html = rooms.map(room => {
                return '<div onclick="selectChatRoom(' + room.room_id + ')" class="p-4 border-b hover:bg-gray-50 cursor-pointer ' + (currentRoomId === room.room_id ? 'bg-blue-50' : '') + '">' +
                    '<div class="font-medium">' + room.room_name + '</div>' +
                    '<div class="text-sm text-gray-500">' + room.participant1_name + '</div>' +
                    '<div class="text-xs text-gray-400">' +
                        (room.last_message_at ? new Date(room.last_message_at).toLocaleString() : 'No messages') +
                    '</div>' +
                '</div>';
            }).join('');
            
            document.getElementById('chatRoomsList').innerHTML = html || '<div class="p-4 text-gray-500 text-center">No active chats</div>';
        }
        
        async function selectChatRoom(roomId) {
            currentRoomId = roomId;
            const room = chatRooms.find(r => r.room_id === roomId);
            if (!room) return;
            
            document.getElementById('chatHeader').innerHTML = '<div class="font-bold">' + room.room_name + '</div>' +
                '<div class="text-sm text-gray-500">' + room.participant1_name + '</div>';
            
            document.getElementById('chatMessageInput').disabled = false;
            document.getElementById('sendChatBtn').disabled = false;
            
            loadChatMessages(roomId);
            displayChatRooms(chatRooms); // Refresh to show selected state
            
            // Auto-refresh messages every 3 seconds
            if (chatRefreshInterval) clearInterval(chatRefreshInterval);
            chatRefreshInterval = setInterval(() => loadChatMessages(roomId), 3000);
        }
        
        async function loadChatMessages(roomId) {
            try {
                const response = await fetch('/api/chat/rooms/' + roomId + '/messages?limit=100');
                const data = await response.json();
                const messages = data.messages || [];
                
                const html = messages.map(msg => {
                    const isSuperAdmin = msg.sender_type === 'superadmin';
                    return '<div class="flex ' + (isSuperAdmin ? 'justify-end' : 'justify-start') + ' mb-3">' +
                        '<div class="max-w-[70%] ' + (isSuperAdmin ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-800') + ' px-4 py-2 rounded-lg">' +
                            '<div class="text-xs mb-1 ' + (isSuperAdmin ? 'text-purple-200' : 'text-gray-500') + '">' +
                                msg.sender_name + ' Â· ' + new Date(msg.created_at).toLocaleTimeString() +
                            '</div>' +
                            '<div>' + msg.message + '</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
                
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = html || '<div class="text-center text-gray-500">No messages yet. Start the conversation!</div>';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Load messages error:', error);
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatMessageInput');
            const message = input.value.trim();
            if (!message || !currentRoomId) return;
            
            try {
                const response = await fetch('/api/chat/rooms/' + currentRoomId + '/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        sender_type: 'superadmin',
                        sender_id: 1,
                        sender_name: 'Super Admin'
                    })
                });
                
                if (response.ok) {
                    input.value = '';
                    loadChatMessages(currentRoomId);
                }
            } catch (error) {
                console.error('Send message error:', error);
                alert('Failed to send message');
            }
        }
        
        // Allow Enter key to send messages
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('chatMessageInput');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });
        
        // ============================================
        // TAB SWITCHING
        // ============================================
        document.querySelectorAll('[data-tab]').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                // Update active button
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
                btn.classList.add('tab-active');
                
                // Show/hide content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(tab + 'Tab').classList.remove('hidden');
                
                // Load data for the selected tab
                if (tab === 'users') loadUsers();
                else if (tab === 'support') loadTickets();
                else if (tab === 'chat') loadChatRooms();
                else if (tab === 'hotels') loadHotels();
                else if (tab === 'vendors') loadVendors();
                else if (tab === 'bookings') loadBookings();
            });
        });
        
        // Event listeners for filters
        document.getElementById('userTypeFilter').addEventListener('change', loadUsers);
        document.getElementById('userStatusFilter').addEventListener('change', loadUsers);
        document.getElementById('ticketStatusFilter').addEventListener('change', loadTickets);
        document.getElementById('ticketPriorityFilter').addEventListener('change', loadTickets);

        function logout() {
            localStorage.removeItem('superadmin_user');
            window.location.href = '/superadmin/login';
        }

        loadStats();
        loadHotels();
    </script>
</body>
</html>
  `)
})

// ============================================
// HOTEL ADMIN (existing)
// ============================================

// Beach Map Designer - Interactive drag-and-drop interface
app.get('/admin/beach-map-designer', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beach Map Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        #beachCanvas {
            border: 2px solid #cbd5e0;
            cursor: crosshair;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .spot-icon {
            position: absolute;
            cursor: move;
            font-size: 24px;
            user-select: none;
            transition: transform 0.1s;
        }
        .spot-icon:hover {
            transform: scale(1.2);
        }
        .spot-icon.selected {
            transform: scale(1.3);
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.8));
        }
        .tool-btn {
            transition: all 0.2s;
        }
        .tool-btn.active {
            background: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-80 bg-white shadow-lg p-6 overflow-y-auto">
            <h1 class="text-2xl font-bold mb-6">
                <i class="fas fa-map-marked-alt mr-2 text-blue-600"></i>
                Beach Map Designer
            </h1>
            
            <!-- Tools -->
            <div class="mb-6">
                <h3 class="font-bold mb-3">Tools</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setTool('select')" id="selectTool" class="tool-btn active px-4 py-2 border rounded-lg hover:bg-gray-50">
                        <i class="fas fa-mouse-pointer mr-1"></i>Select
                    </button>
                    <button onclick="setTool('umbrella')" id="umbrellaTool" class="tool-btn px-4 py-2 border rounded-lg hover:bg-gray-50">
                        ðŸ”µ Umbrella
                    </button>
                    <button onclick="setTool('cabana')" id="cabanaTool" class="tool-btn px-4 py-2 border rounded-lg hover:bg-gray-50">
                        ðŸŸ¢ Cabana
                    </button>
                    <button onclick="setTool('lounger')" id="loungerTool" class="tool-btn px-4 py-2 border rounded-lg hover:bg-gray-50">
                        ðŸŸ¡ Lounger
                    </button>
                    <button onclick="setTool('daybed')" id="daybedTool" class="tool-btn px-4 py-2 border rounded-lg hover:bg-gray-50">
                        ðŸŸ£ Daybed
                    </button>
                    <button onclick="deleteSelected()" class="tool-btn px-4 py-2 border rounded-lg hover:bg-red-50 text-red-600">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                </div>
            </div>
            
            <!-- Zone Drawing Tools -->
            <div class="mb-6 bg-purple-50 p-4 rounded-lg border-2 border-purple-200">
                <h3 class="font-bold mb-3 text-purple-700">
                    <i class="fas fa-draw-polygon mr-2"></i>Zone Overlays
                </h3>
                <p class="text-xs text-gray-600 mb-3">Draw colored zones to help guests identify areas</p>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="setTool('zone-rect')" id="zoneRectTool" class="tool-btn px-4 py-2 border rounded-lg hover:bg-purple-100">
                        <i class="fas fa-square mr-1"></i>Draw Rectangle Zone
                    </button>
                    <button onclick="toggleZonesList()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-list mr-1"></i>Manage Zones (<span id="zonesCount">0</span>)
                    </button>
                </div>
            </div>
            
            <!-- Zones List (Hidden by default) -->
            <div id="zonesList" class="mb-6 hidden">
                <h3 class="font-bold mb-3">Zones</h3>
                <div id="zonesListContainer" class="space-y-2 max-h-60 overflow-y-auto">
                    <p class="text-sm text-gray-500">No zones created yet</p>
                </div>
            </div>
            
            <!-- Upload Beach Photo -->
            <div class="mb-6">
                <h3 class="font-bold mb-3">Beach Photo</h3>
                <input type="file" id="beachPhotoUpload" accept="image/*" class="w-full px-4 py-2 border rounded-lg text-sm">
                <p class="text-xs text-gray-500 mt-2">Upload an aerial view of your beach</p>
            </div>
            
            <!-- Selected Spot Details -->
            <div id="spotDetails" class="mb-6 hidden">
                <h3 class="font-bold mb-3">Spot Details</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Spot Number</label>
                        <input type="text" id="spotNumber" class="w-full px-3 py-2 border rounded-lg" placeholder="A1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Capacity</label>
                        <input type="number" id="spotCapacity" min="1" max="10" value="2" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">
                            <i class="fas fa-map-marker-alt mr-1 text-purple-600"></i>Zone
                        </label>
                        <select id="spotZone" class="w-full px-3 py-2 border rounded-lg bg-white">
                            <option value="General Area">General Area</option>
                            <option value="Quiet Zone">Quiet Zone</option>
                            <option value="Family Area">Family Area</option>
                            <option value="VIP Section">VIP Section</option>
                            <option value="Beach Front">Beach Front</option>
                            <option value="Pool Side">Pool Side</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Organize spots by zone for analytics</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Price (Full Day)</label>
                        <input type="number" id="spotPrice" min="0" step="5" value="0" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="spotPremium" class="mr-2">
                            <span class="text-sm">Premium Spot</span>
                        </label>
                    </div>
                    <button onclick="updateSpotDetails()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-save mr-2"></i>Update Spot
                    </button>
                </div>
            </div>
            
            <!-- Spots List -->
            <div class="mb-6">
                <h3 class="font-bold mb-3">Beach Spots (<span id="spotCount">0</span>)</h3>
                <div id="spotsList" class="space-y-2 max-h-60 overflow-y-auto">
                    <p class="text-sm text-gray-500">No spots placed yet</p>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="space-y-2">
                <button onclick="saveLayout()" class="w-full px-4 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg hover:from-green-700 hover:to-blue-700 font-semibold">
                    <i class="fas fa-save mr-2"></i>Save Beach Layout
                </button>
                <button onclick="clearAll()" class="w-full px-4 py-2 border border-red-600 text-red-600 rounded-lg hover:bg-red-50">
                    <i class="fas fa-trash mr-2"></i>Clear All Spots
                </button>
                <button onclick="window.close()" class="w-full px-4 py-2 border rounded-lg hover:bg-gray-50">
                    <i class="fas fa-times mr-2"></i>Close Designer
                </button>
            </div>
        </div>
        
        <!-- Canvas Area -->
        <div class="flex-1 p-6 overflow-auto">
            <div class="bg-white rounded-lg shadow-lg h-full p-4">
                <div class="relative w-full h-full overflow-auto">
                    <div id="beachCanvas" class="relative bg-gradient-to-b from-blue-100 to-yellow-100" style="min-width: 800px; min-height: 600px; width: max-content; height: max-content;">
                        <!-- Spots will be placed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentTool = 'select';
        let selectedSpot = null;
        let spots = [];
        let spotIdCounter = 1;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        
        // Zone overlay variables
        let zones = [];
        let zoneIdCounter = 1;
        let isDrawingZone = false;
        let zoneStartPoint = null;
        let currentZone = null;
        
        const canvas = document.getElementById('beachCanvas');
        const spotDetails = document.getElementById('spotDetails');
        
        // Load existing spots
        async function loadExistingSpots() {
            try {
                const response = await fetch('/api/admin/beach/spots/1');
                const data = await response.json();
                
                if (data.success && data.spots) {
                    spots = data.spots.map(spot => ({
                        id: spot.spot_id,
                        type: spot.spot_type,
                        x: spot.position_x,
                        y: spot.position_y,
                        number: spot.spot_number,
                        capacity: spot.max_capacity,
                        price: spot.price_full_day,
                        premium: spot.is_premium === 1,
                        zone: spot.zone_name || 'General Area'
                    }));
                    renderSpots();
                }
            } catch (error) {
                console.error('Load spots error:', error);
            }
        }
        
        // Load existing zone overlays
        async function loadExistingZones() {
            try {
                const response = await fetch('/api/admin/beach/zone-overlays/1');
                const data = await response.json();
                
                if (data.overlays && data.overlays.length > 0) {
                    zones = data.overlays.map(overlay => {
                        const coords = JSON.parse(overlay.coordinates);
                        return {
                            id: overlay.overlay_id,
                            name: overlay.zone_name,
                            x: coords.x,
                            y: coords.y,
                            width: coords.width,
                            height: coords.height,
                            color: overlay.color,
                            opacity: overlay.opacity
                        };
                    });
                    renderZones();
                }
            } catch (error) {
                console.error('Load zones error:', error);
            }
        }
        
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            const toolBtn = document.getElementById(tool + 'Tool');
            if (toolBtn) toolBtn.classList.add('active');
            canvas.style.cursor = tool === 'select' ? 'default' : 'crosshair';
        }
        
        function getSpotIcon(type) {
            const icons = {
                umbrella: 'ðŸ”µ',
                cabana: 'ðŸŸ¢',
                lounger: 'ðŸŸ¡',
                daybed: 'ðŸŸ£'
            };
            return icons[type] || 'ðŸ”µ';
        }
        
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (currentTool === 'select') return;
            
            // Handle zone drawing
            if (currentTool === 'zone-rect') {
                isDrawingZone = true;
                zoneStartPoint = { x, y };
                return;
            }
            
            // Handle spot placement
            const spot = {
                id: spotIdCounter++,
                type: currentTool,
                x: x,
                y: y,
                number: 'S' + spotIdCounter,
                capacity: 2,
                zone: 'General Area',
                price: 0,
                premium: false
            };
            
            spots.push(spot);
            renderSpots();
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawingZone || !zoneStartPoint) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Draw temporary zone rectangle
            renderZones();
            renderTempZone(zoneStartPoint.x, zoneStartPoint.y, x, y);
        });
        
        canvas.addEventListener('mouseup', (e) => {
            if (!isDrawingZone || !zoneStartPoint) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Calculate zone coordinates
            const minX = Math.min(zoneStartPoint.x, x);
            const minY = Math.min(zoneStartPoint.y, y);
            const width = Math.abs(x - zoneStartPoint.x);
            const height = Math.abs(y - zoneStartPoint.y);
            
            if (width > 20 && height > 20) {
                const zoneName = prompt('Enter zone name:', 'Quiet Zone');
                if (zoneName) {
                    const zone = {
                        id: zoneIdCounter++,
                        name: zoneName,
                        type: 'rectangle',
                        x: minX,
                        y: minY,
                        width: width,
                        height: height,
                        color: getZoneColor(zoneName),
                        opacity: 0.3
                    };
                    zones.push(zone);
                    renderZones();
                    updateZonesList();
                }
            }
            
            isDrawingZone = false;
            zoneStartPoint = null;
        });
        
        function renderSpots() {
            // Remove existing spot elements
            document.querySelectorAll('.spot-icon').forEach(el => el.remove());
            
            spots.forEach(spot => {
                const spotEl = document.createElement('div');
                spotEl.className = 'spot-icon';
                spotEl.innerHTML = getSpotIcon(spot.type);
                spotEl.style.left = spot.x + 'px';
                spotEl.style.top = spot.y + 'px';
                spotEl.dataset.spotId = spot.id;
                
                spotEl.addEventListener('mousedown', (e) => {
                    if (currentTool === 'select') {
                        e.stopPropagation();
                        selectSpot(spot.id);
                        isDragging = true;
                        const rect = canvas.getBoundingClientRect();
                        dragOffset.x = e.clientX - rect.left - spot.x;
                        dragOffset.y = e.clientY - rect.top - spot.y;
                    }
                });
                
                canvas.appendChild(spotEl);
            });
            
            updateSpotsList();
            document.getElementById('spotCount').textContent = spots.length;
        }
        
        document.addEventListener('mousemove', (e) => {
            if (isDragging && selectedSpot) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left - dragOffset.x;
                const y = e.clientY - rect.top - dragOffset.y;
                
                const spot = spots.find(s => s.id === selectedSpot);
                if (spot) {
                    spot.x = Math.max(0, Math.min(x, rect.width - 30));
                    spot.y = Math.max(0, Math.min(y, rect.height - 30));
                    renderSpots();
                }
            }
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        function selectSpot(id) {
            selectedSpot = id;
            document.querySelectorAll('.spot-icon').forEach(el => el.classList.remove('selected'));
            const spotEl = document.querySelector('[data-spot-id="' + id + '"]');
            if (spotEl) spotEl.classList.add('selected');
            
            const spot = spots.find(s => s.id === id);
            if (spot) {
                document.getElementById('spotNumber').value = spot.number;
                document.getElementById('spotCapacity').value = spot.capacity;
                document.getElementById('spotZone').value = spot.zone || 'General Area';
                document.getElementById('spotPrice').value = spot.price;
                document.getElementById('spotPremium').checked = spot.premium;
                spotDetails.classList.remove('hidden');
            }
        }
        
        function updateSpotDetails() {
            const spot = spots.find(s => s.id === selectedSpot);
            if (spot) {
                spot.number = document.getElementById('spotNumber').value;
                spot.capacity = parseInt(document.getElementById('spotCapacity').value);
                spot.zone = document.getElementById('spotZone').value;
                spot.price = parseFloat(document.getElementById('spotPrice').value);
                spot.premium = document.getElementById('spotPremium').checked;
                updateSpotsList();
                renderSpots();
                alert('âœ… Spot details updated!');
            }
        }
        
        function deleteSelected() {
            if (selectedSpot) {
                spots = spots.filter(s => s.id !== selectedSpot);
                selectedSpot = null;
                spotDetails.classList.add('hidden');
                renderSpots();
            } else {
                alert('Please select a spot first');
            }
        }
        
        function updateSpotsList() {
            const list = document.getElementById('spotsList');
            if (spots.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500">No spots placed yet</p>';
                return;
            }
            
            list.innerHTML = spots.map(spot =>
                '<div class="p-2 border rounded hover:bg-gray-50 cursor-pointer text-sm" onclick="selectSpot(' + spot.id + ')">' +
                    '<div class="flex items-center justify-between">' +
                        '<span>' + getSpotIcon(spot.type) + ' ' + spot.number + '</span>' +
                        '<span class="text-xs text-gray-500">' + spot.capacity + ' guests</span>' +
                    '</div>' +
                    '<div class="text-xs text-purple-600 mt-1">' +
                        '<i class="fas fa-map-marker-alt mr-1"></i>' + (spot.zone || 'General Area') +
                    '</div>' +
                '</div>'
            ).join('');
        }
        
        async function saveLayout() {
            if (spots.length === 0 && zones.length === 0) {
                alert('âš ï¸ Please add at least one spot or zone to the beach');
                return;
            }
            
            try {
                // Delete all existing spots
                const existingSpots = await fetch('/api/admin/beach/spots/1');
                const existingData = await existingSpots.json();
                
                if (existingData.success && existingData.spots) {
                    for (const spot of existingData.spots) {
                        await fetch('/api/admin/beach/spots/' + spot.spot_id, { method: 'DELETE' });
                    }
                }
                
                // Delete all existing zone overlays
                await fetch('/api/admin/beach/zone-overlays/1', { method: 'DELETE' });
                
                // Create all new spots
                for (const spot of spots) {
                    await fetch('/api/admin/beach/spots', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            property_id: 1,
                            zone_id: 1,
                            spot_number: spot.number,
                            spot_type: spot.type,
                            position_x: Math.round(spot.x),
                            position_y: Math.round(spot.y),
                            max_capacity: spot.capacity,
                            price_full_day: spot.price,
                            is_premium: spot.premium ? 1 : 0,
                            zone_name: spot.zone || 'General Area'
                        })
                    });
                }
                
                // Save all zone overlays
                for (let i = 0; i < zones.length; i++) {
                    const zone = zones[i];
                    await fetch('/api/admin/beach/zone-overlays', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            property_id: 1,
                            zone_name: zone.name,
                            shape_type: 'rectangle',
                            coordinates: JSON.stringify({
                                x: Math.round(zone.x),
                                y: Math.round(zone.y),
                                width: Math.round(zone.width),
                                height: Math.round(zone.height)
                            }),
                            color: zone.color,
                            opacity: zone.opacity,
                            display_order: i
                        })
                    });
                }
                
                alert('âœ… Beach layout saved successfully!\\n' + spots.length + ' spots and ' + zones.length + ' zones saved.');
            } catch (error) {
                console.error('Save error:', error);
                alert('âŒ Failed to save beach layout');
            }
        }
        
        function clearAll() {
            if (confirm('Clear all spots? This cannot be undone.')) {
                spots = [];
                selectedSpot = null;
                spotDetails.classList.add('hidden');
                renderSpots();
            }
        }
        
        // Zone overlay functions
        function renderZones() {
            document.querySelectorAll('.zone-overlay').forEach(el => el.remove());
            
            zones.forEach(zone => {
                const zoneEl = document.createElement('div');
                zoneEl.className = 'zone-overlay';
                zoneEl.style.position = 'absolute';
                zoneEl.style.left = zone.x + 'px';
                zoneEl.style.top = zone.y + 'px';
                zoneEl.style.width = zone.width + 'px';
                zoneEl.style.height = zone.height + 'px';
                zoneEl.style.backgroundColor = zone.color;
                zoneEl.style.opacity = zone.opacity;
                zoneEl.style.border = '2px dashed ' + zone.color;
                zoneEl.style.pointerEvents = 'none';
                zoneEl.style.borderRadius = '8px';
                
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.top = '5px';
                label.style.left = '5px';
                label.style.backgroundColor = zone.color;
                label.style.color = 'white';
                label.style.padding = '4px 8px';
                label.style.borderRadius = '4px';
                label.style.fontSize = '12px';
                label.style.fontWeight = 'bold';
                label.style.opacity = '0.9';
                label.textContent = zone.name;
                zoneEl.appendChild(label);
                
                canvas.appendChild(zoneEl);
            });
        }
        
        function renderTempZone(x1, y1, x2, y2) {
            document.querySelectorAll('.temp-zone').forEach(el => el.remove());
            
            const minX = Math.min(x1, x2);
            const minY = Math.min(y1, y2);
            const width = Math.abs(x2 - x1);
            const height = Math.abs(y2 - y1);
            
            const tempZone = document.createElement('div');
            tempZone.className = 'zone-overlay temp-zone';
            tempZone.style.position = 'absolute';
            tempZone.style.left = minX + 'px';
            tempZone.style.top = minY + 'px';
            tempZone.style.width = width + 'px';
            tempZone.style.height = height + 'px';
            tempZone.style.backgroundColor = '#8b5cf6';
            tempZone.style.opacity = '0.3';
            tempZone.style.border = '2px dashed #8b5cf6';
            tempZone.style.pointerEvents = 'none';
            tempZone.style.borderRadius = '8px';
            canvas.appendChild(tempZone);
        }
        
        function getZoneColor(zoneName) {
            const colors = {
                'Quiet Zone': '#10b981',
                'Family Area': '#f59e0b',
                'VIP Section': '#8b5cf6',
                'Beach Front': '#3b82f6',
                'Pool Side': '#06b6d4',
                'General Area': '#6b7280'
            };
            return colors[zoneName] || '#8b5cf6';
        }
        
        function updateZonesList() {
            const container = document.getElementById('zonesListContainer');
            const count = document.getElementById('zonesCount');
            count.textContent = zones.length;
            
            if (zones.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No zones created yet</p>';
                return;
            }
            
            container.innerHTML = zones.map(zone =>
                '<div class="p-3 border rounded-lg bg-white">' +
                    '<div class="flex items-center justify-between mb-2">' +
                        '<div class="flex items-center gap-2">' +
                            '<div class="w-4 h-4 rounded" style="background-color: ' + zone.color + ';"></div>' +
                            '<span class="font-medium">' + zone.name + '</span>' +
                        '</div>' +
                        '<button onclick="deleteZone(' + zone.id + ')" class="text-red-600 hover:text-red-800">' +
                            '<i class="fas fa-trash"></i>' +
                        '</button>' +
                    '</div>' +
                    '<div class="text-xs text-gray-500">' + zone.width + 'x' + zone.height + ' px</div>' +
                '</div>'
            ).join('');
        }
        
        window.toggleZonesList = function() {
            const list = document.getElementById('zonesList');
            list.classList.toggle('hidden');
        };
        
        window.deleteZone = function(id) {
            if (confirm('Delete this zone overlay?')) {
                zones = zones.filter(z => z.id !== id);
                renderZones();
                updateZonesList();
            }
        };
        
        // Beach photo upload
        document.getElementById('beachPhotoUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    canvas.style.backgroundImage = 'url(' + event.target.result + ')';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Initialize
        loadExistingSpots();
        loadExistingZones();
    </script>
</body>
</html>
  `)
})

// Beach Analytics Dashboard - Comprehensive analytics with AI insights
app.get('/admin/beach-analytics', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beach Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .insight-card { border-left: 4px solid #3b82f6; }
        .chart-container { position: relative; height: 300px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-chart-line mr-3 text-blue-600"></i>
                        Beach Analytics Dashboard
                    </h1>
                    <p class="text-gray-600 mt-2">Real-time insights and operational intelligence</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button onclick="window.location.href='/admin/dashboard'" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                </div>
            </div>
        </div>

        <!-- Today's Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="stat-card bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Bookings Today</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="todayBookings">--</p>
                    </div>
                    <div class="bg-blue-100 rounded-full p-4">
                        <i class="fas fa-calendar-check text-2xl text-blue-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Checked In</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="checkedIn">--</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-4">
                        <i class="fas fa-user-check text-2xl text-green-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-xl shadow-sm p-6 border-l-4 border-yellow-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Pending Check-In</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="pendingCheckin">--</p>
                    </div>
                    <div class="bg-yellow-100 rounded-full p-4">
                        <i class="fas fa-clock text-2xl text-yellow-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Today's Revenue</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="todayRevenue">$--</p>
                    </div>
                    <div class="bg-purple-100 rounded-full p-4">
                        <i class="fas fa-dollar-sign text-2xl text-purple-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI-Powered Insights -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-sm p-6 mb-6 border border-blue-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-brain mr-3 text-indigo-600"></i>
                AI-Powered Operational Recommendations
            </h2>
            <div id="aiInsights" class="space-y-3">
                <p class="text-gray-600">Analyzing data...</p>
            </div>
        </div>

        <!-- Live Occupancy Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-signal mr-3 text-blue-600"></i>
                Live Occupancy Status
                <span class="ml-3 px-3 py-1 bg-green-100 text-green-700 text-sm font-semibold rounded-full">
                    <i class="fas fa-circle text-xs animate-pulse mr-1"></i>LIVE
                </span>
            </h2>
            
            <!-- By Zone -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Occupancy by Zone</h3>
                <div id="occupancyByZone" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-gray-500">Loading...</p>
                </div>
            </div>
            
            <!-- By Spot Type -->
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Occupancy by Spot Type</h3>
                <div id="occupancyByType" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <p class="text-gray-500">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Revenue Analytics -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie mr-3 text-purple-600"></i>
                    Revenue by Zone (Last 7 Days)
                </h2>
                <div class="chart-container">
                    <canvas id="revenueByZoneChart"></canvas>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-3 text-green-600"></i>
                    Weekly Booking Trend
                </h2>
                <div class="chart-container">
                    <canvas id="weeklyTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Peak Hours Heatmap -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-fire mr-3 text-red-600"></i>
                Peak Hours Heatmap (Last 30 Days)
            </h2>
            <div id="peakHoursHeatmap" class="overflow-x-auto">
                <p class="text-gray-500">Loading heatmap...</p>
            </div>
        </div>

        <!-- No-Show Tracking -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-user-times mr-3 text-red-600"></i>
                No-Show Tracking (Last 30 Days)
            </h2>
            <div id="noShowSection">
                <p class="text-gray-500">Loading no-show data...</p>
            </div>
        </div>
    </div>

    <script>
        const propertyId = 1;
        let charts = {};

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/analytics/beach/dashboard/' + propertyId);
                const data = await response.json();
                
                if (data.success) {
                    // Update today's metrics
                    document.getElementById('todayBookings').textContent = data.today?.total_bookings || 0;
                    document.getElementById('checkedIn').textContent = data.today?.checked_in || 0;
                    document.getElementById('pendingCheckin').textContent = data.today?.pending_checkin || 0;
                    document.getElementById('todayRevenue').textContent = '$' + (data.today?.total_revenue || 0).toFixed(2);
                    
                    // Render charts
                    renderWeeklyTrend(data.week_trend || []);
                    renderRevenueByZone(data.zone_performance || []);
                    
                    // Generate AI insights
                    generateAIInsights(data);
                }
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        async function loadLiveOccupancy() {
            try {
                const response = await fetch('/api/analytics/beach/live-occupancy/' + propertyId);
                const data = await response.json();
                
                if (data.success) {
                    renderOccupancyByZone(data.occupancy);
                    renderOccupancyByType(data.occupancy);
                }
            } catch (error) {
                console.error('Live occupancy error:', error);
            }
        }

        function renderOccupancyByZone(occupancyData) {
            const zones = {};
            occupancyData.forEach(item => {
                if (!zones[item.zone_name]) {
                    zones[item.zone_name] = { total: 0, occupied: 0, available: 0 };
                }
                zones[item.zone_name].total += item.total;
                zones[item.zone_name].occupied += item.occupied;
                zones[item.zone_name].available += item.available;
            });
            
            const container = document.getElementById('occupancyByZone');
            container.innerHTML = Object.entries(zones).map(([zone, stats]) => {
                const rate = Math.round((stats.occupied / stats.total) * 100);
                const color = rate > 80 ? 'red' : rate > 50 ? 'yellow' : 'green';
                const barColor = rate > 80 ? 'bg-red-500' : rate > 50 ? 'bg-yellow-500' : 'bg-green-500';
                
                return \`
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-800">\${zone}</h4>
                            <span class="text-2xl font-bold text-\${color}-600">\${rate}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                            <div class="\${barColor} h-3 rounded-full transition-all" style="width: \${rate}%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span><i class="fas fa-check-circle text-green-600 mr-1"></i>\${stats.occupied} Occupied</span>
                            <span><i class="fas fa-circle text-gray-400 mr-1"></i>\${stats.available} Available</span>
                        </div>
                    </div>
                \`;
            }).join('');
        }

        function renderOccupancyByType(occupancyData) {
            const types = {};
            occupancyData.forEach(item => {
                if (!types[item.spot_type]) {
                    types[item.spot_type] = { total: 0, occupied: 0 };
                }
                types[item.spot_type].total += item.total;
                types[item.spot_type].occupied += item.occupied;
            });
            
            const icons = {
                umbrella: 'ðŸ”µ',
                cabana: 'ðŸŸ¢',
                lounger: 'ðŸŸ¡',
                daybed: 'ðŸŸ£'
            };
            
            const container = document.getElementById('occupancyByType');
            container.innerHTML = Object.entries(types).map(([type, stats]) => {
                const rate = Math.round((stats.occupied / stats.total) * 100);
                return \`
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 text-center">
                        <div class="text-3xl mb-2">\${icons[type] || 'ðŸ”µ'}</div>
                        <h4 class="font-semibold text-gray-800 capitalize mb-2">\${type}</h4>
                        <div class="text-2xl font-bold text-blue-600 mb-1">\${rate}%</div>
                        <div class="text-xs text-gray-600">\${stats.occupied}/\${stats.total} Occupied</div>
                    </div>
                \`;
            }).join('');
        }

        function renderWeeklyTrend(trendData) {
            const ctx = document.getElementById('weeklyTrendChart');
            if (charts.weeklyTrend) charts.weeklyTrend.destroy();
            
            charts.weeklyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(d => new Date(d.booking_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Bookings',
                        data: trendData.map(d => d.bookings),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        function renderRevenueByZone(zoneData) {
            const ctx = document.getElementById('revenueByZoneChart');
            if (charts.revenueByZone) charts.revenueByZone.destroy();
            
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444'];
            
            charts.revenueByZone = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: zoneData.map(z => z.zone_name),
                    datasets: [{
                        data: zoneData.map(z => z.revenue || 0),
                        backgroundColor: colors.slice(0, zoneData.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function generateAIInsights(data) {
            const insights = [];
            const today = data.today || {};
            const zones = data.zone_performance || [];
            
            // Occupancy insight
            const totalBookings = today.total_bookings || 0;
            const checkedIn = today.checked_in || 0;
            const occupancyRate = totalBookings > 0 ? Math.round((checkedIn / totalBookings) * 100) : 0;
            
            if (occupancyRate > 85) {
                insights.push({
                    icon: 'fa-exclamation-triangle',
                    color: 'red',
                    title: 'High Demand Alert',
                    text: 'Beach occupancy at ' + occupancyRate + '%. Consider implementing dynamic pricing or extending hours.'
                });
            } else if (occupancyRate < 40) {
                insights.push({
                    icon: 'fa-bullhorn',
                    color: 'yellow',
                    title: 'Low Utilization',
                    text: 'Current occupancy is ' + occupancyRate + '%. Recommend promotional campaigns or special offers.'
                });
            }
            
            // Zone performance insight
            if (zones.length > 0) {
                const topZone = zones.reduce((max, z) => z.revenue > max.revenue ? z : max, zones[0]);
                insights.push({
                    icon: 'fa-trophy',
                    color: 'green',
                    title: 'Top Performing Zone',
                    text: topZone.zone_name + ' generated $' + (topZone.revenue || 0).toFixed(2) + ' this week. Consider expanding similar zones.'
                });
            }
            
            // Staff optimization
            if (today.pending_checkin > 5) {
                insights.push({
                    icon: 'fa-users',
                    color: 'blue',
                    title: 'Staffing Recommendation',
                    text: today.pending_checkin + ' guests pending check-in. Ensure adequate staff at beach entrance during peak hours.'
                });
            }
            
            const container = document.getElementById('aiInsights');
            container.innerHTML = insights.map(insight => \`
                <div class="insight-card bg-white rounded-lg p-4 border-l-4 border-\${insight.color}-500 shadow-sm">
                    <div class="flex items-start gap-3">
                        <div class="bg-\${insight.color}-100 rounded-full p-3 flex-shrink-0">
                            <i class="fas \${insight.icon} text-\${insight.color}-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-1">\${insight.title}</h4>
                            <p class="text-sm text-gray-600">\${insight.text}</p>
                        </div>
                    </div>
                </div>
            \`).join('');
        }

        async function loadPeakHours() {
            try {
                const response = await fetch('/api/analytics/beach/peak-hours/' + propertyId + '?days=30');
                const data = await response.json();
                
                if (data.success) {
                    renderPeakHoursHeatmap(data.heatmap_data);
                }
            } catch (error) {
                console.error('Peak hours error:', error);
            }
        }

        function renderPeakHoursHeatmap(heatmapData) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const slots = ['Morning', 'Afternoon', 'Full Day'];
            
            // Aggregate by day and slot
            const matrix = {};
            heatmapData.forEach(row => {
                const day = days[parseInt(row.day_of_week)];
                const slot = row.slot_type === 'half_day_am' ? 'Morning' : 
                            row.slot_type === 'half_day_pm' ? 'Afternoon' : 'Full Day';
                const key = day + '|' + slot;
                matrix[key] = (matrix[key] || 0) + row.booking_count;
            });
            
            const maxValue = Math.max(...Object.values(matrix), 1);
            
            let html = '<table class="w-full border-collapse"><thead><tr class="bg-gray-100"><th class="p-3 text-left font-semibold text-gray-700">Time</th>';
            days.forEach(day => {
                html += '<th class="p-3 text-center font-semibold text-gray-700">' + day + '</th>';
            });
            html += '</tr></thead><tbody>';
            
            slots.forEach(slot => {
                html += '<tr><td class="p-3 font-medium text-gray-700">' + slot + '</td>';
                days.forEach(day => {
                    const key = day + '|' + slot;
                    const value = matrix[key] || 0;
                    const intensity = Math.round((value / maxValue) * 100);
                    const bgColor = intensity > 75 ? 'bg-red-500' :
                                   intensity > 50 ? 'bg-orange-500' :
                                   intensity > 25 ? 'bg-yellow-500' : 'bg-green-500';
                    const opacity = Math.max(0.2, intensity / 100);
                    
                    html += '<td class="p-3 text-center"><div class="' + bgColor + ' rounded-lg p-3 font-semibold text-white" style="opacity: ' + opacity + '">' + value + '</div></td>';
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            document.getElementById('peakHoursHeatmap').innerHTML = html;
        }

        async function loadNoShows() {
            try {
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                const startDateStr = startDate.toISOString().split('T')[0];
                
                const response = await fetch('/api/analytics/beach/no-shows/' + propertyId + '?start_date=' + startDateStr + '&end_date=' + endDate);
                const data = await response.json();
                
                if (data.success) {
                    renderNoShows(data.no_shows, data.statistics);
                }
            } catch (error) {
                console.error('No-shows error:', error);
            }
        }

        function renderNoShows(noShows, statistics) {
            const totalNoShows = statistics.reduce((sum, s) => sum + s.no_show_count, 0);
            const totalLost = statistics.reduce((sum, s) => sum + s.lost_revenue, 0);
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">';
            html += '<div class="bg-red-50 rounded-lg p-4 border border-red-200"><div class="text-sm text-gray-600 mb-1">Total No-Shows</div><div class="text-2xl font-bold text-red-600">' + totalNoShows + '</div></div>';
            html += '<div class="bg-red-50 rounded-lg p-4 border border-red-200"><div class="text-sm text-gray-600 mb-1">Lost Revenue</div><div class="text-2xl font-bold text-red-600">$' + totalLost.toFixed(2) + '</div></div>';
            html += '<div class="bg-blue-50 rounded-lg p-4 border border-blue-200"><div class="text-sm text-gray-600 mb-1">No-Show Rate</div><div class="text-2xl font-bold text-blue-600">' + (totalNoShows > 0 ? '15%' : '0%') + '</div></div>';
            html += '</div>';
            
            if (statistics.length > 0) {
                html += '<h3 class="font-semibold text-gray-700 mb-3">By Zone</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">';
                statistics.forEach(stat => {
                    html += '<div class="bg-gray-50 rounded-lg p-4 border border-gray-200">';
                    html += '<div class="flex justify-between items-center">';
                    html += '<span class="font-medium text-gray-800">' + stat.zone_name + '</span>';
                    html += '<span class="text-red-600 font-semibold">' + stat.no_show_count + ' no-shows</span>';
                    html += '</div>';
                    html += '<div class="text-sm text-gray-600 mt-1">Lost: $' + (stat.lost_revenue || 0).toFixed(2) + '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            document.getElementById('noShowSection').innerHTML = html;
        }

        async function refreshData() {
            await Promise.all([
                loadDashboardData(),
                loadLiveOccupancy(),
                loadPeakHours(),
                loadNoShows()
            ]);
        }

        // Initialize dashboard
        refreshData();
        
        // Auto-refresh every 30 seconds
        setInterval(loadLiveOccupancy, 30000);
    </script>
</body>
</html>
  `)
})

// Staff Beach Check-In Interface - Verify bookings via QR or code
app.get('/staff/beach-check-in', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beach Check-In - Staff</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-cyan-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent flex items-center">
                <i class="fas fa-check-circle mr-3 text-blue-600"></i>
                Beach Check-In
            </h1>
            <p class="text-gray-600 mt-2">Verify guest bookings with QR code or booking code</p>
        </div>

        <!-- Check-In Methods Tabs -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex gap-4 mb-6 border-b">
                <button onclick="switchTab('qr')" id="qrTab" class="tab-btn active px-6 py-3 font-semibold border-b-4 border-blue-600 text-blue-600">
                    <i class="fas fa-qrcode mr-2"></i>Scan QR Code
                </button>
                <button onclick="switchTab('manual')" id="manualTab" class="tab-btn px-6 py-3 font-semibold border-b-4 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-keyboard mr-2"></i>Enter Code
                </button>
            </div>

            <!-- QR Scanner Tab -->
            <div id="qrContent" class="tab-content">
                <div class="text-center">
                    <div id="qr-reader" class="mx-auto max-w-md border-4 border-blue-200 rounded-xl overflow-hidden"></div>
                    <p class="text-sm text-gray-600 mt-4">
                        <i class="fas fa-info-circle mr-2"></i>
                        Position the QR code within the frame
                    </p>
                    <button onclick="startQRScanner()" id="startScanBtn" class="mt-4 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold">
                        <i class="fas fa-camera mr-2"></i>Start Camera
                    </button>
                    <button onclick="stopQRScanner()" id="stopScanBtn" class="mt-4 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold hidden">
                        <i class="fas fa-stop mr-2"></i>Stop Camera
                    </button>
                </div>
            </div>

            <!-- Manual Entry Tab -->
            <div id="manualContent" class="tab-content hidden">
                <div class="max-w-md mx-auto">
                    <label class="block text-lg font-semibold mb-3">Enter Booking Code</label>
                    <input 
                        type="text" 
                        id="bookingCodeInput" 
                        placeholder="B12345" 
                        maxlength="6"
                        class="w-full px-6 py-4 text-2xl font-bold text-center border-4 border-blue-200 rounded-xl focus:border-blue-500 focus:outline-none uppercase"
                        onkeyup="this.value = this.value.toUpperCase()"
                    >
                    <button onclick="verifyManualCode()" class="w-full mt-4 px-6 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold text-lg">
                        <i class="fas fa-check mr-2"></i>Verify Booking
                    </button>
                </div>
            </div>
        </div>

        <!-- Verification Result -->
        <div id="resultCard" class="hidden">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Recent Check-Ins -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-history mr-3 text-gray-600"></i>
                Recent Check-Ins
            </h3>
            <div id="recentCheckIns" class="space-y-3">
                <p class="text-gray-500 text-center py-4">No check-ins yet today</p>
            </div>
        </div>
    </div>

    <script>
        let html5QrCode = null;
        let recentCheckIns = [];

        function switchTab(tab) {
            // Update tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            if (tab === 'qr') {
                document.getElementById('qrTab').classList.add('active', 'border-blue-600', 'text-blue-600');
                document.getElementById('qrContent').classList.remove('hidden');
                document.getElementById('manualContent').classList.add('hidden');
            } else {
                document.getElementById('manualTab').classList.add('active', 'border-blue-600', 'text-blue-600');
                document.getElementById('qrContent').classList.add('hidden');
                document.getElementById('manualContent').classList.remove('hidden');
                stopQRScanner();
            }
        }

        async function startQRScanner() {
            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                await html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    onScanFailure
                );
                document.getElementById('startScanBtn').classList.add('hidden');
                document.getElementById('stopScanBtn').classList.remove('hidden');
            } catch (err) {
                alert('Failed to start camera: ' + err);
            }
        }

        function stopQRScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById('startScanBtn').classList.remove('hidden');
                    document.getElementById('stopScanBtn').classList.add('hidden');
                }).catch(err => console.error(err));
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            stopQRScanner();
            await verifyBooking(decodedText, 'qr');
        }

        function onScanFailure(error) {
            // Ignore scan failures (happens frequently)
        }

        async function verifyManualCode() {
            const code = document.getElementById('bookingCodeInput').value.trim().toUpperCase();
            if (!code || code.length < 5) {
                alert('Please enter a valid booking code (e.g., B12345)');
                return;
            }
            await verifyBooking(code, 'manual');
        }

        async function verifyBooking(data, method) {
            try {
                const response = await fetch('/api/staff/beach/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data, method })
                });

                const result = await response.json();
                
                if (result.success && result.booking) {
                    showBookingDetails(result.booking);
                } else {
                    showError(result.error || 'Booking not found');
                }
            } catch (error) {
                console.error('Verification error:', error);
                showError('Failed to verify booking');
            }
        }

        function showBookingDetails(booking) {
            const resultCard = document.getElementById('resultCard');
            
            const statusColor = booking.booking_status === 'checked_in' ? 'yellow' : 'green';
            const statusText = booking.booking_status === 'checked_in' ? 'Already Checked In' : 'Valid Booking';
            const statusIcon = booking.booking_status === 'checked_in' ? 'fa-exclamation-triangle' : 'fa-check-circle';
            
            resultCard.innerHTML = \`
                <div class="bg-white rounded-2xl shadow-2xl p-8 border-4 border-\${statusColor}-400">
                    <div class="text-center mb-6">
                        <div class="inline-block p-4 bg-\${statusColor}-100 rounded-full mb-3">
                            <i class="fas \${statusIcon} text-4xl text-\${statusColor}-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">\${statusText}</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 rounded-xl">
                            <p class="text-sm text-gray-600">Booking Code</p>
                            <p class="text-3xl font-black text-blue-900">\${booking.booking_code}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-purple-50 rounded-xl">
                                <p class="text-xs text-gray-600">Spot</p>
                                <p class="text-xl font-bold">\${getSpotIcon(booking.spot_type)} \${booking.spot_number}</p>
                            </div>
                            <div class="p-4 bg-green-50 rounded-xl">
                                <p class="text-xs text-gray-600">Date</p>
                                <p class="text-sm font-bold">\${new Date(booking.booking_date).toLocaleDateString()}</p>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-pink-50 rounded-xl">
                            <p class="text-xs text-gray-600">Guest</p>
                            <p class="text-lg font-bold">\${booking.guest_name}</p>
                            <p class="text-sm text-gray-600">Room: \${booking.guest_room_number || 'N/A'}</p>
                        </div>
                        
                        \${booking.booking_status !== 'checked_in' ? \`
                            <button onclick="checkInGuest('\${booking.booking_reference}')" class="w-full px-6 py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold text-lg">
                                <i class="fas fa-check-double mr-2"></i>Confirm Check-In
                            </button>
                        \` : \`
                            <div class="p-4 bg-yellow-50 rounded-xl border-2 border-yellow-300">
                                <p class="text-sm font-semibold text-yellow-800">
                                    <i class="fas fa-clock mr-2"></i>
                                    Checked in at: \${new Date(booking.checked_in_at).toLocaleTimeString()}
                                </p>
                                <p class="text-xs text-gray-600 mt-1">By: \${booking.checked_in_by || 'Staff'}</p>
                            </div>
                        \`}
                    </div>
                </div>
            \`;
            
            resultCard.classList.remove('hidden');
        }

        async function checkInGuest(bookingReference) {
            const staffName = prompt('Enter your name:');
            if (!staffName) return;
            
            try {
                const response = await fetch('/api/staff/beach/check-in', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        booking_reference: bookingReference,
                        staff_name: staffName
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… Guest checked in successfully!');
                    addToRecentCheckIns(result.booking);
                    document.getElementById('resultCard').classList.add('hidden');
                    document.getElementById('bookingCodeInput').value = '';
                } else {
                    alert('âŒ ' + (result.error || 'Check-in failed'));
                }
            } catch (error) {
                console.error('Check-in error:', error);
                alert('âŒ Failed to check in guest');
            }
        }

        function showError(message) {
            const resultCard = document.getElementById('resultCard');
            resultCard.innerHTML = \`
                <div class="bg-white rounded-2xl shadow-2xl p-8 border-4 border-red-400">
                    <div class="text-center">
                        <div class="inline-block p-4 bg-red-100 rounded-full mb-3">
                            <i class="fas fa-times-circle text-4xl text-red-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Booking Not Found</h2>
                        <p class="text-gray-600">\${message}</p>
                        <button onclick="document.getElementById('resultCard').classList.add('hidden')" class="mt-4 px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-xl">
                            Try Again
                        </button>
                    </div>
                </div>
            \`;
            resultCard.classList.remove('hidden');
        }

        function addToRecentCheckIns(booking) {
            recentCheckIns.unshift(booking);
            if (recentCheckIns.length > 5) recentCheckIns.pop();
            
            const container = document.getElementById('recentCheckIns');
            container.innerHTML = recentCheckIns.map(b => \`
                <div class="flex items-center gap-4 p-4 bg-green-50 rounded-xl">
                    <div class="flex-shrink-0 w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white font-bold">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">\${b.guest_name}</p>
                        <p class="text-sm text-gray-600">\${getSpotIcon(b.spot_type)} Spot \${b.spot_number} â€¢ \${b.booking_code}</p>
                    </div>
                    <div class="text-right text-xs text-gray-500">
                        \${new Date(b.checked_in_at).toLocaleTimeString()}
                    </div>
                </div>
            \`).join('');
        }

        function getSpotIcon(type) {
            const icons = {
                umbrella: 'ðŸ”µ',
                cabana: 'ðŸŸ¢',
                lounger: 'ðŸŸ¡',
                daybed: 'ðŸŸ£'
            };
            return icons[type] || 'ðŸ”µ';
        }

        // Initialize
        document.getElementById('bookingCodeInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyManualCode();
        });
    </script>
</body>
</html>
  `)
})

// Interactive Hotel Map Builder - Admin tool to create clickable map hotspots
app.get('/admin/interactive-map-builder', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        #mapCanvas {
            position: relative;
            border: 3px solid #cbd5e0;
            background: #f7fafc;
            cursor: crosshair;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            overflow: hidden;
        }
        .hotspot {
            position: absolute;
            border: 3px solid;
            background: rgba(59, 130, 246, 0.2);
            cursor: move;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-center;
            font-size: 20px;
        }
        .hotspot:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
            z-index: 10;
        }
        .hotspot.selected {
            border-color: #10B981;
            background: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.8);
            z-index: 11;
        }
        .hotspot.circle {
            border-radius: 50%;
        }
        .category-badge {
            transition: all 0.2s;
        }
        .category-badge:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-96 bg-white shadow-2xl p-6 overflow-y-auto border-r-4 border-blue-200">
            <div class="mb-6">
                <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                    <i class="fas fa-map-marked-alt mr-2"></i>
                    Interactive Map Builder
                </h1>
                <p class="text-sm text-gray-600">Create clickable hotspots on your hotel map</p>
            </div>

            <!-- Map Image URL -->
            <div class="mb-6 bg-blue-50 p-4 rounded-xl border border-blue-200">
                <label class="block text-sm font-bold mb-2 text-gray-800">
                    <i class="fas fa-image mr-2 text-blue-600"></i>Map Image URL
                </label>
                <input type="url" id="mapImageUrl" placeholder="https://..." class="w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 mb-2" />
                <button onclick="loadMapImage()" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                    <i class="fas fa-download mr-2"></i>Load Map
                </button>
            </div>

            <!-- Drawing Tools -->
            <div class="mb-6">
                <h3 class="font-bold mb-3 text-gray-800">
                    <i class="fas fa-tools mr-2 text-indigo-600"></i>Drawing Tools
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setTool('select')" id="selectTool" class="tool-btn px-4 py-3 border-2 rounded-lg font-semibold transition bg-blue-600 text-white">
                        <i class="fas fa-mouse-pointer mr-2"></i>Select
                    </button>
                    <button onclick="setTool('rectangle')" id="rectangleTool" class="tool-btn px-4 py-3 border-2 rounded-lg font-semibold hover:bg-gray-50 transition">
                        <i class="fas fa-square mr-2"></i>Rectangle
                    </button>
                    <button onclick="setTool('circle')" id="circleTool" class="tool-btn px-4 py-3 border-2 rounded-lg font-semibold hover:bg-gray-50 transition">
                        <i class="fas fa-circle mr-2"></i>Circle
                    </button>
                    <button onclick="deleteSelected()" class="tool-btn px-4 py-3 border-2 border-red-500 text-red-600 rounded-lg font-semibold hover:bg-red-50 transition">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                </div>
            </div>

            <!-- Hotspot Details -->
            <div id="hotspotDetails" class="mb-6 bg-green-50 p-4 rounded-xl border-2 border-green-300 hidden">
                <h3 class="font-bold mb-3 text-gray-800 flex items-center">
                    <i class="fas fa-edit mr-2 text-green-600"></i>Hotspot Details
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Title *</label>
                        <input type="text" id="hotspotTitle" placeholder="e.g., Building 23" class="w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-green-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Subtitle</label>
                        <input type="text" id="hotspotSubtitle" placeholder="e.g., Deluxe Rooms" class="w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-green-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Category *</label>
                        <select id="hotspotCategory" class="w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">Select category...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Building Number</label>
                        <input type="text" id="hotspotBuildingNumber" placeholder="e.g., 23" class="w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-green-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Description</label>
                        <textarea id="hotspotDescription" rows="2" placeholder="Additional details..." class="w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Link URL (optional)</label>
                        <input type="url" id="hotspotLink" placeholder="https://..." class="w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-green-500" />
                    </div>
                    <button onclick="updateHotspot()" class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-lg">
                        <i class="fas fa-save mr-2"></i>Update Hotspot
                    </button>
                </div>
            </div>

            <!-- Hotspots List -->
            <div class="mb-6">
                <h3 class="font-bold mb-3 text-gray-800 flex items-center justify-between">
                    <span><i class="fas fa-list mr-2 text-purple-600"></i>Hotspots (<span id="hotspotCount">0</span>)</span>
                </h3>
                <div id="hotspotsList" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-sm text-gray-500 italic">No hotspots yet. Draw on the map to add!</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="space-y-2">
                <button onclick="saveAllHotspots()" class="w-full py-4 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-xl font-bold text-lg shadow-xl hover:from-green-700 hover:to-blue-700 transition-all transform hover:scale-105">
                    <i class="fas fa-save mr-2"></i>Save All Hotspots
                </button>
                <button onclick="clearAll()" class="w-full py-2 border-2 border-red-600 text-red-600 rounded-lg font-semibold hover:bg-red-50 transition">
                    <i class="fas fa-trash-alt mr-2"></i>Clear All
                </button>
                <button onclick="window.close()" class="w-full py-2 border-2 rounded-lg font-semibold hover:bg-gray-50 transition">
                    <i class="fas fa-times mr-2"></i>Close
                </button>
            </div>
        </div>
        
        <!-- Canvas Area -->
        <div class="flex-1 p-6 overflow-auto bg-gradient-to-br from-gray-50 to-gray-100">
            <div class="bg-white rounded-2xl shadow-2xl h-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-compass mr-2 text-blue-600"></i>Map Canvas
                    </h2>
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-2"></i>
                        Click and drag to draw hotspots
                    </div>
                </div>
                <div id="mapCanvas" class="w-full rounded-xl" style="height: calc(100% - 60px);">
                    <div class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <i class="fas fa-map text-6xl mb-4"></i>
                            <p class="text-lg">Load a map image to begin</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTool = 'select';
        let selectedHotspot = null;
        let hotspots = [];
        let hotspotIdCounter = 1;
        let isDrawing = false;
        let isDragging = false;
        let startX = 0, startY = 0;
        let dragStartX = 0, dragStartY = 0;
        let categories = [];
        let mapLoaded = false;
        
        const canvas = document.getElementById('mapCanvas');
        
        // Load categories from database
        async function loadCategories() {
            try {
                const response = await fetch('/api/admin/hotel-map/categories/1');
                const data = await response.json();
                
                if (data.success && data.categories) {
                    categories = data.categories;
                    const select = document.getElementById('hotspotCategory');
                    select.innerHTML = '<option value="">Select category...</option>' +
                        categories.map(cat => 
                            \`<option value="\${cat.category_key}">\${cat.icon_emoji || ''} \${cat.category_name}</option>\`
                        ).join('');
                }
            } catch (error) {
                console.error('Load categories error:', error);
            }
        }
        
        // Load existing hotspots
        async function loadExistingHotspots() {
            try {
                const response = await fetch('/api/admin/hotel-map/hotspots/1');
                const data = await response.json();
                
                if (data.success && data.hotspots) {
                    hotspots = data.hotspots.map(h => ({
                        id: h.hotspot_id,
                        x: h.position_x,
                        y: h.position_y,
                        width: h.width,
                        height: h.height,
                        shape: h.shape,
                        title: h.title,
                        subtitle: h.subtitle,
                        description: h.description,
                        category: h.category,
                        buildingNumber: h.building_number,
                        link: h.link_url,
                        color: h.color
                    }));
                    renderHotspots();
                    updateHotspotsList();
                }
            } catch (error) {
                console.error('Load hotspots error:', error);
            }
        }
        
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
            });
            const btn = document.getElementById(tool + 'Tool');
            if (btn) {
                btn.classList.add('bg-blue-600', 'text-white');
            }
            canvas.style.cursor = tool === 'select' ? 'default' : 'crosshair';
        }
        
        function loadMapImage() {
            const url = document.getElementById('mapImageUrl').value;
            if (!url) {
                alert('Please enter a map image URL');
                return;
            }
            
            canvas.style.backgroundImage = \`url(\${url})\`;
            mapLoaded = true;
            canvas.innerHTML = '';
            alert('âœ… Map loaded! Now draw hotspots on the map.');
        }
        
        // Mouse events for drawing
        canvas.addEventListener('mousedown', (e) => {
            if (!mapLoaded) {
                alert('Please load a map image first');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            
            if (currentTool === 'select') {
                // Check if clicked on a hotspot
                const clicked = hotspots.find(h => {
                    return x >= h.x && x <= (h.x + h.width) &&
                           y >= h.y && y <= (h.y + h.height);
                });
                
                if (clicked) {
                    selectHotspot(clicked.id);
                    isDragging = true;
                    dragStartX = x - clicked.x;
                    dragStartY = y - clicked.y;
                }
            } else {
                // Start drawing new hotspot
                isDrawing = true;
                startX = x;
                startY = y;
            }
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!mapLoaded) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            
            if (isDragging && selectedHotspot) {
                const hotspot = hotspots.find(h => h.id === selectedHotspot);
                if (hotspot) {
                    hotspot.x = Math.max(0, Math.min(x - dragStartX, 100 - hotspot.width));
                    hotspot.y = Math.max(0, Math.min(y - dragStartY, 100 - hotspot.height));
                    renderHotspots();
                }
            }
        });
        
        canvas.addEventListener('mouseup', (e) => {
            if (!mapLoaded) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            
            if (isDrawing && (currentTool === 'rectangle' || currentTool === 'circle')) {
                const width = Math.abs(x - startX);
                const height = Math.abs(y - startY);
                
                if (width > 1 && height > 1) {
                    const hotspot = {
                        id: hotspotIdCounter++,
                        x: Math.min(startX, x),
                        y: Math.min(startY, y),
                        width: width,
                        height: height,
                        shape: currentTool,
                        title: 'Hotspot ' + hotspotIdCounter,
                        subtitle: '',
                        description: '',
                        category: '',
                        buildingNumber: '',
                        link: '',
                        color: '#3B82F6'
                    };
                    
                    hotspots.push(hotspot);
                    renderHotspots();
                    updateHotspotsList();
                    selectHotspot(hotspot.id);
                }
            }
            
            isDrawing = false;
            isDragging = false;
        });
        
        function renderHotspots() {
            document.querySelectorAll('.hotspot').forEach(el => el.remove());
            
            hotspots.forEach(hotspot => {
                const el = document.createElement('div');
                el.className = 'hotspot' + (hotspot.shape === 'circle' ? ' circle' : '');
                if (selectedHotspot === hotspot.id) {
                    el.classList.add('selected');
                }
                el.style.left = hotspot.x + '%';
                el.style.top = hotspot.y + '%';
                el.style.width = hotspot.width + '%';
                el.style.height = hotspot.height + '%';
                el.style.borderColor = hotspot.color || '#3B82F6';
                el.dataset.hotspotId = hotspot.id;
                
                // Show icon or building number
                const cat = categories.find(c => c.category_key === hotspot.category);
                if (hotspot.buildingNumber) {
                    el.innerHTML = '<span class="font-bold text-white bg-blue-600 px-2 py-1 rounded">' + hotspot.buildingNumber + '</span>';
                } else if (cat && cat.icon_emoji) {
                    el.innerHTML = cat.icon_emoji;
                }
                
                el.title = hotspot.title;
                
                canvas.appendChild(el);
            });
            
            document.getElementById('hotspotCount').textContent = hotspots.length;
        }
        
        function selectHotspot(id) {
            selectedHotspot = id;
            renderHotspots();
            
            const hotspot = hotspots.find(h => h.id === id);
            if (hotspot) {
                document.getElementById('hotspotTitle').value = hotspot.title;
                document.getElementById('hotspotSubtitle').value = hotspot.subtitle || '';
                document.getElementById('hotspotCategory').value = hotspot.category || '';
                document.getElementById('hotspotBuildingNumber').value = hotspot.buildingNumber || '';
                document.getElementById('hotspotDescription').value = hotspot.description || '';
                document.getElementById('hotspotLink').value = hotspot.link || '';
                document.getElementById('hotspotDetails').classList.remove('hidden');
            }
        }
        
        function updateHotspot() {
            const hotspot = hotspots.find(h => h.id === selectedHotspot);
            if (hotspot) {
                hotspot.title = document.getElementById('hotspotTitle').value;
                hotspot.subtitle = document.getElementById('hotspotSubtitle').value;
                hotspot.category = document.getElementById('hotspotCategory').value;
                hotspot.buildingNumber = document.getElementById('hotspotBuildingNumber').value;
                hotspot.description = document.getElementById('hotspotDescription').value;
                hotspot.link = document.getElementById('hotspotLink').value;
                
                const cat = categories.find(c => c.category_key === hotspot.category);
                if (cat) hotspot.color = cat.color;
                
                renderHotspots();
                updateHotspotsList();
                alert('âœ… Hotspot updated!');
            }
        }
        
        function updateHotspotsList() {
            const list = document.getElementById('hotspotsList');
            if (hotspots.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500 italic">No hotspots yet. Draw on the map to add!</p>';
                return;
            }
            
            list.innerHTML = hotspots.map(h => {
                const cat = categories.find(c => c.category_key === h.category);
                const icon = cat ? cat.icon_emoji : 'ðŸ“';
                return \`<div class="p-3 border-2 rounded-lg hover:bg-gray-50 cursor-pointer transition \${selectedHotspot === h.id ? 'bg-green-50 border-green-500' : 'border-gray-200'}" onclick="selectHotspot(\${h.id})">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold">\${icon} \${h.title}</span>
                        <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-800">\${h.shape}</span>
                    </div>
                    \${h.buildingNumber ? '<div class="text-xs text-gray-600 mt-1">Building ' + h.buildingNumber + '</div>' : ''}
                </div>\`;
            }).join('');
        }
        
        function deleteSelected() {
            if (selectedHotspot) {
                if (confirm('Delete this hotspot?')) {
                    hotspots = hotspots.filter(h => h.id !== selectedHotspot);
                    selectedHotspot = null;
                    document.getElementById('hotspotDetails').classList.add('hidden');
                    renderHotspots();
                    updateHotspotsList();
                }
            } else {
                alert('Please select a hotspot first');
            }
        }
        
        async function saveAllHotspots() {
            if (hotspots.length === 0) {
                alert('âš ï¸ No hotspots to save');
                return;
            }
            
            try {
                // Delete all existing hotspots
                await fetch('/api/admin/hotel-map/hotspots/clear/1', { method: 'POST' });
                
                // Save all hotspots
                for (const hotspot of hotspots) {
                    await fetch('/api/admin/hotel-map/hotspots', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            property_id: 1,
                            position_x: hotspot.x,
                            position_y: hotspot.y,
                            width: hotspot.width,
                            height: hotspot.height,
                            shape: hotspot.shape,
                            hotspot_type: 'poi',
                            title: hotspot.title,
                            subtitle: hotspot.subtitle,
                            description: hotspot.description,
                            category: hotspot.category,
                            building_number: hotspot.buildingNumber,
                            link_url: hotspot.link,
                            color: hotspot.color
                        })
                    });
                }
                
                alert('âœ… All hotspots saved successfully!\\n\\n' + hotspots.length + ' hotspots saved to database.');
            } catch (error) {
                console.error('Save error:', error);
                alert('âŒ Failed to save hotspots');
            }
        }
        
        function clearAll() {
            if (confirm('Clear all hotspots? This cannot be undone.')) {
                hotspots = [];
                selectedHotspot = null;
                document.getElementById('hotspotDetails').classList.add('hidden');
                renderHotspots();
                updateHotspotsList();
            }
        }
        
        // Initialize
        loadCategories();
        loadExistingHotspots();
    </script>
</body>
</html>
  `)
})

// Guest Beach Booking Interface - Visual beach map for guests to book spots
app.get('/beach-booking/:property_id', async (c) => {
  const { property_id } = c.req.param()
  
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beach Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        #beachCanvas {
            border: 2px solid #cbd5e0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
        }
        .spot-icon {
            position: absolute;
            font-size: 28px;
            user-select: none;
            transition: all 0.2s;
            cursor: pointer;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        .spot-icon:hover {
            transform: scale(1.15);
        }
        .spot-icon.available {
            opacity: 1;
        }
        .spot-icon.booked {
            opacity: 0.3;
            filter: grayscale(100%);
            cursor: not-allowed;
        }
        .spot-icon.selected {
            transform: scale(1.3);
            filter: drop-shadow(0 0 12px rgba(59, 130, 246, 1));
        }
        .time-slot {
            transition: all 0.2s;
            cursor: pointer;
        }
        .time-slot:hover {
            transform: translateY(-2px);
        }
        .time-slot.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-yellow-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        <i class="fas fa-umbrella-beach mr-3 text-blue-500"></i>Beach Booking
                    </h1>
                    <p class="text-gray-600 mt-2">Select your perfect spot by the sea ðŸŒŠ</p>
                </div>
                <button onclick="window.history.back()" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl transition">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Beach Map -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-map-marked-alt mr-3 text-blue-600"></i>
                        Select Your Spot
                    </h2>
                    <div class="relative w-full bg-gradient-to-b from-blue-100 to-yellow-100 rounded-xl overflow-auto" style="height: 500px; max-height: 70vh;">
                        <div id="beachCanvas" class="relative" style="min-width: 100%; min-height: 500px; width: max-content; height: max-content;">
                            <!-- Spots will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="mt-4 flex flex-wrap gap-4 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">âœ…</span>
                            <span class="text-gray-600">Available</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl opacity-30 grayscale">ðŸ–ï¸</span>
                            <span class="text-gray-600">Booked</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">â­</span>
                            <span class="text-gray-600">Premium Location</span>
                        </div>
                    </div>
                    
                    <!-- Zone Legend - Dynamic -->
                    <div id="zoneLegend" class="mt-4 pt-4 border-t border-gray-200" style="display: none;">
                        <h4 class="font-semibold text-sm mb-3 text-gray-700">
                            <i class="fas fa-map-marker-alt mr-2 text-purple-600"></i>Beach Zones
                        </h4>
                        <div id="zoneLegendItems" class="grid grid-cols-2 gap-2 text-xs">
                            <!-- Zone legend items will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Booking Form -->
            <div>
                <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-calendar-check mr-3 text-green-600"></i>
                        Your Booking
                    </h2>

                    <!-- Date Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">
                            <i class="fas fa-calendar mr-2 text-blue-500"></i>Date
                        </label>
                        <input type="date" id="bookingDate" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>

                    <!-- Selected Spot Info -->
                    <div id="selectedSpotInfo" class="mb-4 p-4 bg-blue-50 rounded-xl hidden">
                        <h3 class="font-bold text-lg mb-2 flex items-center">
                            <span id="selectedSpotIcon" class="mr-2 text-2xl"></span>
                            <span id="selectedSpotNumber"></span>
                        </h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <p><i class="fas fa-users mr-2"></i>Capacity: <span id="selectedSpotCapacity" class="font-semibold"></span> guests</p>
                            <p><i class="fas fa-dollar-sign mr-2"></i>Price: <span id="selectedSpotPrice" class="font-semibold"></span></p>
                            <p id="premiumBadge" class="hidden"><i class="fas fa-star mr-2 text-yellow-500"></i><span class="font-semibold text-yellow-600">Premium Location</span></p>
                        </div>
                    </div>

                    <!-- Time Slot Selection -->
                    <div id="timeSlotSection" class="mb-4 hidden">
                        <label class="block text-sm font-semibold mb-3">
                            <i class="fas fa-clock mr-2 text-purple-500"></i>Duration
                        </label>
                        <div id="timeSlotsGrid" class="grid grid-cols-2 gap-2">
                            <!-- Time slots will be dynamically loaded -->
                        </div>
                    </div>

                    <!-- Guest Details -->
                    <div id="guestDetailsSection" class="mb-4 space-y-3 hidden">
                        <div>
                            <label class="block text-sm font-semibold mb-2">
                                <i class="fas fa-user mr-2 text-indigo-500"></i>Guest Name
                            </label>
                            <input type="text" id="guestName" placeholder="John Doe" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">
                                <i class="fas fa-door-open mr-2 text-pink-500"></i>Room Number
                            </label>
                            <input type="text" id="roomNumber" placeholder="101" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">
                                <i class="fas fa-users mr-2 text-green-500"></i>Number of Guests
                            </label>
                            <input type="number" id="numGuests" min="1" value="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">
                                <i class="fas fa-comment mr-2 text-orange-500"></i>Special Requests (Optional)
                            </label>
                            <textarea id="specialRequests" rows="2" placeholder="Extra towels, umbrella setup, etc." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>

                    <!-- Book Button -->
                    <button id="bookButton" onclick="completeBooking()" disabled class="w-full py-4 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-xl font-bold text-lg hover:from-green-700 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                        <i class="fas fa-check-circle mr-2"></i>Complete Booking
                    </button>
                    
                    <p class="text-xs text-gray-500 text-center mt-3">
                        <i class="fas fa-info-circle mr-1"></i>Free for hotel guests
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedSpot = null;
        let selectedTimeSlot = null;
        let spots = [];
        let bookings = [];
        let settings = {};
        let zones = [];
        const propertyId = ${property_id};
        
        const canvas = document.getElementById('beachCanvas');
        
        // Set today as minimum date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('bookingDate').min = today;
        document.getElementById('bookingDate').value = today;
        
        // Apply custom colors from settings
        async function loadAndApplySettings() {
            try {
                const response = await fetch('/api/admin/beach/settings/' + propertyId);
                const data = await response.json();
                
                if (data.success && data.settings) {
                    settings = data.settings;
                    
                    // Apply colors
                    const bgFrom = settings.bg_color_from || '#3b82f6';
                    const bgTo = settings.bg_color_to || '#06b6d4';
                    const textColor = settings.text_color || '#1f2937';
                    
                    // Apply to header gradient
                    const header = document.querySelector('.bg-gradient-to-r.from-blue-600.to-purple-600');
                    if (header) {
                        header.style.backgroundImage = 'linear-gradient(to right, ' + bgFrom + ', ' + bgTo + ')';
                    }
                    
                    // Load and render time slots
                    renderTimeSlots(settings.time_slots);
                }
            } catch (error) {
                console.error('Load settings error:', error);
            }
        }
        
        function renderTimeSlots(timeSlotsJson) {
            try {
                const timeSlots = timeSlotsJson ? JSON.parse(timeSlotsJson) : [
                    {id: 'half_day_am', name: 'Morning', start: '08:00', end: '13:00'},
                    {id: 'half_day_pm', name: 'Afternoon', start: '13:00', end: '18:00'},
                    {id: 'full_day', name: 'Full Day', start: '08:00', end: '18:00'}
                ];
                
                const grid = document.getElementById('timeSlotsGrid');
                if (!grid) return;
                
                const html = timeSlots.map(slot => {
                    const startTime = slot.start.split(':')[0];
                    const endTime = slot.end.split(':')[0];
                    const isFullDay = (parseInt(endTime) - parseInt(startTime)) >= 8;
                    
                    return '<button onclick="selectTimeSlot(\\'' + slot.id + '\\')" data-slot="' + slot.id + '" class="time-slot px-4 py-3 border-2 border-gray-200 rounded-xl hover:border-blue-400 font-medium ' + (isFullDay ? 'col-span-2' : '') + '">' +
                        '<div class="text-sm">' + slot.name + '</div>' +
                        '<div class="text-xs text-gray-600">' + formatTime(slot.start) + ' - ' + formatTime(slot.end) + '</div>' +
                    '</button>';
                }).join('');
                
                grid.innerHTML = html;
            } catch (error) {
                console.error('Render time slots error:', error);
            }
        }
        
        function formatTime(time) {
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const displayHour = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            return displayHour + ampm;
        }
        
        // Load beach spots and bookings
        async function loadBeachData() {
            try {
                // Load settings first
                await loadAndApplySettings();
                
                // Load spots
                const spotsResponse = await fetch('/api/admin/beach/spots/' + propertyId);
                const spotsData = await spotsResponse.json();
                
                if (spotsData.success && spotsData.spots) {
                    spots = spotsData.spots;
                }
                
                // Load zone overlays from database
                const zonesResponse = await fetch('/api/admin/beach/zone-overlays/' + propertyId);
                const zonesData = await zonesResponse.json();
                
                if (zonesData.overlays && zonesData.overlays.length > 0) {
                    zones = zonesData.overlays.map(overlay => {
                        const coords = JSON.parse(overlay.coordinates);
                        return {
                            id: overlay.overlay_id,
                            name: overlay.zone_name,
                            type: overlay.shape_type,
                            x: coords.x,
                            y: coords.y,
                            width: coords.width,
                            height: coords.height,
                            color: overlay.color,
                            opacity: overlay.opacity
                        };
                    });
                } else {
                    zones = []; // No zones defined yet
                }
                
                // Update zone legend
                updateZoneLegend();
                
                // Load bookings for selected date
                await loadBookingsForDate();
                renderSpots();
            } catch (error) {
                console.error('Load error:', error);
            }
        }
        
        async function loadBookingsForDate() {
            const date = document.getElementById('bookingDate').value;
            try {
                const response = await fetch('/api/beach/availability/' + propertyId + '/' + date);
                const data = await response.json();
                
                if (data.success) {
                    bookings = data.bookings || [];
                }
            } catch (error) {
                console.error('Load bookings error:', error);
            }
        }
        
        function getSpotIcon(type) {
            const icons = {
                umbrella: 'ðŸ”µ',
                cabana: 'ðŸŸ¢',
                lounger: 'ðŸŸ¡',
                daybed: 'ðŸŸ£'
            };
            return icons[type] || 'ðŸ”µ';
        }
        
        function isSpotAvailable(spotId, timeSlot) {
            if (!timeSlot) return true;
            
            return !bookings.some(booking => 
                booking.spot_id === spotId && 
                booking.slot_type === timeSlot &&
                booking.booking_status !== 'cancelled'
            );
        }
        
        function updateZoneLegend() {
            const legendContainer = document.getElementById('zoneLegend');
            const legendItems = document.getElementById('zoneLegendItems');
            
            if (zones.length === 0) {
                legendContainer.style.display = 'none';
                return;
            }
            
            legendContainer.style.display = 'block';
            legendItems.innerHTML = '';
            
            zones.forEach(zone => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-2';
                item.innerHTML = '<div class="w-4 h-4 rounded" style="background-color: ' + zone.color + '; opacity: 0.6;"></div>' +
                                 '<span class="text-gray-600">' + zone.name + '</span>';
                legendItems.appendChild(item);
            });
        }
        
        function renderZones() {
            document.querySelectorAll('.zone-overlay').forEach(el => el.remove());
            
            zones.forEach(zone => {
                const zoneEl = document.createElement('div');
                zoneEl.className = 'zone-overlay';
                zoneEl.style.position = 'absolute';
                zoneEl.style.left = zone.x + 'px';
                zoneEl.style.top = zone.y + 'px';
                zoneEl.style.width = zone.width + 'px';
                zoneEl.style.height = zone.height + 'px';
                zoneEl.style.backgroundColor = zone.color;
                zoneEl.style.opacity = zone.opacity;
                zoneEl.style.border = '2px solid ' + zone.color;
                zoneEl.style.pointerEvents = 'none';
                zoneEl.style.borderRadius = '12px';
                zoneEl.style.zIndex = '1';
                
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.top = '8px';
                label.style.left = '8px';
                label.style.backgroundColor = zone.color;
                label.style.color = 'white';
                label.style.padding = '6px 12px';
                label.style.borderRadius = '6px';
                label.style.fontSize = '14px';
                label.style.fontWeight = 'bold';
                label.style.opacity = '1';
                label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                label.textContent = zone.name;
                zoneEl.appendChild(label);
                
                canvas.appendChild(zoneEl);
            });
        }
        
        function renderSpots() {
            renderZones();
            
            // Remove existing spot elements
            document.querySelectorAll('.spot-icon').forEach(el => el.remove());
            
            spots.forEach(spot => {
                const spotEl = document.createElement('div');
                spotEl.className = 'spot-icon';
                
                // Check if spot is available for selected time slot
                const available = isSpotAvailable(spot.spot_id, selectedTimeSlot);
                spotEl.classList.add(available ? 'available' : 'booked');
                
                if (selectedSpot && selectedSpot.spot_id === spot.spot_id) {
                    spotEl.classList.add('selected');
                }
                
                spotEl.innerHTML = getSpotIcon(spot.spot_type) + (spot.is_premium ? 'â­' : '');
                spotEl.style.left = spot.position_x + 'px';
                spotEl.style.top = spot.position_y + 'px';
                spotEl.dataset.spotId = spot.spot_id;
                
                if (available) {
                    spotEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectSpot(spot);
                    });
                }
                
                canvas.appendChild(spotEl);
            });
        }
        
        function selectSpot(spot) {
            selectedSpot = spot;
            renderSpots();
            
            // Show spot info
            document.getElementById('selectedSpotIcon').textContent = getSpotIcon(spot.spot_type);
            document.getElementById('selectedSpotNumber').textContent = 'Spot ' + spot.spot_number;
            document.getElementById('selectedSpotCapacity').textContent = spot.max_capacity;
            document.getElementById('selectedSpotPrice').textContent = spot.price_full_day > 0 ? spot.price_full_day + ' USD' : 'FREE for guests';
            document.getElementById('premiumBadge').classList.toggle('hidden', !spot.is_premium);
            document.getElementById('selectedSpotInfo').classList.remove('hidden');
            document.getElementById('timeSlotSection').classList.remove('hidden');
            
            checkFormComplete();
        }
        
        function selectTimeSlot(slot) {
            selectedTimeSlot = slot;
            
            // Update UI
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            document.querySelector('[data-slot="' + slot + '"]').classList.add('selected');
            
            document.getElementById('guestDetailsSection').classList.remove('hidden');
            
            // Re-render spots to update availability
            renderSpots();
            checkFormComplete();
        }
        
        function checkFormComplete() {
            const hasSpot = selectedSpot !== null;
            const hasSlot = selectedTimeSlot !== null;
            const hasName = document.getElementById('guestName').value.trim() !== '';
            const hasRoom = document.getElementById('roomNumber').value.trim() !== '';
            
            document.getElementById('bookButton').disabled = !(hasSpot && hasSlot && hasName && hasRoom);
        }
        
        // Add input listeners
        document.getElementById('guestName').addEventListener('input', checkFormComplete);
        document.getElementById('roomNumber').addEventListener('input', checkFormComplete);
        document.getElementById('bookingDate').addEventListener('change', async () => {
            await loadBookingsForDate();
            renderSpots();
        });
        
        async function completeBooking() {
            if (!selectedSpot || !selectedTimeSlot) {
                alert('Please select a spot and time slot');
                return;
            }
            
            const bookingData = {
                property_id: propertyId,
                spot_id: selectedSpot.spot_id,
                booking_date: document.getElementById('bookingDate').value,
                slot_type: selectedTimeSlot,
                guest_name: document.getElementById('guestName').value,
                guest_room_number: document.getElementById('roomNumber').value,
                num_guests: parseInt(document.getElementById('numGuests').value),
                special_requests: document.getElementById('specialRequests').value
            };
            
            try {
                const response = await fetch('/api/beach/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… Booking Confirmed!\\n\\nBooking Reference: ' + data.booking.booking_reference + '\\n\\nPlease show your QR code at the beach entrance.');
                    
                    // Redirect to booking confirmation
                    window.location.href = '/beach-booking-confirmation/' + data.booking.booking_reference;
                } else {
                    alert('âŒ Booking failed: ' + (data.error || 'Please try again'));
                }
            } catch (error) {
                console.error('Booking error:', error);
                alert('âŒ Booking failed. Please try again.');
            }
        }
        
        // Initialize
        loadBeachData();
    </script>
</body>
</html>
  `)
})

// Beach Booking Confirmation Page with QR Code
app.get('/beach-booking-confirmation/:booking_reference', async (c) => {
  const { booking_reference } = c.req.param()
  
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Confirmed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 via-blue-50 to-purple-50 min-h-screen py-8">
    <div class="max-w-2xl mx-auto px-4">
        <!-- Success Animation -->
        <div class="text-center mb-8 animate-slide-in">
            <div class="inline-block p-6 bg-green-500 rounded-full shadow-2xl mb-4">
                <i class="fas fa-check-circle text-6xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Booking Confirmed!</h1>
            <p class="text-xl text-gray-600">Your beach spot is reserved ðŸ–ï¸</p>
        </div>

        <!-- Booking Details Card -->
        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6 animate-slide-in" style="animation-delay: 0.2s">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-info-circle mr-3 text-blue-600"></i>
                Booking Details
            </h2>

            <div id="bookingDetails" class="space-y-4">
                <!-- Booking Code - Prominently Displayed -->
                <div class="text-center p-6 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-2xl border-4 border-indigo-300">
                    <p class="text-sm text-gray-600 mb-2">Your Booking Code</p>
                    <p class="text-5xl font-black text-indigo-900 tracking-wider" id="bookingCode">------</p>
                    <p class="text-xs text-gray-600 mt-2">Show this code to staff at check-in</p>
                </div>
                
                <div class="flex items-start gap-4 p-4 bg-blue-50 rounded-xl">
                    <i class="fas fa-receipt text-blue-600 text-xl mt-1"></i>
                    <div>
                        <p class="text-sm text-gray-600">Booking Reference</p>
                        <p class="text-xl font-bold text-gray-800">${booking_reference}</p>
                    </div>
                </div>
                
                <div class="flex items-start gap-4 p-4 bg-purple-50 rounded-xl">
                    <i class="fas fa-umbrella-beach text-purple-600 text-xl mt-1"></i>
                    <div>
                        <p class="text-sm text-gray-600">Beach Spot</p>
                        <p class="text-lg font-semibold text-gray-800" id="spotInfo">Loading...</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-start gap-3 p-4 bg-green-50 rounded-xl">
                        <i class="fas fa-calendar text-green-600 text-lg mt-1"></i>
                        <div>
                            <p class="text-xs text-gray-600">Date</p>
                            <p class="font-semibold text-gray-800" id="bookingDateInfo">-</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start gap-3 p-4 bg-yellow-50 rounded-xl">
                        <i class="fas fa-clock text-yellow-600 text-lg mt-1"></i>
                        <div>
                            <p class="text-xs text-gray-600">Time Slot</p>
                            <p class="font-semibold text-gray-800" id="slotInfo">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-start gap-4 p-4 bg-pink-50 rounded-xl">
                    <i class="fas fa-user text-pink-600 text-xl mt-1"></i>
                    <div>
                        <p class="text-sm text-gray-600">Guest Name</p>
                        <p class="text-lg font-semibold text-gray-800" id="guestName">-</p>
                        <p class="text-sm text-gray-600 mt-1">Room: <span id="roomNumber" class="font-semibold">-</span></p>
                    </div>
                </div>
            </div>

            <!-- QR Code -->
            <div class="mt-8 p-6 bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl text-center">
                <h3 class="text-xl font-bold mb-4 flex items-center justify-center">
                    <i class="fas fa-qrcode mr-3 text-indigo-600"></i>
                    Your Access QR Code
                </h3>
                <div class="bg-white p-6 rounded-xl inline-block shadow-lg">
                    <div id="qrcode" class="flex justify-center"></div>
                </div>
                <p class="text-sm text-gray-600 mt-4">
                    <i class="fas fa-info-circle mr-2"></i>
                    Show this QR code at the beach entrance
                </p>
            </div>
        </div>

        <!-- Actions -->
        <div class="grid grid-cols-2 gap-4 no-print animate-slide-in" style="animation-delay: 0.4s">
            <button onclick="window.print()" class="px-6 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold transition shadow-lg">
                <i class="fas fa-print mr-2"></i>Print Confirmation
            </button>
            <button onclick="window.location.href='/hotel/' + propertySlug" class="px-6 py-4 bg-gray-600 hover:bg-gray-700 text-white rounded-xl font-semibold transition shadow-lg">
                <i class="fas fa-home mr-2"></i>Back to Hotel
            </button>
        </div>

        <!-- Important Info -->
        <div class="mt-6 p-6 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg no-print animate-slide-in" style="animation-delay: 0.6s">
            <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2 text-yellow-600"></i>
                Important Information
            </h4>
            <ul id="importantInfoList" class="space-y-2 text-sm text-gray-700">
                <!-- Will be populated dynamically -->
            </ul>
        </div>
    </div>

    <script>
        let propertySlug = 'paradise-resort';
        
        async function loadBookingDetails() {
            try {
                const response = await fetch('/api/beach/bookings/${booking_reference}');
                const data = await response.json();
                
                if (data.success && data.booking) {
                    const booking = data.booking;
                    
                    // Update UI
                    document.getElementById('bookingCode').textContent = booking.booking_code || 'N/A';
                    document.getElementById('spotInfo').textContent = getSpotIcon(booking.spot_type) + ' Spot ' + booking.spot_number;
                    document.getElementById('bookingDateInfo').textContent = new Date(booking.booking_date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    document.getElementById('slotInfo').textContent = formatSlotType(booking.slot_type);
                    document.getElementById('guestName').textContent = booking.guest_name;
                    document.getElementById('roomNumber').textContent = booking.guest_room_number || 'N/A';
                    
                    // Generate QR code with booking data
                    const qrData = booking.qr_code_data || JSON.stringify({
                        booking_reference: booking.booking_reference,
                        booking_code: booking.booking_code,
                        spot_number: booking.spot_number,
                        date: booking.booking_date,
                        guest: booking.guest_name
                    });
                    
                    new QRCode(document.getElementById('qrcode'), {
                        text: qrData,
                        width: 200,
                        height: 200,
                        colorDark: '#1e3a8a',
                        colorLight: '#ffffff'
                    });
                    
                    // Load important information
                    loadImportantInformation();
                } else {
                    alert('Failed to load booking details');
                }
            } catch (error) {
                console.error('Load error:', error);
                alert('Failed to load booking details');
            }
        }
        
        async function loadImportantInformation() {
            try {
                const response = await fetch('/api/admin/beach/settings/1');
                const data = await response.json();
                
                if (data.success && data.settings) {
                    const defaultInfo = 'Please arrive 10 minutes before your time slot\nBring your QR code (printed or on phone)\nBeach towels provided by hotel\nLate arrivals may result in reduced time';
                    const infoText = data.settings.important_information || defaultInfo;
                    const infoLines = infoText.split('\n').filter(line => line.trim());
                    
                    const listHtml = infoLines.map(line => 
                        '<li><i class="fas fa-check mr-2 text-green-600"></i>' + line + '</li>'
                    ).join('');
                    
                    document.getElementById('importantInfoList').innerHTML = listHtml;
                }
            } catch (error) {
                console.error('Load important information error:', error);
                // Show default info on error
                document.getElementById('importantInfoList').innerHTML = 
                    '<li><i class="fas fa-check mr-2 text-green-600"></i>Please arrive 10 minutes before your time slot</li>' +
                    '<li><i class="fas fa-check mr-2 text-green-600"></i>Bring your QR code (printed or on phone)</li>' +
                    '<li><i class="fas fa-check mr-2 text-green-600"></i>Beach towels provided by hotel</li>' +
                    '<li><i class="fas fa-check mr-2 text-green-600"></i>Late arrivals may result in reduced time</li>';
            }
        }
        
        function getSpotIcon(type) {
            const icons = {
                umbrella: 'ðŸ”µ',
                cabana: 'ðŸŸ¢',
                lounger: 'ðŸŸ¡',
                daybed: 'ðŸŸ£'
            };
            return icons[type] || 'ðŸ”µ';
        }
        
        function formatSlotType(slot) {
            const slots = {
                half_day_am: 'Morning (8AM - 1PM)',
                half_day_pm: 'Afternoon (1PM - 6PM)',
                full_day: 'Full Day (8AM - 6PM)'
            };
            return slots[slot] || slot;
        }
        
        // Initialize
        loadBookingDetails();
    </script>
</body>
</html>
  `)
})

app.get('/admin/login', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Login - Paradise Resort</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-900">
        <div class="min-h-screen flex items-center justify-center px-4">
            <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
                <div class="text-center mb-6">
                    <i class="fas fa-shield-alt text-4xl text-blue-600 mb-2"></i>
                    <h1 class="text-2xl font-bold">Admin Portal</h1>
                </div>
                <form id="adminLoginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" id="adminEmail" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" id="adminPassword" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
                        <i class="fas fa-lock mr-2"></i>Secure Login
                    </button>
                </form>
            </div>
        </div>
        <script>
          document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            try {
              const response = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
              });
              
              const data = await response.json();
              
              if (data.success) {
                localStorage.setItem('admin_user', JSON.stringify(data.user));
                localStorage.setItem('admin_token', data.token || data.user.user_id);
                window.location.href = '/admin/dashboard';
              } else {
                alert('Login failed: ' + (data.error || 'Invalid credentials'));
              }
            } catch (error) {
              console.error('Login error:', error);
              alert('Login failed. Please try again.');
            }
          });
        </script>
    </body>
    </html>
  `)
})

// Vendor Dashboard page
app.get('/vendor/dashboard', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 transition-colors duration-300">
    <style>
      /* Dark mode styles for vendor dashboard */
      .dark { color-scheme: dark; }
      .dark body { background-color: #1a202c !important; color: #e2e8f0 !important; }
      .dark .bg-white { background-color: #2d3748 !important; }
      .dark .bg-gray-50 { background-color: #1a202c !important; }
      .dark .bg-gray-100 { background-color: #2d3748 !important; }
      .dark .bg-gray-200 { background-color: #4a5568 !important; }
      .dark .text-gray-700 { color: #cbd5e0 !important; }
      .dark .text-gray-600 { color: #a0aec0 !important; }
      .dark .text-gray-800 { color: #e2e8f0 !important; }
      .dark .text-gray-900 { color: #f7fafc !important; }
      .dark .border { border-color: #4a5568 !important; }
      .dark .border-gray-200 { border-color: #4a5568 !important; }
      .dark .border-gray-300 { border-color: #4a5568 !important; }
      .dark input, .dark select, .dark textarea { background-color: #2d3748 !important; border-color: #4a5568 !important; color: #e2e8f0 !important; }
      .dark input::placeholder, .dark textarea::placeholder { color: #718096 !important; }
      .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2) !important; }
      .dark .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2) !important; }
      .dark .bg-gradient-to-r { opacity: 0.95; }
      * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
    </style>
    <div class="bg-gradient-to-r from-blue-600 to-green-600 text-white py-4 px-4 shadow-lg transition-colors duration-300">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div><h1 class="text-2xl font-bold">Vendor Portal</h1></div>
            <div class="flex items-center gap-3">
                <button onclick="toggleDarkMode()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors" title="Toggle Dark Mode">
                  <i id="darkModeIcon" class="fas fa-moon mr-2"></i><span id="darkModeText">Dark Mode</span>
                </button>
                <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-start">
                    <div><p class="text-gray-600 text-sm">Today's Bookings</p><p class="text-3xl font-bold" id="todayBookings">0</p></div>
                    <div class="bg-blue-100 p-3 rounded-lg"><i class="fas fa-calendar-day text-blue-600 text-xl"></i></div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-start">
                    <div><p class="text-gray-600 text-sm">Total Bookings</p><p class="text-3xl font-bold" id="totalBookings">0</p></div>
                    <div class="bg-green-100 p-3 rounded-lg"><i class="fas fa-list text-green-600 text-xl"></i></div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-start">
                    <div><p class="text-gray-600 text-sm">Pending Confirmations</p><p class="text-3xl font-bold" id="pendingBookings">0</p></div>
                    <div class="bg-yellow-100 p-3 rounded-lg"><i class="fas fa-clock text-yellow-600 text-xl"></i></div>
                </div>
            </div>
        </div>

        <!-- Connected Hotels/Properties -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-hotel mr-2 text-indigo-600"></i>Connected Hotels & Resorts</h2>
            <p class="text-gray-600 text-sm mb-4">You are currently connected to the following properties. Guests at these hotels can discover and book your activities.</p>
            <div id="propertiesList" class="space-y-3">
                <div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i></div>
            </div>
        </div>

        <!-- Bookings History -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-history mr-2 text-purple-600"></i>Booking History</h2>
            <div id="bookingsList" class="space-y-3"></div>
        </div>

        <!-- Callback Requests -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-phone-alt mr-2 text-orange-600"></i>Callback Requests</h2>
            <p class="text-gray-600 mb-4">Guests who requested callbacks for your activities</p>
            <div id="callbacksList" class="space-y-3"></div>
        </div>

        <!-- Vendor Profile -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-user-circle mr-2 text-indigo-600"></i>My Profile</h2>
            <form id="profileForm" class="space-y-4">
                <div class="flex items-center gap-6 mb-6">
                    <div class="relative">
                        <img id="profileImagePreview" src="https://via.placeholder.com/150" alt="Profile" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200">
                        <label for="profileImageInput" class="absolute bottom-0 right-0 bg-blue-600 text-white p-2 rounded-full cursor-pointer hover:bg-blue-700">
                            <i class="fas fa-camera"></i>
                            <input type="file" id="profileImageInput" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold" id="profileBusinessName">Business Name</h3>
                        <p class="text-gray-600" id="profileEmail">email@example.com</p>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium mb-2">Business Name</label><input type="text" id="businessNameInput" required class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium mb-2">Phone</label><input type="tel" id="phoneInput" required class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium mb-2">Website</label><input type="url" id="websiteInput" placeholder="https://" class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium mb-2">Years of Experience</label><input type="number" id="yearsExpInput" min="0" class="w-full px-4 py-2 border rounded-lg"></div>
                </div>
                
                <div><label class="block text-sm font-medium mb-2">Description</label><textarea id="descriptionInput" rows="4" placeholder="Tell guests about your business..." class="w-full px-4 py-2 border rounded-lg"></textarea></div>
                
                <div class="grid md:grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium mb-2">Address</label><input type="text" id="addressInput" class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium mb-2">City</label><input type="text" id="cityInput" class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium mb-2">Country</label><input type="text" id="countryInput" class="w-full px-4 py-2 border rounded-lg"></div>
                </div>
                
                <div><label class="block text-sm font-medium mb-2">Specialties (comma-separated)</label><input type="text" id="specialtiesInput" placeholder="Diving, Snorkeling, PADI Certified" class="w-full px-4 py-2 border rounded-lg"></div>
                
                <div><label class="block text-sm font-medium mb-2">Languages Spoken (comma-separated)</label><input type="text" id="languagesInput" placeholder="English, Arabic, French" class="w-full px-4 py-2 border rounded-lg"></div>
                
                <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-semibold"><i class="fas fa-save mr-2"></i>Update Profile</button>
            </form>
        </div>

        <!-- Add Activity Form -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-plus-circle mr-2 text-blue-600"></i>Add New Activity</h2>
            <form id="addActivityForm" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium mb-2">Activity Title</label><input type="text" id="title" required class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium mb-2">Category</label><select id="category" required class="w-full px-4 py-2 border rounded-lg"><option value="">Select category...</option></select></div>
                    <div><label class="block text-sm font-medium mb-2">Price (USD)</label><input type="number" id="price" required class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium mb-2">Duration (minutes)</label><input type="number" id="duration" required class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium mb-2">Capacity per Slot</label><input type="number" id="capacity" required class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium mb-2">Activity Image URL</label><input type="url" id="activityImageUrl" placeholder="https://images.unsplash.com/photo-example.jpg" class="w-full px-4 py-2 border rounded-lg"><p class="text-xs text-gray-500 mt-1">Provide a direct link to activity image (e.g., from Unsplash, Imgur)</p></div>
                    <div><label class="block text-sm font-medium mb-2">Video URL</label><input type="url" id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-2 border rounded-lg"><p class="text-xs text-gray-500 mt-1">YouTube or direct video link (optional)</p></div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium">Short Description</label>
                        <button type="button" onclick="proofreadText('shortDesc', 'vendor')" class="text-xs px-3 py-1 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover:from-purple-600 hover:to-blue-600 transition flex items-center gap-1">
                            <i class="fas fa-magic"></i> AI Proofread
                        </button>
                    </div>
                    <textarea id="shortDesc" rows="2" required class="w-full px-4 py-2 border rounded-lg"></textarea>
                    <p class="text-xs text-gray-500 mt-1">âœ¨ Use AI Proofread to improve grammar and clarity (10 free per day)</p>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium">Full Description</label>
                        <button type="button" onclick="proofreadText('fullDesc', 'vendor')" class="text-xs px-3 py-1 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover:from-purple-600 hover:to-blue-600 transition flex items-center gap-1">
                            <i class="fas fa-magic"></i> AI Proofread
                        </button>
                    </div>
                    <textarea id="fullDesc" rows="4" required class="w-full px-4 py-2 border rounded-lg"></textarea>
                    <p class="text-xs text-gray-500 mt-1">âœ¨ Use AI Proofread to improve grammar and clarity (10 free per day)</p>
                </div>
                
                <!-- Requirements Section -->
                <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-200">
                  <label class="block text-sm font-bold mb-3 text-gray-700">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>Requirements
                  </label>
                  <div id="requirementsList" class="space-y-2 mb-3"></div>
                  <div class="flex gap-2">
                    <input type="text" id="requirementInput" placeholder="e.g., Minimum age: 12 years" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                    <button type="button" onclick="addRequirement()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm">
                      <i class="fas fa-plus"></i> Add
                    </button>
                  </div>
                </div>

                <!-- What's Included Section -->
                <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200">
                  <label class="block text-sm font-bold mb-3 text-green-700">
                    <i class="fas fa-check-circle mr-2 text-green-600"></i>What's Included
                  </label>
                  <div id="includesList" class="space-y-2 mb-3"></div>
                  <div class="flex gap-2">
                    <input type="text" id="includeInput" placeholder="e.g., Professional guide, Equipment" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                    <button type="button" onclick="addInclude()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm">
                      <i class="fas fa-plus"></i> Add
                    </button>
                  </div>
                </div>

                <!-- What's NOT Included Section -->
                <div class="bg-red-50 p-4 rounded-lg border-2 border-red-200">
                  <label class="block text-sm font-bold mb-3 text-red-700">
                    <i class="fas fa-times-circle mr-2 text-red-600"></i>What's NOT Included
                  </label>
                  <div id="excludesList" class="space-y-2 mb-3"></div>
                  <div class="flex gap-2">
                    <input type="text" id="excludeInput" placeholder="e.g., Dive session, Personal expenses" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                    <button type="button" onclick="addExclude()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm">
                      <i class="fas fa-plus"></i> Add
                    </button>
                  </div>
                </div>

                <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold w-full"><i class="fas fa-save mr-2"></i><span id="submitBtnText">Create Activity</span></button>
            </form>
        </div>

        <!-- Activities List -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-list mr-2 text-green-600"></i>My Activities</h2>
            <div id="activitiesList" class="space-y-4"></div>
        </div>
    </div>

    <script>
      const vendorId = localStorage.getItem('vendor_id');
      if (!vendorId) { window.location.href = '/vendor/login'; }

      // Dark mode toggle
      function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.contains('dark');
        
        if (isDark) {
          html.classList.remove('dark');
          localStorage.setItem('vendorDarkMode', 'false');
          document.getElementById('darkModeIcon').className = 'fas fa-moon mr-2';
          document.getElementById('darkModeText').textContent = 'Dark Mode';
        } else {
          html.classList.add('dark');
          localStorage.setItem('vendorDarkMode', 'true');
          document.getElementById('darkModeIcon').className = 'fas fa-sun mr-2';
          document.getElementById('darkModeText').textContent = 'Light Mode';
        }
      }
      
      // Initialize dark mode from localStorage
      (function initDarkMode() {
        const darkMode = localStorage.getItem('vendorDarkMode');
        if (darkMode === 'true') {
          document.documentElement.classList.add('dark');
          document.getElementById('darkModeIcon').className = 'fas fa-sun mr-2';
          document.getElementById('darkModeText').textContent = 'Light Mode';
        }
      })();

      async function loadDashboard() {
        try {
          const [bookingsRes, activitiesRes, categoriesRes, profileRes, propertiesRes, callbacksRes] = await Promise.all([
            fetch('/api/vendor/bookings', { headers: { 'X-Vendor-ID': vendorId } }),
            fetch('/api/vendor/activities', { headers: { 'X-Vendor-ID': vendorId } }),
            fetch('/api/categories'),
            fetch('/api/vendor/profile', { headers: { 'X-Vendor-ID': vendorId } }),
            fetch('/api/vendor/properties', { headers: { 'X-Vendor-ID': vendorId } }),
            fetch('/api/vendor/callbacks', { headers: { 'X-Vendor-ID': vendorId } })
          ]);

          // Check if all responses are OK
          if (!bookingsRes.ok) {
            console.error('Bookings fetch failed:', bookingsRes.status, await bookingsRes.text());
          }
          if (!activitiesRes.ok) {
            console.error('Activities fetch failed:', activitiesRes.status, await activitiesRes.text());
          }
          if (!categoriesRes.ok) {
            console.error('Categories fetch failed:', categoriesRes.status, await categoriesRes.text());
          }
          if (!profileRes.ok) {
            console.error('Profile fetch failed:', profileRes.status, await profileRes.text());
          }
          if (!propertiesRes.ok) {
            console.error('Properties fetch failed:', propertiesRes.status, await propertiesRes.text());
          }

          const bookings = bookingsRes.ok ? await bookingsRes.json() : { bookings: [] };
          const activities = activitiesRes.ok ? await activitiesRes.json() : { activities: [] };
          const categories = categoriesRes.ok ? await categoriesRes.json() : { categories: [] };
          const profile = profileRes.ok ? await profileRes.json() : { profile: null };
          const properties = propertiesRes.ok ? await propertiesRes.json() : { properties: [] };

          console.log('Dashboard data loaded:', {
            bookings: bookings.bookings?.length || 0,
            activities: activities.activities?.length || 0,
            categories: categories.categories?.length || 0,
            properties: properties.properties?.length || 0,
            profile: profile.profile ? 'loaded' : 'missing'
          });

          const today = new Date().toISOString().split('T')[0];
          const bookingsList = bookings.bookings || [];
          const todayBookings = bookingsList.filter(b => b.activity_date === today);
          document.getElementById('todayBookings').textContent = todayBookings.length;
          document.getElementById('totalBookings').textContent = bookingsList.length;
          document.getElementById('pendingBookings').textContent = bookingsList.filter(b => b.status === 'pending').length;

          const categorySelect = document.getElementById('category');
          const categoriesList = categories.categories || [];
          console.log('Populating categories dropdown:', categoriesList);
          categoriesList.forEach(cat => {
            categorySelect.innerHTML += '<option value="' + cat.category_id + '">' + cat.name + '</option>';
          });
          console.log('Category dropdown HTML:', categorySelect.innerHTML);

          const callbacks = await callbacksRes.json();
          
          displayProperties(properties.properties || []);
          displayBookings(bookingsList);
          displayCallbacks(callbacks || []);
          displayActivities(activities.activities || []);
          console.log('Activities displayed:', activities.activities?.length || 0);
          displayProfile(profile.profile);
        } catch (error) {
          console.error('Dashboard load error:', error);
          alert('Failed to load dashboard. Please try refreshing the page.');
        }
      }

      // Arrays to store requirements, includes, excludes
      let requirementsArray = [];
      let includesArray = [];
      let excludesArray = [];
      let currentEditId = null;

      // Helper function to render a list item with remove button
      function renderListItem(text, index, type) {
        const colors = {
          requirement: { bg: 'bg-blue-100', text: 'text-blue-800', btn: 'text-red-600 hover:text-red-800' },
          include: { bg: 'bg-green-100', text: 'text-green-800', btn: 'text-red-600 hover:text-red-800' },
          exclude: { bg: 'bg-red-100', text: 'text-red-800', btn: 'text-gray-600 hover:text-gray-800' }
        };
        const color = colors[type];
        const escapedText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return '<div class="flex items-center justify-between ' + color.bg + ' px-3 py-2 rounded-lg">' +
          '<span class="' + color.text + ' text-sm">' + escapedText + '</span>' +
          '<button type="button" onclick="removeItem(' + index + ', &quot;' + type + '&quot;)" class="' + color.btn + '">' +
          '<i class="fas fa-times"></i>' +
          '</button>' +
          '</div>';
      }

      // Add requirement
      window.addRequirement = function() {
        const input = document.getElementById('requirementInput');
        const value = input.value.trim();
        if (value) {
          requirementsArray.push(value);
          input.value = '';
          updateRequirementsList();
        }
      }

      // Add include
      window.addInclude = function() {
        const input = document.getElementById('includeInput');
        const value = input.value.trim();
        if (value) {
          includesArray.push(value);
          input.value = '';
          updateIncludesList();
        }
      }

      // Add exclude
      window.addExclude = function() {
        const input = document.getElementById('excludeInput');
        const value = input.value.trim();
        if (value) {
          excludesArray.push(value);
          input.value = '';
          updateExcludesList();
        }
      }

      // Remove item from array
      window.removeItem = function(index, type) {
        if (type === 'requirement') {
          requirementsArray.splice(index, 1);
          updateRequirementsList();
        } else if (type === 'include') {
          includesArray.splice(index, 1);
          updateIncludesList();
        } else if (type === 'exclude') {
          excludesArray.splice(index, 1);
          updateExcludesList();
        }
      }

      // Update display lists
      function updateRequirementsList() {
        const container = document.getElementById('requirementsList');
        container.innerHTML = requirementsArray.map((item, i) => 
          renderListItem(item, i, 'requirement')
        ).join('');
      }

      function updateIncludesList() {
        const container = document.getElementById('includesList');
        container.innerHTML = includesArray.map((item, i) => 
          renderListItem(item, i, 'include')
        ).join('');
      }

      function updateExcludesList() {
        const container = document.getElementById('excludesList');
        container.innerHTML = excludesArray.map((item, i) => 
          renderListItem(item, i, 'exclude')
        ).join('');
      }

      // Clear all arrays (for resetting form)
      function clearAllArrays() {
        requirementsArray = [];
        includesArray = [];
        excludesArray = [];
        updateRequirementsList();
        updateIncludesList();
        updateExcludesList();
      }

      function displayProfile(profile) {
        if (!profile) {
          console.error('Profile data is missing');
          return;
        }
        
        document.getElementById('profileBusinessName').textContent = profile.business_name || 'N/A';
        document.getElementById('profileEmail').textContent = profile.email || 'N/A';
        document.getElementById('businessNameInput').value = profile.business_name || '';
        document.getElementById('phoneInput').value = profile.phone || '';
        document.getElementById('websiteInput').value = profile.website || '';
        document.getElementById('descriptionInput').value = profile.description || '';
        document.getElementById('addressInput').value = profile.address || '';
        document.getElementById('cityInput').value = profile.city || '';
        document.getElementById('countryInput').value = profile.country || '';
        document.getElementById('yearsExpInput').value = profile.years_experience || '';
        
        try {
          const specialties = profile.specialties ? JSON.parse(profile.specialties) : [];
          document.getElementById('specialtiesInput').value = specialties.join(', ');
        } catch (e) {
          console.error('Failed to parse specialties:', e);
          document.getElementById('specialtiesInput').value = '';
        }
        
        try {
          const languages = profile.languages_spoken ? JSON.parse(profile.languages_spoken) : [];
          document.getElementById('languagesInput').value = languages.join(', ');
        } catch (e) {
          console.error('Failed to parse languages:', e);
          document.getElementById('languagesInput').value = '';
        }
        
        if (profile.profile_image) {
          document.getElementById('profileImagePreview').src = profile.profile_image;
        }
      }

      function displayProperties(properties) {
        const list = document.getElementById('propertiesList');
        
        if (!properties || properties.length === 0) {
          list.innerHTML = '<div class="text-center py-8 text-gray-500">' +
            '<i class="fas fa-info-circle text-3xl mb-3"></i>' +
            '<p class="font-semibold">Not connected to any hotels yet</p>' +
            '<p class="text-sm mt-2">Contact hotel administration to get connected and start receiving bookings.</p>' +
            '</div>';
          return;
        }
        
        list.innerHTML = properties.map(prop => {
          const statusClass = prop.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
          const featuredBadge = prop.is_featured ? '<span class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full"><i class="fas fa-star mr-1"></i>Featured</span>' : '';
          const commissionRate = prop.custom_commission_rate || '15';
          
          return '<div class="border border-indigo-200 rounded-lg p-4 bg-indigo-50 hover:shadow-md transition">' +
            '<div class="flex justify-between items-start">' +
            '<div class="flex-1">' +
            '<h3 class="text-lg font-bold text-indigo-900">' + (prop.property_name || 'Unknown Property') + featuredBadge + '</h3>' +
            '<div class="mt-2 space-y-1 text-sm text-gray-700">' +
            '<p><i class="fas fa-map-marker-alt mr-2 text-indigo-600 w-4"></i>' + (prop.property_address || 'Address not available') + '</p>' +
            '<p><i class="fas fa-envelope mr-2 text-indigo-600 w-4"></i>' + (prop.property_email || 'N/A') + '</p>' +
            '<p><i class="fas fa-phone mr-2 text-indigo-600 w-4"></i>' + (prop.property_phone || 'N/A') + '</p>' +
            '<p><i class="fas fa-percentage mr-2 text-indigo-600 w-4"></i>Commission Rate: <strong>' + commissionRate + '%</strong></p>' +
            '<p><i class="fas fa-user-plus mr-2 text-indigo-600 w-4"></i>Joined via: <span class="capitalize">' + (prop.joined_via || 'admin') + '</span></p>' +
            '</div>' +
            '</div>' +
            '<div class="flex flex-col items-end gap-2">' +
            '<span class="px-3 py-1 rounded-full text-xs font-semibold ' + statusClass + '">' + (prop.status || 'pending') + '</span>' +
            '<a href="/hotel/' + (prop.property_slug || '') + '" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">' +
            '<i class="fas fa-external-link-alt mr-1"></i>View Hotel Page' +
            '</a>' +
            '</div>' +
            '</div>' +
            '</div>';
        }).join('');
      }

      function displayBookings(bookings) {
        const list = document.getElementById('bookingsList');
        if (bookings.length === 0) {
          list.innerHTML = '<p class="text-gray-500 text-center py-4">No bookings yet</p>';
          return;
        }
        
        list.innerHTML = bookings.slice(0, 10).map(b => {
          let statusClass = 'bg-gray-100 text-gray-800';
          if (b.booking_status === 'confirmed') statusClass = 'bg-green-100 text-green-800';
          else if (b.booking_status === 'pending') statusClass = 'bg-yellow-100 text-yellow-800';
          
          const title = (b.activity_title || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const firstName = (b.first_name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const lastName = (b.last_name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const email = (b.email || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          
          return '<div class="border rounded-lg p-4 hover:shadow-md transition">' +
            '<div class="flex justify-between items-start">' +
            '<div class="flex-1">' +
            '<h3 class="font-bold">' + title + '</h3>' +
            '<p class="text-sm text-gray-600">' + firstName + ' ' + lastName + ' â€¢ ' + email + '</p>' +
            '<div class="flex gap-4 mt-2 text-sm text-gray-600">' +
            '<span><i class="far fa-calendar mr-1"></i>' + (b.activity_date || '') + '</span>' +
            '<span><i class="far fa-clock mr-1"></i>' + (b.activity_time || '') + '</span>' +
            '<span><i class="far fa-user mr-1"></i>' + (b.num_participants || 0) + ' people</span>' +
            '</div>' +
            '</div>' +
            '<span class="px-3 py-1 rounded-full text-xs ' + statusClass + '">' + (b.booking_status || 'pending') + '</span>' +
            '</div>' +
            '</div>';
        }).join('');
      }

      function displayCallbacks(callbacks) {
        const list = document.getElementById('callbacksList');
        if (callbacks.length === 0) {
          list.innerHTML = '<p class="text-gray-500 text-center py-4">No callback requests yet</p>';
          return;
        }
        
        list.innerHTML = callbacks.map(cb => {
          let statusClass = 'bg-gray-100 text-gray-800';
          if (cb.status === 'contacted') statusClass = 'bg-blue-100 text-blue-800';
          else if (cb.status === 'completed') statusClass = 'bg-green-100 text-green-800';
          else if (cb.status === 'cancelled') statusClass = 'bg-red-100 text-red-800';
          else if (cb.status === 'pending') statusClass = 'bg-yellow-100 text-yellow-800';
          
          const firstName = (cb.first_name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const lastName = (cb.last_name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const phone = (cb.phone || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const email = (cb.email || 'N/A').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const activityTitle = (cb.activity_title || 'General Inquiry').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const message = (cb.message || 'No message').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const preferredTime = (cb.preferred_time || 'anytime').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          
          const statusButtons = cb.status === 'pending' 
            ? '<button onclick="updateCallbackStatus(' + cb.request_id + ', ' + String.fromCharCode(39) + 'contacted' + String.fromCharCode(39) + ')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Mark Contacted</button>' +
              '<button onclick="updateCallbackStatus(' + cb.request_id + ', ' + String.fromCharCode(39) + 'completed' + String.fromCharCode(39) + ')" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">Complete</button>'
            : cb.status === 'contacted'
            ? '<button onclick="updateCallbackStatus(' + cb.request_id + ', ' + String.fromCharCode(39) + 'completed' + String.fromCharCode(39) + ')" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">Complete</button>'
            : '';
          
          return '<div class="border rounded-lg p-4 hover:shadow-md transition">' +
            '<div class="flex justify-between items-start mb-3">' +
            '<div class="flex-1">' +
            '<h3 class="font-bold text-lg">' + firstName + ' ' + lastName + '</h3>' +
            '<p class="text-sm text-orange-600 font-semibold"><i class="fas fa-clipboard-list mr-1"></i>' + activityTitle + '</p>' +
            '</div>' +
            '<span class="px-3 py-1 rounded-full text-xs font-semibold ' + statusClass + '">' + (cb.status || 'pending') + '</span>' +
            '</div>' +
            '<div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600 mb-3">' +
            '<div><i class="fas fa-phone mr-1 text-blue-600"></i>' + phone + '</div>' +
            '<div><i class="fas fa-envelope mr-1 text-blue-600"></i>' + email + '</div>' +
            '<div><i class="fas fa-clock mr-1 text-purple-600"></i>Preferred: ' + preferredTime + '</div>' +
            '<div><i class="fas fa-calendar mr-1 text-gray-500"></i>' + new Date(cb.created_at).toLocaleString() + '</div>' +
            '</div>' +
            (cb.message ? '<div class="bg-gray-50 p-3 rounded text-sm mb-3"><i class="fas fa-comment mr-1 text-gray-600"></i>' + message + '</div>' : '') +
            '<div class="flex gap-2">' +
            statusButtons +
            '</div>' +
            '</div>';
        }).join('');
      }
      
      async function updateCallbackStatus(requestId, status) {
        try {
          const response = await fetch(String.fromCharCode(47) + 'api' + String.fromCharCode(47) + 'vendor' + String.fromCharCode(47) + 'callbacks' + String.fromCharCode(47) + requestId, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-Vendor-ID': vendorId
            },
            body: JSON.stringify({ status })
          });
          
          if (response.ok) {
            alert('Callback status updated!');
            loadDashboard();
          } else {
            alert('Failed to update callback status');
          }
        } catch (error) {
          console.error('Update callback error:', error);
          alert('Error updating callback status');
        }
      }

      function displayActivities(activities) {
        const list = document.getElementById('activitiesList');
        
        console.log('displayActivities called with:', activities ? activities.length : 'null', 'activities');
        
        if (!activities || activities.length === 0) {
          list.innerHTML = '<p class="text-gray-500 text-center py-8">No activities yet. Create your first activity above!</p>';
          return;
        }
        
        try {
          const html = activities.map(a => {
            const statusClass = a.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
            const titleEscaped = String(a.title_en || 'Untitled').replace(/"/g, '&quot;').replace(/'/g, '&#39;').split('\\n').join(' ');
            const descEscaped = String(a.short_description_en || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;').split('\\n').join(' ');
            
            return '<div class="border rounded-lg p-4 hover:shadow-md transition">' +
              '<div class="flex justify-between items-start">' +
              '<div class="flex-1">' +
              '<h3 class="text-xl font-bold">' + titleEscaped + '</h3>' +
              '<p class="text-gray-600 text-sm mt-1">' + descEscaped + '</p>' +
              '<div class="flex gap-4 mt-3 text-sm text-gray-600">' +
              '<span><i class="fas fa-tag mr-1"></i>' + (a.currency || 'USD') + ' ' + (a.price || 0) + '</span>' +
              '<span><i class="far fa-clock mr-1"></i>' + (a.duration_minutes || 0) + ' min</span>' +
              '<span><i class="far fa-user mr-1"></i>Max ' + (a.capacity_per_slot || 1) + '</span>' +
              '</div>' +
              '</div>' +
              '<div class="flex items-start gap-2">' +
              '<span class="px-3 py-1 rounded-full text-sm ' + statusClass + '">' + (a.status || 'draft') + '</span>' +
              '<button onclick="editActivity(' + a.activity_id + ')" class="text-blue-600 hover:text-blue-800 p-2" title="Edit">' +
              '<i class="fas fa-edit"></i>' +
              '</button>' +
              '<button onclick="deleteActivity(' + a.activity_id + ')" class="text-red-600 hover:text-red-800 p-2" title="Delete">' +
              '<i class="fas fa-trash"></i>' +
              '</button>' +
              '</div>' +
              '</div>' +
              '</div>';
          }).join('');
          
          list.innerHTML = html;
          console.log('Successfully rendered', activities.length, 'activities');
        } catch (error) {
          console.error('Error rendering activities:', error);
          list.innerHTML = '<p class="text-red-500 text-center py-8">Error displaying activities. Check console for details.</p>';
        }
      }

      // Profile form submission
      document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const specialties = document.getElementById('specialtiesInput').value.split(',').map(s => s.trim()).filter(s => s);
          const languages = document.getElementById('languagesInput').value.split(',').map(s => s.trim()).filter(s => s);
          
          const response = await fetch('/api/vendor/profile', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Vendor-ID': vendorId },
            body: JSON.stringify({
              business_name: document.getElementById('businessNameInput').value,
              phone: document.getElementById('phoneInput').value,
              website: document.getElementById('websiteInput').value,
              description: document.getElementById('descriptionInput').value,
              address: document.getElementById('addressInput').value,
              city: document.getElementById('cityInput').value,
              country: document.getElementById('countryInput').value,
              years_experience: parseInt(document.getElementById('yearsExpInput').value) || null,
              specialties,
              languages_spoken: languages,
              operating_hours: null,
              social_media: null
            })
          });

          const data = await response.json();
          if (data.success) {
            alert('Profile updated successfully!');
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Failed to update profile'));
          }
        } catch (error) {
          console.error('Profile update error:', error);
          alert('Failed to update profile');
        }
      });

      // Profile image upload
      document.getElementById('profileImageInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          const formData = new FormData();
          formData.append('image', file);
          
          const response = await fetch('/api/vendor/upload-profile-image', {
            method: 'POST',
            headers: { 'X-Vendor-ID': vendorId },
            body: formData
          });
          
          const data = await response.json();
          if (data.success) {
            document.getElementById('profileImagePreview').src = data.image_url;
            alert('Profile image updated!');
          }
        } catch (error) {
          console.error('Image upload error:', error);
          alert('Failed to upload image');
        }
      });

      document.getElementById('addActivityForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const editingId = form.dataset.editingId;
        const isEditing = !!editingId;
        
        try {
          // Get image URL from input
          const imageUrl = document.getElementById('activityImageUrl').value.trim();

          const activityData = {
            category_id: document.getElementById('category').value,
            title_en: document.getElementById('title').value,
            short_description_en: document.getElementById('shortDesc').value,
            full_description_en: document.getElementById('fullDesc').value,
            price: parseFloat(document.getElementById('price').value),
            duration_minutes: parseInt(document.getElementById('duration').value),
            capacity_per_slot: parseInt(document.getElementById('capacity').value),
            images: imageUrl ? [imageUrl] : [],
            video_url: document.getElementById('videoUrl').value || null,
            requirements: requirementsArray,
            includes: includesArray,
            excludes: excludesArray,
            status: 'active'
          };

          const url = isEditing ? '/api/vendor/activities/' + editingId : '/api/vendor/activities';
          const method = isEditing ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json', 'X-Vendor-ID': vendorId },
            body: JSON.stringify(activityData)
          });

          const data = await response.json();
          if (data.success) {
            alert(isEditing ? 'Activity updated successfully!' : 'Activity created successfully!');
            
            // Reset form
            form.reset();
            delete form.dataset.editingId;
            clearAllArrays();
            
            // Reset button and title
            const formTitle = form.parentElement.querySelector('h2');
            formTitle.innerHTML = '<i class="fas fa-plus-circle mr-2 text-blue-600"></i>Add New Activity';
            document.getElementById('submitBtnText').textContent = 'Create Activity';
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            // Reload dashboard
            loadDashboard();
          } else {
            alert('Error: ' + (data.error || 'Failed to save activity'));
          }
        } catch (error) {
          console.error('Save activity error:', error);
          alert('Failed to save activity');
        }
      });

      async function editActivity(activityId) {
        try {
          // Fetch activity details
          const response = await fetch('/api/vendor/activities', {
            headers: { 'X-Vendor-ID': vendorId }
          });
          const data = await response.json();
          const activity = data.activities.find(a => a.activity_id === activityId);
          
          if (!activity) {
            alert('Activity not found');
            return;
          }
          
          // Populate form with activity data
          document.getElementById('title').value = activity.title_en;
          document.getElementById('category').value = activity.category_id;
          document.getElementById('price').value = activity.price;
          document.getElementById('duration').value = activity.duration_minutes;
          document.getElementById('capacity').value = activity.capacity_per_slot;
          
          // Parse and set image URL
          let images = [];
          try {
            images = activity.images ? JSON.parse(activity.images) : [];
          } catch (e) {
            images = Array.isArray(activity.images) ? activity.images : [];
          }
          document.getElementById('activityImageUrl').value = images[0] || '';
          
          document.getElementById('videoUrl').value = activity.video_url || '';
          document.getElementById('shortDesc').value = activity.short_description_en;
          document.getElementById('fullDesc').value = activity.full_description_en;
          
          // Populate requirements, includes, excludes
          try {
            requirementsArray = activity.requirements ? JSON.parse(activity.requirements) : [];
            if (!Array.isArray(requirementsArray)) requirementsArray = [];
          } catch (e) {
            requirementsArray = [];
          }
          
          try {
            includesArray = activity.includes ? JSON.parse(activity.includes) : [];
            if (!Array.isArray(includesArray)) includesArray = [];
          } catch (e) {
            includesArray = [];
          }
          
          try {
            excludesArray = activity.excludes ? JSON.parse(activity.excludes) : [];
            if (!Array.isArray(excludesArray)) excludesArray = [];
          } catch (e) {
            excludesArray = [];
          }
          
          updateRequirementsList();
          updateIncludesList();
          updateExcludesList();
          
          // Change form title and button
          const formTitle = document.querySelector('#addActivityForm').parentElement.querySelector('h2');
          formTitle.innerHTML = '<i class="fas fa-edit mr-2 text-blue-600"></i>Edit Activity';
          
          // Change submit button
          const form = document.getElementById('addActivityForm');
          document.getElementById('submitBtnText').textContent = 'Update Activity';
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
          submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
          
          // Store activity ID for update
          form.dataset.editingId = activityId;
          
          // Scroll to form
          form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (error) {
          console.error('Edit activity error:', error);
          alert('Failed to load activity details');
        }
      }
      
      async function deleteActivity(activityId) {
        if (!confirm('Are you sure you want to delete this activity? This action cannot be undone.')) {
          return;
        }
        
        try {
          const response = await fetch('/api/vendor/activities/' + activityId, {
            method: 'DELETE',
            headers: { 'X-Vendor-ID': vendorId }
          });
          
          const data = await response.json();
          if (data.success) {
            alert('Activity deleted successfully!');
            loadDashboard();
          } else {
            alert('Failed to delete activity: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Delete activity error:', error);
          alert('Failed to delete activity');
        }
      }

      function logout() {
        localStorage.removeItem('vendor_id');
        localStorage.removeItem('vendor_token');
        window.location.href = '/vendor/login';
      }

      // AI Proofreading function
      async function proofreadText(textareaId, userType) {
        const textarea = document.getElementById(textareaId);
        const text = textarea.value.trim();
        
        if (!text) {
          alert('Please enter some text first!');
          return;
        }
        
        if (text.length > 5000) {
          alert('Text is too long! Maximum 5000 characters allowed.');
          return;
        }
        
        // Get user ID
        const userId = userType === 'vendor' ? 
          localStorage.getItem('vendor_id') : 
          localStorage.getItem('property_id');
        
        if (!userId) {
          alert('User session not found. Please log in again.');
          return;
        }
        
        // Show loading state
        const originalText = textarea.value;
        textarea.value = 'âœ¨ AI is proofreading your text...';
        textarea.disabled = true;
        
        try {
          const response = await fetch('/api/ai/proofread', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: originalText,
              user_id: userId,
              user_type: userType
            })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            // Show success
            textarea.value = data.proofread_text;
            textarea.disabled = false;
            
            // Show usage stats
            const usageMsg = \`âœ… Proofreading complete!\\n\\nðŸ“Š Your usage: \${data.usage.used}/\${data.usage.limit} today (\\n\${data.usage.remaining} remaining)\\nâš¡ Processed in \${data.processing_time_ms}ms\`;
            
            if (data.model_used === 'fallback') {
              alert(usageMsg + '\\n\\nâš ï¸ Note: AI service is currently unavailable. Basic formatting applied.');
            } else {
              alert(usageMsg);
            }
          } else {
            // Handle errors
            textarea.value = originalText;
            textarea.disabled = false;
            
            if (response.status === 429) {
              if (data.wait_seconds) {
                alert(\`â³ \${data.message}\\n\\nPlease wait \${data.wait_seconds} seconds before trying again.\`);
              } else {
                alert(\`ðŸš« \${data.message}\\n\\nYou've used \${data.used}/\${data.limit} requests today.\`);
              }
            } else {
              alert('âŒ Error: ' + (data.error || 'Failed to proofread text'));
            }
          }
        } catch (error) {
          textarea.value = originalText;
          textarea.disabled = false;
          alert('âŒ Network error. Please check your connection and try again.');
          console.error('Proofread error:', error);
        }
      }

      loadDashboard();
    </script>
</body>
</html>
  `)
})

// Browse Activities page
app.get('/browse', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Activities</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="bg-gradient-to-r from-blue-500 to-green-500 text-white py-4 px-4 shadow-lg sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <h1 class="text-2xl font-bold"><i class="fas fa-compass mr-2"></i>Browse Activities</h1>
            <span id="roomDisplay" class="text-sm bg-white/20 px-3 py-1 rounded-full"></span>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="grid md:grid-cols-3 gap-4">
                <select id="categoryFilter" class="px-4 py-2 border rounded-lg"><option value="">All Categories</option></select>
                <select id="sortFilter" class="px-4 py-2 border rounded-lg">
                    <option value="popular">Most Popular</option>
                    <option value="price_low">Price: Low to High</option>
                    <option value="price_high">Price: High to Low</option>
                </select>
                <input type="search" id="searchBox" placeholder="Search activities..." class="px-4 py-2 border rounded-lg">
            </div>
        </div>

        <!-- Activities Grid -->
        <div id="activitiesGrid" class="grid md:grid-cols-3 gap-6"></div>

        <div id="loadingSpinner" class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mx-auto"></div></div>
    </div>

    <script>
      let activities = [];
      let categories = [];
      const sessionToken = new URLSearchParams(window.location.search).get('token') || localStorage.getItem('session_token');
      const propertyId = new URLSearchParams(window.location.search).get('property') || '1';

      async function loadData() {
        try {
          const [activitiesRes, categoriesRes] = await Promise.all([
            fetch('/api/activities?property_id=' + propertyId + '&lang=en'),
            fetch('/api/categories?lang=en')
          ]);

          const activitiesData = await activitiesRes.json();
          const categoriesData = await categoriesRes.json();

          activities = activitiesData.activities;
          categories = categoriesData.categories;

          const categoryFilter = document.getElementById('categoryFilter');
          categories.forEach(cat => {
            categoryFilter.innerHTML += '<option value="' + cat.category_id + '">' + cat.name + '</option>';
          });

          displayActivities();
          document.getElementById('loadingSpinner').style.display = 'none';
        } catch (error) {
          console.error('Load error:', error);
          alert('Failed to load activities');
        }
      }

      function displayActivities() {
        const categoryFilter = document.getElementById('categoryFilter').value;
        const sortFilter = document.getElementById('sortFilter').value;
        const searchText = document.getElementById('searchBox').value.toLowerCase();

        let filtered = activities.filter(a => {
          if (categoryFilter && a.category_id != categoryFilter) return false;
          if (searchText && !a.title.toLowerCase().includes(searchText)) return false;
          return true;
        });

        if (sortFilter === 'price_low') filtered.sort((a, b) => a.price - b.price);
        else if (sortFilter === 'price_high') filtered.sort((a, b) => b.price - a.price);
        else filtered.sort((a, b) => (b.popularity_score || 0) - (a.popularity_score || 0));

        const grid = document.getElementById('activitiesGrid');
        if (filtered.length === 0) {
          grid.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-500"><i class="fas fa-search text-4xl mb-4"></i><p>No activities found</p></div>';
          return;
        }

        grid.innerHTML = filtered.map(a => \`
          <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition cursor-pointer" onclick="viewActivity(\${a.activity_id})">
            <div class="h-48 bg-gradient-to-br from-blue-400 to-green-400 flex items-center justify-center">
              <i class="fas fa-hiking text-white text-6xl opacity-75"></i>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-lg mb-2">\${a.title}</h3>
              <p class="text-gray-600 text-sm mb-3 line-clamp-2">\${a.short_description}</p>
              <div class="flex justify-between items-center mb-3">
                <span class="text-blue-600 font-bold text-xl">\${a.currency} \${a.price}</span>
                <span class="text-gray-600 text-sm"><i class="far fa-clock mr-1"></i>\${a.duration_minutes} min</span>
              </div>
              <div class="text-sm text-gray-600 mb-3">
                <i class="fas fa-store mr-1"></i>\${a.vendor_name}
              </div>
              <button class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                <i class="fas fa-calendar-check mr-2"></i>View Details & Book
              </button>
            </div>
          </div>
        \`).join('');
      }

      function viewActivity(id) {
        window.location.href = '/activity?id=' + id + '&token=' + sessionToken;
      }

      document.getElementById('categoryFilter').addEventListener('change', displayActivities);
      document.getElementById('sortFilter').addEventListener('change', displayActivities);
      document.getElementById('searchBox').addEventListener('input', displayActivities);

      loadData();
    </script>
</body>
</html>
  `)
})

// Vendor Profile page (public)
app.get('/vendor/:vendor_slug', async (c) => {
  const { DB } = c.env
  const { vendor_slug } = c.req.param()
  const property_id = c.req.query('property') || '1'
  
  try {
    const vendor = await DB.prepare(`
      SELECT v.* FROM vendors v
      JOIN vendor_properties vp ON v.vendor_id = vp.vendor_id
      WHERE v.slug = ? AND vp.property_id = ? AND v.status = 'active'
    `).bind(vendor_slug, property_id).first()
    
    if (!vendor) {
      return c.html('<html><body><h1>Vendor not found</h1></body></html>', 404)
    }
    
    return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${vendor.business_name} - Vendor Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="bg-gradient-to-r from-blue-500 to-green-500 text-white py-6 px-4">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <button onclick="history.back()" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30"><i class="fas fa-arrow-left mr-2"></i>Back</button>
            <h1 class="text-2xl font-bold">Vendor Profile</h1>
            <div class="w-20"></div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-blue-500 to-green-500 h-32"></div>
            <div class="px-6 pb-6">
                <div class="flex items-end gap-6 -mt-16 mb-6">
                    <img src="${vendor.profile_image || 'https://via.placeholder.com/150'}" alt="${vendor.business_name}" class="w-32 h-32 rounded-full border-4 border-white object-cover">
                    <div class="flex-1 pt-16">
                        <h2 class="text-3xl font-bold">${vendor.business_name}</h2>
                        <div class="flex gap-4 mt-2 text-gray-600">
                            ${vendor.city ? '<span><i class="fas fa-map-marker-alt mr-1"></i>' + vendor.city + (vendor.country ? ', ' + vendor.country : '') + '</span>' : ''}
                            ${vendor.years_experience ? '<span><i class="fas fa-award mr-1"></i>' + vendor.years_experience + ' years experience</span>' : ''}
                            ${vendor.safety_rating ? '<span><i class="fas fa-star mr-1 text-yellow-500"></i>' + vendor.safety_rating + '/5.0</span>' : ''}
                        </div>
                    </div>
                </div>

                ${vendor.description ? '<div class="mb-6"><h3 class="text-xl font-bold mb-3">About Us</h3><p class="text-gray-700">' + vendor.description + '</p></div>' : ''}

                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-xl font-bold mb-3">Contact Information</h3>
                        <div class="space-y-2 text-gray-700">
                            ${vendor.phone ? '<p><i class="fas fa-phone mr-2 text-blue-600"></i>' + vendor.phone + '</p>' : ''}
                            ${vendor.email ? '<p><i class="fas fa-envelope mr-2 text-blue-600"></i>' + vendor.email + '</p>' : ''}
                            ${vendor.website ? '<p><i class="fas fa-globe mr-2 text-blue-600"></i><a href="' + vendor.website + '" target="_blank" class="text-blue-600 hover:underline">' + vendor.website + '</a></p>' : ''}
                            ${vendor.address ? '<p><i class="fas fa-map-marker-alt mr-2 text-blue-600"></i>' + vendor.address + '</p>' : ''}
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-bold mb-3">Details</h3>
                        <div class="space-y-2 text-gray-700" id="vendorDetails">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-3">Our Activities</h3>
                    <div id="activitiesList" class="grid md:grid-cols-3 gap-4">
                        <p class="text-gray-500 col-span-3 text-center py-4">Loading activities...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
      const vendorSlug = '${vendor_slug}';
      const propertyId = '${property_id}';
      
      async function loadVendorData() {
        try {
          const response = await fetch(\`/api/vendors/\${vendorSlug}?property_id=\${propertyId}\`);
          const data = await response.json();
          
          // Display specialties
          const details = document.getElementById('vendorDetails');
          if (data.vendor.specialties && data.vendor.specialties.length > 0) {
            details.innerHTML += '<p><i class="fas fa-certificate mr-2 text-blue-600"></i><strong>Specialties:</strong> ' + data.vendor.specialties.join(', ') + '</p>';
          }
          
          if (data.vendor.languages_spoken && data.vendor.languages_spoken.length > 0) {
            details.innerHTML += '<p><i class="fas fa-language mr-2 text-blue-600"></i><strong>Languages:</strong> ' + data.vendor.languages_spoken.join(', ') + '</p>';
          }
          
          // Display activities
          const activitiesList = document.getElementById('activitiesList');
          if (data.activities.length === 0) {
            activitiesList.innerHTML = '<p class="text-gray-500 col-span-3 text-center py-4">No activities available</p>';
          } else {
            activitiesList.innerHTML = data.activities.map(a => \`
              <a href="/activity?id=\${a.activity_id}" class="block bg-white border rounded-lg p-4 hover:shadow-lg transition">
                <h4 class="font-bold mb-2">\${a.title}</h4>
                <p class="text-sm text-gray-600 mb-3 line-clamp-2">\${a.short_description}</p>
                <div class="flex justify-between items-center">
                  <span class="text-blue-600 font-bold">\${a.currency} \${a.price}</span>
                  <span class="text-sm text-gray-600">\${a.duration_minutes} min</span>
                </div>
              </a>
            \`).join('');
          }
        } catch (error) {
          console.error('Load vendor data error:', error);
        }
      }
      
      loadVendorData();
    </script>
</body>
</html>
    `)
  } catch (error) {
    console.error('Vendor profile page error:', error)
    return c.html('<html><body><h1>Error</h1><p>Failed to load vendor profile</p></body></html>', 500)
  }
})

// Activity Detail page
app.get('/activity', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <div id="content" class="hidden">
        <div class="bg-gradient-to-r from-blue-500 to-green-500 text-white py-4 px-4 sticky top-0 z-10 shadow-lg">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <button onclick="history.back()" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                <h1 class="text-xl font-bold" data-i18n="activity-details">Activity Details</h1>
                <select id="languageSelector" class="px-3 py-1.5 bg-white/20 text-white rounded-lg text-sm border border-white/30">
                    <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
                    <option value="ar">ðŸ‡¸ðŸ‡¦ AR</option>
                    <option value="de">ðŸ‡©ðŸ‡ª DE</option>
                    <option value="fr">ðŸ‡«ðŸ‡· FR</option>
                    <option value="it">ðŸ‡®ðŸ‡¹ IT</option>
                    <option value="ru">ðŸ‡·ðŸ‡º RU</option>
                    <option value="pl">ðŸ‡µðŸ‡± PL</option>
                    <option value="cs">ðŸ‡¨ðŸ‡¿ CS</option>
                    <option value="uk">ðŸ‡ºðŸ‡¦ UK</option>
                </select>
            </div>
        </div>

        <div class="max-w-4xl mx-auto px-4 py-8">
            <!-- Video Section (if available) -->
            <div id="videoSection" class="hidden mb-6">
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <video id="activityVideo" controls class="w-full" style="max-height: 500px;">
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 id="activityTitle" class="text-3xl font-bold mb-2"></h2>
                <div class="flex items-end gap-4 mb-4">
                    <div><span id="price" class="text-4xl font-bold text-blue-600"></span><span class="text-gray-600" data-i18n="per-person">/person</span></div>
                    <div class="flex gap-4 text-sm text-gray-600">
                        <span><i class="far fa-clock mr-1"></i><span id="duration"></span></span>
                        <span><i class="far fa-user mr-1"></i><span data-i18n="max">Max</span> <span id="capacity"></span></span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="startBooking()" class="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg text-lg font-semibold">
                        <i class="fas fa-calendar-check mr-2"></i><span data-i18n="book-now">Book Now</span>
                    </button>
                    <button onclick="showCallbackForm()" class="bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg text-lg font-semibold">
                        <i class="fas fa-phone mr-2"></i><span data-i18n="request-callback">Request Callback</span>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-3" data-i18n="about-activity">About This Activity</h3>
                <p id="description" class="text-gray-700"></p>
            </div>

            <!-- Requirements & Includes Section -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <!-- Requirements -->
                <div id="requirementsSection" class="hidden bg-blue-50 rounded-lg shadow p-5 border-2 border-blue-200">
                    <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>Requirements
                    </h4>
                    <ul id="requirementsList" class="space-y-2 text-sm text-blue-800"></ul>
                </div>

                <!-- What's Included -->
                <div id="includesSection" class="hidden bg-green-50 rounded-lg shadow p-5 border-2 border-green-200">
                    <h4 class="font-bold text-green-800 mb-3 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>Included
                    </h4>
                    <ul id="includesList" class="space-y-2 text-sm text-green-800"></ul>
                </div>

                <!-- What's NOT Included -->
                <div id="excludesSection" class="hidden bg-red-50 rounded-lg shadow p-5 border-2 border-red-200">
                    <h4 class="font-bold text-red-800 mb-3 flex items-center">
                        <i class="fas fa-times-circle mr-2"></i>Not Included
                    </h4>
                    <ul id="excludesList" class="space-y-2 text-sm text-red-800"></ul>
                </div>
            </div>

            <!-- Vendor Information Card -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-4"><i class="fas fa-user-tie mr-2 text-blue-500"></i>Activity Provider</h3>
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h4 id="vendorBusinessName" class="text-lg font-semibold text-gray-800 mb-2"></h4>
                        <div class="space-y-2 text-sm text-gray-600">
                            <p><i class="fas fa-phone mr-2 text-green-500"></i><span id="vendorPhone"></span></p>
                        </div>
                    </div>
                    <div>
                        <a id="vendorProfileLink" href="#" class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                            <i class="fas fa-user-circle mr-2"></i>View Profile
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Callback Request Modal -->
        <div id="callbackModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold">Request Callback</h2>
                    <button onclick="closeCallbackModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-2xl"></i></button>
                </div>
                <form id="callbackForm" class="space-y-4">
                    <div><input type="text" id="cbFirstName" placeholder="First Name" required class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><input type="text" id="cbLastName" placeholder="Last Name" required class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><input type="tel" id="cbPhone" placeholder="Phone Number" required class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><input type="email" id="cbEmail" placeholder="Email (optional)" class="w-full px-4 py-2 border rounded-lg"></div>
                    <div>
                        <select id="cbPreferredTime" class="w-full px-4 py-2 border rounded-lg">
                            <option value="anytime">Anytime</option>
                            <option value="morning">Morning (9AM-12PM)</option>
                            <option value="afternoon">Afternoon (12PM-5PM)</option>
                            <option value="evening">Evening (5PM-8PM)</option>
                        </select>
                    </div>
                    <div><textarea id="cbMessage" placeholder="Your message or questions (optional)" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea></div>
                    <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold">
                        <i class="fas fa-paper-plane mr-2"></i>Submit Request
                    </button>
                </form>
            </div>
        </div>

        <!-- Booking Modal -->
        <div id="bookingModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Book This Activity</h2>
                    <button onclick="closeBookingModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-2xl"></i></button>
                </div>
                
                <div id="step1" class="space-y-4">
                    <h3 class="text-lg font-semibold">Select Date & Time</h3>
                    <div><label class="block text-sm font-medium mb-2">Date</label><input type="date" id="bookingDate" class="w-full px-4 py-2 border rounded-lg"></div>
                    <div id="timeSlots" class="space-y-2"></div>
                    <button onclick="nextStep(2)" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold">Continue</button>
                </div>

                <div id="step2" class="hidden space-y-4">
                    <h3 class="text-lg font-semibold">Number of Participants</h3>
                    <div class="flex items-center gap-4">
                        <button onclick="changeParticipants(-1)" class="w-12 h-12 bg-gray-200 rounded-lg text-xl">-</button>
                        <span id="participantsCount" class="text-3xl font-bold">1</span>
                        <button onclick="changeParticipants(1)" class="w-12 h-12 bg-gray-200 rounded-lg text-xl">+</button>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm text-gray-700">Total: <span id="totalPrice" class="font-bold text-xl text-blue-600"></span></p></div>
                    <div class="flex gap-4">
                        <button onclick="nextStep(1)" class="flex-1 bg-gray-200 py-3 rounded-lg">Back</button>
                        <button onclick="nextStep(3)" class="flex-1 bg-blue-500 text-white py-3 rounded-lg">Continue</button>
                    </div>
                </div>

                <div id="step3" class="hidden space-y-4">
                    <h3 class="text-lg font-semibold">Your Information</h3>
                    <input type="text" id="firstName" placeholder="First Name" required class="w-full px-4 py-2 border rounded-lg">
                    <input type="text" id="lastName" placeholder="Last Name" required class="w-full px-4 py-2 border rounded-lg">
                    <input type="email" id="email" placeholder="Email" required class="w-full px-4 py-2 border rounded-lg">
                    <input type="tel" id="phone" placeholder="Phone" required class="w-full px-4 py-2 border rounded-lg">
                    <textarea id="notes" placeholder="Special requests (optional)" class="w-full px-4 py-2 border rounded-lg" rows="3"></textarea>
                    <div class="flex gap-4">
                        <button onclick="nextStep(2)" class="flex-1 bg-gray-200 py-3 rounded-lg">Back</button>
                        <button onclick="nextStep(4)" class="flex-1 bg-blue-500 text-white py-3 rounded-lg">Continue</button>
                    </div>
                </div>

                <div id="step4" class="hidden space-y-4">
                    <h3 class="text-lg font-semibold">Payment Method</h3>
                    <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:border-blue-500">
                        <input type="radio" name="payment" value="pay_at_vendor" checked class="mr-3">
                        <div class="flex-1"><p class="font-semibold">Pay at Venue</p><p class="text-sm text-gray-600">Pay when you arrive</p></div>
                        <i class="fas fa-money-bill-wave text-2xl text-green-500"></i>
                    </label>
                    <div class="flex gap-4">
                        <button onclick="nextStep(3)" class="flex-1 bg-gray-200 py-3 rounded-lg">Back</button>
                        <button onclick="confirmBooking()" class="flex-1 bg-green-500 text-white py-3 rounded-lg"><i class="fas fa-check mr-2"></i>Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
      let activity = null;
      let selectedDate = null;
      let selectedTime = null;
      let participants = 1;
      const activityId = new URLSearchParams(window.location.search).get('id');
      const sessionToken = new URLSearchParams(window.location.search).get('token') || localStorage.getItem('session_token');
      
      // Get language from URL or localStorage
      const urlParams = new URLSearchParams(window.location.search);
      let currentLanguage = urlParams.get('lang') || localStorage.getItem('language') || 'en';
      localStorage.setItem('language', currentLanguage);
      
      // Translation dictionary - ALL LANGUAGES
      const translations = {
        en: {
          'activity-details': 'Activity Details',
          'back': 'Back',
          'book-now': 'Book Now',
          'request-callback': 'Request Callback',
          'about-activity': 'About This Activity',
          'per-person': '/person',
          'max': 'Max',
          'min': 'min'
        },
        ar: {
          'activity-details': 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·',
          'back': 'Ø±Ø¬ÙˆØ¹',
          'book-now': 'Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†',
          'request-callback': 'Ø·Ù„Ø¨ Ù…Ø¹Ø§ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„',
          'about-activity': 'Ø­ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø´Ø§Ø·',
          'per-person': '/Ø´Ø®Øµ',
          'max': 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰',
          'min': 'Ø¯Ù‚ÙŠÙ‚Ø©'
        },
        de: {
          'activity-details': 'AktivitÃ¤tsdetails',
          'back': 'ZurÃ¼ck',
          'book-now': 'Jetzt buchen',
          'request-callback': 'RÃ¼ckruf anfordern',
          'about-activity': 'Ãœber diese AktivitÃ¤t',
          'per-person': '/Person',
          'max': 'Max',
          'min': 'Min'
        },
        fr: {
          'activity-details': 'DÃ©tails de l\\'activitÃ©',
          'back': 'Retour',
          'book-now': 'RÃ©server maintenant',
          'request-callback': 'Demander un rappel',
          'about-activity': 'Ã€ propos de cette activitÃ©',
          'per-person': '/personne',
          'max': 'Max',
          'min': 'min'
        },
        it: {
          'activity-details': 'Dettagli attivitÃ ',
          'back': 'Indietro',
          'book-now': 'Prenota ora',
          'request-callback': 'Richiedi richiamata',
          'about-activity': 'Informazioni su questa attivitÃ ',
          'per-person': '/persona',
          'max': 'Max',
          'min': 'min'
        },
        ru: {
          'activity-details': 'Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ',
          'back': 'ÐÐ°Ð·Ð°Ð´',
          'book-now': 'Ð—Ð°Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ',
          'request-callback': 'Ð—Ð°Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð·Ð²Ð¾Ð½Ð¾Ðº',
          'about-activity': 'ÐžÐ± ÑÑ‚Ð¾Ð¼ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ð¸',
          'per-person': '/Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº',
          'max': 'ÐœÐ°ÐºÑ',
          'min': 'Ð¼Ð¸Ð½'
        },
        pl: {
          'activity-details': 'SzczegÃ³Å‚y aktywnoÅ›ci',
          'back': 'Wstecz',
          'book-now': 'Zarezerwuj teraz',
          'request-callback': 'PoproÅ› o telefon zwrotny',
          'about-activity': 'O tej aktywnoÅ›ci',
          'per-person': '/osoba',
          'max': 'Maks',
          'min': 'min'
        },
        cs: {
          'activity-details': 'Detaily aktivity',
          'back': 'ZpÄ›t',
          'book-now': 'Rezervovat nynÃ­',
          'request-callback': 'PoÅ¾Ã¡dat o zpÄ›tnÃ© volÃ¡nÃ­',
          'about-activity': 'O tÃ©to aktivitÄ›',
          'per-person': '/osoba',
          'max': 'Max',
          'min': 'min'
        },
        uk: {
          'activity-details': 'Ð”ÐµÑ‚Ð°Ð»Ñ– Ð·Ð°Ñ…Ð¾Ð´Ñƒ',
          'back': 'ÐÐ°Ð·Ð°Ð´',
          'book-now': 'Ð—Ð°Ð±Ñ€Ð¾Ð½ÑŽÐ²Ð°Ñ‚Ð¸',
          'request-callback': 'Ð—Ð°Ð¼Ð¾Ð²Ð¸Ñ‚Ð¸ Ð´Ð·Ð²Ñ–Ð½Ð¾Ðº',
          'about-activity': 'ÐŸÑ€Ð¾ Ñ†ÐµÐ¹ Ð·Ð°Ñ…Ñ–Ð´',
          'per-person': '/Ð¾ÑÐ¾Ð±Ð°',
          'max': 'ÐœÐ°ÐºÑ',
          'min': 'Ñ…Ð²'
        }
      };
      
      function t(key) {
        return translations[currentLanguage]?.[key] || translations['en'][key] || key;
      }
      
      // AI Translation function for activity content
      async function translateText(text, targetLang) {
        if (targetLang === 'en' || !text) return text;
        
        try {
          const response = await fetch('/api/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: text,
              target_lang: targetLang,
              context: 'activity_description',
              persona: 'adventure_travel'
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            return data.translated_text || text;
          }
        } catch (error) {
          console.error('Translation error:', error);
        }
        
        return text; // Fallback to original
      }
      
      function updateLanguageSelector() {
        const selector = document.getElementById('languageSelector');
        if (selector) {
          selector.value = currentLanguage;
          selector.addEventListener('change', function() {
            currentLanguage = this.value;
            localStorage.setItem('language', currentLanguage);
            window.location.href = '/activity?id=' + activityId + '&lang=' + currentLanguage;
          });
        }
      }
      
      function updateUITranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          el.textContent = t(key);
        });
      }

      async function init() {
        if (!activityId) { alert('Activity not found'); return; }
        try {
          const response = await fetch('/api/activities/' + activityId + '?lang=' + currentLanguage);
          const data = await response.json();
          activity = data.activity;

          // Set basic info
          document.getElementById('price').textContent = activity.currency + ' ' + activity.price;
          document.getElementById('duration').textContent = activity.duration_minutes + ' min';
          document.getElementById('capacity').textContent = activity.capacity_per_slot;

          // Translate title and description if needed
          let title = activity.title;
          let description = activity.full_description;
          
          // If language is not EN/AR, use AI translation
          if (currentLanguage !== 'en' && currentLanguage !== 'ar') {
            // Show loading state
            document.getElementById('activityTitle').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';
            document.getElementById('description').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';
            
            // Translate both title and description
            title = await translateText(activity.title_en || activity.title, currentLanguage);
            description = await translateText(activity.full_description_en || activity.full_description, currentLanguage);
          }
          
          document.getElementById('activityTitle').textContent = title;
          document.getElementById('description').textContent = description;

          // Display requirements if available
          if (activity.requirements) {
            let requirements = [];
            try {
              requirements = typeof activity.requirements === 'string' ? JSON.parse(activity.requirements) : activity.requirements;
            } catch (e) {
              requirements = [];
            }
            
            if (Array.isArray(requirements) && requirements.length > 0) {
              document.getElementById('requirementsSection').classList.remove('hidden');
              document.getElementById('requirementsList').innerHTML = requirements.map(req => 
                '<li class="flex items-start"><i class="fas fa-chevron-right mr-2 mt-1 text-blue-600"></i><span>' + req + '</span></li>'
              ).join('');
            }
          }

          // Display includes if available
          if (activity.includes) {
            let includes = [];
            try {
              includes = typeof activity.includes === 'string' ? JSON.parse(activity.includes) : activity.includes;
            } catch (e) {
              includes = [];
            }
            
            if (Array.isArray(includes) && includes.length > 0) {
              document.getElementById('includesSection').classList.remove('hidden');
              document.getElementById('includesList').innerHTML = includes.map(inc => 
                '<li class="flex items-start"><i class="fas fa-check mr-2 mt-1 text-green-600"></i><span>' + inc + '</span></li>'
              ).join('');
            }
          }

          // Display excludes if available
          if (activity.excludes) {
            let excludes = [];
            try {
              excludes = typeof activity.excludes === 'string' ? JSON.parse(activity.excludes) : activity.excludes;
            } catch (e) {
              excludes = [];
            }
            
            if (Array.isArray(excludes) && excludes.length > 0) {
              document.getElementById('excludesSection').classList.remove('hidden');
              document.getElementById('excludesList').innerHTML = excludes.map(exc => 
                '<li class="flex items-start"><i class="fas fa-times mr-2 mt-1 text-red-600"></i><span>' + exc + '</span></li>'
              ).join('');
            }
          }

          // Display video if available
          if (activity.video_url) {
            document.getElementById('videoSection').classList.remove('hidden');
            
            // Check if it's a YouTube URL - use simpler detection to avoid regex escaping issues
            let videoId = null;
            const url = activity.video_url;
            
            // Extract YouTube video ID
            if (url.includes('youtube.com/watch')) {
              const urlParams = new URLSearchParams(url.split('?')[1]);
              videoId = urlParams.get('v');
            } else if (url.includes('youtu.be/')) {
              videoId = url.split('youtu.be/')[1].split(/[?&]/)[0];
            } else if (url.includes('youtube.com/embed/')) {
              videoId = url.split('youtube.com/embed/')[1].split(/[?&]/)[0];
            }
            
            const youtubeMatch = videoId ? [null, videoId] : null;
            
            if (youtubeMatch && youtubeMatch[1]) {
              // It's a YouTube video - use iframe embed
              const videoId = youtubeMatch[1];
              const videoContainer = document.getElementById('videoSection').querySelector('.bg-white');
              videoContainer.innerHTML = \`
                <iframe 
                  id="activityVideo"
                  width="100%" 
                  height="500" 
                  src="https://www.youtube.com/embed/\${videoId}" 
                  frameborder="0" 
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                  allowfullscreen
                  class="w-full rounded-lg"
                  style="max-height: 500px;">
                </iframe>
              \`;
            } else {
              // Direct video file (MP4, etc.)
              document.getElementById('activityVideo').querySelector('source').src = activity.video_url;
              document.getElementById('activityVideo').load();
            }
          }

          // Display vendor information
          document.getElementById('vendorBusinessName').textContent = activity.vendor_name;
          document.getElementById('vendorPhone').textContent = activity.vendor_phone || 'Not provided';
          
          // Set vendor profile link
          document.getElementById('vendorProfileLink').href = '/vendor/' + activity.vendor_slug;

          const today = new Date().toISOString().split('T')[0];
          document.getElementById('bookingDate').min = today;
          document.getElementById('bookingDate').value = today;

          // Update language selector and translations
          updateLanguageSelector();
          updateUITranslations();

          document.getElementById('loading').classList.add('hidden');
          document.getElementById('content').classList.remove('hidden');
        } catch (error) {
          console.error('Load error:', error);
          alert('Failed to load activity');
        }
      }

      function startBooking() {
        document.getElementById('bookingModal').classList.remove('hidden');
        loadTimeSlots();
      }

      function closeBookingModal() {
        document.getElementById('bookingModal').classList.add('hidden');
      }

      async function loadTimeSlots() {
        const date = document.getElementById('bookingDate').value;
        if (!date) return;
        try {
          const response = await fetch('/api/availability/' + activityId + '?date=' + date);
          const data = await response.json();
          const slotsHtml = data.slots.map(slot => '<button onclick="selectTime(\\'' + slot.time + '\\')" class="w-full p-3 border rounded-lg hover:border-blue-500"><div class="flex justify-between"><span>' + slot.time + '</span><span class="text-sm ' + (slot.available > 0 ? 'text-green-600' : 'text-red-600') + '">' + (slot.available > 0 ? slot.available + ' spots' : 'Full') + '</span></div></button>').join('');
          document.getElementById('timeSlots').innerHTML = slotsHtml;
        } catch (error) {
          console.error('Load slots error:', error);
        }
      }

      function selectTime(time) {
        selectedTime = time;
        document.querySelectorAll('#timeSlots button').forEach(btn => btn.classList.remove('border-blue-500', 'border-2'));
        event.target.closest('button').classList.add('border-blue-500', 'border-2');
      }

      function nextStep(step) {
        if (step === 2 && !selectedTime) { alert('Please select a time slot'); return; }
        document.querySelectorAll('[id^="step"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('step' + step).classList.remove('hidden');
        if (step === 2) updateTotalPrice();
      }

      function changeParticipants(delta) {
        participants = Math.max(1, Math.min(activity.capacity_per_slot, participants + delta));
        document.getElementById('participantsCount').textContent = participants;
        updateTotalPrice();
      }

      function updateTotalPrice() {
        const total = activity.price * participants;
        document.getElementById('totalPrice').textContent = activity.currency + ' ' + total;
      }

      async function confirmBooking() {
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        if (!firstName || !lastName || !email || !phone) { alert('Please fill all fields'); return; }

        try {
          const response = await fetch('/api/bookings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              session_token: sessionToken,
              activity_id: activityId,
              activity_date: document.getElementById('bookingDate').value,
              activity_time: selectedTime,
              num_participants: participants,
              payment_method: 'pay_at_vendor',
              guest_notes: document.getElementById('notes').value,
              guest_info: { first_name: firstName, last_name: lastName, email, phone }
            })
          });

          const data = await response.json();
          if (data.success) {
            alert('Booking confirmed! Reference: ' + data.booking_reference);
            window.location.href = '/browse?token=' + sessionToken;
          } else {
            alert('Booking failed: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Booking error:', error);
          alert('Failed to create booking');
        }
      }

      function showCallbackForm() {
        document.getElementById('callbackModal').classList.remove('hidden');
      }

      function closeCallbackModal() {
        document.getElementById('callbackModal').classList.add('hidden');
      }

      document.getElementById('callbackForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const response = await fetch('/api/callback-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: propertyId || 1,
              activity_id: activityId || null,
              vendor_id: activity ? activity.vendor_id : null,
              first_name: document.getElementById('cbFirstName').value,
              last_name: document.getElementById('cbLastName').value,
              phone: document.getElementById('cbPhone').value,
              email: document.getElementById('cbEmail').value || null,
              preferred_time: document.getElementById('cbPreferredTime').value,
              message: document.getElementById('cbMessage').value || null
            })
          });

          const data = await response.json();
          if (data.success) {
            alert('Callback request submitted! We will contact you soon.');
            closeCallbackModal();
            document.getElementById('callbackForm').reset();
          } else {
            alert('Error: ' + (data.error || 'Failed to submit request'));
          }
        } catch (error) {
          console.error('Callback request error:', error);
          alert('Failed to submit request');
        }
      });

      document.getElementById('bookingDate').addEventListener('change', loadTimeSlots);
      init();
    </script>
</body>
</html>
  `)
})

// SIMPLE TEST DASHBOARD
app.get('/admin/test', async (c) => {
  const { DB } = c.env
  const rooms = await DB.prepare(`SELECT * FROM rooms WHERE property_id = 1 ORDER BY room_number`).all()
  
  return c.html(`
<!DOCTYPE html>
<html>
<head>
    <title>Simple Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8">
    <h1 class="text-3xl font-bold mb-4">SIMPLE API TEST</h1>
    <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl mb-4">Rooms from Database:</h2>
        <div id="roomsList"></div>
    </div>
    <script>
        async function loadRooms() {
            const response = await fetch('/api/admin/rooms?property_id=1');
            const rooms = await response.json();
            const list = document.getElementById('roomsList');
            list.innerHTML = rooms.map(r => \`
                <div class="border p-4 mb-2">
                    <strong>Room \${r.room_number}</strong> (\${r.room_type})
                    <br>QR: \${r.qr_code_data}
                </div>
            \`).join('');
        }
        loadRooms();
    </script>
</body>
</html>
  `)
})

// Admin Dashboard page
app.get('/admin/dashboard', (c) => {
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      /* Sidebar Navigation Styles */
      .sidebar-btn {
        cursor: pointer;
        transition: all 0.2s;
        color: #4B5563;
      }
      .sidebar-btn:hover {
        background-color: #F3F4F6;
        color: #1F2937;
      }
      .sidebar-btn.tab-active {
        background-color: #3B82F6;
        color: white;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
      }
      .sidebar-btn.tab-active i {
        color: white;
      }
      
      /* Keep compatibility with old tab-btn class for JavaScript */
      .tab-btn {
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .hidden { display: none !important; }
      .tab-content { display: block; }
      
      /* Dark mode styles */
      .dark {
        color-scheme: dark;
      }
      
      .dark body {
        background-color: #1a202c !important;
        color: #e2e8f0 !important;
      }
      
      .dark .bg-white {
        background-color: #2d3748 !important;
      }
      
      .dark .bg-gray-50 {
        background-color: #1a202c !important;
      }
      
      .dark .bg-gray-100 {
        background-color: #2d3748 !important;
      }
      
      .dark .bg-gray-200 {
        background-color: #4a5568 !important;
      }
      
      .dark .text-gray-700 {
        color: #cbd5e0 !important;
      }
      
      .dark .text-gray-600 {
        color: #a0aec0 !important;
      }
      
      .dark .text-gray-800 {
        color: #e2e8f0 !important;
      }
      
      .dark .text-gray-900 {
        color: #f7fafc !important;
      }
      
      .dark .border {
        border-color: #4a5568 !important;
      }
      
      .dark .border-gray-200 {
        border-color: #4a5568 !important;
      }
      
      .dark .border-gray-300 {
        border-color: #4a5568 !important;
      }
      
      .dark input,
      .dark select,
      .dark textarea {
        background-color: #2d3748 !important;
        border-color: #4a5568 !important;
        color: #e2e8f0 !important;
      }
      
      .dark input::placeholder,
      .dark textarea::placeholder {
        color: #718096 !important;
      }
      
      .dark .shadow-lg {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2) !important;
      }
      
      .dark .shadow {
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2) !important;
      }
      
      /* Keep gradient backgrounds vibrant in dark mode */
      .dark .bg-gradient-to-r {
        opacity: 0.95;
      }
      
      /* Stats cards - keep their gradient colors */
      .dark .stats-card {
        opacity: 1 !important;
      }
      
      /* Tab button hover in dark mode */
      .dark .tab-btn:hover {
        background-color: rgba(59, 130, 246, 0.2) !important;
      }
      
      /* Date filter buttons in dark mode */
      .dark .date-filter-btn {
        background-color: #4a5568 !important;
        color: #e2e8f0 !important;
      }
      
      .dark .date-filter-btn.active {
        background-color: #3B82F6 !important;
        color: white !important;
      }
      
      * {
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      
      /* Mobile responsive */
      @media (max-width: 768px) {
        body { font-size: 14px; }
        
        /* Hide sidebar on mobile, show toggle button */
        #sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }
        #sidebar.mobile-open {
          transform: translateX(0);
        }
        
        /* Remove left margin on mobile */
        #sidebar + div {
          margin-left: 0 !important;
        }
        
        h1 { font-size: 1.25rem !important; }
        h2 { font-size: 1.125rem !important; }
        h3 { font-size: 1rem !important; }
        
        /* Make all form inputs stack on mobile */
        .grid {
          grid-template-columns: 1fr !important;
        }
        
        /* Stats cards mobile */
        .stats-card {
          padding: 1rem !important;
        }
        .stats-card .text-3xl {
          font-size: 1.5rem !important;
        }
        .stats-card i {
          font-size: 2rem !important;
        }
        
        /* Better mobile padding */
        .p-6 { padding: 1rem !important; }
        .py-8 { padding-top: 1rem !important; padding-bottom: 1rem !important; }
        .px-8 { padding-left: 1rem !important; padding-right: 1rem !important; }
        
        /* Mobile buttons */
        button, .btn {
          padding: 0.5rem 1rem !important;
          font-size: 0.875rem !important;
        }
        
        /* QR Code section mobile */
        #qrCodeDisplay {
          padding: 1rem !important;
          max-width: 200px;
          margin: 0 auto;
        }
        #qrCodeDisplay img {
          max-width: 100%;
          height: auto;
        }
        
        /* Tables scroll on mobile */
        table {
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }
        
        /* Form fields full width on mobile */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="url"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
          width: 100% !important;
        }
      }
      
      @media (min-width: 769px) {
        .mobile-menu-btn { display: none; }
      }
      
      /* Hide scrollbar but keep functionality */
      .overflow-x-auto::-webkit-scrollbar {
        height: 4px;
      }
      .overflow-x-auto::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .overflow-x-auto::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
    </style>
</head>
<body class="bg-gray-50 transition-colors duration-300">
    <!-- Professional Header with Logo -->
    <div class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <!-- Logo and Brand -->
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-semibold text-gray-800">Admin Dashboard</h1>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex items-center gap-2">
                <button onclick="openSupportModal()" class="p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Get Support">
                  <i class="fas fa-life-ring text-lg"></i>
                </button>
                <button onclick="openLiveChat()" class="p-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="Live Chat">
                  <i class="fas fa-comments text-lg"></i>
                </button>
                <button onclick="toggleDarkMode()" class="p-2 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" title="Toggle Dark Mode">
                  <i id="darkModeIcon" class="fas fa-moon text-lg"></i>
                </button>
                <div class="hidden md:block w-px h-8 bg-gray-300 mx-2"></div>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors font-medium text-sm">
                  <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Notification & Status Bar -->
    <div class="bg-gray-50 border-b border-gray-200 py-2 px-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 px-3 py-1 bg-green-100 rounded-full">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-xs font-medium text-green-700">Live</span>
                </div>
                <span class="text-xs text-gray-600">Real-time notifications enabled</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="autoRefreshToggle" onclick="toggleAutoRefresh()" class="px-3 py-1 text-xs font-medium text-green-700 hover:bg-green-50 rounded-lg transition">
                    <i class="fas fa-sync-alt mr-1"></i><span class="hidden md:inline">Auto-refresh: </span>ON
                </button>
                <button id="soundToggle" onclick="toggleSound()" class="px-3 py-1 text-xs font-medium text-blue-700 hover:bg-blue-50 rounded-lg transition">
                    <i class="fas fa-volume-up mr-1"></i><span class="hidden md:inline">Sound: </span>ON
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar + Content Layout -->
    <div class="flex min-h-screen bg-gray-50">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="w-64 bg-white shadow-xl fixed left-0 top-16 bottom-0 overflow-y-auto transition-all duration-300 z-40">
            <!-- GuestConnect Logo at Top -->
            <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-br from-blue-50 to-indigo-50">
                <div class="flex flex-col items-center">
                    <img src="https://www.genspark.ai/api/files/s/Az5K2rEF" alt="GuestConnect" class="w-32 h-auto mb-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="display:none;" class="flex-col items-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center shadow-md mb-2">
                            <i class="fas fa-concierge-bell text-white text-3xl"></i>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-gray-900">GuestConnect</div>
                            <div class="text-xs text-gray-500">Property System</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <nav class="py-4">
                <!-- Core Section -->
                <div class="px-3 mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider px-3 mb-2">Core</h3>
                    <button data-tab="qrcode" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3 tab-active">
                        <i class="fas fa-qrcode w-5"></i><span>QR Code</span>
                    </button>
                    <button data-tab="analytics" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-chart-line w-5"></i><span>Analytics</span>
                    </button>
                    <button data-tab="settings" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-cog w-5"></i><span>Settings</span>
                    </button>
                    <button data-tab="feedback" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-comments w-5"></i><span>Feedback</span>
                    </button>
                </div>
                
                <!-- Content Section -->
                <div class="px-3 mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider px-3 mb-2">Content</h3>
                    <button data-tab="offerings" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-utensils w-5"></i><span>Offerings</span>
                    </button>
                    <button data-tab="customsections" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-layer-group w-5"></i><span>Sections</span>
                    </button>
                    <button data-tab="infopages" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-file-alt w-5"></i><span>Info Pages</span>
                    </button>
                    <button data-tab="activities" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-hiking w-5"></i><span>Activities</span>
                    </button>
                </div>
                
                <!-- Services Section -->
                <div class="px-3 mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider px-3 mb-2">Services</h3>
                    <button data-tab="restaurants" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-utensils w-5"></i><span>Restaurants</span>
                    </button>
                    <button data-tab="vendors" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-store w-5"></i><span>Vendors</span>
                    </button>
                    <button data-tab="beach" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-umbrella-beach w-5"></i><span>Beach</span>
                    </button>
                    <button data-tab="callbacks" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-phone w-5"></i><span>Callbacks</span>
                    </button>
                </div>
                
                <!-- AI & Advanced Section -->
                <div class="px-3 mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider px-3 mb-2">AI & Advanced</h3>
                    <button data-tab="chatbot" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-robot w-5"></i><span>AI Chatbot</span>
                    </button>
                    <button data-tab="regcode" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-key w-5"></i><span>Code</span>
                    </button>
                </div>
                
                <!-- Help & Documentation Section -->
                <div class="px-3 mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider px-3 mb-2">Help & Support</h3>
                    <button data-tab="documentation" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-book w-5"></i><span>Documentation</span>
                    </button>
                    <button data-tab="tutorials" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-graduation-cap w-5"></i><span>Tutorials</span>
                    </button>
                    <button data-tab="faq" class="sidebar-btn w-full text-left px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-3">
                        <i class="fas fa-question-circle w-5"></i><span>FAQ</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 ml-64 px-4 py-8">

        <!-- Master QR Code Tab -->
        <div id="qrcodeTab" class="tab-content">
            <!-- QR Code Card Designer -->
            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-4 md:mb-6">
                <h2 class="text-xl md:text-2xl font-bold mb-3 md:mb-4">
                    <i class="fas fa-palette mr-2 text-purple-600"></i>QR Code Card Designer
                </h2>
                <p class="text-sm md:text-base text-gray-600 mb-4 md:mb-6">Create a beautiful, print-ready QR code card for your hotel with custom text, colors, and festive decorations.</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left: Designer Controls -->
                    <div class="space-y-4">
                        <!-- Card Text -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-bold text-lg mb-3 text-blue-900"><i class="fas fa-text mr-2"></i>Card Text</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Main Title</label>
                                    <input type="text" id="cardTitle" class="w-full p-2 border rounded" placeholder="Scan for Hotel Services" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Subtitle</label>
                                    <input type="text" id="cardSubtitle" class="w-full p-2 border rounded" placeholder="Access all amenities and services" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Bottom Message (optional)</label>
                                    <input type="text" id="cardMessage" class="w-full p-2 border rounded" placeholder="e.g., Scan here for info, Welcome!" />
                                </div>
                            </div>
                        </div>

                        <!-- Styling Options -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="font-bold text-lg mb-3 text-green-900"><i class="fas fa-paint-brush mr-2"></i>Colors & Style</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Background</label>
                                    <input type="color" id="bgColor" class="w-full h-10 border rounded cursor-pointer" value="#ffffff" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Text Color</label>
                                    <input type="color" id="qrTextColor" class="w-full h-10 border rounded cursor-pointer" value="#000000" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">QR Size</label>
                                    <select id="qrSize" class="w-full p-2 border rounded">
                                        <option value="250">Small (250px)</option>
                                        <option value="300" selected>Medium (300px)</option>
                                        <option value="400">Large (400px)</option>
                                        <option value="500">Extra Large (500px)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Border Radius</label>
                                    <input type="range" id="borderRadius" min="0" max="30" value="10" class="w-full" />
                                    <span id="borderRadiusValue" class="text-xs text-gray-600">10px</span>
                                </div>
                            </div>
                        </div>

                        <!-- Festive Overlays -->
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h3 class="font-bold text-lg mb-3 text-orange-900"><i class="fas fa-gift mr-2"></i>Festive Decorations</h3>
                            <p class="text-xs text-gray-600 mb-3">Add seasonal overlays to your QR code</p>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setFestiveOverlay(null, event)" class="festive-btn border-2 border-gray-300 bg-white p-3 rounded-lg hover:border-blue-500 transition">
                                    <div class="text-2xl mb-1">âŒ</div>
                                    <div class="text-xs">None</div>
                                </button>
                                <button onclick="setFestiveOverlay('christmas', event)" class="festive-btn border-2 border-gray-300 bg-white p-3 rounded-lg hover:border-red-500 transition">
                                    <div class="text-2xl mb-1">ðŸŽ…</div>
                                    <div class="text-xs">Christmas</div>
                                </button>
                                <button onclick="setFestiveOverlay('newyear', event)" class="festive-btn border-2 border-gray-300 bg-white p-3 rounded-lg hover:border-yellow-500 transition">
                                    <div class="text-2xl mb-1">ðŸŽŠ</div>
                                    <div class="text-xs">New Year</div>
                                </button>
                                <button onclick="setFestiveOverlay('easter', event)" class="festive-btn border-2 border-gray-300 bg-white p-3 rounded-lg hover:border-pink-500 transition">
                                    <div class="text-2xl mb-1">ðŸ°</div>
                                    <div class="text-xs">Easter</div>
                                </button>
                                <button onclick="setFestiveOverlay('ramadan', event)" class="festive-btn border-2 border-gray-300 bg-white p-3 rounded-lg hover:border-purple-500 transition">
                                    <div class="text-2xl mb-1">ðŸŒ™</div>
                                    <div class="text-xs">Ramadan</div>
                                </button>
                                <button onclick="setFestiveOverlay('eid', event)" class="festive-btn border-2 border-gray-300 bg-white p-3 rounded-lg hover:border-green-500 transition">
                                    <div class="text-2xl mb-1">ðŸ•Œ</div>
                                    <div class="text-xs">Eid</div>
                                </button>
                                <button onclick="setFestiveOverlay('halloween', event)" class="festive-btn border-2 border-gray-300 bg-white p-3 rounded-lg hover:border-orange-500 transition">
                                    <div class="text-2xl mb-1">ðŸŽƒ</div>
                                    <div class="text-xs">Halloween</div>
                                </button>
                                <button onclick="setFestiveOverlay('valentine', event)" class="festive-btn border-2 border-gray-300 bg-white p-3 rounded-lg hover:border-red-500 transition">
                                    <div class="text-2xl mb-1">ðŸ’</div>
                                    <div class="text-xs">Valentine</div>
                                </button>
                            </div>
                            <div id="currentOverlay" class="mt-3 text-sm font-semibold text-orange-800">Current: None</div>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-2">
                            <button onclick="saveQRCard()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold">
                                <i class="fas fa-save mr-2"></i>Save Design
                            </button>
                            <button onclick="resetQRCard()" class="bg-gray-400 text-white px-6 py-3 rounded-lg hover:bg-gray-500">
                                <i class="fas fa-undo mr-2"></i>Reset
                            </button>
                        </div>
                    </div>

                    <!-- Right: Live Preview -->
                    <div class="space-y-4">
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-xl border-2 border-indigo-200">
                            <h3 class="text-lg font-bold mb-4 text-center text-indigo-900">
                                <i class="fas fa-eye mr-2"></i>Live Preview
                            </h3>
                            
                            <!-- QR Card Preview -->
                            <div id="qrCardPreview" class="mx-auto" style="max-width: 500px;">
                                <div id="qrCard" class="relative" style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;">
                                    <!-- Title -->
                                    <div id="previewTitle" class="text-2xl font-bold mb-2" style="color: #000;">Scan for Hotel Services</div>
                                    
                                    <!-- Subtitle -->
                                    <div id="previewSubtitle" class="text-base mb-4 opacity-80" style="color: #000;">Access all amenities and services</div>
                                    
                                    <!-- QR Code Container with Festive Overlay -->
                                    <div class="relative inline-block mb-4">
                                        <div id="qrCodePreview" class="bg-white p-4 rounded-lg inline-block" style="position: relative;">
                                            <img id="qrImage" alt="QR Code" style="display: block; width: 300px; height: 300px;" />
                                        </div>
                                        <!-- Festive Overlay (positioned over QR) -->
                                        <div id="festiveOverlayDiv" style="position: absolute; top: -20px; right: -20px; font-size: 80px; display: none;">ðŸŽ…</div>
                                    </div>
                                    
                                    <!-- Bottom Message -->
                                    <div id="previewMessage" class="text-sm font-semibold opacity-70" style="color: #000; min-height: 20px;"></div>
                                    
                                    <!-- Hotel Name -->
                                    <div id="previewHotelName" class="text-xs mt-3 opacity-60" style="color: #000;">Loading...</div>
                                </div>
                            </div>

                            <!-- Print Actions -->
                            <div class="mt-6 flex flex-col sm:flex-row gap-2">
                                <button onclick="downloadQRCard()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-bold">
                                    <i class="fas fa-download mr-2"></i>Download Card
                                </button>
                                <button onclick="printQRCard()" class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-bold">
                                    <i class="fas fa-print mr-2"></i>Print Card
                                </button>
                            </div>
                        </div>

                        <!-- Quick Tips -->
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                            <h4 class="font-bold text-yellow-900 mb-2"><i class="fas fa-lightbulb mr-2"></i>Print Tips</h4>
                            <ul class="text-xs text-yellow-800 space-y-1">
                                <li>â€¢ Use high-quality paper (cardstock recommended)</li>
                                <li>â€¢ Print at 300 DPI or higher for best results</li>
                                <li>â€¢ Test scan QR code before mass printing</li>
                                <li>â€¢ Laminate cards for durability</li>
                                <li>â€¢ Place in room tents, key card holders, or wall frames</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QR Code Details Section (Collapsible) -->
            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                <details class="group">
                    <summary class="cursor-pointer text-lg font-bold text-gray-700 hover:text-blue-600 transition">
                        <i class="fas fa-info-circle mr-2"></i>QR Code Details & Technical Info
                        <i class="fas fa-chevron-down ml-2 group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="mt-4 space-y-3">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600 mb-1">Hotel Landing Page URL:</p>
                            <p id="hotelURL" class="font-mono text-sm text-blue-600 break-all">Loading...</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600 mb-1">Property Name:</p>
                            <p id="propertyName" class="font-semibold">Loading...</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600 mb-1">Property Slug:</p>
                            <p id="propertySlug" class="font-mono text-sm">Loading...</p>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content hidden">
            <!-- Beach Analytics Quick Link -->
            <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg shadow-xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold text-white mb-2 flex items-center">
                            <i class="fas fa-umbrella-beach mr-3"></i>
                            Beach Analytics Dashboard
                        </h3>
                        <p class="text-blue-100 mb-4">
                            Comprehensive beach analytics with live occupancy tracking, revenue insights, peak hours heatmap, AI-powered recommendations, and no-show monitoring.
                        </p>
                        <div class="flex flex-wrap gap-3">
                            <span class="text-sm bg-white/20 text-white px-3 py-1 rounded-full">
                                <i class="fas fa-signal mr-1"></i>Live Occupancy
                            </span>
                            <span class="text-sm bg-white/20 text-white px-3 py-1 rounded-full">
                                <i class="fas fa-brain mr-1"></i>AI Insights
                            </span>
                            <span class="text-sm bg-white/20 text-white px-3 py-1 rounded-full">
                                <i class="fas fa-fire mr-1"></i>Peak Hours
                            </span>
                            <span class="text-sm bg-white/20 text-white px-3 py-1 rounded-full">
                                <i class="fas fa-dollar-sign mr-1"></i>Revenue Analytics
                            </span>
                        </div>
                    </div>
                    <a href="/admin/beach-analytics" class="bg-white hover:bg-gray-100 text-blue-600 px-6 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-chart-bar"></i>
                        Open Dashboard
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-4 md:mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold mb-3 md:mb-0"><i class="fas fa-chart-line mr-2 text-green-600"></i>Analytics & Usage Stats</h2>
                    
                    <!-- Date Range Filter -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterAnalytics('today')" class="date-filter-btn active px-3 py-1.5 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700">Today</button>
                        <button onclick="filterAnalytics('yesterday')" class="date-filter-btn px-3 py-1.5 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">Yesterday</button>
                        <button onclick="filterAnalytics('7days')" class="date-filter-btn px-3 py-1.5 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">Last 7 Days</button>
                        <button onclick="filterAnalytics('30days')" class="date-filter-btn px-3 py-1.5 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">Last 30 Days</button>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-4 md:mb-8">
                    <div class="stats-card bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg shadow-lg p-4 md:p-6">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <p class="text-blue-100 text-xs md:text-sm">QR Code Scans</p>
                                <p class="text-2xl md:text-3xl font-bold" id="totalScans">0</p>
                            </div>
                            <i class="fas fa-qrcode text-2xl md:text-4xl opacity-30"></i>
                        </div>
                        <div id="scansComparison" class="text-xs md:text-sm text-blue-100 flex items-center gap-1">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                    <div class="stats-card bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg shadow-lg p-4 md:p-6">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <p class="text-green-100 text-xs md:text-sm">Bookings</p>
                                <p class="text-2xl md:text-3xl font-bold" id="activeBookings">0</p>
                            </div>
                            <i class="fas fa-calendar-check text-2xl md:text-4xl opacity-30"></i>
                        </div>
                        <div id="bookingsComparison" class="text-xs md:text-sm text-green-100 flex items-center gap-1">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                    <div class="stats-card bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg shadow-lg p-4 md:p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-xs md:text-sm">Total Activities</p>
                                <p class="text-2xl md:text-3xl font-bold" id="totalActivities">0</p>
                            </div>
                            <i class="fas fa-hiking text-2xl md:text-4xl opacity-30"></i>
                        </div>
                    </div>
                    <div class="stats-card bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-lg shadow-lg p-4 md:p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-xs md:text-sm">Total Vendors</p>
                                <p class="text-2xl md:text-3xl font-bold" id="totalVendors">0</p>
                            </div>
                            <i class="fas fa-store text-2xl md:text-4xl opacity-30"></i>
                        </div>
                    </div>
                </div>

                <!-- Popular Sections -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div class="bg-white border rounded-lg p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-bold mb-3 md:mb-4 text-gray-700"><i class="fas fa-fire mr-2 text-red-500"></i>Most Popular Activities</h3>
                        <div id="popularActivities" class="space-y-2 md:space-y-3">
                            <div class="text-center text-gray-400 py-6 md:py-8">
                                <i class="fas fa-spinner fa-spin text-xl md:text-2xl mb-2"></i>
                                <p class="text-sm md:text-base">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white border rounded-lg p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-bold mb-3 md:mb-4 text-gray-700"><i class="fas fa-star mr-2 text-yellow-500"></i>Most Viewed Sections</h3>
                        <div id="popularSections" class="space-y-2 md:space-y-3">
                            <div class="text-center text-gray-400 py-6 md:py-8">
                                <i class="fas fa-spinner fa-spin text-xl md:text-2xl mb-2"></i>
                                <p class="text-sm md:text-base">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Old Rooms Tab (keep for backward compatibility but hide) -->
        <div id="roomsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-door-open mr-2 text-blue-600"></i>Individual Room QR Codes (Legacy)</h2>
                <form id="addRoomForm" class="grid md:grid-cols-3 gap-4">
                    <input type="text" id="roomNumber" placeholder="Room Number (e.g., 101)" required class="px-4 py-2 border rounded-lg">
                    <select id="roomType" required class="px-4 py-2 border rounded-lg">
                        <option value="">Select Type...</option>
                        <option value="Standard">Standard</option>
                        <option value="Deluxe">Deluxe</option>
                        <option value="Suite">Suite</option>
                        <option value="Villa">Villa</option>
                    </select>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"><i class="fas fa-plus mr-2"></i>Create Room & QR Code</button>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">Rooms & QR Codes</h2>
                <div id="roomsList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Vendors Tab -->
        <div id="vendorsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-4 md:mb-6">
                <h2 class="text-xl md:text-2xl font-bold mb-3 md:mb-4"><i class="fas fa-user-plus mr-2 text-green-600"></i>Add New Vendor</h2>
                <form id="addVendorForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <input type="text" id="businessName" placeholder="Business Name" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base">
                        <input type="email" id="vendorEmail" placeholder="Email" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base">
                        <input type="text" id="vendorPhone" placeholder="Phone" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base">
                        <input type="password" id="vendorPassword" placeholder="Password" required class="w-full px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base">
                    </div>
                    <button type="submit" class="w-full sm:w-auto bg-green-600 text-white px-4 md:px-6 py-2 rounded-lg hover:bg-green-700 text-sm md:text-base"><i class="fas fa-check mr-2"></i>Add Vendor</button>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-bold mb-3 md:mb-4">All Vendors</h2>
                <div id="vendorsList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Registration Code Tab -->
        <div id="regcodeTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-key mr-2 text-purple-600"></i>Vendor Registration Code</h2>
                <p class="text-gray-600 mb-4">Share this code with vendors so they can self-register to your hotel</p>
                
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">Current Registration Code</p>
                            <p class="text-4xl font-bold text-blue-600" id="regCode">Loading...</p>
                        </div>
                        <button onclick="regenerateRegCode()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            <i class="fas fa-sync mr-2"></i>Regenerate Code
                        </button>
                    </div>
                    <p class="text-sm text-gray-600">Expires: <span id="regCodeExpiry">Loading...</span></p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-bold mb-2">How it works:</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
                        <li>Share this registration code with your vendors</li>
                        <li>Vendors visit the registration page at <code class="bg-white px-2 py-1 rounded">/vendor/register</code></li>
                        <li>They enter the code along with their business details</li>
                        <li>Once registered, they can immediately add activities to your hotel</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- =============================================
             DOCUMENTATION TAB
             ============================================= -->
        <div id="documentationTab" class="tab-content hidden">
            <div class="max-w-6xl mx-auto">
                <!-- Header -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl shadow-xl p-8 mb-8 text-white">
                    <h1 class="text-4xl font-bold mb-3 flex items-center gap-3">
                        <i class="fas fa-book"></i>
                        GuestConnect Documentation
                    </h1>
                    <p class="text-blue-100 text-lg">Complete guide to managing your property with GuestConnect</p>
                </div>

                <!-- Quick Navigation -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <button onclick="scrollToDocSection('getting-started')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-xl transition-all text-left group">
                        <i class="fas fa-rocket text-3xl text-blue-600 mb-3 group-hover:scale-110 transition-transform"></i>
                        <h3 class="font-bold text-lg mb-2">Getting Started</h3>
                        <p class="text-sm text-gray-600">Initial setup and configuration</p>
                    </button>
                    <button onclick="scrollToDocSection('features')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-xl transition-all text-left group">
                        <i class="fas fa-star text-3xl text-purple-600 mb-3 group-hover:scale-110 transition-transform"></i>
                        <h3 class="font-bold text-lg mb-2">Core Features</h3>
                        <p class="text-sm text-gray-600">All system capabilities explained</p>
                    </button>
                    <button onclick="scrollToDocSection('best-practices')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-xl transition-all text-left group">
                        <i class="fas fa-lightbulb text-3xl text-yellow-600 mb-3 group-hover:scale-110 transition-transform"></i>
                        <h3 class="font-bold text-lg mb-2">Best Practices</h3>
                        <p class="text-sm text-gray-600">Tips for optimal results</p>
                    </button>
                </div>

                <!-- Documentation Content -->
                <div class="space-y-6">
                    
                    <!-- GETTING STARTED -->
                    <div id="getting-started" class="bg-white rounded-xl shadow-lg p-8 scroll-mt-4">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">
                            <i class="fas fa-rocket text-blue-600 mr-3"></i>Getting Started
                        </h2>
                        
                        <div class="space-y-6">
                            <div class="bg-blue-50 border-l-4 border-blue-600 p-6 rounded-r-lg">
                                <h3 class="text-xl font-bold mb-3 text-blue-900">1. Initial Property Setup</h3>
                                <p class="text-gray-700 mb-4">Your property is already configured with default settings. Customize these to match your brand:</p>
                                <ul class="space-y-2 text-gray-700">
                                    <li><i class="fas fa-check-circle text-green-600 mr-2"></i><strong>Settings Tab:</strong> Upload your logo, set property name, contact details, and social media links</li>
                                    <li><i class="fas fa-check-circle text-green-600 mr-2"></i><strong>QR Code Tab:</strong> Design your primary QR code with custom colors and decorations</li>
                                    <li><i class="fas fa-check-circle text-green-600 mr-2"></i><strong>Print Your QR:</strong> Download and place QR codes around your property</li>
                                </ul>
                            </div>

                            <div class="bg-purple-50 border-l-4 border-purple-600 p-6 rounded-r-lg">
                                <h3 class="text-xl font-bold mb-3 text-purple-900">2. Add Your Offerings</h3>
                                <p class="text-gray-700 mb-4">Create the services and amenities guests can discover and book:</p>
                                <ul class="space-y-2 text-gray-700">
                                    <li><i class="fas fa-utensils text-orange-600 mr-2"></i><strong>Restaurants:</strong> Add dining options with menus, hours, and booking capabilities</li>
                                    <li><i class="fas fa-swimmer text-blue-600 mr-2"></i><strong>Activities:</strong> Add spa services, excursions, water sports, etc.</li>
                                    <li><i class="fas fa-umbrella-beach text-yellow-600 mr-2"></i><strong>Beach Services:</strong> Sunbed/umbrella rentals with interactive map</li>
                                    <li><i class="fas fa-info-circle text-green-600 mr-2"></i><strong>Info Pages:</strong> Hotel policies, WiFi info, local attractions</li>
                                </ul>
                            </div>

                            <div class="bg-green-50 border-l-4 border-green-600 p-6 rounded-r-lg">
                                <h3 class="text-xl font-bold mb-3 text-green-900">3. Enable AI Features</h3>
                                <p class="text-gray-700 mb-4">Let AI help your guests 24/7:</p>
                                <ul class="space-y-2 text-gray-700">
                                    <li><i class="fas fa-robot text-blue-600 mr-2"></i><strong>AI Chatbot:</strong> Upload FAQs and hotel information as knowledge base</li>
                                    <li><i class="fas fa-language text-purple-600 mr-2"></i><strong>Multi-language:</strong> Automatic translation to 8+ languages</li>
                                    <li><i class="fas fa-magic text-pink-600 mr-2"></i><strong>AI Proofreading:</strong> Improve your content with one click</li>
                                </ul>
                            </div>

                            <div class="bg-yellow-50 border-l-4 border-yellow-600 p-6 rounded-r-lg">
                                <h3 class="text-xl font-bold mb-3 text-yellow-900">4. Monitor & Optimize</h3>
                                <p class="text-gray-700 mb-4">Track performance and improve guest experience:</p>
                                <ul class="space-y-2 text-gray-700">
                                    <li><i class="fas fa-chart-line text-green-600 mr-2"></i><strong>Analytics Tab:</strong> View bookings, popular items, revenue insights</li>
                                    <li><i class="fas fa-comments text-blue-600 mr-2"></i><strong>Feedback Tab:</strong> Read guest reviews and respond promptly</li>
                                    <li><i class="fas fa-bell text-red-600 mr-2"></i><strong>Callbacks:</strong> Manage guest service requests in real-time</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- CORE FEATURES -->
                    <div id="features" class="bg-white rounded-xl shadow-lg p-8 scroll-mt-4">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">
                            <i class="fas fa-star text-purple-600 mr-3"></i>Core Features Guide
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- QR Code Designer -->
                            <div class="border-2 border-purple-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-qrcode text-2xl text-purple-600"></i>
                                    </div>
                                    <h3 class="text-xl font-bold">QR Code Designer</h3>
                                </div>
                                <p class="text-gray-700 mb-3">Create beautiful, branded QR codes for your property.</p>
                                <ul class="space-y-2 text-sm text-gray-600">
                                    <li>â€¢ Upload custom logo (center of QR code)</li>
                                    <li>â€¢ Choose colors to match your brand</li>
                                    <li>â€¢ Add festive decorations (seasonal themes)</li>
                                    <li>â€¢ Custom text and multilingual support</li>
                                    <li>â€¢ Print-ready high-resolution output</li>
                                </ul>
                            </div>

                            <!-- Restaurant Bookings -->
                            <div class="border-2 border-orange-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-utensils text-2xl text-orange-600"></i>
                                    </div>
                                    <h3 class="text-xl font-bold">Restaurant System</h3>
                                </div>
                                <p class="text-gray-700 mb-3">Complete restaurant management with visual table booking.</p>
                                <ul class="space-y-2 text-sm text-gray-600">
                                    <li>â€¢ Interactive floor plan with drag-and-drop tables</li>
                                    <li>â€¢ AI-powered texture extraction from photos</li>
                                    <li>â€¢ Real-time table availability</li>
                                    <li>â€¢ Multiple time slot management</li>
                                    <li>â€¢ Menu photo galleries</li>
                                    <li>â€¢ Guest-facing booking interface</li>
                                </ul>
                            </div>

                            <!-- Beach Services -->
                            <div class="border-2 border-blue-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-umbrella-beach text-2xl text-blue-600"></i>
                                    </div>
                                    <h3 class="text-xl font-bold">Beach Management</h3>
                                </div>
                                <p class="text-gray-700 mb-3">Visual sunbed and umbrella rental system.</p>
                                <ul class="space-y-2 text-sm text-gray-600">
                                    <li>â€¢ Interactive beach map</li>
                                    <li>â€¢ Click-to-select sunbeds/umbrellas</li>
                                    <li>â€¢ Real-time availability updates</li>
                                    <li>â€¢ Automated booking confirmations</li>
                                    <li>â€¢ Pricing per item or packages</li>
                                </ul>
                            </div>

                            <!-- AI Chatbot -->
                            <div class="border-2 border-green-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-robot text-2xl text-green-600"></i>
                                    </div>
                                    <h3 class="text-xl font-bold">AI Chatbot</h3>
                                </div>
                                <p class="text-gray-700 mb-3">24/7 intelligent guest assistance powered by AI.</p>
                                <ul class="space-y-2 text-sm text-gray-600">
                                    <li>â€¢ Upload knowledge base (FAQs, policies, amenities)</li>
                                    <li>â€¢ Natural language understanding</li>
                                    <li>â€¢ Automatic multilingual responses</li>
                                    <li>â€¢ Context-aware answers</li>
                                    <li>â€¢ Analytics on common questions</li>
                                    <li>â€¢ Seamless handoff to human staff</li>
                                </ul>
                            </div>

                            <!-- Custom Sections -->
                            <div class="border-2 border-pink-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-puzzle-piece text-2xl text-pink-600"></i>
                                    </div>
                                    <h3 class="text-xl font-bold">Custom Sections</h3>
                                </div>
                                <p class="text-gray-700 mb-3">Build any custom content page for your guests.</p>
                                <ul class="space-y-2 text-sm text-gray-600">
                                    <li>â€¢ Drag-and-drop page builder</li>
                                    <li>â€¢ Rich text editor</li>
                                    <li>â€¢ Image galleries and videos</li>
                                    <li>â€¢ Custom icons and emojis</li>
                                    <li>â€¢ Mobile-optimized layouts</li>
                                </ul>
                            </div>

                            <!-- Analytics -->
                            <div class="border-2 border-indigo-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-chart-line text-2xl text-indigo-600"></i>
                                    </div>
                                    <h3 class="text-xl font-bold">Analytics Dashboard</h3>
                                </div>
                                <p class="text-gray-700 mb-3">Comprehensive insights into guest behavior.</p>
                                <ul class="space-y-2 text-sm text-gray-600">
                                    <li>â€¢ Booking statistics and trends</li>
                                    <li>â€¢ Revenue tracking by service</li>
                                    <li>â€¢ Most popular offerings</li>
                                    <li>â€¢ Peak booking times</li>
                                    <li>â€¢ Guest feedback scores</li>
                                    <li>â€¢ QR code scan analytics</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- BEST PRACTICES -->
                    <div id="best-practices" class="bg-white rounded-xl shadow-lg p-8 scroll-mt-4">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">
                            <i class="fas fa-lightbulb text-yellow-600 mr-3"></i>Best Practices & Tips
                        </h2>
                        
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-6">
                                <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                                    <i class="fas fa-image text-blue-600"></i>
                                    Image Quality Matters
                                </h3>
                                <ul class="space-y-2 text-gray-700">
                                    <li>â€¢ Use high-resolution images (1920x1080 or higher)</li>
                                    <li>â€¢ Compress images before uploading (use TinyPNG)</li>
                                    <li>â€¢ Show your property in best lighting conditions</li>
                                    <li>â€¢ Include variety: wide shots, detail shots, ambiance</li>
                                    <li>â€¢ Update seasonal imagery (summer vs winter themes)</li>
                                </ul>
                            </div>

                            <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-6">
                                <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                                    <i class="fas fa-pen text-green-600"></i>
                                    Content Writing Tips
                                </h3>
                                <ul class="space-y-2 text-gray-700">
                                    <li>â€¢ Keep descriptions concise but informative</li>
                                    <li>â€¢ Highlight unique selling points first</li>
                                    <li>â€¢ Use emotional, inviting language</li>
                                    <li>â€¢ Always use AI Proofreading before publishing</li>
                                    <li>â€¢ Include practical details (hours, location, pricing)</li>
                                    <li>â€¢ Write in present tense for immediacy</li>
                                </ul>
                            </div>

                            <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-6">
                                <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                                    <i class="fas fa-clock text-purple-600"></i>
                                    Timing & Updates
                                </h3>
                                <ul class="space-y-2 text-gray-700">
                                    <li>â€¢ Check and respond to feedback daily</li>
                                    <li>â€¢ Update availability in real-time</li>
                                    <li>â€¢ Refresh seasonal offerings quarterly</li>
                                    <li>â€¢ Review analytics weekly to spot trends</li>
                                    <li>â€¢ Update chatbot knowledge base monthly</li>
                                </ul>
                            </div>

                            <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-6">
                                <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                                    <i class="fas fa-users text-orange-600"></i>
                                    Guest Experience First
                                </h3>
                                <ul class="space-y-2 text-gray-700">
                                    <li>â€¢ Make QR codes easily accessible (lobby, rooms, poolside)</li>
                                    <li>â€¢ Test the booking flow yourself regularly</li>
                                    <li>â€¢ Respond to callback requests within 10 minutes</li>
                                    <li>â€¢ Offer incentives for first-time bookers</li>
                                    <li>â€¢ Monitor feedback scores and act on issues quickly</li>
                                    <li>â€¢ Train staff on how to use the system</li>
                                </ul>
                            </div>

                            <div class="bg-gradient-to-r from-red-50 to-red-100 rounded-xl p-6">
                                <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                                    Common Pitfalls to Avoid
                                </h3>
                                <ul class="space-y-2 text-gray-700">
                                    <li>â€¢ âŒ Using blurry or poorly lit images</li>
                                    <li>â€¢ âŒ Forgetting to update availability calendar</li>
                                    <li>â€¢ âŒ Not responding to guest feedback</li>
                                    <li>â€¢ âŒ Overcomplicating descriptions with jargon</li>
                                    <li>â€¢ âŒ Setting unrealistic expectations</li>
                                    <li>â€¢ âŒ Ignoring analytics insights</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- TECHNICAL REFERENCE -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">
                            <i class="fas fa-code text-gray-600 mr-3"></i>Technical Reference
                        </h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-xl font-bold mb-3">Supported Image Formats</h3>
                                <p class="text-gray-700">JPG, PNG, WebP, GIF (static and animated)</p>
                            </div>

                            <div>
                                <h3 class="text-xl font-bold mb-3">Supported Languages</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-gray-700">
                                    <div>ðŸ‡¬ðŸ‡§ English</div>
                                    <div>ðŸ‡¸ðŸ‡¦ Arabic</div>
                                    <div>ðŸ‡©ðŸ‡ª German</div>
                                    <div>ðŸ‡·ðŸ‡º Russian</div>
                                    <div>ðŸ‡µðŸ‡± Polish</div>
                                    <div>ðŸ‡®ðŸ‡¹ Italian</div>
                                    <div>ðŸ‡«ðŸ‡· French</div>
                                    <div>ðŸ‡¨ðŸ‡¿ Czech</div>
                                    <div>ðŸ‡ºðŸ‡¦ Ukrainian</div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-xl font-bold mb-3">Browser Support</h3>
                                <p class="text-gray-700">Chrome 90+, Safari 14+, Firefox 88+, Edge 90+</p>
                            </div>

                            <div>
                                <h3 class="text-xl font-bold mb-3">Mobile Compatibility</h3>
                                <p class="text-gray-700">Fully responsive on all iOS and Android devices</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- =============================================
             TUTORIALS TAB
             ============================================= -->
        <div id="tutorialsTab" class="tab-content hidden">
            <div class="max-w-6xl mx-auto">
                <!-- Header -->
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl shadow-xl p-8 mb-8 text-white">
                    <h1 class="text-4xl font-bold mb-3 flex items-center gap-3">
                        <i class="fas fa-graduation-cap"></i>
                        Video Tutorials & Guides
                    </h1>
                    <p class="text-purple-100 text-lg">Step-by-step video walkthroughs for every feature</p>
                </div>

                <!-- Tutorial Categories -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- Quick Start Tutorial -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 text-white">
                            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-play-circle text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-2">Quick Start</h3>
                            <p class="text-blue-100 text-sm">Get up and running in 10 minutes</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3">
                                <a href="#" onclick="playTutorial('quick-start-1'); return false;" class="block p-4 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-blue-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-blue-600">Initial Setup</h4>
                                                <p class="text-xs text-gray-500">3:45 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-blue-600"></i>
                                    </div>
                                </a>
                                
                                <a href="#" onclick="playTutorial('quick-start-2'); return false;" class="block p-4 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-blue-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-blue-600">Your First QR Code</h4>
                                                <p class="text-xs text-gray-500">2:20 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-blue-600"></i>
                                    </div>
                                </a>
                                
                                <a href="#" onclick="playTutorial('quick-start-3'); return false;" class="block p-4 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-blue-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-blue-600">Adding Your First Service</h4>
                                                <p class="text-xs text-gray-500">4:10 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-blue-600"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Restaurant Management -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow">
                        <div class="bg-gradient-to-br from-orange-500 to-red-600 p-6 text-white">
                            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-utensils text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-2">Restaurants</h3>
                            <p class="text-orange-100 text-sm">Complete restaurant setup guide</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3">
                                <a href="#" onclick="playTutorial('restaurant-1'); return false;" class="block p-4 bg-gray-50 hover:bg-orange-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-orange-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-orange-600">Creating a Restaurant</h4>
                                                <p class="text-xs text-gray-500">5:30 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-orange-600"></i>
                                    </div>
                                </a>
                                
                                <a href="#" onclick="playTutorial('restaurant-2'); return false;" class="block p-4 bg-gray-50 hover:bg-orange-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-orange-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-orange-600">Floor Plan Designer</h4>
                                                <p class="text-xs text-gray-500">7:45 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-orange-600"></i>
                                    </div>
                                </a>
                                
                                <a href="#" onclick="playTutorial('restaurant-3'); return false;" class="block p-4 bg-gray-50 hover:bg-orange-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-orange-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-orange-600">AI Texture Extraction</h4>
                                                <p class="text-xs text-gray-500">3:20 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-orange-600"></i>
                                    </div>
                                </a>
                                
                                <a href="#" onclick="playTutorial('restaurant-4'); return false;" class="block p-4 bg-gray-50 hover:bg-orange-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-orange-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-orange-600">Managing Bookings</h4>
                                                <p class="text-xs text-gray-500">4:55 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-orange-600"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Beach Services -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow">
                        <div class="bg-gradient-to-br from-cyan-500 to-blue-600 p-6 text-white">
                            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-umbrella-beach text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-2">Beach Services</h3>
                            <p class="text-cyan-100 text-sm">Sunbed & umbrella rental setup</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3">
                                <a href="#" onclick="playTutorial('beach-1'); return false;" class="block p-4 bg-gray-50 hover:bg-cyan-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-cyan-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-cyan-600">Beach Map Setup</h4>
                                                <p class="text-xs text-gray-500">6:15 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-cyan-600"></i>
                                    </div>
                                </a>
                                
                                <a href="#" onclick="playTutorial('beach-2'); return false;" class="block p-4 bg-gray-50 hover:bg-cyan-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-cyan-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-cyan-600">Pricing & Availability</h4>
                                                <p class="text-xs text-gray-500">3:40 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-cyan-600"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- AI Chatbot -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow">
                        <div class="bg-gradient-to-br from-green-500 to-emerald-600 p-6 text-white">
                            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-robot text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-2">AI Chatbot</h3>
                            <p class="text-green-100 text-sm">Setup intelligent guest assistant</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3">
                                <a href="#" onclick="playTutorial('chatbot-1'); return false;" class="block p-4 bg-gray-50 hover:bg-green-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-green-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-green-600">Knowledge Base Upload</h4>
                                                <p class="text-xs text-gray-500">5:00 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-green-600"></i>
                                    </div>
                                </a>
                                
                                <a href="#" onclick="playTutorial('chatbot-2'); return false;" class="block p-4 bg-gray-50 hover:bg-green-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-green-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-green-600">Training Your AI</h4>
                                                <p class="text-xs text-gray-500">4:30 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-green-600"></i>
                                    </div>
                                </a>
                                
                                <a href="#" onclick="playTutorial('chatbot-3'); return false;" class="block p-4 bg-gray-50 hover:bg-green-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-green-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-green-600">Monitoring Conversations</h4>
                                                <p class="text-xs text-gray-500">3:15 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-green-600"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Designer -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow">
                        <div class="bg-gradient-to-br from-purple-500 to-indigo-600 p-6 text-white">
                            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-qrcode text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-2">QR Codes</h3>
                            <p class="text-purple-100 text-sm">Design beautiful branded QR codes</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3">
                                <a href="#" onclick="playTutorial('qr-1'); return false;" class="block p-4 bg-gray-50 hover:bg-purple-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-purple-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-purple-600">Custom Branding</h4>
                                                <p class="text-xs text-gray-500">4:20 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-purple-600"></i>
                                    </div>
                                </a>
                                
                                <a href="#" onclick="playTutorial('qr-2'); return false;" class="block p-4 bg-gray-50 hover:bg-purple-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-purple-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-purple-600">Print-Ready Export</h4>
                                                <p class="text-xs text-gray-500">2:50 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-purple-600"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow">
                        <div class="bg-gradient-to-br from-yellow-500 to-orange-600 p-6 text-white">
                            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-chart-line text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold mb-2">Analytics</h3>
                            <p class="text-yellow-100 text-sm">Understanding your data</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3">
                                <a href="#" onclick="playTutorial('analytics-1'); return false;" class="block p-4 bg-gray-50 hover:bg-yellow-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-yellow-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-yellow-600">Reading Your Dashboard</h4>
                                                <p class="text-xs text-gray-500">6:00 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-yellow-600"></i>
                                    </div>
                                </a>
                                
                                <a href="#" onclick="playTutorial('analytics-2'); return false;" class="block p-4 bg-gray-50 hover:bg-yellow-50 rounded-lg transition-colors group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-video text-yellow-600"></i>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 group-hover:text-yellow-600">Optimizing Performance</h4>
                                                <p class="text-xs text-gray-500">5:30 min</p>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 group-hover:text-yellow-600"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Coming Soon Notice -->
                <div class="mt-8 bg-gradient-to-r from-indigo-100 to-purple-100 rounded-xl p-8 text-center">
                    <i class="fas fa-video text-5xl text-indigo-600 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">ðŸ“¹ Video Tutorials Coming Soon!</h3>
                    <p class="text-gray-700 mb-4">We're currently recording comprehensive video tutorials for every feature. Check back soon!</p>
                    <p class="text-sm text-gray-600">In the meantime, explore the <button onclick="switchToTab('documentation')" class="text-blue-600 hover:underline font-semibold">Documentation</button> for detailed written guides.</p>
                </div>
            </div>
        </div>

        <!-- =============================================
             FAQ TAB
             ============================================= -->
        <div id="faqTab" class="tab-content hidden">
            <div class="max-w-5xl mx-auto">
                <!-- Header -->
                <div class="bg-gradient-to-r from-green-600 to-teal-600 rounded-2xl shadow-xl p-8 mb-8 text-white">
                    <h1 class="text-4xl font-bold mb-3 flex items-center gap-3">
                        <i class="fas fa-question-circle"></i>
                        Frequently Asked Questions
                    </h1>
                    <p class="text-green-100 text-lg">Quick answers to common questions</p>
                </div>

                <!-- Search Bar -->
                <div class="mb-8">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="faqSearch" 
                            placeholder="Search FAQs... (e.g., 'how to add restaurant', 'QR code not working')"
                            class="w-full px-6 py-4 pr-12 rounded-xl border-2 border-gray-300 focus:border-blue-500 focus:outline-none text-lg"
                            onkeyup="searchFAQs()"
                        >
                        <i class="fas fa-search absolute right-5 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl"></i>
                    </div>
                </div>

                <!-- FAQ Categories -->
                <div class="space-y-4" id="faqContainer">
                    
                    <!-- Getting Started -->
                    <div class="faq-category" data-category="getting-started">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-3">
                            <i class="fas fa-rocket text-blue-600"></i>
                            Getting Started
                        </h2>
                        
                        <div class="space-y-3">
                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="setup begin start first time new account initial configure">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        How do I set up my property for the first time?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">Follow these simple steps to get started:</p>
                                    <ol class="list-decimal list-inside space-y-2 text-gray-700 ml-4">
                                        <li><strong>Go to Settings Tab:</strong> Upload your logo, set property name, and add contact details</li>
                                        <li><strong>Create Your First QR Code:</strong> Navigate to QR Code tab, customize design with your brand colors</li>
                                        <li><strong>Add Services:</strong> Go to Offerings tab and add your restaurants, activities, and amenities</li>
                                        <li><strong>Print QR Codes:</strong> Download and place them in strategic locations (lobby, rooms, poolside)</li>
                                        <li><strong>Test Everything:</strong> Scan your QR code and try booking something to ensure it works</li>
                                    </ol>
                                    <div class="mt-4 bg-blue-50 p-4 rounded-lg">
                                        <p class="text-sm text-blue-800"><i class="fas fa-lightbulb mr-2"></i><strong>Tip:</strong> Use the AI Assistant (blue button bottom-right) for step-by-step guidance!</p>
                                    </div>
                                </div>
                            </div>

                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="qr code scan print download not working broken">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        My QR code isn't scanning. What should I do?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">Try these troubleshooting steps:</p>
                                    <ul class="space-y-2 text-gray-700">
                                        <li><i class="fas fa-check text-green-600 mr-2"></i><strong>Print Quality:</strong> Ensure the QR code is printed in high resolution (at least 300 DPI)</li>
                                        <li><i class="fas fa-check text-green-600 mr-2"></i><strong>Size Matters:</strong> QR code should be at least 2cm x 2cm in size</li>
                                        <li><i class="fas fa-check text-green-600 mr-2"></i><strong>Clean Surface:</strong> Make sure the QR code isn't damaged, dirty, or behind reflective material</li>
                                        <li><i class="fas fa-check text-green-600 mr-2"></i><strong>Lighting:</strong> Scan in good lighting conditions, avoid shadows</li>
                                        <li><i class="fas fa-check text-green-600 mr-2"></i><strong>Camera Focus:</strong> Hold phone steady and let camera auto-focus</li>
                                        <li><i class="fas fa-check text-green-600 mr-2"></i><strong>Test URL:</strong> Try typing the URL manually to check if it's a QR code or system issue</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="cost price free trial paid subscription billing payment">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        Is GuestConnect free? What are the pricing plans?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">GuestConnect offers flexible pricing:</p>
                                    <div class="grid md:grid-cols-3 gap-4">
                                        <div class="border-2 border-green-200 rounded-lg p-4 bg-green-50">
                                            <h4 class="font-bold text-green-800 mb-2">Free Tier</h4>
                                            <ul class="text-sm text-gray-700 space-y-1">
                                                <li>â€¢ Up to 3 services</li>
                                                <li>â€¢ Basic QR codes</li>
                                                <li>â€¢ 50 bookings/month</li>
                                                <li>â€¢ Email support</li>
                                            </ul>
                                        </div>
                                        <div class="border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                                            <h4 class="font-bold text-blue-800 mb-2">Pro ($49/mo)</h4>
                                            <ul class="text-sm text-gray-700 space-y-1">
                                                <li>â€¢ Unlimited services</li>
                                                <li>â€¢ Advanced QR design</li>
                                                <li>â€¢ Unlimited bookings</li>
                                                <li>â€¢ Priority support</li>
                                                <li>â€¢ Analytics dashboard</li>
                                            </ul>
                                        </div>
                                        <div class="border-2 border-purple-200 rounded-lg p-4 bg-purple-50">
                                            <h4 class="font-bold text-purple-800 mb-2">Enterprise</h4>
                                            <ul class="text-sm text-gray-700 space-y-1">
                                                <li>â€¢ Everything in Pro</li>
                                                <li>â€¢ White-label option</li>
                                                <li>â€¢ Custom integrations</li>
                                                <li>â€¢ Dedicated account manager</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Restaurants & Bookings -->
                    <div class="faq-category" data-category="restaurants">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-3">
                            <i class="fas fa-utensils text-orange-600"></i>
                            Restaurants & Bookings
                        </h2>
                        
                        <div class="space-y-3">
                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="restaurant add create new dining setup menu">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        How do I add a new restaurant?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4"><strong>Step-by-step instructions:</strong></p>
                                    <ol class="list-decimal list-inside space-y-3 text-gray-700 ml-4">
                                        <li><strong>Go to Offerings Tab:</strong> Click "Offerings" in the left sidebar</li>
                                        <li><strong>Select Type:</strong> Choose "Restaurant" from the type dropdown</li>
                                        <li><strong>Fill Details:</strong>
                                            <ul class="ml-6 mt-2 space-y-1 list-disc">
                                                <li>Name and description (use AI Proofreading!)</li>
                                                <li>Location within property</li>
                                                <li>Operating hours</li>
                                                <li>Price range</li>
                                            </ul>
                                        </li>
                                        <li><strong>Upload Images:</strong> Add high-quality photos of food, ambiance, and interior</li>
                                        <li><strong>Add Menus:</strong> In the "Restaurant Menus" section, paste URLs of menu images</li>
                                        <li><strong>Configure Booking:</strong> Enable "Requires Booking" if guests should reserve tables</li>
                                        <li><strong>Design Floor Plan:</strong> Go to Restaurants tab to create interactive floor plan with drag-and-drop tables</li>
                                    </ol>
                                </div>
                            </div>

                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="floor plan table layout design drag drop move arrange">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        How does the floor plan designer work?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">The floor plan designer lets guests see and select specific tables:</p>
                                    <ul class="space-y-3 text-gray-700">
                                        <li><i class="fas fa-magic text-purple-600 mr-2"></i><strong>AI Texture Extraction:</strong> Upload a photo of your restaurant, and AI will extract the floor/wall textures automatically</li>
                                        <li><i class="fas fa-table text-blue-600 mr-2"></i><strong>Add Tables:</strong> Click "Add Table", choose size (2/4/6/8 seats), and place on canvas</li>
                                        <li><i class="fas fa-arrows-alt text-green-600 mr-2"></i><strong>Drag to Position:</strong> Simply drag tables to arrange your actual layout</li>
                                        <li><i class="fas fa-pen text-orange-600 mr-2"></i><strong>Draw Walls:</strong> Use wall drawing tool to outline rooms, sections, or outdoor areas</li>
                                        <li><i class="fas fa-shapes text-red-600 mr-2"></i><strong>Add Elements:</strong> Place decorative elements like bars, buffets, plants, etc.</li>
                                        <li><i class="fas fa-ruler text-teal-600 mr-2"></i><strong>Scale Control:</strong> Use Master Scale Slider to resize everything proportionally</li>
                                    </ul>
                                    <div class="mt-4 bg-orange-50 p-4 rounded-lg">
                                        <p class="text-sm text-orange-800"><i class="fas fa-info-circle mr-2"></i><strong>Note:</strong> Positions are automatically saved. Guests will see exactly what you designed!</p>
                                    </div>
                                </div>
                            </div>

                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="booking reservation manage time slots availability calendar">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        How do I manage restaurant bookings and time slots?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">Managing bookings is simple:</p>
                                    <ul class="space-y-2 text-gray-700">
                                        <li><i class="fas fa-clock text-blue-600 mr-2"></i><strong>Set Time Slots:</strong> In Restaurants tab, configure available booking times (e.g., 18:00, 19:00, 20:00)</li>
                                        <li><i class="fas fa-calendar text-green-600 mr-2"></i><strong>View Bookings:</strong> All reservations appear in Analytics tab with date, time, table, and guest details</li>
                                        <li><i class="fas fa-ban text-red-600 mr-2"></i><strong>Block Tables:</strong> Manually mark tables as unavailable for maintenance or private events</li>
                                        <li><i class="fas fa-sync text-purple-600 mr-2"></i><strong>Auto-Refresh:</strong> Dashboard updates automatically every 5 minutes (toggle in header)</li>
                                        <li><i class="fas fa-bell text-yellow-600 mr-2"></i><strong>Notifications:</strong> Enable sound alerts for new bookings</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI & Automation -->
                    <div class="faq-category" data-category="ai">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-3">
                            <i class="fas fa-robot text-green-600"></i>
                            AI & Automation
                        </h2>
                        
                        <div class="space-y-3">
                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="chatbot ai assistant knowledge base upload train faq">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        How do I set up the AI chatbot for my guests?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">Setting up the AI chatbot is easy:</p>
                                    <ol class="list-decimal list-inside space-y-3 text-gray-700 ml-4">
                                        <li><strong>Go to AI Chatbot Tab:</strong> Find it in the left sidebar under "AI & Advanced"</li>
                                        <li><strong>Upload Knowledge Base:</strong>
                                            <ul class="ml-6 mt-2 space-y-1 list-disc">
                                                <li>Click "Upload Knowledge Base Documents"</li>
                                                <li>Add text files with FAQs, hotel policies, amenity information, local attractions</li>
                                                <li>Supported formats: TXT, PDF, DOC, DOCX</li>
                                            </ul>
                                        </li>
                                        <li><strong>Test Your Bot:</strong> Use the live preview to ask sample questions</li>
                                        <li><strong>Refine Responses:</strong> If answers aren't accurate, add more detailed information to knowledge base</li>
                                        <li><strong>Enable for Guests:</strong> Toggle "Active" to make chatbot available on guest pages</li>
                                    </ol>
                                    <div class="mt-4 bg-green-50 p-4 rounded-lg">
                                        <p class="text-sm text-green-800"><i class="fas fa-lightbulb mr-2"></i><strong>Best Practice:</strong> Include common questions like WiFi password, check-out time, breakfast hours, parking info, etc.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="language translation multilingual arabic german russian french">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        Does the system support multiple languages?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4"><strong>Yes! GuestConnect supports 9 languages with automatic translation:</strong></p>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                                        <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                                            <span class="text-2xl">ðŸ‡¬ðŸ‡§</span>
                                            <span class="text-gray-700">English</span>
                                        </div>
                                        <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                                            <span class="text-2xl">ðŸ‡¸ðŸ‡¦</span>
                                            <span class="text-gray-700">Arabic</span>
                                        </div>
                                        <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                                            <span class="text-2xl">ðŸ‡©ðŸ‡ª</span>
                                            <span class="text-gray-700">German</span>
                                        </div>
                                        <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                                            <span class="text-2xl">ðŸ‡·ðŸ‡º</span>
                                            <span class="text-gray-700">Russian</span>
                                        </div>
                                        <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                                            <span class="text-2xl">ðŸ‡µðŸ‡±</span>
                                            <span class="text-gray-700">Polish</span>
                                        </div>
                                        <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                                            <span class="text-2xl">ðŸ‡®ðŸ‡¹</span>
                                            <span class="text-gray-700">Italian</span>
                                        </div>
                                        <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                                            <span class="text-2xl">ðŸ‡«ðŸ‡·</span>
                                            <span class="text-gray-700">French</span>
                                        </div>
                                        <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                                            <span class="text-2xl">ðŸ‡¨ðŸ‡¿</span>
                                            <span class="text-gray-700">Czech</span>
                                        </div>
                                        <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                                            <span class="text-2xl">ðŸ‡ºðŸ‡¦</span>
                                            <span class="text-gray-700">Ukrainian</span>
                                        </div>
                                    </div>
                                    <p class="text-gray-700 mb-2"><strong>How it works:</strong></p>
                                    <ul class="space-y-2 text-gray-700">
                                        <li>â€¢ Guests select their preferred language from a dropdown</li>
                                        <li>â€¢ All content (menus, descriptions, chatbot responses) translates automatically</li>
                                        <li>â€¢ Translations use AI (GPT-4) for natural, context-aware results</li>
                                        <li>â€¢ You only need to enter content in English - translations happen automatically</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="ai proofreading grammar spelling check improve text">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        What is AI Proofreading and how do I use it?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">AI Proofreading improves your text with one click:</p>
                                    <ul class="space-y-2 text-gray-700 mb-4">
                                        <li><i class="fas fa-spell-check text-blue-600 mr-2"></i>Fixes grammar and spelling errors</li>
                                        <li><i class="fas fa-pen-fancy text-purple-600 mr-2"></i>Improves sentence structure and clarity</li>
                                        <li><i class="fas fa-magic text-pink-600 mr-2"></i>Makes text more engaging and professional</li>
                                        <li><i class="fas fa-language text-green-600 mr-2"></i>Maintains your original meaning and tone</li>
                                    </ul>
                                    <p class="text-gray-700 mb-2"><strong>How to use:</strong></p>
                                    <ol class="list-decimal list-inside space-y-1 text-gray-700 ml-4">
                                        <li>Write your text in any description field</li>
                                        <li>Click the purple "âœ¨ AI Proofread" button above the field</li>
                                        <li>Wait 2-3 seconds for AI to process</li>
                                        <li>Review the improved text and save</li>
                                    </ol>
                                    <div class="mt-4 bg-purple-50 p-4 rounded-lg">
                                        <p class="text-sm text-purple-800"><i class="fas fa-gift mr-2"></i><strong>Free Tier:</strong> 10 proofreading requests per day. Pro plans get unlimited usage!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Beach Services -->
                    <div class="faq-category" data-category="beach">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-3">
                            <i class="fas fa-umbrella-beach text-cyan-600"></i>
                            Beach Services
                        </h2>
                        
                        <div class="space-y-3">
                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="beach sunbed umbrella rental setup map">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        How do I set up beach sunbed and umbrella rentals?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">Setting up beach rentals is visual and intuitive:</p>
                                    <ol class="list-decimal list-inside space-y-3 text-gray-700 ml-4">
                                        <li><strong>Go to Beach Tab:</strong> Find it in the left sidebar under "Bookings"</li>
                                        <li><strong>Upload Beach Photo:</strong> Add a top-down or aerial view of your beach area</li>
                                        <li><strong>Place Sunbeds:</strong> Click on the image where each sunbed is located</li>
                                        <li><strong>Add Umbrellas:</strong> Similarly mark umbrella positions</li>
                                        <li><strong>Set Pricing:</strong> Configure individual prices or package deals (e.g., sunbed + umbrella)</li>
                                        <li><strong>Publish:</strong> Guests can now click on specific sunbeds/umbrellas to book</li>
                                    </ol>
                                    <div class="mt-4 bg-cyan-50 p-4 rounded-lg">
                                        <p class="text-sm text-cyan-800"><i class="fas fa-info-circle mr-2"></i><strong>Tip:</strong> Use a high-quality image with clear view of the beach layout for best results.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Issues -->
                    <div class="faq-category" data-category="technical">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-3">
                            <i class="fas fa-wrench text-red-600"></i>
                            Technical Issues
                        </h2>
                        
                        <div class="space-y-3">
                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="slow loading performance lag speed">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        The system is slow or not loading properly. What should I do?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">Try these troubleshooting steps:</p>
                                    <ul class="space-y-2 text-gray-700">
                                        <li><i class="fas fa-sync text-blue-600 mr-2"></i><strong>Refresh Page:</strong> Press Ctrl+R (Windows) or Cmd+R (Mac)</li>
                                        <li><i class="fas fa-trash text-red-600 mr-2"></i><strong>Clear Cache:</strong> Clear browser cache and cookies, then reload</li>
                                        <li><i class="fas fa-wifi text-green-600 mr-2"></i><strong>Check Internet:</strong> Ensure you have stable internet connection</li>
                                        <li><i class="fas fa-browser text-purple-600 mr-2"></i><strong>Try Another Browser:</strong> Test in Chrome, Safari, or Firefox</li>
                                        <li><i class="fas fa-compress text-orange-600 mr-2"></i><strong>Image Size:</strong> Large images can slow loading - compress them before uploading</li>
                                        <li><i class="fas fa-clock text-teal-600 mr-2"></i><strong>Peak Times:</strong> System may be slower during high-traffic periods</li>
                                    </ul>
                                    <div class="mt-4 bg-red-50 p-4 rounded-lg">
                                        <p class="text-sm text-red-800"><i class="fas fa-life-ring mr-2"></i><strong>Still Not Working?</strong> Click "Get Support" in the header to contact our team.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="booking not working error failed broken">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        Guests are saying bookings aren't working. How do I fix this?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">Check these common issues:</p>
                                    <ul class="space-y-2 text-gray-700">
                                        <li><i class="fas fa-toggle-on text-green-600 mr-2"></i><strong>Booking Enabled:</strong> In Offerings tab, ensure "Requires Booking" is checked</li>
                                        <li><i class="fas fa-calendar text-blue-600 mr-2"></i><strong>Availability Set:</strong> Make sure time slots and dates are configured</li>
                                        <li><i class="fas fa-ban text-red-600 mr-2"></i><strong>No Conflicts:</strong> Check if tables/time slots aren't already booked</li>
                                        <li><i class="fas fa-database text-purple-600 mr-2"></i><strong>Database Connection:</strong> Verify system is connected (check Analytics tab)</li>
                                        <li><i class="fas fa-mobile text-orange-600 mr-2"></i><strong>Mobile Testing:</strong> Test the booking flow on a mobile device yourself</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics & Reports -->
                    <div class="faq-category" data-category="analytics">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-3">
                            <i class="fas fa-chart-line text-indigo-600"></i>
                            Analytics & Reports
                        </h2>
                        
                        <div class="space-y-3">
                            <div class="faq-item bg-white rounded-lg shadow-md overflow-hidden" data-keywords="analytics dashboard statistics data report metrics">
                                <button onclick="toggleFAQ(this)" class="w-full text-left p-6 hover:bg-gray-50 transition-colors flex items-center justify-between group">
                                    <h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600 pr-4">
                                        How do I view booking statistics and analytics?
                                    </h3>
                                    <i class="fas fa-chevron-down text-gray-400 group-hover:text-blue-600 transform transition-transform"></i>
                                </button>
                                <div class="faq-answer hidden px-6 pb-6">
                                    <p class="text-gray-700 mb-4">Access comprehensive analytics in the Analytics tab:</p>
                                    <ul class="space-y-2 text-gray-700">
                                        <li><i class="fas fa-calendar-check text-blue-600 mr-2"></i><strong>Booking Overview:</strong> Total bookings, revenue, and trends over time</li>
                                        <li><i class="fas fa-trophy text-yellow-600 mr-2"></i><strong>Top Performers:</strong> Most popular services and peak booking times</li>
                                        <li><i class="fas fa-dollar-sign text-green-600 mr-2"></i><strong>Revenue Tracking:</strong> Income by service, date range, and category</li>
                                        <li><i class="fas fa-users text-purple-600 mr-2"></i><strong>Guest Insights:</strong> Demographics, preferences, and repeat customers</li>
                                        <li><i class="fas fa-star text-orange-600 mr-2"></i><strong>Feedback Scores:</strong> Average ratings and review summaries</li>
                                        <li><i class="fas fa-download text-gray-600 mr-2"></i><strong>Export Data:</strong> Download reports as CSV or PDF</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Still Have Questions? -->
                <div class="mt-12 bg-gradient-to-r from-blue-100 to-purple-100 rounded-xl p-8 text-center">
                    <i class="fas fa-headset text-5xl text-blue-600 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">Still Have Questions?</h3>
                    <p class="text-gray-700 mb-6">Our support team is here to help!</p>
                    <div class="flex flex-wrap justify-center gap-4">
                        <button onclick="openSupportModal()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
                            <i class="fas fa-life-ring mr-2"></i>Contact Support
                        </button>
                        <button onclick="openLiveChat()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors">
                            <i class="fas fa-comments mr-2"></i>Live Chat
                        </button>
                        <button onclick="toggleAssistant()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-colors">
                            <i class="fas fa-robot mr-2"></i>AI Assistant
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hotel Offerings Tab -->
        <div id="offeringsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-plus-circle mr-2 text-green-600"></i>Add New Hotel Offering</h2>
                <form id="addOfferingForm" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <select id="offeringType" required class="px-4 py-2 border rounded-lg">
                            <option value="">Select Type...</option>
                            <option value="restaurant">Dining & Drinks</option>
                            <option value="event">Events & Entertainment</option>
                            <option value="spa">Spa/Wellness</option>
                            <option value="service">Facilities & Amenities</option>
                        </select>
                        <input type="text" id="offeringTitle" placeholder="Title (English)" required class="px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium">Short Description</label>
                            <button type="button" onclick="proofreadText('offeringDescription', 'admin')" class="text-xs px-3 py-1 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover:from-purple-600 hover:to-blue-600 transition flex items-center gap-1">
                                <i class="fas fa-magic"></i> AI Proofread
                            </button>
                        </div>
                        <textarea id="offeringDescription" placeholder="Short description" required class="w-full px-4 py-2 border rounded-lg" rows="2"></textarea>
                        <p class="text-xs text-gray-500 mt-1">âœ¨ Use AI Proofread to improve grammar and clarity (10 free per day)</p>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium">Full Description</label>
                            <button type="button" onclick="proofreadText('offeringFullDescription', 'admin')" class="text-xs px-3 py-1 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover:from-purple-600 hover:to-blue-600 transition flex items-center gap-1">
                                <i class="fas fa-magic"></i> AI Proofread
                            </button>
                        </div>
                        <textarea id="offeringFullDescription" placeholder="Full description" class="w-full px-4 py-2 border rounded-lg" rows="3"></textarea>
                        <p class="text-xs text-gray-500 mt-1">âœ¨ Use AI Proofread to improve grammar and clarity (10 free per day)</p>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4">
                        <input type="number" id="offeringPrice" placeholder="Price" step="0.01" class="px-4 py-2 border rounded-lg">
                        <input type="text" id="offeringLocation" placeholder="Location" class="px-4 py-2 border rounded-lg">
                        <input type="number" id="offeringDuration" placeholder="Duration (minutes)" class="px-4 py-2 border rounded-lg">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <textarea id="offeringImages" placeholder="Image URLs (one per line)" class="px-4 py-2 border rounded-lg w-full" rows="3"></textarea>
                        <input type="url" id="offeringVideoUrl" placeholder="Video URL (direct link to MP4)" class="px-4 py-2 border rounded-lg">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <label class="flex items-center px-4 py-2 border rounded-lg">
                            <input type="checkbox" id="offeringRequiresBooking" class="mr-2">
                            <span>Requires Booking</span>
                        </label>
                    </div>
                    
                    <!-- Restaurant-specific fields (menus) -->
                    <div id="restaurantFields" class="hidden space-y-4">
                        <div class="border-2 border-dashed border-orange-300 rounded-lg p-4 bg-orange-50">
                            <h3 class="font-bold text-orange-800 mb-2 flex items-center">
                                <i class="fas fa-utensils mr-2"></i>Restaurant Menus
                            </h3>
                            <p class="text-sm text-orange-700 mb-3">Add menu images (paste image URLs, one per line)</p>
                            <textarea 
                                id="menuUrls" 
                                placeholder="Menu Image URLs (one per line)&#10;Example:&#10;https://example.com/breakfast-menu.jpg&#10;https://example.com/lunch-menu.jpg&#10;https://example.com/dinner-menu.jpg" 
                                class="w-full px-4 py-2 border rounded-lg" 
                                rows="4"></textarea>
                            <p class="text-xs text-gray-600 mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                Upload images to Imgur, Cloudinary, or any image host, then paste URLs here
                            </p>
                        </div>
                    </div>
                    
                    <!-- Event-specific fields (hidden by default) -->
                    <div id="eventFields" class="hidden grid md:grid-cols-3 gap-4">
                        <input type="date" id="eventDate" placeholder="Event Date" class="px-4 py-2 border rounded-lg">
                        <input type="time" id="eventStartTime" placeholder="Start Time" class="px-4 py-2 border rounded-lg">
                        <input type="time" id="eventEndTime" placeholder="End Time" class="px-4 py-2 border rounded-lg">
                    </div>
                    
                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-check mr-2"></i>Add Offering
                    </button>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">All Hotel Offerings</h2>
                    <button 
                        onclick="translateAllOfferings()" 
                        id="translateAllBtn"
                        class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-2 rounded-lg hover:from-purple-700 hover:to-pink-700 shadow-lg transition-all">
                        <i class="fas fa-language mr-2"></i>Translate All to 8 Languages
                    </button>
                </div>
                <div class="mb-4 flex gap-2">
                    <button onclick="filterOfferings('all')" class="offering-filter-btn px-4 py-2 rounded bg-blue-500 text-white" data-type="all">All</button>
                    <button onclick="filterOfferings('restaurant')" class="offering-filter-btn px-4 py-2 rounded bg-gray-200" data-type="restaurant"><span id="admin-pill-restaurants">Dining & Drinks</span></button>
                    <button onclick="filterOfferings('event')" class="offering-filter-btn px-4 py-2 rounded bg-gray-200" data-type="event"><span id="admin-pill-events">Events & Entertainment</span></button>
                    <button onclick="filterOfferings('spa')" class="offering-filter-btn px-4 py-2 rounded bg-gray-200" data-type="spa"><span id="admin-pill-spa">Spa</span></button>
                </div>
                <div id="offeringsList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Custom Sections Tab -->
        <div id="customsectionsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">
                    <i class="fas fa-plus-circle mr-2 text-blue-600"></i>
                    Add Custom Section
                </h2>
                <p class="text-gray-600 mb-4">Create additional sections for your hotel homepage (e.g., Pool Bar, Kids Club, Rooftop Lounge)</p>
                <form id="addCustomSectionForm" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <input type="text" id="sectionKey" placeholder="Section Key (e.g., pool-bar)" required class="px-4 py-2 border rounded-lg">
                        <input type="text" id="sectionNameEn" placeholder="Section Name (English)" required class="px-4 py-2 border rounded-lg">
                    </div>
                    <div class="grid md:grid-cols-3 gap-4">
                        <select id="sectionIcon" class="px-4 py-2 border rounded-lg">
                            <option value="fas fa-star">â­ Star</option>
                            <option value="fas fa-swimming-pool">ðŸŠ Pool</option>
                            <option value="fas fa-cocktail">ðŸ¹ Bar</option>
                            <option value="fas fa-child">ðŸ‘¶ Kids</option>
                            <option value="fas fa-gamepad">ðŸŽ® Gaming</option>
                            <option value="fas fa-dumbbell">ðŸ‹ï¸ Fitness</option>
                            <option value="fas fa-graduation-cap">ðŸŽ“ Business Center</option>
                            <option value="fas fa-gift">ðŸŽ Gift Shop</option>
                            <option value="fas fa-coffee">â˜• Cafe</option>
                            <option value="fas fa-music">ðŸŽµ Entertainment</option>
                        </select>
                        <select id="sectionColor" class="px-4 py-2 border rounded-lg">
                            <option value="blue">Blue</option>
                            <option value="purple">Purple</option>
                            <option value="green">Green</option>
                            <option value="orange">Orange</option>
                            <option value="red">Red</option>
                            <option value="pink">Pink</option>
                            <option value="indigo">Indigo</option>
                            <option value="teal">Teal</option>
                        </select>
                        <input type="number" id="sectionOrder" placeholder="Display Order" value="10" class="px-4 py-2 border rounded-lg">
                    </div>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-check mr-2"></i>Create Section
                    </button>
                </form>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">All Custom Sections</h2>
                <div id="customSectionsList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Info Pages Tab -->
        <div id="infopagesTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold"><i class="fas fa-file-alt mr-2 text-purple-600"></i>Info Pages Management</h2>
                        <p class="text-gray-600 mt-1">Create standalone information pages for your guests (not displayed on homepage)</p>
                    </div>
                    <button onclick="showInfoPageModal()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold">
                        <i class="fas fa-plus mr-2"></i>Create New Page
                    </button>
                </div>

                <!-- Info Pages List -->
                <div id="infoPagesContainer" class="space-y-4">
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-3xl"></i>
                        <p class="mt-2">Loading info pages...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Page Editor Modal -->
        <div id="infoPageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
            <div class="min-h-screen px-4 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full my-8">
                    <!-- Modal Header -->
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="text-2xl font-bold" id="infoPageModalTitle">
                            <i class="fas fa-file-alt mr-2"></i>Create Info Page
                        </h3>
                        <button onclick="closeInfoPageModal()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <!-- Modal Body -->
                    <div class="p-6 max-h-[70vh] overflow-y-auto">
                        <form id="infoPageForm" class="space-y-6">
                            <input type="hidden" id="infoPageId" />
                            
                            <!-- Basic Info -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-bold mb-2">
                                        <i class="fas fa-heading mr-1 text-purple-600"></i>Page Title (English) *
                                    </label>
                                    <input type="text" id="infoPageTitle" required 
                                           class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                           placeholder="e.g., Room Phone Extensions">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold mb-2">
                                        <i class="fas fa-key mr-1 text-purple-600"></i>Page Key
                                    </label>
                                    <input type="text" id="infoPageKey" 
                                           class="w-full p-3 border rounded-lg bg-gray-50"
                                           placeholder="Auto-generated" readonly>
                                    <p class="text-xs text-gray-500 mt-1">Used in URL (auto-generated from title)</p>
                                </div>
                            </div>

                            <!-- Visual Settings -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label class="block text-sm font-bold mb-2">
                                        <i class="fas fa-icons mr-1 text-purple-600"></i>Icon
                                    </label>
                                    <select id="infoPageIcon" class="w-full p-3 border rounded-lg">
                                        <option value="fas fa-info-circle">â„¹ï¸ Info</option>
                                        <option value="fas fa-phone">ðŸ“ž Phone</option>
                                        <option value="fas fa-wifi">ðŸ“¶ WiFi</option>
                                        <option value="fas fa-utensils">ðŸ½ï¸ Dining</option>
                                        <option value="fas fa-clock">ðŸ• Hours</option>
                                        <option value="fas fa-parking">ðŸ…¿ï¸ Parking</option>
                                        <option value="fas fa-swimming-pool">ðŸŠ Pool</option>
                                        <option value="fas fa-dumbbell">ðŸ’ª Gym</option>
                                        <option value="fas fa-spa">ðŸ’† Spa</option>
                                        <option value="fas fa-concierge-bell">ðŸ›Žï¸ Concierge</option>
                                        <option value="fas fa-hotel">ðŸ¨ Hotel</option>
                                        <option value="fas fa-shield-alt">ðŸ›¡ï¸ Policy</option>
                                        <option value="fas fa-map-marked-alt">ðŸ—ºï¸ Map</option>
                                        <option value="fas fa-question-circle">â“ FAQ</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold mb-2">
                                        <i class="fas fa-palette mr-1 text-purple-600"></i>Color Theme
                                    </label>
                                    <select id="infoPageColor" class="w-full p-3 border rounded-lg">
                                        <option value="blue">ðŸ”µ Blue</option>
                                        <option value="purple">ðŸŸ£ Purple</option>
                                        <option value="green">ðŸŸ¢ Green</option>
                                        <option value="orange">ðŸŸ  Orange</option>
                                        <option value="red">ðŸ”´ Red</option>
                                        <option value="pink">ðŸ©· Pink</option>
                                        <option value="indigo">ðŸŸ£ Indigo</option>
                                        <option value="teal">ðŸ”· Teal</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold mb-2">
                                        <i class="fas fa-columns mr-1 text-purple-600"></i>Layout
                                    </label>
                                    <select id="infoPageLayout" class="w-full p-3 border rounded-lg">
                                        <option value="single-column">Single Column</option>
                                        <option value="two-column">Two Columns</option>
                                        <option value="card-grid">Card Grid</option>
                                        <option value="table">Table</option>
                                        <option value="accordion">Accordion</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Modern Visual Page Builder - NO CODE REQUIRED! -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <label class="block text-sm font-bold">
                                        <i class="fas fa-magic mr-1 text-purple-600"></i>Page Content Builder - Visual & Simple!
                                    </label>
                                    <button type="button" onclick="toggleBuilderMode()" id="builderModeToggle" class="text-xs px-3 py-1.5 bg-gray-200 rounded hover:bg-gray-300 transition">
                                        <i class="fas fa-code mr-1"></i>Show HTML Editor
                                    </button>
                                </div>
                                
                                <!-- Visual Builder Mode (Default - NO HTML!) -->
                                <div id="visualBuilderContainer" class="border-2 border-dashed border-purple-300 rounded-xl bg-gradient-to-br from-purple-50 to-blue-50 p-4 min-h-[450px]">
                                    <!-- Add Content Blocks Menu -->
                                    <div class="mb-4 bg-white rounded-lg p-4 shadow-md border border-purple-200">
                                        <p class="text-sm font-bold text-purple-700 mb-3 flex items-center">
                                            <i class="fas fa-plus-circle mr-2"></i>
                                            Add Content Block - Click to Add:
                                        </p>
                                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                                            <button type="button" onclick="addContentBlock('heading')" class="px-4 py-3 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 text-sm shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                                <i class="fas fa-heading text-xl mb-1"></i>
                                                <p class="text-xs font-semibold">Heading</p>
                                            </button>
                                            <button type="button" onclick="addContentBlock('text')" class="px-4 py-3 bg-gradient-to-br from-gray-500 to-gray-600 text-white rounded-lg hover:from-gray-600 hover:to-gray-700 text-sm shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                                <i class="fas fa-paragraph text-xl mb-1"></i>
                                                <p class="text-xs font-semibold">Paragraph</p>
                                            </button>
                                            <button type="button" onclick="addContentBlock('list')" class="px-4 py-3 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 text-sm shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                                <i class="fas fa-list text-xl mb-1"></i>
                                                <p class="text-xs font-semibold">List</p>
                                            </button>
                                            <button type="button" onclick="addContentBlock('table')" class="px-4 py-3 bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-lg hover:from-orange-600 hover:to-orange-700 text-sm shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                                <i class="fas fa-table text-xl mb-1"></i>
                                                <p class="text-xs font-semibold">Table</p>
                                            </button>
                                            <button type="button" onclick="addContentBlock('callout')" class="px-4 py-3 bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-lg hover:from-yellow-600 hover:to-yellow-700 text-sm shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                                <i class="fas fa-lightbulb text-xl mb-1"></i>
                                                <p class="text-xs font-semibold">Alert Box</p>
                                            </button>
                                            <button type="button" onclick="addContentBlock('divider')" class="px-4 py-3 bg-gradient-to-br from-gray-400 to-gray-500 text-white rounded-lg hover:from-gray-500 hover:to-gray-600 text-sm shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                                <i class="fas fa-minus text-xl mb-1"></i>
                                                <p class="text-xs font-semibold">Divider</p>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Content Blocks Container (Sortable Blocks!) -->
                                    <div id="contentBlocksContainer" class="space-y-3 min-h-[200px]">
                                        <div id="emptyBuilderState" class="text-center text-gray-500 py-12 bg-white rounded-lg border-2 border-dashed border-gray-300">
                                            <i class="fas fa-cubes text-5xl mb-3 text-purple-300"></i>
                                            <p class="text-lg font-semibold mb-1">No content blocks yet</p>
                                            <p class="text-sm">Click the colorful buttons above to start building your page!</p>
                                            <p class="text-xs mt-2 text-gray-400">No HTML knowledge required - it's drag & drop simple! ðŸŽ¨</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hidden Advanced HTML Editor (for tech-savvy users) -->
                                <textarea id="infoPageContent" rows="15" required
                                          class="hidden w-full p-4 border rounded-lg font-mono text-sm focus:ring-2 focus:ring-purple-500 bg-gray-900 text-green-400"
                                          placeholder="Advanced HTML editor for developers..."></textarea>
                                
                                <div class="mt-3 flex justify-between items-center">
                                    <p class="text-xs text-gray-600 flex items-center gap-2">
                                        <span class="flex items-center gap-1 px-2 py-1 bg-purple-100 rounded">
                                            <i class="fas fa-magic text-purple-600"></i>
                                            <span id="builderHelpText" class="font-semibold text-purple-700">Visual Builder Active - No Coding!</span>
                                        </span>
                                        <span class="text-gray-400">|</span>
                                        <span class="text-gray-500">Add blocks â€¢ Edit â€¢ Reorder â€¢ Delete</span>
                                    </p>
                                    <button type="button" onclick="toggleLivePreview()" id="livePreviewBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-semibold shadow-md">
                                        <i class="fas fa-eye mr-1"></i>Live Preview
                                    </button>
                                </div>
                            </div>

                            <!-- Publish Settings -->
                            <div class="flex gap-6">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="infoPagePublished" checked class="mr-2 w-5 h-5 text-purple-600">
                                    <span class="font-semibold"><i class="fas fa-globe mr-1 text-purple-600"></i>Published (visible to guests)</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="infoPageShowMenu" checked class="mr-2 w-5 h-5 text-purple-600">
                                    <span class="font-semibold"><i class="fas fa-bars mr-1 text-purple-600"></i>Show in Info Menu</span>
                                </label>
                            </div>
                        </form>
                    </div>

                    <!-- Modal Footer -->
                    <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex justify-end gap-3">
                        <button onclick="closeInfoPageModal()" class="px-6 py-3 border rounded-lg hover:bg-gray-100 font-semibold">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                        <button onclick="saveInfoPage()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                            <i class="fas fa-save mr-2"></i>Save Page
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activities Tab -->
        <div id="activitiesTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">All Activities</h2>
                    <button 
                        onclick="translateAllActivities()" 
                        id="translateAllActivitiesBtn"
                        class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-2 rounded-lg hover:from-purple-700 hover:to-pink-700 shadow-lg transition-all">
                        <i class="fas fa-language mr-2"></i>Translate All to 8 Languages
                    </button>
                </div>
                <div id="activitiesList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Callbacks Tab -->
        <div id="callbacksTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div id="callbacksHeader" class="flex items-center">
                        <h2 class="text-2xl font-bold"><i class="fas fa-phone mr-2 text-orange-600"></i>Callback Requests</h2>
                    </div>
                    <span id="callbacksTimestamp" class="text-xs text-gray-500"></span>
                </div>
                <div id="callbacksList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-bold mb-4 md:mb-6"><i class="fas fa-cog mr-2 text-purple-600"></i>Hotel Design Settings</h2>
                
                <!-- Hotel Homepage Link -->
                <div class="mb-6 md:mb-8 p-3 md:p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="text-base md:text-lg font-semibold mb-2 text-blue-800"><i class="fas fa-link mr-2"></i>Your Hotel Homepage</h3>
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 md:gap-4">
                        <input type="text" id="homepageUrl" readonly class="flex-1 px-3 md:px-4 py-2 border rounded-lg bg-white font-mono text-xs md:text-sm" />
                        <button onclick="copyHomepageUrl()" class="px-3 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm md:text-base whitespace-nowrap">
                            <i class="fas fa-copy mr-2"></i><span class="hidden sm:inline">Copy Link</span><span class="sm:hidden">Copy</span>
                        </button>
                        <a id="visitHomepage" href="#" target="_blank" class="px-3 md:px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-center text-sm md:text-base whitespace-nowrap">
                            <i class="fas fa-external-link-alt mr-2"></i><span class="hidden sm:inline">Visit</span><span class="sm:hidden">Open</span>
                        </a>
                    </div>
                </div>

                <form id="settingsForm" class="space-y-6">
                    <!-- Basic Information Section -->
                    <div class="border-b pb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800"><i class="fas fa-hotel mr-2"></i>Basic Information</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-2">Hotel Name</label>
                                <input type="text" id="hotelName" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Paradise Resort & Spa" required />
                                <p class="text-xs text-gray-500 mt-1">This name appears on your homepage and everywhere</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Tagline / Slogan</label>
                                <input type="text" id="hotelTagline" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Discover all we have to offer" />
                                <p class="text-xs text-gray-500 mt-1">Appears below hotel name on hero</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Contact Email</label>
                                <input type="email" id="hotelEmail" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="info@hotel.com" />
                                <p class="text-xs text-gray-500 mt-1">Displayed in footer</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Contact Phone</label>
                                <input type="tel" id="hotelPhone" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="+1 234 567 8900" />
                                <p class="text-xs text-gray-500 mt-1">Displayed in footer</p>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-2">Address</label>
                                <input type="text" id="hotelAddress" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="123 Beach Road, Paradise City" />
                                <p class="text-xs text-gray-500 mt-1">Full hotel address</p>
                            </div>
                        </div>
                    </div>

                    <!-- Branding Section -->
                    <div class="border-b pb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800"><i class="fas fa-palette mr-2"></i>Visual Branding</h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Hotel Logo URL</label>
                                <input type="url" id="brandLogoUrl" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/logo.png" />
                                <p class="text-xs text-gray-500 mt-1">Recommended: PNG or SVG, transparent background, max height 80px</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Hero Background Image URL</label>
                                <input type="url" id="heroImageUrl" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/hero.jpg" />
                                <p class="text-xs text-gray-500 mt-1">Recommended: 1920x600px, high quality, landscape orientation</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Hero Image Effect</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="heroImageEffect" value="none" class="peer sr-only" checked />
                                        <div class="border-2 border-gray-300 rounded-lg p-3 text-center peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:border-blue-400 transition">
                                            <div class="w-full h-12 bg-gradient-to-r from-blue-400 to-green-400 rounded mb-2"></div>
                                            <span class="text-xs font-medium">Original</span>
                                        </div>
                                    </label>
                                    
                                    <label class="cursor-pointer">
                                        <input type="radio" name="heroImageEffect" value="grayscale" class="peer sr-only" />
                                        <div class="border-2 border-gray-300 rounded-lg p-3 text-center peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:border-blue-400 transition">
                                            <div class="w-full h-12 bg-gradient-to-r from-gray-400 to-gray-500 rounded mb-2"></div>
                                            <span class="text-xs font-medium">Grayscale</span>
                                        </div>
                                    </label>
                                    
                                    <label class="cursor-pointer">
                                        <input type="radio" name="heroImageEffect" value="sepia" class="peer sr-only" />
                                        <div class="border-2 border-gray-300 rounded-lg p-3 text-center peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:border-blue-400 transition">
                                            <div class="w-full h-12 bg-gradient-to-r from-yellow-700 to-orange-600 rounded mb-2"></div>
                                            <span class="text-xs font-medium">Sepia</span>
                                        </div>
                                    </label>
                                    
                                    <label class="cursor-pointer">
                                        <input type="radio" name="heroImageEffect" value="blur" class="peer sr-only" />
                                        <div class="border-2 border-gray-300 rounded-lg p-3 text-center peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:border-blue-400 transition">
                                            <div class="w-full h-12 bg-gradient-to-r from-blue-300 to-purple-300 rounded mb-2 opacity-60"></div>
                                            <span class="text-xs font-medium">Blur</span>
                                        </div>
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Choose how your hero background image appears</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Hero Overlay Opacity</label>
                                <div class="flex items-center gap-4">
                                    <input type="range" id="heroOverlayOpacity" min="0" max="100" value="30" class="flex-1" />
                                    <span id="heroOverlayValue" class="text-sm font-medium w-12 text-center">30%</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Dark overlay to improve text readability (0% = no overlay, 100% = completely dark)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Colors Section -->
                    <div class="border-b pb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800"><i class="fas fa-fill-drip mr-2"></i>Color Scheme</h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Primary Color</label>
                                <div class="flex gap-2 mb-2">
                                    <input type="color" id="primaryColor" class="w-16 h-10 border rounded cursor-pointer" />
                                    <input type="text" id="primaryColorText" class="flex-1 px-4 py-2 border rounded-lg font-mono text-sm" placeholder="#3B82F6" />
                                </div>
                                <label class="flex items-center text-sm text-gray-600 cursor-pointer">
                                    <input type="checkbox" id="primaryGradient" class="mr-2" />
                                    <span>Use gradient (Primary â†’ Secondary)</span>
                                </label>
                                <div id="primaryGradientPreview" class="hidden mt-2 h-8 rounded-lg" style="background: linear-gradient(135deg, #3B82F6, #10B981);"></div>
                                <p class="text-xs text-gray-500 mt-1">Main brand color (headers, buttons)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Secondary Color</label>
                                <div class="flex gap-2 mb-2">
                                    <input type="color" id="secondaryColor" class="w-16 h-10 border rounded cursor-pointer" />
                                    <input type="text" id="secondaryColorText" class="flex-1 px-4 py-2 border rounded-lg font-mono text-sm" placeholder="#10B981" />
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Secondary elements & gradient partner</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Accent Color</label>
                                <div class="flex gap-2 mb-2">
                                    <input type="color" id="accentColor" class="w-16 h-10 border rounded cursor-pointer" />
                                    <input type="text" id="accentColorText" class="flex-1 px-4 py-2 border rounded-lg font-mono text-sm" placeholder="#F59E0B" />
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Highlights and badges</p>
                            </div>
                        </div>
                    </div>

                    <!-- Layout Section -->
                    <div class="border-b pb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800"><i class="fas fa-th-large mr-2"></i>Layout Style</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label class="relative cursor-pointer group">
                                <input type="radio" name="layoutStyle" value="modern" class="peer sr-only" />
                                <div class="border-2 border-gray-300 rounded-lg p-4 peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:border-blue-400 transition">
                                    <div class="text-center mb-3">
                                        <i class="fas fa-layer-group text-3xl mb-2 text-blue-600"></i>
                                        <h4 class="font-semibold">Modern</h4>
                                        <p class="text-xs text-gray-500 mt-1">Clean cards with shadows</p>
                                    </div>
                                    <!-- Mini Preview -->
                                    <div class="bg-gray-100 p-3 rounded space-y-2">
                                        <div class="bg-white rounded-xl shadow-md p-2 h-16"></div>
                                        <div class="bg-white rounded-xl shadow-md p-2 h-12"></div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="relative cursor-pointer group">
                                <input type="radio" name="layoutStyle" value="elegant" class="peer sr-only" />
                                <div class="border-2 border-gray-300 rounded-lg p-4 peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:border-blue-400 transition">
                                    <div class="text-center mb-3">
                                        <i class="fas fa-gem text-3xl mb-2 text-purple-600"></i>
                                        <h4 class="font-semibold">Elegant</h4>
                                        <p class="text-xs text-gray-500 mt-1">Luxury with borders</p>
                                    </div>
                                    <!-- Mini Preview -->
                                    <div class="bg-gray-100 p-3 rounded space-y-2">
                                        <div class="bg-white rounded-sm border-2 border-gray-300 p-2 h-16"></div>
                                        <div class="bg-white rounded-sm border-2 border-gray-300 p-2 h-12"></div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="relative cursor-pointer group">
                                <input type="radio" name="layoutStyle" value="minimal" class="peer sr-only" />
                                <div class="border-2 border-gray-300 rounded-lg p-4 peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:border-blue-400 transition">
                                    <div class="text-center mb-3">
                                        <i class="fas fa-minus text-3xl mb-2 text-gray-600"></i>
                                        <h4 class="font-semibold">Minimal</h4>
                                        <p class="text-xs text-gray-500 mt-1">Simple and flat</p>
                                    </div>
                                    <!-- Mini Preview -->
                                    <div class="bg-gray-100 p-3 rounded space-y-2">
                                        <div class="bg-white rounded-md p-2 h-16 border border-gray-200"></div>
                                        <div class="bg-white rounded-md p-2 h-12 border border-gray-200"></div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Typography Section -->
                    <div class="border-b pb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800"><i class="fas fa-font mr-2"></i>Typography</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Font Family</label>
                                <select id="fontFamily" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="inter">Inter (Modern Sans)</option>
                                    <option value="poppins">Poppins (Geometric)</option>
                                    <option value="playfair">Playfair Display (Elegant Serif)</option>
                                    <option value="montserrat">Montserrat (Bold Sans)</option>
                                    <option value="lora">Lora (Classic Serif)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Button Style</label>
                                <select id="buttonStyle" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="rounded">Rounded</option>
                                    <option value="square">Square</option>
                                    <option value="pill">Pill (Fully Rounded)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- UI Elements Section -->
                    <div class="border-b pb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800"><i class="fas fa-cube mr-2"></i>UI Elements</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Card Style</label>
                                <select id="cardStyle" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="shadow">Shadow</option>
                                    <option value="border">Border Only</option>
                                    <option value="elevated">Elevated</option>
                                    <option value="flat">Flat</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Header Style</label>
                                <select id="headerStyle" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="transparent">Transparent Overlay</option>
                                    <option value="solid">Solid Background</option>
                                    <option value="gradient">Gradient</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Homepage Layout Control Section -->
                    <div class="border-b pb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800"><i class="fas fa-th-list mr-2"></i>Homepage Layout Control</h3>
                        <p class="text-sm text-gray-600 mb-4">Control what appears on your homepage and in what order</p>
                        
                        <!-- Hotel Map -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-6 mb-6 shadow-md">
                            <h4 class="font-bold mb-4 text-gray-900 text-lg flex items-center">
                                <i class="fas fa-map-marked-alt mr-3 text-blue-600 text-xl"></i>
                                Interactive Hotel Map Builder
                            </h4>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">
                                        <i class="fas fa-image mr-2 text-indigo-600"></i>Hotel Map Image URL
                                    </label>
                                    <input type="url" id="hotelMapUrl" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="https://example.com/hotel-map.jpg" />
                                    <p class="text-xs text-gray-600 mt-2 flex items-center">
                                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                                        Upload your hotel/resort map image (floor plan, grounds map, aerial view)
                                    </p>
                                </div>
                                
                                <div class="flex items-center justify-between bg-white rounded-lg p-4 border border-gray-200">
                                    <div class="flex-1">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox" id="showHotelMap" class="mr-3 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" />
                                            <span class="text-sm font-semibold text-gray-800">Enable Interactive Map</span>
                                        </label>
                                        <p class="text-xs text-gray-600 mt-1 ml-8">Show floating map button on guest homepage with clickable hotspots</p>
                                    </div>
                                </div>
                                
                                <button onclick="openInteractiveMapBuilder()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold rounded-lg shadow-lg transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                                    <i class="fas fa-pencil-ruler text-lg"></i>
                                    <span>Build Interactive Map (Add Hotspots)</span>
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                                
                                <div id="hotspotsCount" class="text-center text-sm text-gray-600 hidden">
                                    <i class="fas fa-map-pin mr-2 text-indigo-600"></i>
                                    <span id="hotspotsCountText">0 hotspots</span> configured
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section Names (Customization) -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold mb-3 text-gray-800"><i class="fas fa-i-cursor mr-2 text-blue-600"></i>Section Names (Customize Labels)</h4>
                            <p class="text-xs text-gray-500 mb-3">Rename default sections to match your brand (appears on guest homepage)</p>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">ðŸ½ï¸ Restaurants Section Name</label>
                                    <input type="text" id="sectionNameRestaurants" placeholder="e.g., Dining Options" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">ðŸŽ‰ Events Section Name</label>
                                    <input type="text" id="sectionNameEvents" placeholder="e.g., Special Events" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">ðŸ’† Spa Section Name</label>
                                    <input type="text" id="sectionNameSpa" placeholder="e.g., Wellness Center" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">ðŸ›Žï¸ Services Section Name</label>
                                    <input type="text" id="sectionNameService" placeholder="e.g., Hotel Amenities" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">ðŸƒ Activities Section Name</label>
                                    <input type="text" id="sectionNameActivities" placeholder="e.g., Things To Do" class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2"><i class="fas fa-info-circle mr-1"></i>Leave blank to use default names. Changes apply to English version only.</p>
                        </div>
                        
                        <!-- Section Visibility -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold mb-3 text-gray-800"><i class="fas fa-eye mr-2 text-green-600"></i>Section Visibility</h4>
                            <p class="text-xs text-gray-500 mb-3">Toggle which sections appear on your homepage</p>
                            <div id="sectionVisibilityGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                <!-- Will be populated dynamically with default + custom sections -->
                            </div>
                        </div>
                        
                        <!-- Section Order -->
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3 text-gray-800"><i class="fas fa-sort mr-2 text-purple-600"></i>Section Order</h4>
                            <p class="text-xs text-gray-500 mb-3">Drag to reorder how sections appear on your homepage</p>
                            <div id="sectionOrderList" class="space-y-2">
                                <!-- Will be populated dynamically -->
                            </div>
                            <p class="text-xs text-gray-400 mt-3"><i class="fas fa-info-circle mr-1"></i>Drag sections up/down to change their display order</p>
                        </div>
                    </div>

                    <!-- Preview & Save -->
                    <div class="flex gap-4">
                        <button type="button" onclick="previewDesign()" class="flex-1 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold">
                            <i class="fas fa-eye mr-2"></i>Preview Changes
                        </button>
                        <button type="submit" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                            <i class="fas fa-save mr-2"></i>Save Design Settings
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Seasonal Effects Section (inside Settings) -->
            <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6"><i class="fas fa-snowflake mr-2 text-blue-600"></i>Seasonal Effects & Decorations</h2>
                <p class="text-gray-600 mb-6">Add festive effects and decorations to delight your guests during special occasions!</p>
                
                <form id="seasonalForm" class="space-y-6">
                    <!-- Theme Selection -->
                    <div class="border-2 border-dashed border-purple-300 rounded-lg p-6 bg-purple-50">
                        <h3 class="font-bold text-lg mb-4 flex items-center text-purple-800">
                            <i class="fas fa-palette mr-2"></i>Choose Theme
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <label class="theme-option cursor-pointer">
                                <input type="radio" name="theme" value="none" class="hidden theme-radio" checked>
                                <div class="theme-card border-2 rounded-lg p-4 text-center hover:shadow-lg transition">
                                    <i class="fas fa-ban text-3xl mb-2 text-gray-500"></i>
                                    <div class="font-semibold">None</div>
                                    <div class="text-xs text-gray-500">No effects</div>
                                </div>
                            </label>
                            
                            <label class="theme-option cursor-pointer">
                                <input type="radio" name="theme" value="christmas" class="hidden theme-radio">
                                <div class="theme-card border-2 rounded-lg p-4 text-center hover:shadow-lg transition">
                                    <i class="fas fa-tree text-3xl mb-2 text-green-600"></i>
                                    <div class="font-semibold">Christmas</div>
                                    <div class="text-xs text-gray-500">Snow & decorations</div>
                                </div>
                            </label>
                            
                            <label class="theme-option cursor-pointer">
                                <input type="radio" name="theme" value="newyear" class="hidden theme-radio">
                                <div class="theme-card border-2 rounded-lg p-4 text-center hover:shadow-lg transition">
                                    <i class="fas fa-champagne-glasses text-3xl mb-2 text-yellow-600"></i>
                                    <div class="font-semibold">New Year</div>
                                    <div class="text-xs text-gray-500">Fireworks & confetti</div>
                                </div>
                            </label>
                            
                            <label class="theme-option cursor-pointer">
                                <input type="radio" name="theme" value="easter" class="hidden theme-radio">
                                <div class="theme-card border-2 rounded-lg p-4 text-center hover:shadow-lg transition">
                                    <i class="fas fa-egg text-3xl mb-2 text-pink-600"></i>
                                    <div class="font-semibold">Easter</div>
                                    <div class="text-xs text-gray-500">Spring colors</div>
                                </div>
                            </label>
                            
                            <label class="theme-option cursor-pointer">
                                <input type="radio" name="theme" value="ramadan" class="hidden theme-radio">
                                <div class="theme-card border-2 rounded-lg p-4 text-center hover:shadow-lg transition">
                                    <i class="fas fa-moon text-3xl mb-2 text-indigo-600"></i>
                                    <div class="font-semibold">Ramadan</div>
                                    <div class="text-xs text-gray-500">Lanterns & stars</div>
                                </div>
                            </label>
                            
                            <label class="theme-option cursor-pointer">
                                <input type="radio" name="theme" value="eid" class="hidden theme-radio">
                                <div class="theme-card border-2 rounded-lg p-4 text-center hover:shadow-lg transition">
                                    <i class="fas fa-star-and-crescent text-3xl mb-2 text-green-700"></i>
                                    <div class="font-semibold">Eid</div>
                                    <div class="text-xs text-gray-500">Celebration mode</div>
                                </div>
                            </label>
                            
                            <label class="theme-option cursor-pointer">
                                <input type="radio" name="theme" value="halloween" class="hidden theme-radio">
                                <div class="theme-card border-2 rounded-lg p-4 text-center hover:shadow-lg transition">
                                    <i class="fas fa-ghost text-3xl mb-2 text-orange-600"></i>
                                    <div class="font-semibold">Halloween</div>
                                    <div class="text-xs text-gray-500">Spooky vibes</div>
                                </div>
                            </label>
                            
                            <label class="theme-option cursor-pointer">
                                <input type="radio" name="theme" value="valentines" class="hidden theme-radio">
                                <div class="theme-card border-2 rounded-lg p-4 text-center hover:shadow-lg transition">
                                    <i class="fas fa-heart text-3xl mb-2 text-red-600"></i>
                                    <div class="font-semibold">Valentine's</div>
                                    <div class="text-xs text-gray-500">Hearts & love</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Effects Toggle -->
                    <div class="border rounded-lg p-6 bg-gray-50">
                        <h3 class="font-bold text-lg mb-4"><i class="fas fa-magic mr-2 text-purple-600"></i>Visual Effects</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center p-3 border rounded-lg hover:bg-white cursor-pointer">
                                <input type="checkbox" id="enableSnow" class="mr-3 w-5 h-5 text-blue-600">
                                <div class="flex-1">
                                    <div class="font-semibold"><i class="fas fa-snowflake mr-2 text-blue-400"></i>Snow Effect</div>
                                    <div class="text-xs text-gray-500">Falling snowflakes animation</div>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-3 border rounded-lg hover:bg-white cursor-pointer">
                                <input type="checkbox" id="enableFireworks" class="mr-3 w-5 h-5 text-blue-600">
                                <div class="flex-1">
                                    <div class="font-semibold"><i class="fas fa-burst mr-2 text-yellow-500"></i>Fireworks</div>
                                    <div class="text-xs text-gray-500">Celebration fireworks</div>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-3 border rounded-lg hover:bg-white cursor-pointer">
                                <input type="checkbox" id="enableConfetti" class="mr-3 w-5 h-5 text-blue-600">
                                <div class="flex-1">
                                    <div class="font-semibold"><i class="fas fa-wand-magic-sparkles mr-2 text-purple-500"></i>Confetti</div>
                                    <div class="text-xs text-gray-500">Colorful confetti rain</div>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-3 border rounded-lg hover:bg-white cursor-pointer">
                                <input type="checkbox" id="enableLights" class="mr-3 w-5 h-5 text-blue-600">
                                <div class="flex-1">
                                    <div class="font-semibold"><i class="fas fa-lightbulb mr-2 text-yellow-400"></i>Festive Lights</div>
                                    <div class="text-xs text-gray-500">Twinkling string lights</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Custom Message -->
                    <div class="border rounded-lg p-6">
                        <h3 class="font-bold text-lg mb-4"><i class="fas fa-comment-dots mr-2 text-green-600"></i>Custom Greeting Message</h3>
                        <input type="text" id="customMessage" placeholder="e.g., Merry Christmas! ðŸŽ„ or Happy Eid! ðŸŒ™" class="w-full px-4 py-3 border rounded-lg text-lg">
                        <p class="text-xs text-gray-500 mt-2">This message will appear prominently on your hotel page</p>
                    </div>
                    
                    <!-- Profile Overlay -->
                    <div class="border rounded-lg p-6 bg-gradient-to-r from-orange-50 to-pink-50">
                        <h3 class="font-bold text-lg mb-4"><i class="fas fa-hat-wizard mr-2 text-orange-600"></i>Fun Profile Overlays</h3>
                        <label class="flex items-center mb-3">
                            <input type="checkbox" id="enableOverlay" class="mr-3 w-5 h-5">
                            <span class="font-medium">Enable overlay decorations</span>
                        </label>
                        <div id="overlayOptions" class="hidden grid grid-cols-3 md:grid-cols-5 gap-3 mt-4">
                            <label class="overlay-choice cursor-pointer">
                                <input type="radio" name="overlay" value="santa_hat" class="hidden">
                                <div class="border-2 rounded-lg p-3 text-center hover:shadow-lg transition">
                                    <div class="text-2xl mb-1">ðŸŽ…</div>
                                    <div class="text-xs">Santa Hat</div>
                                </div>
                            </label>
                            <label class="overlay-choice cursor-pointer">
                                <input type="radio" name="overlay" value="party_hat" class="hidden">
                                <div class="border-2 rounded-lg p-3 text-center hover:shadow-lg transition">
                                    <div class="text-2xl mb-1">ðŸŽ‰</div>
                                    <div class="text-xs">Party Hat</div>
                                </div>
                            </label>
                            <label class="overlay-choice cursor-pointer">
                                <input type="radio" name="overlay" value="bunny_ears" class="hidden">
                                <div class="border-2 rounded-lg p-3 text-center hover:shadow-lg transition">
                                    <div class="text-2xl mb-1">ðŸ°</div>
                                    <div class="text-xs">Bunny Ears</div>
                                </div>
                            </label>
                            <label class="overlay-choice cursor-pointer">
                                <input type="radio" name="overlay" value="crown" class="hidden">
                                <div class="border-2 rounded-lg p-3 text-center hover:shadow-lg transition">
                                    <div class="text-2xl mb-1">ðŸ‘‘</div>
                                    <div class="text-xs">Crown</div>
                                </div>
                            </label>
                            <label class="overlay-choice cursor-pointer">
                                <input type="radio" name="overlay" value="halo" class="hidden">
                                <div class="border-2 rounded-lg p-3 text-center hover:shadow-lg transition">
                                    <div class="text-2xl mb-1">ðŸ˜‡</div>
                                    <div class="text-xs">Halo</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Preview & Actions -->
                    <div class="flex justify-between items-center pt-4 border-t">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="isActive" class="mr-2 w-5 h-5 text-green-600">
                                <span class="font-semibold text-lg">ðŸŽ¯ Activate Effects Now</span>
                            </label>
                            <p class="text-xs text-gray-500 ml-7">Turn on/off all seasonal effects</p>
                        </div>
                        <div class="flex gap-3">
                            <button type="button" onclick="previewSeasonalEffects()" class="px-6 py-3 border-2 border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 font-semibold">
                                <i class="fas fa-eye mr-2"></i>Preview
                            </button>
                            <button type="submit" class="px-6 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg hover:from-green-700 hover:to-blue-700 font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Settings
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Quick Presets -->
                <div class="mt-8 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border-2 border-blue-200">
                    <h3 class="font-bold mb-3"><i class="fas fa-bolt mr-2 text-yellow-500"></i>Quick Presets</h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="applyPreset('christmas')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ðŸŽ„ Christmas Mode
                        </button>
                        <button onclick="applyPreset('newyear')" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                            ðŸŽ† New Year Mode
                        </button>
                        <button onclick="applyPreset('ramadan')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            ðŸŒ™ Ramadan Mode
                        </button>
                        <button onclick="applyPreset('eid')" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                            â­ Eid Mode
                        </button>
                        <button onclick="applyPreset('none')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            ðŸš« Clear All
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Notification Settings Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-bell mr-2 text-yellow-500"></i>
                        Notification Settings
                    </h2>
                    <button onclick="testNotificationSound()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-volume-up mr-2"></i>Test Sound
                    </button>
                </div>
                
                <form id="notificationSettingsForm" class="space-y-6">
                    <!-- Sound Enable/Disable -->
                    <div class="border-b pb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">
                            <i class="fas fa-volume-high mr-2"></i>Sound Settings
                        </h3>
                        
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="soundEnabled" class="w-5 h-5 text-blue-600 rounded">
                                    <span class="font-semibold text-lg">Enable Notification Sounds</span>
                                </label>
                                <p class="text-sm text-gray-500 ml-8 mt-1">Turn on/off all notification beeps</p>
                            </div>
                        </div>
                        
                        <div id="soundOptions" class="mt-4 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Beep Frequency (Hz)</label>
                                    <input type="number" id="beepFrequency" min="200" max="2000" step="50" 
                                           class="w-full px-4 py-2 border rounded-lg" value="800">
                                    <p class="text-xs text-gray-500 mt-1">Higher = sharper sound (200-2000)</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Beep Duration (ms)</label>
                                    <input type="number" id="beepDuration" min="100" max="2000" step="100" 
                                           class="w-full px-4 py-2 border rounded-lg" value="500">
                                    <p class="text-xs text-gray-500 mt-1">Length of each beep (100-2000)</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Repeat Interval (ms)</label>
                                    <input type="number" id="beepInterval" min="1000" max="10000" step="500" 
                                           class="w-full px-4 py-2 border rounded-lg" value="3000">
                                    <p class="text-xs text-gray-500 mt-1">Time between beeps (1000-10000)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Persistent Beep Settings -->
                    <div class="border-b pb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">
                            <i class="fas fa-repeat mr-2"></i>Persistent Beeping
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">
                            When enabled, notifications will continue beeping until you click on them (like Facebook/WhatsApp).
                        </p>
                        
                        <div class="flex items-center justify-between p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-4">
                            <div>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="persistentBeep" class="w-5 h-5 text-yellow-600 rounded">
                                    <span class="font-semibold text-lg">âš¡ Enable Persistent Beeping</span>
                                </label>
                                <p class="text-sm text-gray-500 ml-8 mt-1">Beep won't stop until you acknowledge the notification</p>
                            </div>
                        </div>
                        
                        <div id="persistentOptions" class="space-y-3">
                            <p class="font-medium text-gray-700">Choose which notification types should beep persistently:</p>
                            
                            <label class="flex items-center gap-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="persistentBookings" class="w-5 h-5 text-blue-600 rounded">
                                <i class="fas fa-calendar-check text-blue-600"></i>
                                <div>
                                    <span class="font-semibold">Restaurant Bookings</span>
                                    <p class="text-xs text-gray-500">Beep until acknowledged when new table reservations arrive</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="persistentCallbacks" class="w-5 h-5 text-green-600 rounded">
                                <i class="fas fa-phone text-green-600"></i>
                                <div>
                                    <span class="font-semibold">Callback Requests</span>
                                    <p class="text-xs text-gray-500">Beep until acknowledged when guests request callbacks</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="persistentFeedback" class="w-5 h-5 text-purple-600 rounded">
                                <i class="fas fa-star text-purple-600"></i>
                                <div>
                                    <span class="font-semibold">Feedback Submissions</span>
                                    <p class="text-xs text-gray-500">Beep until acknowledged when new feedback is received</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="persistentChat" class="w-5 h-5 text-orange-600 rounded">
                                <i class="fas fa-comments text-orange-600"></i>
                                <div>
                                    <span class="font-semibold">Chat Messages</span>
                                    <p class="text-xs text-gray-500">Beep until acknowledged when new chat messages arrive</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Popup Settings -->
                    <div class="border-b pb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">
                            <i class="fas fa-window-maximize mr-2"></i>Popup Settings
                        </h3>
                        
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg mb-4">
                            <div>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="showPopup" class="w-5 h-5 text-blue-600 rounded">
                                    <span class="font-semibold text-lg">Show Notification Popup</span>
                                </label>
                                <p class="text-sm text-gray-500 ml-8 mt-1">Display a popup when new notifications arrive</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Auto-Close Timer (seconds)</label>
                            <input type="number" id="popupAutoClose" min="0" max="60" 
                                   class="w-full px-4 py-2 border rounded-lg" value="0">
                            <p class="text-xs text-gray-500 mt-1">0 = Manual close only, 1-60 = Auto-close after X seconds</p>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="loadNotificationSettings()" 
                                class="px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 font-semibold">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                        <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                            <i class="fas fa-save mr-2"></i>Save Notification Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

        <!-- AI Chatbot Tab -->
        <div id="chatbotTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">
                    <i class="fas fa-robot mr-2 text-purple-600"></i>
                    AI Chatbot - Knowledge Base Management
                </h2>
                <p class="text-gray-600 mb-6">
                    Create a smart AI assistant that answers guest questions using your hotel's information. Upload FAQs, policies, and amenities details.
                </p>
                
                <!-- Analytics Section -->
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-6 mb-6 border-2 border-indigo-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">
                            <i class="fas fa-chart-line mr-2 text-indigo-600"></i>Chatbot Analytics
                        </h3>
                        <button onclick="toggleAnalytics()" id="analyticsToggleBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            <i class="fas fa-chart-bar mr-2"></i>View Analytics
                        </button>
                    </div>
                    
                    <div id="analyticsSection" class="hidden">
                        <!-- Stats Overview -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-lg p-4 shadow">
                                <div class="text-sm text-gray-600 mb-1">Total Conversations</div>
                                <div class="text-2xl font-bold text-indigo-600" id="statTotalConversations">0</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow">
                                <div class="text-sm text-gray-600 mb-1">Total Messages</div>
                                <div class="text-2xl font-bold text-purple-600" id="statTotalMessages">0</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow">
                                <div class="text-sm text-gray-600 mb-1">Avg Response Time</div>
                                <div class="text-2xl font-bold text-blue-600" id="statAvgResponseTime">0s</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow">
                                <div class="text-sm text-gray-600 mb-1">Today's Chats</div>
                                <div class="text-2xl font-bold text-green-600" id="statTodayChats">0</div>
                            </div>
                        </div>
                        
                        <!-- Most Asked Questions -->
                        <div class="bg-white rounded-lg p-6 shadow mb-6">
                            <h4 class="text-lg font-bold mb-4">
                                <i class="fas fa-fire mr-2 text-orange-500"></i>Most Asked Questions (Top 10)
                            </h4>
                            <div id="topQuestionsList" class="space-y-2">
                                <p class="text-gray-500">Loading...</p>
                            </div>
                        </div>
                        
                        <!-- Chat History -->
                        <div class="bg-white rounded-lg p-6 shadow">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-bold">
                                    <i class="fas fa-history mr-2 text-blue-600"></i>Recent Chat History
                                </h4>
                                <div class="flex gap-2">
                                    <input type="date" id="filterDate" class="px-3 py-2 border rounded-lg text-sm" onchange="loadChatHistory()">
                                    <input type="text" id="searchQuery" placeholder="Search messages..." class="px-3 py-2 border rounded-lg text-sm w-64" onkeyup="if(event.key==='Enter') loadChatHistory()">
                                    <button onclick="loadChatHistory()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="chatHistoryList" class="space-y-4 max-h-96 overflow-y-auto">
                                <p class="text-gray-500">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chatbot Settings -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-cog mr-2"></i>Chatbot Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="chatbotEnabled" class="w-5 h-5 rounded">
                                <span class="font-medium">Enable AI Chatbot</span>
                            </label>
                            <p class="text-sm text-gray-600 ml-8 mt-1">Show chat widget on guest page</p>
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Chatbot Name</label>
                            <input type="text" id="chatbotName" placeholder="e.g., Paradise Assistant" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Chat Widget Color</label>
                            <div class="flex gap-2">
                                <input type="color" id="chatbotPrimaryColor" value="#667eea" class="w-16 h-10 border rounded cursor-pointer">
                                <input type="text" id="chatbotPrimaryColorText" value="#667eea" placeholder="#667eea" class="flex-1 px-4 py-2 border rounded-lg font-mono text-sm">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Color for chat button and message bubbles</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block font-medium mb-2">Greeting Message</label>
                            <textarea id="chatbotGreeting" rows="2" placeholder="Welcome message for guests..." class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                    </div>
                    <button onclick="saveChatbotSettings()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-save mr-2"></i>Save Settings
                    </button>
                </div>

                <!-- Auto-Sync Knowledge Base -->
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">
                                <i class="fas fa-sync-alt mr-2 text-blue-600"></i>Auto-Sync Hotel Data
                            </h3>
                            <p class="text-gray-700 mb-4">
                                Automatically import all your hotel's offerings (restaurants, spa, events) and activities into the AI chatbot's knowledge base. 
                                This ensures guests can ask about everything you offer!
                            </p>
                            <button onclick="syncKnowledgeBase()" id="syncBtn" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition font-semibold shadow-lg">
                                <i class="fas fa-sync-alt mr-2"></i>Sync All Hotel Data Now
                            </button>
                            <p class="text-sm text-gray-500 mt-3">
                                <i class="fas fa-info-circle mr-1"></i>
                                This will sync: Restaurants, Spa Services, Events, Activities, and more. Run this whenever you add new offerings.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Add New Document -->
                <div class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-file-upload mr-2 text-green-600"></i>Add Knowledge Document</h3>
                    <form id="addDocumentForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block font-medium mb-2">Document Title *</label>
                                <input type="text" id="docTitle" required placeholder="e.g., Check-in & Check-out Policy" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block font-medium mb-2">Category</label>
                                <select id="docType" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="faq">FAQ</option>
                                    <option value="policy">Policy</option>
                                    <option value="amenity">Amenity Info</option>
                                    <option value="general">General Info</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Content *</label>
                            <textarea id="docContent" required rows="6" placeholder="Enter detailed information that guests might ask about..." class="w-full px-4 py-2 border rounded-lg"></textarea>
                            <p class="text-sm text-gray-500 mt-2">
                                <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                                Tip: Be specific and detailed. Include times, prices, locations, and procedures. The AI will use this to answer questions accurately.
                            </p>
                        </div>
                        <button type="submit" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold">
                            <i class="fas fa-plus mr-2"></i>Add Document & Create Chunks
                        </button>
                    </form>
                </div>

                <!-- Documents List -->
                <div class="bg-white rounded-lg border p-6">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-database mr-2 text-blue-600"></i>Knowledge Base Documents</h3>
                    <div id="documentsList" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading documents...
                        </p>
                    </div>
                </div>
            </div>
        </div>

    <!-- Edit Document Modal -->
    <div id="editDocumentModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold"><i class="fas fa-edit mr-2 text-blue-600"></i>Edit Knowledge Document</h3>
                <button onclick="closeEditDocumentModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="editDocumentForm" class="space-y-4">
                <input type="hidden" id="editDocId" />
                <div>
                    <label class="block font-medium mb-2">Document Title *</label>
                    <input type="text" id="editDocTitle" required placeholder="e.g., Check-in & Check-out Policy" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block font-medium mb-2">Category</label>
                    <select id="editDocType" class="w-full px-4 py-2 border rounded-lg">
                        <option value="faq">FAQ</option>
                        <option value="policy">Policy</option>
                        <option value="amenity">Amenity Info</option>
                        <option value="general">General Info</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium mb-2">Content *</label>
                    <textarea id="editDocContent" required rows="8" placeholder="Enter detailed information..." class="w-full px-4 py-2 border rounded-lg"></textarea>
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                        Tip: When you save, the AI will automatically re-chunk this content for better search.
                    </p>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeEditDocumentModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Support Ticket Modal -->
    <div id="supportModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold"><i class="fas fa-ticket-alt mr-2 text-orange-600"></i>Create Support Ticket</h3>
                <button onclick="closeSupportModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="supportTicketForm" class="space-y-4">
                <div>
                    <label class="block font-medium mb-2">Subject *</label>
                    <input type="text" id="ticketSubject" required class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block font-medium mb-2">Category</label>
                    <select id="ticketCategory" class="w-full px-4 py-2 border rounded-lg">
                        <option value="general">General Inquiry</option>
                        <option value="technical">Technical Issue</option>
                        <option value="billing">Billing Question</option>
                        <option value="feature_request">Feature Request</option>
                        <option value="bug_report">Bug Report</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium mb-2">Priority</label>
                    <select id="ticketPriority" class="w-full px-4 py-2 border rounded-lg">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium mb-2">Description *</label>
                    <textarea id="ticketDescription" required class="w-full px-4 py-2 border rounded-lg" rows="5" placeholder="Please describe your issue or question in detail..."></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeSupportModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700">
                        <i class="fas fa-paper-plane mr-2"></i>Submit Ticket
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Restaurants Management Tab -->
    <div id="restaurantsTab" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="fas fa-utensils mr-2 text-orange-600"></i>
                Restaurant Reservations
            </h2>
            <p class="text-gray-600 mb-6">
                Manage restaurant table bookings, time slots, and floor plans. Select a restaurant below to view its management dashboard.
            </p>
            
            <!-- Restaurant Selector -->
            <div class="mb-6">
                <label class="block text-sm font-semibold mb-2">Select Restaurant:</label>
                <select id="restaurantSelector" class="w-full md:w-96 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    <option value="">Loading restaurants...</option>
                </select>
            </div>
            
            <!-- Quick Stats -->
            <div id="restaurantQuickStats" class="grid md:grid-cols-4 gap-4 mb-6 hidden">
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-sm text-blue-600 font-semibold">Today's Reservations</div>
                    <div class="text-2xl font-bold text-blue-700" id="statTodayReservations">0</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-sm text-green-600 font-semibold">Tables Available</div>
                    <div class="text-2xl font-bold text-green-700" id="statTablesAvailable">0</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4">
                    <div class="text-sm text-purple-600 font-semibold">Time Slots Today</div>
                    <div class="text-2xl font-bold text-purple-700" id="statSlotsToday">0</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-4">
                    <div class="text-sm text-orange-600 font-semibold">Pending Confirmations</div>
                    <div class="text-2xl font-bold text-orange-700" id="statPending">0</div>
                </div>
            </div>
            
            <!-- Action Button -->
            <div id="restaurantActionButton" class="hidden">
                <button onclick="openRestaurantManagement()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold shadow-lg">
                    <i class="fas fa-external-link-alt mr-2"></i>Open Restaurant Management Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- Beach Management Tab -->
    <div id="beachTab" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="fas fa-umbrella-beach mr-2 text-blue-600"></i>
                Beach Booking Management
            </h2>
            <p class="text-gray-600 mb-6">
                Configure your beach spots, create interactive beach maps, and manage guest bookings for umbrellas, cabanas, and loungers.
            </p>
            
            <!-- Beach Settings -->
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg p-6 mb-6 border-2 border-blue-200">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-cog mr-2 text-blue-600"></i>Beach Settings
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="beachBookingEnabled" class="w-5 h-5 rounded">
                            <span class="font-medium">Enable Beach Booking</span>
                        </label>
                        <p class="text-sm text-gray-600 ml-8 mt-1">Allow guests to reserve beach spots online</p>
                    </div>
                    <div>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="freeForGuests" class="w-5 h-5 rounded" checked>
                            <span class="font-medium">Free for Hotel Guests</span>
                        </label>
                        <p class="text-sm text-gray-600 ml-8 mt-1">No charge for registered guests</p>
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Opening Time</label>
                        <input type="time" id="openingTime" value="08:00" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Closing Time</label>
                        <input type="time" id="closingTime" value="18:00" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Advance Booking (days)</label>
                        <input type="number" id="advanceBookingDays" value="7" min="1" max="30" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block font-medium mb-2">Max Duration (hours)</label>
                        <input type="number" id="maxDurationHours" value="12" min="1" max="24" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <button onclick="saveBeachSettings()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-save mr-2"></i>Save Settings
                </button>
            </div>

            <!-- Time Slots Management -->
            <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-lg p-6 mb-6 border-2 border-green-200">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-clock mr-2 text-green-600"></i>Time Slots Management
                </h3>
                <p class="text-sm text-gray-600 mb-4">Configure booking time slots that guests can choose from</p>
                
                <div id="timeSlotsContainer" class="space-y-4 mb-4">
                    <!-- Time slots will be dynamically loaded here -->
                </div>
                
                <div class="flex gap-2">
                    <button onclick="addTimeSlot()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-plus mr-2"></i>Add Time Slot
                    </button>
                    <button onclick="saveTimeSlots()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-save mr-2"></i>Save Time Slots
                    </button>
                </div>
            </div>

            <!-- Beach Card Customization -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 mb-6 border-2 border-purple-200">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-palette mr-2 text-purple-600"></i>Beach Card Customization
                </h3>
                <p class="text-sm text-gray-600 mb-4">Customize the text displayed on the guest-facing beach booking card</p>
                
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block font-medium mb-2">
                            <i class="fas fa-heading mr-2 text-purple-600"></i>Card Title
                        </label>
                        <input type="text" id="cardTitle" placeholder="Beach Booking" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        <p class="text-xs text-gray-500 mt-1">Main heading for the beach booking section</p>
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2">
                            <i class="fas fa-text-height mr-2 text-purple-600"></i>Card Subtitle
                        </label>
                        <input type="text" id="cardSubtitle" placeholder="Reserve your perfect spot by the sea! Select from umbrellas, cabanas, and premium locations." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        <p class="text-xs text-gray-500 mt-1">Description text below the title</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-check-circle mr-2 text-green-600"></i>Feature 1 Text
                            </label>
                            <input type="text" id="feature1Text" placeholder="Free for Hotel Guests" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-check-circle mr-2 text-green-600"></i>Feature 2 Text
                            </label>
                            <input type="text" id="feature2Text" placeholder="Book Up to 7 Days Ahead" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-check-circle mr-2 text-green-600"></i>Feature 3 Text
                            </label>
                            <input type="text" id="feature3Text" placeholder="QR Code Check-in" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-umbrella-beach mr-2 text-blue-600"></i>Umbrellas Category Label
                            </label>
                            <input type="text" id="umbrellasLabel" placeholder="Umbrellas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-umbrella-beach mr-2 text-blue-600"></i>Umbrellas Description
                            </label>
                            <input type="text" id="umbrellasDesc" placeholder="Classic Beach" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-home mr-2 text-orange-600"></i>Cabanas Category Label
                            </label>
                            <input type="text" id="cabanasLabel" placeholder="Cabanas" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-home mr-2 text-orange-600"></i>Cabanas Description
                            </label>
                            <input type="text" id="cabanasDesc" placeholder="Private & Cozy" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-bed mr-2 text-purple-600"></i>Loungers Category Label
                            </label>
                            <input type="text" id="loungersLabel" placeholder="Loungers" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-bed mr-2 text-purple-600"></i>Loungers Description
                            </label>
                            <input type="text" id="loungersDesc" placeholder="Relax in Style" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-star mr-2 text-yellow-600"></i>Daybeds Category Label
                            </label>
                            <input type="text" id="daybedsLabel" placeholder="Daybeds" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block font-medium mb-2">
                                <i class="fas fa-star mr-2 text-yellow-600"></i>Daybeds Description
                            </label>
                            <input type="text" id="daybedsDesc" placeholder="Ultimate Comfort" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2">
                            <i class="fas fa-mouse-pointer mr-2 text-purple-600"></i>Button Text
                        </label>
                        <input type="text" id="buttonText" placeholder="Book Your Spot Now" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        <p class="text-xs text-gray-500 mt-1">Text for the main call-to-action button</p>
                    </div>
                    
                    <div class="col-span-full border-t pt-4 mt-4">
                        <h4 class="text-lg font-bold mb-4">
                            <i class="fas fa-palette mr-2 text-purple-600"></i>Color Customization
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block font-medium mb-2">
                                    <i class="fas fa-paint-brush mr-2 text-blue-600"></i>Background Color (From)
                                </label>
                                <div class="flex gap-2">
                                    <input type="color" id="bgColorFrom" value="#3b82f6" class="w-20 h-10 rounded cursor-pointer">
                                    <input type="text" id="bgColorFromText" value="#3b82f6" class="flex-1 px-4 py-2 border rounded-lg font-mono text-sm" readonly>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Starting gradient color</p>
                            </div>
                            
                            <div>
                                <label class="block font-medium mb-2">
                                    <i class="fas fa-paint-brush mr-2 text-cyan-600"></i>Background Color (To)
                                </label>
                                <div class="flex gap-2">
                                    <input type="color" id="bgColorTo" value="#06b6d4" class="w-20 h-10 rounded cursor-pointer">
                                    <input type="text" id="bgColorToText" value="#06b6d4" class="flex-1 px-4 py-2 border rounded-lg font-mono text-sm" readonly>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Ending gradient color</p>
                            </div>
                            
                            <div>
                                <label class="block font-medium mb-2">
                                    <i class="fas fa-heading mr-2 text-gray-600"></i>Text Color
                                </label>
                                <div class="flex gap-2">
                                    <input type="color" id="textColor" value="#ffffff" class="w-20 h-10 rounded cursor-pointer">
                                    <input type="text" id="textColorText" value="#ffffff" class="flex-1 px-4 py-2 border rounded-lg font-mono text-sm" readonly>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Main text color</p>
                            </div>
                            
                            <div>
                                <label class="block font-medium mb-2">
                                    <i class="fas fa-mouse-pointer mr-2 text-purple-600"></i>Button Color (From)
                                </label>
                                <div class="flex gap-2">
                                    <input type="color" id="buttonColorFrom" value="#ffffff" class="w-20 h-10 rounded cursor-pointer">
                                    <input type="text" id="buttonColorFromText" value="#ffffff" class="flex-1 px-4 py-2 border rounded-lg font-mono text-sm" readonly>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Button background start</p>
                            </div>
                            
                            <div>
                                <label class="block font-medium mb-2">
                                    <i class="fas fa-mouse-pointer mr-2 text-purple-600"></i>Button Color (To)
                                </label>
                                <div class="flex gap-2">
                                    <input type="color" id="buttonColorTo" value="#ffffff" class="w-20 h-10 rounded cursor-pointer">
                                    <input type="text" id="buttonColorToText" value="#ffffff" class="flex-1 px-4 py-2 border rounded-lg font-mono text-sm" readonly>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Button background end</p>
                            </div>
                            
                            <div>
                                <label class="block font-medium mb-2">
                                    <i class="fas fa-font mr-2 text-white"></i>Button Text Color
                                </label>
                                <div class="flex gap-2">
                                    <input type="color" id="buttonTextColor" value="#3b82f6" class="w-20 h-10 rounded cursor-pointer">
                                    <input type="text" id="buttonTextColorText" value="#3b82f6" class="flex-1 px-4 py-2 border rounded-lg font-mono text-sm" readonly>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Button text color</p>
                            </div>
                        </div>
                        
                        <!-- Color Preview -->
                        <div class="mt-6 p-6 rounded-xl shadow-lg" id="colorPreview" style="background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);">
                            <div class="text-center">
                                <h3 class="text-2xl font-bold mb-2" id="previewTitle" style="color: #ffffff;">Beach Booking</h3>
                                <p class="mb-4 opacity-80" id="previewSubtitle" style="color: #ffffff;">Reserve your perfect spot</p>
                                <button class="px-6 py-3 rounded-xl font-semibold shadow-lg transition-transform hover:scale-105" id="previewButton" style="background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%); color: #3b82f6;">
                                    Book Your Spot Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="saveBeachCardCustomization()" class="mt-4 px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition shadow-lg">
                    <i class="fas fa-save mr-2"></i>Save Card Customization
                </button>
            </div>

            <!-- Important Information Customization -->
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg p-6 mb-6 border-2 border-blue-200">
                <h3 class="text-xl font-bold mb-4">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>Important Information
                </h3>
                <p class="text-sm text-gray-600 mb-4">Customize the important information displayed on the guest booking confirmation page</p>
                
                <div>
                    <label class="block font-medium mb-2">
                        <i class="fas fa-list-ul mr-2 text-blue-600"></i>Important Information (One item per line)
                    </label>
                    <textarea id="importantInformation" rows="6" placeholder="Please arrive 10 minutes before your time slot&#10;Bring your QR code (printed or on phone)&#10;Beach towels provided by hotel&#10;Late arrivals may result in reduced time" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Each line will appear as a separate bullet point on the confirmation page</p>
                </div>
                
                <button onclick="saveImportantInformation()" class="mt-4 px-6 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg hover:from-blue-700 hover:to-cyan-700 transition shadow-lg">
                    <i class="fas fa-save mr-2"></i>Save Important Information
                </button>
            </div>

            <!-- Beach Map Designer -->
            <div class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">
                        <i class="fas fa-map-marked-alt mr-2 text-cyan-600"></i>Beach Map Designer
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="openBeachMapDesigner()" class="px-4 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-lg hover:from-cyan-700 hover:to-blue-700 transition">
                            <i class="fas fa-paint-brush mr-2"></i>Design Beach Map
                        </button>
                    </div>
                </div>
                <p class="text-gray-600 mb-4">
                    Upload your beach photo, draw zones, and place spots (umbrellas, cabanas, loungers) with drag-and-drop.
                </p>
                
                <div id="beachMapPreview" class="bg-gray-100 rounded-lg p-8 text-center">
                    <i class="fas fa-map text-6xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">No beach map configured yet</p>
                    <p class="text-sm text-gray-500 mt-2">Click "Design Beach Map" to get started</p>
                </div>
            </div>

            <!-- Beach Spots List -->
            <div class="bg-white rounded-lg border p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">
                        <i class="fas fa-list mr-2 text-blue-600"></i>Beach Spots
                    </h3>
                    <button onclick="addQuickSpot()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>Add Spot
                    </button>
                </div>
                <div id="beachSpotsList" class="space-y-2">
                    <p class="text-gray-500 text-center py-8">No beach spots created yet. Use the Beach Map Designer to add spots.</p>
                </div>
            </div>

            <!-- Beach Bookings -->
            <div class="bg-white rounded-lg border p-6">
                <div class="flex items-center justify-between mb-4">
                    <div id="beachBookingsHeader" class="flex items-center">
                        <h3 class="text-xl font-bold">
                            <i class="fas fa-calendar-check mr-2 text-green-600"></i>Today's Beach Bookings
                        </h3>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="beachBookingsTimestamp" class="text-xs text-gray-500"></span>
                        <input type="date" id="beachBookingDate" class="px-4 py-2 border rounded-lg" onchange="loadBeachBookings()">
                    </div>
                </div>
                <div id="beachBookingsList" class="space-y-3">
                    <p class="text-gray-500 text-center py-8">No bookings for today</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Management Tab -->
    <div id="feedbackTab" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="fas fa-comments mr-2 text-purple-600"></i>
                Feedback & Survey Management
            </h2>
            <p class="text-gray-600 mb-6">
                Create dynamic feedback forms, generate QR codes, analyze guest sentiment, and get AI-powered insights on urgent issues.
            </p>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="feedbackStats">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-blue-600 font-semibold">Total Responses</p>
                            <p class="text-3xl font-bold text-blue-900" id="totalResponses">0</p>
                        </div>
                        <i class="fas fa-inbox text-4xl text-blue-400"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-green-600 font-semibold">Positive</p>
                            <p class="text-3xl font-bold text-green-900" id="positiveCount">0</p>
                        </div>
                        <i class="fas fa-smile text-4xl text-green-400"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-red-600 font-semibold">Urgent</p>
                            <p class="text-3xl font-bold text-red-900" id="urgentCount">0</p>
                        </div>
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-lg border border-yellow-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-yellow-600 font-semibold">Avg Sentiment</p>
                            <p class="text-3xl font-bold text-yellow-900" id="avgSentiment">0.0</p>
                        </div>
                        <i class="fas fa-chart-line text-4xl text-yellow-400"></i>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button onclick="createNewForm()" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
                    <i class="fas fa-plus mr-2"></i>Create New Form
                </button>
                <button onclick="viewAnalytics()" class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
                    <i class="fas fa-chart-bar mr-2"></i>View Analytics
                </button>
                <button onclick="viewInsights()" class="bg-gradient-to-r from-orange-600 to-red-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
                    <i class="fas fa-lightbulb mr-2"></i>AI Insights
                </button>
            </div>

            <!-- Forms List -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-xl font-bold mb-4"><i class="fas fa-list mr-2 text-purple-600"></i>Your Feedback Forms</h3>
                <div id="formsList" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-5xl mb-3"></i>
                        <p>No forms created yet. Click "Create New Form" to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Urgent Alerts Section -->
        <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg shadow-lg p-6 mb-6 border-2 border-red-200" id="urgentAlertsSection" style="display: none;">
            <h3 class="text-xl font-bold mb-4 text-red-800">
                <i class="fas fa-exclamation-circle mr-2 animate-pulse"></i>
                Urgent Issues Requiring Attention
            </h3>
            <div id="urgentAlertsList" class="space-y-3">
            </div>
        </div>

        <!-- Recent Submissions -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <div id="feedbackHeader" class="flex items-center">
                    <h3 class="text-xl font-bold"><i class="fas fa-clock mr-2 text-blue-600"></i>Recent Feedback</h3>
                </div>
                <span id="feedbackTimestamp" class="text-xs text-gray-500"></span>
            </div>
            <div id="recentSubmissions" class="space-y-3">
                <div class="text-center text-gray-500 py-4">
                    <p>No submissions yet</p>
                </div>
            </div>
        </div>

        <!-- ðŸ¤– AI Chat Feedback Section -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold"><i class="fas fa-robot mr-2 text-purple-600"></i>AI Chat Feedback</h3>
                <div class="flex gap-2">
                    <span id="chatFeedbackCount" class="px-3 py-1 bg-purple-100 text-purple-800 text-sm rounded-full font-semibold">0 detected</span>
                    <span id="chatFeedbackUrgent" class="px-3 py-1 bg-red-100 text-red-800 text-sm rounded-full font-semibold">0 urgent</span>
                </div>
            </div>
            <p class="text-gray-600 text-sm mb-4">
                ðŸ’¡ <strong>Auto-detected complaints and feedback</strong> from chatbot conversations. 
                AI analyzes sentiment and extracts structured information.
            </p>
            
            <!-- Category Filter -->
            <div class="mb-4 flex gap-2 flex-wrap">
                <button onclick="filterChatFeedback('all')" class="chat-filter-btn chat-filter-active px-3 py-1 rounded-lg text-sm font-semibold">
                    All
                </button>
                <button onclick="filterChatFeedback('urgent')" class="chat-filter-btn px-3 py-1 bg-red-100 text-red-700 rounded-lg text-sm font-semibold">
                    Urgent
                </button>
                <button onclick="filterChatFeedback('room')" class="chat-filter-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold">
                    Room
                </button>
                <button onclick="filterChatFeedback('food')" class="chat-filter-btn px-3 py-1 bg-orange-100 text-orange-700 rounded-lg text-sm font-semibold">
                    Food
                </button>
                <button onclick="filterChatFeedback('staff')" class="chat-filter-btn px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-sm font-semibold">
                    Staff
                </button>
                <button onclick="filterChatFeedback('cleanliness')" class="chat-filter-btn px-3 py-1 bg-green-100 text-green-700 rounded-lg text-sm font-semibold">
                    Cleanliness
                </button>
            </div>
            
            <div id="chatFeedbackList" class="space-y-3 max-h-96 overflow-y-auto">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-robot text-4xl mb-2"></i>
                    <p>No chat feedback detected yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Builder Modal -->
    <div id="formBuilderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 rounded-t-xl">
                <h3 class="text-2xl font-bold"><i class="fas fa-edit mr-2"></i>Form Builder</h3>
                <p class="text-purple-100 mt-1">Create your custom feedback form</p>
            </div>
            
            <div class="p-6">
                <!-- Form Basic Info -->
                <div class="mb-6">
                    <h4 class="text-lg font-bold mb-4">Basic Information</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Form Name *</label>
                            <input type="text" id="formName" class="w-full px-4 py-2 border rounded-lg" placeholder="e.g., Guest Satisfaction Survey">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Description</label>
                            <textarea id="formDescription" rows="2" class="w-full px-4 py-2 border rounded-lg" placeholder="Brief description of this form"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Form Type</label>
                                <select id="formType" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="feedback">Feedback</option>
                                    <option value="survey">Survey</option>
                                    <option value="complaint">Complaint</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Thank You Message</label>
                                <input type="text" id="thankYouMessage" class="w-full px-4 py-2 border rounded-lg" placeholder="Thank you for your feedback!">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Required Fields -->
                <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-lg font-bold mb-3">Required Guest Information</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="requireRoomNumber" class="w-4 h-4 text-purple-600">
                            <span class="text-sm">Room Number</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="requireGuestName" class="w-4 h-4 text-purple-600">
                            <span class="text-sm">Guest Name</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="requireEmail" class="w-4 h-4 text-purple-600">
                            <span class="text-sm">Email</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="requirePhone" class="w-4 h-4 text-purple-600">
                            <span class="text-sm">Phone</span>
                        </label>
                    </div>
                </div>

                <!-- Display Options -->
                <div class="mb-6 bg-purple-50 p-4 rounded-lg border-2 border-purple-200">
                    <h4 class="text-lg font-bold mb-3 text-purple-900"><i class="fas fa-eye mr-2"></i>Display Options</h4>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="isActiveToggle" checked class="w-5 h-5 text-green-600">
                            <div>
                                <span class="font-semibold">Form Active</span>
                                <p class="text-sm text-gray-600">Allow guests to submit this form</p>
                            </div>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="showOnHomepage" class="w-5 h-5 text-purple-600">
                            <div>
                                <span class="font-semibold">Show on Homepage</span>
                                <p class="text-sm text-gray-600">Display this feedback form next to the Info tab on guest homepage</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Questions Builder -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold">Questions</h4>
                        <button onclick="addQuestion()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            <i class="fas fa-plus mr-2"></i>Add Question
                        </button>
                    </div>
                    <div id="questionsList" class="space-y-3">
                        <div class="text-center text-gray-500 py-4 border-2 border-dashed border-gray-300 rounded-lg">
                            <i class="fas fa-question-circle text-3xl mb-2"></i>
                            <p>No questions yet. Click "Add Question" to start!</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button onclick="closeFormBuilder()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button onclick="saveForm()" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-2 rounded-lg hover:shadow-lg">
                        <i class="fas fa-save mr-2"></i>Save Form
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Type Modal -->
    <div id="questionTypeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-t-xl">
                <h3 class="text-xl font-bold">Choose Question Type</h3>
            </div>
            <div class="p-6 grid grid-cols-2 md:grid-cols-3 gap-4">
                <button onclick="selectQuestionType('text')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-purple-600 hover:bg-purple-50 transition-all">
                    <i class="fas fa-font text-3xl text-purple-600 mb-2"></i>
                    <p class="font-semibold">Short Text</p>
                    <p class="text-xs text-gray-500">Single line input</p>
                </button>
                <button onclick="selectQuestionType('textarea')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-purple-600 hover:bg-purple-50 transition-all">
                    <i class="fas fa-align-left text-3xl text-purple-600 mb-2"></i>
                    <p class="font-semibold">Long Text</p>
                    <p class="text-xs text-gray-500">Multi-line input</p>
                </button>
                <button onclick="selectQuestionType('rating')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-purple-600 hover:bg-purple-50 transition-all">
                    <i class="fas fa-star text-3xl text-purple-600 mb-2"></i>
                    <p class="font-semibold">Rating</p>
                    <p class="text-xs text-gray-500">1-5 stars</p>
                </button>
                <button onclick="selectQuestionType('scale')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-purple-600 hover:bg-purple-50 transition-all">
                    <i class="fas fa-sliders-h text-3xl text-purple-600 mb-2"></i>
                    <p class="font-semibold">Scale</p>
                    <p class="text-xs text-gray-500">1-10 scale</p>
                </button>
                <button onclick="selectQuestionType('multiple_choice')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-purple-600 hover:bg-purple-50 transition-all">
                    <i class="fas fa-list-ul text-3xl text-purple-600 mb-2"></i>
                    <p class="font-semibold">Multiple Choice</p>
                    <p class="text-xs text-gray-500">Pick one option</p>
                </button>
                <button onclick="selectQuestionType('yes_no')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-purple-600 hover:bg-purple-50 transition-all">
                    <i class="fas fa-check-circle text-3xl text-purple-600 mb-2"></i>
                    <p class="font-semibold">Yes/No</p>
                    <p class="text-xs text-gray-500">Binary choice</p>
                </button>
                <button onclick="selectQuestionType('nps')" class="p-4 border-2 border-gray-200 rounded-lg hover:border-purple-600 hover:bg-purple-50 transition-all">
                    <i class="fas fa-chart-line text-3xl text-purple-600 mb-2"></i>
                    <p class="font-semibold">NPS</p>
                    <p class="text-xs text-gray-500">0-10 recommendation</p>
                </button>
            </div>
            <div class="p-4 border-t flex justify-end">
                <button onclick="closeQuestionTypeModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Question Creation Modal -->
    <div id="questionCreationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-t-xl">
                <h3 class="text-2xl font-bold"><i class="fas fa-plus-circle mr-2"></i>Create New Question</h3>
                <p class="text-sm text-purple-100 mt-1">Fill in the details below</p>
            </div>
            <div class="p-6 space-y-6">
                <!-- Question Type Display -->
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                            <i id="questionTypeIcon" class="fas fa-font text-2xl text-purple-600"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Question Type</p>
                            <p id="questionTypeLabel" class="text-lg font-bold text-gray-900">Short Text</p>
                        </div>
                    </div>
                    <button onclick="closeQuestionCreationModal(); document.getElementById('questionTypeModal').classList.remove('hidden');" 
                            class="px-4 py-2 bg-white text-purple-600 rounded-lg hover:bg-purple-100 transition-colors text-sm font-semibold">
                        <i class="fas fa-exchange-alt mr-2"></i>Change Type
                    </button>
                </div>

                <!-- Question Text -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-question-circle mr-2 text-purple-600"></i>Question Text
                        <span class="text-red-500">*</span>
                    </label>
                    <textarea id="questionTextInput" 
                              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" 
                              rows="3" 
                              placeholder="Enter your question here... (e.g., How satisfied are you with our service?)"></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-lightbulb mr-1"></i>
                        Tip: Make your question clear and specific
                    </p>
                </div>

                <!-- Required Toggle -->
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-asterisk text-red-500"></i>
                        <div>
                            <p class="font-semibold text-gray-900">Required Question</p>
                            <p class="text-xs text-gray-600">Guests must answer this question</p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="questionRequiredToggle" checked class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                    </label>
                </div>

                <!-- Options (for multiple choice) -->
                <div id="optionsSection" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-list mr-2 text-purple-600"></i>Answer Options
                        <span class="text-red-500">*</span>
                    </label>
                    <div id="optionsList" class="space-y-2 mb-3">
                        <!-- Options will be added here -->
                    </div>
                    <button onclick="addOption()" class="w-full px-4 py-2 border-2 border-dashed border-purple-300 text-purple-600 rounded-lg hover:bg-purple-50 transition-colors font-semibold">
                        <i class="fas fa-plus mr-2"></i>Add Option
                    </button>
                </div>

                <!-- Preview -->
                <div class="border-t-2 pt-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        <i class="fas fa-eye mr-2 text-purple-600"></i>Preview
                    </label>
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-6 border-2 border-gray-200">
                        <div id="questionPreview" class="text-gray-500 italic">
                            Enter a question above to see preview...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="sticky bottom-0 bg-white border-t p-4 flex gap-3">
                <button onclick="closeQuestionCreationModal()" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button onclick="saveQuestion()" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all font-semibold shadow-lg">
                    <i class="fas fa-check mr-2"></i>Add Question
                </button>
            </div>
        </div>
    </div>

    <!-- View Submission Modal -->
    <div id="submissionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-xl">
                <h3 class="text-2xl font-bold"><i class="fas fa-file-alt mr-2"></i>Feedback Details</h3>
            </div>
            <div id="submissionDetails" class="p-6">
                <!-- Will be populated dynamically -->
            </div>
            <div class="p-4 border-t flex justify-end">
                <button onclick="closeSubmissionModal()" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Live Chat Widget -->
    <div id="chatWidget" class="hidden fixed bottom-4 left-4 w-96 h-[500px] bg-white rounded-xl shadow-2xl flex flex-col z-50">
        <div class="p-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-t-xl flex justify-between items-center">
            <div>
                <h4 class="font-bold"><i class="fas fa-comments mr-2"></i>Live Support Chat</h4>
                <p class="text-xs text-blue-100">We're here to help!</p>
            </div>
            <button onclick="closeLiveChat()" class="text-white/80 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4" id="widgetChatMessages" style="max-height: 360px;">
            <div class="text-center text-gray-500 text-sm">Starting chat...</div>
        </div>
        <div class="p-3 border-t">
            <div class="flex gap-2">
                <input type="text" id="widgetChatInput" placeholder="Type your message..." class="flex-1 px-3 py-2 border rounded-lg text-sm" />
                <button onclick="sendWidgetMessage()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        </div><!-- End Main Content Area -->
    </div><!-- End Sidebar + Content Layout -->

    <!-- AI Insights Modal -->
    <div id="insightsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white px-6 py-4 flex items-center justify-between">
                <h3 class="text-2xl font-bold"><i class="fas fa-lightbulb mr-2"></i>AI Insights Dashboard</h3>
                <button onclick="closeInsightsModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 80px);">
                <div id="insightsList">
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-orange-600 mb-4"></i>
                        <p class="text-gray-600">Loading insights...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submissions Modal -->
    <div id="submissionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4 flex items-center justify-between">
                <div>
                    <h3 class="text-2xl font-bold"><i class="fas fa-comments mr-2"></i>Form Submissions</h3>
                    <p class="text-sm text-blue-100 mt-1" id="submissionsFormName"></p>
                </div>
                <button onclick="closeSubmissionsModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 80px);">
                <div id="submissionsList">
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                        <p class="text-gray-600">Loading submissions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submission Detail Modal -->
    <div id="submissionDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-4 flex items-center justify-between">
                <h3 class="text-2xl font-bold"><i class="fas fa-file-alt mr-2"></i>Submission Details</h3>
                <button onclick="closeSubmissionDetailModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 80px);">
                <div id="submissionDetailContent">
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
                        <p class="text-gray-600">Loading details...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Dashboard Modal -->
    <div id="analyticsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white px-6 py-4 flex items-center justify-between">
                <div>
                    <h3 class="text-2xl font-bold"><i class="fas fa-chart-line mr-2"></i>Feedback Analytics Dashboard</h3>
                    <p class="text-sm text-blue-100 mt-1">Comprehensive insights & trends</p>
                </div>
                <button onclick="closeAnalyticsModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 80px);">
                <div id="analyticsContent">
                    <div class="text-center py-12">
                        <i class="fas fa-spinner fa-spin text-5xl text-blue-600 mb-4"></i>
                        <p class="text-gray-600 text-lg">Loading analytics...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
      const user = JSON.parse(localStorage.getItem('admin_user') || '{}');
      if (!user.user_id) { window.location.href = '/admin/login'; }

      // Get property ID from URL or localStorage
      const propertyId = new URLSearchParams(window.location.search).get('property') || localStorage.getItem('property_id') || '1';

      let currentTab = 'rooms';
      
      function showTab(tab, clickedButton) {
        currentTab = tab;
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn, .sidebar-btn').forEach(btn => btn.classList.remove('tab-active'));
        document.getElementById(tab + 'Tab').classList.remove('hidden');
        if (clickedButton) {
          clickedButton.classList.add('tab-active');
        }
        
        if (tab === 'qrcode') loadQRCode();
        if (tab === 'analytics') {
          requestAnimationFrame(() => {
            if (typeof window.loadAnalytics === 'function') {
              window.loadAnalytics().catch(err => console.error('Analytics error:', err));
            }
          });
        }
        if (tab === 'rooms') loadRooms();
        if (tab === 'vendors') loadVendors();
        if (tab === 'regcode') loadRegCode();
        if (tab === 'offerings') loadOfferings();
        if (tab === 'customsections') loadCustomSections();
        if (tab === 'infopages') loadInfoPages();
        if (tab === 'activities') loadActivities();
        if (tab === 'callbacks') loadCallbacks();
        if (tab === 'settings') loadSettings();
        if (tab === 'chatbot') loadChatbot();
        if (tab === 'beach') loadBeachSettings();
        if (tab === 'feedback') loadFeedbackTab();
        if (tab === 'restaurants') loadRestaurantsTab();
      }
      
      // Add event listeners to sidebar buttons
      document.querySelectorAll('.tab-btn, .sidebar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tab = this.getAttribute('data-tab');
          showTab(tab, this);
        });
      });
      
      // QR Code functions
      async function loadQRCode() {
        try {
          const response = await fetch('/api/properties');
          const data = await response.json();
          const property = data.properties[0];
          
          if (property) {
            const hotelURL = window.location.origin + '/hotel/' + property.slug;
            const hotelURLEl = document.getElementById('hotelURL');
            const propertyNameEl = document.getElementById('propertyName');
            const propertySlugEl = document.getElementById('propertySlug');
            const qrImageEl = document.getElementById('qrImage');
            const previewHotelNameEl = document.getElementById('previewHotelName');
            
            if (hotelURLEl) hotelURLEl.textContent = hotelURL;
            if (propertyNameEl) propertyNameEl.textContent = property.name;
            if (propertySlugEl) propertySlugEl.textContent = property.slug;
            if (previewHotelNameEl) previewHotelNameEl.textContent = property.name;
            
            // Generate QR code using QR Code API
            const qrURL = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(hotelURL);
            if (qrImageEl) qrImageEl.src = qrURL;
          }
        } catch (error) {
          console.error('QR Code load error:', error);
          const qrImageEl = document.getElementById('qrImage');
          if (qrImageEl) qrImageEl.src = '';
        }
      }
      
      window.downloadQR = function() {
        const hotelURL = document.getElementById('hotelURL').textContent;
        const qrURL = 'https://api.qrserver.com/v1/create-qr-code/?size=1000x1000&format=png&data=' + encodeURIComponent(hotelURL);
        const a = document.createElement('a');
        a.href = qrURL;
        a.download = 'hotel-qr-code.png';
        a.click();
      }
      
      window.printQR = function() {
        const qrImg = document.querySelector('#qrCodeDisplay img');
        if (qrImg) {
          const win = window.open('', '_blank');
          win.document.write('<html><head><title>Print QR Code</title></head><body style="text-align:center;padding:50px;">');
          win.document.write('<h1>' + document.getElementById('propertyName').textContent + '</h1>');
          win.document.write('<img src="' + qrImg.src + '" style="width:500px;height:500px;">');
          win.document.write('<p>' + document.getElementById('hotelURL').textContent + '</p>');
          win.document.write('</body></html>');
          win.document.close();
          win.print();
        }
      }
      
      // QR Card Designer Functions
      let currentFestiveOverlay = null;
      let qrCardConfig = {
        title: 'Scan for Hotel Services',
        subtitle: 'Access all amenities and services',
        message: '',
        bgColor: '#ffffff',
        textColor: '#000000',
        qrSize: 300,
        borderRadius: 10,
        festiveOverlay: null
      };

      // Festive overlay emojis mapping
      const festiveOverlays = {
        christmas: 'ðŸŽ…',
        newyear: 'ðŸŽŠ',
        easter: 'ðŸ°',
        ramadan: 'ðŸŒ™',
        eid: 'ðŸ•Œ',
        halloween: 'ðŸŽƒ',
        valentine: 'ðŸ’'
      };

      // Load QR card template from database
      async function loadQRCardTemplate() {
        try {
          const response = await fetch('/api/admin/qr-card/1');
          const data = await response.json();
          
          // Update form fields
          document.getElementById('cardTitle').value = data.card_title || qrCardConfig.title;
          document.getElementById('cardSubtitle').value = data.card_subtitle || qrCardConfig.subtitle;
          document.getElementById('cardMessage').value = data.custom_message || '';
          document.getElementById('bgColor').value = data.background_color || qrCardConfig.bgColor;
          document.getElementById('qrTextColor').value = data.text_color || qrCardConfig.textColor;
          document.getElementById('qrSize').value = data.qr_size || qrCardConfig.qrSize;
          document.getElementById('borderRadius').value = data.border_radius || qrCardConfig.borderRadius;
          
          // Update config
          qrCardConfig = {
            title: data.card_title || qrCardConfig.title,
            subtitle: data.card_subtitle || qrCardConfig.subtitle,
            message: data.custom_message || '',
            bgColor: data.background_color || qrCardConfig.bgColor,
            textColor: data.text_color || qrCardConfig.textColor,
            qrSize: data.qr_size || qrCardConfig.qrSize,
            borderRadius: data.border_radius || qrCardConfig.borderRadius,
            festiveOverlay: data.festive_overlay
          };
          
          currentFestiveOverlay = data.festive_overlay;
          
          // Highlight active festive button
          if (currentFestiveOverlay) {
            setFestiveOverlay(currentFestiveOverlay);
          }
          
          updateQRCardPreview();
        } catch (error) {
          console.error('Load QR card error:', error);
        }
      }

      // Update QR card preview in real-time
      function updateQRCardPreview() {
        const hotelURL = document.getElementById('hotelURL').textContent;
        const propertyName = document.getElementById('propertyName').textContent;
        
        // Update card styling
        const card = document.getElementById('qrCard');
        card.style.background = qrCardConfig.bgColor;
        card.style.borderRadius = qrCardConfig.borderRadius + 'px';
        
        // Update text
        const title = document.getElementById('previewTitle');
        title.textContent = qrCardConfig.title;
        title.style.color = qrCardConfig.textColor;
        
        const subtitle = document.getElementById('previewSubtitle');
        subtitle.textContent = qrCardConfig.subtitle;
        subtitle.style.color = qrCardConfig.textColor;
        
        const message = document.getElementById('previewMessage');
        message.textContent = qrCardConfig.message;
        message.style.color = qrCardConfig.textColor;
        
        const hotelName = document.getElementById('previewHotelName');
        hotelName.textContent = propertyName;
        hotelName.style.color = qrCardConfig.textColor;
        
        // Update QR code
        const qrSize = qrCardConfig.qrSize;
        const qrURL = 'https://api.qrserver.com/v1/create-qr-code/?size=' + qrSize + 'x' + qrSize + '&data=' + encodeURIComponent(hotelURL);
        const qrImage = document.getElementById('qrImage');
        qrImage.src = qrURL;
        qrImage.style.width = qrSize + 'px';
        qrImage.style.height = qrSize + 'px';
        
        // Update festive overlay
        const overlayDiv = document.getElementById('festiveOverlayDiv');
        if (qrCardConfig.festiveOverlay && festiveOverlays[qrCardConfig.festiveOverlay]) {
          overlayDiv.textContent = festiveOverlays[qrCardConfig.festiveOverlay];
          overlayDiv.style.display = 'block';
        } else {
          overlayDiv.style.display = 'none';
        }
        
        // Update border radius value display
        document.getElementById('borderRadiusValue').textContent = qrCardConfig.borderRadius + 'px';
      }

      // Set festive overlay
      window.setFestiveOverlay = function(overlay, event) {
        currentFestiveOverlay = overlay;
        qrCardConfig.festiveOverlay = overlay;
        
        // Update button styles
        document.querySelectorAll('.festive-btn').forEach(btn => {
          btn.classList.remove('border-blue-500', 'border-red-500', 'border-yellow-500', 'border-pink-500', 
                                'border-purple-500', 'border-green-500', 'border-orange-500', 'ring-4', 'ring-blue-200');
          btn.classList.add('border-gray-300');
        });
        
        if (overlay && event) {
          const targetBtn = event.target.closest('.festive-btn');
          if (targetBtn) {
            targetBtn.classList.remove('border-gray-300');
            targetBtn.classList.add('ring-4', 'ring-blue-200', 'border-blue-500');
          }
        }
        
        // Update current overlay text
        const overlayNames = {
          christmas: 'Christmas ðŸŽ…',
          newyear: 'New Year ðŸŽŠ',
          easter: 'Easter ðŸ°',
          ramadan: 'Ramadan ðŸŒ™',
          eid: 'Eid ðŸ•Œ',
          halloween: 'Halloween ðŸŽƒ',
          valentine: 'Valentine ðŸ’'
        };
        document.getElementById('currentOverlay').textContent = 'Current: ' + (overlay ? overlayNames[overlay] : 'None');
        
        updateQRCardPreview();
      };

      // Save QR card design
      window.saveQRCard = async function() {
        try {
          const response = await fetch('/api/admin/qr-card/1', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              card_title: qrCardConfig.title,
              card_subtitle: qrCardConfig.subtitle,
              background_color: qrCardConfig.bgColor,
              text_color: qrCardConfig.textColor,
              qr_size: qrCardConfig.qrSize,
              border_radius: qrCardConfig.borderRadius,
              show_logo: true,
              festive_overlay: qrCardConfig.festiveOverlay,
              custom_message: qrCardConfig.message
            })
          });
          
          const data = await response.json();
          if (data.success) {
            alert('âœ… QR Card Design Saved Successfully!');
          } else {
            alert('âŒ Error saving design');
          }
        } catch (error) {
          console.error('Save QR card error:', error);
          alert('âŒ Error saving design');
        }
      };

      // Reset QR card to defaults
      window.resetQRCard = function() {
        if (!confirm('Reset to default design? Any unsaved changes will be lost.')) return;
        
        document.getElementById('cardTitle').value = 'Scan for Hotel Services';
        document.getElementById('cardSubtitle').value = 'Access all amenities and services';
        document.getElementById('cardMessage').value = '';
        document.getElementById('bgColor').value = '#ffffff';
        document.getElementById('qrTextColor').value = '#000000';
        document.getElementById('qrSize').value = '300';
        document.getElementById('borderRadius').value = '10';
        
        qrCardConfig = {
          title: 'Scan for Hotel Services',
          subtitle: 'Access all amenities and services',
          message: '',
          bgColor: '#ffffff',
          textColor: '#000000',
          qrSize: 300,
          borderRadius: 10,
          festiveOverlay: null
        };
        
        currentFestiveOverlay = null;
        setFestiveOverlay(null);
        updateQRCardPreview();
      };

      // Download QR card as image
      window.downloadQRCard = function() {
        const card = document.getElementById('qrCard');
        const propertyName = document.getElementById('propertyName').textContent;
        
        // Use html2canvas to capture the card
        alert('ðŸ“¥ Download feature: Right-click on the preview card and select "Save Image As..."' + String.fromCharCode(10) + String.fromCharCode(10) + 'Or use your browser screenshot tool to capture the card.');
      };

      // Print QR card
      window.printQRCard = function() {
        const card = document.getElementById('qrCard');
        const propertyName = document.getElementById('propertyName').textContent;
        
        const win = window.open('', '_blank');
        win.document.write('<html><head><title>Print QR Card - ' + propertyName + '</title>');
        win.document.write('<style>body { margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; } @media print { body { padding: 0; } }</style>');
        win.document.write('</head><body>');
        win.document.write('<div>' + card.outerHTML + '</div>');
        win.document.write('</body></html>');
        win.document.close();
        setTimeout(() => win.print(), 500);
      };

      // Event listeners for real-time updates
      document.getElementById('cardTitle').addEventListener('input', (e) => {
        qrCardConfig.title = e.target.value;
        updateQRCardPreview();
      });
      
      document.getElementById('cardSubtitle').addEventListener('input', (e) => {
        qrCardConfig.subtitle = e.target.value;
        updateQRCardPreview();
      });
      
      document.getElementById('cardMessage').addEventListener('input', (e) => {
        qrCardConfig.message = e.target.value;
        updateQRCardPreview();
      });
      
      document.getElementById('bgColor').addEventListener('input', (e) => {
        qrCardConfig.bgColor = e.target.value;
        updateQRCardPreview();
      });
      
      document.getElementById('qrTextColor').addEventListener('input', (e) => {
        qrCardConfig.textColor = e.target.value;
        updateQRCardPreview();
      });
      
      document.getElementById('qrSize').addEventListener('change', (e) => {
        qrCardConfig.qrSize = parseInt(e.target.value);
        updateQRCardPreview();
      });
      
      document.getElementById('borderRadius').addEventListener('input', (e) => {
        qrCardConfig.borderRadius = parseInt(e.target.value);
        updateQRCardPreview();
      });
      
      // Analytics functions
      let currentAnalyticsRange = 'today';
      
      async function loadAnalytics(range) {
        try {
          if (range) currentAnalyticsRange = range;
          
          const response = await fetch('/api/admin/analytics?property_id=' + propertyId + '&range=' + currentAnalyticsRange);
          
          if (!response.ok) {
            throw new Error('Analytics API returned ' + response.status);
          }
          
          const data = await response.json();
          
          // Defensive: Check if elements exist before updating
          const totalScansEl = document.getElementById('totalScans');
          const activeBookingsEl = document.getElementById('activeBookings');
          const totalActivitiesEl = document.getElementById('totalActivities');
          const totalVendorsEl = document.getElementById('totalVendors');
          
          if (!totalScansEl || !activeBookingsEl || !totalActivitiesEl || !totalVendorsEl) {
            console.error('âŒ Analytics DOM elements not found:', {
              totalScans: !!totalScansEl,
              activeBookings: !!activeBookingsEl,
              totalActivities: !!totalActivitiesEl,
              totalVendors: !!totalVendorsEl
            });
            alert('Analytics elements not found. Please refresh the page.');
            return;
          }
          
          console.log('âœ… Analytics loading data...', {
            propertyId: propertyId,
            range: currentAnalyticsRange,
            stats: data.stats
          });
          
          // Update stats
          totalScansEl.textContent = data.stats.totalScans || '0';
          activeBookingsEl.textContent = data.stats.activeBookings || '0';
          totalActivitiesEl.textContent = data.stats.totalActivities || '0';
          totalVendorsEl.textContent = data.stats.totalVendors || '0';
          
          // Show comparison for scans
          const scansComparisonEl = document.getElementById('scansComparison');
          if (scansComparisonEl && data.stats.scansChange !== undefined) {
            const scansChange = parseFloat(data.stats.scansChange);
            const scansIcon = scansChange > 0 ? 'arrow-up' : scansChange < 0 ? 'arrow-down' : 'minus';
            const scansColor = scansChange > 0 ? 'text-green-200' : scansChange < 0 ? 'text-red-200' : 'text-blue-200';
            const scansChangeText = scansChange > 0 ? '+' + Math.abs(scansChange) : scansChange < 0 ? '-' + Math.abs(scansChange) : scansChange;
            scansComparisonEl.innerHTML = 
              '<i class="fas fa-' + scansIcon + ' ' + scansColor + '"></i>' +
              '<span class="' + scansColor + '">' + scansChangeText + '%</span>' +
              '<span>vs previous period</span>';
          }
          
          // Show comparison for bookings
          const bookingsComparisonEl = document.getElementById('bookingsComparison');
          if (bookingsComparisonEl && data.stats.bookingsChange !== undefined) {
            const bookingsChange = parseFloat(data.stats.bookingsChange);
            const bookingsIcon = bookingsChange > 0 ? 'arrow-up' : bookingsChange < 0 ? 'arrow-down' : 'minus';
            const bookingsColor = bookingsChange > 0 ? 'text-green-200' : bookingsChange < 0 ? 'text-red-200' : 'text-green-200';
            const bookingsChangeText = bookingsChange > 0 ? '+' + Math.abs(bookingsChange) : bookingsChange < 0 ? '-' + Math.abs(bookingsChange) : bookingsChange;
            bookingsComparisonEl.innerHTML = 
              '<i class="fas fa-' + bookingsIcon + ' ' + bookingsColor + '"></i>' +
              '<span class="' + bookingsColor + '">' + bookingsChangeText + '%</span>' +
              '<span>vs previous period</span>';
          }
          
          // Popular activities
          const popularActivitiesEl = document.getElementById('popularActivities');
          if (popularActivitiesEl && data.popularActivities) {
            const activitiesHTML = data.popularActivities.map((a, i) => 
              '<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">' +
              '<div class="flex items-center gap-3">' +
              '<span class="text-2xl font-bold text-gray-300">' + (i + 1) + '</span>' +
              '<div>' +
              '<p class="font-semibold">' + (a.title_en || 'Activity') + '</p>' +
              '<p class="text-sm text-gray-600">' + a.booking_count + ' bookings</p>' +
              '</div>' +
              '</div>' +
              '<span class="text-green-600 font-semibold">$' + (a.total_revenue || 0) + '</span>' +
              '</div>'
            ).join('');
            popularActivitiesEl.innerHTML = activitiesHTML || '<p class="text-center text-gray-400 py-4">No activity data yet</p>';
          }
          
          // Popular sections
          const popularSectionsEl = document.getElementById('popularSections');
          if (popularSectionsEl && data.popularSections) {
            const sectionsHTML = data.popularSections.map((s, i) =>
              '<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">' +
              '<div class="flex items-center gap-3">' +
              '<i class="fas fa-' + (s.icon || 'eye') + ' text-xl text-indigo-600"></i>' +
              '<p class="font-semibold capitalize">' + s.name + '</p>' +
              '</div>' +
              '<span class="text-blue-600 font-semibold">' + s.views + ' views</span>' +
              '</div>'
            ).join('');
            popularSectionsEl.innerHTML = sectionsHTML || '<p class="text-center text-gray-400 py-4">No section data yet</p>';
          }
          
        } catch (error) {
          console.error('âŒ Analytics load error:', error);
          alert('Analytics Error: ' + error.message + '\\n\\nCheck console for details.');
        }
      }
      
      // Make loadAnalytics globally accessible to avoid scope issues
      window.loadAnalytics = loadAnalytics;
      
      function filterAnalytics(range) {
        // Update active button
        document.querySelectorAll('.date-filter-btn').forEach(btn => {
          btn.classList.remove('active', 'bg-blue-600', 'text-white');
          btn.classList.add('bg-gray-200', 'text-gray-700');
        });
        event.target.classList.add('active', 'bg-blue-600', 'text-white');
        event.target.classList.remove('bg-gray-200', 'text-gray-700');
        
        // Reload analytics with new range
        loadAnalytics(range);
      }
      
      // Initialize: Load QR code tab by default (it's marked as tab-active)
      loadQRCode();
      loadQRCardTemplate();

      async function loadRegCode() {
        try {
          const response = await fetch('/api/admin/registration-code?property_id=1');
          const data = await response.json();
          document.getElementById('regCode').textContent = data.registration_code;
          const expiry = new Date(data.expires_at);
          document.getElementById('regCodeExpiry').textContent = expiry.toLocaleDateString();
        } catch (error) {
          console.error('Load reg code error:', error);
        }
      }

      async function regenerateRegCode() {
        if (!confirm('Regenerate registration code? The old code will no longer work.')) return;
        try {
          const response = await fetch('/api/admin/regenerate-registration-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ property_id: 1 })
          });
          const data = await response.json();
          if (data.success) {
            alert('New registration code generated!');
            loadRegCode();
          }
        } catch (error) {
          console.error('Regenerate code error:', error);
        }
      }

      async function loadCallbacks() {
        try {
          const response = await fetch('/api/admin/callback-requests?property_id=1');
          const data = await response.json();
          const list = document.getElementById('callbacksList');
          
          if (data.requests.length === 0) {
            list.innerHTML = '<p class="text-gray-500 text-center py-4">No callback requests</p>';
            return;
          }
          
          list.innerHTML = data.requests.map(r => \`
            <div class="border rounded-lg p-4 hover:shadow-md transition">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-bold">\${r.first_name} \${r.last_name}</h3>
                  <p class="text-sm text-gray-600"><i class="fas fa-phone mr-1"></i>\${r.phone}</p>
                  \${r.email ? '<p class="text-sm text-gray-600"><i class="fas fa-envelope mr-1"></i>' + r.email + '</p>' : ''}
                  <p class="text-sm text-gray-600 mt-2">Preferred: \${r.preferred_time}</p>
                  \${r.message ? '<p class="text-sm mt-2">' + r.message + '</p>' : ''}
                </div>
                <span class="px-3 py-1 rounded-full text-xs bg-yellow-100 text-yellow-800">\${r.status}</span>
              </div>
              <p class="text-xs text-gray-400 mt-2">\${new Date(r.created_at).toLocaleString()}</p>
            </div>
          \`).join('');
        } catch (error) {
          console.error('Load callbacks error:', error);
        }
      }

      async function loadRooms() {
        try {
          console.log('ðŸ”„ Loading rooms...');
          const response = await fetch('/api/admin/rooms?property_id=1');
          console.log('ðŸ“¡ Response status:', response.status);
          const rooms = await response.json();
          console.log('ðŸ“¦ Rooms received:', rooms.length, rooms);
          const list = document.getElementById('roomsList');
          console.log('ðŸ“ List element:', list);
          
          if (!list) {
            console.error('âŒ roomsList element not found!');
            return;
          }
          
          if (!rooms || rooms.length === 0) {
            list.innerHTML = '<p class="text-gray-500 p-4">No rooms found. Add rooms below.</p>';
            return;
          }
          
          list.innerHTML = rooms.map(r => '<div class="border rounded-lg p-4 flex justify-between items-center hover:shadow-md transition"><div><span class="font-bold text-lg">Room ' + r.room_number + '</span><span class="text-gray-600 ml-3">' + r.room_type + '</span></div><div class="flex gap-2"><a href="/hotel/paradise-resort" target="_blank" class="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200"><i class="fas fa-external-link-alt mr-2"></i>Test QR</a><button onclick="regenerateQR(' + r.room_id + ')" class="bg-yellow-100 text-yellow-700 px-4 py-2 rounded hover:bg-yellow-200"><i class="fas fa-sync mr-2"></i>Regenerate QR</button></div></div>').join('');
        } catch (error) {
          console.error('Load rooms error:', error);
        }
      }

      async function loadVendors() {
        try {
          const response = await fetch('/api/admin/vendors?property_id=1');
          const vendors = await response.json();
          const list = document.getElementById('vendorsList');
          
          list.innerHTML = vendors.map(v => '<div class="border rounded-lg p-4 flex justify-between items-center hover:shadow-md transition"><div><div class="font-bold text-lg">' + v.business_name + '</div><div class="text-sm text-gray-600">' + v.email + ' â€¢ ' + v.phone + '</div></div><div class="flex gap-2"><span class="px-3 py-1 rounded-full text-sm ' + (v.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') + '">' + v.status + '</span><button onclick="removeVendor(' + v.vendor_id + ')" class="bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200"><i class="fas fa-trash mr-2"></i>Remove</button></div></div>').join('');
        } catch (error) {
          console.error('Load vendors error:', error);
        }
      }

      // INFO PAGES MANAGEMENT
      let currentInfoPageId = null;

      async function loadInfoPages() {
        try {
          const response = await fetch('/api/admin/info-pages?property_id=1');
          const pages = await response.json();
          
          const container = document.getElementById('infoPagesContainer');
          
          if (pages.length === 0) {
            container.innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-file-alt text-5xl mb-4"></i><p class="text-lg">No info pages yet</p><p class="text-sm">Click "Create New Page" to get started!</p></div>';
            return;
          }
          
          let html = '';
          pages.forEach(page => {
            const colorClasses = {
              blue: 'bg-blue-100 text-blue-800 border-blue-300',
              purple: 'bg-purple-100 text-purple-800 border-purple-300',
              green: 'bg-green-100 text-green-800 border-green-300',
              orange: 'bg-orange-100 text-orange-800 border-orange-300',
              red: 'bg-red-100 text-red-800 border-red-300',
              pink: 'bg-pink-100 text-pink-800 border-pink-300',
              indigo: 'bg-indigo-100 text-indigo-800 border-indigo-300',
              teal: 'bg-teal-100 text-teal-800 border-teal-300'
            };
            const colorClass = colorClasses[page.color_theme] || colorClasses.blue;
            const publishStatus = page.is_published ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs"><i class="fas fa-check mr-1"></i>Published</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs"><i class="fas fa-eye-slash mr-1"></i>Draft</span>';
            
            html += '<div class="border rounded-lg p-4 hover:shadow-lg transition flex justify-between items-center">' +
              '<div class="flex items-center gap-4 flex-1">' +
              '<div class="w-16 h-16 ' + colorClass + ' rounded-lg flex items-center justify-center text-2xl border-2">' +
              '<i class="' + page.icon_class + '"></i>' +
              '</div>' +
              '<div class="flex-1">' +
              '<h3 class="font-bold text-lg">' + page.title_en + '</h3>' +
              '<div class="flex gap-2 mt-1 text-sm text-gray-600">' +
              '<span><i class="fas fa-columns mr-1"></i>' + page.layout_type + '</span>' +
              '<span>â€¢</span>' +
              publishStatus +
              '</div>' +
              '</div>' +
              '</div>' +
              '<div class="flex gap-2">' +
              '<button onclick="editInfoPage(' + page.page_id + ')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"><i class="fas fa-edit mr-1"></i>Edit</button>' +
              '<button onclick="deleteInfoPage(' + page.page_id + ', &quot;' + page.title_en + '&quot;)" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"><i class="fas fa-trash mr-1"></i>Delete</button>' +
              '</div>' +
              '</div>';
          });
          
          container.innerHTML = html;
        } catch (error) {
          console.error('Load info pages error:', error);
        }
      }

      window.showInfoPageModal = function() {
        currentInfoPageId = null;
        document.getElementById('infoPageForm').reset();
        document.getElementById('infoPageId').value = '';
        document.getElementById('infoPageModalTitle').innerHTML = '<i class="fas fa-file-alt mr-2"></i>Create Info Page';
        
        // Reset visual builder
        contentBlocks = [];
        blockIdCounter = 0;
        renderContentBlocks();
        document.getElementById('infoPageContent').value = '';
        
        document.getElementById('infoPageModal').classList.remove('hidden');
      }

      window.closeInfoPageModal = function() {
        document.getElementById('infoPageModal').classList.add('hidden');
        currentInfoPageId = null;
      }

      window.editInfoPage = async function(pageId) {
        try {
          const response = await fetch('/api/admin/info-pages/' + pageId);
          const page = await response.json();
          
          currentInfoPageId = pageId;
          document.getElementById('infoPageId').value = pageId;
          document.getElementById('infoPageTitle').value = page.title_en;
          document.getElementById('infoPageKey').value = page.page_key;
          document.getElementById('infoPageIcon').value = page.icon_class;
          document.getElementById('infoPageColor').value = page.color_theme;
          document.getElementById('infoPageLayout').value = page.layout_type;
          document.getElementById('infoPageContent').value = page.content_en || '';
          document.getElementById('infoPagePublished').checked = page.is_published === 1;
          document.getElementById('infoPageShowMenu').checked = page.show_in_menu === 1;
          
          document.getElementById('infoPageModalTitle').innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Info Page';
          document.getElementById('infoPageModal').classList.remove('hidden');
        } catch (error) {
          console.error('Edit info page error:', error);
          alert('Failed to load page details');
        }
      }

      window.saveInfoPage = async function() {
        const title = document.getElementById('infoPageTitle').value.trim();
        const content = document.getElementById('infoPageContent').value.trim();
        
        if (!title || !content) {
          alert('Please fill in title and content');
          return;
        }
        
        const data = {
          property_id: 1,
          page_key: document.getElementById('infoPageKey').value || title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, ''),
          title_en: title,
          content_en: content,
          icon_class: document.getElementById('infoPageIcon').value,
          color_theme: document.getElementById('infoPageColor').value,
          layout_type: document.getElementById('infoPageLayout').value,
          is_published: document.getElementById('infoPagePublished').checked ? 1 : 0,
          show_in_menu: document.getElementById('infoPageShowMenu').checked ? 1 : 0
        };
        
        try {
          const pageId = document.getElementById('infoPageId').value;
          const url = pageId ? '/api/admin/info-pages/' + pageId : '/api/admin/info-pages';
          const method = pageId ? 'PUT' : 'POST';
          
          const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert(pageId ? 'Page updated successfully!' : 'Page created successfully!');
            closeInfoPageModal();
            loadInfoPages();
          } else {
            alert('Failed to save page: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Save info page error:', error);
          alert('Failed to save page');
        }
      }

      window.deleteInfoPage = async function(pageId, title) {
        if (!confirm('Delete info page "' + title + '"?' + String.fromCharCode(10) + String.fromCharCode(10) + 'This cannot be undone.')) {
          return;
        }
        
        try {
          const response = await fetch('/api/admin/info-pages/' + pageId, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('Page deleted successfully!');
            loadInfoPages();
          } else {
            alert('Failed to delete page');
          }
        } catch (error) {
          console.error('Delete info page error:', error);
          alert('Failed to delete page');
        }
      }

      // ============================================
      // MODERN VISUAL PAGE BUILDER - NO CODE VERSION!
      // ============================================
      
      let contentBlocks = [];
      let blockIdCounter = 0;
      let isVisualMode = true;
      
      // Toggle between visual builder and HTML editor
      window.toggleBuilderMode = function() {
        isVisualMode = !isVisualMode;
        const visualContainer = document.getElementById('visualBuilderContainer');
        const htmlTextarea = document.getElementById('infoPageContent');
        const toggleBtn = document.getElementById('builderModeToggle');
        const helpText = document.getElementById('builderHelpText');
        
        if (isVisualMode) {
          // Switch to Visual Mode
          visualContainer.classList.remove('hidden');
          htmlTextarea.classList.add('hidden');
          toggleBtn.innerHTML = '<i class="fas fa-code mr-1"></i>Show HTML Editor';
          helpText.textContent = 'Visual Builder Active - No Coding!';
          // Convert HTML back to blocks if needed
          if (htmlTextarea.value) {
            // Keep HTML in sync
            syncBlocksToHTML();
          }
        } else {
          // Switch to HTML Mode
          visualContainer.classList.add('hidden');
          htmlTextarea.classList.remove('hidden');
          toggleBtn.innerHTML = '<i class="fas fa-magic mr-1"></i>Show Visual Builder';
          helpText.textContent = 'HTML Editor Active - For Advanced Users';
          // Sync blocks to HTML
          syncBlocksToHTML();
        }
      }
      
      // Add a new content block
      window.addContentBlock = function(type) {
        const blockId = 'block-' + (++blockIdCounter);
        const block = { id: blockId, type: type, content: {} };
        
        // Set default content based on type
        switch(type) {
          case 'heading':
            block.content = { text: 'New Heading', level: 'h2' };
            break;
          case 'text':
            block.content = { text: 'Write your paragraph text here...' };
            break;
          case 'list':
            block.content = { type: 'ul', items: ['First item', 'Second item', 'Third item'] };
            break;
          case 'table':
            block.content = { 
              headers: ['Header 1', 'Header 2'], 
              rows: [['Data 1', 'Data 2'], ['Data 3', 'Data 4']]
            };
            break;
          case 'callout':
            block.content = { type: 'info', title: 'Important Note', text: 'Your message here...' };
            break;
          case 'divider':
            block.content = {};
            break;
        }
        
        contentBlocks.push(block);
        renderContentBlocks();
        syncBlocksToHTML();
      }
      
      // Render all content blocks
      window.renderContentBlocks = function() {
        const container = document.getElementById('contentBlocksContainer');
        const emptyState = document.getElementById('emptyBuilderState');
        
        if (contentBlocks.length === 0) {
          if (emptyState) emptyState.classList.remove('hidden');
          return;
        }
        
        if (emptyState) emptyState.classList.add('hidden');
        
        container.innerHTML = contentBlocks.map((block, index) => {
          return renderBlock(block, index);
        }).join('');
      }
      
      // Render individual block
      function renderBlock(block, index) {
        const blockTypeColors = {
          heading: 'from-blue-100 to-blue-200',
          text: 'from-gray-100 to-gray-200',
          list: 'from-green-100 to-green-200',
          table: 'from-orange-100 to-orange-200',
          callout: 'from-yellow-100 to-yellow-200',
          divider: 'from-gray-100 to-gray-200'
        };
        
        let blockHTML = '<div class="bg-gradient-to-r ' + blockTypeColors[block.type] + ' p-4 rounded-lg border-2 border-white shadow-md hover:shadow-lg transition-all" data-block-id="' + block.id + '">' +
          '<div class="flex justify-between items-start mb-3">' +
          '<span class="text-xs font-bold text-gray-600 uppercase px-2 py-1 bg-white rounded">' + block.type + '</span>' +
          '<div class="flex gap-1">';
        
        if (index > 0) {
          blockHTML += '<button onclick="moveBlockUp(' + index + ')" class="px-2 py-1 bg-white rounded hover:bg-gray-50 text-xs"><i class="fas fa-arrow-up"></i></button>';
        }
        if (index < contentBlocks.length - 1) {
          blockHTML += '<button onclick="moveBlockDown(' + index + ')" class="px-2 py-1 bg-white rounded hover:bg-gray-50 text-xs"><i class="fas fa-arrow-down"></i></button>';
        }
        blockHTML += '<button onclick="editBlock(' + index + ')" class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-xs"><i class="fas fa-edit"></i></button>' +
          '<button onclick="deleteBlock(' + index + ')" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs"><i class="fas fa-trash"></i></button>' +
          '</div></div>';
        
        // Render block preview
        switch(block.type) {
          case 'heading':
            blockHTML += '<' + block.content.level + ' class="font-bold text-gray-800">' + block.content.text + '</' + block.content.level + '>';
            break;
          case 'text':
            blockHTML += '<p class="text-gray-700">' + block.content.text + '</p>';
            break;
          case 'list':
            const listTag = block.content.type === 'ol' ? 'ol' : 'ul';
            const listClass = block.content.type === 'ol' ? 'list-decimal' : 'list-disc';
            blockHTML += '<' + listTag + ' class="' + listClass + ' list-inside space-y-1">';
            block.content.items.forEach(item => {
              blockHTML += '<li>' + item + '</li>';
            });
            blockHTML += '</' + listTag + '>';
            break;
          case 'table':
            blockHTML += '<table class="w-full border text-sm"><thead class="bg-gray-100"><tr>';
            block.content.headers.forEach(header => {
              blockHTML += '<th class="border px-2 py-1">' + header + '</th>';
            });
            blockHTML += '</tr></thead><tbody>';
            block.content.rows.forEach(row => {
              blockHTML += '<tr>';
              row.forEach(cell => {
                blockHTML += '<td class="border px-2 py-1">' + cell + '</td>';
              });
              blockHTML += '</tr>';
            });
            blockHTML += '</tbody></table>';
            break;
          case 'callout':
            const calloutColors = {
              info: 'bg-blue-50 border-blue-400',
              warning: 'bg-yellow-50 border-yellow-400',
              success: 'bg-green-50 border-green-400'
            };
            blockHTML += '<div class="border-l-4 p-3 ' + calloutColors[block.content.type] + '">' +
              '<p class="font-semibold">' + block.content.title + '</p>' +
              '<p class="text-sm">' + block.content.text + '</p>' +
              '</div>';
            break;
          case 'divider':
            blockHTML += '<hr class="border-gray-400">';
            break;
        }
        
        blockHTML += '</div>';
        return blockHTML;
      }
      
      // Move block up
      window.moveBlockUp = function(index) {
        if (index > 0) {
          [contentBlocks[index], contentBlocks[index - 1]] = [contentBlocks[index - 1], contentBlocks[index]];
          renderContentBlocks();
          syncBlocksToHTML();
        }
      }
      
      // Move block down
      window.moveBlockDown = function(index) {
        if (index < contentBlocks.length - 1) {
          [contentBlocks[index], contentBlocks[index + 1]] = [contentBlocks[index + 1], contentBlocks[index]];
          renderContentBlocks();
          syncBlocksToHTML();
        }
      }
      
      // Edit block (inline editing)
      window.editBlock = function(index) {
        const block = contentBlocks[index];
        let newContent;
        
        switch(block.type) {
          case 'heading':
            newContent = prompt('Edit heading:', block.content.text);
            if (newContent) block.content.text = newContent;
            break;
          case 'text':
            newContent = prompt('Edit text:', block.content.text);
            if (newContent) block.content.text = newContent;
            break;
          case 'list':
            newContent = prompt('Edit list items (comma-separated):', block.content.items.join(', '));
            if (newContent) block.content.items = newContent.split(',').map(s => s.trim());
            break;
          case 'callout':
            const newTitle = prompt('Edit title:', block.content.title);
            if (newTitle) block.content.title = newTitle;
            const newText = prompt('Edit message:', block.content.text);
            if (newText) block.content.text = newText;
            break;
        }
        
        renderContentBlocks();
        syncBlocksToHTML();
      }
      
      // Delete block
      window.deleteBlock = function(index) {
        if (confirm('Delete this block?')) {
          contentBlocks.splice(index, 1);
          renderContentBlocks();
          syncBlocksToHTML();
        }
      }
      
      // Sync blocks to HTML (for saving)
      function syncBlocksToHTML() {
        let html = '';
        
        contentBlocks.forEach(block => {
          switch(block.type) {
            case 'heading':
              html += '<' + block.content.level + ' class="text-2xl font-bold mb-3 mt-6">' + block.content.text + '</' + block.content.level + '>' + String.fromCharCode(10);
              break;
            case 'text':
              html += '<p class="mb-4">' + block.content.text + '</p>' + String.fromCharCode(10);
              break;
            case 'list':
              const listTag = block.content.type === 'ol' ? 'ol' : 'ul';
              const listClass = block.content.type === 'ol' ? 'list-decimal' : 'list-disc';
              html += '<' + listTag + ' class="' + listClass + ' list-inside space-y-1 mb-4">' + String.fromCharCode(10);
              block.content.items.forEach(item => {
                html += '  <li>' + item + '</li>' + String.fromCharCode(10);
              });
              html += '</' + listTag + '>' + String.fromCharCode(10);
              break;
            case 'table':
              html += '<table class="w-full border-collapse border border-gray-300 mb-4">' + String.fromCharCode(10);
              html += '  <thead><tr class="bg-gray-100">';
              block.content.headers.forEach(header => {
                html += '<th class="border border-gray-300 px-4 py-2">' + header + '</th>';
              });
              html += '</tr></thead>' + String.fromCharCode(10);
              html += '  <tbody>';
              block.content.rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                  html += '<td class="border border-gray-300 px-4 py-2">' + cell + '</td>';
                });
                html += '</tr>';
              });
              html += '</tbody></table>' + String.fromCharCode(10);
              break;
            case 'callout':
              const calloutColors = {
                info: 'bg-blue-50 border-blue-300 text-blue-800',
                warning: 'bg-yellow-50 border-yellow-300 text-yellow-800',
                success: 'bg-green-50 border-green-300 text-green-800'
              };
              html += '<div class="border-l-4 p-4 mb-4 ' + calloutColors[block.content.type] + '">' + String.fromCharCode(10);
              html += '  <p class="font-semibold">' + block.content.title + '</p>' + String.fromCharCode(10);
              html += '  <p>' + block.content.text + '</p>' + String.fromCharCode(10);
              html += '</div>' + String.fromCharCode(10);
              break;
            case 'divider':
              html += '<hr class="my-6 border-gray-300">' + String.fromCharCode(10);
              break;
          }
        });
        
        document.getElementById('infoPageContent').value = html;
      }
      
      // Toggle live preview
      window.toggleLivePreview = function() {
        syncBlocksToHTML();
        window.previewContent();
      }

      window.previewContent = function() {
        const content = document.getElementById('infoPageContent').value;
        const title = document.getElementById('infoPageTitle').value || 'Preview';
        const icon = document.getElementById('infoPageIcon').value;
        
        const win = window.open('', '_blank', 'width=800,height=600');
        win.document.write('<html><head><title>' + title + '</title>');
        win.document.write('<script src="https://cdn.tailwindcss.com"><\\/script>');
        win.document.write('<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">');
        win.document.write('</head><body class="bg-gray-50 p-8">');
        win.document.write('<div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">');
        win.document.write('<h1 class="text-3xl font-bold mb-6"><i class="' + icon + ' mr-3 text-purple-600"></i>' + title + '</h1>');
        win.document.write('<div class="prose max-w-none">' + content + '</div>');
        win.document.write('</div></body></html>');
        win.document.close();
      }

      // Auto-generate page key from title
      document.getElementById('infoPageTitle').addEventListener('input', (e) => {
        if (!currentInfoPageId) {
          const key = e.target.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
          document.getElementById('infoPageKey').value = key;
        }
      });

      async function loadActivities() {
        try {
          const response = await fetch('/api/admin/activities?property_id=1');
          const activities = await response.json();
          const list = document.getElementById('activitiesList');
          
          if (!activities || activities.length === 0) {
            list.innerHTML = '<p class="text-gray-500 text-center py-4">No activities yet. Add vendors to start!</p>';
            return;
          }
          
          list.innerHTML = activities.map(a => \`
            <div class="border rounded-lg p-4 hover:shadow-md transition">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-lg font-bold">\${a.title_en}</h3>
                  <p class="text-sm text-gray-600">by \${a.business_name} â€¢ \${a.category_name}</p>
                  <div class="flex gap-4 mt-2 text-sm text-gray-600">
                    <span><i class="fas fa-tag mr-1"></i>USD \${a.price}</span>
                    <span><i class="far fa-clock mr-1"></i>\${a.duration_minutes} min</span>
                    <span><i class="fas fa-users mr-1"></i>Capacity: \${a.capacity_per_slot}</span>
                  </div>
                </div>
                <div class="flex flex-col gap-2 items-end">
                  <span class="px-3 py-1 rounded-full text-sm \${a.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">\${a.status}</span>
                  <button onclick="deactivateActivity(\${a.activity_id})" class="text-red-600 hover:text-red-800 text-sm">
                    <i class="fas fa-ban mr-1"></i>Deactivate
                  </button>
                </div>
              </div>
            </div>
          \`).join('');
        } catch (error) {
          console.error('Load activities error:', error);
        }
      }

      async function deactivateActivity(activityId) {
        if (!confirm('Deactivate this activity? It will no longer be visible to guests.')) return;
        try {
          const response = await fetch('/api/admin/activities/' + activityId, {
            method: 'DELETE'
          });
          const data = await response.json();
          if (data.success) {
            alert('Activity deactivated!');
            loadActivities();
          }
        } catch (error) {
          console.error('Deactivate activity error:', error);
          alert('Failed to deactivate activity');
        }
      }

      // Custom Sections Management
      async function loadCustomSections() {
        try {
          const response = await fetch('/api/admin/custom-sections?property_id=1');
          const data = await response.json();
          const list = document.getElementById('customSectionsList');
          
          if (!data.sections || data.sections.length === 0) {
            list.innerHTML = '<p class="text-gray-500 text-center py-4">No custom sections yet. Create your first custom section above!</p>';
            return;
          }
          
          list.innerHTML = data.sections.map(s => \`
            <div class="border rounded-lg p-4 hover:shadow-md transition">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-bold text-lg">
                    <i class="\${s.icon_class} mr-2" style="color: var(--primary-color);"></i>
                    \${s.section_name_en}
                  </h3>
                  <p class="text-sm text-gray-600">Key: <code class="bg-gray-100 px-2 py-1 rounded">\${s.section_key}</code></p>
                  <p class="text-sm text-gray-500 mt-1">Order: \${s.display_order} | Visible: \${s.is_visible ? 'âœ… Yes' : 'âŒ No'}</p>
                </div>
                <button onclick="deleteCustomSection(\${s.section_id})" class="bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                  <i class="fas fa-trash mr-1"></i>Delete
                </button>
              </div>
            </div>
          \`).join('');
        } catch (error) {
          console.error('Load custom sections error:', error);
        }
      }

      async function deleteCustomSection(sectionId) {
        if (!confirm('Delete this custom section? All offerings linked to this section will remain but will not be displayed.')) return;
        try {
          const response = await fetch('/api/admin/custom-sections/' + sectionId, {
            method: 'DELETE'
          });
          if (response.ok) {
            alert('Custom section deleted!');
            loadCustomSections();
          }
        } catch (error) {
          console.error('Delete custom section error:', error);
          alert('Failed to delete custom section');
        }
      }

      document.getElementById('addCustomSectionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const data = {
          property_id: 1,
          section_key: document.getElementById('sectionKey').value,
          section_name_en: document.getElementById('sectionNameEn').value,
          icon_class: document.getElementById('sectionIcon').value,
          color_class: document.getElementById('sectionColor').value,
          display_order: parseInt(document.getElementById('sectionOrder').value),
          is_visible: 1
        };
        
        try {
          const response = await fetch('/api/admin/custom-sections', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            alert('Custom section created! Now add offerings to this section.');
            loadCustomSections();
            e.target.reset();
          } else {
            alert('Failed to create custom section. Make sure the section key is unique.');
          }
        } catch (error) {
          console.error('Create custom section error:', error);
          alert('Failed to create custom section');
        }
      });

      // Helper function for admin dashboard - simple passthrough for locations
      function translateLocation(location) {
        return location || '';
      }

      // Hotel Offerings Management
      let allOfferings = [];
      let currentOfferingFilter = 'all';
      
      async function loadOfferings() {
        try {
          // Load property settings if not already loaded
          if (!adminPropertySettings) {
            const settingsResponse = await fetch('/api/admin/property-settings?property_id=1');
            adminPropertySettings = await settingsResponse.json();
          }
          
          const response = await fetch('/api/hotel-offerings/1');
          const data = await response.json();
          allOfferings = data.offerings || [];
          displayOfferings();
          
          // Also load custom sections for the dropdown
          await loadCustomSectionsDropdown();
          
          // Update filter buttons with custom section names
          updateAdminFilterButtons(adminPropertySettings);
        } catch (error) {
          console.error('Load offerings error:', error);
        }
      }
      
      async function loadCustomSectionsDropdown() {
        try {
          const response = await fetch('/api/admin/custom-sections?property_id=1');
          const data = await response.json();
          const dropdown = document.getElementById('offeringType');
          
          // Remove any previously added custom section options
          const existingOptions = dropdown.querySelectorAll('option[data-custom="true"]');
          existingOptions.forEach(opt => opt.remove());
          
          // Add custom sections to dropdown
          if (data.sections && data.sections.length > 0) {
            data.sections.forEach(section => {
              const option = document.createElement('option');
              option.value = section.section_key;
              option.textContent = section.section_name_en;
              option.setAttribute('data-custom', 'true');
              dropdown.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Load custom sections dropdown error:', error);
        }
      }
      
      function displayOfferings() {
        const filteredOfferings = currentOfferingFilter === 'all' 
          ? allOfferings 
          : allOfferings.filter(o => o.offering_type === currentOfferingFilter);
        
        const list = document.getElementById('offeringsList');
        if (filteredOfferings.length === 0) {
          list.innerHTML = '<p class="text-gray-500">No offerings found</p>';
          return;
        }
        
        list.innerHTML = filteredOfferings.map(o => {
          const typeColors = {
            restaurant: 'bg-blue-100 text-blue-700',
            event: 'bg-purple-100 text-purple-700',
            spa: 'bg-green-100 text-green-700',
            service: 'bg-gray-100 text-gray-700'
          };
          
          return \`
            <div class="border rounded-lg p-4 hover:shadow-md">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h3 class="font-bold text-lg">\${o.title}</h3>
                  <span class="inline-block px-2 py-1 rounded text-xs \${typeColors[o.offering_type] || typeColors.service}">
                    \${o.offering_type.toUpperCase()}
                  </span>
                </div>
                <div class="flex gap-2">
                  \${o.offering_type === 'restaurant' ? \`<a href="/admin/restaurant/\${o.offering_id}" class="text-green-600 hover:text-green-800" title="Manage Tables"><i class="fas fa-chair"></i></a>\` : ''}
                  <button onclick="editOffering(\${o.offering_id})" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteOffering(\${o.offering_id})" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <p class="text-sm text-gray-600 mb-2">\${o.short_description}</p>
              <div class="flex flex-wrap gap-3 text-sm text-gray-700">
                <span><i class="fas fa-dollar-sign mr-1"></i>\${o.currency} \${o.price || 'Free'}</span>
                <span><i class="fas fa-map-marker-alt mr-1"></i>\${o.location ? translateLocation(o.location) : 'N/A'}</span>
                \${o.duration_minutes ? \`<span><i class="fas fa-clock mr-1"></i>\${o.duration_minutes} min</span>\` : ''}
                \${o.event_date ? \`<span><i class="fas fa-calendar mr-1"></i>\${o.event_date}</span>\` : ''}
              </div>
            </div>
          \`;
        }).join('');
      }
      
      function filterOfferings(type) {
        currentOfferingFilter = type;
        document.querySelectorAll('.offering-filter-btn').forEach(btn => {
          if (btn.dataset.type === type) {
            btn.className = 'offering-filter-btn px-4 py-2 rounded bg-blue-500 text-white';
          } else {
            btn.className = 'offering-filter-btn px-4 py-2 rounded bg-gray-200';
          }
        });
        displayOfferings();
      }
      
      async function deleteOffering(offeringId) {
        if (!confirm('Delete this offering? This action cannot be undone.')) return;
        
        console.log('Attempting to delete offering:', offeringId);
        
        try {
          const response = await fetch('/api/admin/offerings/' + offeringId, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          console.log('Delete response status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('Delete failed with status:', response.status, errorText);
            alert('Failed to delete offering: ' + response.status + ' ' + errorText);
            return;
          }
          
          const data = await response.json();
          console.log('Delete response data:', data);
          
          if (data.success) {
            alert('Offering deleted successfully!');
            loadOfferings();
          } else {
            alert('Failed to delete offering: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Delete offering error:', error);
          alert('Failed to delete offering: ' + error.message);
        }
      }
      
      async function translateAllOfferings() {
        const btn = document.getElementById('translateAllBtn');
        const originalText = btn.innerHTML;
        
        if (!confirm('This will translate ALL offerings to 8 languages (Arabic, German, Russian, Polish, Italian, French, Czech, Ukrainian).' + String.fromCharCode(10) + String.fromCharCode(10) + 'This may take 2-3 minutes depending on the number of offerings.' + String.fromCharCode(10) + String.fromCharCode(10) + 'Proceed?')) {
          return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Translating...';
        
        try {
          const response = await fetch('/api/admin/offerings/translate-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              openai_api_key: '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'
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Translation Complete!' + String.fromCharCode(10) + String.fromCharCode(10) + 'Total offerings: ' + data.total + String.fromCharCode(10) + 'Successfully translated: ' + data.translated + String.fromCharCode(10) + 'Failed: ' + data.failed + String.fromCharCode(10) + String.fromCharCode(10) + 'All offerings now available in 8 languages!');
            loadOfferings();
          } else {
            alert('Translation failed: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Batch translation error:', error);
          alert('Translation failed: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }
      
      async function translateAllActivities() {
        const btn = document.getElementById('translateAllActivitiesBtn');
        const originalText = btn.innerHTML;
        
        if (!confirm('This will translate ALL activities to 8 languages (Arabic, German, Russian, Polish, Italian, French, Czech, Ukrainian).' + String.fromCharCode(10) + String.fromCharCode(10) + 'This may take 2-3 minutes depending on the number of activities.' + String.fromCharCode(10) + String.fromCharCode(10) + 'Proceed?')) {
          return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Translating...';
        
        try {
          const response = await fetch('/api/admin/activities/translate-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              openai_api_key: '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'
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Translation Complete!' + String.fromCharCode(10) + String.fromCharCode(10) + 'Total activities: ' + data.total + String.fromCharCode(10) + 'Successfully translated: ' + data.translated + String.fromCharCode(10) + 'Failed: ' + data.failed + String.fromCharCode(10) + String.fromCharCode(10) + 'All activities now available in 8 languages!');
            loadActivities();
          } else {
            alert('Translation failed: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Activities batch translation error:', error);
          alert('Translation failed: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }
      
      async function editOffering(offeringId) {
        const offering = allOfferings.find(o => o.offering_id === offeringId);
        if (!offering) return;
        
        // Populate form with existing data
        document.getElementById('offeringType').value = offering.offering_type;
        document.getElementById('offeringTitle').value = offering.title_en;
        document.getElementById('offeringDescription').value = offering.short_description_en;
        document.getElementById('offeringFullDescription').value = offering.full_description_en || '';
        document.getElementById('offeringPrice').value = offering.price || '';
        document.getElementById('offeringLocation').value = offering.location || '';
        document.getElementById('offeringDuration').value = offering.duration_minutes || '';
        document.getElementById('offeringImages').value = offering.images ? offering.images.join(String.fromCharCode(10)) : '';
        document.getElementById('offeringVideoUrl').value = offering.video_url || '';
        document.getElementById('offeringRequiresBooking').checked = offering.requires_booking === 1;
        
        if (offering.offering_type === 'event') {
          document.getElementById('eventFields').classList.remove('hidden');
          document.getElementById('eventDate').value = offering.event_date || '';
          document.getElementById('eventStartTime').value = offering.event_start_time || '';
          document.getElementById('eventEndTime').value = offering.event_end_time || '';
        }
        
        // Load and show restaurant menus if restaurant type
        if (offering.offering_type === 'restaurant') {
          document.getElementById('restaurantFields').classList.remove('hidden');
          
          // Load existing menus
          fetch('/api/offerings/' + offeringId + '/menus')
            .then(res => res.json())
            .then(data => {
              if (data.success && data.menus) {
                const menuUrls = data.menus.map(m => m.menu_url).join(String.fromCharCode(10));
                document.getElementById('menuUrls').value = menuUrls;
              }
            })
            .catch(err => console.error('Error loading menus for edit:', err));
        }
        
        // Change form submit to update instead of create
        const form = document.getElementById('addOfferingForm');
        form.onsubmit = async (e) => {
          e.preventDefault();
          const images = document.getElementById('offeringImages').value.split(String.fromCharCode(10)).map(url => url.trim()).filter(Boolean);
          
          // Get menu URLs if restaurant
          const menuUrls = [];
          const offeringType = document.getElementById('offeringType').value;
          if (offeringType === 'restaurant') {
            const menuUrlsText = document.getElementById('menuUrls').value;
            if (menuUrlsText) {
              menuUrlsText.split(String.fromCharCode(10)).forEach(url => {
                const trimmedUrl = url.trim();
                if (trimmedUrl) menuUrls.push(trimmedUrl);
              });
            }
          }
          
          try {
            const response = await fetch('/api/admin/offerings/' + offeringId, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                offering_type: offeringType,
                title_en: document.getElementById('offeringTitle').value,
                short_description_en: document.getElementById('offeringDescription').value,
                full_description_en: document.getElementById('offeringFullDescription').value,
                price: parseFloat(document.getElementById('offeringPrice').value) || 0,
                location: document.getElementById('offeringLocation').value,
                duration_minutes: parseInt(document.getElementById('offeringDuration').value) || null,
                requires_booking: document.getElementById('offeringRequiresBooking').checked ? 1 : 0,
                images: JSON.stringify(images),
                video_url: document.getElementById('offeringVideoUrl').value || null,
                event_date: document.getElementById('eventDate').value || null,
                event_start_time: document.getElementById('eventStartTime').value || null,
                event_end_time: document.getElementById('eventEndTime').value || null,
                menu_urls: menuUrls.length > 0 ? menuUrls : null
              })
            });
            
            const data = await response.json();
            if (data.success) {
              alert('Offering updated successfully!');
              form.reset();
              document.getElementById('eventFields').classList.add('hidden');
              document.getElementById('restaurantFields').classList.add('hidden');
              document.getElementById('menuUrls').value = '';
              // Reset form back to create mode
              form.onsubmit = null;
              loadOfferings();
            }
          } catch (error) {
            console.error('Update offering error:', error);
            alert('Failed to update offering');
          }
        };
        
        // Scroll to form
        form.scrollIntoView({ behavior: 'smooth' });
      }


      // Show/hide event-specific fields based on offering type
      document.getElementById('offeringType').addEventListener('change', (e) => {
        const eventFields = document.getElementById('eventFields');
        const restaurantFields = document.getElementById('restaurantFields');
        
        if (e.target.value === 'event') {
          eventFields.classList.remove('hidden');
          restaurantFields.classList.add('hidden');
        } else if (e.target.value === 'restaurant') {
          restaurantFields.classList.remove('hidden');
          eventFields.classList.add('hidden');
        } else {
          eventFields.classList.add('hidden');
          restaurantFields.classList.add('hidden');
        }
      });

      document.getElementById('addRoomForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const response = await fetch('/api/admin/rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              room_number: document.getElementById('roomNumber').value,
              room_type: document.getElementById('roomType').value
            })
          });
          const data = await response.json();
          if (data.success) {
            alert('Room created with QR code!');
            document.getElementById('addRoomForm').reset();
            loadRooms();
          }
        } catch (error) {
          console.error('Add room error:', error);
          alert('Failed to create room');
        }
      });

      document.getElementById('addOfferingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const images = document.getElementById('offeringImages').value.split(String.fromCharCode(10)).map(url => url.trim()).filter(Boolean);
          const selectedType = document.getElementById('offeringType').value;
          const selectedOption = document.getElementById('offeringType').selectedOptions[0];
          const isCustomSection = selectedOption.getAttribute('data-custom') === 'true';
          
          // Get menu URLs if restaurant
          const menuUrls = [];
          if (selectedType === 'restaurant') {
            const menuUrlsText = document.getElementById('menuUrls').value;
            if (menuUrlsText) {
              menuUrlsText.split(String.fromCharCode(10)).forEach(url => {
                const trimmedUrl = url.trim();
                if (trimmedUrl) menuUrls.push(trimmedUrl);
              });
            }
          }
          
          const payload = {
            property_id: 1,
            offering_type: isCustomSection ? 'custom' : selectedType,
            custom_section_key: isCustomSection ? selectedType : null,
            title_en: document.getElementById('offeringTitle').value,
            short_description_en: document.getElementById('offeringDescription').value,
            full_description_en: document.getElementById('offeringFullDescription').value,
            price: parseFloat(document.getElementById('offeringPrice').value) || 0,
            location: document.getElementById('offeringLocation').value,
            duration_minutes: parseInt(document.getElementById('offeringDuration').value) || null,
            requires_booking: document.getElementById('offeringRequiresBooking').checked ? 1 : 0,
            images: JSON.stringify(images),
            video_url: document.getElementById('offeringVideoUrl').value || null,
            event_date: document.getElementById('eventDate').value || null,
            event_start_time: document.getElementById('eventStartTime').value || null,
            event_end_time: document.getElementById('eventEndTime').value || null,
            menu_urls: menuUrls.length > 0 ? menuUrls : null
          };
          
          const response = await fetch('/api/admin/offerings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          const data = await response.json();
          if (data.success) {
            alert('Hotel offering added successfully!');
            document.getElementById('addOfferingForm').reset();
            document.getElementById('eventFields').classList.add('hidden');
            document.getElementById('restaurantFields').classList.add('hidden');
            document.getElementById('menuUrls').value = '';
            loadOfferings();
          }
        } catch (error) {
          console.error('Add offering error:', error);
          alert('Failed to add offering');
        }
      });

      document.getElementById('addVendorForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const response = await fetch('/api/admin/vendors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              business_name: document.getElementById('businessName').value,
              email: document.getElementById('vendorEmail').value,
              phone: document.getElementById('vendorPhone').value,
              password: document.getElementById('vendorPassword').value
            })
          });
          const data = await response.json();
          if (data.success) {
            alert('Vendor added successfully!');
            document.getElementById('addVendorForm').reset();
            loadVendors();
          }
        } catch (error) {
          console.error('Add vendor error:', error);
          alert('Failed to add vendor');
        }
      });

      async function regenerateQR(roomId) {
        if (!confirm('Regenerate QR code for this room?')) return;
        try {
          const response = await fetch('/api/admin/rooms/' + roomId + '/regenerate-qr', { method: 'POST' });
          const data = await response.json();
          if (data.success) {
            alert('QR code regenerated!');
            loadRooms();
          }
        } catch (error) {
          console.error('Regenerate QR error:', error);
        }
      }

      async function removeVendor(vendorId) {
        if (!confirm('Remove this vendor? This will deactivate all their activities.')) return;
        try {
          const response = await fetch('/api/admin/vendors/' + vendorId, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ property_id: 1 })
          });
          const data = await response.json();
          if (data.success) {
            alert('Vendor removed successfully');
            loadVendors();
          }
        } catch (error) {
          console.error('Remove vendor error:', error);
          alert('Failed to remove vendor');
        }
      }

      let adminPropertySettings = null; // Store settings globally for admin panel
      
      async function loadSettings() {
        try {
          const response = await fetch('/api/admin/property-settings?property_id=1');
          const settings = await response.json();
          adminPropertySettings = settings; // Store for later use
          
          // Set homepage URL
          const homepageUrl = window.location.origin + '/hotel/' + settings.slug;
          document.getElementById('homepageUrl').value = homepageUrl;
          document.getElementById('visitHomepage').href = homepageUrl;
          
          // Load current settings
          document.getElementById('hotelName').value = settings.name || '';
          document.getElementById('hotelTagline').value = settings.tagline || '';
          document.getElementById('hotelEmail').value = settings.contact_email || '';
          document.getElementById('hotelPhone').value = settings.contact_phone || '';
          document.getElementById('hotelAddress').value = settings.address || '';
          
          // Load section names (custom labels)
          document.getElementById('sectionNameRestaurants').value = settings.section_restaurants_en || '';
          document.getElementById('sectionNameEvents').value = settings.section_events_en || '';
          document.getElementById('sectionNameSpa').value = settings.section_spa_en || '';
          document.getElementById('sectionNameService').value = settings.section_service_en || '';
          document.getElementById('sectionNameActivities').value = settings.section_activities_en || '';
          
          document.getElementById('brandLogoUrl').value = settings.brand_logo_url || '';
          document.getElementById('heroImageUrl').value = settings.hero_image_url || '';
          document.getElementById('heroOverlayOpacity').value = settings.hero_overlay_opacity || 30;
          document.getElementById('heroOverlayValue').textContent = (settings.hero_overlay_opacity || 30) + '%';
          
          // Set hero image effect radio
          const effectRadios = document.querySelectorAll('input[name="heroImageEffect"]');
          effectRadios.forEach(radio => {
            if (radio.value === (settings.hero_image_effect || 'none')) {
              radio.checked = true;
            }
          });
          
          // Hero overlay opacity slider
          document.getElementById('heroOverlayOpacity').addEventListener('input', (e) => {
            document.getElementById('heroOverlayValue').textContent = e.target.value + '%';
          });
          
          document.getElementById('primaryColor').value = settings.primary_color || '#3B82F6';
          document.getElementById('primaryColorText').value = settings.primary_color || '#3B82F6';
          document.getElementById('secondaryColor').value = settings.secondary_color || '#10B981';
          document.getElementById('secondaryColorText').value = settings.secondary_color || '#10B981';
          document.getElementById('accentColor').value = settings.accent_color || '#F59E0B';
          document.getElementById('accentColorText').value = settings.accent_color || '#F59E0B';
          
          document.getElementById('fontFamily').value = settings.font_family || 'inter';
          document.getElementById('buttonStyle').value = settings.button_style || 'rounded';
          
          // Update admin filter buttons with custom section names
          updateAdminFilterButtons(settings);
          document.getElementById('cardStyle').value = settings.card_style || 'shadow';
          document.getElementById('headerStyle').value = settings.header_style || 'transparent';
          
          // Set layout style radio
          const layoutRadios = document.querySelectorAll('input[name="layoutStyle"]');
          layoutRadios.forEach(radio => {
            if (radio.value === (settings.layout_style || 'modern')) {
              radio.checked = true;
            }
          });
          
          // Sync color pickers with text inputs
          document.getElementById('primaryColor').addEventListener('input', (e) => {
            document.getElementById('primaryColorText').value = e.target.value;
          });
          document.getElementById('primaryColorText').addEventListener('input', (e) => {
            document.getElementById('primaryColor').value = e.target.value;
          });
          
          document.getElementById('secondaryColor').addEventListener('input', (e) => {
            document.getElementById('secondaryColorText').value = e.target.value;
          });
          document.getElementById('secondaryColorText').addEventListener('input', (e) => {
            document.getElementById('secondaryColor').value = e.target.value;
          });
          
          document.getElementById('accentColor').addEventListener('input', (e) => {
            document.getElementById('accentColorText').value = e.target.value;
            updateGradientPreview();
          });
          document.getElementById('accentColorText').addEventListener('input', (e) => {
            document.getElementById('accentColor').value = e.target.value;
            updateGradientPreview();
          });
          
          // Gradient checkbox
          document.getElementById('primaryGradient').checked = settings.use_gradient === 1;
          if (settings.use_gradient === 1) {
            document.getElementById('primaryGradientPreview').classList.remove('hidden');
          }
          
          document.getElementById('primaryGradient').addEventListener('change', (e) => {
            if (e.target.checked) {
              document.getElementById('primaryGradientPreview').classList.remove('hidden');
              updateGradientPreview();
            } else {
              document.getElementById('primaryGradientPreview').classList.add('hidden');
            }
          });
          
          updateGradientPreview();
          
          // Load homepage layout settings
          document.getElementById('hotelMapUrl').value = settings.hotel_map_url || '';
          document.getElementById('showHotelMap').checked = settings.show_hotel_map === 1;
          
          // Render section visibility checkboxes dynamically
          await renderSectionVisibility();
          
          // Set visibility values after rendering
          document.getElementById('showRestaurants').checked = settings.show_restaurants === 1;
          document.getElementById('showEvents').checked = settings.show_events === 1;
          document.getElementById('showSpa').checked = settings.show_spa === 1;
          document.getElementById('showService').checked = settings.show_service === 1;
          document.getElementById('showActivities').checked = settings.show_activities === 1;
          
          // Load section order
          const sectionOrder = settings.homepage_section_order ? 
            JSON.parse(settings.homepage_section_order) : 
            ['restaurants', 'events', 'spa', 'service', 'activities', 'beach-booking'];
          await renderSectionOrder(sectionOrder);
          
        } catch (error) {
          console.error('Load settings error:', error);
          alert('Failed to load settings');
        }
      }
      
      function updateAdminFilterButtons(settings) {
        console.log('ðŸ”§ updateAdminFilterButtons called with settings:', settings);
        
        // Update admin panel filter button text with custom section names
        const sections = [
          { key: 'restaurant', elementId: 'admin-pill-restaurants', settingKey: 'section_restaurants_en', default: 'Dining & Drinks', optionValue: 'restaurant', optionDefault: 'Dining & Drinks' },
          { key: 'event', elementId: 'admin-pill-events', settingKey: 'section_events_en', default: 'Events & Entertainment', optionValue: 'event', optionDefault: 'Events & Entertainment' },
          { key: 'spa', elementId: 'admin-pill-spa', settingKey: 'section_spa_en', default: 'Spa', optionValue: 'spa', optionDefault: 'Spa/Wellness' }
        ];
        
        sections.forEach(section => {
          // Update filter button
          const element = document.getElementById(section.elementId);
          console.log('ðŸ” Looking for element:', section.elementId, 'Found:', !!element);
          if (element) {
            const customName = settings[section.settingKey];
            console.log('ðŸ“ Setting key:', section.settingKey, 'Value from DB:', customName);
            element.textContent = customName || section.default;
            console.log('âœ… Admin filter updated:', section.key, 'â†’', customName || section.default);
          } else {
            console.warn('âŒ Element not found:', section.elementId);
          }
          
          // Update dropdown option
          const dropdown = document.getElementById('offeringType');
          if (dropdown) {
            const option = dropdown.querySelector('option[value="' + section.optionValue + '"]');
            if (option) {
              const customName = settings[section.settingKey];
              option.textContent = customName || section.optionDefault;
              console.log('âœ… Dropdown updated:', section.optionValue, 'â†’', customName || section.optionDefault);
            }
          }
        });
      }
      
      // ============================================
      // CHATBOT MANAGEMENT
      // ============================================
      
      async function loadChatbot() {
        try {
          // Load chatbot settings
          const settingsRes = await fetch('/api/chatbot/settings/1');
          const settingsData = await settingsRes.json();
          
          if (settingsData.success && settingsData.settings) {
            document.getElementById('chatbotEnabled').checked = settingsData.settings.chatbot_enabled === 1;
            document.getElementById('chatbotName').value = settingsData.settings.chatbot_name || '';
            document.getElementById('chatbotGreeting').value = settingsData.settings.chatbot_greeting_en || '';
            
            const primaryColor = settingsData.settings.chatbot_primary_color || '#667eea';
            document.getElementById('chatbotPrimaryColor').value = primaryColor;
            document.getElementById('chatbotPrimaryColorText').value = primaryColor;
            
            // Sync color inputs
            document.getElementById('chatbotPrimaryColor').addEventListener('input', (e) => {
              document.getElementById('chatbotPrimaryColorText').value = e.target.value;
            });
            document.getElementById('chatbotPrimaryColorText').addEventListener('input', (e) => {
              if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                document.getElementById('chatbotPrimaryColor').value = e.target.value;
              }
            });
          }
          
          // Load documents
          await loadChatbotDocuments();
        } catch (error) {
          console.error('Load chatbot error:', error);
        }
      }
      
      async function loadChatbotDocuments() {
        try {
          const response = await fetch('/api/admin/chatbot/documents?property_id=1');
          const data = await response.json();
          
          const container = document.getElementById('documentsList');
          
          if (!data.success || !data.documents || data.documents.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8"><i class="fas fa-folder-open mr-2"></i>No documents yet. Add your first knowledge document above!</p>';
            return;
          }
          
          container.innerHTML = data.documents.map(doc => {
            const typeClass = doc.document_type === 'faq' ? 'bg-blue-100 text-blue-800' : doc.document_type === 'policy' ? 'bg-purple-100 text-purple-800' : doc.document_type === 'amenity' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
            return '<div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition">' +
              '<div class="flex justify-between items-start">' +
                '<div class="flex-1">' +
                  '<div class="flex items-center mb-2">' +
                    '<span class="px-3 py-1 text-xs font-semibold rounded-full ' + typeClass + ' mr-2">' +
                      doc.document_type.toUpperCase() +
                    '</span>' +
                    '<h4 class="text-lg font-bold">' + doc.title + '</h4>' +
                  '</div>' +
                  '<p class="text-gray-600 text-sm mb-2 line-clamp-2">' + doc.content.substring(0, 150) + '...</p>' +
                  '<div class="flex items-center text-xs text-gray-500 space-x-4">' +
                    '<span><i class="fas fa-cube mr-1"></i>' + doc.chunk_count + ' chunks</span>' +
                    '<span><i class="fas fa-calendar mr-1"></i>' + new Date(doc.created_at).toLocaleDateString() + '</span>' +
                  '</div>' +
                '</div>' +
                '<div class="ml-4 flex gap-2">' +
                  '<button onclick="editChatbotDocument(' + doc.document_id + ')" class="px-3 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition" title="Edit document">' +
                    '<i class="fas fa-edit"></i>' +
                  '</button>' +
                  '<button onclick="deleteChatbotDocument(' + doc.document_id + ')" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Delete document">' +
                    '<i class="fas fa-trash"></i>' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>';
          }).join('');
        } catch (error) {
          console.error('Load documents error:', error);
          document.getElementById('documentsList').innerHTML = '<p class="text-red-500 text-center py-8"><i class="fas fa-exclamation-circle mr-2"></i>Error loading documents</p>';
        }
      }
      
      window.saveChatbotSettings = async function() {
        try {
          const response = await fetch('/api/admin/chatbot/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              chatbot_enabled: document.getElementById('chatbotEnabled').checked,
              chatbot_name: document.getElementById('chatbotName').value,
              chatbot_greeting_en: document.getElementById('chatbotGreeting').value,
              chatbot_primary_color: document.getElementById('chatbotPrimaryColorText').value
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Chatbot settings saved successfully!');
          } else {
            alert('âŒ Failed to save settings: ' + data.error);
          }
        } catch (error) {
          console.error('Save settings error:', error);
          alert('âŒ Error saving settings');
        }
      };
      
      // Sync knowledge base with all hotel data
      window.syncKnowledgeBase = async function() {
        const syncBtn = document.getElementById('syncBtn');
        const originalHTML = syncBtn.innerHTML;
        
        try {
          syncBtn.disabled = true;
          syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing... Please wait';
          
          const response = await fetch('/api/admin/chatbot/sync-knowledge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ property_id: 1 })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('Successfully synced ' + data.total_documents + ' documents with ' + data.total_chunks + ' searchable chunks! Your AI chatbot now knows about all your restaurants, activities, spa services, and events. Guests can ask questions immediately.');
            loadChatbotDocuments(); // Reload documents list
          } else {
            alert('Sync failed: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Sync error:', error);
          alert('âŒ Error during sync: ' + error.message);
        } finally {
          syncBtn.disabled = false;
          syncBtn.innerHTML = originalHTML;
        }
      };
      
      // Analytics Functions
      window.toggleAnalytics = async function() {
        const section = document.getElementById('analyticsSection');
        const btn = document.getElementById('analyticsToggleBtn');
        
        if (section.classList.contains('hidden')) {
          section.classList.remove('hidden');
          btn.innerHTML = '<i class="fas fa-chart-bar mr-2"></i>Hide Analytics';
          await loadChatbotAnalytics();
        } else {
          section.classList.add('hidden');
          btn.innerHTML = '<i class="fas fa-chart-bar mr-2"></i>View Analytics';
        }
      };
      
      async function loadChatbotAnalytics() {
        await Promise.all([
          loadAnalyticsStats(),
          loadTopQuestions(),
          loadChatHistory()
        ]);
      }
      
      async function loadAnalyticsStats() {
        try {
          const response = await fetch('/api/admin/chatbot/analytics/stats?property_id=1');
          const data = await response.json();
          
          if (data.success) {
            document.getElementById('statTotalConversations').textContent = data.stats.total_conversations || 0;
            document.getElementById('statTotalMessages').textContent = data.stats.total_messages || 0;
            document.getElementById('statAvgResponseTime').textContent = (data.stats.avg_response_time || 0) + 's';
            document.getElementById('statTodayChats').textContent = data.stats.today_chats || 0;
          }
        } catch (error) {
          console.error('Load stats error:', error);
        }
      }
      
      async function loadTopQuestions() {
        try {
          const response = await fetch('/api/admin/chatbot/analytics/top-questions?property_id=1&limit=10');
          const data = await response.json();
          
          const container = document.getElementById('topQuestionsList');
          
          if (data.success && data.questions && data.questions.length > 0) {
            container.innerHTML = data.questions.map((q, index) => 
              '<div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">' +
                '<div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-full flex items-center justify-center font-bold text-sm">' + (index + 1) + '</div>' +
                '<div class="flex-1">' +
                  '<div class="font-medium text-gray-900">' + q.question + '</div>' +
                  '<div class="text-sm text-gray-500 mt-1">Asked ' + q.count + ' times</div>' +
                '</div>' +
              '</div>'
            ).join('');
          } else {
            container.innerHTML = '<p class="text-gray-500">No questions asked yet</p>';
          }
        } catch (error) {
          console.error('Load top questions error:', error);
          document.getElementById('topQuestionsList').innerHTML = '<p class="text-red-500">Error loading questions</p>';
        }
      }
      
      window.loadChatHistory = async function() {
        try {
          const date = document.getElementById('filterDate').value;
          const search = document.getElementById('searchQuery').value;
          
          let url = '/api/admin/chatbot/analytics/chat-history?property_id=1';
          if (date) url += '&date=' + date;
          if (search) url += '&search=' + encodeURIComponent(search);
          
          const response = await fetch(url);
          const data = await response.json();
          
          const container = document.getElementById('chatHistoryList');
          
          if (data.success && data.chats && data.chats.length > 0) {
            container.innerHTML = data.chats.map(chat => 
              '<div class="border-l-4 border-blue-500 bg-gray-50 p-4 rounded-lg">' +
                '<div class="flex items-center justify-between mb-2">' +
                  '<div class="flex items-center gap-2">' +
                    '<span class="text-xs font-mono bg-gray-200 px-2 py-1 rounded">' + chat.session_id.substring(0, 8) + '</span>' +
                    '<span class="text-xs text-gray-500">' + new Date(chat.created_at).toLocaleString() + '</span>' +
                  '</div>' +
                  '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">' + chat.message_count + ' messages</span>' +
                '</div>' +
                '<div class="space-y-2">' +
                  '<div class="flex items-start gap-2">' +
                    '<div class="flex-shrink-0 w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs"><i class="fas fa-user"></i></div>' +
                    '<div class="flex-1 bg-white p-2 rounded-lg text-sm">' + chat.user_message + '</div>' +
                  '</div>' +
                  (chat.ai_message ? 
                    '<div class="flex items-start gap-2">' +
                      '<div class="flex-shrink-0 w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-xs"><i class="fas fa-robot"></i></div>' +
                      '<div class="flex-1 bg-white p-2 rounded-lg text-sm">' + chat.ai_message + '</div>' +
                    '</div>'
                  : '') +
                '</div>' +
              '</div>'
            ).join('');
          } else {
            container.innerHTML = '<p class="text-gray-500">No chat history found</p>';
          }
        } catch (error) {
          console.error('Load chat history error:', error);
          document.getElementById('chatHistoryList').innerHTML = '<p class="text-red-500">Error loading chat history</p>';
        }
      };
      
      // Add document form handler
      document.getElementById('addDocumentForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('docTitle').value;
        const content = document.getElementById('docContent').value;
        const type = document.getElementById('docType').value;
        
        if (!title || !content) {
          alert('Please fill in all required fields');
          return;
        }
        
        try {
          const response = await fetch('/api/admin/chatbot/documents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              title: title,
              content: content,
              document_type: type
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Document added successfully!\\n' + data.chunks_created + ' text chunks created for AI search.');
            document.getElementById('addDocumentForm').reset();
            await loadChatbotDocuments();
          } else {
            alert('âŒ Failed to add document: ' + data.error);
          }
        } catch (error) {
          console.error('Add document error:', error);
          alert('âŒ Error adding document');
        }
      });
      
      document.getElementById('editDocumentForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const documentId = document.getElementById('editDocId').value;
        const title = document.getElementById('editDocTitle').value;
        const content = document.getElementById('editDocContent').value;
        const type = document.getElementById('editDocType').value;
        
        if (!title || !content) {
          alert('Please fill in all required fields');
          return;
        }
        
        try {
          const response = await fetch('/api/admin/chatbot/documents/' + documentId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              title: title,
              content: content,
              document_type: type
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Document updated successfully!\\n' + data.chunks_created + ' text chunks re-created for AI search.');
            closeEditDocumentModal();
            await loadChatbotDocuments();
          } else {
            alert('âŒ Failed to update document: ' + data.error);
          }
        } catch (error) {
          console.error('Update document error:', error);
          alert('âŒ Error updating document');
        }
      });
      
      window.editChatbotDocument = async function(documentId) {
        try {
          // Fetch document details
          const response = await fetch('/api/admin/chatbot/documents?property_id=1');
          const data = await response.json();
          
          const doc = data.documents.find(d => d.document_id === documentId);
          
          if (!doc) {
            alert('âŒ Document not found');
            return;
          }
          
          // Pre-fill form
          document.getElementById('editDocId').value = doc.document_id;
          document.getElementById('editDocTitle').value = doc.title;
          document.getElementById('editDocType').value = doc.document_type;
          document.getElementById('editDocContent').value = doc.content;
          
          // Show modal
          document.getElementById('editDocumentModal').classList.remove('hidden');
        } catch (error) {
          console.error('Edit document error:', error);
          alert('âŒ Error loading document for edit');
        }
      };
      
      window.closeEditDocumentModal = function() {
        document.getElementById('editDocumentModal').classList.add('hidden');
        document.getElementById('editDocumentForm').reset();
      };
      
      window.deleteChatbotDocument = async function(documentId) {
        if (!confirm('Are you sure you want to delete this document? This will also remove all its text chunks.')) {
          return;
        }
        
        try {
          const response = await fetch('/api/admin/chatbot/documents/' + documentId, {
            method: 'DELETE'
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Document deleted successfully!');
            await loadChatbotDocuments();
          } else {
            alert('âŒ Failed to delete document');
          }
        } catch (error) {
          console.error('Delete document error:', error);
          alert('âŒ Error deleting document');
        }
      };
      
      // ===== BEACH MANAGEMENT FUNCTIONS =====
      
      async function loadBeachSettings() {
        try {
          const response = await fetch('/api/admin/beach/settings/1');
          const data = await response.json();
          
          if (data.success && data.settings) {
            const s = data.settings;
            document.getElementById('beachBookingEnabled').checked = s.beach_booking_enabled === 1;
            document.getElementById('freeForGuests').checked = s.free_for_hotel_guests === 1;
            document.getElementById('openingTime').value = s.opening_time || '08:00';
            document.getElementById('closingTime').value = s.closing_time || '18:00';
            document.getElementById('advanceBookingDays').value = s.advance_booking_days || 7;
            document.getElementById('maxDurationHours').value = s.max_booking_duration_hours || 12;
            
            // Load card customization fields
            document.getElementById('cardTitle').value = s.card_title || 'Beach Booking';
            document.getElementById('cardSubtitle').value = s.card_subtitle || 'Reserve your perfect spot by the sea! Select from umbrellas, cabanas, and premium locations.';
            document.getElementById('feature1Text').value = s.feature1_text || 'Free for Hotel Guests';
            document.getElementById('feature2Text').value = s.feature2_text || 'Book Up to 7 Days Ahead';
            document.getElementById('feature3Text').value = s.feature3_text || 'QR Code Check-in';
            document.getElementById('umbrellasLabel').value = s.umbrellas_label || 'Umbrellas';
            document.getElementById('umbrellasDesc').value = s.umbrellas_desc || 'Classic Beach';
            document.getElementById('cabanasLabel').value = s.cabanas_label || 'Cabanas';
            document.getElementById('cabanasDesc').value = s.cabanas_desc || 'Private & Cozy';
            document.getElementById('loungersLabel').value = s.loungers_label || 'Loungers';
            document.getElementById('loungersDesc').value = s.loungers_desc || 'Relax in Style';
            document.getElementById('daybedsLabel').value = s.daybeds_label || 'Daybeds';
            document.getElementById('daybedsDesc').value = s.daybeds_desc || 'Ultimate Comfort';
            document.getElementById('buttonText').value = s.button_text || 'Book Your Spot Now';
            
            // Load color settings
            document.getElementById('bgColorFrom').value = s.bg_color_from || '#3b82f6';
            document.getElementById('bgColorFromText').value = s.bg_color_from || '#3b82f6';
            document.getElementById('bgColorTo').value = s.bg_color_to || '#06b6d4';
            document.getElementById('bgColorToText').value = s.bg_color_to || '#06b6d4';
            document.getElementById('textColor').value = s.text_color || '#ffffff';
            document.getElementById('textColorText').value = s.text_color || '#ffffff';
            document.getElementById('buttonColorFrom').value = s.button_color_from || '#ffffff';
            document.getElementById('buttonColorFromText').value = s.button_color_from || '#ffffff';
            document.getElementById('buttonColorTo').value = s.button_color_to || '#ffffff';
            document.getElementById('buttonColorToText').value = s.button_color_to || '#ffffff';
            document.getElementById('buttonTextColor').value = s.button_text_color || '#3b82f6';
            document.getElementById('buttonTextColorText').value = s.button_text_color || '#3b82f6';
            updateColorPreview();
            setupColorPickers();
            
            // Load important information
            const defaultInfo = 'Please arrive 10 minutes before your time slot\\nBring your QR code (printed or on phone)\\nBeach towels provided by hotel\\nLate arrivals may result in reduced time';
            document.getElementById('importantInformation').value = s.important_information || defaultInfo;
            
            // Load beach spots
            await loadBeachSpots();
            
            // Set today's date for bookings
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('beachBookingDate').value = today;
            await loadBeachBookings();
            
            // Load time slots
            loadTimeSlots(s.time_slots);
          }
        } catch (error) {
          console.error('Load beach settings error:', error);
        }
      }

      function loadTimeSlots(timeSlotsJson) {
        try {
          const timeSlots = timeSlotsJson ? JSON.parse(timeSlotsJson) : [
            {id: 'half_day_am', name: 'Morning', start: '08:00', end: '13:00'},
            {id: 'half_day_pm', name: 'Afternoon', start: '13:00', end: '18:00'},
            {id: 'full_day', name: 'Full Day', start: '08:00', end: '18:00'}
          ];
          
          window.beachTimeSlots = timeSlots;
          renderTimeSlots();
        } catch (error) {
          console.error('Load time slots error:', error);
          window.beachTimeSlots = [
            {id: 'half_day_am', name: 'Morning', start: '08:00', end: '13:00'},
            {id: 'half_day_pm', name: 'Afternoon', start: '13:00', end: '18:00'},
            {id: 'full_day', name: 'Full Day', start: '08:00', end: '18:00'}
          ];
          renderTimeSlots();
        }
      }

      function renderTimeSlots() {
        const container = document.getElementById('timeSlotsContainer');
        if (!container) return;
        
        const html = window.beachTimeSlots.map((slot, index) => 
          '<div class="bg-white p-4 rounded-lg border-2 border-green-200">' +
            '<div class="grid grid-cols-1 md:grid-cols-4 gap-3">' +
              '<div>' +
                '<label class="block text-sm font-medium mb-1">Slot Name</label>' +
                '<input type="text" value="' + slot.name + '" onchange="updateTimeSlot(' + index + ', &quot;name&quot;, this.value)" class="w-full px-3 py-2 border rounded-lg">' +
              '</div>' +
              '<div>' +
                '<label class="block text-sm font-medium mb-1">Start Time</label>' +
                '<input type="time" value="' + slot.start + '" onchange="updateTimeSlot(' + index + ', &quot;start&quot;, this.value)" class="w-full px-3 py-2 border rounded-lg">' +
              '</div>' +
              '<div>' +
                '<label class="block text-sm font-medium mb-1">End Time</label>' +
                '<input type="time" value="' + slot.end + '" onchange="updateTimeSlot(' + index + ', &quot;end&quot;, this.value)" class="w-full px-3 py-2 border rounded-lg">' +
              '</div>' +
              '<div class="flex items-end">' +
                '<button onclick="removeTimeSlot(' + index + ')" class="w-full px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">' +
                  '<i class="fas fa-trash mr-1"></i>Remove' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>'
        ).join('');
        
        container.innerHTML = html;
      }

      window.addTimeSlot = function() {
        const newId = 'slot_' + Date.now();
        window.beachTimeSlots.push({
          id: newId,
          name: 'New Slot',
          start: '09:00',
          end: '12:00'
        });
        renderTimeSlots();
      };

      window.updateTimeSlot = function(index, field, value) {
        if (window.beachTimeSlots[index]) {
          window.beachTimeSlots[index][field] = value;
        }
      };

      window.removeTimeSlot = function(index) {
        if (confirm('Remove this time slot?')) {
          window.beachTimeSlots.splice(index, 1);
          renderTimeSlots();
        }
      };

      window.saveTimeSlots = async function() {
        try {
          const response = await fetch('/api/admin/beach/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              time_slots: JSON.stringify(window.beachTimeSlots)
            })
          });
          
          const data = await response.json();
          if (data.success) {
            alert('âœ… Time slots saved successfully!');
          } else {
            alert('âŒ Failed to save time slots: ' + data.error);
          }
        } catch (error) {
          console.error('Save time slots error:', error);
          alert('âŒ Error saving time slots');
        }
      };

      window.saveBeachCardCustomization = async function() {
        try {
          // Get basic settings to preserve them
          const beachBookingEnabled = document.getElementById('beachBookingEnabled')?.checked ? 1 : 0;
          const freeForGuests = document.getElementById('freeForGuests')?.checked ? 1 : 0;
          const openingTime = document.getElementById('openingTime')?.value || '08:00';
          const closingTime = document.getElementById('closingTime')?.value || '18:00';
          const advanceBookingDays = parseInt(document.getElementById('advanceBookingDays')?.value || '7');
          const maxDurationHours = parseInt(document.getElementById('maxDurationHours')?.value || '12');
          
          const response = await fetch('/api/admin/beach/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              // Preserve basic settings
              beach_booking_enabled: beachBookingEnabled,
              free_for_hotel_guests: freeForGuests,
              opening_time: openingTime,
              closing_time: closingTime,
              advance_booking_days: advanceBookingDays,
              max_booking_duration_hours: maxDurationHours,
              // Card customization
              card_title: document.getElementById('cardTitle').value,
              card_subtitle: document.getElementById('cardSubtitle').value,
              feature1_text: document.getElementById('feature1Text').value,
              feature2_text: document.getElementById('feature2Text').value,
              feature3_text: document.getElementById('feature3Text').value,
              umbrellas_label: document.getElementById('umbrellasLabel').value,
              umbrellas_desc: document.getElementById('umbrellasDesc').value,
              cabanas_label: document.getElementById('cabanasLabel').value,
              cabanas_desc: document.getElementById('cabanasDesc').value,
              loungers_label: document.getElementById('loungersLabel').value,
              loungers_desc: document.getElementById('loungersDesc').value,
              daybeds_label: document.getElementById('daybedsLabel').value,
              daybeds_desc: document.getElementById('daybedsDesc').value,
              button_text: document.getElementById('buttonText').value,
              bg_color_from: document.getElementById('bgColorFrom').value,
              bg_color_to: document.getElementById('bgColorTo').value,
              text_color: document.getElementById('textColor').value,
              button_color_from: document.getElementById('buttonColorFrom').value,
              button_color_to: document.getElementById('buttonColorTo').value,
              button_text_color: document.getElementById('buttonTextColor').value
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Beach card customization saved successfully!');
          } else {
            alert('âŒ Failed to save customization: ' + data.error);
          }
        } catch (error) {
          console.error('Save beach card customization error:', error);
          alert('âŒ Error saving customization');
        }
      };
      
      window.saveImportantInformation = async function() {
        try {
          // Get basic settings to preserve them
          const beachBookingEnabled = document.getElementById('beachBookingEnabled')?.checked ? 1 : 0;
          const freeForGuests = document.getElementById('freeForGuests')?.checked ? 1 : 0;
          const openingTime = document.getElementById('openingTime')?.value || '08:00';
          const closingTime = document.getElementById('closingTime')?.value || '18:00';
          const advanceBookingDays = parseInt(document.getElementById('advanceBookingDays')?.value || '7');
          const maxDurationHours = parseInt(document.getElementById('maxDurationHours')?.value || '12');
          
          const response = await fetch('/api/admin/beach/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              // Preserve basic settings
              beach_booking_enabled: beachBookingEnabled,
              free_for_hotel_guests: freeForGuests,
              opening_time: openingTime,
              closing_time: closingTime,
              advance_booking_days: advanceBookingDays,
              max_booking_duration_hours: maxDurationHours,
              // Important Information
              important_information: document.getElementById('importantInformation').value
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Important information saved successfully!');
          } else {
            alert('âŒ Failed to save important information: ' + data.error);
          }
        } catch (error) {
          console.error('Save important information error:', error);
          alert('âŒ Error saving important information');
        }
      };
      
      window.saveBeachSettings = async function() {
        try {
          // Get current color values to preserve them
          const bgColorFrom = document.getElementById('bgColorFrom')?.value || '#3b82f6';
          const bgColorTo = document.getElementById('bgColorTo')?.value || '#06b6d4';
          const textColor = document.getElementById('textColor')?.value || '#1f2937';
          const buttonColorFrom = document.getElementById('buttonColorFrom')?.value || '#ffffff';
          const buttonColorTo = document.getElementById('buttonColorTo')?.value || '#ffffff';
          const buttonTextColor = document.getElementById('buttonTextColor')?.value || '#3b82f6';
          
          // Get current text values to preserve them
          const cardTitle = document.getElementById('cardTitle')?.value || 'Beach Booking';
          const cardSubtitle = document.getElementById('cardSubtitle')?.value || 'Reserve your perfect spot by the sea! Select from umbrellas, cabanas, and premium locations.';
          const feature1Text = document.getElementById('feature1Text')?.value || 'Free for Hotel Guests';
          const feature2Text = document.getElementById('feature2Text')?.value || 'Book Up to 7 Days Ahead';
          const feature3Text = document.getElementById('feature3Text')?.value || 'QR Code Check-in';
          const umbrellasLabel = document.getElementById('umbrellasLabel')?.value || 'Umbrellas';
          const umbrellasDesc = document.getElementById('umbrellasDesc')?.value || 'Classic Beach';
          const cabanasLabel = document.getElementById('cabanasLabel')?.value || 'Cabanas';
          const cabanasDesc = document.getElementById('cabanasDesc')?.value || 'Private & Cozy';
          const loungersLabel = document.getElementById('loungersLabel')?.value || 'Loungers';
          const loungersDesc = document.getElementById('loungersDesc')?.value || 'Relax in Style';
          const daybedsLabel = document.getElementById('daybedsLabel')?.value || 'Daybeds';
          const daybedsDesc = document.getElementById('daybedsDesc')?.value || 'Ultimate Comfort';
          const buttonText = document.getElementById('buttonText')?.value || 'Book Your Spot Now';
          
          const response = await fetch('/api/admin/beach/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              beach_booking_enabled: document.getElementById('beachBookingEnabled').checked ? 1 : 0,
              free_for_hotel_guests: document.getElementById('freeForGuests').checked ? 1 : 0,
              opening_time: document.getElementById('openingTime').value,
              closing_time: document.getElementById('closingTime').value,
              advance_booking_days: parseInt(document.getElementById('advanceBookingDays').value),
              max_booking_duration_hours: parseInt(document.getElementById('maxDurationHours').value),
              // Preserve colors
              bg_color_from: bgColorFrom,
              bg_color_to: bgColorTo,
              text_color: textColor,
              button_color_from: buttonColorFrom,
              button_color_to: buttonColorTo,
              button_text_color: buttonTextColor,
              // Preserve text customization
              card_title: cardTitle,
              card_subtitle: cardSubtitle,
              feature1_text: feature1Text,
              feature2_text: feature2Text,
              feature3_text: feature3Text,
              umbrellas_label: umbrellasLabel,
              umbrellas_desc: umbrellasDesc,
              cabanas_label: cabanasLabel,
              cabanas_desc: cabanasDesc,
              loungers_label: loungersLabel,
              loungers_desc: loungersDesc,
              daybeds_label: daybedsLabel,
              daybeds_desc: daybedsDesc,
              button_text: buttonText
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Beach settings saved successfully!');
          } else {
            alert('âŒ Failed to save settings: ' + data.error);
          }
        } catch (error) {
          console.error('Save beach settings error:', error);
          alert('âŒ Error saving settings');
        }
      };
      
      async function loadBeachSpots() {
        try {
          const response = await fetch('/api/admin/beach/spots/1');
          const data = await response.json();
          
          const container = document.getElementById('beachSpotsList');
          
          if (data.success && data.spots && data.spots.length > 0) {
            container.innerHTML = data.spots.map(spot => {
              return '<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">' +
                '<div class="flex items-center gap-3">' +
                  '<div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center">' +
                    '<i class="fas fa-umbrella-beach"></i>' +
                  '</div>' +
                  '<div>' +
                    '<div class="font-medium">' + spot.spot_number + '</div>' +
                    '<div class="text-sm text-gray-600">' + spot.spot_type + ' â€¢ Capacity: ' + spot.max_capacity + '</div>' +
                  '</div>' +
                '</div>' +
                '<div class="flex items-center gap-2">' +
                  '<span class="text-sm text-gray-600">' + spot.currency + ' ' + spot.price_full_day + '/day</span>' +
                  '<button onclick="editBeachSpot(' + spot.spot_id + ')" class="p-2 text-blue-600 hover:bg-blue-50 rounded">' +
                    '<i class="fas fa-edit"></i>' +
                  '</button>' +
                  '<button onclick="deleteBeachSpot(' + spot.spot_id + ')" class="p-2 text-red-600 hover:bg-red-50 rounded">' +
                    '<i class="fas fa-trash"></i>' +
                  '</button>' +
                '</div>' +
              '</div>';
            }).join('');
          } else {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">No beach spots created yet. Use the Beach Map Designer to add spots.</p>';
          }
        } catch (error) {
          console.error('Load beach spots error:', error);
        }
      }
      
      // Color picker sync
      function setupColorPickers() {
        const colorInputs = [
          { picker: 'bgColorFrom', text: 'bgColorFromText' },
          { picker: 'bgColorTo', text: 'bgColorToText' },
          { picker: 'textColor', text: 'textColorText' },
          { picker: 'buttonColorFrom', text: 'buttonColorFromText' },
          { picker: 'buttonColorTo', text: 'buttonColorToText' },
          { picker: 'buttonTextColor', text: 'buttonTextColorText' }
        ];
        
        colorInputs.forEach(({ picker, text }) => {
          const pickerEl = document.getElementById(picker);
          const textEl = document.getElementById(text);
          
          if (pickerEl && textEl) {
            pickerEl.addEventListener('input', (e) => {
              textEl.value = e.target.value;
              updateColorPreview();
            });
          }
        });
      }
      
      function updateColorPreview() {
        const bgFrom = document.getElementById('bgColorFrom').value;
        const bgTo = document.getElementById('bgColorTo').value;
        const textColor = document.getElementById('textColor').value;
        const btnFrom = document.getElementById('buttonColorFrom').value;
        const btnTo = document.getElementById('buttonColorTo').value;
        const btnText = document.getElementById('buttonTextColor').value;
        
        const preview = document.getElementById('colorPreview');
        const title = document.getElementById('previewTitle');
        const subtitle = document.getElementById('previewSubtitle');
        const button = document.getElementById('previewButton');
        
        if (preview) preview.style.background = 'linear-gradient(135deg, ' + bgFrom + ' 0%, ' + bgTo + ' 100%)';
        if (title) title.style.color = textColor;
        if (subtitle) subtitle.style.color = textColor;
        if (button) {
          button.style.background = 'linear-gradient(135deg, ' + btnFrom + ' 0%, ' + btnTo + ' 100%)';
          button.style.color = btnText;
        }
      }
      
      window.openBeachMapDesigner = function() {
        window.open('/admin/beach-map-designer', '_blank', 'width=1400,height=900');
      };
      
      window.openInteractiveMapBuilder = function() {
        const mapUrl = document.getElementById('hotelMapUrl').value;
        if (!mapUrl) {
          alert('âš ï¸ Please enter a hotel map image URL first');
          return;
        }
        // Open in new window with map URL pre-filled
        const builderWindow = window.open('/admin/interactive-map-builder', '_blank', 'width=1600,height=1000');
        if (builderWindow) {
          builderWindow.addEventListener('load', () => {
            builderWindow.document.getElementById('mapImageUrl').value = mapUrl;
            builderWindow.loadMapImage();
          });
        }
      };
      
      window.addQuickSpot = async function() {
        const spotNumber = prompt('Enter spot number (e.g., A1, B2):');
        if (!spotNumber) return;
        
        const spotType = prompt('Enter spot type (umbrella, cabana, lounger, daybed):', 'umbrella');
        if (!spotType) return;
        
        try {
          const response = await fetch('/api/admin/beach/spots', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              property_id: 1,
              zone_id: 1, // Default zone
              spot_number: spotNumber,
              spot_type: spotType,
              position_x: Math.floor(Math.random() * 800),
              position_y: Math.floor(Math.random() * 400),
              max_capacity: 2,
              price_full_day: 0
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Spot added! Use Beach Map Designer to position it correctly.');
            await loadBeachSpots();
          } else {
            alert('âŒ Failed to add spot');
          }
        } catch (error) {
          console.error('Add spot error:', error);
          alert('âŒ Error adding spot');
        }
      };
      
      window.deleteBeachSpot = async function(spotId) {
        if (!confirm('Delete this beach spot?')) return;
        
        try {
          const response = await fetch('/api/admin/beach/spots/' + spotId, {
            method: 'DELETE'
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Spot deleted!');
            await loadBeachSpots();
          } else {
            alert('âŒ Failed to delete spot');
          }
        } catch (error) {
          console.error('Delete spot error:', error);
          alert('âŒ Error deleting spot');
        }
      };
      
      window.loadBeachBookings = async function() {
        try {
          const date = document.getElementById('beachBookingDate').value;
          const response = await fetch('/api/admin/beach/bookings?property_id=1&date=' + date);
          const data = await response.json();
          
          const container = document.getElementById('beachBookingsList');
          
          if (data.success && data.bookings && data.bookings.length > 0) {
            container.innerHTML = data.bookings.map(booking => {
              return '<div class="border-l-4 ' + (booking.booking_status === 'confirmed' ? 'border-green-500' : 'border-gray-400') + ' bg-gray-50 p-4 rounded-lg">' +
                '<div class="flex items-center justify-between mb-2">' +
                  '<div class="flex items-center gap-2">' +
                    '<span class="font-bold text-blue-600">' + booking.spot_number + '</span>' +
                    '<span class="text-sm text-gray-600">' + booking.guest_name + '</span>' +
                    (booking.guest_room_number ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">Room ' + booking.guest_room_number + '</span>' : '') +
                  '</div>' +
                  '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">' + booking.slot_type + '</span>' +
                '</div>' +
                '<div class="text-sm text-gray-600">' +
                  '<i class="fas fa-users mr-1"></i>' + booking.num_guests + ' guests' +
                  '<i class="fas fa-clock ml-3 mr-1"></i>' + booking.start_time + ' - ' + booking.end_time +
                  (booking.special_requests ? '<div class="mt-1"><i class="fas fa-comment mr-1"></i>' + booking.special_requests + '</div>' : '') +
                '</div>' +
                '<div class="mt-2 flex gap-2">' +
                  '<button onclick="viewBookingQR(\\'' + booking.booking_reference + '\\')" class="text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">' +
                    '<i class="fas fa-qrcode mr-1"></i>QR Code' +
                  '</button>' +
                  '<button onclick="cancelBeachBooking(\\'' + booking.booking_reference + '\\')" class="text-xs px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">' +
                    '<i class="fas fa-times mr-1"></i>Cancel' +
                  '</button>' +
                '</div>' +
              '</div>';
            }).join('');
          } else {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">No bookings for this date</p>';
          }
        } catch (error) {
          console.error('Load beach bookings error:', error);
        }
      };
      
      window.viewBookingQR = function(bookingReference) {
        window.open('/api/beach/bookings/' + bookingReference + '/qr', '_blank');
      };
      
      window.cancelBeachBooking = async function(bookingReference) {
        if (!confirm('Cancel this booking?')) return;
        
        try {
          const response = await fetch('/api/beach/bookings/' + bookingReference + '/cancel', {
            method: 'POST'
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Booking cancelled!');
            await loadBeachBookings();
          } else {
            alert('âŒ Failed to cancel booking');
          }
        } catch (error) {
          console.error('Cancel booking error:', error);
          alert('âŒ Error cancelling booking');
        }
      };
      
      // ===== END BEACH MANAGEMENT FUNCTIONS =====
      
      async function renderSectionVisibility() {
        // Load custom sections
        let customSections = [];
        try {
          const response = await fetch('/api/admin/custom-sections?property_id=1');
          const data = await response.json();
          customSections = data.sections || [];
        } catch (error) {
          console.error('Failed to load custom sections for visibility:', error);
        }
        
        const defaultSections = [
          { key: 'restaurants', icon: 'ðŸ½ï¸', name: 'Restaurants' },
          { key: 'events', icon: 'ðŸŽ‰', name: 'Events' },
          { key: 'spa', icon: 'ðŸ’†', name: 'Spa' },
          { key: 'service', icon: 'ðŸ›Žï¸', name: 'Services' },
          { key: 'activities', icon: 'ðŸƒ', name: 'Activities' }
        ];
        
        const grid = document.getElementById('sectionVisibilityGrid');
        grid.innerHTML = '';
        
        // Render default sections
        defaultSections.forEach(section => {
          const label = document.createElement('label');
          label.className = 'flex items-center cursor-pointer p-3 bg-white rounded border hover:border-blue-400 transition';
          label.innerHTML = \`
            <input type="checkbox" id="show\${section.key.charAt(0).toUpperCase() + section.key.slice(1)}" 
                   class="mr-2 w-4 h-4" checked data-section-key="\${section.key}" />
            <span class="text-sm font-medium">\${section.icon} \${section.name}</span>
          \`;
          grid.appendChild(label);
        });
        
        // Render custom sections
        customSections.forEach(section => {
          const label = document.createElement('label');
          label.className = 'flex items-center cursor-pointer p-3 bg-white rounded border hover:border-blue-400 transition';
          const icon = section.icon_class ? \`<i class="\${section.icon_class} mr-1"></i>\` : 'âœ¨ ';
          label.innerHTML = \`
            <input type="checkbox" id="showCustom\${section.section_id}" 
                   class="mr-2 w-4 h-4" checked data-section-key="\${section.section_key}" 
                   data-custom="true" data-section-id="\${section.section_id}" />
            <span class="text-sm font-medium">\${icon}\${section.section_name_en}</span>
          \`;
          grid.appendChild(label);
        });
      }
      
      async function renderSectionOrder(order) {
        // Load custom sections first
        let customSections = [];
        try {
          const response = await fetch('/api/admin/custom-sections?property_id=1');
          const data = await response.json();
          customSections = data.sections || [];
        } catch (error) {
          console.error('Failed to load custom sections for ordering:', error);
        }
        
        const sectionNames = {
          'restaurants': 'ðŸ½ï¸ Restaurants',
          'events': 'ðŸŽ‰ Events',
          'spa': 'ðŸ’† Spa & Wellness',
          'service': 'ðŸ›Žï¸ Hotel Services',
          'activities': 'ðŸƒ Activities & Experiences',
          'beach-booking': 'ðŸ–ï¸ Beach Booking'
        };
        
        // Add custom sections to sectionNames
        customSections.forEach(cs => {
          sectionNames[cs.section_key] = cs.icon_class ? 
            '<i class="' + cs.icon_class + ' mr-1"></i>' + cs.section_name_en :
            'âœ¨ ' + cs.section_name_en;
        });
        
        // Add beach-booking if it's not in the order yet (for existing databases)
        if (!order.includes('beach-booking')) {
          order.push('beach-booking');
        }
        
        // Add any custom sections that aren't in the order yet
        customSections.forEach(cs => {
          if (!order.includes(cs.section_key)) {
            order.push(cs.section_key);
          }
        });
        
        const list = document.getElementById('sectionOrderList');
        list.innerHTML = '';
        
        order.forEach((section, index) => {
          const item = document.createElement('div');
          item.className = 'flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-300 cursor-move hover:border-purple-400 transition';
          item.draggable = true;
          item.dataset.section = section;
          
          const displayName = sectionNames[section] || 'â“ ' + section;
          item.innerHTML = '<i class="fas fa-grip-vertical text-gray-400"></i>' +
                          '<span class="flex-1 font-medium">' + (index + 1) + '. ' + displayName + '</span>' +
                          '<i class="fas fa-arrows-alt-v text-gray-400"></i>';
          
          // Drag events
          item.addEventListener('dragstart', handleDragStart);
          item.addEventListener('dragover', handleDragOver);
          item.addEventListener('drop', handleDrop);
          item.addEventListener('dragend', handleDragEnd);
          
          list.appendChild(item);
        });
      }
      
      let draggedElement = null;
      
      function handleDragStart(e) {
        draggedElement = this;
        this.style.opacity = '0.5';
      }
      
      function handleDragOver(e) {
        e.preventDefault();
        return false;
      }
      
      function handleDrop(e) {
        e.preventDefault();
        if (draggedElement !== this) {
          const allItems = Array.from(document.getElementById('sectionOrderList').children);
          const draggedIndex = allItems.indexOf(draggedElement);
          const targetIndex = allItems.indexOf(this);
          
          if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
          } else {
            this.parentNode.insertBefore(draggedElement, this);
          }
          
          updateSectionNumbers();
        }
        return false;
      }
      
      function handleDragEnd() {
        this.style.opacity = '1';
        draggedElement = null;
      }
      
      function updateSectionNumbers() {
        const items = document.getElementById('sectionOrderList').children;
        Array.from(items).forEach((item, index) => {
          const span = item.querySelector('span');
          const text = span.textContent;
          span.textContent = (index + 1) + text.substring(text.indexOf('.'));
        });
      }
      
      function getSectionOrder() {
        const items = document.getElementById('sectionOrderList').children;
        return Array.from(items).map(item => item.dataset.section);
      }
      
      function updateGradientPreview() {
        const primary = document.getElementById('primaryColorText').value || '#3B82F6';
        const secondary = document.getElementById('secondaryColorText').value || '#10B981';
        const preview = document.getElementById('primaryGradientPreview');
        preview.style.background = 'linear-gradient(135deg, ' + primary + ', ' + secondary + ')';
      }
      
      function copyHomepageUrl() {
        const input = document.getElementById('homepageUrl');
        input.select();
        document.execCommand('copy');
        alert('Homepage URL copied to clipboard!');
      }
      
      function previewDesign() {
        const homepageUrl = document.getElementById('visitHomepage').href;
        window.open(homepageUrl, '_blank');
      }
      
      // ========================================
      // NOTIFICATION SETTINGS FUNCTIONS
      // ========================================
      let persistentBeepInterval = null;
      let acknowledgedNotifications = new Set();
      
      async function loadNotificationSettings() {
        try {
          const response = await fetch('/api/admin/notification-settings/1');
          const settings = await response.json();
          
          // Sound settings
          document.getElementById('soundEnabled').checked = settings.sound_enabled;
          document.getElementById('beepFrequency').value = settings.beep_frequency || 800;
          document.getElementById('beepDuration').value = settings.beep_duration_ms || 500;
          document.getElementById('beepInterval').value = settings.beep_interval_ms || 3000;
          
          // Persistent beep settings
          document.getElementById('persistentBeep').checked = settings.persistent_beep;
          document.getElementById('persistentBookings').checked = settings.persistent_new_bookings;
          document.getElementById('persistentCallbacks').checked = settings.persistent_new_callbacks;
          document.getElementById('persistentFeedback').checked = settings.persistent_new_feedback;
          document.getElementById('persistentChat').checked = settings.persistent_new_chat;
          
          // Popup settings
          document.getElementById('showPopup').checked = settings.show_popup;
          document.getElementById('popupAutoClose').value = settings.popup_auto_close_seconds || 0;
          
          // Update global variables
          soundEnabled = settings.sound_enabled;
          refreshIntervalMs = settings.refresh_interval_ms || 300000;
          
          // Toggle visibility of options
          document.getElementById('soundOptions').style.display = settings.sound_enabled ? 'block' : 'none';
          document.getElementById('persistentOptions').style.display = settings.persistent_beep ? 'block' : 'none';
        } catch (error) {
          console.error('Load notification settings error:', error);
        }
      }
      
      function testNotificationSound() {
        const frequency = parseInt(document.getElementById('beepFrequency').value) || 800;
        const duration = parseInt(document.getElementById('beepDuration').value) || 500;
        
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = frequency;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + (duration / 1000));
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + (duration / 1000));
        } catch (error) {
          console.error('Sound test error:', error);
          alert('Could not play test sound. Please check your browser permissions.');
        }
      }
      
      function startPersistentBeep(notificationType) {
        // Check if persistent beeping is enabled for this type
        const persistentBeepEnabled = document.getElementById('persistentBeep')?.checked;
        if (!persistentBeepEnabled) return;
        
        const typeCheckboxId = 'persistent' + notificationType.charAt(0).toUpperCase() + notificationType.slice(1);
        const typeEnabled = document.getElementById(typeCheckboxId)?.checked;
        if (!typeEnabled) return;
        
        // Get beep settings
        const interval = parseInt(document.getElementById('beepInterval')?.value) || 3000;
        
        // Play initial beep
        playNotificationSound();
        
        // Start interval for persistent beeping
        if (persistentBeepInterval) {
          clearInterval(persistentBeepInterval);
        }
        
        persistentBeepInterval = setInterval(() => {
          playNotificationSound();
        }, interval);
      }
      
      function stopPersistentBeep() {
        if (persistentBeepInterval) {
          clearInterval(persistentBeepInterval);
          persistentBeepInterval = null;
        }
      }
      
      function acknowledgeNotification(notificationType) {
        acknowledgedNotifications.add(notificationType);
        stopPersistentBeep();
        
        // Hide notification popup if exists
        const popup = document.getElementById('notificationPopup');
        if (popup) {
          popup.remove();
        }
      }
      
      function showNotificationPopup(type, message, count) {
        const showPopup = document.getElementById('showPopup')?.checked;
        if (!showPopup) return;
        
        // Remove existing popup
        const existingPopup = document.getElementById('notificationPopup');
        if (existingPopup) {
          existingPopup.remove();
        }
        
        // Create popup
        const popup = document.createElement('div');
        popup.id = 'notificationPopup';
        popup.className = 'fixed top-20 right-4 bg-white border-l-4 border-blue-600 shadow-2xl rounded-lg p-4 max-w-sm z-50 animate-slide-in';
        popup.innerHTML = 
          '<div class="flex items-start gap-3">' +
            '<div class="flex-shrink-0">' +
              '<i class="fas fa-bell text-2xl text-blue-600"></i>' +
            '</div>' +
            '<div class="flex-1">' +
              '<h4 class="font-bold text-gray-900 mb-1">' + type + '</h4>' +
              '<p class="text-sm text-gray-600 mb-3">' + message + '</p>' +
              '<button onclick="acknowledgeNotification(\\'' + type.toLowerCase() + '\\')" ' +
                      'class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">' +
                '<i class="fas fa-check mr-2"></i>Acknowledge & Stop Beeping' +
              '</button>' +
            '</div>' +
            '<button onclick="acknowledgeNotification(\\'' + type.toLowerCase() + '\\')" ' +
                    'class="flex-shrink-0 text-gray-400 hover:text-gray-600">' +
              '<i class="fas fa-times"></i>' +
            '</button>' +
          '</div>';
        
        document.body.appendChild(popup);
        
        // Auto-close if configured
        const autoClose = parseInt(document.getElementById('popupAutoClose')?.value) || 0;
        if (autoClose > 0) {
          setTimeout(() => {
            popup.remove();
          }, autoClose * 1000);
        }
      }
      
      // Form submit handler for notification settings
      document.getElementById('notificationSettingsForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const settingsData = {
          sound_enabled: document.getElementById('soundEnabled').checked,
          persistent_beep: document.getElementById('persistentBeep').checked,
          beep_interval_ms: parseInt(document.getElementById('beepInterval').value),
          beep_frequency: parseInt(document.getElementById('beepFrequency').value),
          beep_duration_ms: parseInt(document.getElementById('beepDuration').value),
          persistent_new_bookings: document.getElementById('persistentBookings').checked,
          persistent_new_callbacks: document.getElementById('persistentCallbacks').checked,
          persistent_new_feedback: document.getElementById('persistentFeedback').checked,
          persistent_new_chat: document.getElementById('persistentChat').checked,
          show_popup: document.getElementById('showPopup').checked,
          popup_auto_close_seconds: parseInt(document.getElementById('popupAutoClose').value)
        };
        
        try {
          const response = await fetch('/api/admin/notification-settings/1', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settingsData)
          });
          
          const data = await response.json();
          if (data.success) {
            alert('âœ… Notification settings saved successfully!');
            loadNotificationSettings(); // Reload to apply
          } else {
            alert('âŒ Failed to save settings: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Save notification settings error:', error);
          alert('âŒ Error saving settings');
        }
      });
      
      // Toggle visibility of sound options
      document.getElementById('soundEnabled')?.addEventListener('change', function() {
        document.getElementById('soundOptions').style.display = this.checked ? 'block' : 'none';
      });
      
      // Toggle visibility of persistent options
      document.getElementById('persistentBeep')?.addEventListener('change', function() {
        document.getElementById('persistentOptions').style.display = this.checked ? 'block' : 'none';
      });
      
      document.getElementById('settingsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const layoutStyle = document.querySelector('input[name="layoutStyle"]:checked').value;
        const heroEffect = document.querySelector('input[name="heroImageEffect"]:checked').value;
        
        const settings = {
          property_id: 1,
          name: document.getElementById('hotelName').value,
          tagline: document.getElementById('hotelTagline').value,
          contact_email: document.getElementById('hotelEmail').value,
          contact_phone: document.getElementById('hotelPhone').value,
          address: document.getElementById('hotelAddress').value,
          section_restaurants_en: document.getElementById('sectionNameRestaurants').value || null,
          section_events_en: document.getElementById('sectionNameEvents').value || null,
          section_spa_en: document.getElementById('sectionNameSpa').value || null,
          section_service_en: document.getElementById('sectionNameService').value || null,
          section_activities_en: document.getElementById('sectionNameActivities').value || null,
          brand_logo_url: document.getElementById('brandLogoUrl').value,
          hero_image_url: document.getElementById('heroImageUrl').value,
          hero_image_effect: heroEffect,
          hero_overlay_opacity: parseInt(document.getElementById('heroOverlayOpacity').value),
          primary_color: document.getElementById('primaryColorText').value,
          secondary_color: document.getElementById('secondaryColorText').value,
          accent_color: document.getElementById('accentColorText').value,
          layout_style: layoutStyle,
          font_family: document.getElementById('fontFamily').value,
          button_style: document.getElementById('buttonStyle').value,
          card_style: document.getElementById('cardStyle').value,
          header_style: document.getElementById('headerStyle').value,
          use_gradient: document.getElementById('primaryGradient').checked ? 1 : 0,
          hotel_map_url: document.getElementById('hotelMapUrl').value,
          show_hotel_map: document.getElementById('showHotelMap').checked ? 1 : 0,
          show_restaurants: document.getElementById('showRestaurants').checked ? 1 : 0,
          show_events: document.getElementById('showEvents').checked ? 1 : 0,
          show_spa: document.getElementById('showSpa').checked ? 1 : 0,
          show_service: document.getElementById('showService').checked ? 1 : 0,
          show_activities: document.getElementById('showActivities').checked ? 1 : 0,
          homepage_section_order: JSON.stringify(getSectionOrder())
        };
        
        try {
          // Save main settings
          const response = await fetch('/api/admin/property-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
          });
          
          if (!response.ok) {
            alert('Failed to save settings');
            return;
          }
          
          // Save custom section visibility
          const customCheckboxes = document.querySelectorAll('#sectionVisibilityGrid input[data-custom="true"]');
          for (const checkbox of customCheckboxes) {
            const sectionId = checkbox.getAttribute('data-section-id');
            const isVisible = checkbox.checked ? 1 : 0;
            
            await fetch('/api/admin/custom-sections/' + sectionId, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                is_visible: isVisible
              })
            });
          }
          
          alert('Design settings saved successfully! Visit your homepage to see the changes.');
        } catch (error) {
          console.error('Save settings error:', error);
          alert('Failed to save settings');
        }
      });

      // Dark mode toggle
      function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.contains('dark');
        
        if (isDark) {
          html.classList.remove('dark');
          localStorage.setItem('adminDarkMode', 'false');
          document.getElementById('darkModeIcon').className = 'fas fa-moon';
          document.getElementById('darkModeText').textContent = 'Dark';
        } else {
          html.classList.add('dark');
          localStorage.setItem('adminDarkMode', 'true');
          document.getElementById('darkModeIcon').className = 'fas fa-sun';
          document.getElementById('darkModeText').textContent = 'Light';
        }
      }
      
      // Initialize dark mode from localStorage
      function initDarkMode() {
        const darkMode = localStorage.getItem('adminDarkMode');
        if (darkMode === 'true') {
          document.documentElement.classList.add('dark');
          document.getElementById('darkModeIcon').className = 'fas fa-sun';
          document.getElementById('darkModeText').textContent = 'Light';
        }
      }
      
      // Apply dark mode immediately
      initDarkMode();

      // Support Ticket Functions
      function openSupportModal() {
        document.getElementById('supportModal').classList.remove('hidden');
      }
      
      function closeSupportModal() {
        document.getElementById('supportModal').classList.add('hidden');
        document.getElementById('supportTicketForm').reset();
      }
      
      document.getElementById('supportTicketForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          const response = await fetch('/api/tickets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              subject: document.getElementById('ticketSubject').value,
              description: document.getElementById('ticketDescription').value,
              priority: document.getElementById('ticketPriority').value,
              category: document.getElementById('ticketCategory').value,
              created_by_type: 'hotel',
              created_by_id: user.property_id || 1,
              created_by_email: user.email || 'admin@hotel.com',
              created_by_name: user.name || 'Hotel Admin',
              property_id: user.property_id || 1
            })
          });
          
          const data = await response.json();
          if (data.success) {
            alert('Support ticket created! Ticket #: ' + data.ticket_number + '. Our team will respond soon.');
            closeSupportModal();
          } else {
            alert('Failed to create ticket: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Create ticket error:', error);
          alert('Failed to create support ticket');
        }
      });
      
      // Live Chat Functions
      let widgetChatRoomId = null;
      let widgetChatInterval = null;
      
      async function openLiveChat() {
        document.getElementById('chatWidget').classList.remove('hidden');
        
        // Get or create chat room with super admin
        try {
          const response = await fetch('/api/chat/rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              room_type: 'hotel_support',
              room_name: 'Hotel Support Chat',
              participant1_type: 'hotel',
              participant1_id: user.property_id || 1,
              participant1_name: user.name || 'Hotel Admin',
              property_id: user.property_id || 1
            })
          });
          
          const data = await response.json();
          if (data.success) {
            widgetChatRoomId = data.room_id;
            loadWidgetMessages();
            
            // Auto-refresh messages every 3 seconds
            if (widgetChatInterval) clearInterval(widgetChatInterval);
            widgetChatInterval = setInterval(loadWidgetMessages, 3000);
          }
        } catch (error) {
          console.error('Open chat error:', error);
        }
      }
      
      function closeLiveChat() {
        document.getElementById('chatWidget').classList.add('hidden');
        if (widgetChatInterval) clearInterval(widgetChatInterval);
      }
      
      async function loadWidgetMessages() {
        if (!widgetChatRoomId) return;
        
        try {
          const response = await fetch('/api/chat/rooms/' + widgetChatRoomId + '/messages?limit=50');
          const data = await response.json();
          const messages = data.messages || [];
          
          const html = messages.map(msg => {
            const isMe = msg.sender_type === 'hotel';
            return '<div class="flex ' + (isMe ? 'justify-end' : 'justify-start') + ' mb-3">' +
              '<div class="max-w-[80%] ' + (isMe ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800') + ' px-3 py-2 rounded-lg">' +
                '<div class="text-xs mb-1 ' + (isMe ? 'text-blue-200' : 'text-gray-500') + '">' +
                  msg.sender_name + ' Â· ' + new Date(msg.created_at).toLocaleTimeString() +
                '</div>' +
                '<div class="text-sm">' + msg.message + '</div>' +
              '</div>' +
            '</div>';
          }).join('');
          
          const container = document.getElementById('widgetChatMessages');
          container.innerHTML = html || '<div class="text-center text-gray-500 text-sm">No messages yet. Start the conversation!</div>';
          container.scrollTop = container.scrollHeight;
        } catch (error) {
          console.error('Load widget messages error:', error);
        }
      }
      
      async function sendWidgetMessage() {
        const input = document.getElementById('widgetChatInput');
        const message = input.value.trim();
        if (!message || !widgetChatRoomId) return;
        
        try {
          const response = await fetch('/api/chat/rooms/' + widgetChatRoomId + '/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message,
              sender_type: 'hotel',
              sender_id: user.property_id || 1,
              sender_name: user.name || 'Hotel Admin'
            })
          });
          
          if (response.ok) {
            input.value = '';
            loadWidgetMessages();
          }
        } catch (error) {
          console.error('Send message error:', error);
        }
      }
      
      // Allow Enter key to send messages
      document.getElementById('widgetChatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendWidgetMessage();
        }
      });

      // ============================================
      // SEASONAL EFFECTS FUNCTIONS
      // ============================================
      let seasonalSettings = {};
      
      async function loadSeasonalSettings() {
        try {
          const response = await fetch('/api/seasonal-settings/1');
          const data = await response.json();
          if (data.success) {
            seasonalSettings = data.settings;
            populateSeasonalForm(seasonalSettings);
          }
        } catch (error) {
          console.error('Load seasonal settings error:', error);
        }
      }
      
      function populateSeasonalForm(settings) {
        // Set theme
        document.querySelector('input[name="theme"][value="' + (settings.active_theme || 'none') + '"]').checked = true;
        updateThemeSelection();
        
        // Set effects
        document.getElementById('enableSnow').checked = settings.enable_snow === 1;
        document.getElementById('enableFireworks').checked = settings.enable_fireworks === 1;
        document.getElementById('enableConfetti').checked = settings.enable_confetti === 1;
        document.getElementById('enableLights').checked = settings.enable_lights === 1;
        
        // Set overlay
        document.getElementById('enableOverlay').checked = settings.enable_overlay === 1;
        if (settings.enable_overlay && settings.overlay_type) {
          document.querySelector('input[name="overlay"][value="' + settings.overlay_type + '"]').checked = true;
          document.getElementById('overlayOptions').classList.remove('hidden');
        }
        
        // Set message
        document.getElementById('customMessage').value = settings.custom_message || '';
        
        // Set active status
        document.getElementById('isActive').checked = settings.is_active === 1;
      }
      
      function updateThemeSelection() {
        document.querySelectorAll('.theme-card').forEach(card => {
          card.classList.remove('border-blue-500', 'bg-blue-50');
        });
        const selected = document.querySelector('input[name="theme"]:checked');
        if (selected) {
          selected.closest('.theme-option').querySelector('.theme-card').classList.add('border-blue-500', 'bg-blue-50');
        }
      }
      
      // Theme selection handler
      document.querySelectorAll('input[name="theme"]').forEach(radio => {
        radio.addEventListener('change', updateThemeSelection);
      });
      
      // Overlay toggle handler
      document.getElementById('enableOverlay').addEventListener('change', (e) => {
        if (e.target.checked) {
          document.getElementById('overlayOptions').classList.remove('hidden');
        } else {
          document.getElementById('overlayOptions').classList.add('hidden');
        }
      });
      
      // Overlay selection handler
      document.querySelectorAll('.overlay-choice').forEach(choice => {
        choice.addEventListener('click', () => {
          document.querySelectorAll('.overlay-choice div').forEach(div => {
            div.classList.remove('border-blue-500', 'bg-blue-50');
          });
          choice.querySelector('div').classList.add('border-blue-500', 'bg-blue-50');
        });
      });
      
      function applyPreset(preset) {
        // Reset all
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        if (preset === 'none') {
          document.querySelector('input[name="theme"][value="none"]').checked = true;
          document.getElementById('customMessage').value = '';
        } else if (preset === 'christmas') {
          document.querySelector('input[name="theme"][value="christmas"]').checked = true;
          document.getElementById('enableSnow').checked = true;
          document.getElementById('enableLights').checked = true;
          document.getElementById('enableOverlay').checked = true;
          document.getElementById('overlayOptions').classList.remove('hidden');
          document.querySelector('input[name="overlay"][value="santa_hat"]').checked = true;
          document.getElementById('customMessage').value = 'Merry Christmas! ðŸŽ„âœ¨';
          document.getElementById('isActive').checked = true;
        } else if (preset === 'newyear') {
          document.querySelector('input[name="theme"][value="newyear"]').checked = true;
          document.getElementById('enableFireworks').checked = true;
          document.getElementById('enableConfetti').checked = true;
          document.getElementById('enableOverlay').checked = true;
          document.getElementById('overlayOptions').classList.remove('hidden');
          document.querySelector('input[name="overlay"][value="party_hat"]').checked = true;
          document.getElementById('customMessage').value = 'Happy New Year! ðŸŽ†ðŸ¥³';
          document.getElementById('isActive').checked = true;
        } else if (preset === 'ramadan') {
          document.querySelector('input[name="theme"][value="ramadan"]').checked = true;
          document.getElementById('enableLights').checked = true;
          document.getElementById('customMessage').value = 'Ramadan Kareem! ðŸŒ™â­';
          document.getElementById('isActive').checked = true;
        } else if (preset === 'eid') {
          document.querySelector('input[name="theme"][value="eid"]').checked = true;
          document.getElementById('enableConfetti').checked = true;
          document.getElementById('enableLights').checked = true;
          document.getElementById('customMessage').value = 'Eid Mubarak! â­ðŸŒ™';
          document.getElementById('isActive').checked = true;
        }
        
        updateThemeSelection();
      }
      
      function previewSeasonalEffects() {
        const theme = document.querySelector('input[name="theme"]:checked').value;
        const message = document.getElementById('customMessage').value;
        
        // Open hotel page in new tab with preview parameter
        const previewUrl = '/hotel/paradise-resort?preview=seasonal&theme=' + theme + '&message=' + encodeURIComponent(message);
        window.open(previewUrl, '_blank');
      }
      
      document.getElementById('seasonalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const overlayEnabled = document.getElementById('enableOverlay').checked;
        const overlayType = overlayEnabled ? document.querySelector('input[name="overlay"]:checked')?.value : null;
        
        const data = {
          active_theme: document.querySelector('input[name="theme"]:checked').value,
          is_active: document.getElementById('isActive').checked,
          enable_snow: document.getElementById('enableSnow').checked,
          enable_fireworks: document.getElementById('enableFireworks').checked,
          enable_confetti: document.getElementById('enableConfetti').checked,
          enable_lights: document.getElementById('enableLights').checked,
          enable_overlay: overlayEnabled,
          overlay_type: overlayType,
          custom_message: document.getElementById('customMessage').value
        };
        
        try {
          const response = await fetch('/api/admin/seasonal-settings/1', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          if (result.success) {
            alert('âœ¨ Seasonal settings saved! Visit your hotel page to see the effects.');
            loadSeasonalSettings();
          } else {
            alert('Failed to save settings: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Save seasonal settings error:', error);
          alert('Failed to save seasonal settings');
        }
      });
      
      // Load seasonal settings when settings tab is opened
      document.querySelectorAll('[data-tab]').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.dataset.tab === 'settings') {
            loadSeasonalSettings();
          }
          if (btn.dataset.tab === 'beach') {
            // Setup color pickers when beach tab is clicked
            setTimeout(() => {
              setupColorPickers();
              updateColorPreview();
            }, 100);
          }
        });
      });

      function logout() {
        localStorage.removeItem('admin_user');
        localStorage.removeItem('admin_token');
        window.location.href = '/admin/login';
      }

      // AI Proofreading function
      async function proofreadText(textareaId, userType) {
        const textarea = document.getElementById(textareaId);
        const text = textarea.value.trim();
        
        if (!text) {
          alert('Please enter some text first!');
          return;
        }
        
        if (text.length > 5000) {
          alert('Text is too long! Maximum 5000 characters allowed.');
          return;
        }
        
        // Get user ID
        const userId = userType === 'vendor' ? 
          localStorage.getItem('vendor_id') : 
          localStorage.getItem('property_id');
        
        if (!userId) {
          alert('User session not found. Please log in again.');
          return;
        }
        
        // Show loading state
        const originalText = textarea.value;
        textarea.value = 'âœ¨ AI is proofreading your text...';
        textarea.disabled = true;
        
        try {
          const response = await fetch('/api/ai/proofread', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: originalText,
              user_id: userId,
              user_type: userType
            })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            // Show success
            textarea.value = data.proofread_text;
            textarea.disabled = false;
            
            // Show usage stats
            const usageMsg = \`âœ… Proofreading complete!\\n\\nðŸ“Š Your usage: \${data.usage.used}/\${data.usage.limit} today\\n(\${data.usage.remaining} remaining)\\nâš¡ Processed in \${data.processing_time_ms}ms\`;
            
            if (data.model_used === 'fallback') {
              alert(usageMsg + '\\n\\nâš ï¸ Note: AI service is currently unavailable. Basic formatting applied.');
            } else {
              alert(usageMsg);
            }
          } else {
            // Handle errors
            textarea.value = originalText;
            textarea.disabled = false;
            
            if (response.status === 429) {
              if (data.wait_seconds) {
                alert(\`â³ \${data.message}\\n\\nPlease wait \${data.wait_seconds} seconds before trying again.\`);
              } else {
                alert(\`ðŸš« \${data.message}\\n\\nYou've used \${data.used}/\${data.limit} requests today.\`);
              }
            } else {
              alert('âŒ Error: ' + (data.error || 'Failed to proofread text'));
            }
          }
        } catch (error) {
          textarea.value = originalText;
          textarea.disabled = false;
          alert('âŒ Network error. Please check your connection and try again.');
          console.error('Proofread error:', error);
        }
      }

      loadRooms();

      // ========== FEEDBACK MANAGEMENT FUNCTIONS ==========
      
      let currentFormId = null;
      let formQuestions = [];
      let currentQuestionIndex = 0;

      // Load feedback stats and forms
      async function loadFeedbackTab() {
        try {
          // Load analytics
          const analyticsRes = await fetch('/api/admin/feedback/analytics/' + propertyId);
          const analyticsData = await analyticsRes.json();
          
          if (analyticsData.success) {
            document.getElementById('totalResponses').textContent = analyticsData.stats.total_submissions || 0;
            document.getElementById('positiveCount').textContent = analyticsData.stats.positive_count || 0;
            document.getElementById('urgentCount').textContent = analyticsData.stats.urgent_count || 0;
            document.getElementById('avgSentiment').textContent = (analyticsData.stats.avg_sentiment || 0).toFixed(1);
            
            // Show urgent alerts if any
            if (analyticsData.insights && analyticsData.insights.length > 0) {
              const urgentSection = document.getElementById('urgentAlertsSection');
              const alertsList = document.getElementById('urgentAlertsList');
              urgentSection.style.display = 'block';
              
              alertsList.innerHTML = analyticsData.insights.map(insight => \`
                <div class="bg-white p-4 rounded-lg border-l-4 border-red-500 shadow">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <h4 class="font-bold text-red-900">\${insight.title}</h4>
                      <p class="text-gray-700 mt-1">\${insight.description}</p>
                      <p class="text-sm text-gray-600 mt-2"><strong>Suggested Action:</strong> \${insight.action_suggested}</p>
                      <span class="inline-block mt-2 px-3 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full">
                        \${insight.priority.toUpperCase()}
                      </span>
                    </div>
                    <button onclick="resolveInsight(\${insight.insight_id})" class="ml-4 px-4 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                      <i class="fas fa-check mr-1"></i>Resolve
                    </button>
                  </div>
                </div>
              \`).join('');
            }
            
            // Show recent submissions
            if (analyticsData.recent_submissions && analyticsData.recent_submissions.length > 0) {
              const recentList = document.getElementById('recentSubmissions');
              recentList.innerHTML = analyticsData.recent_submissions.map(sub => \`
                <div class="bg-gray-50 p-4 rounded-lg border hover:shadow-md transition-all cursor-pointer" onclick="viewSubmission(\${sub.submission_id})">
                  <div class="flex justify-between items-start">
                    <div>
                      <h4 class="font-semibold">\${sub.form_name}</h4>
                      <p class="text-sm text-gray-600 mt-1">
                        \${sub.guest_name || 'Anonymous'} \${sub.room_number ? 'â€¢ Room ' + sub.room_number : ''}
                      </p>
                      <span class="inline-block mt-2 px-3 py-1 text-xs font-semibold rounded-full \${
                        sub.sentiment_label === 'positive' ? 'bg-green-100 text-green-800' :
                        sub.sentiment_label === 'negative' ? 'bg-red-100 text-red-800' :
                        sub.sentiment_label === 'urgent' ? 'bg-red-200 text-red-900' :
                        'bg-gray-100 text-gray-800'
                      }">
                        \${sub.sentiment_label.toUpperCase()}
                      </span>
                    </div>
                    <span class="text-sm text-gray-500">\${new Date(sub.submitted_at).toLocaleDateString()}</span>
                  </div>
                </div>
              \`).join('');
            }
          }
          
          // Load forms
          const formsRes = await fetch('/api/admin/feedback/forms/' + propertyId);
          const formsData = await formsRes.json();
          
          if (formsData.success && formsData.forms.length > 0) {
            const formsList = document.getElementById('formsList');
            formsList.innerHTML = formsData.forms.map(form => \`
              <div class="bg-white p-4 rounded-lg border hover:shadow-md transition-all">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <div class="flex items-center gap-3">
                      <h4 class="font-bold text-lg">\${form.form_name}</h4>
                      <span class="px-3 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded-full">
                        \${form.form_type.toUpperCase()}
                      </span>
                      \${form.is_active ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">ACTIVE</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded">INACTIVE</span>'}
                    </div>
                    <p class="text-gray-600 text-sm mt-1">\${form.form_description || 'No description'}</p>
                    <div class="flex gap-4 mt-3 text-sm text-gray-600">
                      <span><i class="fas fa-inbox mr-1"></i>\${form.total_submissions || 0} responses</span>
                      <span><i class="fas fa-exclamation-triangle mr-1 text-red-600"></i>\${form.urgent_count || 0} urgent</span>
                      <span><i class="fas fa-smile mr-1 text-green-600"></i>Sentiment: \${(form.avg_sentiment || 0).toFixed(1)}</span>
                    </div>
                    <div class="mt-3 flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                      <input 
                        type="radio" 
                        name="homepageForm" 
                        id="homepage_\${form.form_id}" 
                        value="\${form.form_id}"
                        \${form.show_on_homepage === 1 ? 'checked' : ''}
                        onchange="setHomepageForm(\${form.form_id})"
                        class="w-4 h-4 text-black border-gray-300 focus:ring-black"
                      />
                      <label for="homepage_\${form.form_id}" class="font-medium text-sm cursor-pointer">
                        <i class="fas fa-home mr-1 text-gray-600"></i>
                        Show on Homepage
                        \${form.show_on_homepage === 1 ? '<span class="ml-2 px-2 py-1 bg-black text-white text-xs rounded">ACTIVE</span>' : ''}
                      </label>
                    </div>
                  </div>
                  <div class="flex flex-col gap-2">
                    <button onclick="generateQR(\${form.form_id}, '\${form.form_name}')" class="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 whitespace-nowrap">
                      <i class="fas fa-qrcode mr-1"></i>QR Code
                    </button>
                    <button onclick="viewFormSubmissions(\${form.form_id}, '\${form.form_name.replace(/'/g, "\\\\'")}')" class="px-4 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 whitespace-nowrap">
                      <i class="fas fa-eye mr-1"></i>View Responses
                    </button>
                    <button onclick="copyFormLink(\${form.form_id})" class="px-4 py-2 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 whitespace-nowrap">
                      <i class="fas fa-link mr-1"></i>Copy Link
                    </button>
                    <button onclick="editForm(\${form.form_id})" class="px-4 py-2 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 whitespace-nowrap">
                      <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button onclick="deleteForm(\${form.form_id}, '\${form.form_name.replace(/'/g, "\\\\'")}')" class="px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700 whitespace-nowrap">
                      <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                  </div>
                </div>
              </div>
            \`).join('');
          }
        } catch (error) {
          console.error('Load feedback error:', error);
          alert('Failed to load feedback data');
        }
        
        // Load AI Chat Feedback
        await loadChatFeedback();
      }
      
      // Load AI-detected chat feedback
      let allChatFeedback = [];
      async function loadChatFeedback() {
        try {
          const response = await fetch('/api/admin/feedback/chat/' + propertyId);
          const data = await response.json();
          
          if (data.success) {
            allChatFeedback = data.chat_feedback || [];
            
            // Update counts
            document.getElementById('chatFeedbackCount').textContent = allChatFeedback.length + ' detected';
            const urgentCount = allChatFeedback.filter(f => f.is_urgent === 1).length;
            document.getElementById('chatFeedbackUrgent').textContent = urgentCount + ' urgent';
            
            // Display all feedback
            displayChatFeedback(allChatFeedback);
          }
        } catch (error) {
          console.error('Load chat feedback error:', error);
        }
      }
      
      function displayChatFeedback(feedbackList) {
        const container = document.getElementById('chatFeedbackList');
        
        if (!feedbackList || feedbackList.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-robot text-4xl mb-2"></i><p>No chat feedback detected yet</p></div>';
          return;
        }
        
        container.innerHTML = feedbackList.map(feedback => \`
          <div class="bg-gray-50 border-l-4 \${feedback.is_urgent ? 'border-red-500' : 'border-purple-500'} p-4 rounded-lg hover:shadow-md transition">
            <div class="flex justify-between items-start mb-2">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="px-2 py-1 bg-\${getCategoryColor(feedback.complaint_category)}-100 text-\${getCategoryColor(feedback.complaint_category)}-800 text-xs font-semibold rounded uppercase">
                    \${feedback.complaint_category}
                  </span>
                  \${feedback.is_urgent ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded">URGENT</span>' : ''}
                  \${feedback.sentiment_label === 'complaint' ? '<span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs font-semibold rounded">COMPLAINT</span>' : ''}
                  \${feedback.is_resolved ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">RESOLVED</span>' : ''}
                </div>
                <p class="font-semibold text-sm text-gray-700 mb-1">\${feedback.complaint_summary}</p>
                <div class="text-sm text-gray-600 mb-2">
                  <strong>Guest:</strong> "\${feedback.guest_message.substring(0, 150)}\${feedback.guest_message.length > 150 ? '...' : ''}"
                </div>
                <div class="text-xs text-gray-500 flex gap-3">
                  \${feedback.guest_name ? '<span><i class="fas fa-user mr-1"></i>' + feedback.guest_name + '</span>' : ''}
                  \${feedback.room_number ? '<span><i class="fas fa-door-open mr-1"></i>Room ' + feedback.room_number + '</span>' : ''}
                  <span><i class="fas fa-clock mr-1"></i>\${new Date(feedback.detected_at).toLocaleString()}</span>
                </div>
              </div>
              <div class="flex flex-col gap-2 ml-4">
                \${!feedback.is_resolved ? 
                  '<button onclick="resolveChatFeedback(' + feedback.feedback_id + ')" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 whitespace-nowrap"><i class="fas fa-check mr-1"></i>Resolve</button>' :
                  '<button disabled class="px-3 py-1 bg-gray-300 text-gray-600 text-xs rounded cursor-not-allowed whitespace-nowrap"><i class="fas fa-check mr-1"></i>Resolved</button>'
                }
                <button onclick="viewFullChatFeedback(\${feedback.feedback_id})" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 whitespace-nowrap">
                  <i class="fas fa-eye mr-1"></i>View
                </button>
              </div>
            </div>
          </div>
        \`).join('');
      }
      
      function getCategoryColor(category) {
        const colors = {
          'room': 'blue',
          'food': 'orange',
          'staff': 'purple',
          'cleanliness': 'green',
          'service': 'indigo',
          'amenities': 'cyan',
          'other': 'gray'
        };
        return colors[category] || 'gray';
      }
      
      window.filterChatFeedback = function(filter) {
        // Update active button
        document.querySelectorAll('.chat-filter-btn').forEach(btn => {
          btn.classList.remove('chat-filter-active');
          btn.classList.remove('bg-purple-600', 'text-white');
        });
        event.target.classList.add('chat-filter-active');
        event.target.classList.add('bg-purple-600', 'text-white');
        
        // Filter feedback
        let filtered = allChatFeedback;
        if (filter === 'urgent') {
          filtered = allChatFeedback.filter(f => f.is_urgent === 1);
        } else if (filter !== 'all') {
          filtered = allChatFeedback.filter(f => f.complaint_category === filter);
        }
        
        displayChatFeedback(filtered);
      }
      
      window.resolveChatFeedback = async function(feedbackId) {
        const notes = prompt('Add resolution notes (optional):');
        
        try {
          const response = await fetch('/api/admin/feedback/chat/' + feedbackId + '/resolve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ admin_notes: notes || '' })
          });
          
          const data = await response.json();
          if (data.success) {
            alert('âœ… Chat feedback marked as resolved');
            loadChatFeedback(); // Reload
          }
        } catch (error) {
          console.error('Resolve error:', error);
          alert('Failed to resolve feedback');
        }
      }
      
      window.viewFullChatFeedback = function(feedbackId) {
        const feedback = allChatFeedback.find(f => f.feedback_id === feedbackId);
        if (!feedback) return;
        
        alert(\`ðŸ¤– AI Chat Feedback Details

Category: \${feedback.complaint_category.toUpperCase()}
Sentiment: \${feedback.sentiment_label} (Score: \${feedback.sentiment_score})

Guest Message:
"\${feedback.guest_message}"

Bot Response:
"\${feedback.bot_response}"

\${feedback.guest_name ? 'Guest Name: ' + feedback.guest_name : ''}
\${feedback.room_number ? 'Room: ' + feedback.room_number : ''}

Detected: \${new Date(feedback.detected_at).toLocaleString()}
\${feedback.is_resolved ? 'Status: RESOLVED' : 'Status: PENDING'}
\${feedback.admin_notes ? 'Notes: ' + feedback.admin_notes : ''}\`);
      }

      // Create new form
      function createNewForm() {
        currentFormId = null;
        formQuestions = [];
        document.getElementById('formName').value = '';
        document.getElementById('formDescription').value = '';
        document.getElementById('formType').value = 'feedback';
        document.getElementById('thankYouMessage').value = 'Thank you for your feedback!';
        document.getElementById('requireRoomNumber').checked = false;
        document.getElementById('requireGuestName').checked = false;
        document.getElementById('requireEmail').checked = false;
        document.getElementById('requirePhone').checked = false;
        document.getElementById('questionsList').innerHTML = '<div class="text-center text-gray-500 py-4 border-2 border-dashed border-gray-300 rounded-lg"><i class="fas fa-question-circle text-3xl mb-2"></i><p>No questions yet. Click "Add Question" to start!</p></div>';
        document.getElementById('formBuilderModal').classList.remove('hidden');
      }

      function closeFormBuilder() {
        document.getElementById('formBuilderModal').classList.add('hidden');
        editingFormId = null;
        formQuestions = [];
        
        // Reset form
        document.getElementById('formName').value = '';
        document.getElementById('formDescription').value = '';
        document.getElementById('formType').value = 'feedback';
        document.getElementById('requireRoomNumber').checked = false;
        document.getElementById('requireGuestName').checked = false;
        document.getElementById('requireEmail').checked = false;
        document.getElementById('requirePhone').checked = false;
        document.getElementById('thankYouMessage').value = '';
        document.getElementById('isActiveToggle').checked = true;
        document.getElementById('showOnHomepage').checked = false;
        
        // Reset modal title
        document.querySelector('#formBuilderModal .text-2xl').innerHTML = '<i class="fas fa-edit mr-2"></i>Form Builder';
      }

      // Add question
      function addQuestion() {
        document.getElementById('questionTypeModal').classList.remove('hidden');
      }

      function closeQuestionTypeModal() {
        document.getElementById('questionTypeModal').classList.add('hidden');
      }

      let currentQuestionType = null;
      let questionOptions = [];

      function selectQuestionType(type) {
        closeQuestionTypeModal();
        currentQuestionType = type;
        questionOptions = [];
        
        // Show question creation modal
        const modal = document.getElementById('questionCreationModal');
        const typeIcon = document.getElementById('questionTypeIcon');
        const typeLabel = document.getElementById('questionTypeLabel');
        const optionsSection = document.getElementById('optionsSection');
        const questionTextInput = document.getElementById('questionTextInput');
        
        // Reset form
        questionTextInput.value = '';
        document.getElementById('questionRequiredToggle').checked = true;
        
        // Configure modal based on type
        const typeConfig = {
          'text': { icon: 'fa-font', label: 'Short Text' },
          'textarea': { icon: 'fa-align-left', label: 'Long Text' },
          'rating': { icon: 'fa-star', label: 'Rating (1-5 stars)' },
          'scale': { icon: 'fa-sliders-h', label: 'Scale (1-10)' },
          'multiple_choice': { icon: 'fa-list-ul', label: 'Multiple Choice' },
          'yes_no': { icon: 'fa-check-circle', label: 'Yes/No' },
          'nps': { icon: 'fa-chart-line', label: 'NPS (0-10)' }
        };
        
        const config = typeConfig[type];
        typeIcon.className = \`fas \${config.icon} text-2xl text-purple-600\`;
        typeLabel.textContent = config.label;
        
        // Show options section for multiple choice
        if (type === 'multiple_choice') {
          optionsSection.classList.remove('hidden');
          renderOptionsList();
        } else {
          optionsSection.classList.add('hidden');
        }
        
        modal.classList.remove('hidden');
        
        // Setup preview listener
        questionTextInput.addEventListener('input', updateQuestionPreview);
        updateQuestionPreview();
      }

      function updateQuestionPreview() {
        const questionText = document.getElementById('questionTextInput').value;
        const preview = document.getElementById('questionPreview');
        const isRequired = document.getElementById('questionRequiredToggle').checked;
        
        if (!questionText.trim()) {
          preview.innerHTML = '<p class="text-gray-500 italic">Enter a question above to see preview...</p>';
          return;
        }
        
        let previewHTML = \`
          <p class="font-semibold text-gray-900 mb-3">
            \${questionText}
            \${isRequired ? '<span class="text-red-500 ml-1">*</span>' : ''}
          </p>
        \`;
        
        // Add preview input based on type
        switch(currentQuestionType) {
          case 'text':
            previewHTML += '<input type="text" class="w-full px-4 py-2 border rounded-lg" placeholder="Guest will type here..." disabled>';
            break;
          case 'textarea':
            previewHTML += '<textarea class="w-full px-4 py-2 border rounded-lg" rows="4" placeholder="Guest will type here..." disabled></textarea>';
            break;
          case 'rating':
            previewHTML += '<div class="flex gap-2">' + 
              Array(5).fill(0).map(() => '<i class="fas fa-star text-2xl text-gray-300"></i>').join('') + 
              '</div>';
            break;
          case 'scale':
            previewHTML += '<input type="range" min="1" max="10" class="w-full" disabled>';
            break;
          case 'multiple_choice':
            if (questionOptions.length > 0) {
              previewHTML += '<div class="space-y-2">' +
                questionOptions.map(opt => \`
                  <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="radio" name="preview" class="w-4 h-4" disabled>
                    <span>\${opt}</span>
                  </label>
                \`).join('') +
                '</div>';
            } else {
              previewHTML += '<p class="text-gray-500 italic">Add options below...</p>';
            }
            break;
          case 'yes_no':
            previewHTML += \`
              <div class="flex gap-3">
                <button class="flex-1 px-6 py-3 border-2 border-green-500 text-green-700 rounded-lg hover:bg-green-50 font-semibold">
                  <i class="fas fa-check mr-2"></i>Yes
                </button>
                <button class="flex-1 px-6 py-3 border-2 border-red-500 text-red-700 rounded-lg hover:bg-red-50 font-semibold">
                  <i class="fas fa-times mr-2"></i>No
                </button>
              </div>
            \`;
            break;
          case 'nps':
            previewHTML += '<div class="flex gap-1">' +
              Array(11).fill(0).map((_, i) => \`
                <button class="flex-1 px-3 py-2 border rounded hover:bg-purple-100 text-sm font-semibold">\${i}</button>
              \`).join('') +
              '</div><div class="flex justify-between text-xs text-gray-600 mt-1"><span>Not likely</span><span>Very likely</span></div>';
            break;
        }
        
        preview.innerHTML = previewHTML;
      }

      function renderOptionsList() {
        const container = document.getElementById('optionsList');
        if (questionOptions.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-sm italic py-2">No options yet. Click "Add Option" below.</p>';
          return;
        }
        
        container.innerHTML = questionOptions.map((opt, idx) => \`
          <div class="flex items-center gap-2">
            <span class="w-8 h-8 bg-purple-100 text-purple-700 rounded-full flex items-center justify-center font-bold text-sm">\${idx + 1}</span>
            <input type="text" value="\${opt}" 
                   onchange="updateOption(\${idx}, this.value)" 
                   class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                   placeholder="Option \${idx + 1}">
            <button onclick="removeOption(\${idx})" class="w-10 h-10 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        \`).join('');
      }

      function addOption() {
        questionOptions.push('Option ' + (questionOptions.length + 1));
        renderOptionsList();
        updateQuestionPreview();
      }

      function updateOption(idx, value) {
        questionOptions[idx] = value;
        updateQuestionPreview();
      }

      function removeOption(idx) {
        questionOptions.splice(idx, 1);
        renderOptionsList();
        updateQuestionPreview();
      }

      function closeQuestionCreationModal() {
        document.getElementById('questionCreationModal').classList.add('hidden');
        currentQuestionType = null;
        questionOptions = [];
      }

      function saveQuestion() {
        const questionText = document.getElementById('questionTextInput').value.trim();
        const isRequired = document.getElementById('questionRequiredToggle').checked;
        
        if (!questionText) {
          alert('Please enter a question text');
          return;
        }
        
        if (currentQuestionType === 'multiple_choice' && questionOptions.length === 0) {
          alert('Please add at least one option for multiple choice questions');
          return;
        }
        
        const question = {
          question_text: questionText,
          question_type: currentQuestionType,
          is_required: isRequired,
          options: currentQuestionType === 'multiple_choice' ? questionOptions : null,
          display_order: formQuestions.length
        };
        
        formQuestions.push(question);
        renderQuestions();
        closeQuestionCreationModal();
      }

      function renderQuestions() {
        const questionsList = document.getElementById('questionsList');
        if (formQuestions.length === 0) {
          questionsList.innerHTML = '<div class="text-center text-gray-500 py-4 border-2 border-dashed border-gray-300 rounded-lg"><i class="fas fa-question-circle text-3xl mb-2"></i><p>No questions yet. Click "Add Question" to start!</p></div>';
          return;
        }
        
        questionsList.innerHTML = formQuestions.map((q, idx) => \`
          <div class="bg-white p-4 rounded-lg border">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <span class="font-bold text-gray-400">#\${idx + 1}</span>
                  <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">\${q.question_type.toUpperCase()}</span>
                  \${q.is_required ? '<span class="text-red-500 text-sm">*</span>' : ''}
                </div>
                <p class="font-semibold mt-2">\${q.question_text}</p>
                \${q.options ? \`<p class="text-sm text-gray-600 mt-1">Options: \${q.options.join(', ')}</p>\` : ''}
              </div>
              <button onclick="removeQuestion(\${idx})" class="text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        \`).join('');
      }

      function removeQuestion(index) {
        formQuestions.splice(index, 1);
        renderQuestions();
      }

      // Save form
      async function saveForm() {
        // Check if we're in edit mode
        if (editingFormId) {
          await saveEditedForm();
          return;
        }
        
        const formName = document.getElementById('formName').value;
        if (!formName) {
          alert('Please enter a form name');
          return;
        }
        
        if (formQuestions.length === 0) {
          alert('Please add at least one question');
          return;
        }
        
        try {
          // Get propertyId from URL or localStorage
          const currentPropertyId = new URLSearchParams(window.location.search).get('property') || localStorage.getItem('property_id') || '1';
          console.log('DEBUG: currentPropertyId =', currentPropertyId);
          console.log('DEBUG: formQuestions =', formQuestions);
          
          // Create form
          const formData = {
            property_id: currentPropertyId,
            form_name: formName,
            form_description: document.getElementById('formDescription').value,
            form_type: document.getElementById('formType').value,
            require_room_number: document.getElementById('requireRoomNumber').checked ? 1 : 0,
            require_guest_name: document.getElementById('requireGuestName').checked ? 1 : 0,
            require_email: document.getElementById('requireEmail').checked ? 1 : 0,
            require_phone: document.getElementById('requirePhone').checked ? 1 : 0,
            thank_you_message: document.getElementById('thankYouMessage').value,
            show_on_homepage: document.getElementById('showOnHomepage').checked ? 1 : 0
          };
          
          console.log('DEBUG: formData =', formData);
          
          const formRes = await fetch('/api/admin/feedback/forms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          
          const formResult = await formRes.json();
          if (!formResult.success) throw new Error('Failed to create form');
          
          const newFormId = formResult.form_id;
          
          // Add all questions
          for (const question of formQuestions) {
            await fetch('/api/admin/feedback/questions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                form_id: newFormId,
                ...question
              })
            });
          }
          
          alert('âœ… Form created successfully!');
          closeFormBuilder();
          loadFeedbackTab();
          
        } catch (error) {
          console.error('âŒ Save form error:', error);
          console.error('Error details:', error.message, error.stack);
          alert('âŒ Failed to save form: ' + error.message);
        }
      }

      // Generate QR Code
      async function generateQR(formId, formName) {
        const formUrl = window.location.origin + '/feedback/' + formId;
        const qrApiUrl = \`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=\${encodeURIComponent(formUrl)}\`;
        
        // Create modal to show QR code
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = \`
          <div class="bg-white rounded-xl p-6 max-w-md">
            <h3 class="text-xl font-bold mb-4"><i class="fas fa-qrcode mr-2 text-purple-600"></i>\${formName}</h3>
            <div class="text-center mb-4">
              <img src="\${qrApiUrl}" alt="QR Code" class="mx-auto border-4 border-purple-600 rounded-lg">
            </div>
            <p class="text-sm text-gray-600 mb-4 text-center">Scan this code to access the feedback form</p>
            <div class="bg-gray-100 p-3 rounded mb-4 break-all text-sm">
              <strong>URL:</strong> \${formUrl}
            </div>
            <div class="flex gap-3">
              <a href="\${qrApiUrl}" download="feedback-qr-\${formId}.png" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded text-center hover:bg-purple-700">
                <i class="fas fa-download mr-2"></i>Download QR
              </a>
              <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">
                Close
              </button>
            </div>
          </div>
        \`;
        document.body.appendChild(modal);
        
        // Close on background click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
      }

      // Copy form link
      function copyFormLink(formId) {
        const formUrl = window.location.origin + '/feedback/' + formId;
        navigator.clipboard.writeText(formUrl).then(() => {
          alert('âœ… Link copied to clipboard!\\n' + formUrl);
        }).catch(() => {
          prompt('Copy this link:', formUrl);
        });
      }

      // View submission details
      async function viewSubmission(submissionId) {
        try {
          const res = await fetch('/api/admin/feedback/submissions/' + submissionId);
          const data = await res.json();
          
          if (data.success) {
            const sub = data.submission;
            const details = document.getElementById('submissionDetails');
            
            details.innerHTML = \`
              <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                  <h4 class="font-bold mb-2">Guest Information</h4>
                  <div class="grid grid-cols-2 gap-3 text-sm">
                    <div><strong>Name:</strong> \${sub.guest_name || 'N/A'}</div>
                    <div><strong>Room:</strong> \${sub.room_number || 'N/A'}</div>
                    <div><strong>Email:</strong> \${sub.guest_email || 'N/A'}</div>
                    <div><strong>Phone:</strong> \${sub.guest_phone || 'N/A'}</div>
                    <div><strong>Submitted:</strong> \${new Date(sub.submitted_at).toLocaleString()}</div>
                    <div><strong>Source:</strong> \${sub.submission_source}</div>
                  </div>
                </div>
                
                <div class="bg-\${sub.sentiment_label === 'positive' ? 'green' : sub.sentiment_label === 'urgent' ? 'red' : 'gray'}-50 p-4 rounded-lg">
                  <h4 class="font-bold mb-2">Sentiment Analysis</h4>
                  <div class="flex items-center gap-4">
                    <span class="px-4 py-2 bg-white rounded-lg font-semibold text-\${sub.sentiment_label === 'positive' ? 'green' : sub.sentiment_label === 'urgent' ? 'red' : 'gray'}-800">
                      \${sub.sentiment_label.toUpperCase()}
                    </span>
                    <span class="text-sm">Score: \${(sub.sentiment_score || 0).toFixed(2)}</span>
                    \${sub.is_urgent ? '<span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full animate-pulse">URGENT</span>' : ''}
                  </div>
                </div>
                
                <div>
                  <h4 class="font-bold mb-3">Responses</h4>
                  <div class="space-y-3">
                    \${sub.answers.map(answer => \`
                      <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="font-semibold text-purple-900 mb-2">\${answer.question_text}</p>
                        <p class="text-gray-800">
                          \${answer.answer_text || ''}
                          \${answer.answer_numeric !== null ? 'â­ ' + answer.answer_numeric : ''}
                        </p>
                      </div>
                    \`).join('')}
                  </div>
                </div>
              </div>
            \`;
            
            document.getElementById('submissionModal').classList.remove('hidden');
            
            // Mark as read
            await fetch('/api/admin/feedback/submissions/' + submissionId + '/mark-read', { method: 'POST' });
          }
        } catch (error) {
          console.error('View submission error:', error);
          alert('Failed to load submission');
        }
      }

      function closeSubmissionModal() {
        document.getElementById('submissionModal').classList.add('hidden');
      }

      // Resolve insight
      async function resolveInsight(insightId) {
        if (!confirm('Mark this issue as resolved?')) return;
        
        try {
          await fetch('/api/admin/feedback/insights/' + insightId + '/resolve', { method: 'POST' });
          alert('âœ… Issue marked as resolved');
          loadFeedbackTab();
        } catch (error) {
          console.error('Resolve insight error:', error);
          alert('Failed to resolve insight');
        }
      }

      // View form submissions
      async function viewFormSubmissions(formId, formName) {
        const modal = document.getElementById('submissionsModal');
        const formNameEl = document.getElementById('submissionsFormName');
        formNameEl.textContent = formName || 'Loading...';
        modal.classList.remove('hidden');
        await loadSubmissions(formId);
      }

      async function loadSubmissions(formId) {
        try {
          const response = await fetch('/api/admin/feedback/forms/' + formId + '/submissions');
          const data = await response.json();
          
          const container = document.getElementById('submissionsList');
          
          if (!data.submissions || data.submissions.length === 0) {
            container.innerHTML = \`
              <div class="text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">No submissions yet</p>
                <p class="text-gray-400 text-sm mt-2">Submissions will appear here once guests complete this form</p>
              </div>
            \`;
            return;
          }

          container.innerHTML = \`
            <div class="space-y-4">
              \${data.submissions.map(sub => {
                const date = new Date(sub.submitted_at);
                const sentimentColor = sub.sentiment_label === 'positive' ? 'green' : 
                                      sub.sentiment_label === 'negative' ? 'red' : 'yellow';
                const sentimentIcon = sub.sentiment_label === 'positive' ? 'smile' : 
                                     sub.sentiment_label === 'negative' ? 'frown' : 'meh';
                
                return \`
                  <div class="bg-white border-2 \${sub.is_urgent ? 'border-red-500' : 'border-gray-200'} rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer"
                       onclick="viewSubmissionDetail('\${sub.submission_id}')">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                          <h4 class="font-bold text-lg text-gray-900">\${sub.guest_name || 'Anonymous'}</h4>
                          \${sub.is_urgent ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-bold rounded-full"><i class="fas fa-exclamation-triangle mr-1"></i>URGENT</span>' : ''}
                          <span class="px-2 py-1 bg-\${sentimentColor}-100 text-\${sentimentColor}-800 text-xs font-semibold rounded-full">
                            <i class="fas fa-\${sentimentIcon} mr-1"></i>\${sub.sentiment_label}
                          </span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                          <p><i class="fas fa-door-open mr-2"></i>Room: <strong>\${sub.room_number || 'N/A'}</strong></p>
                          <p><i class="fas fa-envelope mr-2"></i>\${sub.guest_email || 'No email'}</p>
                          <p><i class="fas fa-clock mr-2"></i>\${date.toLocaleString()}</p>
                          <p><i class="fas fa-chart-line mr-2"></i>Sentiment Score: <strong>\${(sub.sentiment_score * 100).toFixed(1)}%</strong></p>
                        </div>
                      </div>
                      <button class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-eye mr-2"></i>View Details
                      </button>
                    </div>
                  </div>
                \`;
              }).join('')}
            </div>
          \`;
        } catch (error) {
          console.error('Load submissions error:', error);
          document.getElementById('submissionsList').innerHTML = \`
            <div class="text-center py-12">
              <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
              <p class="text-red-600 text-lg">Failed to load submissions</p>
              <button onclick="loadSubmissions('\${formId}')" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                <i class="fas fa-redo mr-2"></i>Retry
              </button>
            </div>
          \`;
        }
      }

      function closeSubmissionsModal() {
        document.getElementById('submissionsModal').classList.add('hidden');
      }

      async function viewSubmissionDetail(submissionId) {
        const modal = document.getElementById('submissionDetailModal');
        modal.classList.remove('hidden');
        await loadSubmissionDetail(submissionId);
      }

      async function loadSubmissionDetail(submissionId) {
        try {
          const response = await fetch('/api/admin/feedback/submissions/' + submissionId);
          const data = await response.json();
          
          const container = document.getElementById('submissionDetailContent');
          const submission = data.submission;
          const date = new Date(submission.submitted_at);
          
          const sentimentColor = submission.sentiment_label === 'positive' ? 'green' : 
                                submission.sentiment_label === 'negative' ? 'red' : 'yellow';
          const sentimentIcon = submission.sentiment_label === 'positive' ? 'smile' : 
                               submission.sentiment_label === 'negative' ? 'frown' : 'meh';
          
          container.innerHTML = \`
            <div class="space-y-6">
              <!-- Header Info -->
              <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6">
                <h4 class="text-2xl font-bold text-gray-900 mb-4">\${submission.form_name}</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div class="bg-white rounded-lg p-4 shadow-sm">
                    <p class="text-sm text-gray-600 mb-1"><i class="fas fa-user mr-2"></i>Guest Name</p>
                    <p class="text-lg font-bold text-gray-900">\${submission.guest_name || 'Anonymous'}</p>
                  </div>
                  <div class="bg-white rounded-lg p-4 shadow-sm">
                    <p class="text-sm text-gray-600 mb-1"><i class="fas fa-door-open mr-2"></i>Room Number</p>
                    <p class="text-lg font-bold text-gray-900">\${submission.room_number || 'N/A'}</p>
                  </div>
                  <div class="bg-white rounded-lg p-4 shadow-sm">
                    <p class="text-sm text-gray-600 mb-1"><i class="fas fa-envelope mr-2"></i>Email</p>
                    <p class="text-lg font-bold text-gray-900 break-all">\${submission.guest_email || 'N/A'}</p>
                  </div>
                  <div class="bg-white rounded-lg p-4 shadow-sm">
                    <p class="text-sm text-gray-600 mb-1"><i class="fas fa-clock mr-2"></i>Submitted</p>
                    <p class="text-lg font-bold text-gray-900">\${date.toLocaleString()}</p>
                  </div>
                </div>
              </div>

              <!-- Sentiment Analysis -->
              <div class="bg-white border-2 border-gray-200 rounded-lg p-6">
                <h5 class="text-lg font-bold text-gray-900 mb-4"><i class="fas fa-brain mr-2"></i>AI Sentiment Analysis</h5>
                <div class="grid grid-cols-2 gap-4">
                  <div class="text-center p-4 bg-\${sentimentColor}-50 rounded-lg">
                    <i class="fas fa-\${sentimentIcon} text-4xl text-\${sentimentColor}-600 mb-2"></i>
                    <p class="text-sm text-gray-600">Sentiment</p>
                    <p class="text-xl font-bold text-\${sentimentColor}-700 capitalize">\${submission.sentiment_label}</p>
                  </div>
                  <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <i class="fas fa-chart-line text-4xl text-blue-600 mb-2"></i>
                    <p class="text-sm text-gray-600">Confidence Score</p>
                    <p class="text-xl font-bold text-blue-700">\${(submission.sentiment_score * 100).toFixed(1)}%</p>
                  </div>
                </div>
                \${submission.is_urgent ? \`
                  <div class="mt-4 p-4 bg-red-50 border-2 border-red-500 rounded-lg">
                    <p class="text-red-800 font-bold">
                      <i class="fas fa-exclamation-triangle mr-2"></i>
                      URGENT: This submission requires immediate attention
                    </p>
                  </div>
                \` : ''}
              </div>

              <!-- Answers -->
              <div class="bg-white border-2 border-gray-200 rounded-lg p-6">
                <h5 class="text-lg font-bold text-gray-900 mb-4"><i class="fas fa-comments mr-2"></i>Responses</h5>
                <div class="space-y-4">
                  \${submission.answers.map((answer, idx) => {
                    let answerDisplay = answer.answer_text;
                    
                    // Handle rating display
                    if (answer.question_type === 'rating' && answer.answer_text) {
                      const rating = parseInt(answer.answer_text);
                      answerDisplay = '<div class="flex items-center gap-1">' + 
                        Array(5).fill(0).map((_, i) => 
                          \`<i class="fas fa-star text-xl \${i < rating ? 'text-yellow-500' : 'text-gray-300'}"></i>\`
                        ).join('') + 
                        \`<span class="ml-2 text-gray-600">(\${rating}/5)</span></div>\`;
                    }
                    
                    // Handle yes/no display
                    if (answer.question_type === 'yes_no') {
                      const isYes = answer.answer_text?.toLowerCase() === 'yes';
                      answerDisplay = \`
                        <span class="inline-flex items-center px-4 py-2 rounded-full \${isYes ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                          <i class="fas fa-\${isYes ? 'check' : 'times'} mr-2"></i>
                          \${answer.answer_text}
                        </span>
                      \`;
                    }

                    return \`
                      <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-question-circle mr-2 text-purple-600"></i>
                          Question \${idx + 1}
                        </p>
                        <p class="text-gray-900 font-medium mb-3">\${answer.question_text}</p>
                        <div class="pl-4 border-l-4 border-purple-600">
                          \${answerDisplay}
                        </div>
                      </div>
                    \`;
                  }).join('')}
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="flex gap-4">
                <button onclick="closeSubmissionDetailModal()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                  <i class="fas fa-arrow-left mr-2"></i>Back to List
                </button>
                <button onclick="alert('Export feature coming soon!')" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold">
                  <i class="fas fa-download mr-2"></i>Export PDF
                </button>
              </div>
            </div>
          \`;
        } catch (error) {
          console.error('Load submission detail error:', error);
          document.getElementById('submissionDetailContent').innerHTML = \`
            <div class="text-center py-12">
              <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
              <p class="text-red-600 text-lg">Failed to load submission details</p>
              <button onclick="loadSubmissionDetail('\${submissionId}')" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                <i class="fas fa-redo mr-2"></i>Retry
              </button>
            </div>
          \`;
        }
      }

      function closeSubmissionDetailModal() {
        document.getElementById('submissionDetailModal').classList.add('hidden');
      }

      // View analytics
      async function viewAnalytics() {
        const modal = document.getElementById('analyticsModal');
        modal.classList.remove('hidden');
        await loadAnalyticsData();
      }

      async function loadAnalyticsData() {
        try {
          const response = await fetch('/api/admin/feedback/analytics/' + propertyId);
          const data = await response.json();
          
          if (!data.success) {
            throw new Error('Failed to load analytics');
          }
          
          const stats = data.stats;
          const recentSubmissions = data.recent_submissions || [];
          const insights = data.insights || [];
          
          const container = document.getElementById('analyticsContent');
          
          // Calculate percentages
          const totalSubmissions = stats.total_submissions || 0;
          const positivePercent = totalSubmissions > 0 ? ((stats.positive_count / totalSubmissions) * 100).toFixed(1) : 0;
          const negativePercent = totalSubmissions > 0 ? ((stats.negative_count / totalSubmissions) * 100).toFixed(1) : 0;
          const neutralPercent = totalSubmissions > 0 ? (100 - positivePercent - negativePercent).toFixed(1) : 0;
          
          container.innerHTML = \`
            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
                <div class="flex items-center justify-between mb-3">
                  <i class="fas fa-inbox text-4xl opacity-80"></i>
                  <span class="text-xs font-semibold bg-white/20 px-3 py-1 rounded-full">Total</span>
                </div>
                <h4 class="text-3xl font-bold mb-1">\${totalSubmissions}</h4>
                <p class="text-blue-100 text-sm">Total Submissions</p>
              </div>
              
              <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg">
                <div class="flex items-center justify-between mb-3">
                  <i class="fas fa-smile text-4xl opacity-80"></i>
                  <span class="text-xs font-semibold bg-white/20 px-3 py-1 rounded-full">\${positivePercent}%</span>
                </div>
                <h4 class="text-3xl font-bold mb-1">\${stats.positive_count || 0}</h4>
                <p class="text-green-100 text-sm">Positive Feedback</p>
              </div>
              
              <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-6 text-white shadow-lg">
                <div class="flex items-center justify-between mb-3">
                  <i class="fas fa-frown text-4xl opacity-80"></i>
                  <span class="text-xs font-semibold bg-white/20 px-3 py-1 rounded-full">\${negativePercent}%</span>
                </div>
                <h4 class="text-3xl font-bold mb-1">\${stats.negative_count || 0}</h4>
                <p class="text-red-100 text-sm">Negative Feedback</p>
              </div>
              
              <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-xl p-6 text-white shadow-lg">
                <div class="flex items-center justify-between mb-3">
                  <i class="fas fa-exclamation-triangle text-4xl opacity-80"></i>
                  <span class="text-xs font-semibold bg-white/20 px-3 py-1 rounded-full">Urgent</span>
                </div>
                <h4 class="text-3xl font-bold mb-1">\${stats.urgent_count || 0}</h4>
                <p class="text-orange-100 text-sm">Requires Attention</p>
              </div>
            </div>

            <!-- Sentiment Overview -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <!-- Sentiment Distribution -->
              <div class="bg-white border-2 border-gray-200 rounded-xl p-6 shadow-md">
                <h4 class="text-xl font-bold mb-4 flex items-center">
                  <i class="fas fa-chart-pie mr-2 text-indigo-600"></i>
                  Sentiment Distribution
                </h4>
                <div class="space-y-4">
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-semibold text-gray-700">
                        <i class="fas fa-smile text-green-600 mr-2"></i>Positive
                      </span>
                      <span class="text-sm font-bold text-green-600">\${stats.positive_count || 0} (\${positivePercent}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                      <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" style="width: \${positivePercent}%"></div>
                    </div>
                  </div>
                  
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-semibold text-gray-700">
                        <i class="fas fa-meh text-yellow-600 mr-2"></i>Neutral
                      </span>
                      <span class="text-sm font-bold text-yellow-600">\${totalSubmissions - (stats.positive_count || 0) - (stats.negative_count || 0)} (\${neutralPercent}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                      <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 h-3 rounded-full transition-all duration-500" style="width: \${neutralPercent}%"></div>
                    </div>
                  </div>
                  
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-semibold text-gray-700">
                        <i class="fas fa-frown text-red-600 mr-2"></i>Negative
                      </span>
                      <span class="text-sm font-bold text-red-600">\${stats.negative_count || 0} (\${negativePercent}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                      <div class="bg-gradient-to-r from-red-400 to-red-600 h-3 rounded-full transition-all duration-500" style="width: \${negativePercent}%"></div>
                    </div>
                  </div>
                </div>
                
                <div class="mt-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold text-gray-700">Average Sentiment Score</span>
                    <span class="text-2xl font-bold text-indigo-600">\${((stats.avg_sentiment || 0) * 100).toFixed(1)}%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div class="bg-gradient-to-r from-indigo-400 to-indigo-600 h-2 rounded-full" style="width: \${(stats.avg_sentiment || 0) * 100}%"></div>
                  </div>
                </div>
              </div>

              <!-- Active Insights -->
              <div class="bg-white border-2 border-gray-200 rounded-xl p-6 shadow-md">
                <h4 class="text-xl font-bold mb-4 flex items-center justify-between">
                  <span>
                    <i class="fas fa-lightbulb mr-2 text-orange-600"></i>
                    Active Insights
                  </span>
                  <span class="px-3 py-1 bg-orange-100 text-orange-800 text-sm font-bold rounded-full">\${insights.length}</span>
                </h4>
                
                \${insights.length > 0 ? \`
                  <div class="space-y-3 max-h-80 overflow-y-auto">
                    \${insights.slice(0, 5).map(insight => \`
                      <div class="p-4 bg-gradient-to-r from-orange-50 to-red-50 border-l-4 border-orange-500 rounded-lg">
                        <div class="flex items-start justify-between mb-2">
                          <h5 class="font-bold text-gray-900 flex-1">\${insight.title}</h5>
                          <span class="px-2 py-1 bg-\${insight.priority === 'critical' ? 'red' : insight.priority === 'high' ? 'orange' : 'yellow'}-100 text-\${insight.priority === 'critical' ? 'red' : insight.priority === 'high' ? 'orange' : 'yellow'}-800 text-xs font-bold rounded uppercase ml-2">
                            \${insight.priority}
                          </span>
                        </div>
                        <p class="text-sm text-gray-700 mb-2">\${insight.description}</p>
                        <p class="text-xs text-gray-600">
                          <i class="fas fa-wrench mr-1"></i>
                          <strong>Action:</strong> \${insight.action_suggested}
                        </p>
                      </div>
                    \`).join('')}
                  </div>
                \` : \`
                  <div class="text-center py-8">
                    <i class="fas fa-check-circle text-5xl text-green-500 mb-3"></i>
                    <p class="text-gray-600">No active insights</p>
                    <p class="text-sm text-gray-500 mt-1">All issues have been resolved!</p>
                  </div>
                \`}
              </div>
            </div>

            <!-- Recent Submissions Timeline -->
            <div class="bg-white border-2 border-gray-200 rounded-xl p-6 shadow-md">
              <h4 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-clock mr-2 text-blue-600"></i>
                Recent Submissions
              </h4>
              
              \${recentSubmissions.length > 0 ? \`
                <div class="space-y-3">
                  \${recentSubmissions.map((sub, idx) => {
                    const date = new Date(sub.submitted_at);
                    const sentimentColor = sub.sentiment_label === 'positive' ? 'green' : 
                                          sub.sentiment_label === 'negative' ? 'red' : 'yellow';
                    const sentimentIcon = sub.sentiment_label === 'positive' ? 'smile' : 
                                         sub.sentiment_label === 'negative' ? 'frown' : 'meh';
                    
                    return \`
                      <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="viewSubmissionDetail('\${sub.submission_id}')">
                        <div class="flex-shrink-0 w-12 h-12 bg-\${sentimentColor}-100 rounded-full flex items-center justify-center">
                          <i class="fas fa-\${sentimentIcon} text-2xl text-\${sentimentColor}-600"></i>
                        </div>
                        <div class="flex-1">
                          <div class="flex items-center gap-2 mb-1">
                            <h5 class="font-bold text-gray-900">\${sub.form_name}</h5>
                            \${sub.is_urgent ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-bold rounded-full">URGENT</span>' : ''}
                          </div>
                          <p class="text-sm text-gray-600">
                            \${sub.guest_name || 'Anonymous'} 
                            \${sub.room_number ? 'â€¢ Room ' + sub.room_number : ''}
                            â€¢ \${date.toLocaleString()}
                          </p>
                        </div>
                        <div class="text-right">
                          <span class="px-3 py-1 bg-\${sentimentColor}-100 text-\${sentimentColor}-800 text-sm font-semibold rounded-full">
                            \${(sub.sentiment_score * 100).toFixed(0)}%
                          </span>
                        </div>
                      </div>
                    \`;
                  }).join('')}
                </div>
              \` : \`
                <div class="text-center py-12">
                  <i class="fas fa-inbox text-5xl text-gray-300 mb-3"></i>
                  <p class="text-gray-500">No submissions yet</p>
                </div>
              \`}
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex gap-4">
              <button onclick="closeAnalyticsModal()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                <i class="fas fa-arrow-left mr-2"></i>Close
              </button>
              <button onclick="alert('Export feature coming soon!')" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all font-semibold shadow-lg">
                <i class="fas fa-download mr-2"></i>Export Report
              </button>
            </div>
          \`;
        } catch (error) {
          console.error('Load analytics error:', error);
          document.getElementById('analyticsContent').innerHTML = \`
            <div class="text-center py-12">
              <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
              <p class="text-red-600 text-lg font-semibold">Failed to load analytics</p>
              <button onclick="loadAnalyticsData()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                <i class="fas fa-redo mr-2"></i>Retry
              </button>
            </div>
          \`;
        }
      }

      function closeAnalyticsModal() {
        document.getElementById('analyticsModal').classList.add('hidden');
      }

      // View insights
      async function viewInsights() {
        const modal = document.getElementById('insightsModal');
        modal.classList.remove('hidden');
        await loadInsights();
      }
      
      async function loadInsights() {
        try {
          const response = await fetch('/api/admin/feedback/analytics/' + propertyId);
          const data = await response.json();
          
          if (data.success) {
            const insightsContainer = document.getElementById('insightsList');
            
            if (!data.insights || data.insights.length === 0) {
              insightsContainer.innerHTML = '<div class="text-center py-8">' +
                '<i class="fas fa-lightbulb text-6xl text-gray-300 mb-4"></i>' +
                '<p class="text-gray-500 mb-4">No AI insights generated yet</p>' +
                '<button onclick="generateInsights()" class="bg-gradient-to-r from-orange-600 to-red-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">' +
                '<i class="fas fa-magic mr-2"></i>Generate AI Insights' +
                '</button>' +
                '</div>';
              return;
            }
            
            const insightsHTML = data.insights.map(insight => {
              const borderColor = insight.priority === 'high' || insight.priority === 'critical' ? 'border-red-500' : insight.priority === 'medium' ? 'border-yellow-500' : 'border-blue-500';
              const badgeColor = insight.priority === 'high' || insight.priority === 'critical' ? 'bg-red-100 text-red-700' : insight.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700';
              const actionItemsHTML = insight.action_suggested ? 
                '<div class="bg-blue-50 border-l-2 border-blue-500 p-3 mb-2">' +
                '<p class="text-sm font-semibold text-blue-900 mb-1"><i class="fas fa-tasks mr-1"></i>Suggested Action:</p>' +
                '<p class="text-sm text-blue-800">' + insight.action_suggested + '</p>' +
                '</div>' : '';
              
              return '<div class="bg-white border-l-4 ' + borderColor + ' rounded-lg shadow p-4 mb-4">' +
                '<div class="flex items-start justify-between mb-2">' +
                '<div class="flex-1">' +
                '<div class="flex items-center gap-2 mb-2">' +
                '<span class="px-2 py-1 rounded text-xs font-semibold ' + badgeColor + '">' + insight.priority.toUpperCase() + '</span>' +
                '<span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-700">' + (insight.insight_type || 'General') + '</span>' +
                '</div>' +
                '<h4 class="font-bold text-lg mb-2">' + insight.title + '</h4>' +
                '<p class="text-gray-700 mb-3">' + insight.description + '</p>' +
                actionItemsHTML +
                '<p class="text-xs text-gray-500 mt-2">' +
                '<i class="fas fa-calendar mr-1"></i>' + new Date(insight.created_at).toLocaleString() +
                '</p>' +
                '</div>' +
                '<button onclick="resolveInsight(' + insight.insight_id + ')" class="ml-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">' +
                '<i class="fas fa-check mr-1"></i>Resolve' +
                '</button>' +
                '</div>' +
                '</div>';
            }).join('');
            
            insightsContainer.innerHTML = '<div class="mb-4">' +
              '<button onclick="generateInsights()" class="bg-gradient-to-r from-orange-600 to-red-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">' +
              '<i class="fas fa-magic mr-2"></i>Generate New Insights' +
              '</button>' +
              '</div>' +
              insightsHTML;
          }
        } catch (error) {
          console.error('Load insights error:', error);
          document.getElementById('insightsList').innerHTML = 
            '<div class="text-center py-8 text-red-600">' +
            '<i class="fas fa-exclamation-triangle text-4xl mb-2"></i>' +
            '<p>Error loading insights</p>' +
            '</div>';
        }
      }
      
      async function generateInsights() {
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating insights...';
        
        try {
          const response = await fetch('/api/admin/feedback/generate-insights/' + propertyId, {
            method: 'POST'
          });
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… AI insights generated successfully!\\n\\nGenerated ' + (data.insights?.length || 0) + ' new insights.');
            await loadInsights();
          } else {
            alert('âš ï¸ ' + (data.message || 'No new insights generated'));
            await loadInsights();
          }
        } catch (error) {
          console.error('Generate insights error:', error);
          alert('âŒ Error generating insights. Please try again.');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        }
      }
      
      async function resolveInsight(insightId) {
        if (!confirm('Mark this insight as resolved?')) return;
        
        try {
          const response = await fetch('/api/admin/feedback/insights/' + insightId + '/resolve', {
            method: 'POST'
          });
          
          if (response.ok) {
            alert('âœ… Insight marked as resolved!');
            await loadInsights();
          } else {
            alert('âŒ Failed to resolve insight');
          }
        } catch (error) {
          console.error('Resolve insight error:', error);
          alert('âŒ Error resolving insight');
        }
      }
      
      function closeInsightsModal() {
        document.getElementById('insightsModal').classList.add('hidden');
      }

      // Set homepage form (only ONE can be selected)
      async function setHomepageForm(formId) {
        try {
          const response = await fetch('/api/admin/feedback/forms/' + formId + '/set-homepage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ property_id: propertyId })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Homepage form updated successfully!');
            loadFeedbackTab(); // Reload to show updated state
          } else {
            alert('âŒ Failed to update homepage form: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Set homepage form error:', error);
          alert('âŒ Failed to update homepage form');
        }
      }

      // Delete form
      async function deleteForm(formId, formName) {
        if (!confirm('Are you sure you want to delete "' + formName + '"?\\n\\nThis will permanently delete the form and all its questions and submissions!')) {
          return;
        }
        
        try {
          const response = await fetch('/api/admin/feedback/forms/' + formId, {
            method: 'DELETE'
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Form deleted successfully!');
            loadFeedbackTab(); // Reload forms list
          } else {
            alert('âŒ Failed to delete form: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Delete form error:', error);
          alert('âŒ Failed to delete form');
        }
      }

      let editingFormId = null;

      async function editForm(formId) {
        try {
          // Fetch form details
          const response = await fetch('/api/admin/feedback/forms/' + formId + '/details');
          const data = await response.json();
          
          if (!data.success) {
            alert('Failed to load form details');
            return;
          }
          
          const form = data.form;
          editingFormId = formId;
          
          // Populate form modal with existing data
          document.getElementById('formName').value = form.form_name;
          document.getElementById('formDescription').value = form.form_description || '';
          document.getElementById('formType').value = form.form_type;
          document.getElementById('requireRoomNumber').checked = form.require_room_number === 1;
          document.getElementById('requireGuestName').checked = form.require_guest_name === 1;
          document.getElementById('requireEmail').checked = form.require_email === 1;
          document.getElementById('requirePhone').checked = form.require_phone === 1;
          document.getElementById('thankYouMessage').value = form.thank_you_message || '';
          document.getElementById('isActiveToggle').checked = form.is_active === 1;
          
          // Load existing questions
          formQuestions = form.questions.map(q => ({
            question_id: q.question_id, // Keep question_id for updates
            question_text: q.question_text,
            question_type: q.question_type,
            is_required: q.is_required === 1,
            options: q.options,
            display_order: q.display_order
          }));
          
          // Update modal title
          document.querySelector('#formBuilderModal .text-2xl').innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Feedback Form';
          
          // Show the modal
          document.getElementById('formBuilderModal').classList.remove('hidden');
          
          renderQuestions();
        } catch (error) {
          console.error('Edit form error:', error);
          alert('Failed to load form for editing');
        }
      }

      async function saveEditedForm() {
        const formName = document.getElementById('formName').value.trim();
        const formDescription = document.getElementById('formDescription').value.trim();
        const formType = document.getElementById('formType').value;
        const requireRoomNumber = document.getElementById('requireRoomNumber').checked;
        const requireGuestName = document.getElementById('requireGuestName').checked;
        const requireEmail = document.getElementById('requireEmail').checked;
        const requirePhone = document.getElementById('requirePhone').checked;
        const thankYouMessage = document.getElementById('thankYouMessage').value.trim();
        const isActive = document.getElementById('isActiveToggle').checked;
        
        if (!formName) {
          alert('Please enter a form name');
          return;
        }
        
        if (formQuestions.length === 0) {
          alert('Please add at least one question');
          return;
        }
        
        try {
          // Update form details
          const updateResponse = await fetch('/api/admin/feedback/forms/' + editingFormId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              form_name: formName,
              form_description: formDescription,
              is_active: isActive,
              require_room_number: requireRoomNumber,
              require_guest_name: requireGuestName,
              require_email: requireEmail,
              require_phone: requirePhone,
              thank_you_message: thankYouMessage
            })
          });
          
          if (!updateResponse.ok) {
            throw new Error('Failed to update form');
          }
          
          // Delete all existing questions
          const existingQuestions = formQuestions.filter(q => q.question_id);
          for (const q of existingQuestions) {
            await fetch('/api/admin/feedback/questions/' + q.question_id, {
              method: 'DELETE'
            });
          }
          
          // Add all questions (both new and existing)
          for (const question of formQuestions) {
            await fetch('/api/admin/feedback/questions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                form_id: editingFormId,
                question_text: question.question_text,
                question_type: question.question_type,
                is_required: question.is_required,
                options: question.options,
                display_order: question.display_order
              })
            });
          }
          
          alert('âœ… Form updated successfully!');
          closeFormBuilder();
          loadFeedbackTab();
          editingFormId = null;
        } catch (error) {
          console.error('Save edited form error:', error);
          alert('Failed to update form. Please try again.');
        }
      }

      // ========== END FEEDBACK MANAGEMENT FUNCTIONS ==========

      // ========================================
      // RESTAURANTS MANAGEMENT
      // ========================================
      let selectedRestaurantId = null;
      
      async function loadRestaurantsTab() {
        try {
          const response = await fetch('/api/hotel-offerings/1');
          const data = await response.json();
          const restaurants = data.offerings.filter(o => o.offering_type === 'restaurant');
          
          const selector = document.getElementById('restaurantSelector');
          if (restaurants.length === 0) {
            selector.innerHTML = '<option value="">No restaurants found</option>';
            return;
          }
          
          selector.innerHTML = '<option value="">-- Select a Restaurant --</option>' + 
            restaurants.map(r => '<option value="' + r.offering_id + '">' + (r.title_en || r.title) + '</option>').join('');
          
          selector.addEventListener('change', async function() {
            selectedRestaurantId = this.value;
            if (selectedRestaurantId) {
              await loadRestaurantStats(selectedRestaurantId);
              document.getElementById('restaurantQuickStats').classList.remove('hidden');
              document.getElementById('restaurantActionButton').classList.remove('hidden');
            } else {
              document.getElementById('restaurantQuickStats').classList.add('hidden');
              document.getElementById('restaurantActionButton').classList.add('hidden');
            }
          });
        } catch (error) {
          console.error('Load restaurants error:', error);
        }
      }
      
      async function loadRestaurantStats(offeringId) {
        try {
          const today = new Date().toISOString().split('T')[0];
          
          // Get today's reservations
          const resResponse = await fetch('/api/admin/restaurant/reservations?offering_id=' + offeringId + '&date=' + today);
          const resData = await resResponse.json();
          const reservations = resData.reservations || [];
          
          // Get tables
          const tablesResponse = await fetch('/api/restaurant/' + offeringId + '/tables');
          const tablesData = await tablesResponse.json();
          const tables = tablesData.tables || [];
          
          // Get sessions
          const sessionsResponse = await fetch('/api/restaurant/' + offeringId + '/sessions?date=' + today);
          const sessionsData = await sessionsResponse.json();
          const sessions = sessionsData.sessions || [];
          
          // Update stats
          document.getElementById('statTodayReservations').textContent = reservations.length;
          document.getElementById('statTablesAvailable').textContent = tables.length;
          document.getElementById('statSlotsToday').textContent = sessions.length;
          document.getElementById('statPending').textContent = reservations.filter(r => r.status === 'pending').length;
        } catch (error) {
          console.error('Load restaurant stats error:', error);
        }
      }
      
      function openRestaurantManagement() {
        if (selectedRestaurantId) {
          window.open('/admin/restaurant/' + selectedRestaurantId, '_blank');
        } else {
          alert('Please select a restaurant first');
        }
      }
      
      // Make function globally accessible
      window.openRestaurantManagement = openRestaurantManagement;
      
      // ========== END RESTAURANTS MANAGEMENT ==========

      // ========== AUTO-REFRESH & NOTIFICATION SYSTEM ==========
      
      // Store previous data to detect new bookings
      let previousBeachBookings = [];
      let previousCallbacks = [];
      let previousFeedback = [];
      
      // Auto-refresh settings
      let autoRefreshEnabled = true;
      let soundEnabled = true;
      let refreshIntervalMs = 300000; // 5 minutes
      let refreshTimers = {};
      
      // Notification sound (simple beep)
      function playNotificationSound() {
        if (!soundEnabled) return;
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = 800; // Frequency in Hz
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.5);
        } catch (error) {
          console.error('Sound error:', error);
        }
      }
      
      // Show notification badge
      function showNewBadge(containerId, count) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const existingBadge = container.querySelector('.new-items-badge');
        if (existingBadge) {
          existingBadge.textContent = count + ' NEW';
        } else {
          const badge = document.createElement('span');
          badge.className = 'new-items-badge bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full ml-2 animate-pulse';
          badge.textContent = count + ' NEW';
          container.appendChild(badge);
        }
      }
      
      // Clear notification badge
      function clearNewBadge(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const badge = container.querySelector('.new-items-badge');
        if (badge) badge.remove();
      }
      
      // Update last refreshed timestamp
      function updateLastRefreshed(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const now = new Date();
        element.textContent = 'Last updated: ' + now.toLocaleTimeString();
      }
      
      // Enhanced loadBeachBookings with change detection
      const originalLoadBeachBookings = window.loadBeachBookings;
      window.loadBeachBookings = async function(detectChanges = false) {
        try {
          const date = document.getElementById('beachBookingDate')?.value;
          const response = await fetch('/api/admin/beach/bookings?property_id=1&date=' + date);
          const data = await response.json();
          
          if (detectChanges && data.success && data.bookings) {
            const newBookings = data.bookings.filter(b => 
              !previousBeachBookings.some(pb => pb.booking_reference === b.booking_reference)
            );
            
            if (newBookings.length > 0 && !acknowledgedNotifications.has('bookings')) {
              startPersistentBeep('bookings');
              showNewBadge('beachBookingsHeader', newBookings.length);
              showNotificationPopup('New Bookings', newBookings.length + ' new booking(s) received', newBookings.length);
              
              // Browser notification
              if (Notification.permission === 'granted') {
                new Notification('New Beach Booking!', {
                  body: newBookings.length + ' new beach booking(s) received',
                  icon: 'https://cdn-icons-png.flaticon.com/512/2921/2921822.png'
                });
              }
            }
            
            previousBeachBookings = data.bookings || [];
          } else if (!detectChanges) {
            previousBeachBookings = data.bookings || [];
          }
          
          // Call original function
          if (originalLoadBeachBookings) {
            await originalLoadBeachBookings();
          }
          
          updateLastRefreshed('beachBookingsTimestamp');
        } catch (error) {
          console.error('Auto-refresh beach bookings error:', error);
        }
      };
      
      // Enhanced loadCallbacks with change detection
      const originalLoadCallbacks = loadCallbacks;
      const enhancedLoadCallbacks = async function(detectChanges = false) {
        try {
          const response = await fetch('/api/admin/callback-requests?property_id=1');
          const data = await response.json();
          
          if (detectChanges && data.requests) {
            const newCallbacks = data.requests.filter(c => 
              !previousCallbacks.some(pc => pc.request_id === c.request_id)
            );
            
            if (newCallbacks.length > 0 && !acknowledgedNotifications.has('callbacks')) {
              startPersistentBeep('callbacks');
              showNewBadge('callbacksHeader', newCallbacks.length);
              showNotificationPopup('New Callback Requests', newCallbacks.length + ' new callback request(s)', newCallbacks.length);
              
              if (Notification.permission === 'granted') {
                new Notification('New Activity Booking Request!', {
                  body: newCallbacks.length + ' new callback request(s)',
                  icon: 'https://cdn-icons-png.flaticon.com/512/3585/3585596.png'
                });
              }
            }
            
            previousCallbacks = data.requests || [];
          } else if (!detectChanges) {
            previousCallbacks = data.requests || [];
          }
          
          // Call original function
          await originalLoadCallbacks();
          updateLastRefreshed('callbacksTimestamp');
        } catch (error) {
          console.error('Auto-refresh callbacks error:', error);
        }
      };
      
      // Enhanced loadFeedbackTab with change detection
      const originalLoadFeedbackTab = loadFeedbackTab;
      const enhancedLoadFeedbackTab = async function(detectChanges = false) {
        try {
          const analyticsRes = await fetch('/api/admin/feedback/analytics/' + propertyId);
          const analyticsData = await analyticsRes.json();
          
          if (detectChanges && analyticsData.success && analyticsData.recent_submissions) {
            const newFeedback = analyticsData.recent_submissions.filter(f => 
              !previousFeedback.some(pf => pf.submission_id === f.submission_id)
            );
            
            if (newFeedback.length > 0 && !acknowledgedNotifications.has('feedback')) {
              startPersistentBeep('feedback');
              showNewBadge('feedbackHeader', newFeedback.length);
              showNotificationPopup('New Feedback', newFeedback.length + ' new feedback submission(s)', newFeedback.length);
              
              if (Notification.permission === 'granted') {
                new Notification('New Feedback Submission!', {
                  body: newFeedback.length + ' new feedback submission(s)',
                  icon: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png'
                });
              }
            }
            
            previousFeedback = analyticsData.recent_submissions || [];
          } else if (!detectChanges) {
            previousFeedback = analyticsData.recent_submissions || [];
          }
          
          // Call original function
          await originalLoadFeedbackTab();
          updateLastRefreshed('feedbackTimestamp');
        } catch (error) {
          console.error('Auto-refresh feedback error:', error);
        }
      };
      
      // Start auto-refresh for a specific section
      function startAutoRefresh(section) {
        if (refreshTimers[section]) {
          clearInterval(refreshTimers[section]);
        }
        
        if (!autoRefreshEnabled) return;
        
        refreshTimers[section] = setInterval(() => {
          if (section === 'beach' && document.getElementById('beachBookingsList')) {
            window.loadBeachBookings(true);
          } else if (section === 'callbacks' && document.getElementById('callbacksList')) {
            enhancedLoadCallbacks(true);
          } else if (section === 'feedback' && document.getElementById('recentSubmissions')) {
            enhancedLoadFeedbackTab(true);
          }
        }, refreshIntervalMs);
      }
      
      // Stop auto-refresh
      function stopAutoRefresh(section) {
        if (refreshTimers[section]) {
          clearInterval(refreshTimers[section]);
          delete refreshTimers[section];
        }
      }
      
      // Toggle auto-refresh
      window.toggleAutoRefresh = function() {
        autoRefreshEnabled = !autoRefreshEnabled;
        const button = document.getElementById('autoRefreshToggle');
        if (button) {
          button.innerHTML = autoRefreshEnabled ? 
            '<i class="fas fa-toggle-on mr-2"></i>Auto-refresh: ON' : 
            '<i class="fas fa-toggle-off mr-2"></i>Auto-refresh: OFF';
          button.className = autoRefreshEnabled ?
            'px-4 py-2 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 transition' :
            'px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition';
        }
        
        if (autoRefreshEnabled) {
          startAutoRefresh('beach');
          startAutoRefresh('callbacks');
          startAutoRefresh('feedback');
        } else {
          stopAutoRefresh('beach');
          stopAutoRefresh('callbacks');
          stopAutoRefresh('feedback');
        }
      };
      
      // Toggle sound
      window.toggleSound = function() {
        soundEnabled = !soundEnabled;
        const button = document.getElementById('soundToggle');
        if (button) {
          button.innerHTML = soundEnabled ? 
            '<i class="fas fa-volume-up mr-2"></i>Sound: ON' : 
            '<i class="fas fa-volume-mute mr-2"></i>Sound: OFF';
          button.className = soundEnabled ?
            'px-4 py-2 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition' :
            'px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition';
        }
      };
      
      // Request notification permission
      function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
      }
      
      // Initialize notification settings and auto-refresh when page loads
      setTimeout(() => {
        requestNotificationPermission();
        loadNotificationSettings();
        
        // Start auto-refresh for active sections
        if (document.getElementById('beachBookingsList')) {
          startAutoRefresh('beach');
        }
        if (document.getElementById('callbacksList')) {
          startAutoRefresh('callbacks');
        }
        if (document.getElementById('recentSubmissions')) {
          startAutoRefresh('feedback');
        }
      }, 2000);
      
      // ========== END AUTO-REFRESH & NOTIFICATION SYSTEM ==========

      // ========== END FEEDBACK MANAGEMENT FUNCTIONS ==========
      
      // ========== AI ASSISTANT SYSTEM ==========
      
      // Assistant state and configuration
      const assistantConfig = {
        tips: {
          qrcode: [
            { icon: 'ðŸŽ¨', title: 'Design Your First QR Code', description: 'Upload your logo, choose colors, and create a professional QR code in under 2 minutes!', action: 'Start Now' },
            { icon: 'ðŸ’¡', title: 'Pro Tip', description: 'Medium size QR codes work best for printing on cards and posters.', action: null },
            { icon: 'ðŸ“±', title: 'Test Before Printing', description: 'Always scan your QR code with multiple devices before mass printing.', action: null }
          ],
          analytics: [
            { icon: 'ðŸ“Š', title: 'Track Guest Engagement', description: 'See how many guests scan your QR codes and which services are most popular.', action: null },
            { icon: 'ðŸ“ˆ', title: 'Export Reports', description: 'Download CSV reports to analyze trends over time.', action: null }
          ],
          settings: [
            { icon: 'ðŸ¨', title: 'Complete Your Profile', description: 'Add your hotel logo, brand colors, and contact information for a professional look.', action: 'Go to Settings' },
            { icon: 'ðŸŽ¨', title: 'Customize Branding', description: 'Match your hotel\\'s brand by setting custom colors and fonts.', action: null }
          ],
          offerings: [
            { icon: 'ðŸ½ï¸', title: 'Add Your First Restaurant', description: 'Showcase your dining options with photos, menus, and booking details.', action: 'Create Restaurant' },
            { icon: 'ðŸŽ­', title: 'Add Events & Activities', description: 'Let guests discover spa treatments, excursions, and special events.', action: null }
          ],
          restaurants: [
            { icon: 'ðŸ“‹', title: 'Restaurant Floor Designer', description: 'Create interactive floor plans so guests can choose their preferred table.', action: 'Open Designer' },
            { icon: 'ðŸ“¸', title: 'Add Photos', description: 'Upload high-quality images of your food and ambiance.', action: null }
          ],
          activities: [
            { icon: 'ðŸŽ«', title: 'Create Activity Packages', description: 'Bundle experiences and let guests book directly through your QR codes.', action: null }
          ],
          default: [
            { icon: 'ðŸš€', title: 'Quick Start Guide', description: 'New here? Let me walk you through the 5 essential setup steps.', action: 'Start Tour' },
            { icon: 'ðŸ’¼', title: 'Getting Started', description: 'Upload your logo, create a QR code, and add your first offering.', action: null }
          ]
        },
        
        quickActions: {
          beach: [
            { icon: 'âš™ï¸', text: 'Configure Settings', desc: '2 min', completed: false, taskKey: 'beachSettingsConfigured', action: () => { document.querySelector('[data-tab="beach"]')?.click(); setTimeout(() => document.getElementById('beachBookingEnabled')?.focus(), 300); } },
            { icon: 'ðŸ—ºï¸', text: 'Design Beach Map', desc: '5 min', completed: false, taskKey: 'beachMapDesigned', action: () => { document.querySelector('.beach-map-design-btn')?.click() || alert('Navigate to Beach Booking Management tab first'); } },
            { icon: 'ðŸŽ¨', text: 'Create Zones', desc: '3 min', completed: false, taskKey: 'zonesCreated', action: () => { alert('Open Beach Map Designer, click "Draw Zone", draw on canvas, name it, and save!'); } }
          ],
          qrcode: [
            { icon: 'ðŸŽ¨', text: 'Design QR Code', desc: '2 min', completed: false, taskKey: 'qrCodeCreated', action: () => document.querySelector('[data-tab="qrcode"]')?.click() },
            { icon: 'ðŸ“¥', text: 'Download QR', desc: '1 min', completed: false, taskKey: 'qrCodeDownloaded', action: () => document.getElementById('downloadCard')?.click() }
          ],
          analytics: [
            { icon: 'ðŸ“Š', text: 'View Beach Analytics', desc: '2 min', completed: false, taskKey: 'viewedAnalytics', action: () => window.location.href = '/admin/beach-analytics' },
            { icon: 'ðŸ“ˆ', text: 'Check Live Occupancy', desc: '1 min', completed: false, taskKey: 'checkedOccupancy', action: () => window.location.href = '/admin/beach-analytics' }
          ],
          settings: [
            { icon: 'ðŸ“¤', text: 'Upload Logo', desc: '1 min', completed: false, taskKey: 'logoUploaded', action: () => document.getElementById('logoUpload')?.click() },
            { icon: 'ðŸŽ¨', text: 'Set Brand Colors', desc: '2 min', completed: false, taskKey: 'colorsSet', action: () => document.querySelector('[data-tab="settings"]')?.click() }
          ],
          default: [
            { icon: 'ðŸ–ï¸', text: 'Setup Beach Booking', desc: '5 min', completed: false, taskKey: 'beachSetup', action: () => document.querySelector('[data-tab="beach"]')?.click() },
            { icon: 'ðŸŽ¨', text: 'Create QR Code', desc: '2 min', completed: false, taskKey: 'qrCodeCreated', action: () => document.querySelector('[data-tab="qrcode"]')?.click() },
            { icon: 'ðŸ“Š', text: 'View Analytics', desc: '2 min', completed: false, taskKey: 'viewedAnalytics', action: () => document.querySelector('[data-tab="analytics"]')?.click() }
          ]
        }
      };
      
      // Get current active tab
      function getCurrentTab() {
        const activeBtn = document.querySelector('.sidebar-btn.tab-active');
        return activeBtn ? activeBtn.getAttribute('data-tab') : 'default';
      }
      
      // Calculate setup progress
      function calculateProgress() {
        const tasks = [
          { key: 'beachSettingsConfigured', check: () => localStorage.getItem('beachSettingsConfigured') },
          { key: 'beachMapDesigned', check: () => localStorage.getItem('beachMapDesigned') },
          { key: 'zonesCreated', check: () => localStorage.getItem('zonesCreated') },
          { key: 'qrCodeCreated', check: () => localStorage.getItem('qrCodeCreated') }
        ];
        
        const completed = tasks.filter(task => task.check()).length;
        return Math.round((completed / tasks.length) * 100);
      }
      
      // Mark task as complete
      window.markTaskComplete = function(taskKey) {
        localStorage.setItem(taskKey, 'true');
        updateAssistantContent();
      };
      
      // Create assistant UI
      function createAssistant() {
        const assistantHTML = \`
          <!-- AI Assistant Floating Button -->
          <div id="aiAssistantBtn" class="fixed bottom-6 right-6 z-50">
            <button onclick="toggleAssistant()" class="relative bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-full w-16 h-16 shadow-2xl transition-all duration-300 flex items-center justify-center group hover:scale-110">
              <i class="fas fa-robot text-2xl"></i>
              <span id="assistantBadge" class="absolute -top-1 -right-1 bg-orange-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold animate-pulse">3</span>
              <div class="absolute -top-12 right-0 bg-gray-900 text-white px-3 py-1 rounded-lg text-sm opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                Need help? Ask me! ðŸ¤–
              </div>
            </button>
          </div>
          
          <!-- AI Assistant Panel -->
          <div id="aiAssistantPanel" class="fixed bottom-24 right-6 w-96 bg-white rounded-2xl shadow-2xl z-50 hidden transform transition-all duration-300 border-2 border-indigo-100" style="max-height: 650px;">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-t-2xl flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                  <i class="fas fa-robot text-blue-600 text-xl"></i>
                </div>
                <div>
                  <h3 class="font-bold text-lg">GuestConnect Assistant</h3>
                  <p class="text-xs text-blue-100">Here to help you succeed! ðŸš€</p>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="toggleChatMode()" id="chatModeBtn" class="hover:bg-white/20 rounded-full p-2 transition" title="Toggle Chat">
                  <i class="fas fa-comments"></i>
                </button>
                <button onclick="toggleAssistant()" class="hover:bg-white/20 rounded-full p-2 transition">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-semibold text-gray-700">Setup Progress</span>
                <span id="progressPercent" class="text-sm font-bold text-indigo-600">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="bg-gradient-to-r from-blue-600 to-indigo-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
            
            <!-- Tasks & Chat Content -->
            <div id="assistantTasksMode" class="overflow-y-auto" style="max-height: 470px;">
              <!-- Quick Actions -->
              <div class="p-4 border-b">
                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                  <i class="fas fa-bolt text-yellow-500"></i>
                  Quick Actions
                </h4>
                <div id="quickActionsContainer" class="space-y-2">
                  <!-- Dynamic quick actions -->
                </div>
              </div>
              
              <!-- Tips & Guidance -->
              <div class="p-4">
                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                  <i class="fas fa-lightbulb text-yellow-500"></i>
                  Tips for This Page
                </h4>
                <div id="tipsContainer" class="space-y-3">
                  <!-- Dynamic tips -->
                </div>
              </div>
            </div>
            
            <!-- Chat Mode -->
            <div id="assistantChatMode" class="hidden flex flex-col" style="height: 470px;">
              <!-- Chat Messages -->
              <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="flex gap-2">
                  <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-blue-600"></i>
                  </div>
                  <div class="bg-blue-50 rounded-lg p-3 max-w-[80%]">
                    <p class="text-sm text-gray-800">Hi! I am your GuestConnect Assistant. Ask me anything about managing your hotel dashboard, configuring beach bookings, analytics, or any feature!</p>
                  </div>
                </div>
              </div>
              
              <!-- Chat Input -->
              <div class="p-4 border-t bg-gray-50">
                <div class="flex gap-2">
                  <input type="text" id="chatInput" placeholder="Ask me anything..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onkeypress="if(event.key==='Enter') sendChatMessage()">
                  <button onclick="sendChatMessage()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
                <div class="mt-2 flex flex-wrap gap-2">
                  <button onclick="sendQuickQuestion('How do I change beach settings?')" class="text-xs px-2 py-1 bg-white border border-gray-300 rounded-full hover:bg-gray-50 transition">
                    Beach settings
                  </button>
                  <button onclick="sendQuickQuestion('Show me analytics')" class="text-xs px-2 py-1 bg-white border border-gray-300 rounded-full hover:bg-gray-50 transition">
                    Analytics
                  </button>
                  <button onclick="sendQuickQuestion('How to customize QR code?')" class="text-xs px-2 py-1 bg-white border border-gray-300 rounded-full hover:bg-gray-50 transition">
                    QR codes
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Welcome Modal (First-Time Users) -->
          <div id="welcomeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-2xl w-full p-8 transform transition-all">
              <div class="text-center">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                  <i class="fas fa-robot text-white text-3xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Welcome to GuestConnect! ðŸŽ‰</h2>
                <p class="text-gray-600 mb-6">I'm your AI assistant, here to help you get started in just 5 minutes.</p>
                
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-6">
                  <h3 class="font-bold text-lg mb-4">Quick Start Checklist:</h3>
                  <div class="space-y-3 text-left">
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                      <span>Upload your hotel logo (1 min)</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">2</div>
                      <span>Design your first QR code (2 min)</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">3</div>
                      <span>Add a restaurant or activity (3 min)</span>
                    </div>
                  </div>
                </div>
                
                <div class="flex gap-3 justify-center">
                  <button onclick="startTour()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-semibold hover:shadow-lg transition">
                    <i class="fas fa-play mr-2"></i>Start Quick Tour
                  </button>
                  <button onclick="dismissWelcome()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition">
                    Skip for Now
                  </button>
                </div>
              </div>
            </div>
          </div>
        \`;
        
        document.body.insertAdjacentHTML('beforeend', assistantHTML);
        
        // Show welcome modal for first-time users
        if (!localStorage.getItem('welcomeShown')) {
          setTimeout(() => {
            document.getElementById('welcomeModal').classList.remove('hidden');
          }, 1000);
        }
        
        updateAssistantContent();
      }
      
      // Toggle assistant panel
      window.toggleAssistant = function() {
        const panel = document.getElementById('aiAssistantPanel');
        if (panel.classList.contains('hidden')) {
          panel.classList.remove('hidden');
          setTimeout(() => panel.classList.add('scale-100'), 10);
          updateAssistantContent();
        } else {
          panel.classList.add('hidden');
        }
      };
      
      // Update assistant content based on current page
      function updateAssistantContent() {
        const currentTab = getCurrentTab();
        const tips = assistantConfig.tips[currentTab] || assistantConfig.tips.default;
        const actions = assistantConfig.quickActions[currentTab] || assistantConfig.quickActions.default;
        
        // Update tips
        const tipsContainer = document.getElementById('tipsContainer');
        if (tipsContainer) {
          tipsContainer.innerHTML = tips.map(tip => \`
            <div class="bg-white border border-gray-200 rounded-lg p-3 hover:shadow-md transition">
              <div class="flex items-start gap-3">
                <span class="text-2xl">\${tip.icon}</span>
                <div class="flex-1">
                  <h5 class="font-semibold text-sm text-gray-900 mb-1">\${tip.title}</h5>
                  <p class="text-xs text-gray-600">\${tip.description}</p>
                  \${tip.action ? \`<button class="mt-2 text-xs text-blue-600 hover:text-blue-700 font-semibold">\${tip.action} â†’</button>\` : ''}
                </div>
              </div>
            </div>
          \`).join('');
        }
        
        // Update quick actions
        const actionsContainer = document.getElementById('quickActionsContainer');
        if (actionsContainer) {
          actionsContainer.innerHTML = actions.map((action, idx) => {
            const isCompleted = action.taskKey && localStorage.getItem(action.taskKey);
            const completedClass = isCompleted ? 'bg-green-50 border-green-200' : 'bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200';
            const completedIcon = isCompleted ? '<i class="fas fa-check-circle text-green-600"></i>' : '<i class="fas fa-arrow-right text-blue-600"></i>';
            const completedBadge = isCompleted ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full ml-2">âœ“ Done</span>' : '';
            
            return '<button onclick="quickAction(' + idx + ', &quot;' + currentTab + '&quot;)" class="w-full flex items-center gap-3 p-3 ' + completedClass + ' rounded-lg hover:shadow-md transition border">' +
              '<span class="text-2xl">' + action.icon + '</span>' +
              '<div class="flex-1 text-left">' +
                '<div class="font-semibold text-sm flex items-center">' +
                  action.text +
                  completedBadge +
                '</div>' +
                '<div class="text-xs text-gray-600">' + action.desc + '</div>' +
              '</div>' +
              completedIcon +
            '</button>';
          }).join('');
        }
        
        // Update progress
        const progress = calculateProgress();
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        if (progressBar && progressPercent) {
          progressBar.style.width = progress + '%';
          progressPercent.textContent = progress + '%';
        }
        
        // Update badge
        const badge = document.getElementById('assistantBadge');
        if (badge && progress < 100) {
          badge.textContent = tips.length;
        } else if (badge) {
          badge.style.display = 'none';
        }
      }
      
      // Quick action handler
      window.quickAction = function(idx, tab) {
        const actions = assistantConfig.quickActions[tab] || assistantConfig.quickActions.default;
        if (actions[idx] && actions[idx].action) {
          actions[idx].action();
          
          // Mark task as complete after action
          if (actions[idx].taskKey) {
            setTimeout(() => {
              const confirmed = confirm('Did you complete this task?\\n\\nClick OK to mark it as complete and update your progress.');
              if (confirmed) {
                localStorage.setItem(actions[idx].taskKey, 'true');
                updateAssistantContent();
              }
            }, 2000);
          }
        }
      };
      
      // Welcome modal actions
      window.dismissWelcome = function() {
        document.getElementById('welcomeModal').classList.add('hidden');
        localStorage.setItem('welcomeShown', 'true');
      };
      
      window.startTour = function() {
        dismissWelcome();
        toggleAssistant();
        // Could integrate with intro.js or driver.js here
        alert('ðŸŽ‰ Tour feature coming soon! For now, explore the assistant panel for tips.');
      };
      
      window.showTutorialModal = function() {
        alert('ðŸ“¹ Video tutorials coming soon! Check back later.');
      };
      
      window.showDocumentation = function() {
        alert('ðŸ“– Documentation portal coming soon!');
      };
      
      // Toggle between tasks and chat mode
      window.toggleChatMode = function() {
        const tasksMode = document.getElementById('assistantTasksMode');
        const chatMode = document.getElementById('assistantChatMode');
        const chatBtn = document.getElementById('chatModeBtn');
        
        if (chatMode.classList.contains('hidden')) {
          tasksMode.classList.add('hidden');
          chatMode.classList.remove('hidden');
          chatBtn.innerHTML = '<i class="fas fa-list"></i>';
          chatBtn.title = 'Show Tasks';
        } else {
          chatMode.classList.add('hidden');
          tasksMode.classList.remove('hidden');
          chatBtn.innerHTML = '<i class="fas fa-comments"></i>';
          chatBtn.title = 'Toggle Chat';
        }
      };
      
      // System knowledge base for AI assistant
      const systemKnowledge = {
        beachBooking: {
          settings: 'Go to Admin Dashboard â†’ Beach Booking Management tab. Here you can configure opening hours, advance booking days, enable/disable booking, set it as free for guests, and customize the beach card appearance.',
          mapDesigner: 'Click Design Beach Map button in Beach Booking Management. Upload a beach photo, draw zones by clicking Draw Zone, place spots (umbrellas, cabanas, loungers) by selecting from the toolbar, then click Save Beach Layout.',
          zones: 'Zones are colored overlays on the beach map. In Beach Map Designer, click Draw Zone, draw on the canvas, name it, and save. Guests will see these zones with a legend.',
          spots: 'Add spots by selecting umbrella/cabana/lounger/daybed icons in Beach Map Designer. Click the canvas to place them. Edit details like spot number, capacity, price, and premium status in the right panel.',
          qrCode: 'Beach bookings automatically generate QR codes with 6-digit booking codes. Staff can scan these at /staff/beach-check-in.',
          analytics: 'Visit /admin/beach-analytics for comprehensive analytics including live occupancy by zone, peak hours heatmaps, revenue by zone, no-show tracking, and AI recommendations.',
          importantInfo: 'Go to Beach Booking Management â†’ scroll to Important Information section (blue gradient card). Edit the text (one line = one bullet point) and click Save. This appears on guest confirmation pages.'
        },
        qrCodes: {
          create: 'Navigate to QR Codes tab â†’ click Create New QR Code â†’ enter destination URL â†’ customize design with logo, colors, and frame â†’ download as PNG or SVG.',
          customize: 'In QR Code designer, upload your logo, select foreground/background colors, choose frame style, and adjust corner style for a branded QR code.',
          download: 'After designing, click the download button to get your QR code as PNG (print quality) or SVG (vector format for scaling).'
        },
        analytics: {
          view: 'Click Analytics tab in the sidebar. You will see guest engagement metrics, QR code scans, popular services, and trends over time.',
          export: 'In Analytics tab, click Export Data button to download CSV reports of your metrics.',
          beach: 'For beach-specific analytics, visit Beach Booking Management â†’ click Open Dashboard in the Analytics card, or go directly to /admin/beach-analytics.'
        },
        settings: {
          logo: 'Go to Settings tab â†’ Hotel Information section â†’ click Upload Logo â†’ select your image file. Your logo appears throughout the platform.',
          colors: 'In Settings â†’ Branding section, use color pickers to set primary and secondary brand colors that apply to guest-facing pages.',
          profile: 'Complete your hotel profile in Settings â†’ Hotel Information. Add name, address, phone, email, and website for a professional appearance.'
        },
        restaurants: {
          add: 'Go to Offerings tab â†’ click Add New Offering â†’ select Restaurant â†’ fill in name, description, upload photos, add menu, set operating hours.',
          floorPlan: 'In restaurant edit page, click Floor Plan Designer â†’ upload restaurant layout image â†’ place table markers â†’ save. Guests can select preferred tables.'
        },
        staff: {
          checkIn: 'Staff can check in guests at /staff/beach-check-in. Scan the QR code or manually enter the 6-digit booking code. System validates and marks guest as checked in.',
          management: 'View all bookings in Beach Booking Management â†’ Todays Bookings section. See guest details, spot assignments, and check-in status.'
        }
      };
      
      // AI Chat Response Generator
      function generateChatResponse(userMessage) {
        const msg = userMessage.toLowerCase();
        
        // Beach-related queries
        if (msg.includes('beach') && (msg.includes('setting') || msg.includes('config'))) {
          return { text: systemKnowledge.beachBooking.settings, action: () => document.querySelector('[data-tab="beach"]')?.click() };
        }
        if (msg.includes('zone') || msg.includes('overlay')) {
          return { text: systemKnowledge.beachBooking.zones, action: () => document.querySelector('[data-tab="beach"]')?.click() };
        }
        if (msg.includes('map') && msg.includes('design')) {
          return { text: systemKnowledge.beachBooking.mapDesigner, action: null };
        }
        if (msg.includes('spot') && msg.includes('add')) {
          return { text: systemKnowledge.beachBooking.spots, action: null };
        }
        if (msg.includes('important') && msg.includes('info')) {
          return { text: systemKnowledge.beachBooking.importantInfo, action: () => document.querySelector('[data-tab="beach"]')?.click() };
        }
        
        // Analytics queries
        if (msg.includes('analytic') || msg.includes('report')) {
          if (msg.includes('beach')) {
            return { text: systemKnowledge.analytics.beach, action: () => window.location.href = '/admin/beach-analytics' };
          }
          return { text: systemKnowledge.analytics.view, action: () => document.querySelector('[data-tab="analytics"]')?.click() };
        }
        
        // QR Code queries
        if (msg.includes('qr') && (msg.includes('create') || msg.includes('make') || msg.includes('design'))) {
          return { text: systemKnowledge.qrCodes.create, action: () => document.querySelector('[data-tab="qrcode"]')?.click() };
        }
        if (msg.includes('qr') && msg.includes('custom')) {
          return { text: systemKnowledge.qrCodes.customize, action: () => document.querySelector('[data-tab="qrcode"]')?.click() };
        }
        
        // Settings queries
        if (msg.includes('logo') && msg.includes('upload')) {
          return { text: systemKnowledge.settings.logo, action: () => document.querySelector('[data-tab="settings"]')?.click() };
        }
        if (msg.includes('color') || msg.includes('brand')) {
          return { text: systemKnowledge.settings.colors, action: () => document.querySelector('[data-tab="settings"]')?.click() };
        }
        
        // Restaurant queries
        if (msg.includes('restaurant') && msg.includes('add')) {
          return { text: systemKnowledge.restaurants.add, action: () => document.querySelector('[data-tab="offerings"]')?.click() };
        }
        if (msg.includes('floor') || msg.includes('table')) {
          return { text: systemKnowledge.restaurants.floorPlan, action: null };
        }
        
        // Staff queries
        if (msg.includes('check') && msg.includes('in')) {
          return { text: systemKnowledge.staff.checkIn, action: () => window.open('/staff/beach-check-in', '_blank') };
        }
        
        // General help
        if (msg.includes('help') || msg.includes('how')) {
          return { text: 'I can help you with:\\n\\n- Beach booking settings and configuration\\n- Analytics and reports\\n- QR code design\\n- Settings and branding\\n- Restaurant management\\n- Staff check-in\\n\\nWhat would you like to know more about?', action: null };
        }
        
        // Default response
        return { text: 'I am here to help! Try asking me about:\\n- How do I change beach settings?\\n- Show me analytics\\n- How to create a QR code?\\n- How to add zones?\\n- How to check in guests?\\n\\nOr tell me what you are trying to accomplish!', action: null };
      }
      
      // Send chat message
      window.sendChatMessage = async function() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;
        
        // Add user message
        const chatMessages = document.getElementById('chatMessages');
        const userMessageHTML = '<div class="flex gap-2 justify-end">' +
          '<div class="bg-indigo-600 text-white rounded-lg p-3 max-w-[80%]">' +
            '<p class="text-sm">' + message + '</p>' +
          '</div>' +
          '<div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0">' +
            '<i class="fas fa-user text-indigo-600"></i>' +
          '</div>' +
        '</div>';
        chatMessages.innerHTML += userMessageHTML;
        
        input.value = '';
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Show typing indicator
        const typingHTML = '<div class="flex gap-2" id="typingIndicator">' +
          '<div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">' +
            '<i class="fas fa-robot text-blue-600"></i>' +
          '</div>' +
          '<div class="bg-blue-50 rounded-lg p-3">' +
            '<div class="flex gap-1">' +
              '<div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>' +
              '<div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>' +
              '<div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>' +
            '</div>' +
          '</div>' +
        '</div>';
        chatMessages.innerHTML += typingHTML;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Call AI API
        try {
          const response = await fetch('/api/admin/assistant/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message })
          });
          
          const data = await response.json();
          
          // Remove typing indicator
          const typingIndicator = document.getElementById('typingIndicator');
          if (typingIndicator) typingIndicator.remove();
          
          // Add AI response
          const aiText = data.response || 'I apologize, but I could not process your request. Please try again.';
          const aiMessageHTML = '<div class="flex gap-2">' +
            '<div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">' +
              '<i class="fas fa-robot text-blue-600"></i>' +
            '</div>' +
            '<div class="bg-blue-50 rounded-lg p-3 max-w-[80%]">' +
              '<p class="text-sm text-gray-800 whitespace-pre-line">' + aiText + '</p>' +
            '</div>' +
          '</div>';
          chatMessages.innerHTML += aiMessageHTML;
          chatMessages.scrollTop = chatMessages.scrollHeight;
          
        } catch (error) {
          console.error('Chat error:', error);
          
          // Remove typing indicator
          const typingIndicator = document.getElementById('typingIndicator');
          if (typingIndicator) typingIndicator.remove();
          
          // Show error message
          const errorHTML = '<div class="flex gap-2">' +
            '<div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">' +
              '<i class="fas fa-exclamation-triangle text-red-600"></i>' +
            '</div>' +
            '<div class="bg-red-50 rounded-lg p-3 max-w-[80%]">' +
              '<p class="text-sm text-red-800">Sorry, I encountered an error. Please try again or contact support.</p>' +
            '</div>' +
          '</div>';
          chatMessages.innerHTML += errorHTML;
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      };
      
      // Execute chat action
      window.executeChatAction = function() {
        if (window.currentChatAction) {
          window.currentChatAction();
        }
      };
      
      // Quick question buttons
      window.sendQuickQuestion = function(question) {
        document.getElementById('chatInput').value = question;
        sendChatMessage();
      };
      
      // Update assistant when tab changes
      document.addEventListener('click', function(e) {
        if (e.target.closest('.sidebar-btn')) {
          setTimeout(updateAssistantContent, 100);
        }
      });
      
      // Initialize assistant
      setTimeout(createAssistant, 1000);
      
      // ========== END AI ASSISTANT SYSTEM ==========
      
      // ========== DOCUMENTATION & FAQ FUNCTIONS ==========
      
      // Scroll to documentation section
      window.scrollToDocSection = function(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      };
      
      // Toggle FAQ answer
      window.toggleFAQ = function(button) {
        const answer = button.nextElementSibling;
        const icon = button.querySelector('.fa-chevron-down');
        
        if (answer.classList.contains('hidden')) {
          answer.classList.remove('hidden');
          icon.style.transform = 'rotate(180deg)';
          button.parentElement.classList.add('ring-2', 'ring-blue-500');
        } else {
          answer.classList.add('hidden');
          icon.style.transform = 'rotate(0deg)';
          button.parentElement.classList.remove('ring-2', 'ring-blue-500');
        }
      };
      
      // Search FAQs
      window.searchFAQs = function() {
        const searchInput = document.getElementById('faqSearch');
        const searchTerm = searchInput.value.toLowerCase();
        const faqItems = document.querySelectorAll('.faq-item');
        const categories = document.querySelectorAll('.faq-category');
        
        if (searchTerm === '') {
          // Show all if search is empty
          faqItems.forEach(item => item.style.display = 'block');
          categories.forEach(cat => cat.style.display = 'block');
          return;
        }
        
        let visibleCategoryCounts = {};
        
        faqItems.forEach(item => {
          const question = item.querySelector('h3').textContent.toLowerCase();
          const answer = item.querySelector('.faq-answer').textContent.toLowerCase();
          const keywords = item.dataset.keywords ? item.dataset.keywords.toLowerCase() : '';
          const category = item.closest('.faq-category').dataset.category;
          
          const matches = question.includes(searchTerm) || 
                         answer.includes(searchTerm) || 
                         keywords.includes(searchTerm);
          
          if (matches) {
            item.style.display = 'block';
            visibleCategoryCounts[category] = (visibleCategoryCounts[category] || 0) + 1;
          } else {
            item.style.display = 'none';
          }
        });
        
        // Hide categories with no visible items
        categories.forEach(cat => {
          const category = cat.dataset.category;
          if (visibleCategoryCounts[category]) {
            cat.style.display = 'block';
          } else {
            cat.style.display = 'none';
          }
        });
      };
      
      // Play tutorial (placeholder)
      window.playTutorial = function(tutorialId) {
        alert('ðŸŽ¥ Video tutorial "' + tutorialId + '" coming soon!\\n\\nWe\\'re currently recording comprehensive video walkthroughs for all features.\\n\\nIn the meantime, check out the Documentation tab for detailed written guides.');
      };
      
      // Switch to specific tab
      window.switchToTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(tabName + 'Tab').classList.remove('hidden');
        
        document.querySelectorAll('.sidebar-btn').forEach(btn => {
          btn.classList.remove('tab-active');
          if (btn.dataset.tab === tabName) {
            btn.classList.add('tab-active');
          }
        });
      };
      
      // ========== END DOCUMENTATION & FAQ FUNCTIONS ==========
    </script>
</body>
</html>
  `)
})

// ============================================
// DEFAULT ROUTE - Guest Landing Page
// ============================================

// Property-specific homepage
app.get('/:property_slug?', async (c) => {
  const { DB } = c.env
  const property_slug = c.req.param('property_slug') || 'paradise-resort'
  
  try {
    const property = await DB.prepare(`
      SELECT * FROM properties WHERE slug = ? AND status = 'active'
    `).bind(property_slug).first()
    
    if (!property) {
      return c.html('<html><body><h1>Property not found</h1><p>Please check the URL or visit <a href="/">homepage</a></p></body></html>', 404)
    }
    
    const primaryColor = property.primary_color || '#0EA5E9'
    const secondaryColor = property.secondary_color || '#10B981'
    
    return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${property.name} - Activity Booking</title>
        <meta name="description" content="Book amazing resort activities instantly">
        <link rel="manifest" href="/static/manifest.json">
        <meta name="theme-color" content="${primaryColor}">
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          body { font-family: 'Inter', system-ui, sans-serif; }
          .gradient-bg { background: linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen">
            <!-- Hero Section -->
            <div class="gradient-bg text-white py-20 px-4">
                <div class="max-w-4xl mx-auto text-center">
                    <i class="fas fa-umbrella-beach text-6xl mb-6"></i>
                    <h1 class="text-5xl font-bold mb-4">${property.name}</h1>
                    <p class="text-xl mb-8">Discover & Book Amazing Activities</p>
                    <div class="bg-white/20 backdrop-blur-sm rounded-lg p-6 max-w-md mx-auto">
                        <i class="fas fa-qrcode text-4xl mb-4"></i>
                        <p class="text-lg mb-2">Scan the QR code in your room</p>
                        <div class="mt-4 space-y-2">
                            <a href="/browse?property=${property.property_id}" class="block bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100">Browse All Activities</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Features Section -->
            <div class="max-w-6xl mx-auto py-16 px-4">
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="text-center p-6">
                        <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-water text-blue-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Water Sports</h3>
                        <p class="text-gray-600">Diving, snorkeling, and more aquatic adventures</p>
                    </div>
                    <div class="text-center p-6">
                        <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-spa text-green-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Spa & Wellness</h3>
                        <p class="text-gray-600">Relax with massages and beauty treatments</p>
                    </div>
                    <div class="text-center p-6">
                        <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-binoculars text-yellow-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Desert Safari</h3>
                        <p class="text-gray-600">Explore the desert with thrilling adventures</p>
                    </div>
                </div>
            </div>

            <!-- How It Works -->
            <div class="bg-white py-16 px-4">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-12">How It Works</h2>
                    <div class="space-y-8">
                        <div class="flex items-start gap-4">
                            <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 font-bold">1</div>
                            <div>
                                <h3 class="text-xl font-bold mb-2">Scan QR Code</h3>
                                <p class="text-gray-600">Use your phone camera to scan the QR code in your room</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 font-bold">2</div>
                            <div>
                                <h3 class="text-xl font-bold mb-2">Browse Activities</h3>
                                <p class="text-gray-600">Explore diving, spa, safari, and dining options</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 font-bold">3</div>
                            <div>
                                <h3 class="text-xl font-bold mb-2">Book Instantly</h3>
                                <p class="text-gray-600">Choose date & time, pay online or at venue, get instant confirmation</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 font-bold">4</div>
                            <div>
                                <h3 class="text-xl font-bold mb-2">Enjoy!</h3>
                                <p class="text-gray-600">Show your confirmation and have an amazing experience</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="bg-gray-800 text-white py-8 px-4">
                <div class="max-w-4xl mx-auto text-center">
                    <p class="mb-3">Â© 2025 ${property.name}. All rights reserved.</p>
                    <div class="mb-3 flex justify-center gap-4">
                        <a href="/vendor/login" class="text-sm text-blue-400 hover:text-blue-300"><i class="fas fa-store mr-1"></i>Vendor Login</a>
                        <a href="/admin/login" class="text-sm text-blue-400 hover:text-blue-300"><i class="fas fa-shield-alt mr-1"></i>Admin Login</a>
                    </div>
                    <p class="text-sm text-gray-400">
                        <a href="#" class="hover:text-white">Privacy Policy</a> | 
                        <a href="#" class="hover:text-white">Terms of Service</a> | 
                        <a href="mailto:info@paradiseresort.com" class="hover:text-white">Contact Us</a>
                    </p>
                </div>
            </footer>
        </div>
    </body>
    </html>
  `)
  } catch (error) {
    console.error('Homepage error:', error)
    return c.html('<html><body><h1>Error</h1><p>Failed to load homepage</p></body></html>', 500)
  }
})

// Restaurant Table Management Page
// ============================================
// GUEST RESTAURANT BOOKING PAGE
// ============================================

app.get('/hotel/:slug/restaurant/:offering_id/book', async (c) => {
  const { DB } = c.env
  const { slug, offering_id } = c.req.param()
  
  try {
    // Get property details
    const property = await DB.prepare(`
      SELECT * FROM properties WHERE slug = ?
    `).bind(slug).first()
    
    if (!property) {
      return c.text('Property not found', 404)
    }
    
    // Get restaurant details
    const restaurant = await DB.prepare(`
      SELECT * FROM hotel_offerings WHERE offering_id = ?
    `).bind(offering_id).first()
    
    if (!restaurant) {
      return c.text('Restaurant not found', 404)
    }
    
    return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Table - ${restaurant.title_en}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      .table-item {
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid #D1D5DB;
      }
      .table-item:hover {
        border-color: #3B82F6;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      .table-item.selected {
        border-color: #10B981;
        border-width: 3px;
        background: #D1FAE5 !important;
      }
      .table-item.reserved {
        background: #FEE2E2 !important;
        border-color: #DC2626;
        opacity: 0.6;
        cursor: not-allowed;
      }
      /* Table shapes */
      .table-rectangle {
        border-radius: 8px;
      }
      .table-circle {
        border-radius: 50%;
      }
      .table-square {
        border-radius: 4px;
      }
      .table-item-mobile {
        cursor: pointer;
        transition: all 0.3s;
      }
      .table-item-mobile:hover:not(.reserved) {
        border-color: #3B82F6 !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      .table-item-mobile.selected {
        border-color: #10B981 !important;
        border-width: 3px !important;
        background: #D1FAE5 !important;
      }
      .time-slot {
        cursor: pointer;
        transition: all 0.2s;
      }
      .time-slot:hover:not(.disabled) {
        background: #DBEAFE !important;
        transform: scale(1.02);
      }
      .time-slot.selected {
        background: #3B82F6 !important;
        color: white !important;
        font-weight: bold;
      }
      .time-slot.disabled {
        background: #F3F4F6 !important;
        color: #9CA3AF !important;
        cursor: not-allowed;
        opacity: 0.5;
      }
      .step-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #E5E7EB;
        color: #6B7280;
        font-weight: bold;
      }
      .step-indicator.active {
        background: #3B82F6;
        color: white;
      }
      .step-indicator.completed {
        background: #10B981;
        color: white;
      }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-6 px-4 shadow-lg">
        <div class="max-w-6xl mx-auto">
            <a href="/hotel/${slug}" class="inline-block mb-4 text-white/80 hover:text-white">
                <i class="fas fa-arrow-left mr-2"></i>Back to Hotel
            </a>
            <h1 class="text-3xl font-bold">${restaurant.title_en}</h1>
            <p class="text-white/90 mt-2">${restaurant.short_description_en || 'Reserve your table'}</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Progress Steps -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between max-w-2xl mx-auto">
                <div class="flex flex-col items-center">
                    <div class="step-indicator active" id="step1-indicator">1</div>
                    <span class="text-xs mt-2 font-semibold">Date & Guests</span>
                </div>
                <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator" id="step2-indicator">2</div>
                    <span class="text-xs mt-2">Time Slot</span>
                </div>
                <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator" id="step3-indicator">3</div>
                    <span class="text-xs mt-2">Select Table</span>
                </div>
                <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator" id="step4-indicator">4</div>
                    <span class="text-xs mt-2">Confirm</span>
                </div>
            </div>
        </div>

        <!-- Step 1: Date & Number of Guests -->
        <div id="step1" class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>
                Select Date & Number of Guests
            </h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold mb-2">Date</label>
                    <input type="date" id="reservationDate" 
                           class="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                           min="${new Date().toISOString().split('T')[0]}">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Number of Guests</label>
                    <select id="numGuests" class="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        <option value="">Select...</option>
                        <option value="1">1 Guest</option>
                        <option value="2">2 Guests</option>
                        <option value="3">3 Guests</option>
                        <option value="4">4 Guests</option>
                        <option value="5">5 Guests</option>
                        <option value="6">6 Guests</option>
                        <option value="7">7 Guests</option>
                        <option value="8">8 Guests</option>
                    </select>
                </div>
            </div>
            
            <button onclick="goToStep2()" class="mt-6 w-full md:w-auto px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                Continue to Time Selection
                <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>

        <!-- Step 2: Time Slot Selection -->
        <div id="step2" class="bg-white rounded-lg shadow-lg p-8 hidden">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-clock mr-2 text-blue-600"></i>
                Select Time Slot
            </h2>
            
            <div id="timeSlotsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <!-- Time slots loaded dynamically -->
            </div>
            
            <div class="flex gap-4">
                <button onclick="goToStep1()" class="px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                <button onclick="goToStep3()" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                    Continue to Table Selection
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Step 3: Table Selection -->
        <div id="step3" class="bg-white rounded-lg shadow-lg p-8 hidden">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-chair mr-2 text-blue-600"></i>
                Select Your Table
            </h2>
            
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                <div class="flex items-center gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 border-2 border-gray-400 bg-white"></div>
                        <span>Available</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 border-2 border-red-600 bg-red-100"></div>
                        <span>Reserved</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 border-3 border-green-600 bg-green-100"></div>
                        <span>Your Selection</span>
                    </div>
                </div>
            </div>
            
            <div id="tableCanvas" class="relative bg-gray-100 rounded-lg" style="height: 600px; width: 100%; overflow: auto; -webkit-overflow-scrolling: touch;">
                <!-- Tables loaded dynamically - responsive floor plan view -->
            </div>
            
            <div id="selectedTableInfo" class="mt-4 p-4 bg-green-50 border-2 border-green-200 rounded-lg hidden">
                <h3 class="font-bold text-green-900">Selected Table:</h3>
                <p id="selectedTableDetails" class="text-green-800 mt-1"></p>
            </div>
            
            <div class="flex gap-4 mt-6">
                <button onclick="goToStep2()" class="px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                <button onclick="goToStep4()" id="continueToConfirm" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold" disabled>
                    Continue to Confirmation
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div id="step4" class="bg-white rounded-lg shadow-lg p-8 hidden">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-check-circle mr-2 text-green-600"></i>
                Confirm Your Reservation
            </h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold mb-4 text-lg">Reservation Details</h3>
                    <div class="space-y-3 p-4 bg-gray-50 rounded-lg">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Restaurant:</span>
                            <span class="font-semibold">${restaurant.title_en}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Date:</span>
                            <span class="font-semibold" id="confirmDate"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Time:</span>
                            <span class="font-semibold" id="confirmTime"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Guests:</span>
                            <span class="font-semibold" id="confirmGuests"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Table:</span>
                            <span class="font-semibold" id="confirmTable"></span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-bold mb-4 text-lg">Your Information</h3>
                    <div class="space-y-3">
                        <input type="text" id="guestName" placeholder="Full Name *" required
                               class="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500">
                        <input type="email" id="guestEmail" placeholder="Email *" required
                               class="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500">
                        <input type="tel" id="guestPhone" placeholder="Phone Number *" required
                               class="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500">
                        <input type="text" id="roomNumber" placeholder="Room Number (if hotel guest)"
                               class="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500">
                        <textarea id="specialRequests" placeholder="Special Requests / Dietary Requirements" rows="3"
                                  class="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-6">
                <button onclick="goToStep3()" class="px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                <button onclick="submitReservation()" class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    <i class="fas fa-check mr-2"></i>Confirm Reservation
                </button>
            </div>
        </div>
    </div>

    <script>
      const offeringId = ${offering_id};
      const propertyId = ${property.property_id};
      let selectedDate = '';
      let selectedGuests = 0;
      let selectedSessionId = null;
      let selectedTableId = null;
      let availableTables = [];
      let reservedTables = [];

      // Step navigation
      window.goToStep1 = function() {
        showStep(1);
      }

      window.goToStep2 = function() {
        const date = document.getElementById('reservationDate').value;
        const guests = document.getElementById('numGuests').value;
        
        if (!date || !guests) {
          alert('Please select date and number of guests');
          return;
        }
        
        selectedDate = date;
        selectedGuests = parseInt(guests);
        loadTimeSlotsAndShow();
      }

      async function loadTimeSlotsAndShow() {
        try {
          const response = await fetch('/api/restaurant/' + offeringId + '/sessions?date=' + selectedDate);
          const data = await response.json();
          
          const container = document.getElementById('timeSlotsContainer');
          
          if (data.success && data.sessions && data.sessions.length > 0) {
            container.innerHTML = data.sessions.map(session => {
              const available = session.current_bookings < session.max_capacity;
              const clickHandler = available ? "window.selectTimeSlot(" + session.session_id + ", '" + session.session_time + "')" : '';
              const disabledClass = !available ? 'disabled' : '';
              const fullyBookedMsg = !available ? '<div class="text-xs text-red-600 mt-1">Fully Booked</div>' : '';
              return '<div class="time-slot p-4 border-2 rounded-lg text-center ' + disabledClass + '" onclick="' + clickHandler + '">' +
                '<div class="font-bold">' + session.session_time + '</div>' +
                '<div class="text-xs text-gray-600 mt-1">' + session.session_type + '</div>' +
                fullyBookedMsg +
                '</div>';
            }).join('');
            showStep(2);
          } else {
            alert('No available time slots for this date');
          }
        } catch (error) {
          console.error('Load sessions error:', error);
          alert('Error loading time slots');
        }
      }

      window.selectTimeSlot = function(sessionId, time) {
        selectedSessionId = sessionId;
        document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
        event.target.closest('.time-slot').classList.add('selected');
      }

      window.goToStep3 = async function() {
        if (!selectedSessionId) {
          alert('Please select a time slot');
          return;
        }
        
        await loadTablesAndAvailability();
        showStep(3);
      }

      async function loadTablesAndAvailability() {
        try {
          // Load AI-extracted textures for this restaurant
          let restaurantTextures = null;
          try {
            const textureResponse = await fetch('/api/restaurant/' + offeringId + '/textures');
            const textureData = await textureResponse.json();
            if (textureData.success && textureData.texture && textureData.texture.is_active) {
              restaurantTextures = textureData.texture;
            }
          } catch (err) {
            console.log('No textures available, using defaults');
          }
          
          // Load all tables
          const tablesResponse = await fetch('/api/restaurant/' + offeringId + '/tables');
          const tablesData = await tablesResponse.json();
          availableTables = tablesData.tables || [];
          
          // Load floor elements (buffet, bar, kitchen, etc.)
          let floorElements = [];
          try {
            const elementsResponse = await fetch('/api/admin/restaurant/' + offeringId + '/floor-elements');
            const elementsData = await elementsResponse.json();
            floorElements = elementsData.elements || [];
          } catch (err) {
            console.log('No floor elements available');
          }
          
          // Load walls
          let walls = [];
          try {
            const wallsResponse = await fetch('/api/admin/restaurant/' + offeringId + '/walls');
            const wallsData = await wallsResponse.json();
            walls = wallsData.walls || [];
          } catch (err) {
            console.log('No walls available');
          }
          
          // Load availability for selected session
          const availabilityResponse = await fetch('/api/restaurant/session/' + selectedSessionId + '/availability');
          const availabilityData = await availabilityResponse.json();
          reservedTables = availabilityData.reserved_tables || [];
          
          // Filter tables by capacity
          const suitableTables = availableTables.filter(t => t.capacity >= selectedGuests);
          
          // Render tables - ALWAYS use floor plan view (mobile-first for QR code scanning)
          const canvas = document.getElementById('tableCanvas');
          canvas.innerHTML = '';
          
          // Apply AI-extracted floor texture if available
          if (restaurantTextures) {
            canvas.style.background = restaurantTextures.floor_color_primary || '#F3F4F6';
            canvas.style.backgroundImage = 'linear-gradient(45deg, ' + 
              (restaurantTextures.floor_color_primary || '#F3F4F6') + ' 25%, ' +
              (restaurantTextures.floor_color_secondary || restaurantTextures.floor_color_primary || '#E5E7EB') + ' 25%, ' +
              (restaurantTextures.floor_color_secondary || restaurantTextures.floor_color_primary || '#E5E7EB') + ' 50%, ' +
              (restaurantTextures.floor_color_primary || '#F3F4F6') + ' 50%, ' +
              (restaurantTextures.floor_color_primary || '#F3F4F6') + ' 75%, ' +
              (restaurantTextures.floor_color_secondary || restaurantTextures.floor_color_primary || '#E5E7EB') + ' 75%, ' +
              (restaurantTextures.floor_color_secondary || restaurantTextures.floor_color_primary || '#E5E7EB') + ')';
            canvas.style.backgroundSize = '40px 40px';
            canvas.style.opacity = restaurantTextures.floor_opacity || 0.8;
          }
          
          // Calculate responsive scale based on screen width
          // Mobile: scale down to fit screen, Desktop: use 0.8 scale
          const screenWidth = window.innerWidth;
          const isMobile = screenWidth < 768;
          
          // Find the rightmost table position to calculate required width
          const maxX = Math.max(...availableTables.map(t => t.position_x + t.width));
          const designWidth = maxX + 50; // Add some padding
          
          // Calculate scale factor
          // Mobile: fit within screen width minus padding
          // Desktop: use standard 0.8 scale
          let scaleFactor;
          if (isMobile) {
            const availableWidth = screenWidth - 32; // 16px padding on each side
            scaleFactor = availableWidth / designWidth;
            // Ensure minimum readable size but not too large
            scaleFactor = Math.min(scaleFactor, 0.6);
            scaleFactor = Math.max(scaleFactor, 0.3);
          } else {
            scaleFactor = 0.8;
          }
          
          // Calculate canvas height based on tallest table position
          const maxY = Math.max(...availableTables.map(t => t.position_y + t.height));
          const canvasHeight = (maxY + 50) * scaleFactor;
          
          canvas.style.height = canvasHeight + 'px';
          canvas.style.display = 'block';
          canvas.style.position = 'relative';
          canvas.style.overflow = 'auto';
          canvas.style.touchAction = 'pan-y pinch-zoom'; // Allow pinch-to-zoom on mobile
          
          // Render walls first (behind everything)
          walls.forEach(wall => {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.style.position = 'absolute';
            svg.style.pointerEvents = 'none';
            svg.style.zIndex = '0';
            
            const scaledStartX = wall.start_x * scaleFactor;
            const scaledStartY = wall.start_y * scaleFactor;
            const scaledEndX = wall.end_x * scaleFactor;
            const scaledEndY = wall.end_y * scaleFactor;
            
            const minX = Math.min(scaledStartX, scaledEndX);
            const minY = Math.min(scaledStartY, scaledEndY);
            const width = Math.abs(scaledEndX - scaledStartX);
            const height = Math.abs(scaledEndY - scaledStartY);
            
            svg.style.left = minX + 'px';
            svg.style.top = minY + 'px';
            svg.style.width = (width + 10) + 'px';
            svg.style.height = (height + 10) + 'px';
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', scaledStartX - minX);
            line.setAttribute('y1', scaledStartY - minY);
            line.setAttribute('x2', scaledEndX - minX);
            line.setAttribute('y2', scaledEndY - minY);
            line.setAttribute('stroke', wall.color || '#64748B');
            line.setAttribute('stroke-width', (wall.thickness || 4) * scaleFactor);
            
            if (wall.style === 'dashed') {
              line.setAttribute('stroke-dasharray', '10,5');
            } else if (wall.style === 'door') {
              line.setAttribute('stroke-dasharray', '20,10');
            } else if (wall.style === 'window') {
              line.setAttribute('stroke-dasharray', '5,5');
            }
            
            svg.appendChild(line);
            canvas.appendChild(svg);
          });
          
          // Render floor elements (buffet, bar, kitchen, etc.)
          floorElements.forEach(element => {
            const div = document.createElement('div');
            div.style.position = 'absolute';
            div.style.left = (element.position_x * scaleFactor) + 'px';
            div.style.top = (element.position_y * scaleFactor) + 'px';
            div.style.width = (element.width * scaleFactor) + 'px';
            div.style.height = (element.height * scaleFactor) + 'px';
            div.style.background = element.color || '#94A3B8';
            div.style.border = '2px solid ' + (element.border_color || '#64748B');
            div.style.borderRadius = '8px';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'center';
            div.style.fontSize = (isMobile ? '10px' : '12px');
            div.style.fontWeight = 'bold';
            div.style.color = '#1F2937';
            div.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            div.style.zIndex = '1';
            div.style.pointerEvents = 'none'; // Can't click on floor elements
            
            // Get icon based on element type
            const iconMap = {
              'buffet': 'fas fa-utensils',
              'bar': 'fas fa-wine-glass-alt',
              'kitchen': 'fas fa-fire-burner',
              'entrance': 'fas fa-door-open',
              'restroom': 'fas fa-restroom',
              'stage': 'fas fa-music',
              'plant': 'fas fa-leaf',
              'decoration': 'fas fa-star'
            };
            const icon = iconMap[element.element_type] || 'fas fa-square';
            const fontSize = Math.max(8, 12 * scaleFactor);
            
            div.innerHTML = '<div class="text-center"><i class="' + icon + ' mr-1"></i><br><span style="font-size: ' + (fontSize * 0.8) + 'px;">' + element.element_label + '</span></div>';
            canvas.appendChild(div);
          });
          
          // Render tables (on top of everything)
          suitableTables.forEach(table => {
            const isReserved = reservedTables.includes(table.table_id);
            const tableEl = document.createElement('div');
            tableEl.className = 'table-item table-' + table.shape + (isReserved ? ' reserved' : '');
            tableEl.style.position = 'absolute';
            tableEl.style.left = (table.position_x * scaleFactor) + 'px';
            tableEl.style.top = (table.position_y * scaleFactor) + 'px';
            
            // For circles, ensure width = height (use average for perfect circle)
            // For other shapes, use actual dimensions scaled
            let width = table.width * scaleFactor;
            let height = table.height * scaleFactor;
            
            if (table.shape === 'circle') {
              // Make circles perfect circles by using the larger dimension
              const size = Math.max(width, height);
              width = size;
              height = size;
            }
            
            tableEl.style.width = width + 'px';
            tableEl.style.height = height + 'px';
            
            // Apply AI-extracted table texture if available
            if (restaurantTextures && !isReserved) {
              const tableColor = restaurantTextures.table_color_primary || '#FFFFFF';
              const tableSecondary = restaurantTextures.table_color_secondary || tableColor;
              tableEl.style.background = 'linear-gradient(135deg, ' + tableColor + ' 0%, ' + tableSecondary + ' 100%)';
              tableEl.style.opacity = restaurantTextures.table_opacity || 0.9;
              tableEl.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15), inset 0 1px 3px rgba(255,255,255,0.3)';
            } else {
              tableEl.style.background = 'white';
            }
            
            tableEl.style.display = 'flex';
            tableEl.style.flexDirection = 'column';
            tableEl.style.alignItems = 'center';
            tableEl.style.justifyContent = 'center';
            tableEl.style.fontSize = isMobile ? '11px' : '14px'; // Smaller text on mobile
            // DON'T override borderRadius - let CSS classes handle shape
            
            tableEl.innerHTML = 
              '<div class="font-bold" style="margin-bottom: 2px;">' + table.table_number + '</div>' +
              '<div class="text-gray-600" style="font-size: ' + (isMobile ? '9px' : '11px') + ';"><i class="fas fa-user"></i> ' + table.capacity + '</div>';
            
            if (!isReserved) {
              tableEl.onclick = () => selectTable(table);
            }
            
            canvas.appendChild(tableEl);
          });
        } catch (error) {
          console.error('Load tables error:', error);
          alert('Error loading tables');
        }
      }

      window.selectTable = function(table) {
        selectedTableId = table.table_id;
        document.querySelectorAll('.table-item, .table-item-mobile').forEach(el => el.classList.remove('selected'));
        event.target.closest('.table-item, .table-item-mobile').classList.add('selected');
        
        document.getElementById('selectedTableInfo').classList.remove('hidden');
        document.getElementById('selectedTableDetails').textContent = 
          'Table ' + table.table_number + ' - ' + (table.table_name || '') + ' (Seats ' + table.capacity + ')';
        document.getElementById('continueToConfirm').disabled = false;
      }

      window.goToStep4 = function() {
        if (!selectedTableId) {
          alert('Please select a table');
          return;
        }
        
        // Populate confirmation details
        document.getElementById('confirmDate').textContent = selectedDate;
        document.getElementById('confirmTime').textContent = document.querySelector('.time-slot.selected .font-bold').textContent;
        document.getElementById('confirmGuests').textContent = selectedGuests + ' Guest' + (selectedGuests > 1 ? 's' : '');
        document.getElementById('confirmTable').textContent = document.getElementById('selectedTableDetails').textContent;
        
        showStep(4);
      }

      window.submitReservation = async function() {
        const name = document.getElementById('guestName').value;
        const email = document.getElementById('guestEmail').value;
        const phone = document.getElementById('guestPhone').value;
        
        if (!name || !email || !phone) {
          alert('Please fill in all required fields');
          return;
        }
        
        const roomNumber = document.getElementById('roomNumber').value;
        const specialRequests = document.getElementById('specialRequests').value;
        
        try {
          const response = await fetch('/api/restaurant/reserve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              session_id: selectedSessionId,
              table_id: selectedTableId,
              property_id: propertyId,
              guest_name: name,
              guest_email: email,
              guest_phone: phone,
              room_number: roomNumber,
              num_guests: selectedGuests,
              special_requests: specialRequests,
              reservation_date: selectedDate
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Reservation confirmed! \\n\\nConfirmation details have been sent to your email.');
            window.location.href = '/hotel/${slug}';
          } else {
            alert('âŒ ' + (data.error || 'Failed to create reservation'));
          }
        } catch (error) {
          console.error('Submit reservation error:', error);
          alert('âŒ Error submitting reservation');
        }
      }

      function showStep(stepNum) {
        // Hide all steps
        for (let i = 1; i <= 4; i++) {
          document.getElementById('step' + i).classList.add('hidden');
          const indicator = document.getElementById('step' + i + '-indicator');
          indicator.classList.remove('active', 'completed');
          if (i < stepNum) {
            indicator.classList.add('completed');
          } else if (i === stepNum) {
            indicator.classList.add('active');
          }
        }
        
        // Show current step
        document.getElementById('step' + stepNum).classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    </script>
</body>
</html>
    `)
  } catch (error) {
    console.error('Restaurant booking page error:', error)
    return c.text('Error loading booking page', 500)
  }
})

app.get('/admin/restaurant/:offering_id', (c) => {
  const { offering_id } = c.req.param()
  
  return c.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Table Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      .table-item {
        position: absolute;
        cursor: move;
        border: 2px solid #3B82F6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        user-select: none;
      }
      .table-item:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
      .table-item.selected { border-color: #10B981; border-width: 3px; }
      .table-rectangle { border-radius: 8px; }
      .table-circle { border-radius: 50%; }
      .table-square { border-radius: 8px; }
      #canvas { position: relative; background: #F3F4F6; border: 2px dashed #9CA3AF; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="bg-gradient-to-r from-blue-700 to-indigo-700 text-white py-4 px-4 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-4">
                    <a href="/admin/dashboard" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                    <h1 class="text-2xl font-bold">Restaurant Management</h1>
                </div>
                <span id="restaurantName" class="text-lg"></span>
            </div>
            <!-- Restaurant Selector -->
            <div class="flex items-center gap-2">
                <label class="text-sm font-semibold">Restaurant:</label>
                <select id="restaurantSelectorHeader" onchange="switchRestaurant(this.value)" class="px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-white/40 min-w-64">
                    <option value="${offering_id}">${offering_id}</option>
                </select>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-lg mb-6 p-2 flex gap-2">
            <button onclick="switchTab('tables')" id="tabTables" class="flex-1 px-4 py-3 rounded-lg font-semibold bg-blue-600 text-white">
                <i class="fas fa-chair mr-2"></i>Tables & Floor Plan
            </button>
            <button onclick="switchTab('sessions')" id="tabSessions" class="flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200">
                <i class="fas fa-clock mr-2"></i>Time Slots & Sessions
            </button>
            <button onclick="switchTab('reservations')" id="tabReservations" class="flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200">
                <i class="fas fa-calendar-check mr-2"></i>Reservations
            </button>
            <button onclick="switchTab('textures')" id="tabTextures" class="flex-1 px-4 py-3 rounded-lg font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200">
                <i class="fas fa-image mr-2"></i>AI Textures
            </button>
        </div>

        <!-- TABLES TAB -->
        <div id="tablesSection">
        <div class="grid md:grid-cols-3 gap-6">
            <!-- Left Panel: Table Controls -->
            <div class="space-y-6">
                <!-- Add Table Form -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-plus-circle mr-2 text-blue-600"></i>Add Table</h2>
                    <form id="addTableForm" class="space-y-3">
                        <input type="text" id="tableNumber" placeholder="Table Number (e.g., T1)" required class="w-full px-3 py-2 border rounded-lg text-sm">
                        <input type="text" id="tableName" placeholder="Table Name (optional)" class="w-full px-3 py-2 border rounded-lg text-sm">
                        <input type="number" id="capacity" placeholder="Capacity" required min="1" max="12" class="w-full px-3 py-2 border rounded-lg text-sm">
                        
                        <select id="shape" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="rectangle">Rectangle</option>
                            <option value="circle">Circle</option>
                            <option value="square">Square</option>
                        </select>
                        
                        <select id="tableType" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="standard">Standard</option>
                            <option value="booth">Booth</option>
                            <option value="bar">Bar/High-Top</option>
                            <option value="outdoor">Outdoor</option>
                            <option value="vip">VIP</option>
                        </select>
                        
                        <div class="border rounded-lg p-2 max-h-32 overflow-y-auto">
                            <p class="text-xs font-semibold mb-2">Features:</p>
                            <label class="flex items-center text-sm mb-1"><input type="checkbox" name="features" value="window_view" class="mr-2">Window View</label>
                            <label class="flex items-center text-sm mb-1"><input type="checkbox" name="features" value="beachfront" class="mr-2">Beachfront</label>
                            <label class="flex items-center text-sm mb-1"><input type="checkbox" name="features" value="sunset_view" class="mr-2">Sunset View</label>
                            <label class="flex items-center text-sm mb-1"><input type="checkbox" name="features" value="quiet" class="mr-2">Quiet Section</label>
                            <label class="flex items-center text-sm mb-1"><input type="checkbox" name="features" value="couples" class="mr-2">Couples</label>
                            <label class="flex items-center text-sm mb-1"><input type="checkbox" name="features" value="family_friendly" class="mr-2">Family Friendly</label>
                        </div>
                        
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Add to Floor Plan
                        </button>
                    </form>
                </div>

                <!-- Add Floor Plan Element Form -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-shapes mr-2 text-purple-600"></i>Add Floor Element</h2>
                    <form id="addElementForm" class="space-y-3">
                        <select id="elementType" required class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="">Select Type...</option>
                            <option value="buffet">ðŸ½ï¸ Buffet</option>
                            <option value="bar">ðŸ· Bar</option>
                            <option value="kitchen">ðŸ”¥ Kitchen</option>
                            <option value="entrance">ðŸšª Entrance</option>
                            <option value="exit">â¬…ï¸ Exit</option>
                            <option value="restroom">ðŸš» Restroom</option>
                            <option value="window">ðŸªŸ Window</option>
                            <option value="plant">ðŸŒ¿ Plant</option>
                            <option value="stage">ðŸŽ¤ Stage</option>
                        </select>
                        <input type="text" id="elementLabel" placeholder="Label (e.g., Main Buffet)" required class="w-full px-3 py-2 border rounded-lg text-sm">
                        <input type="number" id="elementWidth" placeholder="Width (px)" value="100" required class="w-full px-3 py-2 border rounded-lg text-sm">
                        <input type="number" id="elementHeight" placeholder="Height (px)" value="80" required class="w-full px-3 py-2 border rounded-lg text-sm">
                        <input type="color" id="elementColor" value="#94A3B8" class="w-full h-10 border rounded-lg">
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                            <i class="fas fa-plus mr-2"></i>Add Element
                        </button>
                    </form>
                </div>

                <!-- Wall Drawing Tool -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-border-all mr-2 text-gray-600"></i>Draw Walls</h2>
                    <p class="text-sm text-gray-600 mb-4">Click two points on the canvas to draw a wall</p>
                    <div class="space-y-3">
                        <select id="wallStyle" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <option value="solid">â¬› Solid Wall</option>
                            <option value="dashed">âšŠ Dashed Line</option>
                            <option value="door">ðŸšª Doorway</option>
                            <option value="window">ðŸªŸ Window Opening</option>
                        </select>
                        <input type="number" id="wallThickness" placeholder="Thickness (px)" value="4" min="1" max="20" class="w-full px-3 py-2 border rounded-lg text-sm">
                        <input type="color" id="wallColor" value="#64748B" class="w-full h-10 border rounded-lg">
                        <button id="startWallDrawing" onclick="toggleWallDrawing()" class="w-full bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-pen mr-2"></i>Start Drawing Walls
                        </button>
                        <div id="wallDrawingHint" class="hidden text-sm text-blue-600 bg-blue-50 p-2 rounded">
                            <i class="fas fa-info-circle mr-1"></i>Click canvas to set start point, then click again for end point
                        </div>
                    </div>
                </div>

                <!-- Selected Table Info -->
                <div id="selectedTableInfo" class="bg-white rounded-lg shadow-lg p-6 hidden">
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-info-circle mr-2 text-green-600"></i>Selected Table</h2>
                    <div id="tableDetails"></div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="deleteSelectedTable()" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">
                            <i class="fas fa-trash mr-2"></i>Delete
                        </button>
                    </div>
                </div>

                <!-- Tables List -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4">All Tables (<span id="tableCount">0</span>)</h2>
                    <div id="tablesList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Center: Floor Plan Canvas -->
            <div class="md:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold"><i class="fas fa-th mr-2 text-purple-600"></i>Floor Plan Designer</h2>
                        <div class="flex gap-2">
                            <button onclick="saveLayout()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-save mr-2"></i>Save Layout
                            </button>
                            <button onclick="clearCanvas()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                <i class="fas fa-eraser mr-2"></i>Clear
                            </button>
                        </div>
                    </div>
                    
                    <!-- Master Scale Control -->
                    <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border-2 border-blue-200">
                        <div class="flex items-center justify-between mb-2">
                            <label class="font-bold text-gray-700">
                                <i class="fas fa-search-plus mr-2 text-blue-600"></i>Master Scale
                            </label>
                            <span id="scaleValue" class="text-lg font-bold text-blue-600">100%</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-gray-500">Small</span>
                            <input type="range" id="masterScale" min="30" max="150" value="100" step="5" 
                                   class="flex-1 h-3 bg-blue-200 rounded-lg appearance-none cursor-pointer"
                                   oninput="updateMasterScale(this.value)">
                            <span class="text-xs text-gray-500">Large</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Scale all tables, elements & walls at once - perfect for fitting more in the space!
                        </p>
                    </div>
                    
                    <div id="canvas" style="width: 100%; height: 600px; overflow: auto;"></div>
                    
                    <div class="mt-4 flex items-center justify-between text-sm text-gray-600">
                        <span><i class="fas fa-chair mr-2"></i>Drag tables to position them</span>
                        <span>Total Capacity: <strong id="totalCapacity">0</strong> seats</span>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- END TABLES TAB -->

        <!-- SESSIONS TAB -->
        <div id="sessionsSection" class="hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Create Session Form -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-plus-circle mr-2 text-green-600"></i>Create Time Slot</h2>
                    <form id="createSessionForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Session Date</label>
                            <input type="date" id="sessionDate" required class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Start Time</label>
                            <input type="time" id="sessionTime" required class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Session Type</label>
                            <select id="sessionType" class="w-full px-3 py-2 border rounded-lg">
                                <option value="breakfast">Breakfast</option>
                                <option value="brunch">Brunch</option>
                                <option value="lunch">Lunch</option>
                                <option value="afternoon_tea">Afternoon Tea</option>
                                <option value="dinner">Dinner</option>
                                <option value="late_night">Late Night</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Duration (minutes)</label>
                            <input type="number" id="sessionDuration" value="90" min="30" max="240" step="15" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Maximum Capacity</label>
                            <input type="number" id="sessionCapacity" value="80" min="1" max="500" class="w-full px-3 py-2 border rounded-lg">
                            <p class="text-xs text-gray-500 mt-1">Total seats available for this time slot</p>
                        </div>
                        
                        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">
                            <i class="fas fa-plus mr-2"></i>Create Time Slot
                        </button>
                    </form>
                </div>
                
                <!-- Sessions List -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Upcoming Time Slots</h2>
                        <input type="date" id="filterSessionDate" class="px-3 py-2 border rounded-lg text-sm" onchange="loadSessions()">
                    </div>
                    <div id="sessionsList" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-clock text-4xl mb-3"></i>
                            <p>No sessions found</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END SESSIONS TAB -->

        <!-- RESERVATIONS TAB -->
        <div id="reservationsSection" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <!-- Filter Controls -->
                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Date</label>
                        <input type="date" id="filterReservationDate" class="w-full px-3 py-2 border rounded-lg" onchange="loadReservations()">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Status</label>
                        <select id="filterStatus" class="w-full px-3 py-2 border rounded-lg" onchange="loadReservations()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="checked_in">Checked In</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Search Guest</label>
                        <input type="text" id="filterGuest" placeholder="Name or email..." class="w-full px-3 py-2 border rounded-lg" oninput="loadReservations()">
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadReservations()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-search mr-2"></i>Search
                        </button>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="text-sm text-blue-600 font-semibold">Total Today</div>
                        <div class="text-2xl font-bold text-blue-700" id="statTotal">0</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="text-sm text-green-600 font-semibold">Confirmed</div>
                        <div class="text-2xl font-bold text-green-700" id="statConfirmed">0</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <div class="text-sm text-yellow-600 font-semibold">Pending</div>
                        <div class="text-2xl font-bold text-yellow-700" id="statPending">0</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="text-sm text-purple-600 font-semibold">Total Guests</div>
                        <div class="text-2xl font-bold text-purple-700" id="statGuests">0</div>
                    </div>
                </div>
                
                <!-- Reservations List -->
                <div class="mb-4">
                    <h2 class="text-xl font-bold">Reservations (<span id="reservationCount">0</span>)</h2>
                </div>
                <div id="reservationsList" class="space-y-4 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-calendar-times text-4xl mb-3"></i>
                        <p>No reservations found</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- END RESERVATIONS TAB -->
        
        <!-- AI TEXTURES TAB -->
        <div id="texturesSection" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">
                    <i class="fas fa-magic mr-2 text-purple-600"></i>
                    AI-Powered Restaurant Textures
                </h2>
                <p class="text-gray-600 mb-6">
                    Upload a photo of your restaurant and let AI extract floor and table textures to create a realistic floor plan for guests!
                </p>
                
                <!-- Current Texture Status -->
                <div id="currentTextureStatus" class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-bold mb-2">Current Status</h3>
                    <div id="textureStatusContent">
                        <p class="text-gray-500">No textures configured yet. Upload a restaurant photo to get started!</p>
                    </div>
                </div>
                
                <!-- Upload Form -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 mb-6 bg-gray-50">
                    <form id="uploadTextureForm">
                        <div class="mb-4">
                            <label class="block font-semibold mb-2">
                                <i class="fas fa-camera mr-2"></i>Upload Restaurant Photo
                            </label>
                            <input type="file" id="restaurantPhoto" accept="image/*" required
                                   class="w-full px-4 py-2 border rounded-lg">
                            <p class="text-sm text-gray-500 mt-2">
                                ðŸ’¡ Best results: Clear photo showing floor and table surfaces
                            </p>
                        </div>
                        
                        <!-- Preview -->
                        <div id="imagePreview" class="mb-4 hidden">
                            <img id="previewImg" class="max-w-full h-64 object-cover rounded-lg border-2 border-gray-300">
                        </div>
                        
                        <button type="submit" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                            <i class="fas fa-robot mr-2"></i>Analyze with AI
                        </button>
                    </form>
                </div>
                
                <!-- AI Analysis Results -->
                <div id="aiAnalysisResults" class="hidden">
                    <h3 class="font-bold text-lg mb-4">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>AI Analysis Complete
                    </h3>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <!-- Floor Texture -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-bold mb-2">
                                <i class="fas fa-layer-group mr-2 text-blue-600"></i>Floor Texture
                            </h4>
                            <div id="floorTexturePreview" class="mb-3">
                                <!-- Will show extracted floor texture -->
                            </div>
                            <p><strong>Type:</strong> <span id="floorType">-</span></p>
                            <p><strong>Primary Color:</strong> <span id="floorColorPrimary">-</span></p>
                            <label class="block mt-2">
                                <span class="text-sm">Opacity:</span>
                                <input type="range" id="floorOpacity" min="0" max="1" step="0.1" value="0.8"
                                       class="w-full">
                                <span class="text-sm text-gray-500" id="floorOpacityValue">80%</span>
                            </label>
                        </div>
                        
                        <!-- Table Texture -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-bold mb-2">
                                <i class="fas fa-chair mr-2 text-green-600"></i>Table Texture
                            </h4>
                            <div id="tableTexturePreview" class="mb-3">
                                <!-- Will show extracted table texture -->
                            </div>
                            <p><strong>Type:</strong> <span id="tableType">-</span></p>
                            <p><strong>Primary Color:</strong> <span id="tableColorPrimary">-</span></p>
                            <label class="block mt-2">
                                <span class="text-sm">Opacity:</span>
                                <input type="range" id="tableOpacity" min="0" max="1" step="0.1" value="0.9"
                                       class="w-full">
                                <span class="text-sm text-gray-500" id="tableOpacityValue">90%</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Confidence Score -->
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm">
                            <strong>AI Confidence:</strong> 
                            <span id="confidenceScore">-</span>%
                            <i class="fas fa-info-circle ml-2 text-blue-600" title="How confident the AI is about the texture extraction"></i>
                        </p>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <button onclick="saveTextures()" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                            <i class="fas fa-save mr-2"></i>Save & Apply Textures
                        </button>
                        <button onclick="loadTextureSettings()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">
                            <i class="fas fa-redo mr-2"></i>Reset
                        </button>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="aiLoadingState" class="hidden text-center py-8">
                    <div class="animate-spin text-4xl text-purple-600 mb-4">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <p class="text-lg font-semibold">AI is analyzing your restaurant photo...</p>
                    <p class="text-sm text-gray-500">This may take a few moments</p>
                </div>
            </div>
        </div>
        <!-- END AI TEXTURES TAB -->
    </div>

    <script>
      const offeringId = '${offering_id}';
      let tables = [];
      let selectedTable = null;
      let floorElements = [];
      let selectedElement = null;
      let isDragging = false;
      let dragOffset = { x: 0, y: 0 };
      let currentTab = 'tables';
      let masterScale = 100; // 100% by default

      async function init() {
        await loadRestaurant();
        await loadTables();
        await loadFloorElements();
        await loadWalls();
      }

      async function loadRestaurant() {
        try {
          const response = await fetch('/api/hotel-offerings/1');
          const data = await response.json();
          const restaurants = data.offerings.filter(o => o.offering_type === 'restaurant');
          const restaurant = restaurants.find(o => o.offering_id == offeringId);
          
          if (restaurant) {
            document.getElementById('restaurantName').textContent = restaurant.title_en || restaurant.title;
            document.title = \`\${restaurant.title_en || restaurant.title} - Restaurant Management\`;
          }
          
          // Populate restaurant selector
          const selector = document.getElementById('restaurantSelectorHeader');
          selector.innerHTML = restaurants.map(r => 
            \`<option value="\${r.offering_id}" \${r.offering_id == offeringId ? 'selected' : ''}>\${r.title_en || r.title}</option>\`
          ).join('');
        } catch (error) {
          console.error('Load restaurant error:', error);
        }
      }
      
      function switchRestaurant(newOfferingId) {
        if (newOfferingId && newOfferingId != offeringId) {
          window.location.href = '/admin/restaurant/' + newOfferingId;
        }
      }

      async function loadTables() {
        try {
          const response = await fetch('/api/restaurant/' + offeringId + '/tables');
          const data = await response.json();
          tables = data.tables || [];
          renderTables();
          updateTablesList();
        } catch (error) {
          console.error('Load tables error:', error);
        }
      }

      function renderTables() {
        const canvas = document.getElementById('canvas');
        canvas.innerHTML = '';
        
        let totalCap = 0;
        
        tables.forEach(table => {
          totalCap += table.capacity;
          const div = document.createElement('div');
          div.className = \`table-item table-\${table.shape}\`;
          div.id = \`table-\${table.table_id}\`;
          
          // Apply master scale to position and size
          const scale = masterScale / 100;
          div.style.left = (table.position_x * scale) + 'px';
          div.style.top = (table.position_y * scale) + 'px';
          div.style.width = (table.width * scale) + 'px';
          div.style.height = (table.height * scale) + 'px';
          
          // Scale font size too
          const fontSize = Math.max(8, 14 * scale);
          div.innerHTML = \`<div class="text-center" style="font-size: \${fontSize}px;"><div class="font-bold">\${table.table_number}</div><div class="text-gray-600" style="font-size: \${fontSize * 0.8}px;">\${table.capacity}p</div></div>\`;
          
          div.addEventListener('mousedown', (e) => startDrag(e, table));
          div.addEventListener('click', (e) => {
            e.stopPropagation();
            selectTable(table);
          });
          
          canvas.appendChild(div);
        });
        
        document.getElementById('tableCount').textContent = tables.length;
        document.getElementById('totalCapacity').textContent = totalCap;
      }

      function startDrag(e, table) {
        e.preventDefault();
        isDragging = true;
        selectedTable = table;
        const div = document.getElementById(\`table-\${table.table_id}\`);
        const rect = div.getBoundingClientRect();
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', stopDrag);
      }

      function onDrag(e) {
        if (!isDragging) return;
        
        const canvas = document.getElementById('canvas');
        const canvasRect = canvas.getBoundingClientRect();
        const x = e.clientX - canvasRect.left - dragOffset.x;
        const y = e.clientY - canvasRect.top - dragOffset.y;
        const scale = masterScale / 100;
        
        if (selectedTable) {
          // Store UNSCALED positions in the table object (for database)
          const unscaledX = x / scale;
          const unscaledY = y / scale;
          const unscaledWidth = selectedTable.width;
          const unscaledHeight = selectedTable.height;
          
          selectedTable.position_x = Math.max(0, Math.min(unscaledX, (canvasRect.width / scale) - unscaledWidth));
          selectedTable.position_y = Math.max(0, Math.min(unscaledY, (canvasRect.height / scale) - unscaledHeight));
          
          // But display with scaled positions
          const div = document.getElementById(\`table-\${selectedTable.table_id}\`);
          div.style.left = (selectedTable.position_x * scale) + 'px';
          div.style.top = (selectedTable.position_y * scale) + 'px';
        } else if (selectedElement) {
          // Store UNSCALED positions in the element object (for database)
          const unscaledX = x / scale;
          const unscaledY = y / scale;
          const unscaledWidth = selectedElement.width;
          const unscaledHeight = selectedElement.height;
          
          selectedElement.position_x = Math.max(0, Math.min(unscaledX, (canvasRect.width / scale) - unscaledWidth));
          selectedElement.position_y = Math.max(0, Math.min(unscaledY, (canvasRect.height / scale) - unscaledHeight));
          
          // But display with scaled positions
          const div = document.getElementById(\`element-\${selectedElement.element_id}\`);
          div.style.left = (selectedElement.position_x * scale) + 'px';
          div.style.top = (selectedElement.position_y * scale) + 'px';
        }
      }

      function stopDrag() {
        if (isDragging && selectedTable) {
          updateTablePosition(selectedTable);
        } else if (isDragging && selectedElement) {
          updateElementPosition(selectedElement);
        }
        isDragging = false;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', stopDrag);
      }

      async function updateElementPosition(element) {
        try {
          await fetch('/api/admin/restaurant/floor-element/' + element.element_id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(element)
          });
        } catch (error) {
          console.error('Update element position error:', error);
        }
      }

      async function updateTablePosition(table) {
        try {
          await fetch('/api/admin/restaurant/table/' + table.table_id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(table)
          });
        } catch (error) {
          console.error('Update position error:', error);
        }
      }

      function selectTable(table) {
        document.querySelectorAll('.table-item').forEach(el => el.classList.remove('selected'));
        document.getElementById(\`table-\${table.table_id}\`).classList.add('selected');
        selectedTable = table;
        
        const infoPanel = document.getElementById('selectedTableInfo');
        const details = document.getElementById('tableDetails');
        
        details.innerHTML = \`
          <div class="space-y-2 text-sm">
            <div><strong>Number:</strong> \${table.table_number}</div>
            <div><strong>Name:</strong> \${table.table_name || 'N/A'}</div>
            <div><strong>Capacity:</strong> \${table.capacity} seats</div>
            <div><strong>Type:</strong> \${table.table_type}</div>
            <div><strong>Shape:</strong> \${table.shape}</div>
            <div><strong>Features:</strong> \${table.features.length > 0 ? table.features.join(', ') : 'None'}</div>
          </div>
        \`;
        
        infoPanel.classList.remove('hidden');
      }

      function updateTablesList() {
        const list = document.getElementById('tablesList');
        list.innerHTML = tables.map(t => \`
          <div class="flex items-center justify-between p-2 border rounded hover:bg-gray-50 cursor-pointer" onclick='selectTable(\${JSON.stringify(t)})'>
            <div>
              <div class="font-semibold text-sm">\${t.table_number}</div>
              <div class="text-xs text-gray-600">\${t.capacity} seats</div>
            </div>
            <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">\${t.table_type}</span>
          </div>
        \`).join('');
      }

      document.getElementById('addTableForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const features = Array.from(document.querySelectorAll('input[name="features"]:checked')).map(cb => cb.value);
        
        try {
          const response = await fetch('/api/admin/restaurant/table', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              offering_id: offeringId,
              table_number: document.getElementById('tableNumber').value,
              table_name: document.getElementById('tableName').value || null,
              capacity: parseInt(document.getElementById('capacity').value),
              shape: document.getElementById('shape').value,
              table_type: document.getElementById('tableType').value,
              features: features,
              position_x: 50,
              position_y: 50,
              width: document.getElementById('shape').value === 'circle' ? 100 : 120,
              height: document.getElementById('shape').value === 'circle' ? 100 : 80
            })
          });
          
          const data = await response.json();
          if (data.success) {
            alert('Table added successfully!');
            document.getElementById('addTableForm').reset();
            await loadTables();
          }
        } catch (error) {
          console.error('Add table error:', error);
          alert('Failed to add table');
        }
      });

      async function deleteSelectedTable() {
        if (!selectedTable) return;
        if (!confirm(\`Delete table \${selectedTable.table_number}?\`)) return;
        
        try {
          const response = await fetch('/api/admin/restaurant/table/' + selectedTable.table_id, {
            method: 'DELETE'
          });
          
          const data = await response.json();
          if (data.success) {
            alert('Table deleted!');
            selectedTable = null;
            document.getElementById('selectedTableInfo').classList.add('hidden');
            await loadTables();
          }
        } catch (error) {
          console.error('Delete table error:', error);
          alert('Failed to delete table');
        }
      }

      function saveLayout() {
        alert('Layout auto-saves when you move tables!');
      }

      function clearCanvas() {
        if (!confirm('Delete all tables? This cannot be undone.')) return;
        // Implementation for bulk delete
        alert('Please delete tables individually for now');
      }

      // ========================================
      // FLOOR PLAN ELEMENTS MANAGEMENT
      // ========================================
      async function loadFloorElements() {
        try {
          const response = await fetch('/api/admin/restaurant/' + offeringId + '/floor-elements');
          const data = await response.json();
          floorElements = data.elements || [];
          renderFloorElements();
        } catch (error) {
          console.error('Load floor elements error:', error);
        }
      }

      function renderFloorElements() {
        const canvas = document.getElementById('canvas');
        // Remove old elements
        canvas.querySelectorAll('.floor-element').forEach(el => el.remove());
        
        const scale = masterScale / 100;
        
        floorElements.forEach(element => {
          const div = document.createElement('div');
          div.className = 'floor-element';
          div.id = 'element-' + element.element_id;
          div.style.position = 'absolute';
          
          // Apply master scale
          div.style.left = (element.position_x * scale) + 'px';
          div.style.top = (element.position_y * scale) + 'px';
          div.style.width = (element.width * scale) + 'px';
          div.style.height = (element.height * scale) + 'px';
          
          div.style.background = element.color || '#94A3B8';
          div.style.border = '2px solid ' + (element.border_color || '#64748B');
          div.style.borderRadius = '8px';
          div.style.display = 'flex';
          div.style.alignItems = 'center';
          div.style.justifyContent = 'center';
          div.style.cursor = 'move';
          div.style.userSelect = 'none';
          div.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
          
          // Scale font size
          const fontSize = Math.max(8, 12 * scale);
          div.style.fontSize = fontSize + 'px';
          div.style.fontWeight = 'bold';
          div.style.color = '#1F2937';
          
          const icon = getElementIcon(element.element_type);
          div.innerHTML = '<div class="text-center"><i class="' + icon + ' mr-1"></i><br><span style="font-size: ' + (fontSize * 0.8) + 'px;">' + element.element_label + '</span></div>';
          
          div.addEventListener('mousedown', (e) => startElementDrag(e, element));
          div.addEventListener('click', (e) => {
            e.stopPropagation();
            selectElement(element);
          });
          
          canvas.appendChild(div);
        });
      }

      function getElementIcon(type) {
        const icons = {
          'buffet': 'fas fa-utensils',
          'bar': 'fas fa-glass-cheers',
          'kitchen': 'fas fa-fire-burner',
          'entrance': 'fas fa-door-open',
          'exit': 'fas fa-door-closed',
          'restroom': 'fas fa-restroom',
          'window': 'fas fa-window-maximize',
          'wall': 'fas fa-border-all',
          'plant': 'fas fa-leaf',
          'stage': 'fas fa-microphone'
        };
        return icons[type] || 'fas fa-shapes';
      }

      function startElementDrag(e, element) {
        e.preventDefault();
        isDragging = true;
        selectedElement = element;
        selectedTable = null;
        const div = document.getElementById('element-' + element.element_id);
        const rect = div.getBoundingClientRect();
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        
        // Register drag listeners
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', stopDrag);
      }

      function selectElement(element) {
        selectedElement = element;
        selectedTable = null;
        document.querySelectorAll('.floor-element').forEach(el => el.style.borderColor = '#64748B');
        const div = document.getElementById('element-' + element.element_id);
        if (div) div.style.borderColor = '#10B981';
      }

      document.getElementById('addElementForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const elementData = {
          offering_id: offeringId,
          property_id: 1,
          element_type: document.getElementById('elementType').value,
          element_label: document.getElementById('elementLabel').value,
          width: parseInt(document.getElementById('elementWidth').value),
          height: parseInt(document.getElementById('elementHeight').value),
          color: document.getElementById('elementColor').value,
          position_x: 50,
          position_y: 50
        };
        
        try {
          const response = await fetch('/api/admin/restaurant/floor-element', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(elementData)
          });
          
          const data = await response.json();
          if (data.success) {
            alert('Floor element added!');
            document.getElementById('addElementForm').reset();
            await loadFloorElements();
          }
        } catch (error) {
          console.error('Add element error:', error);
          alert('Failed to add floor element');
        }
      });

      // ========================================
      // WALL DRAWING TOOL
      // ========================================
      let isDrawingWall = false;
      let wallStartPoint = null;
      let walls = [];
      let tempWallLine = null;

      async function loadWalls() {
        try {
          const response = await fetch('/api/admin/restaurant/' + offeringId + '/walls');
          const data = await response.json();
          walls = data.walls || [];
          renderWalls();
        } catch (error) {
          console.error('Load walls error:', error);
        }
      }

      function renderWalls() {
        const canvas = document.getElementById('canvas');
        canvas.querySelectorAll('.wall-line').forEach(el => el.remove());
        
        walls.forEach(wall => {
          const line = createWallElement(wall);
          canvas.appendChild(line);
        });
      }

      function createWallElement(wall) {
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.className = 'wall-line';
        svg.style.position = 'absolute';
        svg.style.pointerEvents = 'none';
        svg.style.zIndex = '0';
        
        // Apply master scale to wall coordinates
        const scale = masterScale / 100;
        const scaledStartX = wall.start_x * scale;
        const scaledStartY = wall.start_y * scale;
        const scaledEndX = wall.end_x * scale;
        const scaledEndY = wall.end_y * scale;
        
        const minX = Math.min(scaledStartX, scaledEndX);
        const minY = Math.min(scaledStartY, scaledEndY);
        const width = Math.abs(scaledEndX - scaledStartX);
        const height = Math.abs(scaledEndY - scaledStartY);
        
        svg.style.left = minX + 'px';
        svg.style.top = minY + 'px';
        svg.style.width = (width + 10) + 'px';
        svg.style.height = (height + 10) + 'px';
        
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', scaledStartX - minX);
        line.setAttribute('y1', scaledStartY - minY);
        line.setAttribute('x2', scaledEndX - minX);
        line.setAttribute('y2', scaledEndY - minY);
        line.setAttribute('stroke', wall.color || '#64748B');
        line.setAttribute('stroke-width', (wall.thickness || 4) * scale);
        
        if (wall.style === 'dashed') {
          line.setAttribute('stroke-dasharray', '10,5');
        } else if (wall.style === 'door') {
          line.setAttribute('stroke', '#10B981');
          line.setAttribute('stroke-dasharray', '15,10');
        } else if (wall.style === 'window') {
          line.setAttribute('stroke', '#3B82F6');
          line.setAttribute('stroke-dasharray', '5,5');
        }
        
        svg.appendChild(line);
        return svg;
      }

      window.toggleWallDrawing = function() {
        isDrawingWall = !isDrawingWall;
        const button = document.getElementById('startWallDrawing');
        const hint = document.getElementById('wallDrawingHint');
        
        if (isDrawingWall) {
          button.textContent = 'ðŸ›‘ Cancel Drawing';
          button.className = 'w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700';
          hint.classList.remove('hidden');
          wallStartPoint = null;
        } else {
          button.innerHTML = '<i class="fas fa-pen mr-2"></i>Start Drawing Walls';
          button.className = 'w-full bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700';
          hint.classList.add('hidden');
          wallStartPoint = null;
          if (tempWallLine) {
            tempWallLine.remove();
            tempWallLine = null;
          }
        }
      }

      document.getElementById('canvas').addEventListener('click', async function(e) {
        if (!isDrawingWall) return;
        
        const canvas = document.getElementById('canvas');
        const rect = canvas.getBoundingClientRect();
        const scale = masterScale / 100;
        
        // Get click position and convert to UNSCALED coordinates for storage
        const scaledX = Math.round(e.clientX - rect.left);
        const scaledY = Math.round(e.clientY - rect.top);
        const x = Math.round(scaledX / scale);
        const y = Math.round(scaledY / scale);
        
        if (!wallStartPoint) {
          // Set start point (UNSCALED)
          wallStartPoint = { x, y };
        } else {
          // Set end point and create wall (UNSCALED coordinates)
          const wallData = {
            offering_id: offeringId,
            property_id: 1,
            start_x: wallStartPoint.x,
            start_y: wallStartPoint.y,
            end_x: x,
            end_y: y,
            thickness: parseInt(document.getElementById('wallThickness').value),
            color: document.getElementById('wallColor').value,
            style: document.getElementById('wallStyle').value
          };
          
          try {
            const response = await fetch('/api/admin/restaurant/wall', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(wallData)
            });
            
            const data = await response.json();
            if (data.success) {
              await loadWalls();
              wallStartPoint = null;
              if (tempWallLine) {
                tempWallLine.remove();
                tempWallLine = null;
              }
            }
          } catch (error) {
            console.error('Create wall error:', error);
            alert('Failed to create wall');
          }
        }
      });

      // ========================================
      // MASTER SCALE CONTROL
      // ========================================
      window.updateMasterScale = function(value) {
        masterScale = parseFloat(value); // Store as percentage (30-150)
        document.getElementById('scaleValue').textContent = value + '%';
        
        // Re-render everything with new scale
        renderTables();
        renderFloorElements();
        renderWalls();
      }

      // ========================================
      // TAB SWITCHING
      // ========================================
      function switchTab(tab) {
        currentTab = tab;
        
        // Update button styles
        document.getElementById('tabTables').className = 'flex-1 px-4 py-3 rounded-lg font-semibold ' + (tab === 'tables' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200');
        document.getElementById('tabSessions').className = 'flex-1 px-4 py-3 rounded-lg font-semibold ' + (tab === 'sessions' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200');
        document.getElementById('tabReservations').className = 'flex-1 px-4 py-3 rounded-lg font-semibold ' + (tab === 'reservations' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200');
        document.getElementById('tabTextures').className = 'flex-1 px-4 py-3 rounded-lg font-semibold ' + (tab === 'textures' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200');
        
        // Show/hide sections
        document.getElementById('tablesSection').style.display = tab === 'tables' ? 'block' : 'none';
        document.getElementById('sessionsSection').style.display = tab === 'sessions' ? 'block' : 'none';
        document.getElementById('reservationsSection').style.display = tab === 'reservations' ? 'block' : 'none';
        document.getElementById('texturesSection').style.display = tab === 'textures' ? 'block' : 'none';
        
        // Load data for active tab
        if (tab === 'sessions') {
          loadSessions();
        } else if (tab === 'reservations') {
          loadReservations();
        } else if (tab === 'textures') {
          loadTextureSettings();
        }
      }

      // ========================================
      // SESSIONS MANAGEMENT
      // ========================================
      async function loadSessions() {
        try {
          const dateFilter = document.getElementById('filterSessionDate').value || new Date().toISOString().split('T')[0];
          const response = await fetch(\`/api/restaurant/\${offeringId}/sessions?date=\${dateFilter}\`);
          const data = await response.json();
          
          const list = document.getElementById('sessionsList');
          if (!data.sessions || data.sessions.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="fas fa-clock text-4xl mb-3"></i><p>No sessions found for this date</p></div>';
            return;
          }
          
          list.innerHTML = data.sessions.map(session => \`
            <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h3 class="font-bold text-lg">\${session.session_time}</h3>
                  <span class="inline-block px-2 py-1 rounded text-xs font-semibold bg-blue-100 text-blue-700 capitalize">\${session.session_type}</span>
                </div>
                <button onclick="deleteSession(\${session.session_id})" class="text-red-600 hover:text-red-800">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              <div class="text-sm text-gray-600 space-y-1">
                <div><i class="fas fa-calendar mr-2"></i>\${session.session_date}</div>
                <div><i class="fas fa-hourglass-half mr-2"></i>\${session.duration_minutes} minutes</div>
                <div><i class="fas fa-users mr-2"></i>\${session.current_bookings} / \${session.max_capacity} seats</div>
                <div class="mt-2">
                  \${session.is_available ? '<span class="text-green-600 font-semibold"><i class="fas fa-check-circle mr-1"></i>Available</span>' : '<span class="text-red-600 font-semibold"><i class="fas fa-times-circle mr-1"></i>Full</span>'}
                </div>
              </div>
            </div>
          \`).join('');
        } catch (error) {
          console.error('Load sessions error:', error);
          document.getElementById('sessionsList').innerHTML = '<div class="text-center text-red-500 py-4">Failed to load sessions</div>';
        }
      }

      document.getElementById('createSessionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const sessionData = {
          offering_id: offeringId,
          session_date: document.getElementById('sessionDate').value,
          session_time: document.getElementById('sessionTime').value,
          session_type: document.getElementById('sessionType').value,
          duration_minutes: parseInt(document.getElementById('sessionDuration').value),
          max_capacity: parseInt(document.getElementById('sessionCapacity').value)
        };
        
        try {
          const response = await fetch('/api/admin/restaurant/session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(sessionData)
          });
          
          const data = await response.json();
          if (data.success) {
            alert('Time slot created successfully!');
            // Update filter to show the newly created session's date
            document.getElementById('filterSessionDate').value = sessionData.session_date;
            document.getElementById('createSessionForm').reset();
            // Reset the form date to today for next creation
            document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];
            loadSessions();
          } else {
            alert('Failed to create time slot: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Create session error:', error);
          alert('Error creating time slot');
        }
      });

      async function deleteSession(sessionId) {
        if (!confirm('Delete this time slot? Existing reservations will be affected.')) return;
        
        try {
          const response = await fetch(\`/api/admin/restaurant/session/\${sessionId}\`, {
            method: 'DELETE'
          });
          
          const data = await response.json();
          if (data.success) {
            alert('Time slot deleted');
            loadSessions();
          } else {
            alert('Failed to delete: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Delete session error:', error);
          alert('Error deleting time slot');
        }
      }

      // ========================================
      // RESERVATIONS MANAGEMENT
      // ========================================
      async function loadReservations() {
        try {
          const dateFilter = document.getElementById('filterReservationDate').value || new Date().toISOString().split('T')[0];
          const statusFilter = document.getElementById('filterStatus').value;
          const guestFilter = document.getElementById('filterGuest').value;
          
          let url = \`/api/admin/restaurant/reservations?offering_id=\${offeringId}&date=\${dateFilter}\`;
          if (statusFilter) url += \`&status=\${statusFilter}\`;
          if (guestFilter) url += \`&guest=\${encodeURIComponent(guestFilter)}\`;
          
          const response = await fetch(url);
          const data = await response.json();
          
          if (!data.success) {
            throw new Error(data.error || 'Failed to load reservations');
          }
          
          const reservations = data.reservations || [];
          
          // Update stats
          document.getElementById('statTotal').textContent = reservations.length;
          document.getElementById('statConfirmed').textContent = reservations.filter(r => r.status === 'confirmed').length;
          document.getElementById('statPending').textContent = reservations.filter(r => r.status === 'pending').length;
          document.getElementById('statGuests').textContent = reservations.reduce((sum, r) => sum + r.guest_count, 0);
          document.getElementById('reservationCount').textContent = reservations.length;
          
          // Render reservations
          const list = document.getElementById('reservationsList');
          if (reservations.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="fas fa-calendar-times text-4xl mb-3"></i><p>No reservations found</p></div>';
            return;
          }
          
          list.innerHTML = reservations.map(res => {
            const statusColors = {
              pending: 'bg-yellow-100 text-yellow-700',
              confirmed: 'bg-green-100 text-green-700',
              checked_in: 'bg-blue-100 text-blue-700',
              completed: 'bg-gray-100 text-gray-700',
              cancelled: 'bg-red-100 text-red-700'
            };
            
            return \`
              <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 class="font-bold text-lg">\${res.guest_name}</h3>
                    <div class="text-sm text-gray-600">
                      <i class="fas fa-envelope mr-1"></i>\${res.guest_email || 'No email'}
                      \${res.guest_phone ? \`<span class="ml-3"><i class="fas fa-phone mr-1"></i>\${res.guest_phone}</span>\` : ''}
                    </div>
                  </div>
                  <span class="px-3 py-1 rounded-full text-xs font-semibold \${statusColors[res.status] || 'bg-gray-100'} capitalize">
                    \${res.status}
                  </span>
                </div>
                
                <div class="grid md:grid-cols-2 gap-3 text-sm mb-3">
                  <div><i class="fas fa-calendar mr-2 text-blue-600"></i><strong>Date:</strong> \${res.reservation_date}</div>
                  <div><i class="fas fa-clock mr-2 text-blue-600"></i><strong>Time:</strong> \${res.reservation_time}</div>
                  <div><i class="fas fa-users mr-2 text-blue-600"></i><strong>Guests:</strong> \${res.guest_count}</div>
                  <div><i class="fas fa-chair mr-2 text-blue-600"></i><strong>Table:</strong> \${res.table_number || 'Not assigned'}</div>
                </div>
                
                \${res.special_requests ? \`<div class="text-sm text-gray-600 bg-gray-50 p-2 rounded mb-3"><strong>Special Requests:</strong> \${res.special_requests}</div>\` : ''}
                \${res.dietary_requirements ? \`<div class="text-sm text-gray-600 bg-gray-50 p-2 rounded mb-3"><strong>Dietary:</strong> \${res.dietary_requirements}</div>\` : ''}
                
                <div class="flex gap-2 mt-3">
                  \${res.status === 'pending' ? \`<button onclick="confirmReservation('\${res.reservation_reference}')" class="flex-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-semibold"><i class="fas fa-check mr-1"></i>Confirm</button>\` : ''}
                  \${res.status === 'confirmed' ? \`<button onclick="checkInReservation('\${res.reservation_reference}')" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold"><i class="fas fa-sign-in-alt mr-1"></i>Check In</button>\` : ''}
                  \${res.status !== 'cancelled' && res.status !== 'completed' ? \`<button onclick="cancelReservation('\${res.reservation_reference}')" class="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-semibold"><i class="fas fa-times mr-1"></i>Cancel</button>\` : ''}
                </div>
              </div>
            \`;
          }).join('');
          
        } catch (error) {
          console.error('Load reservations error:', error);
          document.getElementById('reservationsList').innerHTML = '<div class="text-center text-red-500 py-4">Failed to load reservations: ' + error.message + '</div>';
        }
      }

      async function confirmReservation(reference) {
        try {
          const response = await fetch(\`/api/admin/restaurant/reservation/\${reference}/confirm\`, {
            method: 'POST'
          });
          const data = await response.json();
          if (data.success) {
            alert('Reservation confirmed!');
            loadReservations();
          } else {
            alert('Failed to confirm: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Confirm error:', error);
          alert('Error confirming reservation');
        }
      }

      async function checkInReservation(reference) {
        try {
          const response = await fetch(\`/api/admin/restaurant/reservation/\${reference}/checkin\`, {
            method: 'POST'
          });
          const data = await response.json();
          if (data.success) {
            alert('Guest checked in!');
            loadReservations();
          } else {
            alert('Failed to check in: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Check in error:', error);
          alert('Error checking in guest');
        }
      }

      async function cancelReservation(reference) {
        if (!confirm('Cancel this reservation?')) return;
        
        try {
          const response = await fetch(\`/api/admin/restaurant/reservation/\${reference}/cancel\`, {
            method: 'POST'
          });
          const data = await response.json();
          if (data.success) {
            alert('Reservation cancelled');
            loadReservations();
          } else {
            alert('Failed to cancel: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Cancel error:', error);
          alert('Error cancelling reservation');
        }
      }

      // ========================================
      // AI TEXTURES MANAGEMENT
      // ========================================
      let currentTextureData = null;
      
      async function loadTextureSettings() {
        try {
          const response = await fetch('/api/admin/restaurant/' + offeringId + '/textures');
          const data = await response.json();
          
          if (data.success && data.texture) {
            currentTextureData = data.texture;
            displayTextureStatus(data.texture);
          } else {
            document.getElementById('textureStatusContent').innerHTML = 
              '<p class="text-gray-500">No textures configured yet. Upload a restaurant photo to get started!</p>';
          }
        } catch (error) {
          console.error('Load textures error:', error);
        }
      }
      
      function displayTextureStatus(texture) {
        if (!texture.is_active) {
          document.getElementById('textureStatusContent').innerHTML = 
            '<p class="text-gray-500">Textures uploaded but not active. Click "Save & Apply" to enable.</p>';
          return;
        }
        
        const html = \`
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <p class="font-semibold">Floor Texture</p>
              <p class="text-sm text-gray-600">Type: \${texture.floor_texture_type || 'Unknown'}</p>
              <p class="text-sm text-gray-600">Color: \${texture.floor_color_primary || '-'}</p>
              <p class="text-sm text-gray-600">Opacity: \${(texture.floor_opacity * 100).toFixed(0)}%</p>
            </div>
            <div>
              <p class="font-semibold">Table Texture</p>
              <p class="text-sm text-gray-600">Type: \${texture.table_texture_type || 'Unknown'}</p>
              <p class="text-sm text-gray-600">Color: \${texture.table_color_primary || '-'}</p>
              <p class="text-sm text-gray-600">Opacity: \${(texture.table_opacity * 100).toFixed(0)}%</p>
            </div>
          </div>
          <div class="mt-3">
            <span class="inline-block px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full">
              <i class="fas fa-check-circle mr-1"></i>Active on booking page
            </span>
          </div>
        \`;
        document.getElementById('textureStatusContent').innerHTML = html;
      }
      
      // Image preview
      document.getElementById('restaurantPhoto').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            document.getElementById('previewImg').src = event.target.result;
            document.getElementById('imagePreview').classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Handle texture upload and AI analysis
      document.getElementById('uploadTextureForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('restaurantPhoto');
        const file = fileInput.files[0];
        
        if (!file) {
          alert('Please select an image');
          return;
        }
        
        // Show loading state
        document.getElementById('aiLoadingState').classList.remove('hidden');
        document.getElementById('aiAnalysisResults').classList.add('hidden');
        
        try {
          // Convert image to base64
          const reader = new FileReader();
          reader.onload = async function(event) {
            const base64Image = event.target.result;
            
            // Call AI analysis API
            const response = await fetch('/api/admin/restaurant/' + offeringId + '/analyze-textures', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                image: base64Image,
                offering_id: offeringId,
                property_id: 1
              })
            });
            
            const data = await response.json();
            
            // Hide loading
            document.getElementById('aiLoadingState').classList.add('hidden');
            
            if (data.success) {
              currentTextureData = data.texture;
              displayAIResults(data.texture);
              document.getElementById('aiAnalysisResults').classList.remove('hidden');
            } else {
              alert('AI analysis failed: ' + (data.error || 'Unknown error'));
            }
          };
          reader.readAsDataURL(file);
          
        } catch (error) {
          console.error('Texture upload error:', error);
          document.getElementById('aiLoadingState').classList.add('hidden');
          alert('Error uploading image: ' + error.message);
        }
      });
      
      function displayAIResults(texture) {
        document.getElementById('floorType').textContent = texture.floor_texture_type || 'Unknown';
        document.getElementById('floorColorPrimary').textContent = texture.floor_color_primary || '-';
        document.getElementById('tableType').textContent = texture.table_texture_type || 'Unknown';
        document.getElementById('tableColorPrimary').textContent = texture.table_color_primary || '-';
        document.getElementById('confidenceScore').textContent = (texture.confidence_score * 100).toFixed(0);
        
        document.getElementById('floorOpacity').value = texture.floor_opacity || 0.8;
        document.getElementById('floorOpacityValue').textContent = ((texture.floor_opacity || 0.8) * 100).toFixed(0) + '%';
        
        document.getElementById('tableOpacity').value = texture.table_opacity || 0.9;
        document.getElementById('tableOpacityValue').textContent = ((texture.table_opacity || 0.9) * 100).toFixed(0) + '%';
      }
      
      // Opacity sliders
      document.getElementById('floorOpacity').addEventListener('input', function(e) {
        document.getElementById('floorOpacityValue').textContent = (e.target.value * 100).toFixed(0) + '%';
      });
      
      document.getElementById('tableOpacity').addEventListener('input', function(e) {
        document.getElementById('tableOpacityValue').textContent = (e.target.value * 100).toFixed(0) + '%';
      });
      
      window.saveTextures = async function() {
        if (!currentTextureData) {
          alert('No texture data to save');
          return;
        }
        
        try {
          const response = await fetch('/api/admin/restaurant/' + offeringId + '/textures', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              texture_id: currentTextureData.texture_id,
              is_active: 1,
              floor_opacity: parseFloat(document.getElementById('floorOpacity').value),
              table_opacity: parseFloat(document.getElementById('tableOpacity').value)
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('âœ… Textures saved and applied to booking page!');
            loadTextureSettings();
          } else {
            alert('Error saving textures: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Save textures error:', error);
          alert('Error saving textures: ' + error.message);
        }
      }

      // Initialize on page load
      // Set today's date as default for filters
      document.getElementById('filterSessionDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('filterReservationDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];

      init();
    </script>
</body>
</html>
  `)
})

// Feedback submission page - serve HTML directly
app.get('/feedback/:form_id', async (c) => {
  const formId = c.req.param('form_id')
  return c.html(`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .star-rating { display: flex; gap: 0.5rem; font-size: 2rem; flex-direction: row-reverse; justify-content: flex-end; }
        .star { cursor: pointer; color: #d1d5db; transition: color 0.2s; }
        .star.active { color: #fbbf24; }
        .star:hover, .star:hover ~ .star { color: #fbbf24; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <div id="loading" class="text-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
            <p class="text-gray-600">Loading form...</p>
        </div>

        <div id="formContainer" class="hidden">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-8">
                    <h1 class="text-3xl font-bold mb-2" id="formName"></h1>
                    <p class="text-purple-100" id="formDescription"></p>
                    <p class="text-sm text-purple-200 mt-2" id="propertyName"></p>
                </div>

                <div class="p-8">
                    <form id="feedbackForm" class="space-y-6">
                        <div id="guestInfoSection" class="space-y-4 pb-6 border-b">
                            <h3 class="text-lg font-bold text-gray-900">Your Information</h3>
                            <div id="guestFields"></div>
                        </div>

                        <div id="questionsSection" class="space-y-6"></div>

                        <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition-all">
                            <i class="fas fa-paper-plane mr-2"></i>Submit Feedback
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="thankYouMessage" class="hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-12 text-center">
                <div class="mb-6">
                    <i class="fas fa-check-circle text-6xl text-green-500"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-900 mb-4" id="thankYouText"></h2>
                <p class="text-gray-600 mb-6">We appreciate you taking the time to share your thoughts.</p>
            </div>
        </div>

        <div id="errorMessage" class="hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-12 text-center">
                <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Form Not Available</h2>
                <p class="text-gray-600" id="errorText"></p>
            </div>
        </div>
    </div>

    <script>
        const formId = ${formId};
        let formData = null;

        async function loadForm() {
            try {
                const res = await fetch('/api/feedback/forms/' + formId);
                const data = await res.json();

                if (!data.success) throw new Error(data.error || 'Failed to load form');

                formData = data.form;
                
                document.getElementById('formName').textContent = formData.form_name;
                document.getElementById('formDescription').textContent = formData.form_description || '';
                document.getElementById('propertyName').textContent = formData.property_name;

                const guestFields = document.getElementById('guestFields');
                const fields = [];
                
                if (formData.require_room_number) {
                    fields.push('<div><label class="block text-sm font-semibold mb-2">Room Number *</label><input type="text" name="room_number" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-600" placeholder="e.g., 303"></div>');
                }
                if (formData.require_guest_name) {
                    fields.push('<div><label class="block text-sm font-semibold mb-2">Your Name *</label><input type="text" name="guest_name" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-600" placeholder="Full name"></div>');
                }
                if (formData.require_email) {
                    fields.push('<div><label class="block text-sm font-semibold mb-2">Email *</label><input type="email" name="guest_email" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-600" placeholder="your@email.com"></div>');
                }
                if (formData.require_phone) {
                    fields.push('<div><label class="block text-sm font-semibold mb-2">Phone *</label><input type="tel" name="guest_phone" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-600" placeholder="+1234567890"></div>');
                }

                guestFields.innerHTML = fields.join('');

                const questionsSection = document.getElementById('questionsSection');
                questionsSection.innerHTML = formData.questions.map((q, idx) => {
                    let inputHtml = '';
                    
                    switch(q.question_type) {
                        case 'text':
                            inputHtml = '<input type="text" name="q_' + q.question_id + '" ' + (q.is_required ? 'required' : '') + ' class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-600" placeholder="Your answer">';
                            break;
                        case 'textarea':
                            inputHtml = '<textarea name="q_' + q.question_id + '" rows="4" ' + (q.is_required ? 'required' : '') + ' class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-600" placeholder="Your answer"></textarea>';
                            break;
                        case 'rating':
                            inputHtml = '<div class="star-rating" data-question="' + q.question_id + '">';
                            for (let i = 5; i >= 1; i--) {
                                inputHtml += '<span class="star" data-value="' + i + '" onclick="setRating(' + q.question_id + ', ' + i + ')">â˜…</span>';
                            }
                            inputHtml += '</div><input type="hidden" name="q_' + q.question_id + '" ' + (q.is_required ? 'required' : '') + '>';
                            break;
                        case 'scale':
                            inputHtml = '<div class="flex justify-between items-center gap-2">';
                            for (let i = 1; i <= 10; i++) {
                                inputHtml += '<button type="button" onclick="setScale(' + q.question_id + ', ' + i + ')" class="scale-btn w-12 h-12 border-2 rounded-lg font-bold hover:bg-purple-600 hover:text-white hover:border-purple-600 transition-all" data-question="' + q.question_id + '" data-value="' + i + '">' + i + '</button>';
                            }
                            inputHtml += '</div><input type="hidden" name="q_' + q.question_id + '" ' + (q.is_required ? 'required' : '') + '>';
                            break;
                        case 'multiple_choice':
                            const options = q.options || [];
                            inputHtml = '<div class="space-y-2">';
                            options.forEach(opt => {
                                inputHtml += '<label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-purple-50 cursor-pointer transition-all"><input type="radio" name="q_' + q.question_id + '" value="' + opt + '" ' + (q.is_required ? 'required' : '') + ' class="w-5 h-5 text-purple-600"><span class="flex-1">' + opt + '</span></label>';
                            });
                            inputHtml += '</div>';
                            break;
                        case 'yes_no':
                            inputHtml = '<div class="flex gap-4">';
                            inputHtml += '<label class="flex-1 flex items-center justify-center space-x-2 p-4 border-2 rounded-lg hover:bg-green-50 hover:border-green-600 cursor-pointer transition-all"><input type="radio" name="q_' + q.question_id + '" value="Yes" ' + (q.is_required ? 'required' : '') + ' class="w-5 h-5"><span class="font-semibold">Yes</span></label>';
                            inputHtml += '<label class="flex-1 flex items-center justify-center space-x-2 p-4 border-2 rounded-lg hover:bg-red-50 hover:border-red-600 cursor-pointer transition-all"><input type="radio" name="q_' + q.question_id + '" value="No" ' + (q.is_required ? 'required' : '') + ' class="w-5 h-5"><span class="font-semibold">No</span></label>';
                            inputHtml += '</div>';
                            break;
                        case 'nps':
                            inputHtml = '<div class="space-y-3"><div class="flex justify-between text-sm text-gray-600 mb-2"><span>Not at all likely</span><span>Extremely likely</span></div><div class="grid grid-cols-11 gap-2">';
                            for (let i = 0; i <= 10; i++) {
                                inputHtml += '<button type="button" onclick="setNPS(' + q.question_id + ', ' + i + ')" class="nps-btn aspect-square border-2 rounded-lg font-bold hover:bg-purple-600 hover:text-white hover:border-purple-600 transition-all" data-question="' + q.question_id + '" data-value="' + i + '">' + i + '</button>';
                            }
                            inputHtml += '</div></div><input type="hidden" name="q_' + q.question_id + '" ' + (q.is_required ? 'required' : '') + '>';
                            break;
                    }
                    
                    return '<div class="question-block"><label class="block text-md font-semibold text-gray-900 mb-3">' + q.question_text + (q.is_required ? ' <span class="text-red-500">*</span>' : '') + '</label>' + inputHtml + '</div>';
                }).join('');

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('formContainer').classList.remove('hidden');
            } catch (error) {
                console.error('Load form error:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorText').textContent = error.message;
            }
        }

        function setRating(questionId, value) {
            document.querySelector('[name="q_' + questionId + '"]').value = value;
            const stars = document.querySelectorAll('[data-question="' + questionId + '"] .star');
            stars.forEach(star => {
                star.classList.toggle('active', parseInt(star.dataset.value) <= value);
            });
        }

        function setScale(questionId, value) {
            document.querySelector('[name="q_' + questionId + '"]').value = value;
            document.querySelectorAll('[data-question="' + questionId + '"].scale-btn').forEach(btn => {
                btn.classList.toggle('bg-purple-600', parseInt(btn.dataset.value) === value);
                btn.classList.toggle('text-white', parseInt(btn.dataset.value) === value);
                btn.classList.toggle('border-purple-600', parseInt(btn.dataset.value) === value);
            });
        }

        function setNPS(questionId, value) {
            document.querySelector('[name="q_' + questionId + '"]').value = value;
            document.querySelectorAll('[data-question="' + questionId + '"].nps-btn').forEach(btn => {
                btn.classList.toggle('bg-purple-600', parseInt(btn.dataset.value) === value);
                btn.classList.toggle('text-white', parseInt(btn.dataset.value) === value);
                btn.classList.toggle('border-purple-600', parseInt(btn.dataset.value) === value);
            });
        }

        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formElement = e.target;
            const formDataObj = new FormData(formElement);
            
            const answers = [];
            formData.questions.forEach(q => {
                const answer = formDataObj.get('q_' + q.question_id);
                if (answer) {
                    answers.push({
                        question_id: q.question_id,
                        answer_text: answer
                    });
                }
            });

            const submission = {
                form_id: formId,
                room_number: formDataObj.get('room_number') || null,
                guest_name: formDataObj.get('guest_name') || null,
                guest_email: formDataObj.get('guest_email') || null,
                guest_phone: formDataObj.get('guest_phone') || null,
                answers: answers,
                source: 'homepage'
            };

            try {
                const res = await fetch('/api/feedback/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submission)
                });

                const data = await res.json();

                if (data.success) {
                    document.getElementById('formContainer').classList.add('hidden');
                    document.getElementById('thankYouMessage').classList.remove('hidden');
                    document.getElementById('thankYouText').textContent = formData.thank_you_message || 'Thank you for your feedback!';
                } else {
                    alert('Failed to submit: ' + data.error);
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('Failed to submit feedback. Please try again.');
            }
        });

        loadForm();
    </script>
</body>
</html>
  `)
})

export default app
